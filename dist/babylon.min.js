!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("EBJS",[],e):"object"==typeof exports?exports.EBJS=e():t.EBJS=e()}(this,function(){return function(t){function e(r){if(i[r])return i[r].exports;var n=i[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var i={};return e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,r){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="http://localhost:7000/dist/",e(e.s=3)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=i(2),n=i(1).OIMO;e.BABYLON=r,e.OIMO=n},function(t,e,i){"use strict";function r(t,e,i){return{a:t,b:e,c:i}}function n(t,e,i,r){var n=.5*(-i.y*r.x+e.y*(-i.x+r.x)+e.x*(i.y-r.y)+i.x*r.y),s=n<0?-1:1,o=(e.y*r.x-e.x*r.y+(r.y-e.y)*t.x+(e.x-r.x)*t.y)*s,a=(e.x*i.y-e.y*i.x+(e.y-i.y)*t.x+(i.x-e.x)*t.y)*s;return o>0&&a>0&&o+a<2*n*s}function s(t,e){return{x:t,y:e}}Object.defineProperty(e,"__esModule",{value:!0});var o,a={REVISION:"1.2",nextID:0,proxyID:0,BR_NULL:0,BR_BRUTE_FORCE:1,BR_SWEEP_AND_PRUNE:2,BR_BOUNDING_VOLUME_TREE:3,BODY_NULL:0,BODY_DYNAMIC:1,BODY_STATIC:2,SHAPE_NULL:0,SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,SHAPE_TETRA:4,JOINT_NULL:0,JOINT_DISTANCE:1,JOINT_BALL_AND_SOCKET:2,JOINT_HINGE:3,JOINT_WHEEL:4,JOINT_SLIDER:5,JOINT_PRISMATIC:6,WORLD_SCALE:100,INV_SCALE:.01,AABB_PROX:.005,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(t,e,i){return t+(e-t)*i},rand:function(t,e){return a.lerp(t,e,a.random())},randInt:function(t,e,i){return 1*a.lerp(t,e,a.random()).toFixed(i||0)},int:function(t){return~~t},fix:function(t,e){return t.toFixed(e||3,10)},clamp:function(t,e,i){return a.max(e,a.min(i,t))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,CustomError:null,Error:function(t,e){null==a.CustomError?console.error(t,e):a.CustomError.innerHTML+=t+" - "+e+"<br>"}};o||(o="undefined"!=typeof Float32Array?Float32Array:Array);try{!function(t){var e,i=["now","webkitNow","msNow","mozNow"];if(t.performance)for(var r=0;r<i.length;++r){var n=i[r];if(t.performance[n]){e=function(){return t.performance[n]()};break}}e||(e=Date.now),a.now=e}(window)}catch(t){a.now=function(){return 0}}a.World=function(t,e,i,r){switch(this.timeStep=t||.01666,this.numIterations=i||8,e||2){case 1:this.broadPhase=new a.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new a.SAPBroadPhase;break;case 3:this.broadPhase=new a.DBVTBroadPhase}this.performance=null,this.isNoStat=r||!1,this.isNoStat||(this.performance=new a.Performance(this)),this.enableRandomizer=!0,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new a.Vec3(0,-9.80665,0);var n=5;this.detectors=[],this.detectors.length=n;for(var s=n;s--;)this.detectors[s]=[],this.detectors[s].length=n;this.detectors[a.SHAPE_SPHERE][a.SHAPE_SPHERE]=new a.SphereSphereCollisionDetector,this.detectors[a.SHAPE_SPHERE][a.SHAPE_BOX]=new a.SphereBoxCollisionDetector(!1),this.detectors[a.SHAPE_BOX][a.SHAPE_SPHERE]=new a.SphereBoxCollisionDetector(!0),this.detectors[a.SHAPE_BOX][a.SHAPE_BOX]=new a.BoxBoxCollisionDetector,this.detectors[a.SHAPE_CYLINDER][a.SHAPE_CYLINDER]=new a.CylinderCylinderCollisionDetector,this.detectors[a.SHAPE_CYLINDER][a.SHAPE_BOX]=new a.BoxCylinderCollisionDetector(!0),this.detectors[a.SHAPE_BOX][a.SHAPE_CYLINDER]=new a.BoxCylinderCollisionDetector(!1),this.detectors[a.SHAPE_CYLINDER][a.SHAPE_SPHERE]=new a.SphereCylinderCollisionDetector(!0),this.detectors[a.SHAPE_SPHERE][a.SHAPE_CYLINDER]=new a.SphereCylinderCollisionDetector(!1),this.detectors[a.SHAPE_TETRA][a.SHAPE_TETRA]=new a.TetraTetraCollisionDetector,this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]},a.World.prototype={constructor:a.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);a.nextID=0,a.proxyID=0},addRigidBody:function(t){t.parent&&a.Error("World","It is not possible to be added to more than one world one of the rigid body"),t.parent=this,t.awake();for(var e=t.shapes;null!==e;e=e.next)this.addShape(e);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var e=t;if(e.parent===this){e.awake();for(var i=e.jointLink;null!=i;){var r=i.joint;i=i.next,this.removeJoint(r)}for(var n=t.shapes;null!==n;n=n.next)this.removeShape(n);var s=e.prev,o=e.next;null!==s&&(s.next=o),null!==o&&(o.prev=s),this.rigidBodies==e&&(this.rigidBodies=o),e.prev=null,e.next=null,e.parent=null,this.numRigidBodies--}},getByName:function(t){for(var e=null,i=this.rigidBodies;null!==i;)" "!==i.name&&i.name===t&&(e=i),i=i.next;for(var r=this.joints;null!==r;)""!==r.name&&r.name===t&&(e=r),r=r.next;return e},addShape:function(t){t.parent&&t.parent.parent||a.Error("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&a.Error("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.parent=this,this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){var e=t,i=e.prev,r=e.next;null!==i&&(i.next=r),null!==r&&(r.prev=i),this.joints==e&&(this.joints=r),e.prev=null,e.next=null,this.numJoints--,e.awake(),e.detach(),e.parent=null},worldscale:function(t){a.WORLD_SCALE=t||100,a.INV_SCALE=1/a.WORLD_SCALE},addContact:function(t,e){var i;null!==this.unusedContacts?(i=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):i=new a.Contact,i.attach(t,e),i.detector=this.detectors[t.type][e.type],this.contacts&&((this.contacts.prev=i).next=this.contacts),this.contacts=i,this.numContacts++},removeContact:function(t){var e=t.prev,i=t.next;i&&(i.prev=e),e&&(e.next=i),this.contacts==t&&(this.contacts=i),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},checkContact:function(t,e){for(var i,r,n=this.contacts;null!==n;){if(i=n.body1.name||" ",r=n.body2.name||" ",i==t&&r==e||r==t&&i==e)return!!n.touching;n=n.next}return!1},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t,e,i,r,n=!this.isNoStat;n&&(t=a.now());for(var s=this.rigidBodies;null!==s;)s.addedToIsland=!1,s.sleeping&&(s.linearVelocity.testZero()||s.angularVelocity.testZero()||s.position.testDiff(s.sleepPosition)||s.orientation.testDiff(s.sleepOrientation))&&s.awake(),s=s.next;n&&(e=a.now()),this.broadPhase.detectPairs();for(var o=this.broadPhase.pairs,h=this.broadPhase.numPairs;h--;){var l,c,u=o[h];u.shape1.id<u.shape2.id?(l=u.shape1,c=u.shape2):(l=u.shape2,c=u.shape1);var p;p=l.numContacts<c.numContacts?l.contactLink:c.contactLink;for(var d=!1;p;){var f=p.contact;if(f.shape1==l&&f.shape2==c){f.persisting=!0,d=!0;break}p=p.next}d||this.addContact(l,c)}for(n&&(i=a.now(),this.performance.broadPhaseTime=i-e),this.numContactPoints=0,f=this.contacts;null!==f;)if(f.persisting||!f.shape1.aabb.intersectTest(f.shape2.aabb)){var m=f.body1,_=f.body2;(m.isDynamic&&!m.sleeping||_.isDynamic&&!_.sleeping)&&f.updateManifold(),this.numContactPoints+=f.manifold.numPoints,f.persisting=!1,f.constraint.addedToIsland=!1,f=f.next}else{var g=f.next;this.removeContact(f),f=g}n&&(r=a.now(),this.performance.narrowPhaseTime=r-i);var y,v,x=1/this.timeStep;for(y=this.joints;null!==y;y=y.next)y.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],e=a.now(),this.numIslands=0;for(var b=this.rigidBodies;null!==b;b=b.next)if(!(b.addedToIsland||b.isStatic||b.sleeping))if(b.isLonely())b.isDynamic&&b.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(b)?(b.sleepTime+=this.timeStep,b.sleepTime>.5?b.sleep():b.updatePosition(this.timeStep)):(b.sleepTime=0,b.updatePosition(this.timeStep)),this.numIslands++;else{var P=0,T=0,S=1;this.islandStack[0]=b,b.addedToIsland=!0;do{if(s=this.islandStack[--S],this.islandStack[S]=null,s.sleeping=!1,this.islandRigidBodies[P++]=s,!s.isStatic){for(var A=s.contactLink;null!==A;A=A.next){var f=A.contact;if(v=f.constraint,!v.addedToIsland&&f.touching){this.islandConstraints[T++]=v,v.addedToIsland=!0;var g=A.body;g.addedToIsland||(this.islandStack[S++]=g,g.addedToIsland=!0)}}for(var C=s.jointLink;null!==C;C=C.next)v=C.joint,v.addedToIsland||(this.islandConstraints[T++]=v,v.addedToIsland=!0,g=C.body,!g.addedToIsland&&g.isDynamic&&(this.islandStack[S++]=g,g.addedToIsland=!0))}}while(0!=S);for(var E=(new a.Vec3).addTime(this.gravity,this.timeStep),M=P;M--;)s=this.islandRigidBodies[M],s.isDynamic&&s.linearVelocity.addEqual(E);if(this.enableRandomizer)for(M=T;M--;)if(0!==M){var D=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*M|0;v=this.islandConstraints[M],this.islandConstraints[M]=this.islandConstraints[D],this.islandConstraints[D]=v}for(M=T;M--;)this.islandConstraints[M].preSolve(this.timeStep,x);for(var R=this.numIterations;R--;)for(M=T;M--;)this.islandConstraints[M].solve();for(M=T;M--;)this.islandConstraints[M].postSolve(),this.islandConstraints[M]=null;var I=10;for(M=P;M--;)s=this.islandRigidBodies[M],this.callSleep(s)?(s.sleepTime+=this.timeStep,s.sleepTime<I&&(I=s.sleepTime)):(s.sleepTime=0,I=0);if(I>.5)for(M=P;M--;)this.islandRigidBodies[M].sleep(),this.islandRigidBodies[M]=null;else for(M=P;M--;)this.islandRigidBodies[M].updatePosition(this.timeStep),this.islandRigidBodies[M]=null;this.numIslands++}n&&(i=a.now(),this.performance.solvingTime=i-e,i=a.now(),this.performance.upfps(),this.performance.totalTime=i-t)}},a.RigidBody=function(t,e,i,r,n,s,o){this.name=" ",this.MAX_SHAPES=64,this.prev=null,this.next=null,this.type=a.BODY_NULL,this.massInfo=new a.MassInfo,this.position=new a.Vec3(t,e,i),this.orientation=this.rotationAxisToQuad(r||0,n||0,s||0,o||0),this.newPosition=new a.Vec3,this.controlPos=!1,this.newOrientation=new a.Quat,this.newRotation=new a.Vec3,this.currentRotation=new a.Vec3,this.controlRot=!1,this.controlRotInTime=!1,this.linearVelocity=new a.Vec3,this.angularVelocity=new a.Vec3,this.matrix=new a.Mat44,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new a.Vec3,this.sleepOrientation=new a.Quat,this.isStatic=!1,this.isDynamic=!1,this.rotation=new a.Mat33,this.mass=NaN,this.inverseMass=NaN,this.inverseInertia=new a.Mat33,this.localInertia=new a.Mat33,this.inverseLocalInertia=new a.Mat33,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1},a.RigidBody.prototype={constructor:a.RigidBody,addShape:function(t){t.parent&&a.Error("RigidBody","It is not possible that you add to the multi-rigid body the shape of one"),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var e=t;if(e.parent==this){var i=e.prev,r=e.next;null!=i&&(i.next=r),null!=r&&(r.prev=i),this.shapes==e&&(this.shapes=r),e.prev=null,e.next=null,e.parent=null,this.parent&&this.parent.removeShape(e),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,e){var i=void 0===e||e;this.type=t||a.BODY_DYNAMIC,this.isDynamic=this.type==a.BODY_DYNAMIC,this.isStatic=this.type==a.BODY_STATIC,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var r=this.localInertia.elements,n=new a.Mat33,s=new a.Vec3,o=this.shapes;null!=o;o=o.next){o.calculateMassInfo(this.massInfo);var h=this.massInfo.mass,l=o.relativePosition.x,c=o.relativePosition.y,u=o.relativePosition.z;s.addScale(o.relativePosition,h),this.mass+=h,this.rotateInertia(o.relativeRotation,this.massInfo.inertia,n),this.localInertia.addEqual(n),r[0]+=h*(c*c+u*u),r[4]+=h*(l*l+u*u),r[8]+=h*(l*l+c*c);var p=h*l*c,d=h*c*u,f=h*u*l;r[1]-=p,r[3]-=p,r[2]-=d,r[6]-=d,r[5]-=f,r[7]-=f}if(this.inverseMass=1/this.mass,s.scaleEqual(this.inverseMass),i){for(this.position.addEqual(s),o=this.shapes;null!=o;o=o.next)o.relativePosition.subEqual(s);l=s.x,c=s.y,u=s.z,r[0]-=this.mass*(c*c+u*u),r[4]-=this.mass*(l*l+u*u),r[8]-=this.mass*(l*l+c*c),p=this.mass*l*c,d=this.mass*c*u,f=this.mass*u*l,r[1]+=p,r[3]+=p,r[2]+=d,r[6]+=d,r[5]+=f,r[7]+=f}this.inverseLocalInertia.invert(this.localInertia),this.type==a.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var e=this.jointLink;null!=e;)e.body.sleepTime=0,e.body.sleeping=!1,e=e.next;for(var i=this.shapes;null!=i;i=i.next)i.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case a.BODY_STATIC:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case a.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-this.position.x)/t,this.linearVelocity.y=(this.newPosition.y-this.position.y)/t,this.linearVelocity.z=(this.newPosition.z-this.position.z)/t,this.controlPos=!1),this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t);break;default:a.Error("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(t,e,i){var r=t.elements,n=e.elements,s=r[0],o=r[3],a=r[6],h=r[1],l=r[4],c=r[7],u=r[2],p=r[5],d=r[8],f=n[0],m=n[3],_=n[6],g=n[1],y=n[4],v=n[7],x=n[2],b=n[5],P=n[8],T=s*f+h*m+u*_,S=s*g+h*y+u*v,A=s*x+h*b+u*P,C=o*f+l*m+p*_,E=o*g+l*y+p*v,M=o*x+l*b+p*P,D=a*f+c*m+d*_,R=a*g+c*y+d*v,I=a*x+c*b+d*P,O=i.elements;O[0]=T*s+S*h+A*u,O[1]=T*o+S*l+A*p,O[2]=T*a+S*c+A*d,O[3]=C*s+E*h+M*u,O[4]=C*o+E*l+M*p,O[5]=C*a+E*c+M*d,O[6]=D*s+R*h+I*u,O[7]=D*o+R*l+I*p,O[8]=D*a+R*c+I*d},syncShapes:function(){var t=this.orientation.s,e=this.orientation.x,i=this.orientation.y,r=this.orientation.z,n=2*e,s=2*i,o=2*r,a=e*n,h=i*s,l=r*o,c=e*s,u=i*o,p=e*o,d=t*n,f=t*s,m=t*o,_=this.rotation.elements;_[0]=1-h-l,_[1]=c-m,_[2]=p+f,_[3]=c+m,_[4]=1-a-l,_[5]=u-d,_[6]=p-f,_[7]=u+d,_[8]=1-a-h,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var g=this.shapes;null!=g;g=g.next)g.position.mul(this.position,g.relativePosition,this.rotation),g.rotation.mul(this.rotation,g.relativeRotation),g.updateProxy()},applyImpulse:function(t,e){this.linearVelocity.addScale(e,this.inverseMass);var i=new a.Vec3;i.sub(t,this.position).cross(i,e).mulMat(this.inverseInertia,i),this.angularVelocity.addEqual(i)},rotationVectToQuad:function(t){var e=a.EulerToAxis(t.x*a.degtorad,t.y*a.degtorad,t.z*a.degtorad);return this.rotationAxisToQuad(e[0],e[1],e[2],e[3])},rotationAxisToQuad:function(t,e,i,r){var n=e*e+i*i+r*r;n>0&&(n=1/a.sqrt(n),e*=n,i*=n,r*=n);var s=a.sin(.5*t),o=a.cos(.5*t);return new a.Quat(o,s*e,s*i,s*r)},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(a.INV_SCALE),this.controlPos=!0},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0},setRotation:function(t){this.newOrientation=this.rotationVectToQuad(t),this.controlRot=!0},resetPosition:function(t,e,i){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,e,i).multiplyScalar(a.INV_SCALE),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new a.Quat(t.w,t.x,t.y,t.z),this.awake()},resetRotation:function(t,e,i){this.angularVelocity.set(0,0,0),this.orientation=this.rotationVectToQuad(new a.Vec3(t,e,i)),this.awake()},getPosition:function(){return(new a.Vec3).scale(this.position,a.WORLD_SCALE)},getRotation:function(){return(new a.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new a.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var t,e,i=this.matrix.elements;return this.sleeping?i[15]=1:(t=this.rotation.elements,i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=0,i[4]=t[1],i[5]=t[4],i[6]=t[7],i[7]=0,i[8]=t[2],i[9]=t[5],i[10]=t[8],i[11]=0,e=this.position,i[12]=e.x*a.WORLD_SCALE,i[13]=e.y*a.WORLD_SCALE,i[14]=e.z*a.WORLD_SCALE,i[15]=0),i}},a.Body=function(t){var e=t||{};e.world&&(void 0===e.type&&(e.type="box"),this.name=e.name||"",this.body=e.world.add(e))},a.Body.prototype={constructor:a.Body,setPosition:function(t){this.body.setPosition(t)},setQuaternion:function(t){this.body.setQuaternion(t)},setRotation:function(t){this.body.setRotation(t)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(t,e,i){this.body.resetPosition(t,e,i)},resetRotation:function(t,e,i){this.body.resetRotation(t,e,i)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(t){this.body.checkContact(t)}},a.Link=function(t){var e=t||{};e.world&&(void 0===e.type&&(e.type="jointHinge"),this.name=e.name||"",this.joint=e.world.add(e))},a.Link.prototype={constructor:a.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}},a.Dictionary=function(){this.data={},this.keys=[]},a.Dictionary.prototype={constructor:a.Dictionary,set:function(t){var e=t.id;this.get[e]||this.keys.push(e),this.data[e]=t},get:function(t){return this.data[t]},del:function(t){var e=this.keys,i=e.indexOf(t.id);i>-1&&(delete this.data[e[i]],e.splice(i,1))},reset:function(){for(var t,e=this.data,i=this.keys;i.length>0;)t=i.pop(),delete e[t]}},a.Performance=function(t){this.parent=t,this.infos=new o(13),this.f=[0,0,0],this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhase=this.types[this.parent.broadPhase.types],this.version=a.REVISION,this.fps=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0},a.Performance.prototype={upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},updatingTime:function(){return a.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){return["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+a.fix(this.broadPhaseTime)+"<br>","narrow-phase "+a.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+a.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+a.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+"<br>"].join("\n")},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updatingTime(),this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}},a.Mat44=function(t,e,i,r,n,s,a,h,l,c,u,p,d,f,m,_){this.elements=new o(16);var g=this.elements;g[0]=void 0!==t?t:1,g[4]=e||0,g[8]=i||0,g[12]=r||0,g[1]=n||0,g[5]=void 0!==s?s:1,g[9]=a||0,g[13]=h||0,g[2]=l||0,g[6]=c||0,g[10]=void 0!==u?u:1,g[14]=p||0,g[3]=d||0,g[7]=f||0,g[11]=m||0,g[15]=void 0!==_?_:1},a.Mat44.prototype={constructor:a.Mat44,set:function(t,e,i,r,n,s,o,a,h,l,c,u,p,d,f,m){var _=this.elements;return _[0]=t,_[4]=e,_[8]=i,_[12]=r,_[1]=n,_[5]=s,_[9]=o,_[13]=a,_[2]=h,_[6]=l,_[10]=c,_[14]=u,_[3]=p,_[7]=d,_[11]=f,_[15]=m,this}},a.Mat33=function(t,e,i,r,n,s,a,h,l){this.elements=new o(9);this.elements;this.init(void 0!==t?t:1,e||0,i||0,r||0,void 0!==n?n:1,s||0,a||0,h||0,void 0!==l?l:1)},a.Mat33.prototype={constructor:a.Mat33,set:function(t,e,i,r,n,s,o,a,h){var l=this.elements;return l[0]=t,l[1]=e,l[2]=i,l[3]=r,l[4]=n,l[5]=s,l[6]=o,l[7]=a,l[8]=h,this},init:function(t,e,i,r,n,s,o,a,h){var l=this.elements;return l[0]=t,l[1]=e,l[2]=i,l[3]=r,l[4]=n,l[5]=s,l[6]=o,l[7]=a,l[8]=h,this},multiply:function(t){var e=this.elements;return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,this},add:function(t,e){var i=this.elements,r=t.elements,n=e.elements;return i[0]=r[0]+n[0],i[1]=r[1]+n[1],i[2]=r[2]+n[2],i[3]=r[3]+n[3],i[4]=r[4]+n[4],i[5]=r[5]+n[5],i[6]=r[6]+n[6],i[7]=r[7]+n[7],i[8]=r[8]+n[8],this},addEqual:function(t){var e=this.elements,i=t.elements;return e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[3],e[4]+=i[4],e[5]+=i[5],e[6]+=i[6],e[7]+=i[7],e[8]+=i[8],this},sub:function(t,e){var i=this.elements,r=t.elements,n=e.elements;return i[0]=r[0]-n[0],i[1]=r[1]-n[1],i[2]=r[2]-n[2],i[3]=r[3]-n[3],i[4]=r[4]-n[4],i[5]=r[5]-n[5],i[6]=r[6]-n[6],i[7]=r[7]-n[7],i[8]=r[8]-n[8],this},subEqual:function(t){var e=this.elements,i=t.elements;return e[0]-=i[0],e[1]-=i[1],e[2]-=i[2],e[3]-=i[3],e[4]-=i[4],e[5]-=i[5],e[6]-=i[6],e[7]-=i[7],e[8]-=i[8],this},scale:function(t,e){var i=this.elements,r=t.elements;return i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i[3]=r[3]*e,i[4]=r[4]*e,i[5]=r[5]*e,i[6]=r[6]*e,i[7]=r[7]*e,i[8]=r[8]*e,this},scaleEqual:function(t){var e=this.elements;return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,this},mul:function(t,e){var i=this.elements,r=t.elements,n=e.elements,s=r[0],o=r[3],a=r[6],h=r[1],l=r[4],c=r[7],u=r[2],p=r[5],d=r[8],f=n[0],m=n[3],_=n[6],g=n[1],y=n[4],v=n[7],x=n[2],b=n[5],P=n[8];return i[0]=s*f+h*m+u*_,i[1]=s*g+h*y+u*v,i[2]=s*x+h*b+u*P,i[3]=o*f+l*m+p*_,i[4]=o*g+l*y+p*v,i[5]=o*x+l*b+p*P,i[6]=a*f+c*m+d*_,i[7]=a*g+c*y+d*v,i[8]=a*x+c*b+d*P,this},mulScale:function(t,e,i,r,n){var s=n||!1,o=this.elements,a=t.elements;return s?(o[0]=e*a[0],o[1]=e*a[1],o[2]=e*a[2],o[3]=i*a[3],o[4]=i*a[4],o[5]=i*a[5],o[6]=r*a[6],o[7]=r*a[7],o[8]=r*a[8]):(o[0]=a[0]*e,o[1]=a[1]*i,o[2]=a[2]*r,o[3]=a[3]*e,o[4]=a[4]*i,o[5]=a[5]*r,o[6]=a[6]*e,o[7]=a[7]*i,o[8]=a[8]*r),this},mulRotate:function(t,e,i,r,n,s){var o=s||!1,h=a.sin(e),l=a.cos(e),c=1-l,u=i*i*c+l,p=i*r*c-n*h,d=i*n*c+r*h,f=r*i*c+n*h,m=r*r*c+l,_=r*n*c-i*h,g=n*i*c-r*h,y=n*r*c+i*h,v=n*n*c+l,x=t.elements,b=x[0],P=x[3],T=x[6],S=x[1],A=x[4],C=x[7],E=x[2],M=x[5],D=x[8],R=this.elements;return o?(R[0]=u*b+p*P+d*T,R[1]=u*S+p*A+d*C,R[2]=u*E+p*M+d*D,R[3]=f*b+m*P+_*T,R[4]=f*S+m*A+_*C,R[5]=f*E+m*M+_*D,R[6]=g*b+y*P+v*T,R[7]=g*S+y*A+v*C,R[8]=g*E+y*M+v*D):(R[0]=b*u+S*f+E*g,R[1]=b*p+S*m+E*y,R[2]=b*d+S*_+E*v,R[3]=P*u+A*f+M*g,R[4]=P*p+A*m+M*y,R[5]=P*d+A*_+M*v,R[6]=T*u+C*f+D*g,R[7]=T*p+C*m+D*y,R[8]=T*d+C*_+D*v),this},transpose:function(t){var e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8],this},setQuat:function(t){var e=this.elements,i=2*t.x,r=2*t.y,n=2*t.z,s=t.x*i,o=t.y*r,a=t.z*n,h=t.x*r,l=t.y*n,c=t.x*n,u=t.s*i,p=t.s*r,d=t.s*n;return e[0]=1-o-a,e[1]=h-d,e[2]=c+p,e[3]=h+d,e[4]=1-s-a,e[5]=l-u,e[6]=c-p,e[7]=l+u,e[8]=1-s-o,this},invert:function(t){var e=this.elements,i=t.elements,r=i[0],n=i[3],s=i[6],o=i[1],a=i[4],h=i[7],l=i[2],c=i[5],u=i[8],p=a*u-h*c,d=h*l-o*u,f=o*c-a*l,m=r*p+n*d+s*f;return 0!=m&&(m=1/m),e[0]=m*p,e[1]=m*d,e[2]=m*f,e[3]=m*(c*s-n*u),e[4]=m*(r*u-l*s),e[5]=m*(l*n-r*c),e[6]=m*(n*h-a*s),e[7]=m*(o*s-r*h),e[8]=m*(r*a-o*n),this},toEuler:function(){function t(t){return a.min(a.max(t,-1),1)}var e=this.elements,i=e[0],r=e[3],n=e[6],s=(e[1],e[4]),o=e[7],h=(e[2],e[5]),l=e[8],c=new a.Vec3;new a.Quat;return c.y=a.asin(t(n)),a.abs(n)<.99999?(c.x=a.atan2(-o,l),c.z=a.atan2(-r,i)):(c.x=a.atan2(h,s),c.z=0),c},toString:function(){var t=this.elements;return"Mat33|"+t[0].toFixed(4)+", "+t[1].toFixed(4)+", "+t[2].toFixed(4)+"|\n     |"+t[3].toFixed(4)+", "+t[4].toFixed(4)+", "+t[5].toFixed(4)+"|\n     |"+t[6].toFixed(4)+", "+t[7].toFixed(4)+", "+t[8].toFixed(4)+"|"},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var e=t.elements;return this.set(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]),this},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}},a.Quat=function(t,e,i,r){this.s=void 0!==t?t:1,this.x=e||0,this.y=i||0,this.z=r||0},a.Quat.prototype={constructor:a.Quat,set:function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.s=r,this},init:function(t,e,i,r){return this.s=void 0!==t?t:1,this.x=e||0,this.y=i||0,this.z=r||0,this},add:function(t,e){return this.s=t.s+e.s,this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addTime:function(t,e){var i=t.x,r=t.y,n=t.z,s=this.s,o=this.x,h=this.y,l=this.z;e*=.5;var c=(-i*o-r*h-n*l)*e,u=(i*s+r*l-n*h)*e,p=(-i*l+r*s+n*o)*e,d=(i*h-r*o+n*s)*e;s+=c,o+=u,h+=p,l+=d;var f=1/a.sqrt(s*s+o*o+h*h+l*l);return this.s=s*f,this.x=o*f,this.y=h*f,this.z=l*f,this},sub:function(t,e){return this.s=t.s-e.s,this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},scale:function(t,e){return this.s=t.s*e,this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this},mul:function(t,e){var i=t.x,r=t.y,n=t.z,s=t.s,o=e.x,a=e.y,h=e.z,l=e.s;return this.x=i*l+s*o+r*h-n*a,this.y=r*l+s*a+n*o-i*h,this.z=n*l+s*h+i*a-r*o,this.s=s*l-i*o-r*a-n*h,this},arc:function(t,e){var i=t.x,r=t.y,n=t.z,s=e.x,o=e.y,h=e.z,l=i*s+r*o+n*h;if(l==-1)return s=r*i-n*n,o=-n*r-i*i,h=i*n+r*r,l=1/a.sqrt(s*s+o*o+h*h),this.s=0,this.x=s*l,this.y=o*l,this.z=h*l,this;var c=r*h-n*o,u=n*s-i*h,p=i*o-r*s;return this.s=a.sqrt(.5*(1+l)),l=.5/this.s,this.x=c*l,this.y=u*l,this.z=p*l,this},normalize:function(t){var e=a.sqrt(t.s*t.s+t.x*t.x+t.y*t.y+t.z*t.z);return e>0&&(e=1/e),this.s=t.s*e,this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this},invert:function(t){return this.s=t.s,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},length:function(){return a.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.s=t.s,this.x=t.x,this.y=t.y,this.z=t.z,this},testDiff:function(t){return this.s!==t.s||this.x!==t.x||this.y!==t.y||this.z!==t.z},clone:function(t){return new a.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}},a.Quaternion=function(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1},a.Quaternion.prototype={constructor:a.Quaternion,setFromRotationMatrix:function(t){var e,i=t.elements,r=i[0],n=i[1],s=i[2],o=i[3],h=i[4],l=i[5],c=i[6],u=i[7],p=i[8],d=r+h+p;return d>0?(e=.5/a.sqrt(d+1),this.w=.25/e,this.x=(u-l)*e,this.y=(s-c)*e,this.z=(o-n)*e):r>h&&r>p?(e=2*a.sqrt(1+r-h-p),this.w=(u-l)/e,this.x=.25*e,this.y=(n+o)/e,this.z=(s+c)/e):h>p?(e=2*a.sqrt(1+h-r-p),this.w=(s-c)/e,this.x=(n+o)/e,this.y=.25*e,this.z=(l+u)/e):(e=2*a.sqrt(1+p-r-h),this.w=(o-n)/e,this.x=(s+c)/e,this.y=(l+u)/e,this.z=.25*e),this}},a.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},a.Vec3.prototype={constructor:a.Vec3,init:function(t,e,i){return this.x=t||0,this.y=e||0,this.z=i||0,this},set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},add:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addTime:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},addScale:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},scale:function(t,e){return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},cross:function(t,e){var i=t.x,r=t.y,n=t.z,s=e.x,o=e.y,a=e.z;return this.x=r*a-n*o,this.y=n*s-i*a,this.z=i*o-r*s,this},mul:function(t,e,i){var r=i.elements;return this.x=t.x+e.x*r[0]+e.y*r[1]+e.z*r[2],this.y=t.y+e.x*r[3]+e.y*r[4]+e.z*r[5],this.z=t.z+e.x*r[6]+e.y*r[7]+e.z*r[8],this},mulMat:function(t,e){var i=t.elements;return this.x=i[0]*e.x+i[1]*e.y+i[2]*e.z,this.y=i[3]*e.x+i[4]*e.y+i[5]*e.z,this.z=i[6]*e.x+i[7]*e.y+i[8]*e.z,this},normalize:function(t){var e=t.x,i=t.y,r=t.z,n=e*e+i*i+r*r;return n>0&&(n=1/a.sqrt(n),this.x=e*n,this.y=i*n,this.z=r*n),this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return a.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyQuaternion:function(t){var e=this.x,i=this.y,r=this.z,n=t.x,s=t.y,o=t.z,a=t.s,h=a*e+s*r-o*i,l=a*i+o*e-n*r,c=a*r+n*i-s*e,u=-n*e-s*i-o*r;return this.x=h*a+u*-n+l*-o-c*-s,this.y=l*a+u*-s+c*-n-h*-o,this.z=c*a+u*-o+h*-s-l*-n,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return t.x!==this.x||t.y!==this.y||t.z!==this.z},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},norm:function(){return this.divideScalar(this.length())}},a.Euler=function(t,e,i,r){this._x=t||0,this._y=e||0,this._z=i||0,this._order=r||a.Euler.DefaultOrder},a.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],a.Euler.DefaultOrder="XYZ",a.clamp=function(t,e,i){return t<e?e:t>i?i:t},a.Euler.prototype={constructor:a.Euler,_x:0,_y:0,_z:0,_order:a.Euler.DefaultOrder,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get order(){return this._order},set order(t){this._order=t,this.onChangeCallback()},set:function(t,e,i,r){return this._x=t,this._y=e,this._z=i,this._order=r||this._order,this.onChangeCallback(),this},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},setFromRotationMatrix:function(t,e){var i=a.clamp,r=t.elements,n=r[0],s=r[1],o=r[2],h=r[3],l=r[4],c=r[5],u=r[6],p=r[7],d=r[8];return e=e||this._order,"XYZ"===e?(this._y=a.asin(i(o,-1,1)),a.abs(o)<.99999?(this._x=a.atan2(-c,d),this._z=a.atan2(-s,n)):(this._x=a.atan2(p,l),this._z=0)):"YXZ"===e?(this._x=a.asin(-i(c,-1,1)),a.abs(c)<.99999?(this._y=a.atan2(o,d),this._z=a.atan2(h,l)):(this._y=a.atan2(-u,n),this._z=0)):"ZXY"===e?(this._x=a.asin(i(p,-1,1)),a.abs(p)<.99999?(this._y=a.atan2(-u,d),this._z=a.atan2(-s,l)):(this._y=0,this._z=a.atan2(h,n))):"ZYX"===e?(this._y=a.asin(-i(u,-1,1)),a.abs(u)<.99999?(this._x=a.atan2(p,d),this._z=a.atan2(h,n)):(this._x=0,this._z=a.atan2(-s,l))):"YZX"===e?(this._z=a.asin(i(h,-1,1)),a.abs(h)<.99999?(this._x=a.atan2(-c,l),this._y=a.atan2(-u,n)):(this._x=0,this._y=a.atan2(o,d))):"XZY"===e?(this._z=a.asin(-i(s,-1,1)),a.abs(s)<.99999?(this._x=a.atan2(p,l),this._y=a.atan2(o,n)):(this._x=a.atan2(-c,d),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+e),this._order=e,this.onChangeCallback(),this},setFromQuaternion:function(t,e,i){var r=a.clamp,n=t.x*t.x,s=t.y*t.y,o=t.z*t.z,h=t.s*t.s;return e=e||this._order,"XYZ"===e?(this._x=a.atan2(2*(t.x*t.s-t.y*t.z),h-n-s+o),this._y=a.asin(r(2*(t.x*t.z+t.y*t.s),-1,1)),this._z=a.atan2(2*(t.z*t.s-t.x*t.y),h+n-s-o)):"YXZ"===e?(this._x=a.asin(r(2*(t.x*t.s-t.y*t.z),-1,1)),this._y=a.atan2(2*(t.x*t.z+t.y*t.s),h-n-s+o),this._z=a.atan2(2*(t.x*t.y+t.z*t.s),h-n+s-o)):"ZXY"===e?(this._x=a.asin(r(2*(t.x*t.s+t.y*t.z),-1,1)),this._y=a.atan2(2*(t.y*t.s-t.z*t.x),h-n-s+o),this._z=a.atan2(2*(t.z*t.s-t.x*t.y),h-n+s-o)):"ZYX"===e?(this._x=a.atan2(2*(t.x*t.s+t.z*t.y),h-n-s+o),this._y=a.asin(r(2*(t.y*t.s-t.x*t.z),-1,1)),this._z=a.atan2(2*(t.x*t.y+t.z*t.s),h+n-s-o)):"YZX"===e?(this._x=a.atan2(2*(t.x*t.s-t.z*t.y),h-n+s-o),this._y=a.atan2(2*(t.y*t.s-t.x*t.z),h+n-s-o),this._z=a.asin(r(2*(t.x*t.y+t.z*t.s),-1,1))):"XZY"===e?(this._x=a.atan2(2*(t.x*t.s+t.y*t.z),h-n+s-o),this._y=a.atan2(2*(t.x*t.z+t.y*t.s),h+n-s-o),this._z=a.asin(r(2*(t.z*t.s-t.x*t.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+e),this._order=e,i!==!1&&this.onChangeCallback(),this},reorder:function(){var t=new a.Quat;return function(e){t.setFromEuler(this),this.setFromQuaternion(t,e)}}(),equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){},clone:function(){return new a.Euler(this._x,this._y,this._z,this._order)}},a.EulerToAxis=function(t,e,i){var r=a.cos(.5*e),n=a.sin(.5*e),s=a.cos(.5*i),o=a.sin(.5*i),h=a.cos(.5*t),l=a.sin(.5*t),c=r*s,u=n*o,p=c*h-u*l,d=c*l+u*h,f=n*s*h+r*o*l,m=r*o*h-n*s*l,_=2*a.acos(p),g=d*d+f*f+m*m;return g<.001?(d=1,f=m=0):(g=a.sqrt(g),d/=g,f/=g,m/=g),[_,d,f,m]},a.EulerToMatrix=function(t,e,i){var r=a.cos(e),n=a.sin(e),s=a.cos(i),o=a.sin(i),h=a.cos(t),l=a.sin(t),c=new a.Mat33,u=c.elements;return u[0]=r*s,u[1]=n*l-r*o*h,u[2]=r*o*l+n*h,u[3]=o,u[4]=s*h,u[5]=-s*l,u[6]=-n*s,u[7]=n*o*h+r*l,u[8]=-n*o*l+r*h,c},a.MatrixToEuler=function(t){var e,i,r,n=t.elements;return n[3]>.998?(i=a.atan2(n[2],n[8]),r=a.PI/2,e=0):n[3]<-.998?(i=a.atan2(n[2],n[8]),r=-a.PI/2,e=0):(i=a.atan2(-n[6],n[0]),e=a.atan2(-n[5],n[4]),r=a.asin(n[3])),[e,i,r]},a.unwrapDegrees=function(t){return t%=360,t>180&&(t-=360),t<-180&&(t+=360),t},a.unwrapRadian=function(t){return t%=a.TwoPI,t>a.PI&&(t-=a.TwoPI),t<-a.PI&&(t+=a.TwoPI),t},a.Distance3d=function(t,e){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2];return a.sqrt(i*i+r*r+n*n)},a.Constraint=function(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1},a.Constraint.prototype={constructor:a.Constraint,preSolve:function(t,e){a.Error("Constraint","Inheritance error.")},solve:function(){a.Error("Constraint","Inheritance error.")},postSolve:function(){a.Error("Constraint","Inheritance error.")}},a.Joint=function(t){a.Constraint.call(this),this.name="",this.type=a.JOINT_NULL,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new a.Vec3).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new a.Vec3).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new a.Vec3,this.relativeAnchorPoint2=new a.Vec3,this.anchorPoint1=new a.Vec3,this.anchorPoint2=new a.Vec3,this.allowCollision=t.allowCollision,this.b1Link=new a.JointLink(this),this.b2Link=new a.JointLink(this),this.matrix=new a.Mat44},a.Joint.prototype=Object.create(a.Constraint.prototype),a.Joint.prototype.constructor=a.Joint,a.Joint.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1),this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},a.Joint.prototype.attach=function(){this.b1Link.body=this.body2,this.b2Link.body=this.body1,null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++},a.Joint.prototype.detach=function(){var t=this.b1Link.prev,e=this.b1Link.next;null!=t&&(t.next=e),null!=e&&(e.prev=t),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=e),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,t=this.b2Link.prev,e=this.b2Link.next,null!=t&&(t.next=e),null!=e&&(e.prev=t),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=e),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--,this.b1Link.body=null,this.b2Link.body=null},a.Joint.prototype.awake=function(){this.body1.awake(),this.body2.awake()},a.Joint.prototype.preSolve=function(t,e){},a.Joint.prototype.solve=function(){},a.Joint.prototype.postSolve=function(){},a.Joint.prototype.remove=function(){this.dispose()},a.Joint.prototype.dispose=function(){this.parent.removeJoint(this)},a.Joint.prototype.getPosition=function(){return[(new a.Vec3).scale(this.anchorPoint1,a.WORLD_SCALE),(new a.Vec3).scale(this.anchorPoint2,a.WORLD_SCALE)]},a.Joint.prototype.getMatrix=function(){var t=this.matrix.elements,e=this.anchorPoint1,i=this.anchorPoint2;return t[0]=e.x*a.WORLD_SCALE,t[1]=e.y*a.WORLD_SCALE,t[2]=e.z*a.WORLD_SCALE,t[3]=0,t[4]=i.x*a.WORLD_SCALE,t[5]=i.y*a.WORLD_SCALE,t[6]=i.z*a.WORLD_SCALE,t[7]=0,t},a.JointConfig=function(){this.body1=null,this.body2=null,this.localAnchorPoint1=new a.Vec3,this.localAnchorPoint2=new a.Vec3,this.localAxis1=new a.Vec3,this.localAxis2=new a.Vec3,this.allowCollision=!1},a.JointLink=function(t){this.prev=null,this.next=null,this.body=null,this.joint=t},a.LimitMotor=function(t,e){e=e||!1,this.axis=t,this.angle=0,this.lowerLimit=e?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0},a.LimitMotor.prototype={constructor:a.LimitMotor,setLimit:function(t,e){this.lowerLimit=t,this.upperLimit=e},setMotor:function(t,e){this.motorSpeed=t,this.maxMotorForce=e},setSpring:function(t,e){this.frequency=t,this.dampingRatio=e}},a.BallAndSocketJoint=function(t){a.Joint.call(this,t),this.type=a.JOINT_BALL_AND_SOCKET,this.lc=new a.LinearConstraint(this)},a.BallAndSocketJoint.prototype=Object.create(a.Joint.prototype),a.BallAndSocketJoint.prototype.constructor=a.BallAndSocketJoint,a.BallAndSocketJoint.prototype.preSolve=function(t,e){this.updateAnchorPoints(),this.lc.preSolve(t,e)},a.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()},a.BallAndSocketJoint.prototype.postSolve=function(){},a.DistanceJoint=function(t,e,i){a.Joint.call(this,t),this.type=a.JOINT_DISTANCE,this.normal=new a.Vec3,this.nr=new a.Vec3,this.limitMotor=new a.LimitMotor(this.normal,!0),this.limitMotor.lowerLimit=e,this.limitMotor.upperLimit=i,this.t=new a.TranslationalConstraint(this,this.limitMotor)},a.DistanceJoint.prototype=Object.create(a.Joint.prototype),a.DistanceJoint.prototype.constructor=a.DistanceJoint,a.DistanceJoint.prototype.preSolve=function(t,e){this.updateAnchorPoints(),this.nr.sub(this.anchorPoint2,this.anchorPoint1),this.normal.normalize(this.nr),this.t.preSolve(t,e)},a.DistanceJoint.prototype.solve=function(){this.t.solve()},a.DistanceJoint.prototype.postSolve=function(){},a.HingeJoint=function(t,e,i){a.Joint.call(this,t),this.type=a.JOINT_HINGE,this.localAxis1=t.localAxis1.clone().norm(),this.localAxis2=t.localAxis2.clone().norm(),this.localAngle1=new a.Vec3(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var r=(new a.Mat33).setQuat((new a.Quat).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new a.Vec3).mulMat(r,this.localAngle1),this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.ax1=new a.Vec3,this.ax2=new a.Vec3,this.an1=new a.Vec3,this.an2=new a.Vec3,this.limitMotor=new a.LimitMotor(this.nor,!1),this.limitMotor.lowerLimit=e,this.limitMotor.upperLimit=i,this.lc=new a.LinearConstraint(this),this.r3=new a.Rotational3Constraint(this,this.limitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0))},a.HingeJoint.prototype=Object.create(a.Joint.prototype),a.HingeJoint.prototype.constructor=a.HingeJoint,a.HingeJoint.prototype.preSolve=function(t,e){var i,r,n,s;this.updateAnchorPoints(),this.ax1.mulMat(this.body1.rotation,this.localAxis1),this.ax2.mulMat(this.body2.rotation,this.localAxis2),this.an1.mulMat(this.body1.rotation,this.localAngle1),this.an2.mulMat(this.body2.rotation,this.localAngle2),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm(),this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm(),this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x),s=this.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z),this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0?this.limitMotor.angle=-s:this.limitMotor.angle=s,i=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y,r=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z,n=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x,this.r3.limitMotor2.angle=this.tan.x*i+this.tan.y*r+this.tan.z*n,this.r3.limitMotor3.angle=this.bin.x*i+this.bin.y*r+this.bin.z*n,this.r3.preSolve(t,e),this.lc.preSolve(t,e)},a.HingeJoint.prototype.solve=function(){this.r3.solve(),this.lc.solve()},a.HingeJoint.prototype.postSolve=function(){},a.HingeJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?a.PI:a.acos(t)},a.PrismaticJoint=function(t,e,i){a.Joint.call(this,t),this.type=a.JOINT_PRISMATIC,this.localAxis1=(new a.Vec3).normalize(t.localAxis1),this.localAxis2=(new a.Vec3).normalize(t.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.ac=new a.AngularConstraint(this,(new a.Quat).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new a.LimitMotor(this.nor,!0),this.limitMotor.lowerLimit=e,this.limitMotor.upperLimit=i,this.t3=new a.Translational3Constraint(this,this.limitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0))},a.PrismaticJoint.prototype=Object.create(a.Joint.prototype),a.PrismaticJoint.prototype.constructor=a.PrismaticJoint,a.PrismaticJoint.prototype.preSolve=function(t,e){var i,r;this.updateAnchorPoints(),i=this.body1.rotation.elements;var n=this.localAxis1X*i[0]+this.localAxis1Y*i[1]+this.localAxis1Z*i[2],s=this.localAxis1X*i[3]+this.localAxis1Y*i[4]+this.localAxis1Z*i[5],o=this.localAxis1X*i[6]+this.localAxis1Y*i[7]+this.localAxis1Z*i[8];i=this.body2.rotation.elements;var h=this.localAxis2X*i[0]+this.localAxis2Y*i[1]+this.localAxis2Z*i[2],l=this.localAxis2X*i[3]+this.localAxis2Y*i[4]+this.localAxis2Z*i[5],c=this.localAxis2X*i[6]+this.localAxis2Y*i[7]+this.localAxis2Z*i[8],u=n*this.body2.inverseMass+h*this.body1.inverseMass,p=s*this.body2.inverseMass+l*this.body1.inverseMass,d=o*this.body2.inverseMass+c*this.body1.inverseMass;r=a.sqrt(u*u+p*p+d*d),r>0&&(r=1/r),u*=r,p*=r,d*=r;var f=p*u-d*d,m=-d*p-u*u,_=u*d+p*p;r=1/a.sqrt(f*f+m*m+_*_),f*=r,m*=r,_*=r;var g=p*_-d*m,y=d*f-u*_,v=u*m-p*f;this.nor.init(u,p,d),this.tan.init(f,m,_),this.bin.init(g,y,v),this.ac.preSolve(t,e),this.t3.preSolve(t,e)},a.PrismaticJoint.prototype.solve=function(){this.ac.solve(),this.t3.solve()},a.PrismaticJoint.prototype.postSolve=function(){},a.SliderJoint=function(t,e,i){a.Joint.call(this,t),this.type=a.JOINT_SLIDER,this.localAxis1=(new a.Vec3).normalize(t.localAxis1),this.localAxis2=(new a.Vec3).normalize(t.localAxis2);var r;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,r=1/a.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=r,this.localAngAxis1Y*=r,this.localAngAxis1Z*=r,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var n=(new a.Mat33).setQuat((new a.Quat).arc(this.localAxis1,this.localAxis2)),s=n.elements;this.localAngAxis2X=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],this.localAngAxis2Y=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],this.localAngAxis2Z=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8],this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.rotationalLimitMotor=new a.LimitMotor(this.nor,!1),this.r3=new a.Rotational3Constraint(this,this.rotationalLimitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0)),this.translationalLimitMotor=new a.LimitMotor(this.nor,!0),this.translationalLimitMotor.lowerLimit=e,this.translationalLimitMotor.upperLimit=i,this.t3=new a.Translational3Constraint(this,this.translationalLimitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0))},a.SliderJoint.prototype=Object.create(a.Joint.prototype),a.SliderJoint.prototype.constructor=a.SliderJoint,a.SliderJoint.prototype.preSolve=function(t,e){var i,r,n,s;this.updateAnchorPoints(),i=this.body1.rotation.elements;var o=this.localAxis1X*i[0]+this.localAxis1Y*i[1]+this.localAxis1Z*i[2],h=this.localAxis1X*i[3]+this.localAxis1Y*i[4]+this.localAxis1Z*i[5],l=this.localAxis1X*i[6]+this.localAxis1Y*i[7]+this.localAxis1Z*i[8],c=this.localAngAxis1X*i[0]+this.localAngAxis1Y*i[1]+this.localAngAxis1Z*i[2],u=this.localAngAxis1X*i[3]+this.localAngAxis1Y*i[4]+this.localAngAxis1Z*i[5],p=this.localAngAxis1X*i[6]+this.localAngAxis1Y*i[7]+this.localAngAxis1Z*i[8];i=this.body2.rotation.elements;var d=this.localAxis2X*i[0]+this.localAxis2Y*i[1]+this.localAxis2Z*i[2],f=this.localAxis2X*i[3]+this.localAxis2Y*i[4]+this.localAxis2Z*i[5],m=this.localAxis2X*i[6]+this.localAxis2Y*i[7]+this.localAxis2Z*i[8],_=this.localAngAxis2X*i[0]+this.localAngAxis2Y*i[1]+this.localAngAxis2Z*i[2],g=this.localAngAxis2X*i[3]+this.localAngAxis2Y*i[4]+this.localAngAxis2Z*i[5],y=this.localAngAxis2X*i[6]+this.localAngAxis2Y*i[7]+this.localAngAxis2Z*i[8],v=o*this.body2.inverseMass+d*this.body1.inverseMass,x=h*this.body2.inverseMass+f*this.body1.inverseMass,b=l*this.body2.inverseMass+m*this.body1.inverseMass;r=a.sqrt(v*v+x*x+b*b),r>0&&(r=1/r),v*=r,x*=r,b*=r;var P=x*v-b*b,T=-b*x-v*v,S=v*b+x*x;r=1/a.sqrt(P*P+T*T+S*S),P*=r,T*=r,S*=r;var A=x*S-b*T,C=b*P-v*S,E=v*T-x*P;this.nor.init(v,x,b),this.tan.init(P,T,S),this.bin.init(A,C,E),this.rotationalLimitMotor.angle=v*(u*y-p*g)+x*(p*_-c*y)+b*(c*g-u*_)<0?-this.acosClamp(c*_+u*g+p*y):this.acosClamp(c*_+u*g+p*y),r=h*m-l*f,n=l*d-o*m,s=o*f-h*d,this.r3.limitMotor2.angle=P*r+T*n+S*s,this.r3.limitMotor3.angle=A*r+C*n+E*s,this.r3.preSolve(t,e),this.t3.preSolve(t,e)},a.SliderJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},a.SliderJoint.prototype.postSolve=function(){},a.SliderJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?a.PI:a.acos(t)},a.WheelJoint=function(t){a.Joint.call(this,t),this.type=a.JOINT_WHEEL,this.localAxis1=(new a.Vec3).normalize(t.localAxis1),this.localAxis2=(new a.Vec3).normalize(t.localAxis2);var e;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var i=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(i>-1&&i<1)this.localAngAxis1X=this.localAxis2X-i*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-i*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-i*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-i*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-i*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-i*this.localAxis2Z,e=1/a.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=e,this.localAngAxis1Y*=e,this.localAngAxis1Z*=e,e=1/a.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=e,this.localAngAxis2Y*=e,this.localAngAxis2Z*=e;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,e=1/a.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=e,this.localAngAxis1Y*=e,this.localAngAxis1Z*=e;var r=(new a.Mat33).setQuat((new a.Quat).arc(this.localAxis1,this.localAxis2)),n=r.elements;this.localAngAxis2X=this.localAngAxis1X*n[0]+this.localAngAxis1Y*n[1]+this.localAngAxis1Z*n[2],this.localAngAxis2Y=this.localAngAxis1X*n[3]+this.localAngAxis1Y*n[4]+this.localAngAxis1Z*n[5],this.localAngAxis2Z=this.localAngAxis1X*n[6]+this.localAngAxis1Y*n[7]+this.localAngAxis1Z*n[8]}this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.translationalLimitMotor=new a.LimitMotor(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new a.LimitMotor(this.tan,!1),this.rotationalLimitMotor2=new a.LimitMotor(this.bin,!1),this.t3=new a.Translational3Constraint(this,new a.LimitMotor(this.nor,!0),this.translationalLimitMotor,new a.LimitMotor(this.bin,!0)),this.t3.weight=1,this.r3=new a.Rotational3Constraint(this,new a.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)},a.WheelJoint.prototype=Object.create(a.Joint.prototype),a.WheelJoint.prototype.constructor=a.WheelJoint,a.WheelJoint.prototype.preSolve=function(t,e){var i,r;this.updateAnchorPoints(),i=this.body1.rotation.elements;var n=this.localAxis1X*i[0]+this.localAxis1Y*i[1]+this.localAxis1Z*i[2],s=this.localAxis1X*i[3]+this.localAxis1Y*i[4]+this.localAxis1Z*i[5],o=this.localAxis1X*i[6]+this.localAxis1Y*i[7]+this.localAxis1Z*i[8],h=this.localAngAxis1X*i[0]+this.localAngAxis1Y*i[1]+this.localAngAxis1Z*i[2],l=this.localAngAxis1X*i[3]+this.localAngAxis1Y*i[4]+this.localAngAxis1Z*i[5],c=this.localAngAxis1X*i[6]+this.localAngAxis1Y*i[7]+this.localAngAxis1Z*i[8];i=this.body2.rotation.elements;var u=this.localAxis2X*i[0]+this.localAxis2Y*i[1]+this.localAxis2Z*i[2],p=this.localAxis2X*i[3]+this.localAxis2Y*i[4]+this.localAxis2Z*i[5],d=this.localAxis2X*i[6]+this.localAxis2Y*i[7]+this.localAxis2Z*i[8],f=this.localAngAxis2X*i[0]+this.localAngAxis2Y*i[1]+this.localAngAxis2Z*i[2],m=this.localAngAxis2X*i[3]+this.localAngAxis2Y*i[4]+this.localAngAxis2Z*i[5],_=this.localAngAxis2X*i[6]+this.localAngAxis2Y*i[7]+this.localAngAxis2Z*i[8];this.r3.limitMotor1.angle=n*u+s*p+o*d,this.rotationalLimitMotor1.angle=n*(l*d-c*p)+s*(c*u-h*d)+o*(h*p-l*u)<0?-this.acosClamp(h*u+l*p+c*d):this.acosClamp(h*u+l*p+c*d),this.rotationalLimitMotor2.angle=u*(m*o-_*s)+p*(_*n-f*o)+d*(f*s-m*n)<0?this.acosClamp(f*n+m*s+_*o):-this.acosClamp(f*n+m*s+_*o);var g=p*o-d*s,y=d*n-u*o,v=u*s-p*n;r=a.sqrt(g*g+y*y+v*v),r>0&&(r=1/r),g*=r,y*=r,v*=r;var x=y*d-v*p,b=v*u-g*d,P=g*p-y*u;r=a.sqrt(x*x+b*b+P*P),r>0&&(r=1/r),x*=r,b*=r,P*=r;var T=s*v-o*y,S=o*g-n*v,A=n*y-s*g;r=a.sqrt(T*T+S*S+A*A),r>0&&(r=1/r),T*=r,S*=r,A*=r,this.nor.init(g,y,v),this.tan.init(x,b,P),this.bin.init(T,S,A),this.r3.preSolve(t,e),this.t3.preSolve(t,e)},a.WheelJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},a.WheelJoint.prototype.postSolve=function(){},a.WheelJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?a.PI:a.acos(t)},a.AngularConstraint=function(t,e){this.joint=t,this.targetOrientation=(new a.Quat).invert(e),this.relativeOrientation=new a.Quat,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new a.Vec3,this.imp=new a.Vec3,this.rn0=new a.Vec3,this.rn1=new a.Vec3,this.rn2=new a.Vec3,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia},a.AngularConstraint.prototype={constructor:a.AngularConstraint,preSolve:function(t,e){var i,r,n;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),n=(new a.Mat33).add(this.ii1,this.ii2).elements,i=1/(n[0]*(n[4]*n[8]-n[7]*n[5])+n[3]*(n[7]*n[2]-n[1]*n[8])+n[6]*(n[1]*n[5]-n[4]*n[2])),this.dd=new a.Mat33(n[4]*n[8]-n[5]*n[7],n[2]*n[7]-n[1]*n[8],n[1]*n[5]-n[2]*n[4],n[5]*n[6]-n[3]*n[8],n[0]*n[8]-n[2]*n[6],n[2]*n[3]-n[0]*n[5],n[3]*n[7]-n[4]*n[6],n[1]*n[6]-n[0]*n[7],n[0]*n[4]-n[1]*n[3]).multiply(i),this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),i=2*this.relativeOrientation.s,this.vel.scale(this.relativeOrientation,i),r=this.vel.length(),r>.02?(r=(.02-r)/r*e*.05,this.vel.scaleEqual(r)):this.vel.init(),this.rn1.mulMat(this.ii1,this.imp),this.rn2.mulMat(this.ii2,this.imp),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)},solve:function(){var t=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,t),this.rn1.mulMat(this.ii1,this.rn0),this.rn2.mulMat(this.ii2,this.rn0),this.imp.addEqual(this.rn0),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)}},a.LinearConstraint=function(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0},a.LinearConstraint.prototype={constructor:a.LinearConstraint,preSolve:function(t,e){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var i=this.ii1.elements,r=this.ii2.elements;this.ax1x=this.r1z*i[1]+-this.r1y*i[2],this.ax1y=this.r1z*i[4]+-this.r1y*i[5],this.ax1z=this.r1z*i[7]+-this.r1y*i[8],this.ay1x=-this.r1z*i[0]+this.r1x*i[2],this.ay1y=-this.r1z*i[3]+this.r1x*i[5],this.ay1z=-this.r1z*i[6]+this.r1x*i[8],this.az1x=this.r1y*i[0]+-this.r1x*i[1],this.az1y=this.r1y*i[3]+-this.r1x*i[4],this.az1z=this.r1y*i[6]+-this.r1x*i[7],this.ax2x=this.r2z*r[1]+-this.r2y*r[2],this.ax2y=this.r2z*r[4]+-this.r2y*r[5],this.ax2z=this.r2z*r[7]+-this.r2y*r[8],this.ay2x=-this.r2z*r[0]+this.r2x*r[2],this.ay2y=-this.r2z*r[3]+this.r2x*r[5],this.ay2z=-this.r2z*r[6]+this.r2x*r[8],this.az2x=this.r2y*r[0]+-this.r2x*r[1],this.az2y=this.r2y*r[3]+-this.r2x*r[4],this.az2z=this.r2y*r[6]+-this.r2x*r[7];var n=this.m1+this.m2,s=new a.Mat33(n,0,0,0,n,0,0,0,n),o=s.elements;o[0]+=i[4]*this.r1z*this.r1z-(i[7]+i[5])*this.r1y*this.r1z+i[8]*this.r1y*this.r1y,o[1]+=(i[6]*this.r1y+i[5]*this.r1x)*this.r1z-i[3]*this.r1z*this.r1z-i[8]*this.r1x*this.r1y,o[2]+=(i[3]*this.r1y-i[4]*this.r1x)*this.r1z-i[6]*this.r1y*this.r1y+i[7]*this.r1x*this.r1y,o[3]+=(i[2]*this.r1y+i[7]*this.r1x)*this.r1z-i[1]*this.r1z*this.r1z-i[8]*this.r1x*this.r1y,o[4]+=i[0]*this.r1z*this.r1z-(i[6]+i[2])*this.r1x*this.r1z+i[8]*this.r1x*this.r1x,o[5]+=(i[1]*this.r1x-i[0]*this.r1y)*this.r1z-i[7]*this.r1x*this.r1x+i[6]*this.r1x*this.r1y,o[6]+=(i[1]*this.r1y-i[4]*this.r1x)*this.r1z-i[2]*this.r1y*this.r1y+i[5]*this.r1x*this.r1y,o[7]+=(i[3]*this.r1x-i[0]*this.r1y)*this.r1z-i[5]*this.r1x*this.r1x+i[2]*this.r1x*this.r1y,o[8]+=i[0]*this.r1y*this.r1y-(i[3]+i[1])*this.r1x*this.r1y+i[4]*this.r1x*this.r1x,o[0]+=r[4]*this.r2z*this.r2z-(r[7]+r[5])*this.r2y*this.r2z+r[8]*this.r2y*this.r2y,o[1]+=(r[6]*this.r2y+r[5]*this.r2x)*this.r2z-r[3]*this.r2z*this.r2z-r[8]*this.r2x*this.r2y,o[2]+=(r[3]*this.r2y-r[4]*this.r2x)*this.r2z-r[6]*this.r2y*this.r2y+r[7]*this.r2x*this.r2y,o[3]+=(r[2]*this.r2y+r[7]*this.r2x)*this.r2z-r[1]*this.r2z*this.r2z-r[8]*this.r2x*this.r2y,o[4]+=r[0]*this.r2z*this.r2z-(r[6]+r[2])*this.r2x*this.r2z+r[8]*this.r2x*this.r2x,o[5]+=(r[1]*this.r2x-r[0]*this.r2y)*this.r2z-r[7]*this.r2x*this.r2x+r[6]*this.r2x*this.r2y,o[6]+=(r[1]*this.r2y-r[4]*this.r2x)*this.r2z-r[2]*this.r2y*this.r2y+r[5]*this.r2x*this.r2y,o[7]+=(r[3]*this.r2x-r[0]*this.r2y)*this.r2z-r[5]*this.r2x*this.r2x+r[2]*this.r2x*this.r2y,o[8]+=r[0]*this.r2y*this.r2y-(r[3]+r[1])*this.r2x*this.r2y+r[4]*this.r2x*this.r2x;var h=1/(o[0]*(o[4]*o[8]-o[7]*o[5])+o[3]*(o[7]*o[2]-o[1]*o[8])+o[6]*(o[1]*o[5]-o[4]*o[2]));this.dd=new a.Mat33(o[4]*o[8]-o[5]*o[7],o[2]*o[7]-o[1]*o[8],o[1]*o[5]-o[2]*o[4],o[5]*o[6]-o[3]*o[8],o[0]*o[8]-o[2]*o[6],o[2]*o[3]-o[0]*o[5],o[3]*o[7]-o[4]*o[6],o[1]*o[6]-o[0]*o[7],o[0]*o[4]-o[1]*o[3]).multiply(h),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var l=a.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);l>.005?(l=(.005-l)/l*e*.05,this.velx*=l,this.vely*=l,this.velz*=l):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,e=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,r=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,n=e*t[0]+i*t[1]+r*t[2],s=e*t[3]+i*t[4]+r*t[5],o=e*t[6]+i*t[7]+r*t[8];this.impx+=n,this.impy+=s,this.impz+=o,this.l1.x+=n*this.m1,this.l1.y+=s*this.m1,this.l1.z+=o*this.m1,this.a1.x+=n*this.ax1x+s*this.ay1x+o*this.az1x,this.a1.y+=n*this.ax1y+s*this.ay1y+o*this.az1y,this.a1.z+=n*this.ax1z+s*this.ay1z+o*this.az1z,this.l2.x-=n*this.m2,this.l2.y-=s*this.m2,this.l2.z-=o*this.m2,this.a2.x-=n*this.ax2x+s*this.ay2x+o*this.az2x,this.a2.y-=n*this.ax2y+s*this.ay2y+o*this.az2y,this.a2.z-=n*this.ax2z+s*this.ay2z+o*this.az2z}},a.Rotational3Constraint=function(t,e,i,r){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=e,this.limitMotor2=i,this.limitMotor3=r,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0},a.Rotational3Constraint.prototype={constructor:a.Rotational3Constraint,preSolve:function(t,e){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var i=this.i1.elements,r=this.i2.elements;this.i1e00=i[0],this.i1e01=i[1],this.i1e02=i[2],this.i1e10=i[3],this.i1e11=i[4],this.i1e12=i[5],this.i1e20=i[6],this.i1e21=i[7],this.i1e22=i[8],this.i2e00=r[0],this.i2e01=r[1],this.i2e02=r[2],this.i2e10=r[3],this.i2e11=r[4],this.i2e12=r[5],this.i2e20=r[6],this.i2e21=r[7],this.i2e22=r[8];var n=this.limitMotor1.frequency,s=this.limitMotor2.frequency,o=this.limitMotor3.frequency,a=n>0,h=s>0,l=o>0,c=this.lowerLimit1<=this.upperLimit1,u=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,d=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-d):d<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-d):d>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-d):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),a||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var f=this.limitMotor2.angle;u?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-f):f<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-f):f>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-f):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),h||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var m=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-m):m<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-m):m>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-m):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||a)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||h)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,a&&2!=this.limitState1){var _=6.2831853*n,g=_*_*t,y=e/(g+2*this.limitMotor1.dampingRatio*_);this.cfm1=this.kv00*y,this.limitVelocity1*=g*y}else this.cfm1=0,this.limitVelocity1*=.05*e;h&&2!=this.limitState2?(_=6.2831853*s,g=_*_*t,y=e/(g+2*this.limitMotor2.dampingRatio*_),this.cfm2=this.kv11*y,this.limitVelocity2*=g*y):(this.cfm2=0,this.limitVelocity2*=.05*e),l&&2!=this.limitState3?(_=6.2831853*o,g=_*_*t,y=e/(g+2*this.limitMotor3.dampingRatio*_),this.cfm3=this.kv22*y,this.limitVelocity3*=g*y):(this.cfm3=0,this.limitVelocity3*=.05*e),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var v=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*v,this.d01=(this.k02*this.k21-this.k01*this.k22)*v,this.d02=(this.k01*this.k12-this.k02*this.k11)*v,this.d10=(this.k12*this.k20-this.k10*this.k22)*v,this.d11=(this.k00*this.k22-this.k02*this.k20)*v,this.d12=(this.k02*this.k10-this.k00*this.k12)*v,this.d20=(this.k10*this.k21-this.k11*this.k20)*v,this.d21=(this.k01*this.k20-this.k00*this.k21)*v,this.d22=(this.k00*this.k11-this.k01*this.k10)*v,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var x=this.limitImpulse1+this.motorImpulse1,b=this.limitImpulse2+this.motorImpulse2,P=this.limitImpulse3+this.motorImpulse3;this.a1.x+=x*this.a1x1+b*this.a1x2+P*this.a1x3,this.a1.y+=x*this.a1y1+b*this.a1y2+P*this.a1y3,this.a1.z+=x*this.a1z1+b*this.a1z2+P*this.a1z3,this.a2.x-=x*this.a2x1+b*this.a2x2+P*this.a2x3,this.a2.y-=x*this.a2y1+b*this.a2y2+P*this.a2y3,this.a2.z-=x*this.a2z1+b*this.a2z2+P*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,e=this.a2.y-this.a1.y,i=this.a2.z-this.a1.z;this.limitVelocity3=30;var r=t*this.ax1+e*this.ay1+i*this.az1-this.limitVelocity1,n=t*this.ax2+e*this.ay2+i*this.az2-this.limitVelocity2,s=t*this.ax3+e*this.ay3+i*this.az3-this.limitVelocity3,o=r*this.d00+n*this.d01+s*this.d02,a=r*this.d10+n*this.d11+s*this.d12,h=r*this.d20+n*this.d21+s*this.d22;this.limitImpulse1+=o,this.limitImpulse2+=a,this.limitImpulse3+=h,this.a1.x+=o*this.a1x1+a*this.a1x2+h*this.a1x3,this.a1.y+=o*this.a1y1+a*this.a1y2+h*this.a1y3,this.a1.z+=o*this.a1z1+a*this.a1z2+h*this.a1z3,this.a2.x-=o*this.a2x1+a*this.a2x2+h*this.a2x3,this.a2.y-=o*this.a2y1+a*this.a2y2+h*this.a2y3,this.a2.z-=o*this.a2z1+a*this.a2z2+h*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,e=this.a2.y-this.a1.y,i=this.a2.z-this.a1.z,r=t*this.ax1+e*this.ay1+i*this.az1,n=t*this.ax2+e*this.ay2+i*this.az2,s=t*this.ax3+e*this.ay3+i*this.az3,o=this.motorImpulse1,a=this.motorImpulse2,h=this.motorImpulse3,l=0,c=0,u=0;this.enableMotor1&&(l=(r-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-o),this.enableMotor2&&(c=(n-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-a),this.enableMotor3&&(u=(s-this.motorSpeed3)*this.dv22,this.motorImpulse3+=u,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),u=this.motorImpulse3-h),r+=l*this.kv00+c*this.k01+u*this.k02,n+=l*this.k10+c*this.kv11+u*this.k12,s+=l*this.k20+c*this.k21+u*this.kv22,r-=this.limitVelocity1+this.limitImpulse1*this.cfm1,n-=this.limitVelocity2+this.limitImpulse2*this.cfm2,s-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,d=this.limitImpulse2,f=this.limitImpulse3,m=r*this.d00+n*this.d01+s*this.d02,_=r*this.d10+n*this.d11+s*this.d12,g=r*this.d20+n*this.d21+s*this.d22;this.limitImpulse1+=m,this.limitImpulse2+=_,this.limitImpulse3+=g;var y=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(m=-p,n+=m*this.k10,s+=m*this.k20,y|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(_=-d,r+=_*this.k01,s+=_*this.k21,y|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(g=-f,r+=g*this.k02,n+=g*this.k12,y|=4);var v;switch(y){case 1:v=1/(this.k11*this.k22-this.k12*this.k21),_=(this.k22*n+-this.k12*s)*v,g=(-this.k21*n+this.k11*s)*v;break;case 2:v=1/(this.k00*this.k22-this.k02*this.k20),m=(this.k22*r+-this.k02*s)*v,g=(-this.k20*r+this.k00*s)*v;break;case 3:g=s/this.k22;break;case 4:v=1/(this.k00*this.k11-this.k01*this.k10),m=(this.k11*r+-this.k01*n)*v,_=(-this.k10*r+this.k00*n)*v;break;case 5:_=n/this.k11;break;case 6:m=r/this.k00}this.limitImpulse1=m+p,this.limitImpulse2=_+d,this.limitImpulse3=g+f;var x=l+m,b=c+_,P=u+g;this.a1.x+=x*this.a1x1+b*this.a1x2+P*this.a1x3,this.a1.y+=x*this.a1y1+b*this.a1y2+P*this.a1y3,this.a1.z+=x*this.a1z1+b*this.a1z2+P*this.a1z3,this.a2.x-=x*this.a2x1+b*this.a2x2+P*this.a2x3,this.a2.y-=x*this.a2y1+b*this.a2y2+P*this.a2y3,this.a2.z-=x*this.a2z1+b*this.a2z2+P*this.a2z3,t=this.a2.x-this.a1.x,e=this.a2.y-this.a1.y,i=this.a2.z-this.a1.z,n=t*this.ax2+e*this.ay2+i*this.az2}},a.RotationalConstraint=function(t,e){this.cfm=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.enableLimit=!1,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=e,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},a.RotationalConstraint.prototype={constructor:a.RotationalConstraint,preSolve:function(t,e){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0;var i=this.i1.elements,r=this.i2.elements;this.i1e00=i[0],this.i1e01=i[1],this.i1e02=i[2],this.i1e10=i[3],this.i1e11=i[4],this.i1e12=i[5],this.i1e20=i[6],this.i1e21=i[7],this.i1e22=i[8],this.i2e00=r[0],this.i2e01=r[1],this.i2e02=r[2],this.i2e10=r[3],this.i2e11=r[4],this.i2e12=r[5],this.i2e20=r[6],this.i2e21=r[7],this.i2e22=r[8];var n=this.limitMotor.frequency,s=n>0,o=this.lowerLimit<=this.upperLimit,a=this.limitMotor.angle;if(o?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a):a<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a):a>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-a):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),s||(this.limitVelocity>.02?this.limitVelocity-=.02:this.limitVelocity<-.02?this.limitVelocity+=.02:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||s)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0),this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02,this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12,this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22,this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02,this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12,this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22,this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z),this.invMotorDenom=1/this.motorDenom,s&&2!=this.limitState){var h=6.2831853*n,l=h*h*t,c=e/(l+2*this.limitMotor.dampingRatio*h);this.cfm=this.motorDenom*c,this.limitVelocity*=l*c}else this.cfm=0,this.limitVelocity*=.05*e;this.invDenom=1/(this.motorDenom+this.cfm),this.limitImpulse*=.95,this.motorImpulse*=.95;var u=this.limitImpulse+this.motorImpulse;this.a1.x+=u*this.a1x,this.a1.y+=u*this.a1y,this.a1.z+=u*this.a1z,this.a2.x-=u*this.a2x,this.a2.y-=u*this.a2y,this.a2.z-=u*this.a2z},solve:function(){var t,e=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);if(this.enableMotor){t=(e-this.motorSpeed)*this.invMotorDenom;var i=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-i,e-=t*this.motorDenom}else t=0;var r;if(2!=this.limitState){r=(e-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var n=this.limitImpulse;this.limitImpulse+=r,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),r=this.limitImpulse-n}else r=0;var s=r+t;this.a1.x+=s*this.a1x,this.a1.y+=s*this.a1y,this.a1.z+=s*this.a1z,this.a2.x-=s*this.a2x,this.a2.y-=s*this.a2y,this.a2.z-=s*this.a2z}},a.Translational3Constraint=function(t,e,i,r){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=e,this.limitMotor2=i,this.limitMotor3=r,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1},a.Translational3Constraint.prototype={constructor:a.Translational3Constraint,preSolve:function(t,e){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var i=this.i1.elements,r=this.i2.elements;this.i1e00=i[0],this.i1e01=i[1],this.i1e02=i[2],this.i1e10=i[3],this.i1e11=i[4],this.i1e12=i[5],this.i1e20=i[6],this.i1e21=i[7],this.i1e22=i[8],this.i2e00=r[0],this.i2e01=r[1],this.i2e02=r[2],this.i2e10=r[3],this.i2e11=r[4],this.i2e12=r[5],this.i2e20=r[6],this.i2e21=r[7],this.i2e22=r[8];var n=this.p2.x-this.p1.x,s=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,a=n*this.ax1+s*this.ay1+o*this.az1,h=n*this.ax2+s*this.ay2+o*this.az2,l=n*this.ax3+s*this.ay3+o*this.az3,c=this.limitMotor1.frequency,u=this.limitMotor2.frequency,p=this.limitMotor3.frequency,d=c>0,f=u>0,m=p>0,_=this.lowerLimit1<=this.upperLimit1,g=this.lowerLimit2<=this.upperLimit2,y=this.lowerLimit3<=this.upperLimit3;(d&&a>20||a<-20)&&(d=!1),(f&&h>20||h<-20)&&(f=!1),(m&&l>20||l<-20)&&(m=!1),_?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-a,d||(a=this.lowerLimit1)):a<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-a,d||(a=this.lowerLimit1)):a>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-a,d||(a=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),d||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),g?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-h,f||(h=this.lowerLimit2)):h<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-h,f||(h=this.lowerLimit2)):h>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-h,f||(h=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),f||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),y?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,m||(l=this.lowerLimit3)):l<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,m||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,m||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),m||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||d)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||f)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||m)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var v=a*this.ax1+h*this.ax2+l*this.ax2,x=a*this.ay1+h*this.ay2+l*this.ay2,b=a*this.az1+h*this.az2+l*this.az2,P=this.m2/(this.m1+this.m2);this.weight>=0&&(P=this.weight);var T=1-P;this.r1x=this.r1.x+v*P,this.r1y=this.r1.y+x*P,this.r1z=this.r1.z+b*P,this.r2x=this.r2.x-v*T,this.r2y=this.r2.y-x*T,this.r2z=this.r2.z-b*T,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var S=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*S,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*S,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*S,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*S,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*S,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*S,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*S,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*S,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*S,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,d&&2!=this.limitState1){var A=6.2831853*c,C=A*A*t,E=e/(C+2*this.limitMotor1.dampingRatio*A);this.cfm1=this.kv00*E,this.limitVelocity1*=C*E}else this.cfm1=0,this.limitVelocity1*=.05*e;f&&2!=this.limitState2?(A=6.2831853*u,C=A*A*t,E=e/(C+2*this.limitMotor2.dampingRatio*A),this.cfm2=this.kv11*E,this.limitVelocity2*=C*E):(this.cfm2=0,this.limitVelocity2*=.05*e),m&&2!=this.limitState3?(A=6.2831853*p,C=A*A*t,E=e/(C+2*this.limitMotor3.dampingRatio*A),this.cfm3=this.kv22*E,this.limitVelocity3*=C*E):(this.cfm3=0,this.limitVelocity3*=.05*e),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var M=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*M,this.d01=(this.k02*this.k21-this.k01*this.k22)*M,this.d02=(this.k01*this.k12-this.k02*this.k11)*M,this.d10=(this.k12*this.k20-this.k10*this.k22)*M,this.d11=(this.k00*this.k22-this.k02*this.k20)*M,this.d12=(this.k02*this.k10-this.k00*this.k12)*M,this.d20=(this.k10*this.k21-this.k11*this.k20)*M,this.d21=(this.k01*this.k20-this.k00*this.k21)*M,this.d22=(this.k00*this.k11-this.k01*this.k10)*M;var D=this.limitImpulse1+this.motorImpulse1,R=this.limitImpulse2+this.motorImpulse2,I=this.limitImpulse3+this.motorImpulse3;this.l1.x+=D*this.l1x1+R*this.l1x2+I*this.l1x3,this.l1.y+=D*this.l1y1+R*this.l1y2+I*this.l1y3,this.l1.z+=D*this.l1z1+R*this.l1z2+I*this.l1z3,this.a1.x+=D*this.a1x1+R*this.a1x2+I*this.a1x3,this.a1.y+=D*this.a1y1+R*this.a1y2+I*this.a1y3,this.a1.z+=D*this.a1z1+R*this.a1z2+I*this.a1z3,this.l2.x-=D*this.l2x1+R*this.l2x2+I*this.l2x3,this.l2.y-=D*this.l2y1+R*this.l2y2+I*this.l2y3,this.l2.z-=D*this.l2z1+R*this.l2z2+I*this.l2z3,this.a2.x-=D*this.a2x1+R*this.a2x2+I*this.a2x3,this.a2.y-=D*this.a2y1+R*this.a2y2+I*this.a2y3,this.a2.z-=D*this.a2z1+R*this.a2z2+I*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,e=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,i=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,r=t*this.ax1+e*this.ay1+i*this.az1,n=t*this.ax2+e*this.ay2+i*this.az2,s=t*this.ax3+e*this.ay3+i*this.az3,o=this.motorImpulse1,a=this.motorImpulse2,h=this.motorImpulse3,l=0,c=0,u=0;this.enableMotor1&&(l=(r-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-o),this.enableMotor2&&(c=(n-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-a),this.enableMotor3&&(u=(s-this.motorSpeed3)*this.dv22,this.motorImpulse3+=u,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),u=this.motorImpulse3-h),r+=l*this.kv00+c*this.k01+u*this.k02,n+=l*this.k10+c*this.kv11+u*this.k12,s+=l*this.k20+c*this.k21+u*this.kv22,r-=this.limitVelocity1+this.limitImpulse1*this.cfm1,n-=this.limitVelocity2+this.limitImpulse2*this.cfm2,s-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,d=this.limitImpulse2,f=this.limitImpulse3,m=r*this.d00+n*this.d01+s*this.d02,_=r*this.d10+n*this.d11+s*this.d12,g=r*this.d20+n*this.d21+s*this.d22;this.limitImpulse1+=m,this.limitImpulse2+=_,this.limitImpulse3+=g;var y=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(m=-p,n+=m*this.k10,s+=m*this.k20,y|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(_=-d,r+=_*this.k01,s+=_*this.k21,y|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(g=-f,r+=g*this.k02,n+=g*this.k12,y|=4);var v;switch(y){case 1:v=1/(this.k11*this.k22-this.k12*this.k21),_=(this.k22*n+-this.k12*s)*v,g=(-this.k21*n+this.k11*s)*v;break;case 2:v=1/(this.k00*this.k22-this.k02*this.k20),m=(this.k22*r+-this.k02*s)*v,g=(-this.k20*r+this.k00*s)*v;break;case 3:g=s/this.k22;break;case 4:v=1/(this.k00*this.k11-this.k01*this.k10),m=(this.k11*r+-this.k01*n)*v,_=(-this.k10*r+this.k00*n)*v;break;case 5:_=n/this.k11;break;case 6:m=r/this.k00}this.limitImpulse1=p+m,this.limitImpulse2=d+_,this.limitImpulse3=f+g;var x=l+m,b=c+_,P=u+g;this.l1.x+=x*this.l1x1+b*this.l1x2+P*this.l1x3,this.l1.y+=x*this.l1y1+b*this.l1y2+P*this.l1y3,this.l1.z+=x*this.l1z1+b*this.l1z2+P*this.l1z3,this.a1.x+=x*this.a1x1+b*this.a1x2+P*this.a1x3,this.a1.y+=x*this.a1y1+b*this.a1y2+P*this.a1y3,this.a1.z+=x*this.a1z1+b*this.a1z2+P*this.a1z3,this.l2.x-=x*this.l2x1+b*this.l2x2+P*this.l2x3,this.l2.y-=x*this.l2y1+b*this.l2y2+P*this.l2y3,this.l2.z-=x*this.l2z1+b*this.l2z2+P*this.l2z3,this.a2.x-=x*this.a2x1+b*this.a2x2+P*this.a2x3,this.a2.y-=x*this.a2y1+b*this.a2y2+P*this.a2y3,this.a2.z-=x*this.a2z1+b*this.a2z2+P*this.a2z3}},a.TranslationalConstraint=function(t,e){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=e,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},a.TranslationalConstraint.prototype={constructor:a.TranslationalConstraint,preSolve:function(t,e){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var i=this.i1.elements,r=this.i2.elements;this.i1e00=i[0],this.i1e01=i[1],this.i1e02=i[2],this.i1e10=i[3],this.i1e11=i[4],this.i1e12=i[5],this.i1e20=i[6],this.i1e21=i[7],this.i1e22=i[8],this.i2e00=r[0],this.i2e01=r[1],this.i2e02=r[2],this.i2e10=r[3],this.i2e11=r[4],this.i2e12=r[5],this.i2e20=r[6],this.i2e21=r[7],this.i2e22=r[8];var n=this.p2.x-this.p1.x,s=this.p2.y-this.p1.y,o=this.p2.z-this.p1.z,a=n*this.ax+s*this.ay+o*this.az,h=this.limitMotor.frequency,l=h>0,c=this.lowerLimit<=this.upperLimit;(l&&a>20||a<-20)&&(l=!1),c?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a,l||(a=this.lowerLimit)):a<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a,l||(a=this.lowerLimit)):a>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-a,l||(a=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var u=a*this.ax,p=a*this.ay,d=a*this.az,f=this.m1/(this.m1+this.m2),m=1-f;if(this.r1x=this.r1.x+u*f,this.r1y=this.r1.y+p*f,this.r1z=this.r1.z+d*f,this.r2x=this.r2.x-u*m,this.r2y=this.r2.y-p*m,this.r2z=this.r2.z-d*m,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var _=6.2831853*h,g=_*_*t,y=e/(g+2*this.limitMotor.dampingRatio*_);this.cfm=this.motorDenom*y,this.limitVelocity*=g*y}else this.cfm=0,this.limitVelocity*=.05*e;this.invDenom=1/(this.motorDenom+this.cfm);var v=this.limitImpulse+this.motorImpulse;this.l1.x+=v*this.l1x,this.l1.y+=v*this.l1y,this.l1.z+=v*this.l1z,this.a1.x+=v*this.a1x,this.a1.y+=v*this.a1y,this.a1.z+=v*this.a1z,this.l2.x-=v*this.l2x,this.l2.y-=v*this.l2y,this.l2.z-=v*this.l2z,this.a2.x-=v*this.a2x,this.a2.y-=v*this.a2y,this.a2.z-=v*this.a2z},solve:function(){var t,e=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(e-this.motorSpeed)*this.invMotorDenom;var i=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-i,e-=t*this.motorDenom}else t=0;var r;if(2!=this.limitState){r=(e-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var n=this.limitImpulse;this.limitImpulse+=r,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),r=this.limitImpulse-n}else r=0;var s=r+t;this.l1.x+=s*this.l1x,this.l1.y+=s*this.l1y,this.l1.z+=s*this.l1z,this.a1.x+=s*this.a1x,this.a1.y+=s*this.a1y,this.a1.z+=s*this.a1z,this.l2.x-=s*this.l2x,this.l2.y-=s*this.l2y,this.l2.z-=s*this.l2z,this.a2.x-=s*this.a2x,this.a2.y-=s*this.a2y,this.a2.z-=s*this.a2z}},a.Contact=function(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new a.ContactLink(this),this.b2Link=new a.ContactLink(this),this.s1Link=new a.ContactLink(this),this.s2Link=new a.ContactLink(this),this.manifold=new a.ContactManifold,this.buffer=[],this.buffer.length=4,this.buffer[0]=new a.ImpulseDataBuffer,this.buffer[1]=new a.ImpulseDataBuffer,this.buffer[2]=new a.ImpulseDataBuffer,this.buffer[3]=new a.ImpulseDataBuffer,this.points=this.manifold.points,this.constraint=new a.ContactConstraint(this.manifold)},a.Contact.prototype={constructor:a.Contact,mixRestitution:function(t,e){return a.sqrt(t*e)},mixFriction:function(t,e){return a.sqrt(t*e)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,e=t;e--;){var i=this.buffer[e],r=this.points[e];i.lp1X=r.localPoint1.x,i.lp1Y=r.localPoint1.y,i.lp1Z=r.localPoint1.z,i.lp2X=r.localPoint2.x,i.lp2Y=r.localPoint2.y,i.lp2Z=r.localPoint2.z,i.impulse=r.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var n=this.manifold.numPoints;if(0==n)return void(this.touching=!1);for(this.touching=!0,e=n;e--;){r=this.points[e];for(var s=r.localPoint1.x,o=r.localPoint1.y,a=r.localPoint1.z,h=r.localPoint2.x,l=r.localPoint2.y,c=r.localPoint2.z,u=-1,p=4e-4,d=t;d--;){i=this.buffer[d];var f=i.lp1X-s,m=i.lp1Y-o,_=i.lp1Z-a,g=f*f+m*m+_*_;f=i.lp2X-h,m=i.lp2Y-l,_=i.lp2Z-c;var y=f*f+m*m+_*_;g<y?g<p&&(p=g,u=d):y<p&&(p=y,u=d)}if(u!=-1){var v=this.buffer[u];this.buffer[u]=this.buffer[--t],this.buffer[t]=v,r.normalImpulse=v.impulse,r.warmStarted=!0}else r.normalImpulse=0,r.warmStarted=!1}},attach:function(t,e){this.shape1=t,this.shape2=e,this.body1=t.parent,this.body2=e.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=e,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=e.contactLink?(this.s2Link.next=e.contactLink).prev=this.s2Link:this.s2Link.next=null,e.contactLink=this.s2Link,e.numContacts++,this.b1Link.shape=e,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,e=this.s1Link.next;null!==t&&(t.next=e),null!==e&&(e.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=e),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,e=this.s2Link.next,null!==t&&(t.next=e),null!==e&&(e.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=e),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,e=this.b1Link.next,null!==t&&(t.next=e),null!==e&&(e.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=e),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,e=this.b2Link.next,null!==t&&(t.next=e),null!==e&&(e.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=e),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}},a.ContactConstraint=function(t){a.Constraint.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.ii1=null,this.ii2=null,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new a.ContactPointDataBuffer,this.cs.next=new a.ContactPointDataBuffer,this.cs.next.next=new a.ContactPointDataBuffer,this.cs.next.next.next=new a.ContactPointDataBuffer},a.ContactConstraint.prototype=Object.create(a.Constraint.prototype),a.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},a.ContactConstraint.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},a.ContactConstraint.prototype.preSolve=function(t,e){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var i=this.ii1.elements,r=this.ii2.elements,n=this.p1.x,s=this.p1.y,o=this.p1.z,h=this.p2.x,l=this.p2.y,c=this.p2.z,u=this.m1+this.m2;this.num=this.manifold.numPoints;for(var p=this.cs,d=0;d<this.num;d++){var f,m,_,g,y,v,x=this.ps[d];f=x.position.x,m=x.position.y,_=x.position.z;var b=f-n,P=m-s,T=_-o,S=f-h,A=m-l,C=_-c;p.rp1X=b,p.rp1Y=P,p.rp1Z=T,p.rp2X=S,p.rp2Y=A,p.rp2Z=C,p.norImp=x.normalImpulse,p.tanImp=x.tangentImpulse,p.binImp=x.binormalImpulse;var E=x.normal.x,M=x.normal.y,D=x.normal.z,R=this.lv2.x+this.av2.y*C-this.av2.z*A-(this.lv1.x+this.av1.y*T-this.av1.z*P),I=this.lv2.y+this.av2.z*S-this.av2.x*C-(this.lv1.y+this.av1.z*b-this.av1.x*T),O=this.lv2.z+this.av2.x*A-this.av2.y*S-(this.lv1.z+this.av1.x*P-this.av1.y*b),w=E*R+M*I+D*O,L=R-w*E,F=I-w*M,V=O-w*D,N=L*L+F*F+V*V;N>.04?N=1/a.sqrt(N):(L=M*E-D*D,F=-D*M-E*E,V=E*D+M*M,N=1/a.sqrt(L*L+F*F+V*V)),L*=N,F*=N,V*=N;var z=M*V-D*F,B=D*L-E*V,k=E*F-M*L;p.norX=E,p.norY=M,p.norZ=D,p.tanX=L,p.tanY=F,p.tanZ=V,p.binX=z,p.binY=B,p.binZ=k,p.norU1X=E*this.m1,p.norU1Y=M*this.m1,p.norU1Z=D*this.m1,p.norU2X=E*this.m2,p.norU2Y=M*this.m2,p.norU2Z=D*this.m2,p.tanU1X=L*this.m1,p.tanU1Y=F*this.m1,p.tanU1Z=V*this.m1,p.tanU2X=L*this.m2,p.tanU2Y=F*this.m2,p.tanU2Z=V*this.m2,p.binU1X=z*this.m1,p.binU1Y=B*this.m1,p.binU1Z=k*this.m1,p.binU2X=z*this.m2,p.binU2Y=B*this.m2,p.binU2Z=k*this.m2;var U=P*D-T*M,G=T*E-b*D,W=b*M-P*E,j=A*D-C*M,H=C*E-S*D,X=S*M-A*E,Y=P*V-T*F,Z=T*L-b*V,K=b*F-P*L,q=A*V-C*F,Q=C*L-S*V,J=S*F-A*L,$=P*k-T*B,tt=T*z-b*k,et=b*B-P*z,it=A*k-C*B,rt=C*z-S*k,nt=S*B-A*z,st=U*i[0]+G*i[1]+W*i[2],ot=U*i[3]+G*i[4]+W*i[5],at=U*i[6]+G*i[7]+W*i[8],ht=j*r[0]+H*r[1]+X*r[2],lt=j*r[3]+H*r[4]+X*r[5],ct=j*r[6]+H*r[7]+X*r[8],ut=Y*i[0]+Z*i[1]+K*i[2],pt=Y*i[3]+Z*i[4]+K*i[5],dt=Y*i[6]+Z*i[7]+K*i[8],ft=q*r[0]+Q*r[1]+J*r[2],mt=q*r[3]+Q*r[4]+J*r[5],_t=q*r[6]+Q*r[7]+J*r[8],gt=$*i[0]+tt*i[1]+et*i[2],yt=$*i[3]+tt*i[4]+et*i[5],vt=$*i[6]+tt*i[7]+et*i[8],xt=it*r[0]+rt*r[1]+nt*r[2],bt=it*r[3]+rt*r[4]+nt*r[5],Pt=it*r[6]+rt*r[7]+nt*r[8];p.norT1X=U,p.norT1Y=G,p.norT1Z=W,p.tanT1X=Y,p.tanT1Y=Z,p.tanT1Z=K,p.binT1X=$,p.binT1Y=tt,p.binT1Z=et,p.norT2X=j,p.norT2Y=H,p.norT2Z=X,p.tanT2X=q,p.tanT2Y=Q,p.tanT2Z=J,p.binT2X=it,p.binT2Y=rt,p.binT2Z=nt,p.norTU1X=st,p.norTU1Y=ot,p.norTU1Z=at,p.tanTU1X=ut,p.tanTU1Y=pt,p.tanTU1Z=dt,p.binTU1X=gt,p.binTU1Y=yt,p.binTU1Z=vt,p.norTU2X=ht,p.norTU2Y=lt,p.norTU2Z=ct,p.tanTU2X=ft,p.tanTU2Y=mt,p.tanTU2Z=_t,p.binTU2X=xt,p.binTU2Y=bt,p.binTU2Z=Pt,f=U*i[0]+G*i[1]+W*i[2],m=U*i[3]+G*i[4]+W*i[5],_=U*i[6]+G*i[7]+W*i[8],g=m*T-_*P,y=_*b-f*T,v=f*P-m*b,f=j*r[0]+H*r[1]+X*r[2],m=j*r[3]+H*r[4]+X*r[5],_=j*r[6]+H*r[7]+X*r[8],g+=m*C-_*A,y+=_*S-f*C,v+=f*A-m*S;var Tt=1/(u+E*g+M*y+D*v);f=Y*i[0]+Z*i[1]+K*i[2],m=Y*i[3]+Z*i[4]+K*i[5],_=Y*i[6]+Z*i[7]+K*i[8],g=m*T-_*P,y=_*b-f*T,v=f*P-m*b,f=q*r[0]+Q*r[1]+J*r[2],m=q*r[3]+Q*r[4]+J*r[5],_=q*r[6]+Q*r[7]+J*r[8],g+=m*C-_*A,y+=_*S-f*C,v+=f*A-m*S;var St=1/(u+L*g+F*y+V*v);f=$*i[0]+tt*i[1]+et*i[2],m=$*i[3]+tt*i[4]+et*i[5],_=$*i[6]+tt*i[7]+et*i[8],g=m*T-_*P,y=_*b-f*T,v=f*P-m*b,f=it*r[0]+rt*r[1]+nt*r[2],m=it*r[3]+rt*r[4]+nt*r[5],_=it*r[6]+rt*r[7]+nt*r[8],g+=m*C-_*A,y+=_*S-f*C,v+=f*A-m*S;var At=1/(u+z*g+B*y+k*v);if(p.norDen=Tt,p.tanDen=St,p.binDen=At,x.warmStarted){var Ct=x.normalImpulse;this.lv1.x+=p.norU1X*Ct,this.lv1.y+=p.norU1Y*Ct,this.lv1.z+=p.norU1Z*Ct,this.av1.x+=st*Ct,this.av1.y+=ot*Ct,this.av1.z+=at*Ct,this.lv2.x-=p.norU2X*Ct,this.lv2.y-=p.norU2Y*Ct,this.lv2.z-=p.norU2Z*Ct,this.av2.x-=ht*Ct,this.av2.y-=lt*Ct,this.av2.z-=ct*Ct,p.norImp=Ct,p.tanImp=0,p.binImp=0,w=0}else p.norImp=0,p.tanImp=0,p.binImp=0;w>-1&&(w=0);var Et=this.restitution*-w,Mt=-(x.penetration+.005)*e*.05;Et<Mt&&(Et=Mt),p.norTar=Et,p.last=d==this.num-1,p=p.next}},a.ContactConstraint.prototype.solve=function(){for(var t=this.lv1.x,e=this.lv1.y,i=this.lv1.z,r=this.lv2.x,n=this.lv2.y,s=this.lv2.z,o=this.av1.x,h=this.av1.y,l=this.av1.z,c=this.av2.x,u=this.av2.y,p=this.av2.z,d=this.cs;;){var f,m,_,g,y,v=d.norImp,x=d.tanImp,b=d.binImp,P=-v*this.friction,T=r-t,S=n-e,A=s-i;y=T*d.tanX+S*d.tanY+A*d.tanZ+c*d.tanT2X+u*d.tanT2Y+p*d.tanT2Z-o*d.tanT1X-h*d.tanT1Y-l*d.tanT1Z,f=x,m=y*d.tanDen,x+=m,y=T*d.binX+S*d.binY+A*d.binZ+c*d.binT2X+u*d.binT2Y+p*d.binT2Z-o*d.binT1X-h*d.binT1Y-l*d.binT1Z,_=b,g=y*d.binDen,b+=g;var C=x*x+b*b;if(C>P*P&&(C=P/a.sqrt(C),x*=C,b*=C),m=x-f,g=b-_,t+=d.tanU1X*m+d.binU1X*g,e+=d.tanU1Y*m+d.binU1Y*g,i+=d.tanU1Z*m+d.binU1Z*g,o+=d.tanTU1X*m+d.binTU1X*g,h+=d.tanTU1Y*m+d.binTU1Y*g,l+=d.tanTU1Z*m+d.binTU1Z*g,r-=d.tanU2X*m+d.binU2X*g,n-=d.tanU2Y*m+d.binU2Y*g,s-=d.tanU2Z*m+d.binU2Z*g,c-=d.tanTU2X*m+d.binTU2X*g,u-=d.tanTU2Y*m+d.binTU2Y*g,p-=d.tanTU2Z*m+d.binTU2Z*g,y=(r-t)*d.norX+(n-e)*d.norY+(s-i)*d.norZ+c*d.norT2X+u*d.norT2Y+p*d.norT2Z-o*d.norT1X-h*d.norT1Y-l*d.norT1Z,f=v,m=(y-d.norTar)*d.norDen,v+=m,v>0&&(v=0),m=v-f,t+=d.norU1X*m,e+=d.norU1Y*m,i+=d.norU1Z*m,o+=d.norTU1X*m,h+=d.norTU1Y*m,l+=d.norTU1Z*m,r-=d.norU2X*m,n-=d.norU2Y*m,s-=d.norU2Z*m,c-=d.norTU2X*m,u-=d.norTU2Y*m,p-=d.norTU2Z*m,d.norImp=v,d.tanImp=x,d.binImp=b,d.last)break;d=d.next}this.lv1.x=t,this.lv1.y=e,this.lv1.z=i,this.lv2.x=r,this.lv2.y=n,this.lv2.z=s,this.av1.x=o,this.av1.y=h,this.av1.z=l,this.av2.x=c,this.av2.y=u,this.av2.z=p},a.ContactConstraint.prototype.postSolve=function(){for(var t=this.cs,e=this.num;e--;){var i=this.ps[e];i.normal.x=t.norX,i.normal.y=t.norY,i.normal.z=t.norZ,i.tangent.x=t.tanX,i.tangent.y=t.tanY,i.tangent.z=t.tanZ,i.binormal.x=t.binX,i.binormal.y=t.binY,i.binormal.z=t.binZ,i.normalImpulse=t.norImp,i.tangentImpulse=t.tanImp,i.binormalImpulse=t.binImp,i.normalDenominator=t.norDen,i.tangentDenominator=t.tanDen,i.binormalDenominator=t.binDen,t=t.next}},a.ContactLink=function(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t},a.ContactManifold=function(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[],this.points.length=4,this.points[0]=new a.ManifoldPoint,this.points[1]=new a.ManifoldPoint,this.points[2]=new a.ManifoldPoint,this.points[3]=new a.ManifoldPoint},a.ContactManifold.prototype={constructor:a.ContactManifold,reset:function(t,e){this.body1=t.parent,this.body2=e.parent,this.numPoints=0},addPoint:function(t,e,i,r,n,s,o,a){var h=this.points[this.numPoints++];h.position.x=t,h.position.y=e,h.position.z=i;var l=this.body1.rotation,c=t-this.body1.position.x,u=e-this.body1.position.y,p=i-this.body1.position.z,d=l.elements;h.localPoint1.x=c*d[0]+u*d[3]+p*d[6],h.localPoint1.y=c*d[1]+u*d[4]+p*d[7],h.localPoint1.z=c*d[2]+u*d[5]+p*d[8],l=this.body2.rotation,c=t-this.body2.position.x,u=e-this.body2.position.y,p=i-this.body2.position.z,h.localPoint2.x=c*d[0]+u*d[3]+p*d[6],h.localPoint2.y=c*d[1]+u*d[4]+p*d[7],h.localPoint2.z=c*d[2]+u*d[5]+p*d[8],h.normalImpulse=0,a?(h.normal.x=-r,h.normal.y=-n,h.normal.z=-s):(h.normal.x=r,h.normal.y=n,h.normal.z=s),h.penetration=o,h.warmStarted=!1}},a.ContactPointDataBuffer=function(){this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.rp1X=NaN,this.rp1Y=NaN,this.rp1Z=NaN,this.rp2X=NaN,this.rp2Y=NaN,this.rp2Z=NaN,this.norU1X=NaN,this.norU1Y=NaN,this.norU1Z=NaN,this.norU2X=NaN,this.norU2Y=NaN,this.norU2Z=NaN,this.tanU1X=NaN,this.tanU1Y=NaN,this.tanU1Z=NaN,this.tanU2X=NaN,this.tanU2Y=NaN,this.tanU2Z=NaN,this.binU1X=NaN,this.binU1Y=NaN,this.binU1Z=NaN,this.binU2X=NaN,this.binU2Y=NaN,this.binU2Z=NaN,this.norT1X=NaN,this.norT1Y=NaN,this.norT1Z=NaN,this.norT2X=NaN,this.norT2Y=NaN,this.norT2Z=NaN,this.tanT1X=NaN,this.tanT1Y=NaN,this.tanT1Z=NaN,this.tanT2X=NaN,this.tanT2Y=NaN,this.tanT2Z=NaN,this.binT1X=NaN,this.binT1Y=NaN,this.binT1Z=NaN,this.binT2X=NaN,this.binT2Y=NaN,this.binT2Z=NaN,this.norTU1X=NaN,this.norTU1Y=NaN,this.norTU1Z=NaN,this.norTU2X=NaN,this.norTU2Y=NaN,this.norTU2Z=NaN,this.tanTU1X=NaN,this.tanTU1Y=NaN,this.tanTU1Z=NaN,this.tanTU2X=NaN,this.tanTU2Y=NaN,this.tanTU2Z=NaN,this.binTU1X=NaN,this.binTU1Y=NaN,this.binTU1Z=NaN,this.binTU2X=NaN,this.binTU2Y=NaN,this.binTU2Z=NaN,this.norImp=NaN,this.tanImp=NaN,this.binImp=NaN,this.norDen=NaN,this.tanDen=NaN,this.binDen=NaN,this.norTar=NaN,this.next=null,this.last=!1},a.ImpulseDataBuffer=function(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN},a.ManifoldPoint=function(){this.warmStarted=!1,this.position=new a.Vec3,this.localPoint1=new a.Vec3,this.localPoint2=new a.Vec3,this.normal=new a.Vec3,this.tangent=new a.Vec3,this.binormal=new a.Vec3,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0},a.MassInfo=function(){this.mass=0,this.inertia=new a.Mat33},a.Shape=function(t){this.type=a.SHAPE_NULL,this.id=a.nextID++,this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new a.Vec3,this.rotation=new a.Mat33,this.relativePosition=(new a.Vec3).copy(t.relativePosition),this.relativeRotation=(new a.Mat33).copy(t.relativeRotation),this.aabb=new a.AABB,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith},a.Shape.prototype={constructor:a.Shape,calculateMassInfo:function(t){a.Error("Shape","Inheritance error.")},updateProxy:function(){a.Error("Shape","Inheritance error.")}},a.ShapeConfig=function(){this.relativePosition=new a.Vec3,this.relativeRotation=new a.Mat33,this.friction=.4,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295},a.BoxShape=function(t,e,i,r){a.Shape.call(this,t),this.type=a.SHAPE_BOX,this.width=e,this.height=i,this.depth=r,this.halfWidth=.5*e,this.halfHeight=.5*i,this.halfDepth=.5*r,this.dimentions=new o(18),this.elements=new o(24)},a.BoxShape.prototype=Object.create(a.Shape.prototype),a.BoxShape.prototype.constructor=a.BoxShape,a.BoxShape.prototype.calculateMassInfo=function(t){var e=this.width*this.height*this.depth*this.density,i=1/12;t.mass=e,t.inertia.set(e*(this.height*this.height+this.depth*this.depth)*i,0,0,0,e*(this.width*this.width+this.depth*this.depth)*i,0,0,0,e*(this.width*this.width+this.height*this.height)*i)},a.BoxShape.prototype.updateProxy=function(){var t=this.rotation.elements,e=this.dimentions;e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e[9]=t[0]*this.halfWidth,e[10]=t[3]*this.halfWidth,e[11]=t[6]*this.halfWidth,e[12]=t[1]*this.halfHeight,e[13]=t[4]*this.halfHeight,e[14]=t[7]*this.halfHeight,e[15]=t[2]*this.halfDepth,e[16]=t[5]*this.halfDepth,e[17]=t[8]*this.halfDepth;var i=e[9],r=e[10],n=e[11],s=e[12],o=e[13],h=e[14],l=e[15],c=e[16],u=e[17],p=this.position.x,d=this.position.y,f=this.position.z,m=this.elements;m[0]=p+i+s+l,m[1]=d+r+o+c,m[2]=f+n+h+u,m[3]=p+i+s-l,m[4]=d+r+o-c,m[5]=f+n+h-u,m[6]=p+i-s+l,m[7]=d+r-o+c,m[8]=f+n-h+u,m[9]=p+i-s-l,m[10]=d+r-o-c,m[11]=f+n-h-u,m[12]=p-i+s+l,m[13]=d-r+o+c,m[14]=f-n+h+u,m[15]=p-i+s-l,m[16]=d-r+o-c,m[17]=f-n+h-u,m[18]=p-i-s+l,m[19]=d-r-o+c,m[20]=f-n-h+u,m[21]=p-i-s-l,m[22]=d-r-o-c,m[23]=f-n-h-u;var _=e[9]<0?-e[9]:e[9],g=e[10]<0?-e[10]:e[10],y=e[11]<0?-e[11]:e[11];_=e[12]<0?_-e[12]:_+e[12],g=e[13]<0?g-e[13]:g+e[13],y=e[14]<0?y-e[14]:y+e[14],_=e[15]<0?_-e[15]:_+e[15],g=e[16]<0?g-e[16]:g+e[16],y=e[17]<0?y-e[17]:y+e[17];var v=a.AABB_PROX;this.aabb.set(this.position.x-_-v,this.position.x+_+v,this.position.y-g-v,this.position.y+g+v,this.position.z-y-v,this.position.z+y+v),null!=this.proxy&&this.proxy.update()},a.SphereShape=function(t,e){a.Shape.call(this,t),this.type=a.SHAPE_SPHERE,this.radius=e},a.SphereShape.prototype=Object.create(a.Shape.prototype),a.SphereShape.prototype.constructor=a.SphereShape,a.SphereShape.prototype.calculateMassInfo=function(t){var e=1.333*a.PI*this.radius*this.radius*this.radius*this.density;t.mass=e;var i=e*this.radius*this.radius*.4;t.inertia.set(i,0,0,0,i,0,0,0,i)},a.SphereShape.prototype.updateProxy=function(){var t=a.AABB_PROX;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()},a.CylinderShape=function(t,e,i){a.Shape.call(this,t),this.type=a.SHAPE_CYLINDER,this.radius=e,this.height=i,this.halfHeight=.5*i,this.normalDirection=new a.Vec3,this.halfDirection=new a.Vec3},a.CylinderShape.prototype=Object.create(a.Shape.prototype),a.CylinderShape.prototype.constructor=a.CylinderShape,a.CylinderShape.prototype.calculateMassInfo=function(t){var e=this.radius*this.radius,i=a.PI*e*this.height*this.density,r=(.25*e+.0833*this.height*this.height)*i,n=.5*e;t.mass=i,t.inertia.set(r,0,0,0,n,0,0,0,r)},a.CylinderShape.prototype.updateProxy=function(){var t,e,i,r,n,s,o,h,l,c,u,p=this.rotation.elements;n=p[1]*p[1],s=p[4]*p[4],o=p[7]*p[7],this.normalDirection.set(p[1],p[4],p[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),e=1-n,t=a.sqrt(e*e+n*s+n*o),t>0&&(t=this.radius/t),e*=t,i=1-s,t=a.sqrt(s*n+i*i+s*o),t>0&&(t=this.radius/t),i*=t,r=1-o,t=a.sqrt(o*n+o*s+r*r),t>0&&(t=this.radius/t),r*=t,h=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,l=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,c=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,h=e<0?h-e:h+e,l=i<0?l-i:l+i,c=r<0?c-r:c+r,u=a.AABB_PROX,this.aabb.set(this.position.x-h-u,this.position.x+h+u,this.position.y-l-u,this.position.y+l+u,this.position.z-c-u,this.position.z+c+u),null!=this.proxy&&this.proxy.update()},a.TetraShape=function(t,e,i,n,s){a.Shape.call(this,t),this.type=a.SHAPE_TETRA,this.verts=[e,i,n,s],this.faces=[r(0,1,2),r(1,2,3),r(2,3,4),r(4,0,1)]},a.TetraShape.prototype=Object.create(a.Shape.prototype),a.TetraShape.prototype.constructor=a.TetraShape,a.TetraShape.prototype.calculateMassInfo=function(){},a.TetraShape.prototype.updateProxy=function(){this.aabb.setFromPoints(this.verts),null!==this.proxy&&this.proxy.update()},a.CollisionDetector=function(){this.flip=!1},a.CollisionDetector.prototype={constructor:a.CollisionDetector,detectCollision:function(t,e,i){a.Error("CollisionDetector","Inheritance error.")}},a.BoxBoxCollisionDetector=function(){a.CollisionDetector.call(this),this.clipVertices1=new o(24),this.clipVertices2=new o(24),this.used=new o(8),this.INF=1/0},a.BoxBoxCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.BoxBoxCollisionDetector.prototype.constructor=a.BoxBoxCollisionDetector,a.BoxBoxCollisionDetector.prototype.detectCollision=function(t,e,i){var r,n;t.id<e.id?(r=t,n=e):(r=e,n=t);var s,o,h,l,c,u,p,d,f,m,_,g,y,v,x,b,P,T,S,A,C,E,M,D,R,I,O,w,L,F,V,N,z,B,k,U,G=r.elements,W=n.elements,j=r.dimentions,H=n.dimentions,X=r.position,Y=n.position,Z=X.x,K=X.y,q=X.z,Q=Y.x,J=Y.y,$=Y.z,tt=Q-Z,et=J-K,it=$-q,rt=r.halfWidth,nt=r.halfHeight,st=r.halfDepth,ot=n.halfWidth,at=n.halfHeight,ht=n.halfDepth,lt=j[0],ct=j[1],ut=j[2],pt=j[3],dt=j[4],ft=j[5],mt=j[6],_t=j[7],gt=j[8],yt=j[9],vt=j[10],xt=j[11],bt=j[12],Pt=j[13],Tt=j[14],St=j[15],At=j[16],Ct=j[17],Et=H[0],Mt=H[1],Dt=H[2],Rt=H[3],It=H[4],Ot=H[5],wt=H[6],Lt=H[7],Ft=H[8],Vt=H[9],Nt=H[10],zt=H[11],Bt=H[12],kt=H[13],Ut=H[14],Gt=H[15],Wt=H[16],jt=H[17],Ht=ct*Dt-ut*Mt,Xt=ut*Et-lt*Dt,Yt=lt*Mt-ct*Et,Zt=ct*Ot-ut*It,Kt=ut*Rt-lt*Ot,qt=lt*It-ct*Rt,Qt=ct*Ft-ut*Lt,Jt=ut*wt-lt*Ft,$t=lt*Lt-ct*wt,te=dt*Dt-ft*Mt,ee=ft*Et-pt*Dt,ie=pt*Mt-dt*Et,re=dt*Ot-ft*It,ne=ft*Rt-pt*Ot,se=pt*It-dt*Rt,oe=dt*Ft-ft*Lt,ae=ft*wt-pt*Ft,he=pt*Lt-dt*wt,le=_t*Dt-gt*Mt,ce=gt*Et-mt*Dt,ue=mt*Mt-_t*Et,pe=_t*Ot-gt*It,de=gt*Rt-mt*Ot,fe=mt*It-_t*Rt,me=_t*Ft-gt*Lt,_e=gt*wt-mt*Ft,ge=mt*Lt-_t*wt,ye=!1,ve=!1,xe=!1,be=!1,Pe=!1,Te=!1,Se=!1,Ae=!1,Ce=!1;if(V=lt*tt+ct*et+ut*it,s=V>0,s||(V=-V),N=rt,B=lt*Et+ct*Mt+ut*Dt,k=lt*Rt+ct*It+ut*Ot,U=lt*wt+ct*Lt+ut*Ft,B<0&&(B=-B),k<0&&(k=-k),U<0&&(U=-U),z=B*ot+k*at+U*ht,!((b=V-N-z)>0||(V=pt*tt+dt*et+ft*it,o=V>0,o||(V=-V),N=nt,B=pt*Et+dt*Mt+ft*Dt,k=pt*Rt+dt*It+ft*Ot,U=pt*wt+dt*Lt+ft*Ft,B<0&&(B=-B),k<0&&(k=-k),U<0&&(U=-U),z=B*ot+k*at+U*ht,(P=V-N-z)>0||(V=mt*tt+_t*et+gt*it,h=V>0,h||(V=-V),N=st,B=mt*Et+_t*Mt+gt*Dt,k=mt*Rt+_t*It+gt*Ot,U=mt*wt+_t*Lt+gt*Ft,B<0&&(B=-B),k<0&&(k=-k),U<0&&(U=-U),z=B*ot+k*at+U*ht,(T=V-N-z)>0||(V=Et*tt+Mt*et+Dt*it,l=V>0,l||(V=-V),B=Et*lt+Mt*ct+Dt*ut,k=Et*pt+Mt*dt+Dt*ft,U=Et*mt+Mt*_t+Dt*gt,B<0&&(B=-B),k<0&&(k=-k),U<0&&(U=-U),N=B*rt+k*nt+U*st,z=ot,(S=1*(V-N-z))>0||(V=Rt*tt+It*et+Ot*it,c=V>0,c||(V=-V),B=Rt*lt+It*ct+Ot*ut,k=Rt*pt+It*dt+Ot*ft,U=Rt*mt+It*_t+Ot*gt,B<0&&(B=-B),k<0&&(k=-k),U<0&&(U=-U),N=B*rt+k*nt+U*st,z=at,(A=1*(V-N-z))>0||(V=wt*tt+Lt*et+Ft*it,u=V>0,u||(V=-V),B=wt*lt+Lt*ct+Ft*ut,k=wt*pt+Lt*dt+Ft*ft,U=wt*mt+Lt*_t+Ft*gt,B<0&&(B=-B),k<0&&(k=-k),U<0&&(U=-U),N=B*rt+k*nt+U*st,z=ht,(C=1*(V-N-z))>0))))))){if((V=Ht*Ht+Xt*Xt+Yt*Yt)>1e-5){if(V=1/a.sqrt(V),Ht*=V,Xt*=V,Yt*=V,V=Ht*tt+Xt*et+Yt*it,p=V>0,p||(V=-V),B=Ht*pt+Xt*dt+Yt*ft,k=Ht*mt+Xt*_t+Yt*gt,B<0&&(B=-B),k<0&&(k=-k),N=B*nt+k*st,B=Ht*Rt+Xt*It+Yt*Ot,k=Ht*wt+Xt*Lt+Yt*Ft,B<0&&(B=-B),k<0&&(k=-k),z=B*at+k*ht,(E=V-N-z)>0)return}else p=!1,E=0,ye=!0;if((V=Zt*Zt+Kt*Kt+qt*qt)>1e-5){if(V=1/a.sqrt(V),Zt*=V,Kt*=V,qt*=V,V=Zt*tt+Kt*et+qt*it,d=V>0,d||(V=-V),B=Zt*pt+Kt*dt+qt*ft,k=Zt*mt+Kt*_t+qt*gt,B<0&&(B=-B),k<0&&(k=-k),N=B*nt+k*st,B=Zt*Et+Kt*Mt+qt*Dt,k=Zt*wt+Kt*Lt+qt*Ft,B<0&&(B=-B),k<0&&(k=-k),z=B*ot+k*ht,(M=V-N-z)>0)return}else d=!1,M=0,ve=!0;if((V=Qt*Qt+Jt*Jt+$t*$t)>1e-5){if(V=1/a.sqrt(V),Qt*=V,Jt*=V,$t*=V,V=Qt*tt+Jt*et+$t*it,f=V>0,f||(V=-V),B=Qt*pt+Jt*dt+$t*ft,k=Qt*mt+Jt*_t+$t*gt,B<0&&(B=-B),k<0&&(k=-k),N=B*nt+k*st,B=Qt*Et+Jt*Mt+$t*Dt,k=Qt*Rt+Jt*It+$t*Ot,B<0&&(B=-B),k<0&&(k=-k),z=B*ot+k*at,(D=V-N-z)>0)return}else f=!1,D=0,xe=!0;if((V=te*te+ee*ee+ie*ie)>1e-5){if(V=1/a.sqrt(V),te*=V,ee*=V,ie*=V,V=te*tt+ee*et+ie*it,m=V>0,m||(V=-V),B=te*lt+ee*ct+ie*ut,k=te*mt+ee*_t+ie*gt,B<0&&(B=-B),k<0&&(k=-k),N=B*rt+k*st,B=te*Rt+ee*It+ie*Ot,k=te*wt+ee*Lt+ie*Ft,B<0&&(B=-B),k<0&&(k=-k),z=B*at+k*ht,(R=V-N-z)>0)return}else m=!1,R=0,be=!0;if((V=re*re+ne*ne+se*se)>1e-5){if(V=1/a.sqrt(V),re*=V,ne*=V,se*=V,V=re*tt+ne*et+se*it,_=V>0,_||(V=-V),B=re*lt+ne*ct+se*ut,k=re*mt+ne*_t+se*gt,B<0&&(B=-B),k<0&&(k=-k),N=B*rt+k*st,B=re*Et+ne*Mt+se*Dt,k=re*wt+ne*Lt+se*Ft,B<0&&(B=-B),k<0&&(k=-k),z=B*ot+k*ht,(I=V-N-z)>0)return}else _=!1,I=0,Pe=!0;if((V=oe*oe+ae*ae+he*he)>1e-5){if(V=1/a.sqrt(V),oe*=V,ae*=V,he*=V,V=oe*tt+ae*et+he*it,g=V>0,g||(V=-V),B=oe*lt+ae*ct+he*ut,k=oe*mt+ae*_t+he*gt,B<0&&(B=-B),k<0&&(k=-k),N=B*rt+k*st,B=oe*Et+ae*Mt+he*Dt,k=oe*Rt+ae*It+he*Ot,B<0&&(B=-B),k<0&&(k=-k),z=B*ot+k*at,(O=V-N-z)>0)return}else g=!1,O=0,Te=!0;if((V=le*le+ce*ce+ue*ue)>1e-5){if(V=1/a.sqrt(V),le*=V,ce*=V,ue*=V,V=le*tt+ce*et+ue*it,y=V>0,y||(V=-V),B=le*lt+ce*ct+ue*ut,k=le*pt+ce*dt+ue*ft,B<0&&(B=-B),k<0&&(k=-k),N=B*rt+k*nt,B=le*Rt+ce*It+ue*Ot,k=le*wt+ce*Lt+ue*Ft,B<0&&(B=-B),k<0&&(k=-k),z=B*at+k*ht,(w=V-N-z)>0)return}else y=!1,w=0,Se=!0;if((V=pe*pe+de*de+fe*fe)>1e-5){if(V=1/a.sqrt(V),pe*=V,de*=V,fe*=V,V=pe*tt+de*et+fe*it,v=V>0,v||(V=-V),B=pe*lt+de*ct+fe*ut,k=pe*pt+de*dt+fe*ft,B<0&&(B=-B),k<0&&(k=-k),N=B*rt+k*nt,B=pe*Et+de*Mt+fe*Dt,k=pe*wt+de*Lt+fe*Ft,B<0&&(B=-B),k<0&&(k=-k),z=B*ot+k*ht,(L=V-N-z)>0)return}else v=!1,L=0,Ae=!0;if((V=me*me+_e*_e+ge*ge)>1e-5){if(V=1/a.sqrt(V),me*=V,_e*=V,ge*=V,V=me*tt+_e*et+ge*it,x=V>0,x||(V=-V),B=me*lt+_e*ct+ge*ut,k=me*pt+_e*dt+ge*ft,B<0&&(B=-B),k<0&&(k=-k),N=B*rt+k*nt,B=me*Et+_e*Mt+ge*Dt,k=me*Rt+_e*It+ge*Ot,B<0&&(B=-B),k<0&&(k=-k),z=B*ot+k*at,(F=V-N-z)>0)return}else x=!1,F=0,Ce=!0;var Ee=b,Me=b,De=0,Re=s;P>Me&&(Ee=P,Me=P,De=1,Re=o),T>Me&&(Ee=T,Me=T,De=2,Re=h),S>Me&&(Ee=S,Me=S,De=3,Re=l),A>Me&&(Ee=A,Me=A,De=4,Re=c),C>Me&&(Ee=C,Me=C,De=5,Re=u),E-.01>Me&&!ye&&(Ee=E,Me=E-.01,De=6,Re=p),M-.01>Me&&!ve&&(Ee=M,Me=M-.01,De=7,Re=d),D-.01>Me&&!xe&&(Ee=D,Me=D-.01,De=8,Re=f),R-.01>Me&&!be&&(Ee=R,Me=R-.01,De=9,Re=m),I-.01>Me&&!Pe&&(Ee=I,Me=I-.01,De=10,Re=_),O-.01>Me&&!Te&&(Ee=O,Me=O-.01,De=11,Re=g),w-.01>Me&&!Se&&(Ee=w,Me=w-.01,De=12,Re=y),L-.01>Me&&!Ae&&(Ee=L,Me=L-.01,De=13,Re=v),F-.01>Me&&!Ce&&(Ee=F,De=14,Re=x);var Ie=0,Oe=0,we=0,Le=0,Fe=0,Ve=0,Ne=0,ze=0,Be=0,ke=0,Ue=0,Ge=0,We=0,je=0,He=0,Xe=0,Ye=0,Ze=0,Ke=!1;0==De?(Re?(ke=Z+yt,Ue=K+vt,Ge=q+xt,Ie=lt,Oe=ct,we=ut):(ke=Z-yt,Ue=K-vt,Ge=q-xt,Ie=-lt,Oe=-ct,we=-ut),We=bt,je=Pt,He=Tt,Le=-pt,Fe=-dt,Ve=-ft,Xe=St,Ye=At,Ze=Ct,Ne=-mt,ze=-_t,Be=-gt):1==De?(Re?(ke=Z+bt,Ue=K+Pt,Ge=q+Tt,Ie=pt,Oe=dt,we=ft):(ke=Z-bt,Ue=K-Pt,Ge=q-Tt,Ie=-pt,Oe=-dt,we=-ft),We=yt,je=vt,He=xt,Le=-lt,Fe=-ct,Ve=-ut,Xe=St,Ye=At,Ze=Ct,Ne=-mt,ze=-_t,Be=-gt):2==De?(Re?(ke=Z+St,Ue=K+At,Ge=q+Ct,Ie=mt,Oe=_t,we=gt):(ke=Z-St,Ue=K-At,Ge=q-Ct,Ie=-mt,Oe=-_t,we=-gt),We=yt,je=vt,He=xt,Le=-lt,Fe=-ct,Ve=-ut,Xe=bt,Ye=Pt,Ze=Tt,Ne=-pt,ze=-dt,Be=-ft):3==De?(Ke=!0,Re?(ke=Q-Vt,Ue=J-Nt,Ge=$-zt,Ie=-Et,Oe=-Mt,we=-Dt):(ke=Q+Vt,Ue=J+Nt,Ge=$+zt,Ie=Et,Oe=Mt,we=Dt),We=Bt,je=kt,He=Ut,Le=-Rt,Fe=-It,Ve=-Ot,Xe=Gt,Ye=Wt,Ze=jt,Ne=-wt,ze=-Lt,Be=-Ft):4==De?(Ke=!0,Re?(ke=Q-Bt,Ue=J-kt,Ge=$-Ut,Ie=-Rt,Oe=-It,we=-Ot):(ke=Q+Bt,Ue=J+kt,Ge=$+Ut,Ie=Rt,Oe=It,we=Ot),We=Vt,je=Nt,He=zt,Le=-Et,Fe=-Mt,Ve=-Dt,Xe=Gt,Ye=Wt,Ze=jt,Ne=-wt,ze=-Lt,Be=-Ft):5==De?(Ke=!0,Re?(ke=Q-Gt,Ue=J-Wt,Ge=$-jt,Ie=-wt,Oe=-Lt,we=-Ft):(ke=Q+Gt,Ue=J+Wt,Ge=$+jt,Ie=wt,Oe=Lt,we=Ft),We=Vt,je=Nt,He=zt,Le=-Et,Fe=-Mt,Ve=-Dt,Xe=Bt,Ye=kt,Ze=Ut,Ne=-Rt,ze=-It,Be=-Ot):6==De?(Ie=Ht,Oe=Xt,we=Yt,Le=lt,Fe=ct,Ve=ut,Ne=Et,ze=Mt,Be=Dt):7==De?(Ie=Zt,Oe=Kt,we=qt,Le=lt,Fe=ct,Ve=ut,Ne=Rt,ze=It,Be=Ot):8==De?(Ie=Qt,Oe=Jt,we=$t,Le=lt,Fe=ct,Ve=ut,Ne=wt,ze=Lt,Be=Ft):9==De?(Ie=te,Oe=ee,we=ie,Le=pt,Fe=dt,Ve=ft,Ne=Et,ze=Mt,Be=Dt):10==De?(Ie=re,Oe=ne,we=se,Le=pt,Fe=dt,Ve=ft,Ne=Rt,ze=It,Be=Ot):11==De?(Ie=oe,Oe=ae,we=he,Le=pt,Fe=dt,Ve=ft,Ne=wt,ze=Lt,Be=Ft):12==De?(Ie=le,Oe=ce,we=ue,Le=mt,Fe=_t,Ve=gt,Ne=Et,ze=Mt,Be=Dt):13==De?(Ie=pe,Oe=de,we=fe,Le=mt,Fe=_t,Ve=gt,Ne=Rt,ze=It,Be=Ot):14==De&&(Ie=me,Oe=_e,we=ge,Le=mt,Fe=_t,Ve=gt,Ne=wt,ze=Lt,Be=Ft);if(De>5){Re||(Ie=-Ie,Oe=-Oe,we=-we);var qe,Qe,Je,$e,ti,ei,ii,ri,ni,si,oi;ei=G[0],ii=G[1],ri=G[2],Qe=Ie*ei+Oe*ii+we*ri,Je=G[3],$e=G[4],ti=G[5],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),Je=G[6],$e=G[7],ti=G[8],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),Je=G[9],$e=G[10],ti=G[11],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),Je=G[12],$e=G[13],ti=G[14],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),Je=G[15],$e=G[16],ti=G[17],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),Je=G[18],$e=G[19],ti=G[20],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),Je=G[21],$e=G[22],ti=G[23],qe=Ie*Je+Oe*$e+we*ti,qe>Qe&&(Qe=qe,ei=Je,ii=$e,ri=ti),ni=W[0],si=W[1],oi=W[2],Qe=Ie*ni+Oe*si+we*oi,Je=W[3],$e=W[4],ti=W[5],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=W[6],$e=W[7],ti=W[8],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=W[9],$e=W[10],ti=W[11],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=W[12],$e=W[13],ti=W[14],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=W[15],$e=W[16],ti=W[17],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=W[18],$e=W[19],ti=W[20],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=W[21],$e=W[22],ti=W[23],qe=Ie*Je+Oe*$e+we*ti,qe<Qe&&(Qe=qe,ni=Je,si=$e,oi=ti),Je=ni-ei,$e=si-ii,ti=oi-ri,B=Le*Ne+Fe*ze+Ve*Be;var ai=(Je*(Le-Ne*B)+$e*(Fe-ze*B)+ti*(Ve-Be*B))/(1-B*B);return void i.addPoint(ei+Le*ai+Ie*Ee*.5,ii+Fe*ai+Oe*Ee*.5,ri+Ve*ai+we*Ee*.5,Ie,Oe,we,Ee,!1)}var hi,li,ci,ui,pi,di,fi,mi,_i,gi,yi,vi,xi=1,bi=0,Pi=0;Ke?(bi=lt*Ie+ct*Oe+ut*we,bi<xi&&(xi=bi,Pi=0),-bi<xi&&(xi=-bi,Pi=1),bi=pt*Ie+dt*Oe+ft*we,bi<xi&&(xi=bi,Pi=2),-bi<xi&&(xi=-bi,Pi=3),bi=mt*Ie+_t*Oe+gt*we,bi<xi&&(xi=bi,Pi=4),-bi<xi&&(xi=-bi,Pi=5),0==Pi?(hi=G[0],li=G[1],ci=G[2],ui=G[6],pi=G[7],di=G[8],fi=G[9],mi=G[10],_i=G[11],gi=G[3],yi=G[4],vi=G[5]):1==Pi?(hi=G[15],li=G[16],ci=G[17],ui=G[21],pi=G[22],di=G[23],fi=G[18],mi=G[19],_i=G[20],gi=G[12],yi=G[13],vi=G[14]):2==Pi?(hi=G[12],li=G[13],ci=G[14],ui=G[0],pi=G[1],di=G[2],fi=G[3],mi=G[4],_i=G[5],gi=G[15],yi=G[16],vi=G[17]):3==Pi?(hi=G[21],li=G[22],ci=G[23],ui=G[9],pi=G[10],di=G[11],fi=G[6],mi=G[7],_i=G[8],gi=G[18],yi=G[19],vi=G[20]):4==Pi?(hi=G[12],li=G[13],ci=G[14],ui=G[18],pi=G[19],di=G[20],fi=G[6],mi=G[7],_i=G[8],gi=G[0],yi=G[1],vi=G[2]):5==Pi&&(hi=G[3],li=G[4],ci=G[5],ui=G[6],pi=G[7],di=G[8],fi=G[21],mi=G[22],_i=G[23],gi=G[15],yi=G[16],vi=G[17])):(bi=Et*Ie+Mt*Oe+Dt*we,bi<xi&&(xi=bi,Pi=0),-bi<xi&&(xi=-bi,Pi=1),bi=Rt*Ie+It*Oe+Ot*we,bi<xi&&(xi=bi,Pi=2),-bi<xi&&(xi=-bi,Pi=3),bi=wt*Ie+Lt*Oe+Ft*we,bi<xi&&(xi=bi,Pi=4),-bi<xi&&(xi=-bi,Pi=5),0==Pi?(hi=W[0],li=W[1],ci=W[2],ui=W[6],pi=W[7],di=W[8],fi=W[9],mi=W[10],_i=W[11],gi=W[3],yi=W[4],vi=W[5]):1==Pi?(hi=W[15],li=W[16],ci=W[17],ui=W[21],pi=W[22],di=W[23],fi=W[18],mi=W[19],_i=W[20],gi=W[12],yi=W[13],vi=W[14]):2==Pi?(hi=W[12],li=W[13],ci=W[14],ui=W[0],pi=W[1],di=W[2],fi=W[3],mi=W[4],_i=W[5],gi=W[15],yi=W[16],vi=W[17]):3==Pi?(hi=W[21],li=W[22],ci=W[23],ui=W[9],pi=W[10],di=W[11],fi=W[6],mi=W[7],_i=W[8],gi=W[18],yi=W[19],vi=W[20]):4==Pi?(hi=W[12],li=W[13],ci=W[14],ui=W[18],pi=W[19],di=W[20],fi=W[6],mi=W[7],_i=W[8],gi=W[0],yi=W[1],vi=W[2]):5==Pi&&(hi=W[3],li=W[4],ci=W[5],ui=W[9],pi=W[10],di=W[11],fi=W[21],mi=W[22],_i=W[23],gi=W[15],yi=W[16],vi=W[17]));var Ti,Si,Ai,Ci,Ei,Mi,Di,Ri,Ii;this.clipVertices1[0]=hi,this.clipVertices1[1]=li,this.clipVertices1[2]=ci,this.clipVertices1[3]=ui,this.clipVertices1[4]=pi,this.clipVertices1[5]=di,this.clipVertices1[6]=fi,this.clipVertices1[7]=mi,this.clipVertices1[8]=_i,this.clipVertices1[9]=gi,this.clipVertices1[10]=yi,this.clipVertices1[11]=vi,Si=0,Ci=this.clipVertices1[9],Ei=this.clipVertices1[10],Mi=this.clipVertices1[11],B=(Ci-ke-We)*Le+(Ei-Ue-je)*Fe+(Mi-Ge-He)*Ve;for(var Oi=0;Oi<4;Oi++)Ai=3*Oi,Di=this.clipVertices1[Ai],Ri=this.clipVertices1[Ai+1],Ii=this.clipVertices1[Ai+2],k=(Di-ke-We)*Le+(Ri-Ue-je)*Fe+(Ii-Ge-He)*Ve,B>0?k>0?(Ai=3*Si,Si++,this.clipVertices2[Ai]=Di,this.clipVertices2[Ai+1]=Ri,this.clipVertices2[Ai+2]=Ii):(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices2[Ai]=Ci+(Di-Ci)*ai,this.clipVertices2[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices2[Ai+2]=Mi+(Ii-Mi)*ai):k>0&&(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices2[Ai]=Ci+(Di-Ci)*ai,this.clipVertices2[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices2[Ai+2]=Mi+(Ii-Mi)*ai,Ai=3*Si,Si++,this.clipVertices2[Ai]=Di,this.clipVertices2[Ai+1]=Ri,this.clipVertices2[Ai+2]=Ii),Ci=Di,Ei=Ri,Mi=Ii,B=k;if(0!=(Ti=Si)){for(Si=0,Ai=3*(Ti-1),Ci=this.clipVertices2[Ai],Ei=this.clipVertices2[Ai+1],Mi=this.clipVertices2[Ai+2],B=(Ci-ke-Xe)*Ne+(Ei-Ue-Ye)*ze+(Mi-Ge-Ze)*Be,Oi=0;Oi<Ti;Oi++)Ai=3*Oi,Di=this.clipVertices2[Ai],Ri=this.clipVertices2[Ai+1],Ii=this.clipVertices2[Ai+2],k=(Di-ke-Xe)*Ne+(Ri-Ue-Ye)*ze+(Ii-Ge-Ze)*Be,B>0?k>0?(Ai=3*Si,Si++,this.clipVertices1[Ai]=Di,this.clipVertices1[Ai+1]=Ri,this.clipVertices1[Ai+2]=Ii):(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices1[Ai]=Ci+(Di-Ci)*ai,this.clipVertices1[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices1[Ai+2]=Mi+(Ii-Mi)*ai):k>0&&(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices1[Ai]=Ci+(Di-Ci)*ai,this.clipVertices1[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices1[Ai+2]=Mi+(Ii-Mi)*ai,Ai=3*Si,Si++,this.clipVertices1[Ai]=Di,this.clipVertices1[Ai+1]=Ri,this.clipVertices1[Ai+2]=Ii),Ci=Di,Ei=Ri,Mi=Ii,B=k;if(0!=(Ti=Si)){for(Si=0,Ai=3*(Ti-1),Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],B=(Ci-ke+We)*-Le+(Ei-Ue+je)*-Fe+(Mi-Ge+He)*-Ve,Oi=0;Oi<Ti;Oi++)Ai=3*Oi,Di=this.clipVertices1[Ai],Ri=this.clipVertices1[Ai+1],Ii=this.clipVertices1[Ai+2],k=(Di-ke+We)*-Le+(Ri-Ue+je)*-Fe+(Ii-Ge+He)*-Ve,B>0?k>0?(Ai=3*Si,Si++,this.clipVertices2[Ai]=Di,this.clipVertices2[Ai+1]=Ri,this.clipVertices2[Ai+2]=Ii):(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices2[Ai]=Ci+(Di-Ci)*ai,this.clipVertices2[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices2[Ai+2]=Mi+(Ii-Mi)*ai):k>0&&(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices2[Ai]=Ci+(Di-Ci)*ai,this.clipVertices2[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices2[Ai+2]=Mi+(Ii-Mi)*ai,Ai=3*Si,Si++,this.clipVertices2[Ai]=Di,this.clipVertices2[Ai+1]=Ri,this.clipVertices2[Ai+2]=Ii),Ci=Di,Ei=Ri,Mi=Ii,B=k;if(0!=(Ti=Si)){for(Si=0,Ai=3*(Ti-1),Ci=this.clipVertices2[Ai],Ei=this.clipVertices2[Ai+1],Mi=this.clipVertices2[Ai+2],B=(Ci-ke+Xe)*-Ne+(Ei-Ue+Ye)*-ze+(Mi-Ge+Ze)*-Be,Oi=0;Oi<Ti;Oi++)Ai=3*Oi,Di=this.clipVertices2[Ai],Ri=this.clipVertices2[Ai+1],Ii=this.clipVertices2[Ai+2],k=(Di-ke+Xe)*-Ne+(Ri-Ue+Ye)*-ze+(Ii-Ge+Ze)*-Be,B>0?k>0?(Ai=3*Si,Si++,this.clipVertices1[Ai]=Di,this.clipVertices1[Ai+1]=Ri,this.clipVertices1[Ai+2]=Ii):(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices1[Ai]=Ci+(Di-Ci)*ai,this.clipVertices1[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices1[Ai+2]=Mi+(Ii-Mi)*ai):k>0&&(Ai=3*Si,Si++,ai=B/(B-k),this.clipVertices1[Ai]=Ci+(Di-Ci)*ai,this.clipVertices1[Ai+1]=Ei+(Ri-Ei)*ai,this.clipVertices1[Ai+2]=Mi+(Ii-Mi)*ai,Ai=3*Si,Si++,this.clipVertices1[Ai]=Di,this.clipVertices1[Ai+1]=Ri,this.clipVertices1[Ai+2]=Ii),Ci=Di,Ei=Ri,Mi=Ii,B=k;if(Ti=Si,Ke){var wi=r;r=n,n=wi}if(0!=Ti){var Li=r!=t;if(Ti>4){Ci=.25*(hi+ui+fi+gi),Ei=.25*(li+pi+mi+yi),Mi=.25*(ci+di+_i+vi),Le=hi-Ci,Fe=li-Ei,Ve=ci-Mi,Ne=ui-Ci,ze=pi-Ei,Be=di-Mi;var Fi=0,Vi=0,Ni=0,zi=0,Bi=-this.INF;for(xi=this.INF,Oi=0;Oi<Ti;Oi++)this.used[Oi]=!1,Ai=3*Oi,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],bi=Ci*Le+Ei*Fe+Mi*Ve,bi<xi&&(xi=bi,Fi=Oi),bi>Bi&&(Bi=bi,Ni=Oi);for(this.used[Fi]=!0,this.used[Ni]=!0,Bi=-this.INF,xi=this.INF,Oi=0;Oi<Ti;Oi++)this.used[Oi]||(Ai=3*Oi,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],bi=Ci*Ne+Ei*ze+Mi*Be,bi<xi&&(xi=bi,Vi=Oi),bi>Bi&&(Bi=bi,zi=Oi));Ai=3*Fi,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],bi=(Ci-ke)*Ie+(Ei-Ue)*Oe+(Mi-Ge)*we,bi<0&&i.addPoint(Ci,Ei,Mi,Ie,Oe,we,bi,Li),Ai=3*Vi,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],bi=(Ci-ke)*Ie+(Ei-Ue)*Oe+(Mi-Ge)*we,bi<0&&i.addPoint(Ci,Ei,Mi,Ie,Oe,we,bi,Li),Ai=3*Ni,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],bi=(Ci-ke)*Ie+(Ei-Ue)*Oe+(Mi-Ge)*we,bi<0&&i.addPoint(Ci,Ei,Mi,Ie,Oe,we,bi,Li),Ai=3*zi,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],bi=(Ci-ke)*Ie+(Ei-Ue)*Oe+(Mi-Ge)*we,bi<0&&i.addPoint(Ci,Ei,Mi,Ie,Oe,we,bi,Li)}else for(Oi=0;Oi<Ti;Oi++)Ai=3*Oi,Ci=this.clipVertices1[Ai],Ei=this.clipVertices1[Ai+1],Mi=this.clipVertices1[Ai+2],(bi=(Ci-ke)*Ie+(Ei-Ue)*Oe+(Mi-Ge)*we)<0&&i.addPoint(Ci,Ei,Mi,Ie,Oe,we,bi,Li)}}}}}},a.SphereBoxCollisionDetector=function(t){a.CollisionDetector.call(this),this.flip=t},a.SphereBoxCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.SphereBoxCollisionDetector.prototype.constructor=a.SphereBoxCollisionDetector,a.SphereBoxCollisionDetector.prototype.detectCollision=function(t,e,i){var r,n;this.flip?(r=e,n=t):(r=t,n=e);var s,o,h,l,c,u=n.dimentions,p=r.position,d=p.x,f=p.y,m=p.z,_=n.position,g=_.x,y=_.y,v=_.z,x=r.radius,b=n.halfWidth,P=n.halfHeight,T=n.halfDepth,S=d-g,A=f-y,C=m-v,E=u[0]*S+u[1]*A+u[2]*C,M=u[3]*S+u[4]*A+u[5]*C,D=u[6]*S+u[7]*A+u[8]*C,R=0;E>b?E=b:E<-b?E=-b:R=1,M>P?M=P:M<-P?M=-P:R|=2,D>T?D=T:D<-T?D=-T:R|=4,7==R?(S=E<0?b+E:b-E,A=M<0?P+M:P-M,C=D<0?T+D:T-D,S<A?S<C?(l=S-b,E<0?(E=-b,S=u[0],A=u[1],C=u[2]):(E=b,S=-u[0],A=-u[1],C=-u[2])):(l=C-T,D<0?(D=-T,S=u[6],A=u[7],C=u[8]):(D=T,S=-u[6],A=-u[7],C=-u[8])):A<C?(l=A-P,M<0?(M=-P,S=u[3],A=u[4],C=u[5]):(M=P,S=-u[3],A=-u[4],C=-u[5])):(l=C-T,D<0?(D=-T,S=u[6],A=u[7],C=u[8]):(D=T,S=-u[6],A=-u[7],C=-u[8])),s=g+E*u[0]+M*u[3]+D*u[6],o=y+E*u[1]+M*u[4]+D*u[7],h=v+E*u[2]+M*u[5]+D*u[8],i.addPoint(d+x*S,f+x*A,m+x*C,S,A,C,l-x,this.flip)):(s=g+E*u[0]+M*u[3]+D*u[6],o=y+E*u[1]+M*u[4]+D*u[7],h=v+E*u[2]+M*u[5]+D*u[8],S=s-p.x,A=o-p.y,C=h-p.z,(l=S*S+A*A+C*C)>0&&l<x*x&&(l=a.sqrt(l),c=1/l,S*=c,A*=c,C*=c,i.addPoint(d+x*S,f+x*A,m+x*C,S,A,C,l-x,this.flip)))},a.SphereSphereCollisionDetector=function(){a.CollisionDetector.call(this)},a.SphereSphereCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.SphereSphereCollisionDetector.prototype.constructor=a.SphereSphereCollisionDetector,a.SphereSphereCollisionDetector.prototype.detectCollision=function(t,e,i){var r=t,n=e,s=r.position,o=n.position,h=o.x-s.x,l=o.y-s.y,c=o.z-s.z,u=h*h+l*l+c*c,p=r.radius,d=n.radius,f=p+d;if(u>0&&u<f*f){u=a.sqrt(u);var m=1/u;h*=m,l*=m,c*=m,i.addPoint(s.x+h*p,s.y+l*p,s.z+c*p,h,l,c,u-f,!1)}},a.BoxCylinderCollisionDetector=function(t){a.CollisionDetector.call(this),this.flip=t},a.BoxCylinderCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.BoxCylinderCollisionDetector.prototype.constructor=a.BoxCylinderCollisionDetector,a.BoxCylinderCollisionDetector.prototype.getSep=function(t,e,i,r,n){var s,o,h,l,c,u,p,d,f,m,_,g,y,v=new a.Vec3,x=t.position.x,b=t.position.y,P=t.position.z,T=e.position.x,S=e.position.y,A=e.position.z,C=T-x,E=S-b,M=A-P;C*C+E*E+M*M==0&&(E=.001);var D=-C,R=-E,I=-M;this.supportPointB(t,-D,-R,-I,v);var O=v.x,w=v.y,L=v.z;this.supportPointC(e,D,R,I,v);var F=v.x,V=v.y,N=v.z,z=F-O,B=V-w,k=N-L;if(z*D+B*R+k*I<=0)return!1;if(D=B*M-k*E,R=k*C-z*M,I=z*E-B*C,D*D+R*R+I*I==0)return i.init(z-C,B-E,k-M),i.normalize(i),r.init(.5*(O+F),.5*(w+V),.5*(L+N)),!0;this.supportPointB(t,-D,-R,-I,v);var U=v.x,G=v.y,W=v.z;this.supportPointC(e,D,R,I,v);var j=v.x,H=v.y,X=v.z,Y=j-U,Z=H-G,K=X-W;if(Y*D+Z*R+K*I<=0)return!1;s=z-C,o=B-E,h=k-M,l=Y-C,c=Z-E,u=K-M,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l,D*C+R*E+I*M>0&&(s=z,o=B,h=k,z=Y,B=Z,k=K,Y=s,Z=o,K=h,s=O,o=w,h=L,O=U,w=G,L=W,U=s,G=o,W=h,s=F,o=V,h=N,F=j,V=H,N=X,j=s,H=o,X=h,D=-D,R=-R,I=-I);for(var q=0;;){if(++q>100)return!1;this.supportPointB(t,-D,-R,-I,v);var Q=v.x,J=v.y,$=v.z;this.supportPointC(e,D,R,I,v);var tt=v.x,et=v.y,it=v.z,rt=tt-Q,nt=et-J,st=it-$;if(rt*D+nt*R+st*I<=0)return!1;if((B*st-k*nt)*C+(k*rt-z*st)*E+(z*nt-B*rt)*M<0)Y=rt,Z=nt,K=st,U=Q,G=J,W=$,j=tt,H=et,X=it,s=z-C,o=B-E,h=k-M,l=rt-C,c=nt-E,u=st-M,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l;else if((nt*K-st*Z)*C+(st*Y-rt*K)*E+(rt*Z-nt*Y)*M<0)z=rt,B=nt,k=st,O=Q,w=J,L=$,F=tt,V=et,N=it,s=rt-C,o=nt-E,h=st-M,l=Y-C,c=Z-E,u=K-M,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l;else for(var ot=!1;;){if(s=Y-z,o=Z-B,h=K-k,l=rt-z,c=nt-B,u=st-k,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l,p=1/a.sqrt(D*D+R*R+I*I),D*=p,R*=p,I*=p,D*z+R*B+I*k>=0&&!ot){var at=(B*K-k*Z)*rt+(k*Y-z*K)*nt+(z*Z-B*Y)*st,ht=(nt*K-st*Z)*C+(st*Y-rt*K)*E+(rt*Z-nt*Y)*M,lt=(E*k-M*B)*rt+(M*z-C*k)*nt+(C*B-E*z)*st,ct=(Z*k-K*B)*C+(K*z-Y*k)*E+(Y*B-Z*z)*M,ut=at+ht+lt+ct;ut<=0&&(at=0,ht=(Z*st-K*nt)*D+(K*rt-Y*st)*R+(Y*nt-Z*rt)*I,lt=(nt*K-st*Z)*D+(st*Y-rt*K)*R+(rt*Z-nt*Y)*I,ct=(B*K-k*Z)*D+(k*Y-z*K)*R+(z*Z-B*Y)*I,ut=ht+lt+ct);var pt=1/ut;d=(x*at+O*ht+U*lt+Q*ct)*pt,f=(b*at+w*ht+G*lt+J*ct)*pt,m=(P*at+L*ht+W*lt+$*ct)*pt,_=(T*at+F*ht+j*lt+tt*ct)*pt,g=(S*at+V*ht+H*lt+et*ct)*pt,y=(A*at+N*ht+X*lt+it*ct)*pt,ot=!0}this.supportPointB(t,-D,-R,-I,v);var dt=v.x,ft=v.y,mt=v.z;this.supportPointC(e,D,R,I,v);var _t=v.x,gt=v.y,yt=v.z,vt=_t-dt,xt=gt-ft,bt=yt-mt,Pt=-(vt*D+xt*R+bt*I);if((vt-rt)*D+(xt-nt)*R+(bt-st)*I<=.01||Pt>=0)return!!ot&&(i.init(-D,-R,-I),r.init(.5*(d+_),.5*(f+g),.5*(m+y)),n.x=Pt,!0);(xt*k-bt*B)*C+(bt*z-vt*k)*E+(vt*B-xt*z)*M<0?(xt*K-bt*Z)*C+(bt*Y-vt*K)*E+(vt*Z-xt*Y)*M<0?(z=vt,B=xt,k=bt,O=dt,w=ft,L=mt,F=_t,V=gt,N=yt):(rt=vt,nt=xt,st=bt,Q=dt,J=ft,$=mt,tt=_t,et=gt,it=yt):(xt*st-bt*nt)*C+(bt*rt-vt*st)*E+(vt*nt-xt*rt)*M<0?(Y=vt,Z=xt,K=bt,U=dt,G=ft,W=mt,j=_t,H=gt,X=yt):(z=vt,B=xt,k=bt,O=dt,w=ft,L=mt,F=_t,V=gt,N=yt)}}},a.BoxCylinderCollisionDetector.prototype.supportPointB=function(t,e,i,r,n){var s,o,a,h=t.rotation.elements,l=h[0]*e+h[3]*i+h[6]*r,c=h[1]*e+h[4]*i+h[7]*r,u=h[2]*e+h[5]*i+h[8]*r,p=t.halfWidth,d=t.halfHeight,f=t.halfDepth;s=l<0?-p:p,o=c<0?-d:d,a=u<0?-f:f,l=h[0]*s+h[1]*o+h[2]*a+t.position.x,c=h[3]*s+h[4]*o+h[5]*a+t.position.y,u=h[6]*s+h[7]*o+h[8]*a+t.position.z,n.init(l,c,u)},a.BoxCylinderCollisionDetector.prototype.supportPointC=function(t,e,i,r,n){var s,o,h,l=t.rotation.elements,c=l[0]*e+l[3]*i+l[6]*r,u=l[1]*e+l[4]*i+l[7]*r,p=l[2]*e+l[5]*i+l[8]*r,d=c,f=p,m=d*d+f*f,_=t.radius,g=t.halfHeight;0==m?u<0?(s=_,o=-g,h=0):(s=_,o=g,h=0):(m=t.radius/a.sqrt(m),u<0?(s=d*m,o=-g,h=f*m):(s=d*m,o=g,h=f*m)),c=l[0]*s+l[1]*o+l[2]*h+t.position.x,u=l[3]*s+l[4]*o+l[5]*h+t.position.y,p=l[6]*s+l[7]*o+l[8]*h+t.position.z,n.init(c,u,p)},a.BoxCylinderCollisionDetector.prototype.detectCollision=function(t,e,i){var r,n;this.flip?(r=e,n=t):(r=t,n=e);var s=new a.Vec3,o=new a.Vec3,h=new a.Vec3;if(this.getSep(r,n,s,o,h)){var l=r.position.x,c=r.position.y,u=r.position.z,p=n.position.x,d=n.position.y,f=n.position.z,m=r.halfWidth,_=r.halfHeight,g=r.halfDepth,y=n.halfHeight,v=n.radius,x=r.dimentions,b=x[0],P=x[1],T=x[2],S=x[3],A=x[4],C=x[5],E=x[6],M=x[7],D=x[8],R=x[9],I=x[10],O=x[11],w=x[12],L=x[13],F=x[14],V=x[15],N=x[16],z=x[17],B=n.normalDirection.x,k=n.normalDirection.y,U=n.normalDirection.z,G=n.halfDirection.x,W=n.halfDirection.y,j=n.halfDirection.z,H=s.x,X=s.y,Y=s.z,Z=H*b+X*P+Y*T,K=H*S+X*A+Y*C,q=H*E+X*M+Y*D,Q=H*B+X*k+Y*U,J=Z>0,$=K>0,tt=q>0,et=Q>0;J||(Z=-Z),$||(K=-K),tt||(q=-q),et||(Q=-Q);var it=0;Q>.999?it=Z>.999?Z>Q?1:4:K>.999?K>Q?2:4:q>.999&&q>Q?3:4:Z>.999?it=1:K>.999?it=2:q>.999&&(it=3);var rt,nt,st,ot,at,ht,lt,ct,ut,pt,dt,ft,mt,_t,gt,yt,vt,xt,bt,Pt,Tt,St,At,Ct,Et,Mt,Dt,Rt,It,Ot,wt,Lt,Ft,Vt,Nt,zt,Bt,kt,Ut,Gt,Wt,jt,Ht,Xt,Yt,Zt,Kt,qt,Qt,Jt,$t,te,ee;if(0==it)i.addPoint(o.x,o.y,o.z,H,X,Y,h.x,this.flip);else if(4==it){et?(ot=p-G,at=d-W,ht=f-j,H=-B,X=-k,Y=-U):(ot=p+G,at=d+W,ht=f+j,H=B,X=k,Y=U);var ie,re,ne,se,oe,ae,he,le,ce,ue,pe,de;Pt=1,it=0,Ht=b*H+P*X+T*Y,Ht<Pt&&(Pt=Ht,it=0),-Ht<Pt&&(Pt=-Ht,it=1),Ht=S*H+A*X+C*Y,Ht<Pt&&(Pt=Ht,it=2),-Ht<Pt&&(Pt=-Ht,it=3),Ht=E*H+M*X+D*Y,Ht<Pt&&(Pt=Ht,it=4),-Ht<Pt&&(Pt=-Ht,it=5);var fe=r.elements;switch(it){case 0:ie=fe[0],re=fe[1],ne=fe[2],se=fe[6],oe=fe[7],ae=fe[8],he=fe[9],le=fe[10],ce=fe[11],ue=fe[3],pe=fe[4],de=fe[5];break;case 1:ie=fe[15],re=fe[16],ne=fe[17],se=fe[21],oe=fe[22],ae=fe[23],he=fe[18],le=fe[19],ce=fe[20],ue=fe[12],pe=fe[13],de=fe[14];break;case 2:ie=fe[12],re=fe[13],ne=fe[14],se=fe[0],oe=fe[1],ae=fe[2],he=fe[3],le=fe[4],ce=fe[5],ue=fe[15],pe=fe[16],de=fe[17];break;case 3:ie=fe[21],re=fe[22],ne=fe[23],se=fe[9],oe=fe[10],ae=fe[11],he=fe[6],le=fe[7],ce=fe[8],ue=fe[18],pe=fe[19],de=fe[20];break;case 4:ie=fe[12],re=fe[13],ne=fe[14],se=fe[18],oe=fe[19],ae=fe[20],he=fe[6],le=fe[7],ce=fe[8],ue=fe[0],pe=fe[1],de=fe[2];break;case 5:ie=fe[3],re=fe[4],ne=fe[5],se=fe[9],oe=fe[10],ae=fe[11],he=fe[21],le=fe[22],ce=fe[23],ue=fe[15],pe=fe[16],de=fe[17]}bt=H*(ie-ot)+X*(re-at)+Y*(ne-ht),bt<=0&&i.addPoint(ie,re,ne,-H,-X,-Y,bt,this.flip),bt=H*(se-ot)+X*(oe-at)+Y*(ae-ht),bt<=0&&i.addPoint(se,oe,ae,-H,-X,-Y,bt,this.flip),bt=H*(he-ot)+X*(le-at)+Y*(ce-ht),bt<=0&&i.addPoint(he,le,ce,-H,-X,-Y,bt,this.flip),bt=H*(ue-ot)+X*(pe-at)+Y*(de-ht),bt<=0&&i.addPoint(ue,pe,de,-H,-X,-Y,bt,this.flip)}else{switch(it){case 1:J?(rt=l+R,nt=c+I,st=u+O,H=b,X=P,Y=T):(rt=l-R,nt=c-I,st=u-O,H=-b,X=-P,Y=-T),Zt=S,Kt=A,qt=C,te=_,Qt=E,Jt=M,$t=D,ee=g;break;case 2:$?(rt=l+w,nt=c+L,st=u+F,H=S,X=A,Y=C):(rt=l-w,nt=c-L,st=u-F,H=-S,X=-A,Y=-C),Zt=b,Kt=P,qt=T,te=m,Qt=E,Jt=M,$t=D,ee=g;break;case 3:tt?(rt=l+V,nt=c+N,st=u+z,H=E,X=M,Y=D):(rt=l-V,nt=c-N,st=u-z,H=-E,X=-M,Y=-D),Zt=b,Kt=P,qt=T,te=m,Qt=S,Jt=A,$t=C,ee=_}if(Pt=H*B+X*k+Y*U,Tt=Pt<0?y:-y,ot=p+Tt*B,at=d+Tt*k,ht=f+Tt*U,Q>=.999999?(St=-X,At=Y,Ct=H):(St=H,At=X,Ct=Y),Tt=St*B+At*k+Ct*U,Mt=Tt*B-St,Dt=Tt*k-At,Rt=Tt*U-Ct,0==(Tt=a.sqrt(Mt*Mt+Dt*Dt+Rt*Rt)))return;if(Tt=v/Tt,Mt*=Tt,Dt*=Tt,Rt*=Tt,St=ot+Mt,At=at+Dt,Ct=ht+Rt,Pt<-.96||Pt>.96)lt=B*B*1.5-.5,ct=B*k*1.5-.866025403*U,ut=B*U*1.5+.866025403*k,pt=k*B*1.5+.866025403*U,dt=k*k*1.5-.5,ft=k*U*1.5-.866025403*B,mt=U*B*1.5-.866025403*k,_t=U*k*1.5+.866025403*B,gt=U*U*1.5-.5,yt=St,vt=At,xt=Ct,bt=H*(yt-rt)+X*(vt-nt)+Y*(xt-st),St=yt-bt*H-rt,At=vt-bt*X-nt,Ct=xt-bt*Y-st,kt=Zt*St+Kt*At+qt*Ct,jt=Qt*St+Jt*At+$t*Ct,kt<-te?kt=-te:kt>te&&(kt=te),jt<-ee?jt=-ee:jt>ee&&(jt=ee),St=kt*Zt+jt*Qt,At=kt*Kt+jt*Jt,Ct=kt*qt+jt*$t,yt=rt+St,vt=nt+At,xt=st+Ct,i.addPoint(yt,vt,xt,H,X,Y,bt,this.flip),yt=Mt*lt+Dt*ct+Rt*ut,vt=Mt*pt+Dt*dt+Rt*ft,xt=Mt*mt+Dt*_t+Rt*gt,yt=(Mt=yt)+ot,vt=(Dt=vt)+at,xt=(Rt=xt)+ht,bt=H*(yt-rt)+X*(vt-nt)+Y*(xt-st),bt<=0&&(St=yt-bt*H-rt,At=vt-bt*X-nt,Ct=xt-bt*Y-st,kt=Zt*St+Kt*At+qt*Ct,jt=Qt*St+Jt*At+$t*Ct,kt<-te?kt=-te:kt>te&&(kt=te),jt<-ee?jt=-ee:jt>ee&&(jt=ee),St=kt*Zt+jt*Qt,At=kt*Kt+jt*Jt,Ct=kt*qt+jt*$t,yt=rt+St,vt=nt+At,xt=st+Ct,i.addPoint(yt,vt,xt,H,X,Y,bt,this.flip)),yt=Mt*lt+Dt*ct+Rt*ut,vt=Mt*pt+Dt*dt+Rt*ft,xt=Mt*mt+Dt*_t+Rt*gt,yt=(Mt=yt)+ot,vt=(Dt=vt)+at,xt=(Rt=xt)+ht,(bt=H*(yt-rt)+X*(vt-nt)+Y*(xt-st))<=0&&(St=yt-bt*H-rt,At=vt-bt*X-nt,Ct=xt-bt*Y-st,kt=Zt*St+Kt*At+qt*Ct,jt=Qt*St+Jt*At+$t*Ct,kt<-te?kt=-te:kt>te&&(kt=te),jt<-ee?jt=-ee:jt>ee&&(jt=ee),St=kt*Zt+jt*Qt,At=kt*Kt+jt*Jt,Ct=kt*qt+jt*$t,yt=rt+St,vt=nt+At,xt=st+Ct,i.addPoint(yt,vt,xt,H,X,Y,bt,this.flip));else{if(Nt=St,zt=At,Bt=Ct,kt=H*(Nt-rt)+X*(zt-nt)+Y*(Bt-st),Nt-=kt*H,zt-=kt*X,Bt-=kt*Y,Pt>0?(Ut=St+2*G,Gt=At+2*W,Wt=Ct+2*j):(Ut=St-2*G,Gt=At-2*W,Wt=Ct-2*j),jt=H*(Ut-rt)+X*(Gt-nt)+Y*(Wt-st),Ut-=jt*H,Gt-=jt*X,Wt-=jt*Y,It=Nt-rt,Ot=zt-nt,wt=Bt-st,Lt=Ut-rt,Ft=Gt-nt,Vt=Wt-st,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt,Z=It*Zt+Ot*Kt+wt*qt,K=Lt*Zt+Ft*Kt+Vt*qt,Ht=Z-te,Xt=K-te,Ht>0){if(Xt>0)return;Yt=Ht/(Ht-Xt),Nt+=St*Yt,zt+=At*Yt,Bt+=Ct*Yt,kt+=Et*Yt,It=Nt-rt,Ot=zt-nt,wt=Bt-st,Z=It*Zt+Ot*Kt+wt*qt,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt}else Xt>0&&(Yt=Ht/(Ht-Xt),Ut=Nt+St*Yt,Gt=zt+At*Yt,Wt=Bt+Ct*Yt,jt=kt+Et*Yt,Lt=Ut-rt,Ft=Gt-nt,Vt=Wt-st,K=Lt*Zt+Ft*Kt+Vt*qt,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt);if(Ht=Z+te,Xt=K+te,Ht<0){if(Xt<0)return;Yt=Ht/(Ht-Xt),Nt+=St*Yt,zt+=At*Yt,Bt+=Ct*Yt,kt+=Et*Yt,It=Nt-rt,Ot=zt-nt,wt=Bt-st,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt}else Xt<0&&(Yt=Ht/(Ht-Xt),Ut=Nt+St*Yt,Gt=zt+At*Yt,Wt=Bt+Ct*Yt,jt=kt+Et*Yt,Lt=Ut-rt,Ft=Gt-nt,Vt=Wt-st,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt);if(Z=It*Qt+Ot*Jt+wt*$t,K=Lt*Qt+Ft*Jt+Vt*$t,Ht=Z-ee,Xt=K-ee,Ht>0){if(Xt>0)return;Yt=Ht/(Ht-Xt),Nt+=St*Yt,zt+=At*Yt,Bt+=Ct*Yt,kt+=Et*Yt,It=Nt-rt,Ot=zt-nt,wt=Bt-st,Z=It*Qt+Ot*Jt+wt*$t,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt}else Xt>0&&(Yt=Ht/(Ht-Xt),Ut=Nt+St*Yt,Gt=zt+At*Yt,Wt=Bt+Ct*Yt,jt=kt+Et*Yt,Lt=Ut-rt,Ft=Gt-nt,Vt=Wt-st,K=Lt*Qt+Ft*Jt+Vt*$t,St=Ut-Nt,At=Gt-zt,Ct=Wt-Bt,Et=jt-kt);if(Ht=Z+ee,Xt=K+ee,Ht<0){if(Xt<0)return;Yt=Ht/(Ht-Xt),Nt+=St*Yt,zt+=At*Yt,Bt+=Ct*Yt,kt+=Et*Yt}else Xt<0&&(Yt=Ht/(Ht-Xt),Ut=Nt+St*Yt,Gt=zt+At*Yt,Wt=Bt+Ct*Yt,jt=kt+Et*Yt);kt<0&&i.addPoint(Nt,zt,Bt,H,X,Y,kt,this.flip),jt<0&&i.addPoint(Ut,Gt,Wt,H,X,Y,jt,this.flip)}}}},a.CylinderCylinderCollisionDetector=function(){a.CollisionDetector.call(this)},a.CylinderCylinderCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.CylinderCylinderCollisionDetector.prototype.constructor=a.CylinderCylinderCollisionDetector,a.CylinderCylinderCollisionDetector.prototype.getSep=function(t,e,i,r,n){var s,o,h,l,c,u,p,d,f,m,_,g,y,v=new a.Vec3,x=t.position.x,b=t.position.y,P=t.position.z,T=e.position.x,S=e.position.y,A=e.position.z,C=T-x,E=S-b,M=A-P;C*C+E*E+M*M==0&&(E=.001);var D=-C,R=-E,I=-M;this.supportPoint(t,-D,-R,-I,v);var O=v.x,w=v.y,L=v.z;this.supportPoint(e,D,R,I,v);var F=v.x,V=v.y,N=v.z,z=F-O,B=V-w,k=N-L;if(z*D+B*R+k*I<=0)return!1;if(D=B*M-k*E,R=k*C-z*M,I=z*E-B*C,D*D+R*R+I*I==0)return i.init(z-C,B-E,k-M),i.normalize(i),r.init(.5*(O+F),.5*(w+V),.5*(L+N)),!0;this.supportPoint(t,-D,-R,-I,v);var U=v.x,G=v.y,W=v.z;this.supportPoint(e,D,R,I,v);var j=v.x,H=v.y,X=v.z,Y=j-U,Z=H-G,K=X-W;if(Y*D+Z*R+K*I<=0)return!1;s=z-C,o=B-E,h=k-M,l=Y-C,c=Z-E,u=K-M,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l,D*C+R*E+I*M>0&&(s=z,o=B,h=k,z=Y,B=Z,k=K,Y=s,Z=o,K=h,s=O,o=w,h=L,O=U,w=G,L=W,U=s,G=o,W=h,s=F,o=V,h=N,F=j,V=H,N=X,j=s,H=o,X=h,D=-D,R=-R,I=-I);for(var q=0;;){if(++q>100)return!1;this.supportPoint(t,-D,-R,-I,v);var Q=v.x,J=v.y,$=v.z;this.supportPoint(e,D,R,I,v);var tt=v.x,et=v.y,it=v.z,rt=tt-Q,nt=et-J,st=it-$;if(rt*D+nt*R+st*I<=0)return!1;if((B*st-k*nt)*C+(k*rt-z*st)*E+(z*nt-B*rt)*M<0)Y=rt,Z=nt,K=st,U=Q,G=J,W=$,j=tt,H=et,X=it,s=z-C,o=B-E,h=k-M,l=rt-C,c=nt-E,u=st-M,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l;else if((nt*K-st*Z)*C+(st*Y-rt*K)*E+(rt*Z-nt*Y)*M<0)z=rt,B=nt,k=st,O=Q,w=J,L=$,F=tt,V=et,N=it,s=rt-C,o=nt-E,h=st-M,l=Y-C,c=Z-E,u=K-M,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l;else for(var ot=!1;;){if(s=Y-z,o=Z-B,h=K-k,l=rt-z,c=nt-B,u=st-k,D=o*u-h*c,R=h*l-s*u,I=s*c-o*l,p=1/a.sqrt(D*D+R*R+I*I),D*=p,R*=p,I*=p,D*z+R*B+I*k>=0&&!ot){var at=(B*K-k*Z)*rt+(k*Y-z*K)*nt+(z*Z-B*Y)*st,ht=(nt*K-st*Z)*C+(st*Y-rt*K)*E+(rt*Z-nt*Y)*M,lt=(E*k-M*B)*rt+(M*z-C*k)*nt+(C*B-E*z)*st,ct=(Z*k-K*B)*C+(K*z-Y*k)*E+(Y*B-Z*z)*M,ut=at+ht+lt+ct;ut<=0&&(at=0,ht=(Z*st-K*nt)*D+(K*rt-Y*st)*R+(Y*nt-Z*rt)*I,lt=(nt*K-st*Z)*D+(st*Y-rt*K)*R+(rt*Z-nt*Y)*I,ct=(B*K-k*Z)*D+(k*Y-z*K)*R+(z*Z-B*Y)*I,ut=ht+lt+ct);var pt=1/ut;d=(x*at+O*ht+U*lt+Q*ct)*pt,f=(b*at+w*ht+G*lt+J*ct)*pt,m=(P*at+L*ht+W*lt+$*ct)*pt,_=(T*at+F*ht+j*lt+tt*ct)*pt,g=(S*at+V*ht+H*lt+et*ct)*pt,y=(A*at+N*ht+X*lt+it*ct)*pt,ot=!0}this.supportPoint(t,-D,-R,-I,v);var dt=v.x,ft=v.y,mt=v.z;this.supportPoint(e,D,R,I,v);var _t=v.x,gt=v.y,yt=v.z,vt=_t-dt,xt=gt-ft,bt=yt-mt,Pt=-(vt*D+xt*R+bt*I);if((vt-rt)*D+(xt-nt)*R+(bt-st)*I<=.01||Pt>=0)return!!ot&&(i.init(-D,-R,-I),r.init(.5*(d+_),.5*(f+g),.5*(m+y)),n.x=Pt,!0);(xt*k-bt*B)*C+(bt*z-vt*k)*E+(vt*B-xt*z)*M<0?(xt*K-bt*Z)*C+(bt*Y-vt*K)*E+(vt*Z-xt*Y)*M<0?(z=vt,B=xt,k=bt,O=dt,w=ft,L=mt,F=_t,V=gt,N=yt):(rt=vt,nt=xt,st=bt,Q=dt,J=ft,$=mt,tt=_t,et=gt,it=yt):(xt*st-bt*nt)*C+(bt*rt-vt*st)*E+(vt*nt-xt*rt)*M<0?(Y=vt,Z=xt,K=bt,U=dt,G=ft,W=mt,j=_t,H=gt,X=yt):(z=vt,B=xt,k=bt,O=dt,w=ft,L=mt,F=_t,V=gt,N=yt)}}},a.CylinderCylinderCollisionDetector.prototype.supportPoint=function(t,e,i,r,n){var s,o,h,l=t.rotation.elements,c=l[0]*e+l[3]*i+l[6]*r,u=l[1]*e+l[4]*i+l[7]*r,p=l[2]*e+l[5]*i+l[8]*r,d=c,f=p,m=d*d+f*f,_=t.radius,g=t.halfHeight;0==m?u<0?(s=_,o=-g,h=0):(s=_,o=g,h=0):(m=t.radius/a.sqrt(m),u<0?(s=d*m,o=-g,h=f*m):(s=d*m,o=g,h=f*m)),c=l[0]*s+l[1]*o+l[2]*h+t.position.x,u=l[3]*s+l[4]*o+l[5]*h+t.position.y,p=l[6]*s+l[7]*o+l[8]*h+t.position.z,n.init(c,u,p)},a.CylinderCylinderCollisionDetector.prototype.detectCollision=function(t,e,i){var r,n;t.id<e.id?(r=t,n=e):(r=e,n=t);var s,o,h,l,c,u,p,d,f,m,_,g,y,v,x,b,P,T,S,A,C,E=r.position,M=n.position,D=E.x,R=E.y,I=E.z,O=M.x,w=M.y,L=M.z,F=r.halfHeight,V=n.halfHeight,N=r.normalDirection,z=n.normalDirection,B=r.halfDirection,k=n.halfDirection,U=r.radius,G=n.radius,W=N.x,j=N.y,H=N.z,X=z.x,Y=z.y,Z=z.z,K=B.x,q=B.y,Q=B.z,J=k.x,$=k.y,tt=k.z,et=D-O,it=R-w,rt=I-L,nt=new a.Vec3,st=new a.Vec3,ot=new a.Vec3;if(this.getSep(r,n,nt,st,ot)){var at=nt.x*W+nt.y*j+nt.z*H,ht=nt.x*X+nt.y*Y+nt.z*Z,lt=at>0,ct=ht>0;lt||(at=-at),ct||(ht=-ht);var ut=0;(at>.999||ht>.999)&&(ut=at>ht?1:2);var pt,dt,ft,mt,_t,gt,yt,vt,xt,bt,Pt,Tt,St,At,Ct,Et,Mt,Dt,Rt,It,Ot=ot.x;switch(pt=nt.x,dt=nt.y,ft=nt.z,ut){case 0:i.addPoint(st.x,st.y,st.z,pt,dt,ft,Ot,!1);break;case 1:if(lt?(o=D+K,h=R+q,l=I+Q,pt=W,dt=j,ft=H):(o=D-K,h=R-q,l=I-Q,pt=-W,dt=-j,ft=-H),S=pt*X+dt*Y+ft*Z,s=S<0?V:-V,c=O+s*X,u=w+s*Y,p=L+s*Z,ht>=.999999?(d=-dt,f=ft,m=pt):(d=pt,f=dt,m=ft),s=d*X+f*Y+m*Z,et=s*X-d,it=s*Y-f,rt=s*Z-m,0==(s=a.sqrt(et*et+it*it+rt*rt)))break;if(s=G/s,et*=s,it*=s,rt*=s,d=c+et,f=u+it,m=p+rt,S<-.96||S>.96)mt=X*X*1.5-.5,_t=X*Y*1.5-.866025403*Z,gt=X*Z*1.5+.866025403*Y,yt=Y*X*1.5+.866025403*Z,vt=Y*Y*1.5-.5,xt=Y*Z*1.5-.866025403*X,bt=Z*X*1.5-.866025403*Y,Pt=Z*Y*1.5+.866025403*X,Tt=Z*Z*1.5-.5,St=d,At=f,Ct=m,Et=pt*(St-o)+dt*(At-h)+ft*(Ct-l),d=St-Et*pt-o,f=At-Et*dt-h,m=Ct-Et*ft-l,s=d*d+f*f+m*m,s>U*U&&(s=U/a.sqrt(s),d*=s,f*=s,m*=s),St=o+d,At=h+f,Ct=l+m,i.addPoint(St,At,Ct,pt,dt,ft,Et,!1),St=et*mt+it*_t+rt*gt,At=et*yt+it*vt+rt*xt,Ct=et*bt+it*Pt+rt*Tt,St=(et=St)+c,At=(it=At)+u,Ct=(rt=Ct)+p,Et=pt*(St-o)+dt*(At-h)+ft*(Ct-l),Et<=0&&(d=St-Et*pt-o,f=At-Et*dt-h,m=Ct-Et*ft-l,s=d*d+f*f+m*m,s>U*U&&(s=U/a.sqrt(s),d*=s,f*=s,m*=s),St=o+d,At=h+f,Ct=l+m,i.addPoint(St,At,Ct,pt,dt,ft,Et,!1)),St=et*mt+it*_t+rt*gt,At=et*yt+it*vt+rt*xt,Ct=et*bt+it*Pt+rt*Tt,St=(et=St)+c,At=(it=At)+u,Ct=(rt=Ct)+p,(Et=pt*(St-o)+dt*(At-h)+ft*(Ct-l))<=0&&(d=St-Et*pt-o,f=At-Et*dt-h,m=Ct-Et*ft-l,s=d*d+f*f+m*m,s>U*U&&(s=U/a.sqrt(s),d*=s,f*=s,m*=s),St=o+d,At=h+f,Ct=l+m,i.addPoint(St,At,Ct,pt,dt,ft,Et,!1));else{if(_=d,g=f,y=m,P=pt*(_-o)+dt*(g-h)+ft*(y-l),_-=P*pt,g-=P*dt,y-=P*ft,S>0?(v=d+X*V*2,x=f+Y*V*2,b=m+Z*V*2):(v=d-X*V*2,x=f-Y*V*2,b=m-Z*V*2),T=pt*(v-o)+dt*(x-h)+ft*(b-l),v-=T*pt,x-=T*dt,b-=T*ft,et=o-_,it=h-g,rt=l-y,d=v-_,f=x-g,m=b-y,Mt=et*et+it*it+rt*rt,Dt=et*d+it*f+rt*m,Rt=d*d+f*f+m*m,(It=Dt*Dt-Rt*(Mt-U*U))<0)break;It=a.sqrt(It),A=(Dt+It)/Rt,C=(Dt-It)/Rt,C<A&&(s=A,A=C,C=s),C>1&&(C=1),A<0&&(A=0),d=_+(v-_)*A,f=g+(x-g)*A,m=y+(b-y)*A,v=_+(v-_)*C,x=g+(x-g)*C,b=y+(b-y)*C,_=d,g=f,y=m,s=P+(T-P)*A,T=P+(T-P)*C,P=s,P<0&&i.addPoint(_,g,y,pt,dt,ft,Et,!1),T<0&&i.addPoint(v,x,b,pt,dt,ft,Et,!1)}break;case 2:if(ct?(c=O-J,u=w-$,p=L-tt,pt=-X,dt=-Y,ft=-Z):(c=O+J,u=w+$,p=L+tt,pt=X,dt=Y,ft=Z),S=pt*W+dt*j+ft*H,s=S<0?F:-F,o=D+s*W,h=R+s*j,l=I+s*H,at>=.999999?(d=-dt,f=ft,m=pt):(d=pt,f=dt,m=ft),s=d*W+f*j+m*H,et=s*W-d,it=s*j-f,rt=s*H-m,0==(s=a.sqrt(et*et+it*it+rt*rt)))break;if(s=U/s,et*=s,it*=s,rt*=s,d=o+et,f=h+it,m=l+rt,S<-.96||S>.96)mt=W*W*1.5-.5,_t=W*j*1.5-.866025403*H,gt=W*H*1.5+.866025403*j,yt=j*W*1.5+.866025403*H,vt=j*j*1.5-.5,xt=j*H*1.5-.866025403*W,bt=H*W*1.5-.866025403*j,Pt=H*j*1.5+.866025403*W,Tt=H*H*1.5-.5,St=d,At=f,Ct=m,Et=pt*(St-c)+dt*(At-u)+ft*(Ct-p),d=St-Et*pt-c,f=At-Et*dt-u,m=Ct-Et*ft-p,s=d*d+f*f+m*m,s>G*G&&(s=G/a.sqrt(s),d*=s,f*=s,m*=s),St=c+d,At=u+f,Ct=p+m,i.addPoint(St,At,Ct,-pt,-dt,-ft,Et,!1),St=et*mt+it*_t+rt*gt,At=et*yt+it*vt+rt*xt,Ct=et*bt+it*Pt+rt*Tt,St=(et=St)+o,At=(it=At)+h,Ct=(rt=Ct)+l,Et=pt*(St-c)+dt*(At-u)+ft*(Ct-p),Et<=0&&(d=St-Et*pt-c,f=At-Et*dt-u,m=Ct-Et*ft-p,s=d*d+f*f+m*m,s>G*G&&(s=G/a.sqrt(s),d*=s,f*=s,m*=s),St=c+d,At=u+f,Ct=p+m,i.addPoint(St,At,Ct,-pt,-dt,-ft,Et,!1)),St=et*mt+it*_t+rt*gt,At=et*yt+it*vt+rt*xt,Ct=et*bt+it*Pt+rt*Tt,St=(et=St)+o,At=(it=At)+h,Ct=(rt=Ct)+l,(Et=pt*(St-c)+dt*(At-u)+ft*(Ct-p))<=0&&(d=St-Et*pt-c,f=At-Et*dt-u,m=Ct-Et*ft-p,s=d*d+f*f+m*m,s>G*G&&(s=G/a.sqrt(s),d*=s,f*=s,m*=s),St=c+d,At=u+f,Ct=p+m,i.addPoint(St,At,Ct,-pt,-dt,-ft,Et,!1));else{if(_=d,g=f,y=m,P=pt*(_-c)+dt*(g-u)+ft*(y-p),_-=P*pt,g-=P*dt,y-=P*ft,S>0?(v=d+W*F*2,x=f+j*F*2,b=m+H*F*2):(v=d-W*F*2,x=f-j*F*2,b=m-H*F*2),T=pt*(v-c)+dt*(x-u)+ft*(b-p),v-=T*pt,x-=T*dt,b-=T*ft,et=c-_,it=u-g,rt=p-y,d=v-_,f=x-g,m=b-y,Mt=et*et+it*it+rt*rt,Dt=et*d+it*f+rt*m,Rt=d*d+f*f+m*m,(It=Dt*Dt-Rt*(Mt-G*G))<0)break;It=a.sqrt(It),A=(Dt+It)/Rt,C=(Dt-It)/Rt,C<A&&(s=A,A=C,C=s),C>1&&(C=1),A<0&&(A=0),d=_+(v-_)*A,f=g+(x-g)*A,m=y+(b-y)*A,v=_+(v-_)*C,x=g+(x-g)*C,b=y+(b-y)*C,_=d,g=f,y=m,s=P+(T-P)*A,T=P+(T-P)*C,P=s,P<0&&i.addPoint(_,g,y,-pt,-dt,-ft,P,!1),T<0&&i.addPoint(v,x,b,-pt,-dt,-ft,T,!1)}}}},a.SphereCylinderCollisionDetector=function(t){a.CollisionDetector.call(this),this.flip=t},a.SphereCylinderCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.SphereCylinderCollisionDetector.prototype.constructor=a.SphereCylinderCollisionDetector,a.SphereCylinderCollisionDetector.prototype.detectCollision=function(t,e,i){var r,n;this.flip?(r=e,n=t):(r=t,n=e);var s=r.position,o=s.x,h=s.y,l=s.z,c=n.position,u=c.x,p=c.y,d=c.z,f=n.normalDirection.x,m=n.normalDirection.y,_=n.normalDirection.z,g=r.radius,y=n.radius,v=g+y,x=n.halfHeight,b=o-u,P=h-p,T=l-d,S=b*f+P*m+T*_;if(!(S<-x-g||S>x+g)){var A=u+S*f,C=p+S*m,E=d+S*_,M=o-A,D=h-C,R=l-E,I=M*M+D*D+R*R;if(!(I>v*v)){I>y*y&&(I=y/a.sqrt(I),M*=I,D*=I,R*=I),S<-x?S=-x:S>x&&(S=x),A=u+S*f+M,C=p+S*m+D,E=d+S*_+R,b=A-o,P=C-h,T=E-l,I=b*b+P*P+T*T;var O;I>0&&I<g*g&&(I=a.sqrt(I),O=1/I,b*=O,P*=O,T*=O,i.addPoint(o+b*g,h+P*g,l+T*g,b,P,T,I-g,this.flip))}}},a.TetraTetraCollisionDetector=function(){a.CollisionDetector.call(this)},a.TetraTetraCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.TetraTetraCollisionDetector.prototype.constructor=a.TetraTetraCollisionDetector,a.TetraTetraCollisionDetector.prototype.detectCollision=function(t,e,i){var r,o,a,h,l,c,u=t.faces,p=t.verts,d=(e.faces,e.verts),f=0,m=u;for(r=0;r<4;r++)for(a=p[r],o=0;o<4;o++)h=d[m[r].a],l=d[m[r].b],c=d[m[r].c],n(s(a.x,a.y),s(h.x,h.y),s(l.x,l.y),s(c.x,c.y))&&n(s(a.x,a.z),s(h.x,h.z),s(l.x,l.z),s(c.x,c.z))&&n(s(a.z,a.y),s(h.z,h.y),s(l.z,l.y),s(c.z,c.y))&&f++,4===f&&i.addPoint(a)},a.AABB=function(t,e,i,r,n,s){this.elements=new o(6);var a=this.elements;a[0]=t||0,a[1]=i||0,a[2]=n||0,a[3]=e||0,a[4]=r||0,a[5]=s||0},a.AABB.prototype={constructor:a.AABB,set:function(t,e,i,r,n,s){var o=this.elements;return o[0]=t,o[3]=e,o[1]=i,o[4]=r,o[2]=n,o[5]=s,this},intersectTest:function(t){var e=this.elements,i=t.elements;return e[0]>i[3]||e[1]>i[4]||e[2]>i[5]||e[3]<i[0]||e[4]<i[1]||e[5]<i[2]},intersectTestTwo:function(t){var e=this.elements,i=t.elements;return e[0]<i[0]||e[1]<i[1]||e[2]<i[2]||e[3]>i[3]||e[4]>i[4]||e[5]>i[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,e){var i=e||0,r=t.elements;return this.set(r[0]-i,r[3]+i,r[1]-i,r[4]+i,r[2]-i,r[5]+i),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,e){var i=t.elements,r=e.elements,n=this.elements;return n[0]=i[0]<r[0]?i[0]:r[0],n[1]=i[1]<r[1]?i[1]:r[1],n[2]=i[2]<r[2]?i[2]:r[2],n[3]=i[3]>r[3]?i[3]:r[3],n[4]=i[4]>r[4]?i[4]:r[4],n[5]=i[5]>r[5]?i[5]:r[5],this},surfaceArea:function(){var t=this.elements,e=t[3]-t[0],i=t[4]-t[1],r=t[5]-t[2];return 2*(e*(i+r)+i*r)},intersectsWithPoint:function(t,e,i){var r=this.elements;return t>=r[0]&&t<=r[3]&&e>=r[1]&&e<=r[4]&&i>=r[2]&&i<=r[5]},setFromPoints:function(t){this.makeEmpty();for(var e=0;e<t.length;e++)this.expandByPoint(t[e])},makeEmpty:function(){this.set(-(1/0),-(1/0),-(1/0),1/0,1/0,1/0)},expandByPoint:function(t){var e=this.elements;this.set(a.min(e[0],t.x),a.min(e[1],t.y),a.min(e[2],t.z),a.max(e[3],t.x),a.max(e[4],t.y),a.max(e[5],t.z))}},a.Proxy=function(t){this.shape=t,this.aabb=t.aabb},a.Proxy.prototype={constructor:a.Proxy,update:function(){a.Error("Proxy","Inheritance error.")}},a.BasicProxy=function(t){a.Proxy.call(this,t),this.id=a.proxyID++},a.BasicProxy.prototype=Object.create(a.Proxy.prototype),a.BasicProxy.prototype.constructor=a.BasicProxy,a.BasicProxy.prototype.update=function(){},a.BroadPhase=function(){this.types=a.BR_NULL,this.numPairChecks=0,this.numPairs=0,this.pairs=[]},a.BroadPhase.prototype={constructor:a.BroadPhase,createProxy:function(t){a.Error("BroadPhase","Inheritance error.")},addProxy:function(t){a.Error("BroadPhase","Inheritance error.")},removeProxy:function(t){a.Error("BroadPhase","Inheritance error.")},isAvailablePair:function(t,e){var i=t.parent,r=e.parent;if(i==r||!i.isDynamic&&!r.isDynamic||0==(t.belongsTo&e.collidesWith)||0==(e.belongsTo&t.collidesWith))return!1;var n;for(n=i.numJoints<r.numJoints?i.jointLink:r.jointLink;null!==n;){var s=n.joint;if(!s.allowCollision&&(s.body1==i&&s.body2==r||s.body1==r&&s.body2==i))return!1;n=n.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){a.Error("BroadPhase","Inheritance error.")},addPair:function(t,e){var i=new a.Pair(t,e);this.pairs.push(i),this.numPairs++}},a.BruteForceBroadPhase=function(){a.BroadPhase.call(this),this.types=a.BR_BRUTE_FORCE,this.proxies=[]},a.BruteForceBroadPhase.prototype=Object.create(a.BroadPhase.prototype),a.BruteForceBroadPhase.prototype.constructor=a.BruteForceBroadPhase,a.BruteForceBroadPhase.prototype.createProxy=function(t){return new a.BasicProxy(t)},a.BruteForceBroadPhase.prototype.addProxy=function(t){this.proxies.push(t)},a.BruteForceBroadPhase.prototype.removeProxy=function(t){var e=this.proxies.indexOf(t);e>-1&&this.proxies.splice(e,1)},a.BruteForceBroadPhase.prototype.collectPairs=function(){var t,e,i,r=0,n=this.proxies,s=n.length;for(this.numPairChecks=s*(s-1)>>1;r<s;)for(e=n[r++],t=r+1;t<s;)i=n[t++],!e.aabb.intersectTest(i.aabb)&&this.isAvailablePair(e.shape,i.shape)&&this.addPair(e.shape,i.shape)},a.Pair=function(t,e){this.shape1=t||null,this.shape2=e||null},a.SAPAxis=function(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new o(64)},a.SAPAxis.prototype={constructor:a.SAPAxis,addElements:function(t,e){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var i=[],r=this.numElements;r--;)i[r]=this.elements[r]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=e},removeElements:function(t,e){for(var i=-1,r=-1,n=0,s=this.numElements;n<s;n++){var o=this.elements[n];if(o==t||o==e){if(i!=-1){r=n;break}i=n}}for(n=i+1,s=r;n<s;n++)this.elements[n-1]=this.elements[n];for(n=r+1,s=this.numElements;n<s;n++)this.elements[n-2]=this.elements[n];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,e=1;this.numElements>>e!=0;)e++;e=e*this.numElements>>2,t=0;for(var i=!1,r=this.elements,n=1,s=this.numElements;n<s;n++){var o=r[n],h=o.value,l=r[n-1];if(l.value>h){var c=n;do{if(r[c]=l,0==--c)break;l=r[c-1]}while(l.value>h);if(r[c]=o,(t+=n-c)>e){i=!0;break}}}if(i){t=2;var u=this.stack;for(u[0]=0,u[1]=this.numElements-1;t>0;){var p=u[--t],d=u[--t],f=p-d;if(f>16){var m=d+a.floor(.5*f);for(o=r[m],r[m]=r[p],r[p]=o,h=o.value,n=d-1,c=p;;){var _,g;do{_=r[++n]}while(_.value<h);do{g=r[--c]}while(h<g.value&&c!=d);if(n>=c)break;r[n]=g,r[c]=_}r[p]=r[n],r[n]=o,n-d>p-n?(u[t++]=d,u[t++]=n-1,u[t++]=n+1,u[t++]=p):(u[t++]=n+1,u[t++]=p,u[t++]=d,u[t++]=n-1)}else for(n=d+1;n<=p;n++)if(o=r[n],h=o.value,l=r[n-1],l.value>h){c=n;do{if(r[c]=l,0==--c)break;l=r[c-1]}while(l.value>h);r[c]=o}}}},calculateTestCount:function(){for(var t=1,e=0,i=1,r=this.numElements;i<r;i++)this.elements[i].max?t--:(e+=t,t++);return e}},a.SAPBroadPhase=function(){a.BroadPhase.call(this),this.types=a.BR_SWEEP_AND_PRUNE,this.numElementsD=0,this.numElementsS=0,this.axesD=[new a.SAPAxis,new a.SAPAxis,new a.SAPAxis],this.axesS=[new a.SAPAxis,new a.SAPAxis,new a.SAPAxis],this.index1=0,this.index2=1},a.SAPBroadPhase.prototype=Object.create(a.BroadPhase.prototype);a.SAPBroadPhase.prototype.constructor=a.SAPBroadPhase,a.SAPBroadPhase.prototype.createProxy=function(t){return new a.SAPProxy(this,t)},a.SAPBroadPhase.prototype.addProxy=function(t){var e=t;e.isDynamic()?(this.axesD[0].addElements(e.min[0],e.max[0]),this.axesD[1].addElements(e.min[1],e.max[1]),this.axesD[2].addElements(e.min[2],e.max[2]),e.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(e.min[0],e.max[0]),this.axesS[1].addElements(e.min[1],e.max[1]),this.axesS[2].addElements(e.min[2],e.max[2]),e.belongsTo=2,this.numElementsS+=2)},a.SAPBroadPhase.prototype.removeProxy=function(t){var e=t;if(0!=e.belongsTo){switch(e.belongsTo){case 1:this.axesD[0].removeElements(e.min[0],e.max[0]),this.axesD[1].removeElements(e.min[1],e.max[1]),this.axesD[2].removeElements(e.min[2],e.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(e.min[0],e.max[0]),this.axesS[1].removeElements(e.min[1],e.max[1]),this.axesS[2].removeElements(e.min[2],e.max[2]),this.numElementsS-=2}e.belongsTo=0}},a.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var t=this.axesD[this.index1],e=this.axesD[this.index2];t.sort(),e.sort();var i,r,n=t.calculateTestCount(),s=e.calculateTestCount();n<=s?(e=this.axesS[this.index1],e.sort(),i=t.elements,r=e.elements):(t=this.axesS[this.index2],t.sort(),i=e.elements,r=t.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var o,a,h=0,l=0;h<this.numElementsD;){var c,u;if(l==this.numElementsS)c=i[h],u=!0,h++;else{var p=i[h],d=r[l];p.value<d.value?(c=p,u=!0,h++):(c=d,u=!1,l++)}if(c.max){var f=c.pair;if(u){if(f==o){o=o.pair;continue}c=o}else{if(f==a){a=a.pair;continue}c=a}do{if((x=c.pair)==f){c.pair=x.pair;break}c=x}while(null!=c)}else{for(var m=c.proxy.shape,_=c.min1.value,g=c.max1.value,y=c.min2.value,v=c.max2.value,x=o;null!=x;x=x.pair){var b=x.proxy.shape;this.numPairChecks++,_>x.max1.value||g<x.min1.value||y>x.max2.value||v<x.min2.value||!this.isAvailablePair(m,b)||this.addPair(m,b)}if(u){for(x=a;null!=x;x=x.pair)b=x.proxy.shape,this.numPairChecks++,_>x.max1.value||g<x.min1.value||y>x.max2.value||v<x.min2.value||!this.isAvailablePair(m,b)||this.addPair(m,b);c.pair=o,o=c}else c.pair=a,a=c}}this.index2=3^(this.index1|this.index2)}},a.SAPElement=function(t,e){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=e,this.value=0},a.SAPProxy=function(t,e){a.Proxy.call(this,e),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new a.SAPElement(this,!1),this.max[0]=new a.SAPElement(this,!0),this.min[1]=new a.SAPElement(this,!1),this.max[1]=new a.SAPElement(this,!0),this.min[2]=new a.SAPElement(this,!1),this.max[2]=new a.SAPElement(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]},a.SAPProxy.prototype=Object.create(a.Proxy.prototype),a.SAPProxy.prototype.constructor=a.SAPProxy,a.SAPProxy.prototype.isDynamic=function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},a.SAPProxy.prototype.update=function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},a.DBVT=function(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new a.AABB},a.DBVT.prototype={constructor:a.DBVT,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null==this.root)return void(this.root=t);for(var e,i,r=t.aabb,n=this.root;null==n.proxy;){var s=n.child1,o=n.child2,h=n.aabb,l=s.aabb,c=o.aabb;e=h.surfaceArea(),this.aabb.combine(r,h),i=this.aabb.surfaceArea();var u=2*i,p=2*(i-e),d=p;this.aabb.combine(r,l),d+=null!=s.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea();var f=p;if(this.aabb.combine(r,c),f+=null!=o.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-c.surfaceArea(),d<f){if(u<d)break;n=s}else{if(u<f)break;n=o}}var m,_=n.parent;m=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new a.DBVTNode,m.parent=_,m.child1=t,m.child2=n,m.aabb.combine(t.aabb,n.aabb),m.height=n.height+1,n.parent=m,t.parent=m,n==this.root?this.root=m:_.child1==n?_.child1=m:_.child2=m;do{m=this.balance(m),this.fix(m),m=m.parent}while(null!=m)},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t==this.root)return void(this.root=null);var e,i=t.parent;if(e=i.child1==t?i.child2:i.child1,i==this.root)return this.root=e,void(e.parent=null);var r=i.parent;e.parent=r,r.child1==i?r.child1=e:r.child2=e,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=i);do{r=this.balance(r),this.fix(r),r=r.parent}while(null!=r)},balance:function t(e){var i=e.height;if(i<2)return e;var r,n=e.parent,s=e.child1,o=e.child2,a=s.height,h=o.height,t=a-h;if(t>1){var l=s.child1,c=s.child2,u=l.height,p=c.height;return u>p?(s.child2=e,e.parent=s,e.child1=c,c.parent=e,e.aabb.combine(c.aabb,o.aabb),r=p-h,e.height=p-(r&r>>31)+1,s.aabb.combine(l.aabb,e.aabb),r=u-i,s.height=u-(r&r>>31)+1):(s.child1=e,e.parent=s,e.child1=l,l.parent=e,e.aabb.combine(l.aabb,o.aabb),r=u-h,e.height=u-(r&r>>31)+1,s.aabb.combine(e.aabb,c.aabb),r=i-p,s.height=i-(r&r>>31)+1),null!=n?n.child1==e?n.child1=s:n.child2=s:this.root=s,s.parent=n,s}if(t<-1){var d=o.child1,f=o.child2,m=d.height,_=f.height;return m>_?(o.child2=e,e.parent=o,e.child2=f,f.parent=e,e.aabb.combine(s.aabb,f.aabb),r=a-_,e.height=a-(r&r>>31)+1,o.aabb.combine(d.aabb,e.aabb),r=m-i,o.height=m-(r&r>>31)+1):(o.child1=e,e.parent=o,e.child2=d,d.parent=e,e.aabb.combine(s.aabb,d.aabb),r=a-m,e.height=a-(r&r>>31)+1,o.aabb.combine(e.aabb,f.aabb),r=i-_,o.height=i-(r&r>>31)+1),null!=n?n.child1==e?n.child1=o:n.child2=o:this.root=o,o.parent=n,o}return e},fix:function(t){var e=t.child1,i=t.child2;t.aabb.combine(e.aabb,i.aabb),t.height=e.height<i.height?i.height+1:e.height+1}},a.DBVTBroadPhase=function(){a.BroadPhase.call(this),this.types=a.BR_BOUNDING_VOLUME_TREE,this.tree=new a.DBVT,this.stack=[],this.leaves=[],this.numLeaves=0},a.DBVTBroadPhase.prototype=Object.create(a.BroadPhase.prototype),a.DBVTBroadPhase.prototype.constructor=a.DBVTBroadPhase,a.DBVTBroadPhase.prototype.createProxy=function(t){return new a.DBVTProxy(t)},a.DBVTBroadPhase.prototype.addProxy=function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},a.DBVTBroadPhase.prototype.removeProxy=function(t){this.tree.deleteLeaf(t.leaf);var e=this.leaves.indexOf(t.leaf);e>-1&&(this.leaves.splice(e,1),this.numLeaves--)},a.DBVTBroadPhase.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var t,e=.1,i=this.numLeaves;i--;)t=this.leaves[i],t.proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,e),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},a.DBVTBroadPhase.prototype.collide=function(t,e){var i,r,n,s,o,a,h=2;for(this.stack[0]=t,this.stack[1]=e;h>0;)if(n=this.stack[--h],s=this.stack[--h],o=null!=n.proxy,a=null!=s.proxy,this.numPairChecks++,o&&a){if(i=n.proxy.shape,r=s.proxy.shape,i==r||i.aabb.intersectTest(r.aabb)||!this.isAvailablePair(i,r))continue;this.addPair(i,r)}else{if(n.aabb.intersectTest(s.aabb))continue;a||!o&&n.aabb.surfaceArea()>s.aabb.surfaceArea()?(this.stack[h++]=n.child1,this.stack[h++]=s,this.stack[h++]=n.child2,this.stack[h++]=s):(this.stack[h++]=n,this.stack[h++]=s.child1,this.stack[h++]=n,this.stack[h++]=s.child2)}},a.DBVTNode=function(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new a.AABB},a.DBVTProxy=function(t){a.Proxy.call(this,t),this.leaf=new a.DBVTNode,this.leaf.proxy=this},a.DBVTProxy.prototype=Object.create(a.Proxy.prototype),a.DBVTProxy.prototype.constructor=a.DBVTProxy,a.DBVTProxy.prototype.update=function(){},a.World.prototype.add=function(t){t=t||{};var e=t.type||"box";if("string"==typeof e&&(e=[e]),"joint"==e[0].substring(0,5)){"joint"===e[0]&&(e[0]="jointHinge");var i=t.axe1||[1,0,0],r=t.axe2||[1,0,0],n=t.pos1||[0,0,0],s=t.pos2||[0,0,0];n=n.map(function(t){return t*a.INV_SCALE}),s=s.map(function(t){return t*a.INV_SCALE});var o,h;"jointDistance"===e[0]?(o=t.min||0,h=t.max||10,o*=a.INV_SCALE,h*=a.INV_SCALE):(o=t.min||57.29578,h=t.max||0,o*=a.degtorad,h*=a.degtorad);var l=t.limit||null,c=t.spring||null,u=t.motor||null,p=new a.JointConfig;p.allowCollision=t.collision||!1,p.localAxis1.init(i[0],i[1],i[2]),p.localAxis2.init(r[0],r[1],r[2]),p.localAnchorPoint1.init(n[0],n[1],n[2]),p.localAnchorPoint2.init(s[0],s[1],s[2]),("string"==typeof t.body1||t.body1 instanceof String)&&(t.body1=this.getByName(t.body1)),("string"==typeof t.body2||t.body2 instanceof String)&&(t.body2=this.getByName(t.body2)),p.body1=t.body1,p.body2=t.body2;var d;switch(e[0]){case"jointDistance":d=new a.DistanceJoint(p,o,h),null!==c&&d.limitMotor.setSpring(c[0],c[1]),null!==u&&d.limitMotor.setSpring(u[0],u[1]);break;case"jointHinge":d=new a.HingeJoint(p,o,h),null!==c&&d.limitMotor.setSpring(c[0],c[1]),null!==u&&d.limitMotor.setSpring(u[0],u[1]);break;case"jointPrisme":d=new a.PrismaticJoint(p,o,h);break;case"jointSlide":d=new a.SliderJoint(p,o,h);break;case"jointBall":d=new a.BallAndSocketJoint(p);break;case"jointWheel":d=new a.WheelJoint(p),null!==l&&d.rotationalLimitMotor1.setLimit(l[0],l[1]),null!==c&&d.rotationalLimitMotor1.setSpring(c[0],c[1]),null!==u&&d.rotationalLimitMotor1.setSpring(u[0],u[1])}return d.name=t.name||"",this.addJoint(d),d}var f=t.move||!1,m=t.noSleep||!1,_=t.pos||[0,0,0];_=_.map(function(t){return t*a.INV_SCALE});var g=t.size||[1,1,1];g=g.map(function(t){return t*a.INV_SCALE});var y=t.rot||[0,0,0];y=y.map(function(t){return t*a.degtorad});for(var v=[],x=0;x<y.length/3;x++){var b=a.EulerToAxis(y[x+0],y[x+1],y[x+2]);v.push(b[0]),v.push(b[1]),v.push(b[2]),v.push(b[3])}var P=new a.ShapeConfig;void 0!==t.sc&&(P=t.sc),t.config&&(P.density=void 0===t.config[0]?1:t.config[0],P.friction=void 0===t.config[1]?.4:t.config[1],P.restitution=void 0===t.config[2]?.2:t.config[2],P.belongsTo=t.config[3]||1,P.collidesWith=t.config[4]||4294967295),void 0!==t.density&&(P.density=t.density),void 0!==t.friction&&(P.friction=t.friction),void 0!==t.restitution&&(P.restitution=t.restitution),void 0!==t.belongsTo&&(P.belongsTo=t.belongsTo),void 0!==t.collidesWith&&(P.collidesWith=t.collidesWith),t.massPos&&(t.massPos=t.massPos.map(function(t){return t*a.INV_SCALE}),P.relativePosition.init(t.massPos[0],t.massPos[1],t.massPos[2])),t.massRot&&(t.massRot=t.massRot.map(function(t){return t*a.degtorad}),P.relativeRotation=a.EulerToMatrix(t.massRot[0],t.massRot[1],t.massRot[2]));for(var T,S,A=new a.RigidBody(_[0],_[1],_[2],v[0],v[1],v[2],v[3]),C=[],x=0;x<e.length;x++){switch(T=3*x,S=4*x,e[x]){case"sphere":C[x]=new a.SphereShape(P,g[T]);break;case"cylinder":C[x]=new a.CylinderShape(P,g[T],g[T+1]);break;case"box":C[x]=new a.BoxShape(P,g[T],g[T+1],g[T+2])}A.addShape(C[x]),x>0&&(C[x].relativePosition=new a.Vec3(_[T],_[T+1],_[T+2]),v[S+0]&&(C[x].relativeRotation=[v[S],v[S+1],v[S+2],v[S+3]]))}return f?(t.massPos||t.massRot?A.setupMass(1,!1):A.setupMass(1,!0),A.allowSleep=!m):A.setupMass(2),A.name=t.name||" ",this.addRigidBody(A),A},e.OIMO=a},function(t,e,i){"use strict";var r,n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s=function(t,e,i,r){var s,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"===("undefined"==typeof Reflect?"undefined":n(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var h=t.length-1;h>=0;h--)(s=t[h])&&(a=(o<3?s(a):o>3?s(e,i,a):s(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},o=function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);i.prototype=e.prototype,t.prototype=new i};!function(t){t.ToGammaSpace=1/2.2,t.ToLinearSpace=2.2,t.Epsilon=.001;var e=function(){function t(){}return t.WithinEpsilon=function(t,e,i){void 0===i&&(i=1.401298e-45);var r=t-e;return-i<=r&&r<=i},t.ToHex=function(t){var e=t.toString(16);return t<=15?("0"+e).toUpperCase():e.toUpperCase()},t.Sign=function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},t.Clamp=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),Math.min(i,Math.max(e,t))},t}();t.MathTools=e;var i=function(){function i(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.r=t,this.g=e,this.b=i}return i.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},i.prototype.getClassName=function(){return"Color3"},i.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0)},i.prototype.toArray=function(t,e){return void 0===e&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,this},i.prototype.toColor4=function(t){return void 0===t&&(t=1),new r(this.r,this.g,this.b,t)},i.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},i.prototype.toLuminance=function(){return.3*this.r+.59*this.g+.11*this.b},i.prototype.multiply=function(t){return new i(this.r*t.r,this.g*t.g,this.b*t.b)},i.prototype.multiplyToRef=function(t,e){return e.r=this.r*t.r,e.g=this.g*t.g,e.b=this.b*t.b,this},i.prototype.equals=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},i.prototype.equalsFloats=function(t,e,i){return this.r===t&&this.g===e&&this.b===i},i.prototype.scale=function(t){return new i(this.r*t,this.g*t,this.b*t)},i.prototype.scaleToRef=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,this},i.prototype.add=function(t){return new i(this.r+t.r,this.g+t.g,this.b+t.b)},i.prototype.addToRef=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,this},i.prototype.subtract=function(t){return new i(this.r-t.r,this.g-t.g,this.b-t.b)},i.prototype.subtractToRef=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,this},i.prototype.clone=function(){return new i(this.r,this.g,this.b)},i.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},i.prototype.copyFromFloats=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},i.prototype.toHexString=function(){var t=255*this.r|0,i=255*this.g|0,r=255*this.b|0;return"#"+e.ToHex(t)+e.ToHex(i)+e.ToHex(r)},i.prototype.toLinearSpace=function(){var t=new i;return this.toLinearSpaceToRef(t),t},i.prototype.toLinearSpaceToRef=function(e){return e.r=Math.pow(this.r,t.ToLinearSpace),e.g=Math.pow(this.g,t.ToLinearSpace),e.b=Math.pow(this.b,t.ToLinearSpace),this},i.prototype.toGammaSpace=function(){var t=new i;return this.toGammaSpaceToRef(t),t},i.prototype.toGammaSpaceToRef=function(e){return e.r=Math.pow(this.r,t.ToGammaSpace),e.g=Math.pow(this.g,t.ToGammaSpace),e.b=Math.pow(this.b,t.ToGammaSpace),this},i.FromHexString=function(t){if("#"!==t.substring(0,1)||7!==t.length)return new i(0,0,0);var e=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),n=parseInt(t.substring(5,7),16);return i.FromInts(e,r,n)},i.FromArray=function(t,e){return void 0===e&&(e=0),new i(t[e],t[e+1],t[e+2])},i.FromInts=function(t,e,r){return new i(t/255,e/255,r/255)},i.Lerp=function(t,e,r){return new i(t.r+(e.r-t.r)*r,t.g+(e.g-t.g)*r,t.b+(e.b-t.b)*r)},i.Red=function(){return new i(1,0,0)},i.Green=function(){return new i(0,1,0)},i.Blue=function(){return new i(0,0,1)},i.Black=function(){return new i(0,0,0)},i.White=function(){return new i(1,1,1)},i.Purple=function(){return new i(.5,0,.5)},i.Magenta=function(){return new i(1,0,1)},i.Yellow=function(){return new i(1,1,0)},i.Gray=function(){return new i(.5,.5,.5)},i}();t.Color3=i;var r=function(){function t(t,e,i,r){this.r=t,this.g=e,this.b=i,this.a=r}return t.prototype.addInPlace=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},t.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},t.prototype.toArray=function(t,e){return void 0===e&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t[e+3]=this.a,this},t.prototype.add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},t.prototype.subtract=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},t.prototype.subtractToRef=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,this},t.prototype.scale=function(e){return new t(this.r*e,this.g*e,this.b*e,this.a*e)},t.prototype.scaleToRef=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,this},t.prototype.multiply=function(e){return new t(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)},t.prototype.multiplyToRef=function(t,e){return e.r=this.r*t.r,e.g=this.g*t.g,e.b=this.b*t.b,e.a=this.a*t.a,e},t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},t.prototype.getClassName=function(){return"Color4"},t.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0),t=397*t^(this.a||0)},t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)},t.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.toHexString=function(){var t=255*this.r|0,i=255*this.g|0,r=255*this.b|0,n=255*this.a|0;return"#"+e.ToHex(t)+e.ToHex(i)+e.ToHex(r)+e.ToHex(n)},t.FromHexString=function(e){if("#"!==e.substring(0,1)||9!==e.length)return new t(0,0,0,0);var i=parseInt(e.substring(1,3),16),r=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),s=parseInt(e.substring(7,9),16);return t.FromInts(i,r,n,s)},t.Lerp=function(e,i,r){var n=new t(0,0,0,0);return t.LerpToRef(e,i,r,n),n},t.LerpToRef=function(t,e,i,r){r.r=t.r+(e.r-t.r)*i,r.g=t.g+(e.g-t.g)*i,r.b=t.b+(e.b-t.b)*i,r.a=t.a+(e.a-t.a)*i},t.FromArray=function(e,i){return void 0===i&&(i=0),new t(e[i],e[i+1],e[i+2],e[i+3])},t.FromInts=function(e,i,r,n){return new t(e/255,i/255,r/255,n/255)},t.CheckColors4=function(t,e){if(t.length===3*e){for(var i=[],r=0;r<t.length;r+=3){var n=r/3*4;i[n]=t[r],i[n+1]=t[r+1],i[n+2]=t[r+2],i[n+3]=1}return i}return t},t}();t.Color4=r;var n=function(){function i(t,e){this.x=t,this.y=e}return i.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},i.prototype.getClassName=function(){return"Vector2"},i.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0)},i.prototype.toArray=function(t,e){return void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,this},i.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},i.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this},i.prototype.copyFromFloats=function(t,e){return this.x=t,this.y=e,this},i.prototype.add=function(t){return new i(this.x+t.x,this.y+t.y)},i.prototype.addToRef=function(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,this},i.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this},i.prototype.addVector3=function(t){return new i(this.x+t.x,this.y+t.y)},i.prototype.subtract=function(t){return new i(this.x-t.x,this.y-t.y)},i.prototype.subtractToRef=function(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,this},i.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this},i.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this},i.prototype.multiply=function(t){return new i(this.x*t.x,this.y*t.y)},i.prototype.multiplyToRef=function(t,e){return e.x=this.x*t.x,e.y=this.y*t.y,this},i.prototype.multiplyByFloats=function(t,e){return new i(this.x*t,this.y*e)},i.prototype.divide=function(t){return new i(this.x/t.x,this.y/t.y)},i.prototype.divideToRef=function(t,e){return e.x=this.x/t.x,e.y=this.y/t.y,this},i.prototype.negate=function(){return new i(-this.x,-this.y)},i.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this},i.prototype.scale=function(t){return new i(this.x*t,this.y*t)},i.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y},i.prototype.equalsWithEpsilon=function(i,r){return void 0===r&&(r=t.Epsilon),i&&e.WithinEpsilon(this.x,i.x,r)&&e.WithinEpsilon(this.y,i.y,r)},i.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},i.prototype.normalize=function(){var t=this.length();if(0===t)return this;var e=1/t;return this.x*=e,this.y*=e,this},i.prototype.clone=function(){return new i(this.x,this.y)},i.Zero=function(){return new i(0,0)},i.FromArray=function(t,e){return void 0===e&&(e=0),new i(t[e],t[e+1])},i.FromArrayToRef=function(t,e,i){i.x=t[e],i.y=t[e+1]},i.CatmullRom=function(t,e,r,n,s){var o=s*s,a=s*o;return new i(.5*(2*e.x+(-t.x+r.x)*s+(2*t.x-5*e.x+4*r.x-n.x)*o+(-t.x+3*e.x-3*r.x+n.x)*a),.5*(2*e.y+(-t.y+r.y)*s+(2*t.y-5*e.y+4*r.y-n.y)*o+(-t.y+3*e.y-3*r.y+n.y)*a))},i.Clamp=function(t,e,r){var n=t.x;n=n>r.x?r.x:n,n=n<e.x?e.x:n;var s=t.y;return s=s>r.y?r.y:s,s=s<e.y?e.y:s,new i(n,s)},i.Hermite=function(t,e,r,n,s){var o=s*s,a=s*o,h=2*a-3*o+1,l=-2*a+3*o,c=a-2*o+s,u=a-o;return new i(t.x*h+r.x*l+e.x*c+n.x*u,t.y*h+r.y*l+e.y*c+n.y*u)},i.Lerp=function(t,e,r){return new i(t.x+(e.x-t.x)*r,t.y+(e.y-t.y)*r)},i.Dot=function(t,e){return t.x*e.x+t.y*e.y},i.Normalize=function(t){var e=t.clone();return e.normalize(),e},i.Minimize=function(t,e){return new i(t.x<e.x?t.x:e.x,t.y<e.y?t.y:e.y)},i.Maximize=function(t,e){return new i(t.x>e.x?t.x:e.x,t.y>e.y?t.y:e.y)},i.Transform=function(t,e){var r=i.Zero();return i.TransformToRef(t,e,r),r},i.TransformToRef=function(t,e,i){var r=t.x*e.m[0]+t.y*e.m[4]+e.m[12],n=t.x*e.m[1]+t.y*e.m[5]+e.m[13];i.x=r,i.y=n},i.PointInTriangle=function(t,e,i,r){var n=.5*(-i.y*r.x+e.y*(-i.x+r.x)+e.x*(i.y-r.y)+i.x*r.y),s=n<0?-1:1,o=(e.y*r.x-e.x*r.y+(r.y-e.y)*t.x+(e.x-r.x)*t.y)*s,a=(e.x*i.y-e.y*i.x+(e.y-i.y)*t.x+(i.x-e.x)*t.y)*s;return o>0&&a>0&&o+a<2*n*s},i.Distance=function(t,e){return Math.sqrt(i.DistanceSquared(t,e))},i.DistanceSquared=function(t,e){var i=t.x-e.x,r=t.y-e.y;return i*i+r*r},i.Center=function(t,e){var i=t.add(e);return i.scaleInPlace(.5),i},i.DistanceOfPointFromSegment=function(t,e,r){var n=i.DistanceSquared(e,r);if(0===n)return i.Distance(t,e);var s=r.subtract(e),o=Math.max(0,Math.min(1,i.Dot(t.subtract(e),s)/n)),a=e.add(s.multiplyByFloats(o,o));return i.Distance(t,a)},i}();t.Vector2=n;var s=function(){function i(t,e,i){this.x=t,this.y=e,this.z=i}return i.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},i.prototype.getClassName=function(){return"Vector3"},i.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0)},i.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},i.prototype.toArray=function(t,e){return void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,this},i.prototype.toQuaternion=function(){var t=new h(0,0,0,1),e=Math.cos(.5*(this.x+this.z)),i=Math.sin(.5*(this.x+this.z)),r=Math.cos(.5*(this.z-this.x)),n=Math.sin(.5*(this.z-this.x)),s=Math.cos(.5*this.y),o=Math.sin(.5*this.y);return t.x=r*o,t.y=-n*o,t.z=i*s,t.w=e*s,t},i.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},i.prototype.add=function(t){return new i(this.x+t.x,this.y+t.y,this.z+t.z)},i.prototype.addToRef=function(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,this},i.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},i.prototype.subtract=function(t){return new i(this.x-t.x,this.y-t.y,this.z-t.z)},i.prototype.subtractToRef=function(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,this},i.prototype.subtractFromFloats=function(t,e,r){return new i(this.x-t,this.y-e,this.z-r)},i.prototype.subtractFromFloatsToRef=function(t,e,i,r){return r.x=this.x-t,r.y=this.y-e,r.z=this.z-i,this},i.prototype.negate=function(){return new i(-this.x,-this.y,-this.z)},i.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this},i.prototype.scale=function(t){return new i(this.x*t,this.y*t,this.z*t)},i.prototype.scaleToRef=function(t,e){e.x=this.x*t,e.y=this.y*t,e.z=this.z*t},i.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},i.prototype.equalsWithEpsilon=function(i,r){return void 0===r&&(r=t.Epsilon),i&&e.WithinEpsilon(this.x,i.x,r)&&e.WithinEpsilon(this.y,i.y,r)&&e.WithinEpsilon(this.z,i.z,r)},i.prototype.equalsToFloats=function(t,e,i){return this.x===t&&this.y===e&&this.z===i},i.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},i.prototype.multiply=function(t){return new i(this.x*t.x,this.y*t.y,this.z*t.z)},i.prototype.multiplyToRef=function(t,e){return e.x=this.x*t.x,e.y=this.y*t.y,e.z=this.z*t.z,this},i.prototype.multiplyByFloats=function(t,e,r){return new i(this.x*t,this.y*e,this.z*r)},i.prototype.divide=function(t){return new i(this.x/t.x,this.y/t.y,this.z/t.z)},i.prototype.divideToRef=function(t,e){return e.x=this.x/t.x,e.y=this.y/t.y,e.z=this.z/t.z,this},i.prototype.MinimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this},i.prototype.MaximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this},i.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},i.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},i.prototype.normalize=function(){var t=this.length();if(0===t||1===t)return this;var e=1/t;return this.x*=e,this.y*=e,this.z*=e,this},i.prototype.clone=function(){return new i(this.x,this.y,this.z)},i.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},i.prototype.copyFromFloats=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},i.GetClipFactor=function(t,e,r,n){var s=i.Dot(t,r)-n;return s/(s-(i.Dot(e,r)-n))},i.FromArray=function(t,e){return e||(e=0),new i(t[e],t[e+1],t[e+2])},i.FromFloatArray=function(t,e){return e||(e=0),new i(t[e],t[e+1],t[e+2])},i.FromArrayToRef=function(t,e,i){i.x=t[e],i.y=t[e+1],i.z=t[e+2]},i.FromFloatArrayToRef=function(t,e,i){i.x=t[e],i.y=t[e+1],i.z=t[e+2]},i.FromFloatsToRef=function(t,e,i,r){r.x=t,r.y=e,r.z=i},i.Zero=function(){return new i(0,0,0)},i.Up=function(){return new i(0,1,0)},i.Forward=function(){return new i(0,0,1)},i.Right=function(){return new i(1,0,0)},i.Left=function(){return new i(-1,0,0)},i.TransformCoordinates=function(t,e){var r=i.Zero();return i.TransformCoordinatesToRef(t,e,r),r},i.TransformCoordinatesToRef=function(t,e,i){var r=t.x*e.m[0]+t.y*e.m[4]+t.z*e.m[8]+e.m[12],n=t.x*e.m[1]+t.y*e.m[5]+t.z*e.m[9]+e.m[13],s=t.x*e.m[2]+t.y*e.m[6]+t.z*e.m[10]+e.m[14],o=t.x*e.m[3]+t.y*e.m[7]+t.z*e.m[11]+e.m[15];i.x=r/o,i.y=n/o,i.z=s/o},i.TransformCoordinatesFromFloatsToRef=function(t,e,i,r,n){var s=t*r.m[0]+e*r.m[4]+i*r.m[8]+r.m[12],o=t*r.m[1]+e*r.m[5]+i*r.m[9]+r.m[13],a=t*r.m[2]+e*r.m[6]+i*r.m[10]+r.m[14],h=t*r.m[3]+e*r.m[7]+i*r.m[11]+r.m[15];n.x=s/h,n.y=o/h,n.z=a/h},i.TransformNormal=function(t,e){var r=i.Zero();return i.TransformNormalToRef(t,e,r),r},i.TransformNormalToRef=function(t,e,i){var r=t.x*e.m[0]+t.y*e.m[4]+t.z*e.m[8],n=t.x*e.m[1]+t.y*e.m[5]+t.z*e.m[9],s=t.x*e.m[2]+t.y*e.m[6]+t.z*e.m[10];i.x=r,i.y=n,i.z=s},i.TransformNormalFromFloatsToRef=function(t,e,i,r,n){n.x=t*r.m[0]+e*r.m[4]+i*r.m[8],n.y=t*r.m[1]+e*r.m[5]+i*r.m[9],n.z=t*r.m[2]+e*r.m[6]+i*r.m[10]},i.CatmullRom=function(t,e,r,n,s){var o=s*s,a=s*o;return new i(.5*(2*e.x+(-t.x+r.x)*s+(2*t.x-5*e.x+4*r.x-n.x)*o+(-t.x+3*e.x-3*r.x+n.x)*a),.5*(2*e.y+(-t.y+r.y)*s+(2*t.y-5*e.y+4*r.y-n.y)*o+(-t.y+3*e.y-3*r.y+n.y)*a),.5*(2*e.z+(-t.z+r.z)*s+(2*t.z-5*e.z+4*r.z-n.z)*o+(-t.z+3*e.z-3*r.z+n.z)*a))},i.Clamp=function(t,e,r){var n=t.x;n=n>r.x?r.x:n,n=n<e.x?e.x:n;var s=t.y;s=s>r.y?r.y:s,s=s<e.y?e.y:s;var o=t.z;return o=o>r.z?r.z:o,o=o<e.z?e.z:o,new i(n,s,o)},i.Hermite=function(t,e,r,n,s){var o=s*s,a=s*o,h=2*a-3*o+1,l=-2*a+3*o,c=a-2*o+s,u=a-o;return new i(t.x*h+r.x*l+e.x*c+n.x*u,t.y*h+r.y*l+e.y*c+n.y*u,t.z*h+r.z*l+e.z*c+n.z*u)},i.Lerp=function(t,e,r){return new i(t.x+(e.x-t.x)*r,t.y+(e.y-t.y)*r,t.z+(e.z-t.z)*r)},i.Dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},i.Cross=function(t,e){var r=i.Zero();return i.CrossToRef(t,e,r),r},i.CrossToRef=function(t,e,i){A.Vector3[0].x=t.y*e.z-t.z*e.y,A.Vector3[0].y=t.z*e.x-t.x*e.z,A.Vector3[0].z=t.x*e.y-t.y*e.x,i.copyFrom(A.Vector3[0])},i.Normalize=function(t){var e=i.Zero();return i.NormalizeToRef(t,e),e},i.NormalizeToRef=function(t,e){e.copyFrom(t),e.normalize()},i.Project=function(t,e,r,n){var s=n.width,o=n.height,a=n.x,h=n.y,c=i._viewportMatrixCache?i._viewportMatrixCache:i._viewportMatrixCache=new l;l.FromValuesToRef(s/2,0,0,0,0,-o/2,0,0,0,0,1,0,a+s/2,o/2+h,0,1,c);var u=i._matrixCache?i._matrixCache:i._matrixCache=new l;return e.multiplyToRef(r,u),u.multiplyToRef(c,u),i.TransformCoordinates(t,u)},i.UnprojectFromTransform=function(t,r,n,s,o){var a=i._matrixCache?i._matrixCache:i._matrixCache=new l;s.multiplyToRef(o,a),a.invert(),t.x=t.x/r*2-1,t.y=-(t.y/n*2-1);var h=i.TransformCoordinates(t,a),c=t.x*a.m[3]+t.y*a.m[7]+t.z*a.m[11]+a.m[15];return e.WithinEpsilon(c,1)&&(h=h.scale(1/c)),h},i.Unproject=function(t,r,n,s,o,a){var h=i._matrixCache?i._matrixCache:i._matrixCache=new l;s.multiplyToRef(o,h),h.multiplyToRef(a,h),h.invert();var c=new i(t.x/r*2-1,-(t.y/n*2-1),t.z),u=i.TransformCoordinates(c,h),p=c.x*h.m[3]+c.y*h.m[7]+c.z*h.m[11]+h.m[15];return e.WithinEpsilon(p,1)&&(u=u.scale(1/p)),u},i.Minimize=function(t,e){var i=t.clone();return i.MinimizeInPlace(e),i},i.Maximize=function(t,e){var i=t.clone();return i.MaximizeInPlace(e),i},i.Distance=function(t,e){return Math.sqrt(i.DistanceSquared(t,e))},i.DistanceSquared=function(t,e){var i=t.x-e.x,r=t.y-e.y,n=t.z-e.z;return i*i+r*r+n*n},i.Center=function(t,e){var i=t.add(e);return i.scaleInPlace(.5),i},i.RotationFromAxis=function(t,e,r){var n=i.Zero();return i.RotationFromAxisToRef(t,e,r,n),n},i.RotationFromAxisToRef=function(r,n,s,o){var a=r.normalize(),h=s.normalize(),l=d.X,c=d.Y,u=0,p=0,f=0,m=0,_=0,g=0,y=0,v=-1,x=0,b=A.Vector3[0],P=0,T=A.Vector3[1];e.WithinEpsilon(h.z,0,t.Epsilon)?g=1:e.WithinEpsilon(h.x,0,t.Epsilon)?m=1:(y=h.z/h.x,m=-y*Math.sqrt(1/(1+y*y)),g=Math.sqrt(1/(1+y*y))),T.x=m,T.y=_,T.z=g,T.normalize(),i.CrossToRef(a,T,b),b.normalize(),i.Dot(h,b)<0&&(v=1),P=i.Dot(a,T),P=Math.min(1,Math.max(-1,P)),f=Math.acos(P)*v,i.Dot(T,l)<0&&(f=Math.PI+f,T=T.scaleInPlace(-1),x++);var S=A.Vector3[2],C=A.Vector3[3];m=0,_=0,g=0,v=-1,e.WithinEpsilon(h.z,0,t.Epsilon)?m=1:(y=T.z/T.x,m=-y*Math.sqrt(1/(1+y*y)),g=Math.sqrt(1/(1+y*y))),S.x=m,S.y=_,S.z=g,S.normalize(),i.CrossToRef(S,T,C),C.normalize(),i.CrossToRef(h,S,b),b.normalize(),i.Dot(T,b)<0&&(v=1),P=i.Dot(h,S),P=Math.min(1,Math.max(-1,P)),p=Math.acos(P)*v,i.Dot(C,c)<0&&(p=Math.PI+p,x++),v=-1,i.CrossToRef(l,T,b),b.normalize(),i.Dot(b,c)<0&&(v=1),P=i.Dot(T,l),P=Math.min(1,Math.max(-1,P)),u=-Math.acos(P)*v,P<0&&x<2&&(u=Math.PI+u),o.x=p,o.y=u,o.z=f},i}();t.Vector3=s;var o=function(){function i(t,e,i,r){this.x=t,this.y=e,this.z=i,this.w=r}return i.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},i.prototype.getClassName=function(){return"Vector4"},i.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},i.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},i.prototype.toArray=function(t,e){return void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,this},i.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},i.prototype.add=function(t){return new i(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},i.prototype.addToRef=function(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,e.w=this.w+t.w,this},i.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},i.prototype.subtract=function(t){return new i(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},i.prototype.subtractToRef=function(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,e.w=this.w-t.w,this},i.prototype.subtractFromFloats=function(t,e,r,n){return new i(this.x-t,this.y-e,this.z-r,this.w-n)},i.prototype.subtractFromFloatsToRef=function(t,e,i,r,n){return n.x=this.x-t,n.y=this.y-e,n.z=this.z-i,n.w=this.w-r,this},i.prototype.negate=function(){return new i(-this.x,-this.y,-this.z,-this.w)},i.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},i.prototype.scale=function(t){return new i(this.x*t,this.y*t,this.z*t,this.w*t)},i.prototype.scaleToRef=function(t,e){e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t},i.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},i.prototype.equalsWithEpsilon=function(i,r){return void 0===r&&(r=t.Epsilon),i&&e.WithinEpsilon(this.x,i.x,r)&&e.WithinEpsilon(this.y,i.y,r)&&e.WithinEpsilon(this.z,i.z,r)&&e.WithinEpsilon(this.w,i.w,r)},i.prototype.equalsToFloats=function(t,e,i,r){return this.x===t&&this.y===e&&this.z===i&&this.w===r},i.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},i.prototype.multiply=function(t){return new i(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)},i.prototype.multiplyToRef=function(t,e){return e.x=this.x*t.x,e.y=this.y*t.y,e.z=this.z*t.z,e.w=this.w*t.w,this},i.prototype.multiplyByFloats=function(t,e,r,n){return new i(this.x*t,this.y*e,this.z*r,this.w*n)},i.prototype.divide=function(t){return new i(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)},i.prototype.divideToRef=function(t,e){return e.x=this.x/t.x,e.y=this.y/t.y,e.z=this.z/t.z,e.w=this.w/t.w,this},i.prototype.MinimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this},i.prototype.MaximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this},i.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},i.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},i.prototype.normalize=function(){var t=this.length();if(0===t)return this;var e=1/t;return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},i.prototype.toVector3=function(){return new s(this.x,this.y,this.z)},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)},i.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},i.prototype.copyFromFloats=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},i.FromArray=function(t,e){return e||(e=0),new i(t[e],t[e+1],t[e+2],t[e+3])},i.FromArrayToRef=function(t,e,i){i.x=t[e],i.y=t[e+1],i.z=t[e+2],i.w=t[e+3]},i.FromFloatArrayToRef=function(t,e,i){i.x=t[e],i.y=t[e+1],i.z=t[e+2],i.w=t[e+3]},i.FromFloatsToRef=function(t,e,i,r,n){n.x=t,n.y=e,n.z=i,n.w=r},i.Zero=function(){return new i(0,0,0,0)},i.Normalize=function(t){var e=i.Zero();return i.NormalizeToRef(t,e),e},i.NormalizeToRef=function(t,e){e.copyFrom(t),e.normalize()},i.Minimize=function(t,e){var i=t.clone();return i.MinimizeInPlace(e),i},i.Maximize=function(t,e){var i=t.clone();return i.MaximizeInPlace(e),i},i.Distance=function(t,e){return Math.sqrt(i.DistanceSquared(t,e))},i.DistanceSquared=function(t,e){var i=t.x-e.x,r=t.y-e.y,n=t.z-e.z,s=t.w-e.w;return i*i+r*r+n*n+s*s},i.Center=function(t,e){var i=t.add(e);return i.scaleInPlace(.5),i},i}();t.Vector4=o;var a=function(){function t(t,e){this.width=t,this.height=e}return t.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"},t.prototype.getClassName=function(){return"Size"},t.prototype.getHashCode=function(){var t=this.width||0;return t=397*t^(this.height||0)},t.prototype.copyFrom=function(t){this.width=t.width,this.height=t.height},t.prototype.copyFromFloats=function(t,e){this.width=t,this.height=e},t.prototype.multiplyByFloats=function(e,i){return new t(this.width*e,this.height*i)},t.prototype.clone=function(){return new t(this.width,this.height)},t.prototype.equals=function(t){return!!t&&(this.width===t.width&&this.height===t.height)},Object.defineProperty(t.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),t.Zero=function(){return new t(0,0)},t.prototype.add=function(e){return new t(this.width+e.width,this.height+e.height)},t.prototype.substract=function(e){return new t(this.width-e.width,this.height-e.height)},t.Lerp=function(e,i,r){return new t(e.width+(i.width-e.width)*r,e.height+(i.height-e.height)*r)},t}();t.Size=a;var h=function(){function t(t,e,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===r&&(r=1),this.x=t,this.y=e,this.z=i,this.w=r}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},t.prototype.getClassName=function(){return"Quaternion"},t.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},t.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},t.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.copyFromFloats=function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},t.prototype.scale=function(e){return new t(this.x*e,this.y*e,this.z*e,this.w*e)},t.prototype.multiply=function(e){var i=new t(0,0,0,1);return this.multiplyToRef(e,i),i},t.prototype.multiplyToRef=function(t,e){var i=this.x*t.w+this.y*t.z-this.z*t.y+this.w*t.x,r=-this.x*t.z+this.y*t.w+this.z*t.x+this.w*t.y,n=this.x*t.y-this.y*t.x+this.z*t.w+this.w*t.z,s=-this.x*t.x-this.y*t.y-this.z*t.z+this.w*t.w;return e.copyFromFloats(i,r,n,s),this},t.prototype.multiplyInPlace=function(t){return this.multiplyToRef(t,this),this},t.prototype.conjugateToRef=function(t){return t.copyFromFloats(-this.x,-this.y,-this.z,this.w),this},t.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.prototype.conjugate=function(){return new t(-this.x,-this.y,-this.z,this.w)},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},t.prototype.toEulerAngles=function(t){void 0===t&&(t="YZX");var e=s.Zero();return this.toEulerAnglesToRef(e,t),e},t.prototype.toEulerAnglesToRef=function(t,e){void 0===e&&(e="YZX");var i=this.z,r=this.x,n=this.y,s=this.w,o=s*s,a=i*i,h=r*r,l=n*n,c=n*i-r*s,u=.4999999;return c<-u?(t.y=2*Math.atan2(n,s),t.x=Math.PI/2,t.z=0):c>u?(t.y=2*Math.atan2(n,s),t.x=-Math.PI/2,t.z=0):(t.z=Math.atan2(2*(r*n+i*s),-a-h+l+o),t.x=Math.asin(-2*(i*n-r*s)),t.y=Math.atan2(2*(i*r+n*s),a-h-l+o)),this},t.prototype.toRotationMatrix=function(t){var e=this.x*this.x,i=this.y*this.y,r=this.z*this.z,n=this.x*this.y,s=this.z*this.w,o=this.z*this.x,a=this.y*this.w,h=this.y*this.z,l=this.x*this.w;return t.m[0]=1-2*(i+r),t.m[1]=2*(n+s),t.m[2]=2*(o-a),t.m[3]=0,t.m[4]=2*(n-s),t.m[5]=1-2*(r+e),t.m[6]=2*(h+l),t.m[7]=0,t.m[8]=2*(o+a),t.m[9]=2*(h-l),t.m[10]=1-2*(i+e),t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t.m[15]=1,this},t.prototype.fromRotationMatrix=function(e){return t.FromRotationMatrixToRef(e,this),this},t.FromRotationMatrix=function(e){var i=new t;return t.FromRotationMatrixToRef(e,i),i},t.FromRotationMatrixToRef=function(t,e){var i,r=t.m,n=r[0],s=r[4],o=r[8],a=r[1],h=r[5],l=r[9],c=r[2],u=r[6],p=r[10],d=n+h+p;d>0?(i=.5/Math.sqrt(d+1),e.w=.25/i,e.x=(u-l)*i,e.y=(o-c)*i,e.z=(a-s)*i):n>h&&n>p?(i=2*Math.sqrt(1+n-h-p),e.w=(u-l)/i,e.x=.25*i,e.y=(s+a)/i,e.z=(o+c)/i):h>p?(i=2*Math.sqrt(1+h-n-p),e.w=(o-c)/i,e.x=(s+a)/i,e.y=.25*i,e.z=(l+u)/i):(i=2*Math.sqrt(1+p-n-h),e.w=(a-s)/i,e.x=(o+c)/i,e.y=(l+u)/i,e.z=.25*i)},t.Inverse=function(e){return new t(-e.x,-e.y,-e.z,e.w)},t.Identity=function(){return new t(0,0,0,1)},t.RotationAxis=function(e,i){return t.RotationAxisToRef(e,i,new t)},t.RotationAxisToRef=function(t,e,i){var r=Math.sin(e/2);return t.normalize(),i.w=Math.cos(e/2),i.x=t.x*r,i.y=t.y*r,i.z=t.z*r,i},t.FromArray=function(e,i){return i||(i=0),new t(e[i],e[i+1],e[i+2],e[i+3])},t.RotationYawPitchRoll=function(e,i,r){var n=new t;return t.RotationYawPitchRollToRef(e,i,r,n),n},t.RotationYawPitchRollToRef=function(t,e,i,r){var n=.5*i,s=.5*e,o=.5*t,a=Math.sin(n),h=Math.cos(n),l=Math.sin(s),c=Math.cos(s),u=Math.sin(o),p=Math.cos(o);r.x=p*l*h+u*c*a,r.y=u*c*h-p*l*a,r.z=p*c*a-u*l*h,r.w=p*c*h+u*l*a},t.RotationAlphaBetaGamma=function(e,i,r){var n=new t;return t.RotationAlphaBetaGammaToRef(e,i,r,n),n},t.RotationAlphaBetaGammaToRef=function(t,e,i,r){var n=.5*(i+t),s=.5*(i-t),o=.5*e;r.x=Math.cos(s)*Math.sin(o),r.y=Math.sin(s)*Math.sin(o),r.z=Math.sin(n)*Math.cos(o),r.w=Math.cos(n)*Math.cos(o)},t.Slerp=function(e,i,r){var n=t.Identity();return t.SlerpToRef(e,i,r,n),n},t.SlerpToRef=function(t,e,i,r){var n,s,o=i,a=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w,h=!1;if(a<0&&(h=!0,a=-a),a>.999999)s=1-o,n=h?-o:o;else{var l=Math.acos(a),c=1/Math.sin(l);s=Math.sin((1-o)*l)*c,n=h?-Math.sin(o*l)*c:Math.sin(o*l)*c}r.x=s*t.x+n*e.x,r.y=s*t.y+n*e.y,r.z=s*t.z+n*e.z,r.w=s*t.w+n*e.w},t}();t.Quaternion=h;var l=function(){function t(){this.m=new Float32Array(16)}return t.prototype.isIdentity=function(){return 1===this.m[0]&&1===this.m[5]&&1===this.m[10]&&1===this.m[15]&&(0===this.m[1]&&0===this.m[2]&&0===this.m[3]&&0===this.m[4]&&0===this.m[6]&&0===this.m[7]&&0===this.m[8]&&0===this.m[9]&&0===this.m[11]&&0===this.m[12]&&0===this.m[13]&&0===this.m[14])},t.prototype.determinant=function(){var t=this.m[10]*this.m[15]-this.m[11]*this.m[14],e=this.m[9]*this.m[15]-this.m[11]*this.m[13],i=this.m[9]*this.m[14]-this.m[10]*this.m[13],r=this.m[8]*this.m[15]-this.m[11]*this.m[12],n=this.m[8]*this.m[14]-this.m[10]*this.m[12],s=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*t-this.m[6]*e+this.m[7]*i)-this.m[1]*(this.m[4]*t-this.m[6]*r+this.m[7]*n)+this.m[2]*(this.m[4]*e-this.m[5]*r+this.m[7]*s)-this.m[3]*(this.m[4]*i-this.m[5]*n+this.m[6]*s)},t.prototype.toArray=function(){return this.m},t.prototype.asArray=function(){return this.toArray()},t.prototype.invert=function(){return this.invertToRef(this),this},t.prototype.reset=function(){for(var t=0;t<16;t++)this.m[t]=0;return this},t.prototype.add=function(e){var i=new t;return this.addToRef(e,i),i},t.prototype.addToRef=function(t,e){for(var i=0;i<16;i++)e.m[i]=this.m[i]+t.m[i];return this},t.prototype.addToSelf=function(t){for(var e=0;e<16;e++)this.m[e]+=t.m[e];return this},t.prototype.invertToRef=function(t){var e=this.m[0],i=this.m[1],r=this.m[2],n=this.m[3],s=this.m[4],o=this.m[5],a=this.m[6],h=this.m[7],l=this.m[8],c=this.m[9],u=this.m[10],p=this.m[11],d=this.m[12],f=this.m[13],m=this.m[14],_=this.m[15],g=u*_-p*m,y=c*_-p*f,v=c*m-u*f,x=l*_-p*d,b=l*m-u*d,P=l*f-c*d,T=o*g-a*y+h*v,S=-(s*g-a*x+h*b),A=s*y-o*x+h*P,C=-(s*v-o*b+a*P),E=1/(e*T+i*S+r*A+n*C),M=a*_-h*m,D=o*_-h*f,R=o*m-a*f,I=s*_-h*d,O=s*m-a*d,w=s*f-o*d,L=a*p-h*u,F=o*p-h*c,V=o*u-a*c,N=s*p-h*l,z=s*u-a*l,B=s*c-o*l;return t.m[0]=T*E,t.m[4]=S*E,t.m[8]=A*E,t.m[12]=C*E,t.m[1]=-(i*g-r*y+n*v)*E,t.m[5]=(e*g-r*x+n*b)*E,t.m[9]=-(e*y-i*x+n*P)*E,t.m[13]=(e*v-i*b+r*P)*E,t.m[2]=(i*M-r*D+n*R)*E,t.m[6]=-(e*M-r*I+n*O)*E,t.m[10]=(e*D-i*I+n*w)*E,t.m[14]=-(e*R-i*O+r*w)*E,t.m[3]=-(i*L-r*F+n*V)*E,t.m[7]=(e*L-r*N+n*z)*E,t.m[11]=-(e*F-i*N+n*B)*E,t.m[15]=(e*V-i*z+r*B)*E,this},t.prototype.setTranslation=function(t){return this.m[12]=t.x,this.m[13]=t.y,this.m[14]=t.z,this},t.prototype.getTranslation=function(){return new s(this.m[12],this.m[13],this.m[14])},t.prototype.multiply=function(e){var i=new t;return this.multiplyToRef(e,i),i},t.prototype.copyFrom=function(t){for(var e=0;e<16;e++)this.m[e]=t.m[e];return this},t.prototype.copyToArray=function(t,e){void 0===e&&(e=0);for(var i=0;i<16;i++)t[e+i]=this.m[i];return this},t.prototype.multiplyToRef=function(t,e){return this.multiplyToArray(t,e.m,0),this},t.prototype.multiplyToArray=function(t,e,i){var r=this.m[0],n=this.m[1],s=this.m[2],o=this.m[3],a=this.m[4],h=this.m[5],l=this.m[6],c=this.m[7],u=this.m[8],p=this.m[9],d=this.m[10],f=this.m[11],m=this.m[12],_=this.m[13],g=this.m[14],y=this.m[15],v=t.m[0],x=t.m[1],b=t.m[2],P=t.m[3],T=t.m[4],S=t.m[5],A=t.m[6],C=t.m[7],E=t.m[8],M=t.m[9],D=t.m[10],R=t.m[11],I=t.m[12],O=t.m[13],w=t.m[14],L=t.m[15];return e[i]=r*v+n*T+s*E+o*I,e[i+1]=r*x+n*S+s*M+o*O,e[i+2]=r*b+n*A+s*D+o*w,e[i+3]=r*P+n*C+s*R+o*L,e[i+4]=a*v+h*T+l*E+c*I,e[i+5]=a*x+h*S+l*M+c*O,e[i+6]=a*b+h*A+l*D+c*w,e[i+7]=a*P+h*C+l*R+c*L,e[i+8]=u*v+p*T+d*E+f*I,e[i+9]=u*x+p*S+d*M+f*O,e[i+10]=u*b+p*A+d*D+f*w,e[i+11]=u*P+p*C+d*R+f*L,e[i+12]=m*v+_*T+g*E+y*I,e[i+13]=m*x+_*S+g*M+y*O,e[i+14]=m*b+_*A+g*D+y*w,e[i+15]=m*P+_*C+g*R+y*L,this},t.prototype.equals=function(t){return t&&this.m[0]===t.m[0]&&this.m[1]===t.m[1]&&this.m[2]===t.m[2]&&this.m[3]===t.m[3]&&this.m[4]===t.m[4]&&this.m[5]===t.m[5]&&this.m[6]===t.m[6]&&this.m[7]===t.m[7]&&this.m[8]===t.m[8]&&this.m[9]===t.m[9]&&this.m[10]===t.m[10]&&this.m[11]===t.m[11]&&this.m[12]===t.m[12]&&this.m[13]===t.m[13]&&this.m[14]===t.m[14]&&this.m[15]===t.m[15]},t.prototype.clone=function(){return t.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},t.prototype.getClassName=function(){return"Matrix"},t.prototype.getHashCode=function(){for(var t=this.m[0]||0,e=1;e<16;e++)t=397*t^(this.m[e]||0);return t},t.prototype.decompose=function(i,r,n){n.x=this.m[12],n.y=this.m[13],n.z=this.m[14];var s=e.Sign(this.m[0]*this.m[1]*this.m[2]*this.m[3])<0?-1:1,o=e.Sign(this.m[4]*this.m[5]*this.m[6]*this.m[7])<0?-1:1,a=e.Sign(this.m[8]*this.m[9]*this.m[10]*this.m[11])<0?-1:1;return i.x=s*Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]),i.y=o*Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]),i.z=a*Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]),0===i.x||0===i.y||0===i.z?(r.x=0,r.y=0,r.z=0,r.w=1,!1):(t.FromValuesToRef(this.m[0]/i.x,this.m[1]/i.x,this.m[2]/i.x,0,this.m[4]/i.y,this.m[5]/i.y,this.m[6]/i.y,0,this.m[8]/i.z,this.m[9]/i.z,this.m[10]/i.z,0,0,0,0,1,A.Matrix[0]),h.FromRotationMatrixToRef(A.Matrix[0],r),!0)},t.prototype.getRotationMatrix=function(){var e=t.Identity();return this.getRotationMatrixToRef(e),e},t.prototype.getRotationMatrixToRef=function(e){var i=this.m,r=i[0]*i[1]*i[2]*i[3]<0?-1:1,n=i[4]*i[5]*i[6]*i[7]<0?-1:1,s=i[8]*i[9]*i[10]*i[11]<0?-1:1,o=r*Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),a=n*Math.sqrt(i[4]*i[4]+i[5]*i[5]+i[6]*i[6]),h=s*Math.sqrt(i[8]*i[8]+i[9]*i[9]+i[10]*i[10]);t.FromValuesToRef(i[0]/o,i[1]/o,i[2]/o,0,i[4]/a,i[5]/a,i[6]/a,0,i[8]/h,i[9]/h,i[10]/h,0,0,0,0,1,e)},t.FromArray=function(e,i){var r=new t;return i||(i=0),t.FromArrayToRef(e,i,r),r},t.FromArrayToRef=function(t,e,i){for(var r=0;r<16;r++)i.m[r]=t[r+e]},t.FromFloat32ArrayToRefScaled=function(t,e,i,r){for(var n=0;n<16;n++)r.m[n]=t[n+e]*i},t.FromValuesToRef=function(t,e,i,r,n,s,o,a,h,l,c,u,p,d,f,m,_){_.m[0]=t,_.m[1]=e,_.m[2]=i,_.m[3]=r,_.m[4]=n,_.m[5]=s,_.m[6]=o,_.m[7]=a,_.m[8]=h,_.m[9]=l,_.m[10]=c,_.m[11]=u,_.m[12]=p,_.m[13]=d,_.m[14]=f,_.m[15]=m},t.prototype.getRow=function(t){if(t<0||t>3)return null;var e=4*t;return new o(this.m[e+0],this.m[e+1],this.m[e+2],this.m[e+3])},t.prototype.setRow=function(t,e){if(t<0||t>3)return this;var i=4*t;return this.m[i+0]=e.x,this.m[i+1]=e.y,this.m[i+2]=e.z,this.m[i+3]=e.w,this},t.FromValues=function(e,i,r,n,s,o,a,h,l,c,u,p,d,f,m,_){var g=new t;return g.m[0]=e,g.m[1]=i,g.m[2]=r,g.m[3]=n,g.m[4]=s,g.m[5]=o,g.m[6]=a,g.m[7]=h,g.m[8]=l,g.m[9]=c,g.m[10]=u,g.m[11]=p,g.m[12]=d,g.m[13]=f,g.m[14]=m,g.m[15]=_,g},t.Compose=function(e,i,r){var n=t.FromValues(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1),s=t.Identity();return i.toRotationMatrix(s),n=n.multiply(s),n.setTranslation(r),n},t.Identity=function(){return t.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},t.IdentityToRef=function(e){t.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e)},t.Zero=function(){return t.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},t.RotationX=function(e){var i=new t;return t.RotationXToRef(e,i),i},t.Invert=function(e){var i=new t;return e.invertToRef(i),i},t.RotationXToRef=function(t,e){var i=Math.sin(t),r=Math.cos(t);e.m[0]=1,e.m[15]=1,e.m[5]=r,e.m[10]=r,e.m[9]=-i,e.m[6]=i,e.m[1]=0,e.m[2]=0,e.m[3]=0,e.m[4]=0,e.m[7]=0,e.m[8]=0,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0},t.RotationY=function(e){var i=new t;return t.RotationYToRef(e,i),i},t.RotationYToRef=function(t,e){var i=Math.sin(t),r=Math.cos(t);e.m[5]=1,e.m[15]=1,e.m[0]=r,e.m[2]=-i,e.m[8]=i,e.m[10]=r,e.m[1]=0,e.m[3]=0,e.m[4]=0,e.m[6]=0,e.m[7]=0,e.m[9]=0,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0},t.RotationZ=function(e){var i=new t;return t.RotationZToRef(e,i),i},t.RotationZToRef=function(t,e){var i=Math.sin(t),r=Math.cos(t);e.m[10]=1,e.m[15]=1,e.m[0]=r,e.m[1]=i,e.m[4]=-i,e.m[5]=r,e.m[2]=0,e.m[3]=0,e.m[6]=0,e.m[7]=0,e.m[8]=0,e.m[9]=0,e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0},t.RotationAxis=function(e,i){var r=t.Zero();return t.RotationAxisToRef(e,i,r),r},t.RotationAxisToRef=function(t,e,i){var r=Math.sin(-e),n=Math.cos(-e),s=1-n;t.normalize(),i.m[0]=t.x*t.x*s+n,i.m[1]=t.x*t.y*s-t.z*r,i.m[2]=t.x*t.z*s+t.y*r,i.m[3]=0,i.m[4]=t.y*t.x*s+t.z*r,i.m[5]=t.y*t.y*s+n,i.m[6]=t.y*t.z*s-t.x*r,i.m[7]=0,i.m[8]=t.z*t.x*s-t.y*r,i.m[9]=t.z*t.y*s+t.x*r,i.m[10]=t.z*t.z*s+n,i.m[11]=0,i.m[15]=1},t.RotationYawPitchRoll=function(e,i,r){var n=new t;return t.RotationYawPitchRollToRef(e,i,r,n),n},t.RotationYawPitchRollToRef=function(t,e,i,r){h.RotationYawPitchRollToRef(t,e,i,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(r)},t.Scaling=function(e,i,r){var n=t.Zero();return t.ScalingToRef(e,i,r,n),n},t.ScalingToRef=function(t,e,i,r){r.m[0]=t,r.m[1]=0,r.m[2]=0,r.m[3]=0,r.m[4]=0,r.m[5]=e,r.m[6]=0,r.m[7]=0,r.m[8]=0,r.m[9]=0,r.m[10]=i,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},t.Translation=function(e,i,r){var n=t.Identity();return t.TranslationToRef(e,i,r,n),n},t.TranslationToRef=function(e,i,r,n){t.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,i,r,1,n)},t.Lerp=function(e,i,r){for(var n=t.Zero(),s=0;s<16;s++)n.m[s]=e.m[s]*(1-r)+i.m[s]*r;return n},t.DecomposeLerp=function(e,i,r){var n=new s(0,0,0),o=new h,a=new s(0,0,0);e.decompose(n,o,a);var l=new s(0,0,0),c=new h,u=new s(0,0,0);i.decompose(l,c,u);var p=s.Lerp(n,l,r),d=h.Slerp(o,c,r),f=s.Lerp(a,u,r);return t.Compose(p,d,f)},t.LookAtLH=function(e,i,r){var n=t.Zero();return t.LookAtLHToRef(e,i,r,n),n},t.LookAtLHToRef=function(e,i,r,n){i.subtractToRef(e,this._zAxis),this._zAxis.normalize(),s.CrossToRef(r,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),s.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var o=-s.Dot(this._xAxis,e),a=-s.Dot(this._yAxis,e),h=-s.Dot(this._zAxis,e);return t.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,o,a,h,1,n)},t.LookAtRH=function(e,i,r){var n=t.Zero();return t.LookAtRHToRef(e,i,r,n),n},t.LookAtRHToRef=function(e,i,r,n){e.subtractToRef(i,this._zAxis),this._zAxis.normalize(),s.CrossToRef(r,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),s.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var o=-s.Dot(this._xAxis,e),a=-s.Dot(this._yAxis,e),h=-s.Dot(this._zAxis,e);return t.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,o,a,h,1,n)},t.OrthoLH=function(e,i,r,n){var s=t.Zero();return t.OrthoLHToRef(e,i,r,n,s),s},t.OrthoLHToRef=function(e,i,r,n,s){var o=2/e,a=2/i,h=1/(n-r),l=r/(r-n);t.FromValuesToRef(o,0,0,0,0,a,0,0,0,0,h,0,0,0,l,1,s)},t.OrthoOffCenterLH=function(e,i,r,n,s,o){var a=t.Zero();return t.OrthoOffCenterLHToRef(e,i,r,n,s,o,a),a},t.OrthoOffCenterLHToRef=function(t,e,i,r,n,s,o){o.m[0]=2/(e-t),o.m[1]=o.m[2]=o.m[3]=0,o.m[5]=2/(r-i),o.m[4]=o.m[6]=o.m[7]=0,o.m[10]=1/(s-n),o.m[8]=o.m[9]=o.m[11]=0,o.m[12]=(t+e)/(t-e),o.m[13]=(r+i)/(i-r),o.m[14]=-n/(s-n),o.m[15]=1},t.OrthoOffCenterRH=function(e,i,r,n,s,o){var a=t.Zero();return t.OrthoOffCenterRHToRef(e,i,r,n,s,o,a),a},t.OrthoOffCenterRHToRef=function(e,i,r,n,s,o,a){t.OrthoOffCenterLHToRef(e,i,r,n,s,o,a),a.m[10]*=-1},t.PerspectiveLH=function(e,i,r,n){var s=t.Zero();return s.m[0]=2*r/e,s.m[1]=s.m[2]=s.m[3]=0,s.m[5]=2*r/i,s.m[4]=s.m[6]=s.m[7]=0,s.m[10]=-n/(r-n),s.m[8]=s.m[9]=0,s.m[11]=1,s.m[12]=s.m[13]=s.m[15]=0,s.m[14]=r*n/(r-n),s},t.PerspectiveFovLH=function(e,i,r,n){var s=t.Zero();return t.PerspectiveFovLHToRef(e,i,r,n,s),s},t.PerspectiveFovLHToRef=function(t,e,i,r,n,s){void 0===s&&(s=!0);var o=1/Math.tan(.5*t);n.m[0]=s?o/e:o,n.m[1]=n.m[2]=n.m[3]=0,n.m[5]=s?o:o*e,n.m[4]=n.m[6]=n.m[7]=0,n.m[8]=n.m[9]=0,n.m[10]=r/(r-i),n.m[11]=1,n.m[12]=n.m[13]=n.m[15]=0,n.m[14]=-(i*r)/(r-i)},t.PerspectiveFovRH=function(e,i,r,n){var s=t.Zero();return t.PerspectiveFovRHToRef(e,i,r,n,s),s},t.PerspectiveFovRHToRef=function(t,e,i,r,n,s){void 0===s&&(s=!0);var o=1/Math.tan(.5*t);n.m[0]=s?o/e:o,n.m[1]=n.m[2]=n.m[3]=0,n.m[5]=s?o:o*e,n.m[4]=n.m[6]=n.m[7]=0,n.m[8]=n.m[9]=0,n.m[10]=r/(i-r),n.m[11]=-1,n.m[12]=n.m[13]=n.m[15]=0,n.m[14]=i*r/(i-r)},t.PerspectiveFovWebVRToRef=function(t,e,i,r,n){void 0===n&&(n=!0);var s=Math.tan(t.upDegrees*Math.PI/180),o=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),h=Math.tan(t.rightDegrees*Math.PI/180),l=2/(a+h),c=2/(s+o);r.m[0]=l,r.m[1]=r.m[2]=r.m[3]=r.m[4]=0,r.m[5]=c,r.m[6]=r.m[7]=0,r.m[8]=(a-h)*l*.5,r.m[9]=-((s-o)*c*.5),r.m[10]=-i/(e-i),r.m[11]=1,r.m[12]=r.m[13]=r.m[15]=0,r.m[14]=e*i/(e-i)},t.GetFinalMatrix=function(e,i,r,n,s,o){var a=e.width,h=e.height,l=e.x,c=e.y,u=t.FromValues(a/2,0,0,0,0,-h/2,0,0,0,0,o-s,0,l+a/2,h/2+c,s,1);return i.multiply(r).multiply(n).multiply(u)},t.GetAsMatrix2x2=function(t){return new Float32Array([t.m[0],t.m[1],t.m[4],t.m[5]])},t.GetAsMatrix3x3=function(t){return new Float32Array([t.m[0],t.m[1],t.m[2],t.m[4],t.m[5],t.m[6],t.m[8],t.m[9],t.m[10]])},t.Transpose=function(e){var i=new t;return i.m[0]=e.m[0],i.m[1]=e.m[4],i.m[2]=e.m[8],i.m[3]=e.m[12],i.m[4]=e.m[1],i.m[5]=e.m[5],i.m[6]=e.m[9],i.m[7]=e.m[13],i.m[8]=e.m[2],i.m[9]=e.m[6],i.m[10]=e.m[10],i.m[11]=e.m[14],i.m[12]=e.m[3],i.m[13]=e.m[7],i.m[14]=e.m[11],i.m[15]=e.m[15],i},t.Reflection=function(e){var i=new t;return t.ReflectionToRef(e,i),i},t.ReflectionToRef=function(t,e){t.normalize();var i=t.normal.x,r=t.normal.y,n=t.normal.z,s=-2*i,o=-2*r,a=-2*n;e.m[0]=s*i+1,e.m[1]=o*i,e.m[2]=a*i,e.m[3]=0,e.m[4]=s*r,e.m[5]=o*r+1,e.m[6]=a*r,e.m[7]=0,e.m[8]=s*n,e.m[9]=o*n,e.m[10]=a*n+1,e.m[11]=0,e.m[12]=s*t.d,e.m[13]=o*t.d,e.m[14]=a*t.d,e.m[15]=1},t.FromXYZAxesToRef=function(t,e,i,r){r.m[0]=t.x,r.m[1]=t.y,r.m[2]=t.z,r.m[3]=0,r.m[4]=e.x,r.m[5]=e.y,r.m[6]=e.z,r.m[7]=0,r.m[8]=i.x,r.m[9]=i.y,r.m[10]=i.z,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},t.FromQuaternionToRef=function(t,e){var i=t.x*t.x,r=t.y*t.y,n=t.z*t.z,s=t.x*t.y,o=t.z*t.w,a=t.z*t.x,h=t.y*t.w,l=t.y*t.z,c=t.x*t.w;e.m[0]=1-2*(r+n),e.m[1]=2*(s+o),e.m[2]=2*(a-h),e.m[3]=0,e.m[4]=2*(s-o),e.m[5]=1-2*(n+i),e.m[6]=2*(l+c),e.m[7]=0,e.m[8]=2*(a+h),e.m[9]=2*(l-c),e.m[10]=1-2*(r+i),e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e.m[15]=1},t._tempQuaternion=new h,t._xAxis=s.Zero(),t._yAxis=s.Zero(),t._zAxis=s.Zero(),t}();t.Matrix=l;var c=function(){function t(t,e,i,r){this.normal=new s(t,e,i),this.d=r}return t.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},t.prototype.clone=function(){return new t(this.normal.x,this.normal.y,this.normal.z,this.d)},t.prototype.getClassName=function(){return"Plane"},t.prototype.getHashCode=function(){var t=this.normal.getHashCode();return t=397*t^(this.d||0)},t.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),e=0;return 0!==t&&(e=1/t),this.normal.x*=e,this.normal.y*=e,this.normal.z*=e,this.d*=e,this},t.prototype.transform=function(e){var i=l.Transpose(e),r=this.normal.x,n=this.normal.y,s=this.normal.z,o=this.d;return new t(r*i.m[0]+n*i.m[1]+s*i.m[2]+o*i.m[3],r*i.m[4]+n*i.m[5]+s*i.m[6]+o*i.m[7],r*i.m[8]+n*i.m[9]+s*i.m[10]+o*i.m[11],r*i.m[12]+n*i.m[13]+s*i.m[14]+o*i.m[15])},t.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},t.prototype.copyFromPoints=function(t,e,i){var r,n=e.x-t.x,s=e.y-t.y,o=e.z-t.z,a=i.x-t.x,h=i.y-t.y,l=i.z-t.z,c=s*l-o*h,u=o*a-n*l,p=n*h-s*a,d=Math.sqrt(c*c+u*u+p*p);return r=0!==d?1/d:0,this.normal.x=c*r,this.normal.y=u*r,this.normal.z=p*r,this.d=-(this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z),this},t.prototype.isFrontFacingTo=function(t,e){return s.Dot(this.normal,t)<=e},t.prototype.signedDistanceTo=function(t){return s.Dot(t,this.normal)+this.d},t.FromArray=function(e){return new t(e[0],e[1],e[2],e[3])},t.FromPoints=function(e,i,r){var n=new t(0,0,0,0);return n.copyFromPoints(e,i,r),n},t.FromPositionAndNormal=function(e,i){var r=new t(0,0,0,0);return i.normalize(),r.normal=i,r.d=-(i.x*e.x+i.y*e.y+i.z*e.z),r},t.SignedDistanceToPlaneFromPositionAndNormal=function(t,e,i){var r=-(e.x*t.x+e.y*t.y+e.z*t.z);return s.Dot(i,e)+r},t}();t.Plane=c;var u=function(){function t(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r}return t.prototype.toGlobal=function(e,i){return new t(this.x*e,this.y*i,this.width*e,this.height*i)},t}();t.Viewport=u;var p=function(){function t(){}return t.GetPlanes=function(e){for(var i=[],r=0;r<6;r++)i.push(new c(0,0,0,0));return t.GetPlanesToRef(e,i),i},t.GetPlanesToRef=function(t,e){e[0].normal.x=t.m[3]+t.m[2],e[0].normal.y=t.m[7]+t.m[6],e[0].normal.z=t.m[11]+t.m[10],e[0].d=t.m[15]+t.m[14],e[0].normalize(),e[1].normal.x=t.m[3]-t.m[2],e[1].normal.y=t.m[7]-t.m[6],e[1].normal.z=t.m[11]-t.m[10],e[1].d=t.m[15]-t.m[14],e[1].normalize(),e[2].normal.x=t.m[3]+t.m[0],e[2].normal.y=t.m[7]+t.m[4],e[2].normal.z=t.m[11]+t.m[8],e[2].d=t.m[15]+t.m[12],e[2].normalize(),e[3].normal.x=t.m[3]-t.m[0],e[3].normal.y=t.m[7]-t.m[4],e[3].normal.z=t.m[11]-t.m[8],e[3].d=t.m[15]-t.m[12],e[3].normalize(),e[4].normal.x=t.m[3]-t.m[1],e[4].normal.y=t.m[7]-t.m[5],e[4].normal.z=t.m[11]-t.m[9],e[4].d=t.m[15]-t.m[13],e[4].normalize(),e[5].normal.x=t.m[3]+t.m[1],e[5].normal.y=t.m[7]+t.m[5],e[5].normal.z=t.m[11]+t.m[9],e[5].d=t.m[15]+t.m[13],e[5].normalize()},t}();t.Frustum=p,function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(t.Space||(t.Space={}));var d=(t.Space,function(){function t(){}return t.X=new s(1,0,0),t.Y=new s(0,1,0),t.Z=new s(0,0,1),t}());t.Axis=d;var f=function(){function t(){}return t.interpolate=function(t,e,i,r,n){for(var s=1-3*r+3*e,o=3*r-6*e,a=3*e,h=t,l=0;l<5;l++){var c=h*h;h-=(s*(c*h)+o*c+a*h-t)*(1/(3*s*c+2*o*h+a)),h=Math.min(1,Math.max(0,h))}return 3*Math.pow(1-h,2)*h*i+3*(1-h)*Math.pow(h,2)*n+Math.pow(h,3)},t}();t.BezierCurve=f,function(t){t[t.CW=0]="CW",t[t.CCW=1]="CCW"}(t.Orientation||(t.Orientation={}));var m=t.Orientation,_=function(){function t(t){var e=this;this.degrees=function(){return 180*e._radians/Math.PI},this.radians=function(){return e._radians},this._radians=t,this._radians<0&&(this._radians+=2*Math.PI)}return t.BetweenTwoPoints=function(e,i){var r=i.subtract(e);return new t(Math.atan2(r.y,r.x))},t.FromRadians=function(e){return new t(e)},t.FromDegrees=function(e){return new t(e*Math.PI/180)},t}();t.Angle=_;var g=function(){function t(t,e,i){this.startPoint=t,this.midPoint=e,this.endPoint=i;var r=Math.pow(e.x,2)+Math.pow(e.y,2),s=(Math.pow(t.x,2)+Math.pow(t.y,2)-r)/2,o=(r-Math.pow(i.x,2)-Math.pow(i.y,2))/2,a=(t.x-e.x)*(e.y-i.y)-(e.x-i.x)*(t.y-e.y);this.centerPoint=new n((s*(e.y-i.y)-o*(t.y-e.y))/a,((t.x-e.x)*o-(e.x-i.x)*s)/a),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=_.BetweenTwoPoints(this.centerPoint,this.startPoint);var h=this.startAngle.degrees(),l=_.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),c=_.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();l-h>180&&(l-=360),l-h<-180&&(l+=360),c-l>180&&(c-=360),c-l<-180&&(c+=360),this.orientation=l-h<0?m.CW:m.CCW,this.angle=_.FromDegrees(this.orientation===m.CW?h-c:c-h)}return t}();t.Arc2=g;var y=function(){function t(t,e){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new n(t,e))}return t.prototype.addLineTo=function(t,e){if(closed)return this;var i=new n(t,e),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this},t.prototype.addArcTo=function(t,e,i,r,s){if(void 0===s&&(s=36),closed)return this;var o=this._points[this._points.length-1],a=new n(t,e),h=new n(i,r),l=new g(o,a,h),c=l.angle.radians()/s;l.orientation===m.CW&&(c*=-1);for(var u=l.startAngle.radians()+c,p=0;p<s;p++){var d=Math.cos(u)*l.radius+l.centerPoint.x,f=Math.sin(u)*l.radius+l.centerPoint.y;this.addLineTo(d,f),u+=c}return this},t.prototype.close=function(){return this.closed=!0,this},t.prototype.length=function(){var t=this._length;if(!this.closed){var e=this._points[this._points.length-1];t+=this._points[0].subtract(e).length()}return t},t.prototype.getPoints=function(){return this._points},t.prototype.getPointAtLengthPosition=function(t){if(t<0||t>1)return n.Zero();for(var e=t*this.length(),i=0,r=0;r<this._points.length;r++){var s=(r+1)%this._points.length,o=this._points[r],a=this._points[s],h=a.subtract(o),l=h.length()+i;if(e>=i&&e<=l){var c=h.normalize(),u=e-i;return new n(o.x+c.x*u,o.y+c.y*u)}i=l}return n.Zero()},t.StartingAt=function(e,i){return new t(e,i)},t}();t.Path2=y;var v=function(){function i(t,e,i){this.path=t,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array;for(var r=0;r<t.length;r++)this._curve[r]=t[r].clone();this._raw=i||!1,this._compute(e)}return i.prototype.getCurve=function(){return this._curve},i.prototype.getTangents=function(){return this._tangents},i.prototype.getNormals=function(){return this._normals},i.prototype.getBinormals=function(){return this._binormals},i.prototype.getDistances=function(){return this._distances},i.prototype.update=function(t,e){for(var i=0;i<t.length;i++)this._curve[i].x=t[i].x,this._curve[i].y=t[i].y,this._curve[i].z=t[i].z;return this._compute(e),this},i.prototype._compute=function(t){var e=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[e-1]=this._curve[e-1].subtract(this._curve[e-2]),this._raw||this._tangents[e-1].normalize();var i=this._tangents[0],r=this._normalVector(this._curve[0],i,t);this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=s.Cross(i,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var n,o,a,h,l=1;l<e;l++)n=this._getLastNonNullVector(l),l<e-1&&(o=this._getFirstNonNullVector(l),this._tangents[l]=n.add(o),this._tangents[l].normalize()),this._distances[l]=this._distances[l-1]+n.length(),a=this._tangents[l],h=this._binormals[l-1],this._normals[l]=s.Cross(h,a),this._raw||this._normals[l].normalize(),this._binormals[l]=s.Cross(a,this._normals[l]),this._raw||this._binormals[l].normalize()},i.prototype._getFirstNonNullVector=function(t){for(var e=1,i=this._curve[t+e].subtract(this._curve[t]);0===i.length()&&t+e+1<this._curve.length;)e++,i=this._curve[t+e].subtract(this._curve[t]);return i},i.prototype._getLastNonNullVector=function(t){for(var e=1,i=this._curve[t].subtract(this._curve[t-e]);0===i.length()&&t>e+1;)e++,i=this._curve[t].subtract(this._curve[t-e]);return i},i.prototype._normalVector=function(i,r,n){var o,a=r.length();if(0===a&&(a=1),void 0===n||null===n){var h;e.WithinEpsilon(Math.abs(r.y)/a,1,t.Epsilon)?e.WithinEpsilon(Math.abs(r.x)/a,1,t.Epsilon)?e.WithinEpsilon(Math.abs(r.z)/a,1,t.Epsilon)||(h=new s(0,0,1)):h=new s(1,0,0):h=new s(0,-1,0),o=s.Cross(r,h)}else o=s.Cross(r,n),s.CrossToRef(o,r,o);return o.normalize(),o},i}();t.Path3D=v;var x=function(){function t(t){this._length=0,this._points=t,this._length=this._computeLength(t)}return t.CreateQuadraticBezier=function(e,i,r,n){n=n>2?n:3;for(var o=new Array,a=function(t,e,i,r){return(1-t)*(1-t)*e+2*t*(1-t)*i+t*t*r},h=0;h<=n;h++)o.push(new s(a(h/n,e.x,i.x,r.x),a(h/n,e.y,i.y,r.y),a(h/n,e.z,i.z,r.z)));return new t(o)},t.CreateCubicBezier=function(e,i,r,n,o){o=o>3?o:4;for(var a=new Array,h=function(t,e,i,r,n){return(1-t)*(1-t)*(1-t)*e+3*t*(1-t)*(1-t)*i+3*t*t*(1-t)*r+t*t*t*n},l=0;l<=o;l++)a.push(new s(h(l/o,e.x,i.x,r.x,n.x),h(l/o,e.y,i.y,r.y,n.y),h(l/o,e.z,i.z,r.z,n.z)));return new t(a)},t.CreateHermiteSpline=function(e,i,r,n,o){for(var a=new Array,h=1/o,l=0;l<=o;l++)a.push(s.Hermite(e,i,r,n,l*h));return new t(a)},t.prototype.getPoints=function(){return this._points},t.prototype.length=function(){return this._length},t.prototype.continue=function(e){for(var i=this._points[this._points.length-1],r=this._points.slice(),n=e.getPoints(),s=1;s<n.length;s++)r.push(n[s].subtract(n[0]).add(i));return new t(r)},t.prototype._computeLength=function(t){for(var e=0,i=1;i<t.length;i++)e+=t[i].subtract(t[i-1]).length();return e},t}();t.Curve3=x;var b=function(){function t(){this.L00=s.Zero(),this.L1_1=s.Zero(),this.L10=s.Zero(),this.L11=s.Zero(),this.L2_2=s.Zero(),this.L2_1=s.Zero(),this.L20=s.Zero(),this.L21=s.Zero(),this.L22=s.Zero()}return t.prototype.addLight=function(t,e,i){var r=new s(e.r,e.g,e.b),n=r.scale(i);this.L00=this.L00.add(n.scale(.282095)),this.L1_1=this.L1_1.add(n.scale(.488603*t.y)),this.L10=this.L10.add(n.scale(.488603*t.z)),this.L11=this.L11.add(n.scale(.488603*t.x)),this.L2_2=this.L2_2.add(n.scale(1.092548*t.x*t.y)),this.L2_1=this.L2_1.add(n.scale(1.092548*t.y*t.z)),this.L21=this.L21.add(n.scale(1.092548*t.x*t.z)),this.L20=this.L20.add(n.scale(.315392*(3*t.z*t.z-1))),this.L22=this.L22.add(n.scale(.546274*(t.x*t.x-t.y*t.y)))},t.prototype.scale=function(t){this.L00=this.L00.scale(t),this.L1_1=this.L1_1.scale(t),this.L10=this.L10.scale(t),this.L11=this.L11.scale(t),this.L2_2=this.L2_2.scale(t),this.L2_1=this.L2_1.scale(t),this.L20=this.L20.scale(t),this.L21=this.L21.scale(t),this.L22=this.L22.scale(t)},t}();t.SphericalHarmonics=b;var P=function(){function t(){this.x=s.Zero(),this.y=s.Zero(),this.z=s.Zero(),this.xx=s.Zero(),this.yy=s.Zero(),this.zz=s.Zero(),this.xy=s.Zero(),this.yz=s.Zero(),this.zx=s.Zero()}return t.prototype.addAmbient=function(t){var e=new s(t.r,t.g,t.b);this.xx=this.xx.add(e),this.yy=this.yy.add(e),this.zz=this.zz.add(e)},t.getSphericalPolynomialFromHarmonics=function(e){var i=new t;return i.x=e.L11.scale(1.02333),i.y=e.L1_1.scale(1.02333),i.z=e.L10.scale(1.02333),i.xx=e.L00.scale(.886277).subtract(e.L20.scale(.247708)).add(e.L22.scale(.429043)),i.yy=e.L00.scale(.886277).subtract(e.L20.scale(.247708)).subtract(e.L22.scale(.429043)),i.zz=e.L00.scale(.886277).add(e.L20.scale(.495417)),i.yz=e.L2_1.scale(.858086),i.zx=e.L21.scale(.858086),i.xy=e.L2_2.scale(.858086),i},t}();t.SphericalPolynomial=P;var T=function(){function t(t,e){void 0===t&&(t=s.Zero()),void 0===e&&(e=s.Up()),this.position=t,this.normal=e}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone())},t}();t.PositionNormalVertex=T;var S=function(){function t(t,e,i){void 0===t&&(t=s.Zero()),void 0===e&&(e=s.Up()),void 0===i&&(i=n.Zero()),this.position=t,this.normal=e,this.uv=i}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone(),this.uv.clone())},t}();t.PositionNormalTextureVertex=S;var A=function(){function t(){}return t.Color3=[i.Black(),i.Black(),i.Black()],t.Vector2=[n.Zero(),n.Zero(),n.Zero()],t.Vector3=[s.Zero(),s.Zero(),s.Zero(),s.Zero(),s.Zero(),s.Zero(),s.Zero(),s.Zero(),s.Zero()],t.Vector4=[o.Zero(),o.Zero(),o.Zero()],t.Quaternion=[new h(0,0,0,0)],t.Matrix=[l.Zero(),l.Zero(),l.Zero(),l.Zero(),l.Zero(),l.Zero(),l.Zero(),l.Zero()],t}();t.Tmp=A}(r||(r={}));var r;!function(t){function e(t,e){return function(i,r){i.__serializableMembers||(i.__serializableMembers={}),i.__serializableMembers[r]||(i.__serializableMembers[r]={type:t,sourceName:e})}}function i(t){return e(0,t)}function r(t){return e(1,t)}function n(t){return e(2,t)}function s(t){return e(3,t)}function o(t){return e(4,t)}function a(t){return e(5,t)}function h(t){return e(6,t)}function l(t){return e(7,t)}t.serialize=i,t.serializeAsTexture=r,t.serializeAsColor3=n,t.serializeAsFresnelParameters=s,t.serializeAsVector2=o,t.serializeAsVector3=a,t.serializeAsMeshReference=h,t.serializeAsColorCurves=l;var c=function(){function e(){}return e.Serialize=function(e,i){i||(i={}),i.tags=t.Tags.GetTags(e);for(var r in e.__serializableMembers){var n=e.__serializableMembers[r],s=n.sourceName||r,o=n.type,a=e[r];if(void 0!==a&&null!==a)switch(o){case 0:i[s]=a;break;case 1:i[s]=a.serialize();break;case 2:i[s]=a.asArray();break;case 3:i[s]=a.serialize();break;case 4:i[s]=a.asArray();break;case 5:i[s]=a.asArray();break;case 6:i[s]=a.id;break;case 7:i[s]=a.serialize()}}return i},e.Parse=function(e,i,r,n){var s=e();t.Tags.AddTagsTo(s,i.tags);for(var o in s.__serializableMembers){var a=s.__serializableMembers[o],h=i[a.sourceName||o],l=a.type;if(void 0!==h&&null!==h)switch(l){case 0:s[o]=h;break;case 1:s[o]=t.Texture.Parse(h,r,n);break;case 2:s[o]=t.Color3.FromArray(h);break;case 3:s[o]=t.FresnelParameters.Parse(h);break;case 4:s[o]=t.Vector2.FromArray(h);break;case 5:s[o]=t.Vector3.FromArray(h);break;case 6:s[o]=r.getLastMeshByID(h);break;case 7:s[o]=t.ColorCurves.Parse(h)}}return s},e.Clone=function(e,i){var r=e();t.Tags.AddTagsTo(r,i.tags);for(var n in r.__serializableMembers){var s=r.__serializableMembers[n],o=i[n],a=s.type;if(void 0!==o&&null!==o)switch(a){case 0:case 6:r[n]=o;break;case 1:case 2:case 3:case 4:case 5:case 7:r[n]=o.clone()}}return r},e}();t.SerializationHelper=c}(r||(r={}));var r;!function(t){var e=function(){function t(t,e){void 0===e&&(e=!1),this.initalize(t,e)}return t.prototype.initalize=function(t,e){return void 0===e&&(e=!1),this.mask=t,this.skipNextObservers=e,this},t}();t.EventState=e;var i=function(){function t(t,e){this.callback=t,this.mask=e}return t}();t.Observer=i;var r=function(){function t(){this._observers=new Array,this._eventState=new e(0)}return t.prototype.add=function(t,e,r){if(void 0===e&&(e=-1),void 0===r&&(r=!1),!t)return null;var n=new i(t,e);return r?this._observers.unshift(n):this._observers.push(n),n},t.prototype.remove=function(t){var e=this._observers.indexOf(t);return e!==-1&&(this._observers.splice(e,1),!0)},t.prototype.removeCallback=function(t){for(var e=0;e<this._observers.length;e++)if(this._observers[e].callback===t)return this._observers.splice(e,1),!0;return!1},t.prototype.notifyObservers=function(t,e){void 0===e&&(e=-1);var i=this._eventState;i.mask=e,i.skipNextObservers=!1;for(var r=0,n=this._observers;r<n.length;r++){var s=n[r];if(s.mask&e&&s.callback(t,i),i.skipNextObservers)return!1}return!0},t.prototype.hasObservers=function(){return this._observers.length>0},t.prototype.clear=function(){this._observers=new Array},t.prototype.clone=function(){var e=new t;return e._observers=this._observers.slice(0),e},t}();t.Observable=r}(r||(r={}));var r;!function(t){var e=function(){function e(t,i){this.idbFactory=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,this.callbackManifestChecked=i,this.currentSceneUrl=e.ReturnFullUrlLocation(t),this.db=null,this.enableSceneOffline=!1,this.enableTexturesOffline=!1,this.manifestVersionFound=0,this.mustUpdateRessources=!1,this.hasReachedQuota=!1,e.IDBStorageEnabled?this.checkManifestFile():this.callbackManifestChecked(!0)}return e.prototype.checkManifestFile=function(){function e(){r.enableSceneOffline=!1,r.enableTexturesOffline=!1,r.callbackManifestChecked(!1)}var i=this,r=this,n=!1,s=this.currentSceneUrl+".manifest",o=new XMLHttpRequest;navigator.onLine&&(n=!0,s=s+(null==s.match(/\?/)?"?":"&")+(new Date).getTime()),o.open("GET",s,!0),o.addEventListener("load",function(){if(200===o.status||t.Tools.ValidateXHRData(o,1))try{var r=JSON.parse(o.response);i.enableSceneOffline=r.enableSceneOffline,i.enableTexturesOffline=r.enableTexturesOffline,r.version&&!isNaN(parseInt(r.version))&&(i.manifestVersionFound=r.version),i.callbackManifestChecked&&i.callbackManifestChecked(!0)}catch(t){e()}else e()},!1),o.addEventListener("error",function(t){if(n){n=!1;var r=i.currentSceneUrl+".manifest";o.open("GET",r,!0),o.send()}else e()},!1);try{o.send()}catch(e){t.Tools.Error("Error on XHR send request."),r.callbackManifestChecked(!1)}},e.prototype.openAsync=function(e,i){function r(){s.isSupported=!1,i&&i()}var n=this,s=this;if(this.idbFactory&&(this.enableSceneOffline||this.enableTexturesOffline))if(this.db)e&&e();else{this.hasReachedQuota=!1,this.isSupported=!0;var o=this.idbFactory.open("babylonjs",1);o.onerror=function(t){r()},o.onblocked=function(e){t.Tools.Error("IDB request blocked. Please reload the page."),r()},o.onsuccess=function(t){n.db=o.result,e()},o.onupgradeneeded=function(e){n.db=e.target.result;try{n.db.createObjectStore("scenes",{keyPath:"sceneUrl"}),n.db.createObjectStore("versions",{keyPath:"sceneUrl"}),n.db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(e){t.Tools.Error("Error while creating object stores. Exception: "+e.message),r()}}}else this.isSupported=!1,i&&i()},e.prototype.loadImageFromDB=function(t,i){var r=this,n=e.ReturnFullUrlLocation(t),s=function(){r.hasReachedQuota||null===r.db?i.src=t:r._saveImageIntoDBAsync(n,i)};this.mustUpdateRessources?s():this._loadImageFromDBAsync(n,i,s)},e.prototype._loadImageFromDBAsync=function(e,i,r){if(this.isSupported&&null!==this.db){var n,s=this.db.transaction(["textures"]);s.onabort=function(t){i.src=e},s.oncomplete=function(s){var o;if(n){o=(window.URL||window.webkitURL).createObjectURL(n.data,{oneTimeOnly:!0}),i.onerror=function(){t.Tools.Error("Error loading image from blob URL: "+o+" switching back to web url: "+e),i.src=e},i.src=o}else r()};var o=s.objectStore("textures").get(e);o.onsuccess=function(t){n=t.target.result},o.onerror=function(r){t.Tools.Error("Error loading texture "+e+" from DB."),i.src=e}}else t.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i.src=e},e.prototype._saveImageIntoDBAsync=function(i,r){var n=this;if(this.isSupported){var s=function(){var t;if(o){var e=window.URL||window.webkitURL;try{t=e.createObjectURL(o,{oneTimeOnly:!0})}catch(i){t=e.createObjectURL(o)}}r.src=t};if(e.IsUASupportingBlobStorage){var o,a=new XMLHttpRequest;a.open("GET",i,!0),a.responseType="blob",a.addEventListener("load",function(){if(200===a.status){o=a.response;var t=n.db.transaction(["textures"],"readwrite");t.onabort=function(t){try{t.srcElement.error&&"QuotaExceededError"===t.srcElement.error.name&&(n.hasReachedQuota=!0)}catch(t){}s()},t.oncomplete=function(t){s()};var h={textureUrl:i,data:o};try{var l=t.objectStore("textures").put(h);l.onsuccess=function(t){},l.onerror=function(t){s()}}catch(t){25===t.code&&(e.IsUASupportingBlobStorage=!1),r.src=i}}else r.src=i},!1),a.addEventListener("error",function(e){t.Tools.Error("Error in XHR request in BABYLON.Database."),r.src=i},!1),a.send()}else r.src=i}else t.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),r.src=i},e.prototype._checkVersionFromDB=function(t,e){var i=this,r=function(r){i._saveVersionIntoDBAsync(t,e)};this._loadVersionFromDBAsync(t,e,r)},e.prototype._loadVersionFromDBAsync=function(e,i,r){var n=this;if(this.isSupported){var s;try{var o=this.db.transaction(["versions"]);o.oncomplete=function(t){s?n.manifestVersionFound>s.data?(n.mustUpdateRessources=!0,r()):i(s.data):(n.mustUpdateRessources=!0,r())},o.onabort=function(t){i(-1)};var a=o.objectStore("versions").get(e);a.onsuccess=function(t){s=t.target.result},a.onerror=function(r){t.Tools.Error("Error loading version for scene "+e+" from DB."),i(-1)}}catch(e){t.Tools.Error("Error while accessing 'versions' object store (READ OP). Exception: "+e.message),i(-1)}}else t.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i(-1)},e.prototype._saveVersionIntoDBAsync=function(e,i){var r=this;if(this.isSupported&&!this.hasReachedQuota)try{var n=this.db.transaction(["versions"],"readwrite");n.onabort=function(t){try{t.srcElement.error&&"QuotaExceededError"===t.srcElement.error.name&&(r.hasReachedQuota=!0)}catch(t){}i(-1)},n.oncomplete=function(t){i(r.manifestVersionFound)};var s={sceneUrl:e,data:this.manifestVersionFound},o=n.objectStore("versions").put(s);o.onsuccess=function(t){},o.onerror=function(e){t.Tools.Error("Error in DB add version request in BABYLON.Database.")}}catch(e){t.Tools.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+e.message),i(-1)}else i(-1)},e.prototype.loadFileFromDB=function(t,i,r,n,s){var o=this,a=e.ReturnFullUrlLocation(t),h=function(t){o._saveFileIntoDBAsync(a,i,r)};this._checkVersionFromDB(a,function(t){t!==-1?o.mustUpdateRessources?o._saveFileIntoDBAsync(a,i,r,s):o._loadFileFromDBAsync(a,i,h,s):n()})},e.prototype._loadFileFromDBAsync=function(e,i,r,n){if(this.isSupported){var s;s=e.indexOf(".babylon")!==-1?"scenes":"textures";var o,a=this.db.transaction([s]);a.oncomplete=function(t){o?i(o.data):r()},a.onabort=function(t){r()};var h=a.objectStore(s).get(e);h.onsuccess=function(t){o=t.target.result},h.onerror=function(i){t.Tools.Error("Error loading file "+e+" from DB."),r()}}else t.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i()},e.prototype._saveFileIntoDBAsync=function(e,i,r,n){var s=this;if(this.isSupported){var o;o=e.indexOf(".babylon")!==-1?"scenes":"textures";var a,h=new XMLHttpRequest;h.open("GET",e,!0),n&&(h.responseType="arraybuffer"),h.onprogress=r,h.addEventListener("load",function(){if(200===h.status||t.Tools.ValidateXHRData(h,n?6:1))if(a=n?h.response:h.responseText,s.hasReachedQuota)i(a);else{var r=s.db.transaction([o],"readwrite");r.onabort=function(t){try{t.srcElement.error&&"QuotaExceededError"===t.srcElement.error.name&&(s.hasReachedQuota=!0)}catch(t){}i(a)},r.oncomplete=function(t){i(a)};var l;l="scenes"===o?{sceneUrl:e,data:a,version:s.manifestVersionFound}:{textureUrl:e,data:a};try{var c=r.objectStore(o).put(l);c.onsuccess=function(t){},c.onerror=function(e){t.Tools.Error("Error in DB add file request in BABYLON.Database.")}}catch(t){i(a)}}else i()},!1),h.addEventListener("error",function(e){t.Tools.Error("error on XHR request."),i()},!1),h.send()}else t.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i()},e.IsUASupportingBlobStorage=!0,e.IDBStorageEnabled=!0,e.parseURL=function(t){document.createElement("a").href=t;var e=t.substring(0,t.lastIndexOf("#")),i=t.substring(e.lastIndexOf("/")+1,t.length);return t.substring(0,t.indexOf(i,0))},e.ReturnFullUrlLocation=function(t){return t.indexOf("http:/")===-1?e.parseURL(window.location.href)+t:t},e}();t.Database=e}(r||(r={}));var r;!function(t){!function(e){var i=function(){function e(){}return e.GetTGAHeader=function(t){var e=0;return{id_length:t[e++],colormap_type:t[e++],image_type:t[e++],colormap_index:t[e++]|t[e++]<<8,colormap_length:t[e++]|t[e++]<<8,colormap_size:t[e++],origin:[t[e++]|t[e++]<<8,t[e++]|t[e++]<<8],width:t[e++]|t[e++]<<8,height:t[e++]|t[e++]<<8,pixel_size:t[e++],flags:t[e++]}},e.UploadContent=function(i,r){if(r.length<19)return void t.Tools.Error("Unable to load TGA file - Not enough data to contain header");var n=18,s=e.GetTGAHeader(r);if(s.id_length+n>r.length)return void t.Tools.Error("Unable to load TGA file - Not enough data");n+=s.id_length;var o=!1,a=!1,h=!1;switch(s.image_type){case e._TYPE_RLE_INDEXED:o=!0;case e._TYPE_INDEXED:a=!0;break;case e._TYPE_RLE_RGB:o=!0;case e._TYPE_RGB:!0;break;case e._TYPE_RLE_GREY:o=!0;case e._TYPE_GREY:h=!0}var l,c,u=(s.flags,s.pixel_size>>3),p=s.width*s.height*u;if(a&&(c=r.subarray(n,n+=s.colormap_length*(s.colormap_size>>3))),o){l=new Uint8Array(p);for(var d,f,m,_=0,g=new Uint8Array(u);n<p&&_<p;)if(d=r[n++],f=1+(127&d),128&d){for(m=0;m<u;++m)g[m]=r[n++];for(m=0;m<f;++m)l.set(g,_+m*u);_+=u*f}else{for(f*=u,m=0;m<f;++m)l[_+m]=r[n++];_+=f}}else l=r.subarray(n,n+=a?s.width*s.height:p);var y,v,x,b,P,T;switch((s.flags&e._ORIGIN_MASK)>>e._ORIGIN_SHIFT){default:case e._ORIGIN_UL:y=0,x=1,T=s.width,v=0,b=1,P=s.height;break;case e._ORIGIN_BL:y=0,x=1,T=s.width,v=s.height-1,b=-1,P=-1;break;case e._ORIGIN_UR:y=s.width-1,x=-1,T=-1,v=0,b=1,P=s.height;break;case e._ORIGIN_BR:y=s.width-1,x=-1,T=-1,v=s.height-1,b=-1,P=-1}var S="_getImageData"+(h?"Grey":"")+s.pixel_size+"bits",A=e[S](s,c,l,v,b,P,y,x,T);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,s.width,s.height,0,i.RGBA,i.UNSIGNED_BYTE,A)},e._getImageData8bits=function(t,e,i,r,n,s,o,a,h){var l,c,u,p=i,d=e,f=t.width,m=t.height,_=0,g=new Uint8Array(f*m*4);for(u=r;u!==s;u+=n)for(c=o;c!==h;c+=a,_++)l=p[_],g[4*(c+f*u)+3]=255,g[4*(c+f*u)+2]=d[3*l+0],g[4*(c+f*u)+1]=d[3*l+1],g[4*(c+f*u)+0]=d[3*l+2];return g},e._getImageData16bits=function(t,e,i,r,n,s,o,a,h){var l,c,u,p=i,d=t.width,f=t.height,m=0,_=new Uint8Array(d*f*4);for(u=r;u!==s;u+=n)for(c=o;c!==h;c+=a,m+=2)l=p[m+0]+(p[m+1]<<8),_[4*(c+d*u)+0]=(31744&l)>>7,_[4*(c+d*u)+1]=(992&l)>>2,_[4*(c+d*u)+2]=(31&l)>>3,_[4*(c+d*u)+3]=32768&l?0:255;return _},e._getImageData24bits=function(t,e,i,r,n,s,o,a,h){var l,c,u=i,p=t.width,d=t.height,f=0,m=new Uint8Array(p*d*4);for(c=r;c!==s;c+=n)for(l=o;l!==h;l+=a,f+=3)m[4*(l+p*c)+3]=255,m[4*(l+p*c)+2]=u[f+0],m[4*(l+p*c)+1]=u[f+1],m[4*(l+p*c)+0]=u[f+2];return m},e._getImageData32bits=function(t,e,i,r,n,s,o,a,h){var l,c,u=i,p=t.width,d=t.height,f=0,m=new Uint8Array(p*d*4);for(c=r;c!==s;c+=n)for(l=o;l!==h;l+=a,f+=4)m[4*(l+p*c)+2]=u[f+0],m[4*(l+p*c)+1]=u[f+1],m[4*(l+p*c)+0]=u[f+2],m[4*(l+p*c)+3]=u[f+3];return m},e._getImageDataGrey8bits=function(t,e,i,r,n,s,o,a,h){var l,c,u,p=i,d=t.width,f=t.height,m=0,_=new Uint8Array(d*f*4);for(u=r;u!==s;u+=n)for(c=o;c!==h;c+=a,m++)l=p[m],_[4*(c+d*u)+0]=l,_[4*(c+d*u)+1]=l,_[4*(c+d*u)+2]=l,_[4*(c+d*u)+3]=255;return _},e._getImageDataGrey16bits=function(t,e,i,r,n,s,o,a,h){var l,c,u=i,p=t.width,d=t.height,f=0,m=new Uint8Array(p*d*4);for(c=r;c!==s;c+=n)for(l=o;l!==h;l+=a,f+=2)m[4*(l+p*c)+0]=u[f+0],m[4*(l+p*c)+1]=u[f+0],m[4*(l+p*c)+2]=u[f+0],m[4*(l+p*c)+3]=u[f+1];return m},e._TYPE_NO_DATA=0,e._TYPE_INDEXED=1,e._TYPE_RGB=2,e._TYPE_GREY=3,e._TYPE_RLE_INDEXED=9,e._TYPE_RLE_RGB=10,e._TYPE_RLE_GREY=11,e._ORIGIN_MASK=48,e._ORIGIN_SHIFT=4,e._ORIGIN_BL=0,e._ORIGIN_BR=1,e._ORIGIN_UL=2,e._ORIGIN_UR=3,e}();e.TGATools=i}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(){function t(e){this.length=0,this._duplicateId=0,this.data=new Array(e),this._id=t._GlobalId++}return t.prototype.push=function(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2),t.__smartArrayFlags||(t.__smartArrayFlags={}),t.__smartArrayFlags[this._id]=this._duplicateId},t.prototype.pushNoDuplicate=function(t){return(!t.__smartArrayFlags||t.__smartArrayFlags[this._id]!==this._duplicateId)&&(this.push(t),!0)},t.prototype.sort=function(t){this.data.sort(t)},t.prototype.reset=function(){this.length=0,this._duplicateId++},t.prototype.concat=function(t){if(0!==t.length){this.length+t.length>this.data.length&&(this.data.length=2*(this.length+t.length));for(var e=0;e<t.length;e++)this.data[this.length++]=(t.data||t)[e]}},t.prototype.concatWithNoDuplicate=function(t){if(0!==t.length){this.length+t.length>this.data.length&&(this.data.length=2*(this.length+t.length));for(var e=0;e<t.length;e++){var i=(t.data||t)[e];this.pushNoDuplicate(i)}}},t.prototype.indexOf=function(t){var e=this.data.indexOf(t);return e>=this.length?-1:e},t._GlobalId=0,t}();t.SmartArray=e}(r||(r={}));var r;!function(t){var e=function(){function t(){this._count=0,this._data={}}return t.prototype.copyFrom=function(t){var e=this;this.clear(),t.forEach(function(t,i){return e.add(t,i)})},t.prototype.get=function(t){var e=this._data[t];if(void 0!==e)return e},t.prototype.getOrAddWithFactory=function(t,e){var i=this.get(t);return void 0!==i?i:(i=e(t),i&&this.add(t,i),i)},t.prototype.getOrAdd=function(t,e){var i=this.get(t);return void 0!==i?i:(this.add(t,e),e)},t.prototype.contains=function(t){return void 0!==this._data[t]},t.prototype.add=function(t,e){return void 0===this._data[t]&&(this._data[t]=e,++this._count,!0)},t.prototype.set=function(t,e){return void 0!==this._data[t]&&(this._data[t]=e,!0)},t.prototype.getAndRemove=function(t){var e=this.get(t);return void 0!==e?(delete this._data[t],--this._count,e):null},t.prototype.remove=function(t){return!!this.contains(t)&&(delete this._data[t],--this._count,!0)},t.prototype.clear=function(){this._data={},this._count=0},Object.defineProperty(t.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t){for(var e in this._data){t(e,this._data[e])}},t.prototype.first=function(t){for(var e in this._data){var i=this._data[e],r=t(e,i);if(r)return r}return null},t}();t.StringDictionary=e}(r||(r={}));var r;!function(t){function e(t,e){return function(i){i.__bjsclassName__=t,i.__bjsmoduleName__=null!=e?e:null}}var i,r=function(e,i){return e?e instanceof t.Mesh?null:e instanceof t.SubMesh?e.clone(i):e.clone?e.clone():null:null},s=function(){function e(){}return e.Instantiate=function(t){for(var e=t.split("."),i=window||this,r=0,n=e.length;r<n;r++)i=i[e[r]];return"function"!=typeof i?null:i},e.SetImmediate=function(t){window.setImmediate?window.setImmediate(t):setTimeout(t,1)},e.IsExponentOfTwo=function(t){var e=1;do{e*=2}while(e<t);return e===t},e.GetExponentOfTwo=function(t,e){var i=1;do{i*=2}while(i<t);return i>e&&(i=e),i},e.GetFilename=function(t){var e=t.lastIndexOf("/");return e<0?t:t.substring(e+1)},e.GetDOMTextContent=function(t){for(var e="",i=t.firstChild;i;)3===i.nodeType&&(e+=i.textContent),i=i.nextSibling;return e},e.ToDegrees=function(t){return 180*t/Math.PI},e.ToRadians=function(t){return t*Math.PI/180},e.EncodeArrayBufferTobase64=function(t){for(var e,i,r,n,s,o,a,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",c=0,u=new Uint8Array(t);c<u.length;)e=u[c++],i=c<u.length?u[c++]:Number.NaN,r=c<u.length?u[c++]:Number.NaN,n=e>>2,s=(3&e)<<4|i>>4,o=(15&i)<<2|r>>6,a=63&r,isNaN(i)?o=a=64:isNaN(r)&&(a=64),l+=h.charAt(n)+h.charAt(s)+h.charAt(o)+h.charAt(a);return"data:image/png;base64,"+l},e.ExtractMinAndMaxIndexed=function(e,i,r,n,s){void 0===s&&(s=null);for(var o=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new t.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),h=r;h<r+n;h++){var l=new t.Vector3(e[3*i[h]],e[3*i[h]+1],e[3*i[h]+2]);o=t.Vector3.Minimize(l,o),a=t.Vector3.Maximize(l,a)}return s&&(o.x-=o.x*s.x+s.y,o.y-=o.y*s.x+s.y,o.z-=o.z*s.x+s.y,a.x+=a.x*s.x+s.y,a.y+=a.y*s.x+s.y,a.z+=a.z*s.x+s.y),{minimum:o,maximum:a}},e.ExtractMinAndMax=function(e,i,r,n,s){void 0===n&&(n=null);var o=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new t.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);s||(s=3);for(var h=i;h<i+r;h++){var l=new t.Vector3(e[h*s],e[h*s+1],e[h*s+2]);o=t.Vector3.Minimize(l,o),a=t.Vector3.Maximize(l,a)}return n&&(o.x-=o.x*n.x+n.y,o.y-=o.y*n.x+n.y,o.z-=o.z*n.x+n.y,a.x+=a.x*n.x+n.y,a.y+=a.y*n.x+n.y,a.z+=a.z*n.x+n.y),{minimum:o,maximum:a}},e.Vector2ArrayFeeder=function(e){return function(i){var r=void 0!==e.BYTES_PER_ELEMENT;if(i>=(r?e.length/2:e.length))return null;if(r){var n=e;return new t.Vector2(n[2*i+0],n[2*i+1])}return e[i]}},e.ExtractMinAndMaxVector2=function(e,i){void 0===i&&(i=null);for(var r=new t.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),n=new t.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),s=0,o=e(s++);o;)r=t.Vector2.Minimize(o,r),n=t.Vector2.Maximize(o,n),o=e(s++);return i&&(r.x-=r.x*i.x+i.y,r.y-=r.y*i.x+i.y,n.x+=n.x*i.x+i.y,n.y+=n.y*i.x+i.y),{minimum:r,maximum:n}},e.MakeArray=function(t,e){if(e===!0||void 0!==t&&null!=t)return Array.isArray(t)?t:[t]},e.GetPointerPrefix=function(){var t="pointer";return window.PointerEvent||navigator.pointerEnabled||(t="mouse"),t},e.QueueNewFrame=function(t,e){void 0===e&&(e=window),e.requestAnimationFrame?e.requestAnimationFrame(t):e.msRequestAnimationFrame?e.msRequestAnimationFrame(t):e.webkitRequestAnimationFrame?e.webkitRequestAnimationFrame(t):e.mozRequestAnimationFrame?e.mozRequestAnimationFrame(t):e.oRequestAnimationFrame?e.oRequestAnimationFrame(t):window.setTimeout(t,16)},e.RequestFullscreen=function(t){var e=t.requestFullscreen||t.msRequestFullscreen||t.webkitRequestFullscreen||t.mozRequestFullScreen;e&&e.call(t)},e.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},e.SetCorsBehavior=function(t,i){if(e.CorsBehavior)switch(n(e.CorsBehavior)){case"function":var r=e.CorsBehavior(t);if(r)return r;break;case"string":default:i.crossOrigin=e.CorsBehavior}},e.CleanUrl=function(t){return t=t.replace(/#/gm,"%23")},e.LoadImage=function(i,r,n,s){i instanceof ArrayBuffer&&(i=e.EncodeArrayBufferTobase64(i)),i=e.CleanUrl(i);var o=new Image;"data:"!==i.substr(0,5)&&e.SetCorsBehavior(i,o),o.onload=function(){r(o)},o.onerror=function(t){e.Error("Error while trying to load texture: "+i),e.UseFallbackTexture?(o.src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z",r(o)):n()};var a=function(){o.src=i},h=function(){s.loadImageFromDB(i,o)};if("data:"!==i.substr(0,5)&&s&&s.enableTexturesOffline&&t.Database.IsUASupportingBlobStorage)s.openAsync(h,a);else if(i.indexOf("file:")===-1)a();else try{var l,c=i.substring(5).toLowerCase();try{l=URL.createObjectURL(t.FilesInput.FilesTextures[c],{oneTimeOnly:!0})}catch(e){l=URL.createObjectURL(t.FilesInput.FilesTextures[c])}o.src=l}catch(t){o.src=null}return o},e.LoadFile=function(i,r,n,s,o,a){i=e.CleanUrl(i);var h=function(){var t=new XMLHttpRequest,s=e.BaseUrl+i;t.open("GET",s,!0),o&&(t.responseType="arraybuffer"),t.onprogress=n,t.onreadystatechange=function(){if(4===t.readyState)if(t.onreadystatechange=null,t.status>=200&&t.status<300||navigator.isCocoonJS&&0===t.status)r(o?t.response:t.responseText);else{if(!a)throw new Error("Error status: "+t.status+" - Unable to load "+s);a()}},t.send(null)},l=function(){s.loadFileFromDB(i,r,n,h,o)};if(i.indexOf("file:")!==-1){var c=i.substring(5).toLowerCase();e.ReadFile(t.FilesInput.FilesToLoad[c],r,n,o)}else s&&s.enableSceneOffline?s.openAsync(l,h):h()},e.ReadFileAsDataURL=function(t,e,i){var r=new FileReader;r.onload=function(t){e(t.target.result)},r.onprogress=i,r.readAsDataURL(t)},e.ReadFile=function(t,i,r,n){var s=new FileReader;s.onerror=function(r){e.Log("Error while reading file: "+t.name),i(JSON.stringify({autoClear:!0,clearColor:[1,0,0],ambientColor:[0,0,0],gravity:[0,-9.807,0],meshes:[],cameras:[],lights:[]}))},s.onload=function(t){i(t.target.result)},s.onprogress=r,n?s.readAsArrayBuffer(t):s.readAsText(t)},e.FileAsURL=function(t){var e=new Blob([t]);return(window.URL||window.webkitURL).createObjectURL(e)},e.Format=function(t,e){return void 0===e&&(e=2),t.toFixed(e)},e.CheckExtends=function(t,e,i){t.x<e.x&&(e.x=t.x),t.y<e.y&&(e.y=t.y),t.z<e.z&&(e.z=t.z),t.x>i.x&&(i.x=t.x),t.y>i.y&&(i.y=t.y),t.z>i.z&&(i.z=t.z)},e.DeepCopy=function(t,e,i,s){for(var o in t)if(("_"!==o[0]||s&&s.indexOf(o)!==-1)&&(!i||i.indexOf(o)===-1)){var a=t[o],h=void 0===a?"undefined":n(a);if("function"!==h)if("object"===h)if(a instanceof Array){if(e[o]=[],a.length>0)if("object"==n(a[0]))for(var l=0;l<a.length;l++){var c=r(a[l],e);e[o].indexOf(c)===-1&&e[o].push(c)}else e[o]=a.slice(0)}else e[o]=r(a,e);else e[o]=a}},e.IsEmpty=function(t){for(var e in t)return!1;return!0},e.RegisterTopRootEvents=function(t){for(var e=0;e<t.length;e++){var i=t[e];window.addEventListener(i.name,i.handler,!1);try{window.parent&&window.parent.addEventListener(i.name,i.handler,!1)}catch(t){}}},e.UnregisterTopRootEvents=function(t){for(var e=0;e<t.length;e++){var i=t[e];window.removeEventListener(i.name,i.handler);try{window.parent&&window.parent.removeEventListener(i.name,i.handler)}catch(t){}}},e.DumpFramebuffer=function(t,r,n,s,o){void 0===o&&(o="image/png");for(var a=4*t,h=r/2,l=n.readPixels(0,0,t,r),c=0;c<h;c++)for(var u=0;u<a;u++){var p=u+c*a,d=r-c-1,f=u+d*a,m=l[p];l[p]=l[f],l[f]=m}i||(i=document.createElement("canvas")),i.width=t,i.height=r;var _=i.getContext("2d"),g=_.createImageData(t,r);g.data.set(l),_.putImageData(g,0,0),e.EncodeScreenshotCanvasData(s,o)},e.EncodeScreenshotCanvasData=function(t,e){void 0===e&&(e="image/png");var r=i.toDataURL(e);if(t)t(r);else if("download"in document.createElement("a")){var n=window.document.createElement("a");n.href=r;var s=new Date,o=(s.getFullYear()+"-"+(s.getMonth()+1)).slice(-2)+"-"+s.getDate()+"_"+s.getHours()+"-"+("0"+s.getMinutes()).slice(-2);n.setAttribute("download","screenshot_"+o+".png"),window.document.body.appendChild(n),n.addEventListener("click",function(){n.parentElement.removeChild(n)}),n.click()}else{var a=window.open(""),h=a.document.createElement("img");h.src=r,a.document.body.appendChild(h)}},e.CreateScreenshot=function(t,r,n,s,o){void 0===o&&(o="image/png");var a,h;if(n.precision)a=Math.round(t.getRenderWidth()*n.precision),h=Math.round(a/t.getAspectRatio(r));else if(n.width&&n.height)a=n.width,h=n.height;else if(n.width&&!n.height)a=n.width,h=Math.round(a/t.getAspectRatio(r));else if(n.height&&!n.width)h=n.height,a=Math.round(h*t.getAspectRatio(r));else{if(isNaN(n))return void e.Error("Invalid 'size' parameter !");h=n,a=n}i||(i=document.createElement("canvas")),i.width=a,i.height=h,i.getContext("2d").drawImage(t.getRenderingCanvas(),0,0,a,h),e.EncodeScreenshotCanvasData(s,o)},e.CreateScreenshotUsingRenderTarget=function(i,r,n,s,o){void 0===o&&(o="image/png");var a,h;if(n.precision)a=Math.round(i.getRenderWidth()*n.precision),h=Math.round(a/i.getAspectRatio(r)),n={width:a,height:h};else if(n.width&&n.height)a=n.width,h=n.height;else if(n.width&&!n.height)a=n.width,h=Math.round(a/i.getAspectRatio(r)),n={width:a,height:h};else if(n.height&&!n.width)h=n.height,a=Math.round(h*i.getAspectRatio(r)),n={width:a,height:h};else{if(isNaN(n))return void e.Error("Invalid 'size' parameter !");h=n,a=n}var l=r.getScene(),c=null;l.activeCamera!==r&&(c=l.activeCamera,l.activeCamera=r);var u=new t.RenderTargetTexture("screenShot",n,l,!1,!1);u.renderList=l.meshes,u.onAfterRenderObservable.add(function(){e.DumpFramebuffer(a,h,i,s,o)}),l.incrementRenderId(),l.resetCachedMaterial(),u.render(!0),u.dispose(),c&&(l.activeCamera=c),r.getProjectionMatrix(!0)},e.ValidateXHRData=function(e,i){void 0===i&&(i=7);try{if(1&i){if(e.responseText&&e.responseText.length>0)return!0;if(1===i)return!1}if(2&i){var r=t.Internals.TGATools.GetTGAHeader(e.response);if(r.width&&r.height&&r.width>0&&r.height>0)return!0;if(2===i)return!1}if(4&i){var n=new Uint8Array(e.response,0,3);return 68===n[0]&&68===n[1]&&83===n[2]}}catch(t){}return!1},e.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})},Object.defineProperty(e,"NoneLogLevel",{get:function(){return e._NoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MessageLogLevel",{get:function(){return e._MessageLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WarningLogLevel",{get:function(){return e._WarningLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"ErrorLogLevel",{get:function(){return e._ErrorLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"AllLogLevel",{get:function(){return e._MessageLogLevel|e._WarningLogLevel|e._ErrorLogLevel},enumerable:!0,configurable:!0}),e._AddLogEntry=function(t){e._LogCache=t+e._LogCache,e.OnNewCacheEntry&&e.OnNewCacheEntry(t)},e._FormatMessage=function(t){var e=function(t){return t<10?"0"+t:""+t},i=new Date;return"["+e(i.getHours())+":"+e(i.getMinutes())+":"+e(i.getSeconds())+"]: "+t},e._LogDisabled=function(t){},e._LogEnabled=function(t){var i=e._FormatMessage(t);console.log("BJS - "+i);var r="<div style='color:white'>"+i+"</div><br>";e._AddLogEntry(r)},e._WarnDisabled=function(t){},e._WarnEnabled=function(t){var i=e._FormatMessage(t);console.warn("BJS - "+i);var r="<div style='color:orange'>"+i+"</div><br>";e._AddLogEntry(r)},e._ErrorDisabled=function(t){},e._ErrorEnabled=function(t){e.errorsCount++;var i=e._FormatMessage(t);console.error("BJS - "+i);var r="<div style='color:red'>"+i+"</div><br>";e._AddLogEntry(r)},Object.defineProperty(e,"LogCache",{get:function(){return e._LogCache},enumerable:!0,configurable:!0}),e.ClearLogCache=function(){e._LogCache="",e.errorsCount=0},Object.defineProperty(e,"LogLevels",{set:function(t){(t&e.MessageLogLevel)===e.MessageLogLevel?e.Log=e._LogEnabled:e.Log=e._LogDisabled,(t&e.WarningLogLevel)===e.WarningLogLevel?e.Warn=e._WarnEnabled:e.Warn=e._WarnDisabled,(t&e.ErrorLogLevel)===e.ErrorLogLevel?e.Error=e._ErrorEnabled:e.Error=e._ErrorDisabled},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PerformanceNoneLogLevel",{get:function(){return e._PerformanceNoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PerformanceUserMarkLogLevel",{get:function(){return e._PerformanceUserMarkLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PerformanceConsoleLogLevel",{get:function(){return e._PerformanceConsoleLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PerformanceLogLevel",{set:function(t){return(t&e.PerformanceUserMarkLogLevel)===e.PerformanceUserMarkLogLevel?(e.StartPerformanceCounter=e._StartUserMark,void(e.EndPerformanceCounter=e._EndUserMark)):(t&e.PerformanceConsoleLogLevel)===e.PerformanceConsoleLogLevel?(e.StartPerformanceCounter=e._StartPerformanceConsole,void(e.EndPerformanceCounter=e._EndPerformanceConsole)):(e.StartPerformanceCounter=e._StartPerformanceCounterDisabled,void(e.EndPerformanceCounter=e._EndPerformanceCounterDisabled))},enumerable:!0,configurable:!0}),e._StartPerformanceCounterDisabled=function(t,e){},e._EndPerformanceCounterDisabled=function(t,e){},e._StartUserMark=function(t,i){void 0===i&&(i=!0),i&&e._performance.mark&&e._performance.mark(t+"-Begin")},e._EndUserMark=function(t,i){void 0===i&&(i=!0),i&&e._performance.mark&&(e._performance.mark(t+"-End"),e._performance.measure(t,t+"-Begin",t+"-End"))},e._StartPerformanceConsole=function(t,i){void 0===i&&(i=!0),i&&(e._StartUserMark(t,i),console.time&&console.time(t))},e._EndPerformanceConsole=function(t,i){void 0===i&&(i=!0),i&&(e._EndUserMark(t,i),console.time&&console.timeEnd(t))},Object.defineProperty(e,"Now",{get:function(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()},enumerable:!0,configurable:!0}),e.getClassName=function(t,e){void 0===e&&(e=!1);var i=null;if(!e&&t.getClassName)i=t.getClassName();else{if(t instanceof Object){i=(e?t:Object.getPrototypeOf(t)).constructor.__bjsclassName__}i||(i=void 0===t?"undefined":n(t))}return i},e.first=function(t,e){for(var i=0,r=t;i<r.length;i++){var n=r[i];if(e(n))return n}},e.getFullClassName=function(t,e){void 0===e&&(e=!1);var i=null,r=null;if(!e&&t.getClassName)i=t.getClassName();else{if(t instanceof Object){var s=e?t:Object.getPrototypeOf(t);i=s.constructor.__bjsclassName__,r=s.constructor.__bjsmoduleName__}i||(i=void 0===t?"undefined":n(t))}return i?(null!=r?r+".":"")+i:null},e.arrayOrStringFeeder=function(t){return function(i){if(i>=t.length)return null;var r=t.charCodeAt?t.charCodeAt(i):t[i];return r&&r.getHashCode&&(r=r.getHashCode()),"string"==typeof r?e.hashCodeFromStream(e.arrayOrStringFeeder(r)):r}},e.hashCodeFromStream=function(t){for(var e=0,i=0,r=t(i++);null!=r;)e=(e<<5)-e+r,e|=0,r=t(i++);return e},e.BaseUrl="",e.CorsBehavior="anonymous",e.UseFallbackTexture=!0,e._NoneLogLevel=0,e._MessageLogLevel=1,e._WarningLogLevel=2,e._ErrorLogLevel=4,e._LogCache="",e.errorsCount=0,e.Log=e._LogEnabled,e.Warn=e._WarnEnabled,e.Error=e._ErrorEnabled,e._PerformanceNoneLogLevel=0,e._PerformanceUserMarkLogLevel=1,e._PerformanceConsoleLogLevel=2,e._performance=window.performance,e.StartPerformanceCounter=e._StartPerformanceCounterDisabled,e.EndPerformanceCounter=e._EndPerformanceCounterDisabled,e}();t.Tools=s;var o=function(){function t(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return Object.defineProperty(t.prototype,"min",{get:function(){return this._min},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"max",{get:function(){return this._max},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"average",{get:function(){return this._average},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:!0,configurable:!0}),t.prototype.fetchNewFrame=function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++},t.prototype.addCount=function(t,e){this._current+=t,e&&this._fetchResult()},t.prototype.beginMonitoring=function(){this._startMonitoringTime=s.Now},t.prototype.endMonitoring=function(t){void 0===t&&(t=!0),t&&this.fetchNewFrame();var e=s.Now;this._current=e-this._startMonitoringTime,t&&this._fetchResult()},t.prototype._fetchResult=function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var t=s.Now;t-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=t,this._lastSecAccumulated=0,this._lastSecValueCount=0)},t}();t.PerfCounter=o,t.className=e;var a=function(){function t(t,e,i,r){void 0===r&&(r=0),this.iterations=t,this._fn=e,this._successCallback=i,this.index=r-1,this._done=!1}return t.prototype.executeNext=function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())},t.prototype.breakLoop=function(){this._done=!0,this._successCallback()},t.Run=function(e,i,r,n){void 0===n&&(n=0);var s=new t(e,i,r,n);return s.executeNext(),s},t.SyncAsyncForLoop=function(e,i,r,n,s,o){void 0===o&&(o=0),t.Run(Math.ceil(e/i),function(t){s&&s()?t.breakLoop():setTimeout(function(){for(var n=0;n<i;++n){var o=t.index*i+n;if(o>=e)break;if(r(o),s&&s()){t.breakLoop();break}}t.executeNext()},o)},n)},t}();t.AsyncLoop=a}(r||(r={}));var r;!function(t){!function(t){var e=function(){function t(){this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._alphaBlend=!1,this._blendFunctionParameters=new Array(4),this.reset()}return Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(t){this._alphaBlend!==t&&(this._alphaBlend=t,this._isAlphaBlendDirty=!0)},enumerable:!0,configurable:!0}),t.prototype.setAlphaBlendFunctionParameters=function(t,e,i,r){this._blendFunctionParameters[0]===t&&this._blendFunctionParameters[1]===e&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=t,this._blendFunctionParameters[1]=e,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)},t.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1},t.prototype.apply=function(t){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?t.enable(t.BLEND):t.disable(t.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(t.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1))},t}();t._AlphaState=e}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){!function(t){var e=function(){function t(){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this.reset()}return Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zOffset",{get:function(){return this._zOffset},set:function(t){this._zOffset!==t&&(this._zOffset=t,this._isZOffsetDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cullFace",{get:function(){return this._cullFace},set:function(t){this._cullFace!==t&&(this._cullFace=t,this._isCullFaceDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"cull",{get:function(){return this._cull},set:function(t){this._cull!==t&&(this._cull=t,this._isCullDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(t){this._depthFunc!==t&&(this._depthFunc=t,this._isDepthFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthMask",{get:function(){return this._depthMask},set:function(t){this._depthMask!==t&&(this._depthMask=t,this._isDepthMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"depthTest",{get:function(){return this._depthTest},set:function(t){this._depthTest!==t&&(this._depthTest=t,this._isDepthTestDirty=!0)},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1},t.prototype.apply=function(t){this.isDirty&&(this._isCullDirty&&(this.cull?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(t.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(t.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(t.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(this.zOffset,0)):t.disable(t.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1))},t}();t._DepthCullingState=e}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){!function(e){var i=function(){function e(){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(t){this._stencilFunc!==t&&(this._stencilFunc=t,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(t){this._stencilFuncRef!==t&&(this._stencilFuncRef=t,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(t){this._stencilFuncMask!==t&&(this._stencilFuncMask=t,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(t){this._stencilOpStencilFail!==t&&(this._stencilOpStencilFail=t,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(t){this._stencilOpDepthFail!==t&&(this._stencilOpDepthFail=t,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(t){this._stencilOpStencilDepthPass!==t&&(this._stencilOpStencilDepthPass=t,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(t){this._stencilMask!==t&&(this._stencilMask=t,this._isStencilMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(t){this._stencilTest!==t&&(this._stencilTest=t,this._isStencilTestDirty=!0)},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=t.Engine.ALWAYS,this._stencilFuncRef=1,this._stencilFuncMask=255,this._stencilOpStencilFail=t.Engine.KEEP,this._stencilOpDepthFail=t.Engine.KEEP,this._stencilOpStencilDepthPass=t.Engine.REPLACE,this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},e.prototype.apply=function(t){this.isDirty&&(this._isStencilTestDirty&&(this.stencilTest?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(t.stencilMask(this.stencilMask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(t.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(t.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass),this._isStencilOpDirty=!1))},e}();e._StencilState=i}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(t,e,i,r){var n=t.createShader("vertex"===i?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(t.shaderSource(n,(r?r+"\n":"")+e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n));return n},i=36193,r=function(t,e){return e===c.TEXTURETYPE_FLOAT?t.FLOAT:e===c.TEXTURETYPE_HALF_FLOAT?i:t.UNSIGNED_BYTE},n=function(e,i,r){var n=r.NEAREST,s=r.NEAREST;return e===t.Texture.BILINEAR_SAMPLINGMODE?(n=r.LINEAR,s=i?r.LINEAR_MIPMAP_NEAREST:r.LINEAR):e===t.Texture.TRILINEAR_SAMPLINGMODE?(n=r.LINEAR,s=i?r.LINEAR_MIPMAP_LINEAR:r.LINEAR):e===t.Texture.NEAREST_SAMPLINGMODE&&(n=r.NEAREST,s=i?r.NEAREST_MIPMAP_LINEAR:r.NEAREST),{min:s,mag:n}},s=function(e,i,r,s,o,a,h,l,c,u){void 0===u&&(u=t.Texture.TRILINEAR_SAMPLINGMODE);var p=r.getEngine(),d=t.Tools.GetExponentOfTwo(s,p.getCaps().maxTextureSize),f=t.Tools.GetExponentOfTwo(o,p.getCaps().maxTextureSize);p._bindTextureDirectly(i.TEXTURE_2D,e),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,void 0===a?1:a?1:0),e._baseWidth=s,e._baseHeight=o,e._width=d,e._height=f,e.isReady=!0,c(d,f);var m=n(u,!h,i);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,m.mag),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,m.min),h||l||i.generateMipmap(i.TEXTURE_2D),p._bindTextureDirectly(i.TEXTURE_2D,null),p.resetTextureCache(),r._removePendingData(e),e.onLoadedCallbacks.forEach(function(t){t()}),e.onLoadedCallbacks=[]},o=function(e,i,r,n,s,o){void 0===o&&(o=null);var a,h=function(){r[i]=a,r._internalCount++,n._removePendingData(a),6===r._internalCount&&s(r)},l=function(){n._removePendingData(a),o&&o()};a=t.Tools.LoadImage(e,h,l,n.database),n._addPendingData(a)},a=function(t,e,i,r,n){void 0===n&&(n=null);var s=[];s._internalCount=0;for(var a=0;a<6;a++)o(r[a],a,s,e,i,n)},h=function(){function t(){}return t}();t.InstancingAttributeInfo=h;var l=function(){function t(){}return t}();t.EngineCapabilities=l;var c=function(){function o(e,i,r,n){var s=this;void 0===n&&(n=!0),this.isFullscreen=!1,this.isPointerLock=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.enableOfflineSupport=!0,this.scenes=new Array,this._windowIsBackground=!1,this._webGLVersion="1.0",this._badOS=!1,this._drawCalls=new t.PerfCounter,this._renderingQueueLaunched=!1,this._activeRenderLoops=[],this.fpsRange=60,this.previousFramesDuration=[],this.fps=60,this.deltaTime=0,this._depthCullingState=new t.Internals._DepthCullingState,this._stencilState=new t.Internals._StencilState,this._alphaState=new t.Internals._AlphaState,this._alphaMode=o.ALPHA_DISABLE,this._loadedTexturesCache=new Array,this._maxTextureChannels=16,this._activeTexturesCache=new Array(this._maxTextureChannels),this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentBufferPointers=[],this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._texturesSupported=new Array,this._onVRFullScreenTriggered=function(){if(s._vrDisplayEnabled&&s._vrDisplayEnabled.isPresenting){s._oldSize=new t.Size(s.getRenderWidth(),s.getRenderHeight()),s._oldHardwareScaleFactor=s.getHardwareScalingLevel();var e=s._vrDisplayEnabled.getEyeParameters("left");s.setHardwareScalingLevel(1),s.setSize(2*e.renderWidth,e.renderHeight)}else s.setHardwareScalingLevel(s._oldHardwareScaleFactor),s.setSize(s._oldSize.width,s._oldSize.height),s._vrDisplayEnabled=void 0},this._renderingCanvas=e,this._externalData=new t.StringDictionary,r=r||{},null!=i&&(r.antialias=i),void 0===r.preserveDrawingBuffer&&(r.preserveDrawingBuffer=!1);var a=this._canRenderToFloatTexture(),h=this._canRenderToHalfFloatTexture();if(!this._gl){if(!e)throw new Error("The provided canvas is null or undefined.");try{this._gl=e.getContext("webgl",r)||e.getContext("experimental-webgl",r)}catch(t){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported");this._onBlur=function(){s._windowIsBackground=!0},this._onFocus=function(){s._windowIsBackground=!1},window.addEventListener("blur",this._onBlur),window.addEventListener("focus",this._onFocus);var c=r.limitDeviceRatio||window.devicePixelRatio||1;this._hardwareScalingLevel=n?1/Math.min(c,window.devicePixelRatio||1):1,this.resize(),this._isStencilEnable=r.stencil,this._caps=new l,this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),this._caps.maxVertexAttribs=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),this._glVersion=this._gl.getParameter(this._gl.VERSION);var u=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=u&&(this._glRenderer=this._gl.getParameter(u.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(u.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor="Unknown vendor"),this._glRenderer||(this._glRenderer="Unknown renderer"),this._caps.standardDerivatives=null!==this._gl.getExtension("OES_standard_derivatives"),this._caps.astc=this._gl.getExtension("WEBGL_compressed_texture_astc"),this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc"),this._caps.pvrtc=this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),this._caps.etc1=this._gl.getExtension("WEBGL_compressed_texture_etc1"),this._caps.etc2=this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),this._caps.textureFloat=null!==this._gl.getExtension("OES_texture_float"),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.instancedArrays=this._gl.getExtension("ANGLE_instanced_arrays"),this._caps.uintIndices=null!==this._gl.getExtension("OES_element_index_uint"),this._caps.fragmentDepthSupported=null!==this._gl.getExtension("EXT_frag_depth"),this._caps.highPrecisionShaderSupported=!0,this._caps.drawBuffersExtension=this._gl.getExtension("WEBGL_draw_buffers"),this._caps.textureFloatLinearFiltering=this._gl.getExtension("OES_texture_float_linear"),this._caps.textureLOD=this._gl.getExtension("EXT_shader_texture_lod"),this._caps.textureFloatRender=a,this._caps.textureHalfFloat=null!==this._gl.getExtension("OES_texture_half_float"),this._caps.textureHalfFloatLinearFiltering=this._gl.getExtension("OES_texture_half_float_linear"),this._caps.textureHalfFloatRender=h,this._caps.astc&&this.texturesSupported.push(".astc"),this._caps.s3tc&&this.texturesSupported.push(".dds"),this._caps.pvrtc&&this.texturesSupported.push(".pvr"),this._caps.etc2&&this.texturesSupported.push(".etc2"),this._caps.etc1&&this.texturesSupported.push(".etc1"),this._gl.getShaderPrecisionFormat){var p=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);this._caps.highPrecisionShaderSupported=0!==p.precision}this.setDepthBuffer(!0),this.setDepthFunctionToLessOrEqual(),this.setDepthWrite(!0),this._onFullscreenChange=function(){void 0!==document.fullscreen?s.isFullscreen=document.fullscreen:void 0!==document.mozFullScreen?s.isFullscreen=document.mozFullScreen:void 0!==document.webkitIsFullScreen?s.isFullscreen=document.webkitIsFullScreen:void 0!==document.msIsFullScreen&&(s.isFullscreen=document.msIsFullScreen),s.isFullscreen&&s._pointerLockRequested&&(e.requestPointerLock=e.requestPointerLock||e.msRequestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock&&e.requestPointerLock())},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=function(){s.isPointerLock=document.mozPointerLockElement===e||document.webkitPointerLockElement===e||document.msPointerLockElement===e||document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1),t.AudioEngine&&!o.audioEngine&&(o.audioEngine=new t.AudioEngine),this._loadingScreen=new t.DefaultLoadingScreen(this._renderingCanvas),r.autoEnableWebVR&&this.initWebVR();var d=/AppleWebKit.*10.[\d] Mobile/;this._badOS=d.test(navigator.userAgent),t.Tools.Log("Babylon.js engine (v"+o.Version+") launched")}return Object.defineProperty(o,"NEVER",{get:function(){return o._NEVER},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALWAYS",{get:function(){return o._ALWAYS},enumerable:!0,configurable:!0}),Object.defineProperty(o,"LESS",{get:function(){return o._LESS},enumerable:!0,configurable:!0}),Object.defineProperty(o,"EQUAL",{get:function(){return o._EQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(o,"LEQUAL",{get:function(){return o._LEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(o,"GREATER",{get:function(){return o._GREATER},enumerable:!0,configurable:!0}),Object.defineProperty(o,"GEQUAL",{get:function(){return o._GEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(o,"NOTEQUAL",{get:function(){return o._NOTEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(o,"KEEP",{get:function(){return o._KEEP},enumerable:!0,configurable:!0}),Object.defineProperty(o,"REPLACE",{get:function(){return o._REPLACE},enumerable:!0,configurable:!0}),Object.defineProperty(o,"INCR",{get:function(){return o._INCR},enumerable:!0,configurable:!0}),Object.defineProperty(o,"DECR",{get:function(){return o._DECR},enumerable:!0,configurable:!0}),Object.defineProperty(o,"INVERT",{get:function(){return o._INVERT},enumerable:!0,configurable:!0}),Object.defineProperty(o,"INCR_WRAP",{get:function(){return o._INCR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(o,"DECR_WRAP",{get:function(){return o._DECR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_DISABLE",{get:function(){return o._ALPHA_DISABLE},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_ONEONE",{get:function(){return o._ALPHA_ONEONE},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_ADD",{get:function(){return o._ALPHA_ADD},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_COMBINE",{get:function(){return o._ALPHA_COMBINE},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_SUBTRACT",{get:function(){return o._ALPHA_SUBTRACT},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_MULTIPLY",{get:function(){return o._ALPHA_MULTIPLY},enumerable:!0,configurable:!0}),Object.defineProperty(o,"ALPHA_MAXIMIZED",{get:function(){return o._ALPHA_MAXIMIZED},enumerable:!0,configurable:!0}),Object.defineProperty(o,"DELAYLOADSTATE_NONE",{get:function(){return o._DELAYLOADSTATE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(o,"DELAYLOADSTATE_LOADED",{get:function(){return o._DELAYLOADSTATE_LOADED},enumerable:!0,configurable:!0}),Object.defineProperty(o,"DELAYLOADSTATE_LOADING",{get:function(){return o._DELAYLOADSTATE_LOADING},enumerable:!0,configurable:!0}),Object.defineProperty(o,"DELAYLOADSTATE_NOTLOADED",{get:function(){return o._DELAYLOADSTATE_NOTLOADED},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTUREFORMAT_ALPHA",{get:function(){return o._TEXTUREFORMAT_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTUREFORMAT_LUMINANCE",{get:function(){return o._TEXTUREFORMAT_LUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTUREFORMAT_LUMINANCE_ALPHA",{get:function(){return o._TEXTUREFORMAT_LUMINANCE_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTUREFORMAT_RGB",{get:function(){return o._TEXTUREFORMAT_RGB},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTUREFORMAT_RGBA",{get:function(){return o._TEXTUREFORMAT_RGBA},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTURETYPE_UNSIGNED_INT",{get:function(){return o._TEXTURETYPE_UNSIGNED_INT},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTURETYPE_FLOAT",{get:function(){return o._TEXTURETYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(o,"TEXTURETYPE_HALF_FLOAT",{get:function(){return o._TEXTURETYPE_HALF_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(o,"Version",{get:function(){return"2.5"},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"texturesSupported",{get:function(){return this._texturesSupported},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!0,configurable:!0}),o.prototype._prepareWorkingCanvas=function(){this._workingCanvas||(this._workingCanvas=document.createElement("canvas"),this._workingContext=this._workingCanvas.getContext("2d"))},o.prototype.resetTextureCache=function(){for(var t=0;t<this._maxTextureChannels;t++)this._activeTexturesCache[t]=null},o.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},o.prototype.getAspectRatio=function(t,e){void 0===e&&(e=!1);var i=t.viewport;return this.getRenderWidth(e)*i.width/(this.getRenderHeight(e)*i.height)},o.prototype.getRenderWidth=function(t){return void 0===t&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget._width:this._renderingCanvas.width},o.prototype.getRenderHeight=function(t){return void 0===t&&(t=!1),!t&&this._currentRenderTarget?this._currentRenderTarget._height:this._renderingCanvas.height},o.prototype.getRenderingCanvas=function(){return this._renderingCanvas},o.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas.getBoundingClientRect()},o.prototype.setHardwareScalingLevel=function(t){this._hardwareScalingLevel=t,this.resize()},o.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},o.prototype.getLoadedTexturesCache=function(){return this._loadedTexturesCache},o.prototype.getCaps=function(){return this._caps},Object.defineProperty(o.prototype,"drawCalls",{get:function(){return this._drawCalls.current},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"drawCallsPerfCounter",{get:function(){return this._drawCalls},enumerable:!0,configurable:!0}),o.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},o.prototype.setDepthFunction=function(t){this._depthCullingState.depthFunc=t},o.prototype.setDepthFunctionToGreater=function(){this._depthCullingState.depthFunc=this._gl.GREATER},o.prototype.setDepthFunctionToGreaterOrEqual=function(){this._depthCullingState.depthFunc=this._gl.GEQUAL},o.prototype.setDepthFunctionToLess=function(){this._depthCullingState.depthFunc=this._gl.LESS},o.prototype.setDepthFunctionToLessOrEqual=function(){this._depthCullingState.depthFunc=this._gl.LEQUAL},o.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},o.prototype.setStencilBuffer=function(t){this._stencilState.stencilTest=t},o.prototype.getStencilMask=function(){return this._stencilState.stencilMask},o.prototype.setStencilMask=function(t){this._stencilState.stencilMask=t},o.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},o.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},o.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},o.prototype.setStencilFunction=function(t){this._stencilState.stencilFunc=t},o.prototype.setStencilFunctionReference=function(t){this._stencilState.stencilFuncRef=t},o.prototype.setStencilFunctionMask=function(t){this._stencilState.stencilFuncMask=t},o.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},o.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},o.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},o.prototype.setStencilOperationFail=function(t){this._stencilState.stencilOpStencilFail=t},o.prototype.setStencilOperationDepthFail=function(t){this._stencilState.stencilOpDepthFail=t},o.prototype.setStencilOperationPass=function(t){this._stencilState.stencilOpStencilDepthPass=t},o.prototype.stopRenderLoop=function(t){if(!t)return void(this._activeRenderLoops=[]);var e=this._activeRenderLoops.indexOf(t);e>=0&&this._activeRenderLoops.splice(e,1)},o.prototype._renderLoop=function(){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(var i=0;i<this._activeRenderLoops.length;i++){(0,this._activeRenderLoops[i])()}this.endFrame()}this._activeRenderLoops.length>0?t.Tools.QueueNewFrame(this._bindedRenderFunction,this._vrDisplayEnabled):this._renderingQueueLaunched=!1},o.prototype.runRenderLoop=function(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._bindedRenderFunction=this._renderLoop.bind(this),t.Tools.QueueNewFrame(this._bindedRenderFunction)))},o.prototype.switchFullscreen=function(e){this.isFullscreen?t.Tools.ExitFullscreen():(this._pointerLockRequested=e,t.Tools.RequestFullscreen(this._renderingCanvas))},o.prototype.clear=function(t,e,i,r){void 0===r&&(r=!1),this.applyStates();var n=0;e&&(this._gl.clearColor(t.r,t.g,t.b,void 0!==t.a?t.a:1),n|=this._gl.COLOR_BUFFER_BIT),i&&(this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)},o.prototype.scissorClear=function(t,e,i,r,n){var s=this._gl,o=s.getParameter(s.SCISSOR_TEST),a=s.getParameter(s.SCISSOR_BOX);s.enable(s.SCISSOR_TEST),s.scissor(t,e,i,r),this.clear(n,!0,!0,!0),s.scissor(a[0],a[1],a[2],a[3]),o===!0?s.enable(s.SCISSOR_TEST):s.disable(s.SCISSOR_TEST)},o.prototype.setViewport=function(t,e,i){var r=e||(navigator.isCocoonJS?window.innerWidth:this._renderingCanvas.width),n=i||(navigator.isCocoonJS?window.innerHeight:this._renderingCanvas.height),s=t.x||0,o=t.y||0;this._cachedViewport=t,this._gl.viewport(s*r,o*n,r*t.width,n*t.height)},o.prototype.setDirectViewport=function(t,e,i,r){var n=this._cachedViewport;return this._cachedViewport=null,this._gl.viewport(t,e,i,r),n},o.prototype.beginFrame=function(){this._measureFps()},o.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._vrDisplayEnabled&&this._vrDisplayEnabled.isPresenting&&this._vrDisplayEnabled.submitFrame()},o.prototype.resize=function(){var e=navigator.isCocoonJS?window.innerWidth:this._renderingCanvas.clientWidth,i=navigator.isCocoonJS?window.innerHeight:this._renderingCanvas.clientHeight;this.setSize(e/this._hardwareScalingLevel,i/this._hardwareScalingLevel);for(var r=0;r<this.scenes.length;r++){var n=this.scenes[r];t.DebugLayer&&n.debugLayer.isVisible()&&n.debugLayer._syncPositions()}},o.prototype.setSize=function(t,e){this._renderingCanvas.width=t,this._renderingCanvas.height=e;for(var i=0;i<this.scenes.length;i++)for(var r=this.scenes[i],n=0;n<r.cameras.length;n++){var s=r.cameras[n];s._currentRenderId=0}},o.prototype.initWebVR=function(){this.vrDisplaysPromise||this._getVRDisplays()},o.prototype.enableVR=function(t){this._vrDisplayEnabled=t,this._vrDisplayEnabled.requestPresent([{source:this.getRenderingCanvas()}]).then(this._onVRFullScreenTriggered)},o.prototype.disableVR=function(){this._vrDisplayEnabled&&this._vrDisplayEnabled.exitPresent().then(this._onVRFullScreenTriggered)},o.prototype._getVRDisplays=function(){var t=this,e=function(e){e.length;return t._vrDisplays=e.filter(function(t){return e[0]instanceof VRDisplay}),t._vrDisplays};navigator.getVRDisplays&&(this.vrDisplaysPromise=navigator.getVRDisplays().then(e))},o.prototype.bindFramebuffer=function(t,e,i,r){this._currentRenderTarget=t,this.bindUnboundFramebuffer(t._framebuffer);var n=this._gl;t.isCube&&n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,0),n.viewport(0,0,i||t._width,r||t._height),this.wipeCaches()},o.prototype.bindUnboundFramebuffer=function(t){this._currentFramebuffer!==t&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,t),this._currentFramebuffer=t)},o.prototype.unBindFramebuffer=function(t,e){if(void 0===e&&(e=!1),this._currentRenderTarget=null,t.generateMipMaps&&!e){var i=this._gl;this._bindTextureDirectly(i.TEXTURE_2D,t),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null)}this.bindUnboundFramebuffer(null)},o.prototype.generateMipMapsForCubemap=function(t){if(t.generateMipMaps){var e=this._gl;this._bindTextureDirectly(e.TEXTURE_CUBE_MAP,t),e.generateMipmap(e.TEXTURE_CUBE_MAP),this._bindTextureDirectly(e.TEXTURE_CUBE_MAP,null)}},o.prototype.flushFramebuffer=function(){this._gl.flush()},o.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget=null,this.bindUnboundFramebuffer(null),this.setViewport(this._cachedViewport),this.wipeCaches()},o.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},o.prototype.createVertexBuffer=function(t){var e=this._gl.createBuffer();return this.bindArrayBuffer(e),t instanceof Float32Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),e.references=1,e},o.prototype.createDynamicVertexBuffer=function(t){var e=this._gl.createBuffer();return this.bindArrayBuffer(e),t instanceof Float32Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),this._gl.DYNAMIC_DRAW),this._resetVertexBufferBinding(),e.references=1,e},o.prototype.updateDynamicVertexBuffer=function(t,e,i,r){this.bindArrayBuffer(t),void 0===i&&(i=0),void 0===r?e instanceof Float32Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,e):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e.subarray(i,i+r)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(i,i+r)),this._resetVertexBufferBinding()},o.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},o.prototype.createIndexBuffer=function(t){var e=this._gl.createBuffer();this.bindIndexBuffer(e);var i,r=!1;if(this._caps.uintIndices){for(var n=0;n<t.length;n++)if(t[n]>65535){r=!0;break}i=r?new Uint32Array(t):new Uint16Array(t)}else i=new Uint16Array(t);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),e.references=1,e.is32Bits=r,e},o.prototype.bindArrayBuffer=function(t){this.bindBuffer(t,this._gl.ARRAY_BUFFER)},o.prototype.bindIndexBuffer=function(t){this.bindBuffer(t,this._gl.ELEMENT_ARRAY_BUFFER)},o.prototype.bindBuffer=function(t,e){this._currentBoundBuffer[e]!==t&&(this._gl.bindBuffer(e,t),this._currentBoundBuffer[e]=t)},o.prototype.updateArrayBuffer=function(t){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)},o.prototype.vertexAttribPointer=function(t,e,i,r,n,s,o){var a=this._currentBufferPointers[e],h=!1;a?(a.buffer!==t&&(a.buffer=t,h=!0),a.size!==i&&(a.size=i,h=!0),a.type!==r&&(a.type=r,h=!0),a.normalized!==n&&(a.normalized=n,h=!0),a.stride!==s&&(a.stride=s,h=!0),a.offset!==o&&(a.offset=o,h=!0)):(h=!0,this._currentBufferPointers[e]={indx:e,size:i,type:r,normalized:n,stride:s,offset:o,buffer:t}),h&&(this.bindArrayBuffer(t),this._gl.vertexAttribPointer(e,i,r,n,s,o))},o.prototype.bindBuffersDirectly=function(t,e,i,r,n){if(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=n;for(var s=n.getAttributesCount(),o=0,a=0;a<s;a++)if(a<i.length){var h=n.getAttributeLocation(a);h>=0&&(this._vertexAttribArraysEnabled[h]||(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0),this.vertexAttribPointer(t,h,i[a],this._gl.FLOAT,!1,r,o)),o+=4*i[a]}else{var h=n.getAttributeLocation(a);this._vertexAttribArraysEnabled[h]&&(this._gl.disableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!1)}}this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},o.prototype.bindBuffers=function(t,e,i){if(this._cachedVertexBuffers!==t||this._cachedEffectForVertexBuffers!==i){this._cachedVertexBuffers=t,this._cachedEffectForVertexBuffers=i;for(var r=i.getAttributesNames(),n=0;n<r.length;n++){var s=i.getAttributeLocation(n);if(s>=0){var o=t[r[n]];if(!o){this._vertexAttribArraysEnabled[s]&&(this._gl.disableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!1);continue}this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0);var a=o.getBuffer();this.vertexAttribPointer(a,s,o.getSize(),this._gl.FLOAT,!1,4*o.getStrideSize(),4*o.getOffset()),o.getIsInstanced()&&(this._caps.instancedArrays.vertexAttribDivisorANGLE(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(a))}}}null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},o.prototype.unbindInstanceAttributes=function(){for(var t,e=0,i=this._currentInstanceLocations.length;e<i;e++){var r=this._currentInstanceBuffers[e];t!=r&&(t=r,this.bindArrayBuffer(r));var n=this._currentInstanceLocations[e];this._caps.instancedArrays.vertexAttribDivisorANGLE(n,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},o.prototype._releaseBuffer=function(t){return 0===--t.references&&(this._gl.deleteBuffer(t),!0)},o.prototype.createInstancesBuffer=function(t){var e=this._gl.createBuffer();return e.capacity=t,this.bindArrayBuffer(e),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),e},o.prototype.deleteInstancesBuffer=function(t){this._gl.deleteBuffer(t)},o.prototype.updateAndBindInstancesBuffer=function(t,e,i){if(this.bindArrayBuffer(t),e&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e),void 0!==i[0].index){for(var r=0,n=0;n<i.length;n++){var s=i[n];r+=4*s.attributeSize}for(var n=0;n<i.length;n++){var s=i[n];this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this.vertexAttribPointer(t,s.index,s.attributeSize,s.attribyteType||this._gl.FLOAT,s.normalized||!1,r,s.offset),this._caps.instancedArrays.vertexAttribDivisorANGLE(s.index,1),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(t)}}else for(var o=0;o<4;o++){var a=i[o];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this.vertexAttribPointer(t,a,4,this._gl.FLOAT,!1,64,16*o),this._caps.instancedArrays.vertexAttribDivisorANGLE(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(t)}},o.prototype.applyStates=function(){this._depthCullingState.apply(this._gl),this._stencilState.apply(this._gl),this._alphaState.apply(this._gl)},o.prototype.draw=function(t,e,i,r){this.applyStates(),this._drawCalls.addCount(1,!1);var n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,s=this._uintIndicesCurrentlySet?4:2;if(r)return void this._caps.instancedArrays.drawElementsInstancedANGLE(t?this._gl.TRIANGLES:this._gl.LINES,i,n,e*s,r);this._gl.drawElements(t?this._gl.TRIANGLES:this._gl.LINES,i,n,e*s)},o.prototype.drawPointClouds=function(t,e,i){if(this.applyStates(),this._drawCalls.addCount(1,!1),i)return void this._caps.instancedArrays.drawArraysInstancedANGLE(this._gl.POINTS,t,e,i);this._gl.drawArrays(this._gl.POINTS,t,e)},o.prototype.drawUnIndexed=function(t,e,i,r){if(this.applyStates(),this._drawCalls.addCount(1,!1),r)return void this._caps.instancedArrays.drawArraysInstancedANGLE(t?this._gl.TRIANGLES:this._gl.LINES,e,i,r);this._gl.drawArrays(t?this._gl.TRIANGLES:this._gl.LINES,e,i)},o.prototype._releaseEffect=function(t){this._compiledEffects[t._key]&&(delete this._compiledEffects[t._key],t.getProgram()&&this._gl.deleteProgram(t.getProgram()))},o.prototype.createEffect=function(e,i,r,n,s,o,a,h,l){var c=e.vertexElement||e.vertex||e,u=e.fragmentElement||e.fragment||e,p=c+"+"+u+"@"+s;if(this._compiledEffects[p])return this._compiledEffects[p];var d=new t.Effect(e,i,r,n,this,s,o,a,h,l);return d._key=p,this._compiledEffects[p]=d,d},o.prototype.createEffectForParticles=function(t,e,i,r,n,s,o){return void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===r&&(r=""),this.createEffect({vertex:"particles",fragmentElement:t},["position","color","options"],["view","projection"].concat(e),["diffuseSampler"].concat(i),r,n,s,o)},o.prototype.createShaderProgram=function(t,i,r,n){n=n||this._gl;var s=e(n,t,"vertex",r),o=e(n,i,"fragment",r),a=n.createProgram();if(n.attachShader(a,s),n.attachShader(a,o),n.linkProgram(a),!n.getProgramParameter(a,n.LINK_STATUS)){var h=n.getProgramInfoLog(a);if(h)throw new Error(h)}return n.deleteShader(s),n.deleteShader(o),a},o.prototype.getUniforms=function(t,e){for(var i=[],r=0;r<e.length;r++)i.push(this._gl.getUniformLocation(t,e[r]));return i},o.prototype.getAttributes=function(t,e){for(var i=[],r=0;r<e.length;r++)try{i.push(this._gl.getAttribLocation(t,e[r]))}catch(t){i.push(-1)}return i},o.prototype.enableEffect=function(t){this.setProgram(t.getProgram()),this._currentEffect=t,t.onBind&&t.onBind(t)},o.prototype.setIntArray=function(t,e){t&&this._gl.uniform1iv(t,e)},o.prototype.setIntArray2=function(t,e){t&&e.length%2==0&&this._gl.uniform2iv(t,e)},o.prototype.setIntArray3=function(t,e){t&&e.length%3==0&&this._gl.uniform3iv(t,e)},o.prototype.setIntArray4=function(t,e){t&&e.length%4==0&&this._gl.uniform4iv(t,e)},o.prototype.setFloatArray=function(t,e){t&&this._gl.uniform1fv(t,e)},o.prototype.setFloatArray2=function(t,e){t&&e.length%2==0&&this._gl.uniform2fv(t,e)},o.prototype.setFloatArray3=function(t,e){t&&e.length%3==0&&this._gl.uniform3fv(t,e)},o.prototype.setFloatArray4=function(t,e){t&&e.length%4==0&&this._gl.uniform4fv(t,e)},o.prototype.setArray=function(t,e){t&&this._gl.uniform1fv(t,e)},o.prototype.setArray2=function(t,e){t&&e.length%2==0&&this._gl.uniform2fv(t,e)},o.prototype.setArray3=function(t,e){t&&e.length%3==0&&this._gl.uniform3fv(t,e)},o.prototype.setArray4=function(t,e){t&&e.length%4==0&&this._gl.uniform4fv(t,e)},o.prototype.setMatrices=function(t,e){t&&this._gl.uniformMatrix4fv(t,!1,e)},o.prototype.setMatrix=function(t,e){t&&this._gl.uniformMatrix4fv(t,!1,e.toArray())},o.prototype.setMatrix3x3=function(t,e){t&&this._gl.uniformMatrix3fv(t,!1,e)},o.prototype.setMatrix2x2=function(t,e){t&&this._gl.uniformMatrix2fv(t,!1,e)},o.prototype.setFloat=function(t,e){t&&this._gl.uniform1f(t,e)},o.prototype.setFloat2=function(t,e,i){t&&this._gl.uniform2f(t,e,i)},o.prototype.setFloat3=function(t,e,i,r){t&&this._gl.uniform3f(t,e,i,r)},o.prototype.setBool=function(t,e){t&&this._gl.uniform1i(t,e)},o.prototype.setFloat4=function(t,e,i,r,n){t&&this._gl.uniform4f(t,e,i,r,n)},o.prototype.setColor3=function(t,e){t&&this._gl.uniform3f(t,e.r,e.g,e.b)},o.prototype.setColor4=function(t,e,i){t&&this._gl.uniform4f(t,e.r,e.g,e.b,i)},o.prototype.setState=function(t,e,i,r){void 0===e&&(e=0),void 0===r&&(r=!1);var n=r?this._gl.FRONT:this._gl.BACK,s=r?this._gl.BACK:this._gl.FRONT,o=this.cullBackFaces?n:s;(this._depthCullingState.cull!==t||i||this._depthCullingState.cullFace!==o)&&(t?(this._depthCullingState.cullFace=o,this._depthCullingState.cull=!0):this._depthCullingState.cull=!1),this._depthCullingState.zOffset=e},o.prototype.setDepthBuffer=function(t){this._depthCullingState.depthTest=t},o.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},o.prototype.setDepthWrite=function(t){this._depthCullingState.depthMask=t},o.prototype.setColorWrite=function(t){this._gl.colorMask(t,t,t,t)},o.prototype.setAlphaMode=function(t,e){if(void 0===e&&(e=!1),this._alphaMode!==t){switch(t){case o.ALPHA_DISABLE:this._alphaState.alphaBlend=!1;break;case o.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case o.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case o.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case o.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case o.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case o.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0}e||this.setDepthWrite(t===o.ALPHA_DISABLE),this._alphaMode=t}},o.prototype.getAlphaMode=function(){return this._alphaMode},o.prototype.setAlphaTesting=function(t){this._alphaTest=t},o.prototype.getAlphaTesting=function(){return this._alphaTest},o.prototype.wipeCaches=function(){this.resetTextureCache(),this._currentEffect=null,this._stencilState.reset(),this._depthCullingState.reset(),this.setDepthFunctionToLessOrEqual(),this._alphaState.reset(),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null},o.prototype.setSamplingMode=function(e,i){var r=this._gl;this._bindTextureDirectly(r.TEXTURE_2D,e);var n=r.NEAREST,s=r.NEAREST;i===t.Texture.BILINEAR_SAMPLINGMODE?(n=r.LINEAR,s=r.LINEAR):i===t.Texture.TRILINEAR_SAMPLINGMODE&&(n=r.LINEAR,s=r.LINEAR_MIPMAP_LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,s),this._bindTextureDirectly(r.TEXTURE_2D,null),e.samplingMode=i},o.prototype.setTextureFormatToUse=function(t){for(var e=0,i=this.texturesSupported.length;e<i;e++)if(".astc"!==this._texturesSupported[e]&&".pvr"!==this._texturesSupported[e]&&".etc1"!==this._texturesSupported[e]&&".etc2"!==this._texturesSupported[e])for(var r=0,n=t.length;r<n;r++)if(this._texturesSupported[e]===t[r].toLowerCase())return this._textureFormatInUse=this._texturesSupported[e];return this._textureFormatInUse=null},o.prototype.createTexture=function(e,i,r,n,o,a,h,l){var c=this;void 0===o&&(o=t.Texture.TRILINEAR_SAMPLINGMODE),void 0===a&&(a=null),void 0===h&&(h=null),void 0===l&&(l=null);var u,p=this._gl.createTexture(),d=!1;if("data:"===e.substr(0,5)&&(d=!0),d){var f=e;d=f.split(":"),e=f,u=d[1].substr(d[1].length-4,4).toLowerCase()}else{var m=e.lastIndexOf(".");u=e.substring(m).toLowerCase(),!this._textureFormatInUse||d||n.database||(u=this._textureFormatInUse,e=e.substring(0,m)+this._textureFormatInUse)}var _=".dds"===u,g=".tga"===u;n._addPendingData(p),p.url=e,p.noMipmap=i,p.references=1,p.samplingMode=o,p.onLoadedCallbacks=[a],this._loadedTexturesCache.push(p);var y,v=function(){n._removePendingData(p),h&&h()};if(g)y=function(e){var a=new Uint8Array(e),h=t.Internals.TGATools.GetTGAHeader(a);s(p,c._gl,n,h.width,h.height,r,i,!1,function(){t.Internals.TGATools.UploadContent(c._gl,a)},o)},d instanceof Array?y(l):t.Tools.LoadFile(e,function(t){y(t)},null,n.database,!0,v);else if(_)y=function(e){var a=t.Internals.DDSTools.GetDDSInfo(e),h=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&!i&&a.width>>a.mipmapCount-1==1;s(p,c._gl,n,a.width,a.height,r,!h,a.isFourCC,function(){t.Internals.DDSTools.UploadDDSLevels(c._gl,c.getCaps().s3tc,e,a,h,1)},o)},d instanceof Array?y(l):t.Tools.LoadFile(e,function(t){y(t)},null,n.database,!0,v);else{var x=function(e){s(p,c._gl,n,e.width,e.height,r,i,!1,function(i,r){var n=e.width===i&&e.height===r;n||(c._prepareWorkingCanvas(),c._workingCanvas.width=i,c._workingCanvas.height=r,o===t.Texture.NEAREST_SAMPLINGMODE&&(c._workingContext.imageSmoothingEnabled=!1,c._workingContext.mozImageSmoothingEnabled=!1,c._workingContext.oImageSmoothingEnabled=!1,c._workingContext.webkitImageSmoothingEnabled=!1,c._workingContext.msImageSmoothingEnabled=!1),c._workingContext.drawImage(e,0,0,e.width,e.height,0,0,i,r),o===t.Texture.NEAREST_SAMPLINGMODE&&(c._workingContext.imageSmoothingEnabled=!0,c._workingContext.mozImageSmoothingEnabled=!0,c._workingContext.oImageSmoothingEnabled=!0,c._workingContext.webkitImageSmoothingEnabled=!0,c._workingContext.msImageSmoothingEnabled=!0)),c._gl.texImage2D(c._gl.TEXTURE_2D,0,c._gl.RGBA,c._gl.RGBA,c._gl.UNSIGNED_BYTE,n?e:c._workingCanvas)},o)};d instanceof Array?t.Tools.LoadImage(l,x,v,n.database):t.Tools.LoadImage(e,x,v,n.database)}return p},o.prototype._getInternalFormat=function(t){var e=this._gl.RGBA;switch(t){case o.TEXTUREFORMAT_ALPHA:e=this._gl.ALPHA;break;case o.TEXTUREFORMAT_LUMINANCE:e=this._gl.LUMINANCE;break;case o.TEXTUREFORMAT_LUMINANCE_ALPHA:e=this._gl.LUMINANCE_ALPHA;break;case o.TEXTUREFORMAT_RGB:e=this._gl.RGB;break;case o.TEXTUREFORMAT_RGBA:e=this._gl.RGBA}return e},o.prototype.updateRawTexture=function(t,e,i,r,n){void 0===n&&(n=null);var s=this._getInternalFormat(i);this._bindTextureDirectly(this._gl.TEXTURE_2D,t),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,void 0===r?1:r?1:0),t._width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[n],t._width,t._height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,t._width,t._height,0,s,this._gl.UNSIGNED_BYTE,e),t.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this.resetTextureCache(),t.isReady=!0},o.prototype.createRawTexture=function(t,e,i,r,s,o,a,h){void 0===h&&(h=null);var l=this._gl.createTexture();l._baseWidth=e,l._baseHeight=i,l._width=e,l._height=i,l.references=1,this.updateRawTexture(l,t,r,o,h),this._bindTextureDirectly(this._gl.TEXTURE_2D,l);var c=n(a,s,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,c.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,c.min),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),l.samplingMode=a,this._loadedTexturesCache.push(l),l},o.prototype.createDynamicTexture=function(e,i,r,n){var s=this._gl.createTexture();return s._baseWidth=e,s._baseHeight=i,r&&(e=t.Tools.GetExponentOfTwo(e,this._caps.maxTextureSize),i=t.Tools.GetExponentOfTwo(i,this._caps.maxTextureSize)),this.resetTextureCache(),s._width=e,s._height=i,s.isReady=!1,s.generateMipMaps=r,s.references=1,s.samplingMode=n,this.updateTextureSamplingMode(n,s),this._loadedTexturesCache.push(s),s},o.prototype.updateTextureSamplingMode=function(t,e){var i=n(t,e.generateMipMaps,this._gl);e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MAG_FILTER,i.mag),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MIN_FILTER,i.min),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,i.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,i.min),this._bindTextureDirectly(this._gl.TEXTURE_2D,null))},o.prototype.updateDynamicTexture=function(t,e,i,r){void 0===r&&(r=!1),this._bindTextureDirectly(this._gl.TEXTURE_2D,t),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?1:0),r&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),t.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),r&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.resetTextureCache(),t.isReady=!0},o.prototype.updateVideoTexture=function(t,e,i){if(!t._isDisabled){this._bindTextureDirectly(this._gl.TEXTURE_2D,t),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?0:1);try{void 0===this._videoTextureSupported&&(this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported?this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e):(t._workingCanvas||(t._workingCanvas=document.createElement("canvas"),t._workingContext=t._workingCanvas.getContext("2d"),t._workingCanvas.width=t._width,t._workingCanvas.height=t._height),t._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,t._width,t._height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t._workingCanvas)),t.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this.resetTextureCache(),t.isReady=!0}catch(e){t._isDisabled=!0}}},o.prototype.createRenderTargetTexture=function(e,i){var s=!1,a=!0,h=!1,l=o.TEXTURETYPE_UNSIGNED_INT,c=t.Texture.TRILINEAR_SAMPLINGMODE;void 0!==i&&(s=void 0===i.generateMipMaps?i:i.generateMipMaps,a=void 0===i.generateDepthBuffer||i.generateDepthBuffer,h=a&&i.generateStencilBuffer,l=void 0===i.type?l:i.type,void 0!==i.samplingMode&&(c=i.samplingMode),l!==o.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?l!==o.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(c=t.Texture.NEAREST_SAMPLINGMODE):c=t.Texture.NEAREST_SAMPLINGMODE);var u=this._gl,p=u.createTexture();this._bindTextureDirectly(u.TEXTURE_2D,p);var d=e.width||e,f=e.height||e,m=n(c,s,u);l!==o.TEXTURETYPE_FLOAT||this._caps.textureFloat||(l=o.TEXTURETYPE_UNSIGNED_INT,t.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,m.mag),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,m.min),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,d,f,0,u.RGBA,r(u,l),null);var _;h?(_=u.createRenderbuffer(),u.bindRenderbuffer(u.RENDERBUFFER,_),u.renderbufferStorage(u.RENDERBUFFER,u.DEPTH_STENCIL,d,f)):a&&(_=u.createRenderbuffer(),u.bindRenderbuffer(u.RENDERBUFFER,_),u.renderbufferStorage(u.RENDERBUFFER,u.DEPTH_COMPONENT16,d,f));var g=u.createFramebuffer();return this.bindUnboundFramebuffer(g),h?u.framebufferRenderbuffer(u.FRAMEBUFFER,u.DEPTH_STENCIL_ATTACHMENT,u.RENDERBUFFER,_):a&&u.framebufferRenderbuffer(u.FRAMEBUFFER,u.DEPTH_ATTACHMENT,u.RENDERBUFFER,_),u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,p,0),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(u.TEXTURE_2D,null),u.bindRenderbuffer(u.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),p._framebuffer=g,a&&(p._depthBuffer=_),p._baseWidth=d,p._baseHeight=f,p._width=d,p._height=f,p.isReady=!0,p.generateMipMaps=s,p.references=1,p.samplingMode=c,p.type=l,this.resetTextureCache(),this._loadedTexturesCache.push(p),p},o.prototype.createRenderTargetCubeTexture=function(e,i){var r=this._gl,s=r.createTexture(),o=!0,a=!0,h=!1,l=t.Texture.TRILINEAR_SAMPLINGMODE;void 0!==i&&(o=void 0===i.generateMipMaps?i:i.generateMipMaps,a=void 0===i.generateDepthBuffer||i.generateDepthBuffer,h=a&&i.generateStencilBuffer,void 0!==i.samplingMode&&(l=i.samplingMode)),s.isCube=!0,s.references=1,s.generateMipMaps=o,s.references=1,s.samplingMode=l;var c=n(l,o,r);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,s);for(var u=0;u<6;u++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,r.RGBA,e,e,0,r.RGBA,r.UNSIGNED_BYTE,null);r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,c.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,c.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);var p;h?(p=r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,p),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,e,e)):a&&(p=r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,p),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e,e));var d=r.createFramebuffer();return this.bindUnboundFramebuffer(d),h?r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,p):a&&r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,p),s.generateMipMaps&&(this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,s),r.generateMipmap(r.TEXTURE_CUBE_MAP)),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),r.bindRenderbuffer(r.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),s._framebuffer=d,a&&(s._depthBuffer=p),s._width=e,s._height=e,s.isReady=!0,this.resetTextureCache(),this._loadedTexturesCache.push(s),s},o.prototype.createCubeTexture=function(e,i,r,n,s,o){var h=this;void 0===s&&(s=null),void 0===o&&(o=null);var l=this._gl,c=l.createTexture();c.isCube=!0,c.url=e,c.references=1,c.onLoadedCallbacks=[];var u=e.substr(e.length-4,4).toLowerCase();return this.getCaps().s3tc&&".dds"===u?t.Tools.LoadFile(e,function(e){var i=t.Internals.DDSTools.GetDDSInfo(e),r=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&!n;h._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,1),t.Internals.DDSTools.UploadDDSLevels(h._gl,h.getCaps().s3tc,e,i,r,6),n||i.isFourCC||1!==i.mipmapCount||l.generateMipmap(l.TEXTURE_CUBE_MAP),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,r?l.LINEAR_MIPMAP_LINEAR:l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),h._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.resetTextureCache(),c._width=i.width,c._height=i.height,c.isReady=!0},null,null,!0,o):a(e,i,function(e){var i=t.Tools.GetExponentOfTwo(e[0].width,h._caps.maxCubemapTextureSize),r=i;h._prepareWorkingCanvas(),h._workingCanvas.width=i,h._workingCanvas.height=r;var o=[l.TEXTURE_CUBE_MAP_POSITIVE_X,l.TEXTURE_CUBE_MAP_POSITIVE_Y,l.TEXTURE_CUBE_MAP_POSITIVE_Z,l.TEXTURE_CUBE_MAP_NEGATIVE_X,l.TEXTURE_CUBE_MAP_NEGATIVE_Y,l.TEXTURE_CUBE_MAP_NEGATIVE_Z];h._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,0);for(var a=0;a<o.length;a++)h._workingContext.drawImage(e[a],0,0,e[a].width,e[a].height,0,0,i,r),l.texImage2D(o[a],0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,h._workingCanvas);n||l.generateMipmap(l.TEXTURE_CUBE_MAP),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,n?l.LINEAR:l.LINEAR_MIPMAP_LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),h._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.resetTextureCache(),c._width=i,c._height=r,c.isReady=!0,c.onLoadedCallbacks.forEach(function(t){t()}),s&&s()},r,o),this._loadedTexturesCache.push(c),c},o.prototype.updateTextureSize=function(t,e,i){t._width=e,t._height=i,t._size=e*i,t._baseWidth=e,t._baseHeight=i},o.prototype.createRawCubeTexture=function(e,r,n,s,a,h,l,c){var u=this,p=this._gl,d=p.createTexture();r._addPendingData(d),d.isCube=!0,d.references=1,d.url=e;var f=this._getInternalFormat(s),m=p.UNSIGNED_BYTE;a===o.TEXTURETYPE_FLOAT&&(m=p.FLOAT);var _=n,g=_,y=t.Tools.IsExponentOfTwo(_)&&t.Tools.IsExponentOfTwo(g);d._width=_,d._height=g;var v=function(){r._removePendingData(d)},x=function(e){var n=l(e),s=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];if(_=d._width,g=d._height,y=t.Tools.IsExponentOfTwo(_)&&t.Tools.IsExponentOfTwo(g),u._bindTextureDirectly(p.TEXTURE_CUBE_MAP,d),p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,0),!h&&y)if(c){var o=[];o.push(n[0]),o.push(n[3]),o.push(n[1]),o.push(n[4]),o.push(n[2]),o.push(n[5]);for(var a=c(o),v=0;v<a.length;v++){var x=_>>v;p.texImage2D(s[0],v,f,x,x,0,f,m,a[v][0]),p.texImage2D(s[1],v,f,x,x,0,f,m,a[v][2]),p.texImage2D(s[2],v,f,x,x,0,f,m,a[v][4]),p.texImage2D(s[3],v,f,x,x,0,f,m,a[v][1]),p.texImage2D(s[4],v,f,x,x,0,f,m,a[v][3]),p.texImage2D(s[5],v,f,x,x,0,f,m,a[v][5])}}else{for(var b=0;b<s.length;b++){var P=n[b];p.texImage2D(s[b],0,f,_,g,0,f,m,P)}if(p.generateMipmap(p.TEXTURE_CUBE_MAP),m===p.FLOAT&&f===p.RGB&&1282===p.getError()){t.Tools.Log("RGB32F not renderable on Firefox, trying fallback to RGBA32F.");for(var b=0;b<s.length;b++){for(var P=n[b],T=new Float32Array(_*g*4),S=0;S<_;S++)for(var A=0;A<g;A++){var C=3*(A*_+S),E=4*(A*_+S);T[E+0]=P[C+0],T[E+1]=P[C+1],T[E+2]=P[C+2],T[E+3]=1}p.texImage2D(s[b],0,p.RGBA,_,g,0,p.RGBA,m,T)}p.generateMipmap(p.TEXTURE_CUBE_MAP)}}else h=!0;(m!==p.FLOAT||u._caps.textureFloatLinearFiltering)&&(m!==i||u._caps.textureHalfFloatLinearFiltering)?(p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MAG_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MIN_FILTER,h?p.LINEAR:p.LINEAR_MIPMAP_LINEAR)):(p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_MIN_FILTER,p.NEAREST)),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_CUBE_MAP,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),u._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null),d.isReady=!0,u.resetTextureCache(),r._removePendingData(d)};return t.Tools.LoadFile(e,function(t){x(t)},v,r.database,!0),d},o.prototype._releaseTexture=function(t){var e=this._gl;t._framebuffer&&e.deleteFramebuffer(t._framebuffer),t._depthBuffer&&e.deleteRenderbuffer(t._depthBuffer),e.deleteTexture(t),this.unbindAllTextures();var i=this._loadedTexturesCache.indexOf(t);i!==-1&&this._loadedTexturesCache.splice(i,1)},o.prototype.setProgram=function(t){this._currentProgram!==t&&(this._gl.useProgram(t),this._currentProgram=t)},o.prototype.bindSamplers=function(t){this.setProgram(t.getProgram());for(var e=t.getSamplers(),i=0;i<e.length;i++){var r=t.getUniform(e[i]);this._gl.uniform1i(r,i)}this._currentEffect=null},o.prototype.activateTexture=function(t){this._activeTexture!==t&&(this._gl.activeTexture(t),this._activeTexture=t)},o.prototype._bindTextureDirectly=function(t,e){this._activeTexturesCache[this._activeTexture]!==e&&(this._gl.bindTexture(t,e),this._activeTexturesCache[this._activeTexture]=e)},o.prototype._bindTexture=function(t,e){t<0||(this.activateTexture(this._gl["TEXTURE"+t]),this._bindTextureDirectly(this._gl.TEXTURE_2D,e))},o.prototype.setTextureFromPostProcess=function(t,e){this._bindTexture(t,e._textures.data[e._currentRenderTextureInd])},o.prototype.unbindAllTextures=function(){for(var t=0;t<this._caps.maxTexturesImageUnits;t++)this.activateTexture(this._gl["TEXTURE"+t]),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)},o.prototype.setTexture=function(t,e,i){t<0||(this._gl.uniform1i(e,t),this._setTexture(t,i))},o.prototype._setTexture=function(e,i){if(!i||!i.isReady())return void(null!=this._activeTexturesCache[e]&&(this.activateTexture(this._gl["TEXTURE"+e]),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)));var r=!1;if(i instanceof t.VideoTexture)this.activateTexture(this._gl["TEXTURE"+e]),r=!0,i.update();else if(i.delayLoadState===o.DELAYLOADSTATE_NOTLOADED)return void i.delayLoad();var n=i.getInternalTexture();if(this._activeTexturesCache[e]!==n)if(r||this.activateTexture(this._gl["TEXTURE"+e]),n.isCube){if(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,n),n._cachedCoordinatesMode!==i.coordinatesMode){n._cachedCoordinatesMode=i.coordinatesMode;var s=i.coordinatesMode!==t.Texture.CUBIC_MODE&&i.coordinatesMode!==t.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,s),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,s)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,i)}else{if(this._bindTextureDirectly(this._gl.TEXTURE_2D,n),n._cachedWrapU!==i.wrapU)switch(n._cachedWrapU=i.wrapU,i.wrapU){case t.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case t.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case t.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT)}if(n._cachedWrapV!==i.wrapV)switch(n._cachedWrapV=i.wrapV,i.wrapV){case t.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case t.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case t.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT)}this._setAnisotropicLevel(this._gl.TEXTURE_2D,i)}},o.prototype.setTextureArray=function(t,e,i){if(!(t<0)){this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length));for(var r=0;r<i.length;r++)this._textureUnits[r]=t+r;this._gl.uniform1iv(e,this._textureUnits);for(var n=0;n<i.length;n++)this._setTexture(t+n,i[n])}},o.prototype._setAnisotropicLevel=function(e,i){var r=this._caps.textureAnisotropicFilterExtension,n=i.anisotropicFilteringLevel;i.getInternalTexture().samplingMode===t.Texture.NEAREST_SAMPLINGMODE&&(n=1),r&&i._cachedAnisotropicFilteringLevel!==n&&(this._gl.texParameterf(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n,this._caps.maxAnisotropy)),i._cachedAnisotropicFilteringLevel=n)},o.prototype.readPixels=function(t,e,i,r){var n=new Uint8Array(r*i*4);return this._gl.readPixels(t,e,i,r,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n),n},o.prototype.addExternalData=function(t,e){return this._externalData.add(t,e)},o.prototype.getExternalData=function(t){return this._externalData.get(t)},o.prototype.getOrAddExternalDataWithFactory=function(t,e){return this._externalData.getOrAddWithFactory(t,e)},o.prototype.removeExternalData=function(t){return this._externalData.remove(t)},o.prototype.releaseInternalTexture=function(t){if(t&&0===--t.references){var e=this.getLoadedTexturesCache(),i=e.indexOf(t);i>-1&&e.splice(i,1),this._releaseTexture(t)}},o.prototype.unbindAllAttributes=function(){for(var t=0,e=this._vertexAttribArraysEnabled.length;t<e;t++)t>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[t]||(this._gl.disableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!1)},o.prototype.dispose=function(){for(this.hideLoadingUI(),this.stopRenderLoop();this.scenes.length;)this.scenes[0].dispose();o.audioEngine.dispose();for(var t in this._compiledEffects)this._gl.deleteProgram(this._compiledEffects[t]._program);this.unbindAllAttributes(),this._gl=null,this.disableVR(),window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)},o.prototype.displayLoadingUI=function(){this._loadingScreen.displayLoadingUI()},o.prototype.hideLoadingUI=function(){this._loadingScreen.hideLoadingUI()},Object.defineProperty(o.prototype,"loadingScreen",{get:function(){return this._loadingScreen},set:function(t){this._loadingScreen=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"loadingUIText",{set:function(t){this._loadingScreen.loadingUIText=t},enumerable:!0,configurable:!0}),Object.defineProperty(o.prototype,"loadingUIBackgroundColor",{set:function(t){this._loadingScreen.loadingUIBackgroundColor=t},enumerable:!0,configurable:!0}),o.prototype.attachContextLostEvent=function(t){this._renderingCanvas.addEventListener("webglcontextlost",t,!1)},o.prototype.attachContextRestoredEvent=function(t){this._renderingCanvas.addEventListener("webglcontextrestored",t,!1)},o.prototype.getVertexShaderSource=function(t){var e=this._gl.getAttachedShaders(t);return this._gl.getShaderSource(e[0])},o.prototype.getFragmentShaderSource=function(t){var e=this._gl.getAttachedShaders(t);return this._gl.getShaderSource(e[1])},o.prototype.getFps=function(){return this.fps},o.prototype.getDeltaTime=function(){return this.deltaTime},o.prototype._measureFps=function(){this.previousFramesDuration.push(t.Tools.Now);var e=this.previousFramesDuration.length;if(e>=2&&(this.deltaTime=this.previousFramesDuration[e-1]-this.previousFramesDuration[e-2]),e>=this.fpsRange){e>this.fpsRange&&(this.previousFramesDuration.splice(0,1),e=this.previousFramesDuration.length);for(var i=0,r=0;r<e-1;r++)i+=this.previousFramesDuration[r+1]-this.previousFramesDuration[r];this.fps=1e3/(i/(e-1))}},o.prototype._canRenderToFloatTexture=function(){return this._canRenderToTextureOfType(t.Engine.TEXTURETYPE_FLOAT,"OES_texture_float")},o.prototype._canRenderToHalfFloatTexture=function(){return this._canRenderToTextureOfType(t.Engine.TEXTURETYPE_HALF_FLOAT,"OES_texture_half_float")},o.prototype._canRenderToTextureOfType=function(e,i){var n=document.createElement("canvas");n.height=16,n.width=16;var s=n.getContext("webgl")||n.getContext("experimental-webgl");if(!s.getExtension(i))return!1;var o="attribute vec4 a_position;\n                void main() {\n                    gl_Position = a_position;\n                }",a="precision mediump float;\n                uniform vec4 u_color;\n                uniform sampler2D u_texture;\n\n                void main() {\n                    gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;\n                }",h=this.createShaderProgram(o,a,null,s);s.useProgram(h);var l=s.getAttribLocation(h,"a_position"),c=s.getUniformLocation(h,"u_color"),u=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,u),s.bufferData(s.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s.STATIC_DRAW),s.enableVertexAttribArray(l),s.vertexAttribPointer(l,2,s.FLOAT,!1,0,0);var p=s.createTexture();s.bindTexture(s.TEXTURE_2D,p),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,1,1,0,s.RGBA,s.UNSIGNED_BYTE,new Uint8Array([255,255,255,255]));var d=s.createTexture();s.bindTexture(s.TEXTURE_2D,d),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,1,1,0,s.RGBA,r(s,e),null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST);var f=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,f),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,d,0);var m=function(){s.deleteProgram(h),s.disableVertexAttribArray(l),s.deleteBuffer(u),s.deleteFramebuffer(f),s.deleteTexture(p),s.deleteTexture(d)};if(s.checkFramebufferStatus(s.FRAMEBUFFER)!==s.FRAMEBUFFER_COMPLETE)return t.Tools.Log("GL Support: can **NOT** render to "+e+" texture"),m(),!1;s.bindTexture(s.TEXTURE_2D,p),s.uniform4fv(c,[0,10,20,1]),s.drawArrays(s.TRIANGLES,0,6),s.bindTexture(s.TEXTURE_2D,d),s.bindFramebuffer(s.FRAMEBUFFER,null),s.clearColor(1,0,0,1),s.clear(s.COLOR_BUFFER_BIT),s.uniform4fv(c,[0,.1,.05,1]),s.drawArrays(s.TRIANGLES,0,6);var _=new Uint8Array(4);return s.readPixels(0,0,1,1,s.RGBA,s.UNSIGNED_BYTE,_),0!==_[0]||_[1]<248||_[2]<248||_[3]<254?(t.Tools.Log("GL Support: Was not able to actually render to "+e+" texture"),m(),!1):(m(),!0)},o.isSupported=function(){try{if(navigator.isCocoonJS)return!0;var t=document.createElement("canvas");return null!=(t.getContext("webgl")||t.getContext("experimental-webgl"))&&!!window.WebGLRenderingContext}catch(t){return!1}},o._ALPHA_DISABLE=0,o._ALPHA_ADD=1,o._ALPHA_COMBINE=2,o._ALPHA_SUBTRACT=3,o._ALPHA_MULTIPLY=4,o._ALPHA_MAXIMIZED=5,o._ALPHA_ONEONE=6,o._DELAYLOADSTATE_NONE=0,o._DELAYLOADSTATE_LOADED=1,o._DELAYLOADSTATE_LOADING=2,o._DELAYLOADSTATE_NOTLOADED=4,o._TEXTUREFORMAT_ALPHA=0,o._TEXTUREFORMAT_LUMINANCE=1,o._TEXTUREFORMAT_LUMINANCE_ALPHA=2,o._TEXTUREFORMAT_RGB=4,o._TEXTUREFORMAT_RGBA=5,o._TEXTURETYPE_UNSIGNED_INT=0,o._TEXTURETYPE_FLOAT=1,o._TEXTURETYPE_HALF_FLOAT=2,o._NEVER=512,o._ALWAYS=519,o._LESS=513,o._EQUAL=514,o._LEQUAL=515,o._GREATER=516,o._GEQUAL=518,o._NOTEQUAL=517,o._KEEP=7680,o._REPLACE=7681,o._INCR=7682,o._DECR=7683,o._INVERT=5386,o._INCR_WRAP=34055,o._DECR_WRAP=34056,o.CollisionsEpsilon=.001,o.CodeRepository="src/",o.ShadersRepository="src/Shaders/",o}();t.Engine=c}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){this.state="",this.metadata=null,this.doNotSerialize=!1,this.animations=new Array,this._ranges={},this._childrenFlag=-1,this._isEnabled=!0,this._isReady=!0,this._currentRenderId=-1,this._parentRenderId=-1,this.onDisposeObservable=new t.Observable,this.name=e,this.id=e,this._scene=i,this._initCache()}return Object.defineProperty(e.prototype,"parent",{get:function(){return this._parentNode},set:function(t){if(this._parentNode!==t){if(this._parentNode){var e=this._parentNode._children.indexOf(this);e!==-1&&this._parentNode._children.splice(e,1)}this._parentNode=t,this._parentNode&&(this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this))}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getEngine=function(){return this._scene.getEngine()},e.prototype.getWorldMatrix=function(){return t.Matrix.Identity()},e.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},e.prototype.updateCache=function(t){!t&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())},e.prototype._updateCache=function(t){},e.prototype._isSynchronized=function(){return!0},e.prototype._markSyncedWithParent=function(){this._parentRenderId=this.parent._currentRenderId},e.prototype.isSynchronizedWithParent=function(){return!this.parent||this._parentRenderId===this.parent._currentRenderId&&this.parent.isSynchronized()},e.prototype.isSynchronized=function(t){var e=this.hasNewParent();return e=e||!this.isSynchronizedWithParent(),e=e||!this._isSynchronized(),t&&this.updateCache(!0),!e},e.prototype.hasNewParent=function(t){return this._cache.parent!==this.parent&&(t&&(this._cache.parent=this.parent),!0)},e.prototype.isReady=function(){return this._isReady},e.prototype.isEnabled=function(){return!!this._isEnabled&&(!this.parent||this.parent.isEnabled())},e.prototype.setEnabled=function(t){this._isEnabled=t},e.prototype.isDescendantOf=function(t){return!!this.parent&&(this.parent===t||this.parent.isDescendantOf(t))},e.prototype._getDescendants=function(t,e,i){if(void 0===e&&(e=!1),this._children)for(var r=0;r<this._children.length;r++){var n=this._children[r];i&&!i(n)||t.push(n),e||n._getDescendants(t,!1,i)}},e.prototype.getDescendants=function(t,e){var i=[];return this._getDescendants(i,t,e),i},e.prototype.getChildren=function(t){return this.getDescendants(!0,t)},e.prototype.getChildMeshes=function(e,i){var r=[];return this._getDescendants(r,e,function(e){return(!i||i(e))&&e instanceof t.AbstractMesh}),r},e.prototype._setReady=function(t){if(t!==this._isReady){if(!t)return void(this._isReady=!1);this._isReady=!0,this.onReady&&this.onReady(this)}},e.prototype.getAnimationByName=function(t){for(var e=0;e<this.animations.length;e++){var i=this.animations[e];if(i.name===t)return i}return null},e.prototype.createAnimationRange=function(e,i,r){if(!this._ranges[e]){this._ranges[e]=new t.AnimationRange(e,i,r);for(var n=0,s=this.animations.length;n<s;n++)this.animations[n]&&this.animations[n].createRange(e,i,r)}},e.prototype.deleteAnimationRange=function(t,e){void 0===e&&(e=!0);for(var i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(t,e);this._ranges[t]=void 0},e.prototype.getAnimationRange=function(t){return this._ranges[t]},e.prototype.beginAnimation=function(t,e,i,r){var n=this.getAnimationRange(t);if(!n)return null;this._scene.beginAnimation(this,n.from,n.to,e,i,r)},e.prototype.serializeAnimationRanges=function(){var t=[];for(var e in this._ranges){var i={};i.name=e,i.from=this._ranges[e].from,i.to=this._ranges[e].to,t.push(i)}return t},e.prototype.dispose=function(){this.parent=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e.ParseAnimationRanges=function(t,e,i){if(e.ranges)for(var r=0;r<e.ranges.length;r++){var n=e.ranges[r];t.createAnimationRange(n.name,n.from,n.to)}},s([t.serialize()],e.prototype,"name",void 0),s([t.serialize()],e.prototype,"id",void 0),s([t.serialize()],e.prototype,"uniqueId",void 0),s([t.serialize()],e.prototype,"state",void 0),s([t.serialize()],e.prototype,"metadata",void 0),e}();t.Node=e}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i,r,n,s,o,a){this._engine=t,this._canvas=i,this._currentScene=e,this._sceneLoadedCallback=r,this._progressCallback=n,this._additionnalRenderLoopLogicCallback=s,this._textureLoadingCallback=o,this._startingProcessingFilesCallback=a}return e.prototype.monitorElementForDragNDrop=function(t){var e=this;t&&(this._elementToMonitor=t,this._elementToMonitor.addEventListener("dragenter",function(t){e.drag(t)},!1),this._elementToMonitor.addEventListener("dragover",function(t){e.drag(t)},!1),this._elementToMonitor.addEventListener("drop",function(t){e.drop(t)},!1))},e.prototype.renderFunction=function(){if(this._additionnalRenderLoopLogicCallback&&this._additionnalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){var t=this._currentScene.getWaitingItemsCount();t>0&&this._textureLoadingCallback(t)}this._currentScene.render()}},e.prototype.drag=function(t){t.stopPropagation(),t.preventDefault()},e.prototype.drop=function(t){t.stopPropagation(),t.preventDefault(),this.loadFiles(t)},e.prototype.loadFiles=function(t){if(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(),t&&t.dataTransfer&&t.dataTransfer.files&&(this._filesToLoad=t.dataTransfer.files),t&&t.target&&t.target.files&&(this._filesToLoad=t.target.files),this._filesToLoad&&this._filesToLoad.length>0){for(var i=0;i<this._filesToLoad.length;i++)switch(this._filesToLoad[i].type){case"image/jpeg":case"image/png":case"image/bmp":e.FilesTextures[this._filesToLoad[i].name.toLowerCase()]=this._filesToLoad[i];break;case"image/targa":case"image/vnd.ms-dds":case"audio/wav":case"audio/x-wav":case"audio/mp3":case"audio/mpeg":case"audio/mpeg3":case"audio/x-mpeg-3":case"audio/ogg":e.FilesToLoad[this._filesToLoad[i].name.toLowerCase()]=this._filesToLoad[i];break;default:this._filesToLoad[i].name.indexOf(".mtl")!==-1?e.FilesToLoad[this._filesToLoad[i].name.toLowerCase()]=this._filesToLoad[i]:this._filesToLoad[i].name.indexOf(".babylon")===-1&&this._filesToLoad[i].name.indexOf(".stl")===-1&&this._filesToLoad[i].name.indexOf(".obj")===-1||this._filesToLoad[i].name.indexOf(".manifest")!==-1||this._filesToLoad[i].name.indexOf(".incremental")!==-1||this._filesToLoad[i].name.indexOf(".babylonmeshdata")!==-1||this._filesToLoad[i].name.indexOf(".babylongeometrydata")!==-1||this._filesToLoad[i].name.indexOf(".babylonbinarymeshdata")!==-1||this._filesToLoad[i].name.indexOf(".binary.babylon")!==-1||(this._sceneFileToLoad=this._filesToLoad[i])}this.reload()}},e.prototype.reload=function(){var e=this,i=this;this._sceneFileToLoad?(this._currentScene&&(t.Tools.errorsCount>0&&(t.Tools.ClearLogCache(),t.Tools.Log("Babylon.js engine (v"+t.Engine.Version+") launched")),this._engine.stopRenderLoop(),this._currentScene.dispose()),t.SceneLoader.Load("file:",this._sceneFileToLoad,this._engine,function(t){i._currentScene=t,i._currentScene.executeWhenReady(function(){i._currentScene.activeCamera&&0!==i._currentScene.lights.length||i._currentScene.createDefaultCameraOrLight(),i._currentScene.activeCamera.attachControl(i._canvas),i._sceneLoadedCallback&&i._sceneLoadedCallback(e._sceneFileToLoad,i._currentScene),i._engine.runRenderLoop(function(){i.renderFunction()})})},function(t){e._progressCallback&&e._progressCallback(t)})):t.Tools.Error("Please provide a valid .babylon file.")},e.FilesTextures=new Array,e.FilesToLoad=new Array,e}();t.FilesInput=e}(r||(r={}));var r;!function(t){var e=function(){function t(t,e,i){this.bu=t,this.bv=e,this.distance=i,this.faceId=0,this.subMeshId=0}return t}();t.IntersectionInfo=e;var i=function(){function e(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshId=0,this.pickedSprite=null}return e.prototype.getNormal=function(e,i){if(void 0===e&&(e=!1),void 0===i&&(i=!0),!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(t.VertexBuffer.NormalKind))return null;var r,n=this.pickedMesh.getIndices();if(i){var s=this.pickedMesh.getVerticesData(t.VertexBuffer.NormalKind),o=t.Vector3.FromArray(s,3*n[3*this.faceId]),a=t.Vector3.FromArray(s,3*n[3*this.faceId+1]),h=t.Vector3.FromArray(s,3*n[3*this.faceId+2]);o=o.scale(this.bu),a=a.scale(this.bv),h=h.scale(1-this.bu-this.bv),r=new t.Vector3(o.x+a.x+h.x,o.y+a.y+h.y,o.z+a.z+h.z)}else{var l=this.pickedMesh.getVerticesData(t.VertexBuffer.PositionKind),c=t.Vector3.FromArray(l,3*n[3*this.faceId]),u=t.Vector3.FromArray(l,3*n[3*this.faceId+1]),p=t.Vector3.FromArray(l,3*n[3*this.faceId+2]),d=c.subtract(u),f=p.subtract(u);r=t.Vector3.Cross(d,f)}return e&&(r=t.Vector3.TransformNormal(r,this.pickedMesh.getWorldMatrix())),t.Vector3.Normalize(r)},e.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(t.VertexBuffer.UVKind))return null;var e=this.pickedMesh.getIndices(),i=this.pickedMesh.getVerticesData(t.VertexBuffer.UVKind),r=t.Vector2.FromArray(i,2*e[3*this.faceId]),n=t.Vector2.FromArray(i,2*e[3*this.faceId+1]),s=t.Vector2.FromArray(i,2*e[3*this.faceId+2]);return r=r.scale(1-this.bu-this.bv),n=n.scale(this.bu),s=s.scale(this.bv),new t.Vector2(r.x+n.x+s.x,r.y+n.y+s.y)},e}();t.PickingInfo=i}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){this.minimum=e,this.maximum=i,this._tempRadiusVector=t.Vector3.Zero();var r=t.Vector3.Distance(e,i);this.center=t.Vector3.Lerp(e,i,.5),this.radius=.5*r,this.centerWorld=t.Vector3.Zero(),this._update(t.Matrix.Identity())}return e.prototype._update=function(e){t.Vector3.TransformCoordinatesToRef(this.center,e,this.centerWorld),t.Vector3.TransformNormalFromFloatsToRef(1,1,1,e,this._tempRadiusVector),this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius},e.prototype.isInFrustum=function(t){for(var e=0;e<6;e++)if(t[e].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},e.prototype.intersectsPoint=function(e){var i=this.centerWorld.x-e.x,r=this.centerWorld.y-e.y,n=this.centerWorld.z-e.z,s=Math.sqrt(i*i+r*r+n*n);return!(Math.abs(this.radiusWorld-s)<t.Epsilon)},e.Intersects=function(t,e){var i=t.centerWorld.x-e.centerWorld.x,r=t.centerWorld.y-e.centerWorld.y,n=t.centerWorld.z-e.centerWorld.z,s=Math.sqrt(i*i+r*r+n*n);return!(t.radiusWorld+e.radiusWorld<s)},e}();t.BoundingSphere=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){this.minimum=e,this.maximum=i,this.vectors=new Array,this.vectorsWorld=new Array,this.vectors.push(this.minimum.clone()),this.vectors.push(this.maximum.clone()),this.vectors.push(this.minimum.clone()),this.vectors[2].x=this.maximum.x,this.vectors.push(this.minimum.clone()),this.vectors[3].y=this.maximum.y,this.vectors.push(this.minimum.clone()),this.vectors[4].z=this.maximum.z,this.vectors.push(this.maximum.clone()),this.vectors[5].z=this.minimum.z,this.vectors.push(this.maximum.clone()),this.vectors[6].x=this.minimum.x,this.vectors.push(this.maximum.clone()),this.vectors[7].y=this.minimum.y,this.center=this.maximum.add(this.minimum).scale(.5),this.extendSize=this.maximum.subtract(this.minimum).scale(.5),this.directions=[t.Vector3.Zero(),t.Vector3.Zero(),t.Vector3.Zero()];for(var r=0;r<this.vectors.length;r++)this.vectorsWorld[r]=t.Vector3.Zero();this.minimumWorld=t.Vector3.Zero(),this.maximumWorld=t.Vector3.Zero(),this._update(t.Matrix.Identity())}return e.prototype.getWorldMatrix=function(){return this._worldMatrix},e.prototype.setWorldMatrix=function(t){return this._worldMatrix.copyFrom(t),this},e.prototype._update=function(e){t.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),t.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var i=0;i<this.vectors.length;i++){var r=this.vectorsWorld[i];t.Vector3.TransformCoordinatesToRef(this.vectors[i],e,r),r.x<this.minimumWorld.x&&(this.minimumWorld.x=r.x),r.y<this.minimumWorld.y&&(this.minimumWorld.y=r.y),r.z<this.minimumWorld.z&&(this.minimumWorld.z=r.z),r.x>this.maximumWorld.x&&(this.maximumWorld.x=r.x),r.y>this.maximumWorld.y&&(this.maximumWorld.y=r.y),r.z>this.maximumWorld.z&&(this.maximumWorld.z=r.z)}this.maximumWorld.addToRef(this.minimumWorld,this.center),this.center.scaleInPlace(.5),t.Vector3.FromFloatArrayToRef(e.m,0,this.directions[0]),t.Vector3.FromFloatArrayToRef(e.m,4,this.directions[1]),t.Vector3.FromFloatArrayToRef(e.m,8,this.directions[2]),this._worldMatrix=e},e.prototype.isInFrustum=function(t){return e.IsInFrustum(this.vectorsWorld,t)},e.prototype.isCompletelyInFrustum=function(t){return e.IsCompletelyInFrustum(this.vectorsWorld,t)},e.prototype.intersectsPoint=function(e){var i=-t.Epsilon;return!(this.maximumWorld.x-e.x<i||i>e.x-this.minimumWorld.x)&&(!(this.maximumWorld.y-e.y<i||i>e.y-this.minimumWorld.y)&&!(this.maximumWorld.z-e.z<i||i>e.z-this.minimumWorld.z))},e.prototype.intersectsSphere=function(t){return e.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)},e.prototype.intersectsMinMax=function(t,e){return!(this.maximumWorld.x<t.x||this.minimumWorld.x>e.x)&&(!(this.maximumWorld.y<t.y||this.minimumWorld.y>e.y)&&!(this.maximumWorld.z<t.z||this.minimumWorld.z>e.z))},e.Intersects=function(t,e){return!(t.maximumWorld.x<e.minimumWorld.x||t.minimumWorld.x>e.maximumWorld.x)&&(!(t.maximumWorld.y<e.minimumWorld.y||t.minimumWorld.y>e.maximumWorld.y)&&!(t.maximumWorld.z<e.minimumWorld.z||t.minimumWorld.z>e.maximumWorld.z))},e.IntersectsSphere=function(e,i,r,n){var s=t.Vector3.Clamp(r,e,i);return t.Vector3.DistanceSquared(r,s)<=n*n},e.IsCompletelyInFrustum=function(t,e){for(var i=0;i<6;i++)for(var r=0;r<8;r++)if(e[i].dotCoordinate(t[r])<0)return!1;return!0},e.IsInFrustum=function(t,e){for(var i=0;i<6;i++){for(var r=8,n=0;n<8&&e[i].dotCoordinate(t[n])<0;n++)--r;if(0===r)return!1}return!0},e}();t.BoundingBox=e}(r||(r={}));var r;!function(t){var e=function(e,i){var r=t.Vector3.Dot(i.center,e),n=Math.abs(t.Vector3.Dot(i.directions[0],e))*i.extendSize.x,s=Math.abs(t.Vector3.Dot(i.directions[1],e))*i.extendSize.y,o=Math.abs(t.Vector3.Dot(i.directions[2],e))*i.extendSize.z,a=n+s+o;return{min:r-a,max:r+a}},i=function(t,e,i,r){return!(t>r||i>e)},r=function(t,r,n){var s=e(t,r),o=e(t,n);return i(s.min,s.max,o.min,o.max)},n=function(){function e(e,i){this.minimum=e,this.maximum=i,this._isLocked=!1,this.boundingBox=new t.BoundingBox(e,i),this.boundingSphere=new t.BoundingSphere(e,i)}return Object.defineProperty(e.prototype,"isLocked",{get:function(){return this._isLocked},set:function(t){this._isLocked=t},enumerable:!0,configurable:!0}),e.prototype.update=function(t){this._isLocked||(this.boundingBox._update(t),this.boundingSphere._update(t))},e.prototype.isInFrustum=function(t){return!!this.boundingSphere.isInFrustum(t)&&this.boundingBox.isInFrustum(t)},e.prototype.isCompletelyInFrustum=function(t){return this.boundingBox.isCompletelyInFrustum(t)},e.prototype._checkCollision=function(t){return t._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},e.prototype.intersectsPoint=function(t){return!!this.boundingSphere.centerWorld&&(!!this.boundingSphere.intersectsPoint(t)&&!!this.boundingBox.intersectsPoint(t))},e.prototype.intersects=function(e,i){if(!this.boundingSphere.centerWorld||!e.boundingSphere.centerWorld)return!1;if(!t.BoundingSphere.Intersects(this.boundingSphere,e.boundingSphere))return!1;if(!t.BoundingBox.Intersects(this.boundingBox,e.boundingBox))return!1;if(!i)return!0;var n=this.boundingBox,s=e.boundingBox;return!!r(n.directions[0],n,s)&&(!!r(n.directions[1],n,s)&&(!!r(n.directions[2],n,s)&&(!!r(s.directions[0],n,s)&&(!!r(s.directions[1],n,s)&&(!!r(s.directions[2],n,s)&&(!!r(t.Vector3.Cross(n.directions[0],s.directions[0]),n,s)&&(!!r(t.Vector3.Cross(n.directions[0],s.directions[1]),n,s)&&(!!r(t.Vector3.Cross(n.directions[0],s.directions[2]),n,s)&&(!!r(t.Vector3.Cross(n.directions[1],s.directions[0]),n,s)&&(!!r(t.Vector3.Cross(n.directions[1],s.directions[1]),n,s)&&(!!r(t.Vector3.Cross(n.directions[1],s.directions[2]),n,s)&&(!!r(t.Vector3.Cross(n.directions[2],s.directions[0]),n,s)&&(!!r(t.Vector3.Cross(n.directions[2],s.directions[1]),n,s)&&!!r(t.Vector3.Cross(n.directions[2],s.directions[2]),n,s))))))))))))))},e}();t.BoundingInfo=n}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i){void 0===i&&(i=Number.MAX_VALUE),this.origin=t,this.direction=e,this.length=i,this._show=!1}return e.prototype.intersectsBoxMinMax=function(t,e){var i,r,n,s,o=0,a=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<t.x||this.origin.x>e.x)return!1}else if(i=1/this.direction.x,r=(t.x-this.origin.x)*i,n=(e.x-this.origin.x)*i,n===-(1/0)&&(n=1/0),r>n&&(s=r,r=n,n=s),o=Math.max(r,o),a=Math.min(n,a),o>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<t.y||this.origin.y>e.y)return!1}else if(i=1/this.direction.y,r=(t.y-this.origin.y)*i,n=(e.y-this.origin.y)*i,n===-(1/0)&&(n=1/0),r>n&&(s=r,r=n,n=s),o=Math.max(r,o),a=Math.min(n,a),o>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<t.z||this.origin.z>e.z)return!1}else if(i=1/this.direction.z,r=(t.z-this.origin.z)*i,n=(e.z-this.origin.z)*i,n===-(1/0)&&(n=1/0),r>n&&(s=r,r=n,n=s),o=Math.max(r,o),a=Math.min(n,a),o>a)return!1;return!0},e.prototype.intersectsBox=function(t){return this.intersectsBoxMinMax(t.minimum,t.maximum)},e.prototype.intersectsSphere=function(t){var e=t.center.x-this.origin.x,i=t.center.y-this.origin.y,r=t.center.z-this.origin.z,n=e*e+i*i+r*r,s=t.radius*t.radius;if(n<=s)return!0;var o=e*this.direction.x+i*this.direction.y+r*this.direction.z;return!(o<0)&&n-o*o<=s},e.prototype.intersectsTriangle=function(e,i,r){this._edge1||(this._edge1=t.Vector3.Zero(),this._edge2=t.Vector3.Zero(),this._pvec=t.Vector3.Zero(),this._tvec=t.Vector3.Zero(),this._qvec=t.Vector3.Zero()),i.subtractToRef(e,this._edge1),r.subtractToRef(e,this._edge2),t.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var n=t.Vector3.Dot(this._edge1,this._pvec);if(0===n)return null;var s=1/n;this.origin.subtractToRef(e,this._tvec);var o=t.Vector3.Dot(this._tvec,this._pvec)*s;if(o<0||o>1)return null;t.Vector3.CrossToRef(this._tvec,this._edge1,this._qvec);var a=t.Vector3.Dot(this.direction,this._qvec)*s;if(a<0||o+a>1)return null;var h=t.Vector3.Dot(this._edge2,this._qvec)*s;return h>this.length?null:new t.IntersectionInfo(o,a,h)},e.prototype.intersectsPlane=function(e){var i,r=t.Vector3.Dot(e.normal,this.direction);if(Math.abs(r)<9.99999997475243e-7)return null;var n=t.Vector3.Dot(e.normal,this.origin);return i=(-e.d-n)/r,i<0?i<-9.99999997475243e-7?null:0:i},e.prototype.intersectsMesh=function(i,r){var n=t.Tmp.Matrix[0];return i.getWorldMatrix().invertToRef(n),this._tmpRay?e.TransformToRef(this,n,this._tmpRay):this._tmpRay=e.Transform(this,n),i.intersects(this._tmpRay,r)},e.prototype.show=function(e,i){this._show||(this._renderFunction=this._render.bind(this),this._show=!0,this._scene=e,this._renderPoints=[this.origin,this.origin.add(this.direction.scale(this.length))],this._renderLine=t.Mesh.CreateLines("ray",this._renderPoints,e,!0),this._scene.registerBeforeRender(this._renderFunction)),i&&this._renderLine.color.copyFrom(i)},e.prototype.hide=function(){this._show&&(this._show=!1,this._scene.unregisterBeforeRender(this._renderFunction)),this._renderLine&&(this._renderLine.dispose(),this._renderLine=null,this._renderPoints=null)},e.prototype._render=function(){var e=this._renderPoints[1];e.copyFrom(this.direction),e.scaleInPlace(this.length),e.addInPlace(this.origin),t.Mesh.CreateLines("ray",this._renderPoints,this._scene,!0,this._renderLine)},e.prototype.intersectionSegment=function(i,r,n){var s,o,a,h,l=this.origin.add(this.direction.multiplyByFloats(e.rayl,e.rayl,e.rayl)),c=r.subtract(i),u=l.subtract(this.origin),p=i.subtract(this.origin),d=t.Vector3.Dot(c,c),f=t.Vector3.Dot(c,u),m=t.Vector3.Dot(u,u),_=t.Vector3.Dot(c,p),g=t.Vector3.Dot(u,p),y=d*m-f*f,v=y,x=y;y<e.smallnum?(o=0,v=1,h=g,x=m):(o=f*g-m*_,h=d*g-f*_,o<0?(o=0,h=g,x=m):o>v&&(o=v,h=g+f,x=m)),h<0?(h=0,-_<0?o=0:-_>d?o=v:(o=-_,v=d)):h>x&&(h=x,-_+f<0?o=0:-_+f>d?o=v:(o=-_+f,v=d)),s=Math.abs(o)<e.smallnum?0:o/v,a=Math.abs(h)<e.smallnum?0:h/x;var b=u.multiplyByFloats(a,a,a),P=p.add(c.multiplyByFloats(s,s,s)).subtract(b);return a>0&&a<=this.length&&P.lengthSquared()<n*n?b.length():-1},e.CreateNew=function(i,r,n,s,o,a,h){var l=t.Vector3.Unproject(new t.Vector3(i,r,0),n,s,o,a,h),c=t.Vector3.Unproject(new t.Vector3(i,r,1),n,s,o,a,h),u=c.subtract(l);return u.normalize(),new e(l,u)},e.CreateNewFromTo=function(i,r,n){void 0===n&&(n=t.Matrix.Identity());var s=r.subtract(i),o=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),e.Transform(new e(i,s,o),n)},e.Transform=function(i,r){var n=t.Vector3.TransformCoordinates(i.origin,r),s=t.Vector3.TransformNormal(i.direction,r);return s.normalize(),new e(n,s,i.length)},e.TransformToRef=function(e,i,r){t.Vector3.TransformCoordinatesToRef(e.origin,i,r.origin),t.Vector3.TransformNormalToRef(e.direction,i,r.direction),e.direction.normalize()},e.smallnum=1e-8,e.rayl=1e9,e}();t.Ray=e}(r||(r={}));var r;!function(t){var e=function(e){function i(r,n){var s=this;e.call(this,r,n),this.onCollideObservable=new t.Observable,this.onCollisionPositionChangeObservable=new t.Observable,this.onAfterWorldMatrixUpdateObservable=new t.Observable,this.definedFacingForward=!0,this.position=new t.Vector3(0,0,0),this._rotation=new t.Vector3(0,0,0),this._scaling=new t.Vector3(1,1,1),this.billboardMode=i.BILLBOARDMODE_NONE,this.visibility=1,this.alphaIndex=Number.MAX_VALUE,this.infiniteDistance=!1,this.isVisible=!0,this.isPickable=!0,this.showBoundingBox=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.renderingGroupId=0,this.receiveShadows=!1,this.renderOutline=!1,this.outlineColor=t.Color3.Red(),this.outlineWidth=.02,this.renderOverlay=!1,this.overlayColor=t.Color3.Red(),this.overlayAlpha=.5,this.hasVertexAlpha=!1,this.useVertexColors=!0,this.applyFog=!0,this.computeBonesUsingShaders=!0,this.scalingDeterminant=1,this.numBoneInfluencers=4,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.layerMask=268435455,this.alwaysSelectAsActiveMesh=!1,this._checkCollisions=!1,this.ellipsoid=new t.Vector3(.5,1,.5),this.ellipsoidOffset=new t.Vector3(0,0,0),this._collider=new t.Collider,this._oldPositionForCollisions=new t.Vector3(0,0,0),this._diffPositionForCollisions=new t.Vector3(0,0,0),this._newPositionForCollisions=new t.Vector3(0,0,0),this.edgesWidth=1,this.edgesColor=new t.Color4(1,0,0,1),this._localWorld=t.Matrix.Zero(),this._worldMatrix=t.Matrix.Zero(),this._rotateYByPI=t.Matrix.RotationY(Math.PI),this._absolutePosition=t.Vector3.Zero(),this._collisionsTransformMatrix=t.Matrix.Zero(),this._collisionsScalingMatrix=t.Matrix.Zero(),this._isDirty=!1,this._pivotMatrix=t.Matrix.Identity(),this._isDisposed=!1,this._renderId=0,this._intersectionsInProgress=new Array,this._isWorldMatrixFrozen=!1,this._unIndexed=!1,this._onCollisionPositionChange=function(e,i,r){void 0===r&&(r=null),s.getScene().workerCollisions&&i.multiplyInPlace(s._collider.radius),i.subtractToRef(s._oldPositionForCollisions,s._diffPositionForCollisions),s._diffPositionForCollisions.length()>t.Engine.CollisionsEpsilon&&s.position.addInPlace(s._diffPositionForCollisions),r&&s.onCollideObservable.notifyObservers(r),s.onCollisionPositionChangeObservable.notifyObservers(s.position)},n.addMesh(this)}return o(i,e),Object.defineProperty(i,"BILLBOARDMODE_NONE",{get:function(){return i._BILLBOARDMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_X",{get:function(){return i._BILLBOARDMODE_X},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_Y",{get:function(){return i._BILLBOARDMODE_Y},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_Z",{get:function(){return i._BILLBOARDMODE_Z},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_ALL",{get:function(){return i._BILLBOARDMODE_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onCollide",{set:function(t){this._onCollideObserver&&this.onCollideObservable.remove(this._onCollideObserver),this._onCollideObserver=this.onCollideObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onCollisionPositionChange",{set:function(t){this._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._onCollisionPositionChangeObserver),this._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._skeleton},set:function(t){this._skeleton&&this._skeleton.needInitialSkinMatrix&&this._skeleton._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._skeleton=t,this._skeleton||(this._bonesTransformMatrices=null)},enumerable:!0,configurable:!0}),i.prototype.toString=function(e){var i="Name: "+this.name+", isInstance: "+(this instanceof t.InstancedMesh?"YES":"NO");return i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0),this._skeleton&&(i+=", skeleton: "+this._skeleton.name),e&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingFreezeWorldMatrix?"YES":"NO")),i},Object.defineProperty(i.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaling",{get:function(){return this._scaling},set:function(t){this._scaling=t,this.physicsImpostor&&this.physicsImpostor.forceUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(t){this._rotationQuaternion=t,t&&this.rotation.length()&&this.rotation.copyFromFloats(0,0,0)},enumerable:!0,configurable:!0}),i.prototype.updatePoseMatrix=function(t){this._poseMatrix.copyFrom(t)},i.prototype.getPoseMatrix=function(){return this._poseMatrix},i.prototype.disableEdgesRendering=function(){void 0!==this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=void 0)},i.prototype.enableEdgesRendering=function(e,i){void 0===e&&(e=.95),void 0===i&&(i=!1),this.disableEdgesRendering(),this._edgesRenderer=new t.EdgesRenderer(this,e,i)},Object.defineProperty(i.prototype,"isBlocked",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.getLOD=function(t){return this},i.prototype.getTotalVertices=function(){return 0},i.prototype.getIndices=function(){return null},i.prototype.getVerticesData=function(t){return null},i.prototype.isVerticesDataPresent=function(t){return!1},i.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfo||this._updateBoundingInfo(),this._boundingInfo)},i.prototype.setBoundingInfo=function(t){this._boundingInfo=t},Object.defineProperty(i.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(t.VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(t.VertexBuffer.MatricesWeightsKind)},enumerable:!0,configurable:!0}),i.prototype._preActivate=function(){},i.prototype._preActivateForIntermediateRendering=function(t){},i.prototype._activate=function(t){this._renderId=t},i.prototype.getWorldMatrix=function(){return this._masterMesh?this._masterMesh.getWorldMatrix():(this._currentRenderId!==this.getScene().getRenderId()&&this.computeWorldMatrix(),this._worldMatrix)},Object.defineProperty(i.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:!0,configurable:!0}),i.prototype.freezeWorldMatrix=function(){this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this._isWorldMatrixFrozen=!0},i.prototype.unfreezeWorldMatrix=function(){this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)},Object.defineProperty(i.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:!0,configurable:!0}),i.prototype.rotate=function(e,r,n){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=t.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=t.Vector3.Zero());var s;if(n&&n!==t.Space.LOCAL){if(this.parent){var o=this.parent.getWorldMatrix().clone();o.invert(),e=t.Vector3.TransformNormal(e,o)}s=t.Quaternion.RotationAxisToRef(e,r,i._rotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=t.Quaternion.RotationAxisToRef(e,r,i._rotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion)},i.prototype.translate=function(e,i,r){var n=e.scale(i);if(r&&r!==t.Space.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(n));else{var s=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(s)}},i.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},i.prototype.setAbsolutePosition=function(e){if(e){var i,r,n;if(void 0===e.x){if(arguments.length<3)return;i=arguments[0],r=arguments[1],n=arguments[2]}else i=e.x,r=e.y,n=e.z;if(this.parent){var s=this.parent.getWorldMatrix().clone();s.invert();var o=new t.Vector3(i,r,n);this.position=t.Vector3.TransformCoordinates(o,s)}else this.position.x=i,this.position.y=r,this.position.z=n}},i.prototype.movePOV=function(t,e,i){this.position.addInPlace(this.calcMovePOV(t,e,i))},i.prototype.calcMovePOV=function(e,i,r){var n=new t.Matrix;(this.rotationQuaternion?this.rotationQuaternion:t.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);var s=t.Vector3.Zero(),o=this.definedFacingForward?-1:1;return t.Vector3.TransformCoordinatesFromFloatsToRef(e*o,i,r*o,n,s),s},i.prototype.rotatePOV=function(t,e,i){this.rotation.addInPlace(this.calcRotatePOV(t,e,i))},i.prototype.calcRotatePOV=function(e,i,r){var n=this.definedFacingForward?1:-1;return new t.Vector3(e*n,i,r*n)},i.prototype.setPivotMatrix=function(t){this._pivotMatrix=t,this._cache.pivotMatrixUpdated=!0},i.prototype.getPivotMatrix=function(){return this._pivotMatrix},i.prototype._isSynchronized=function(){return!this._isDirty&&(this.billboardMode===this._cache.billboardMode&&this.billboardMode===i.BILLBOARDMODE_NONE&&(!this._cache.pivotMatrixUpdated&&(!this.infiniteDistance&&(!!this._cache.position.equals(this.position)&&(!(this.rotationQuaternion&&!this._cache.rotationQuaternion.equals(this.rotationQuaternion))&&(!!this._cache.rotation.equals(this.rotation)&&!!this._cache.scaling.equals(this.scaling)))))))},i.prototype._initCache=function(){e.prototype._initCache.call(this),this._cache.localMatrixUpdated=!1,this._cache.position=t.Vector3.Zero(),this._cache.scaling=t.Vector3.Zero(),this._cache.rotation=t.Vector3.Zero(),this._cache.rotationQuaternion=new t.Quaternion(0,0,0,0),this._cache.billboardMode=-1},i.prototype.markAsDirty=function(t){"rotation"===t&&(this.rotationQuaternion=null),this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0},i.prototype._updateBoundingInfo=function(){this._boundingInfo=this._boundingInfo||new t.BoundingInfo(this.absolutePosition,this.absolutePosition),this._boundingInfo.update(this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)},i.prototype._updateSubMeshesBoundingInfo=function(t){if(this.subMeshes)for(var e=0;e<this.subMeshes.length;e++){var i=this.subMeshes[e];i.IsGlobal||i.updateBoundingInfo(t)}},i.prototype.computeWorldMatrix=function(e){if(this._isWorldMatrixFrozen)return this._worldMatrix;if(!e&&(this._currentRenderId===this.getScene().getRenderId()||this.isSynchronized(!0)))return this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix;if(this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._cache.billboardMode=this.billboardMode,this._currentRenderId=this.getScene().getRenderId(),this._isDirty=!1,t.Matrix.ScalingToRef(this.scaling.x*this.scalingDeterminant,this.scaling.y*this.scalingDeterminant,this.scaling.z*this.scalingDeterminant,t.Tmp.Matrix[1]),this.rotationQuaternion){this.rotation.length()&&(this.rotationQuaternion.multiplyInPlace(t.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)),this.rotation.copyFromFloats(0,0,0))}if(this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(t.Tmp.Matrix[0]),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(t.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,t.Tmp.Matrix[0]),this._cache.rotation.copyFrom(this.rotation)),this.infiniteDistance&&!this.parent){var r=this.getScene().activeCamera;if(r){var n=r.getWorldMatrix(),s=new t.Vector3(n.m[12],n.m[13],n.m[14]);t.Matrix.TranslationToRef(this.position.x+s.x,this.position.y+s.y,this.position.z+s.z,t.Tmp.Matrix[2])}}else t.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,t.Tmp.Matrix[2]);if(this._pivotMatrix.multiplyToRef(t.Tmp.Matrix[1],t.Tmp.Matrix[4]),t.Tmp.Matrix[4].multiplyToRef(t.Tmp.Matrix[0],t.Tmp.Matrix[5]),this.billboardMode!==i.BILLBOARDMODE_NONE&&this.getScene().activeCamera){t.Tmp.Vector3[0].copyFrom(this.position);var o=t.Tmp.Vector3[0];if(this.parent&&this.parent.getWorldMatrix){this._markSyncedWithParent();var a;this._meshToBoneReferal?(this.parent.getWorldMatrix().multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),t.Tmp.Matrix[6]),a=t.Tmp.Matrix[6]):a=this.parent.getWorldMatrix(),t.Vector3.TransformNormalToRef(o,a,t.Tmp.Vector3[1]),o=t.Tmp.Vector3[1]}var h=this.getScene().activeCamera.globalPosition.clone();this.parent&&this.parent.position&&(o.addInPlace(this.parent.position),t.Matrix.TranslationToRef(o.x,o.y,o.z,t.Tmp.Matrix[2])),(this.billboardMode&i.BILLBOARDMODE_ALL)!==i.BILLBOARDMODE_ALL&&(this.billboardMode&i.BILLBOARDMODE_X&&(h.x=o.x+t.Epsilon),this.billboardMode&i.BILLBOARDMODE_Y&&(h.y=o.y+t.Epsilon),this.billboardMode&i.BILLBOARDMODE_Z&&(h.z=o.z+t.Epsilon)),t.Matrix.LookAtLHToRef(o,h,t.Vector3.Up(),t.Tmp.Matrix[3]),t.Tmp.Matrix[3].m[12]=t.Tmp.Matrix[3].m[13]=t.Tmp.Matrix[3].m[14]=0,t.Tmp.Matrix[3].invert(),t.Tmp.Matrix[5].multiplyToRef(t.Tmp.Matrix[3],this._localWorld),this._rotateYByPI.multiplyToRef(this._localWorld,t.Tmp.Matrix[5])}return t.Tmp.Matrix[5].multiplyToRef(t.Tmp.Matrix[2],this._localWorld),this.parent&&this.parent.getWorldMatrix&&this.billboardMode===i.BILLBOARDMODE_NONE?(this._markSyncedWithParent(),this._meshToBoneReferal?(this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),t.Tmp.Matrix[6]),t.Tmp.Matrix[6].multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix)):this._worldMatrix.copyFrom(this._localWorld),this._updateBoundingInfo(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=t.Matrix.Invert(this._worldMatrix)),this._worldMatrix},i.prototype.registerAfterWorldMatrixUpdate=function(t){this.onAfterWorldMatrixUpdateObservable.add(t)},i.prototype.unregisterAfterWorldMatrixUpdate=function(t){this.onAfterWorldMatrixUpdateObservable.removeCallback(t)},i.prototype.setPositionWithLocalVector=function(e){this.computeWorldMatrix(),this.position=t.Vector3.TransformNormal(e,this._localWorld)},i.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var e=this._localWorld.clone();return e.invert(),t.Vector3.TransformNormal(this.position,e)},i.prototype.locallyTranslate=function(e){this.computeWorldMatrix(!0),this.position=t.Vector3.TransformCoordinates(e,this._localWorld)},i.prototype.lookAt=function(e,r,n,s,o){void 0===r&&(r=0),void 0===n&&(n=0),void 0===s&&(s=0),void 0===o&&(o=t.Space.LOCAL);var a=i._lookAtVectorCache,h=o===t.Space.LOCAL?this.position:this.getAbsolutePosition();e.subtractToRef(h,a);var l=-Math.atan2(a.z,a.x)-Math.PI/2,c=Math.sqrt(a.x*a.x+a.z*a.z),u=Math.atan2(a.y,c);this.rotationQuaternion=this.rotationQuaternion||new t.Quaternion,t.Quaternion.RotationYawPitchRollToRef(l+r,u+n,s,this.rotationQuaternion)},i.prototype.attachToBone=function(t,e){this._meshToBoneReferal=e,this.parent=t,t.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1)},i.prototype.detachFromBone=function(){this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._meshToBoneReferal=null,this.parent=null},i.prototype.isInFrustum=function(t){return this._boundingInfo.isInFrustum(t)},i.prototype.isCompletelyInFrustum=function(t){return this._boundingInfo.isCompletelyInFrustum(t)},i.prototype.intersectsMesh=function(t,e){return!(!this._boundingInfo||!t._boundingInfo)&&this._boundingInfo.intersects(t._boundingInfo,e)},i.prototype.intersectsPoint=function(t){return!!this._boundingInfo&&this._boundingInfo.intersectsPoint(t)},i.prototype.setPhysicsState=function(e,i){return e.impostor&&(i=e,e=e.impostor),this.physicsImpostor=new t.PhysicsImpostor(this,e,i,this.getScene()),this.physicsImpostor.physicsBody},i.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},i.prototype.getPhysicsMass=function(){return this.physicsImpostor.getParam("mass")},i.prototype.getPhysicsFriction=function(){return this.physicsImpostor.getParam("friction")},i.prototype.getPhysicsRestitution=function(){return this.physicsImpostor.getParam("restitution")},i.prototype.getPositionInCameraSpace=function(e){return e||(e=this.getScene().activeCamera),t.Vector3.TransformCoordinates(this.absolutePosition,e.getViewMatrix())},i.prototype.getDistanceToCamera=function(t){return t||(t=this.getScene().activeCamera),this.absolutePosition.subtract(t.position).length()},i.prototype.applyImpulse=function(t,e){this.physicsImpostor&&this.physicsImpostor.applyImpulse(t,e)},i.prototype.setPhysicsLinkWith=function(e,i,r,n){this.physicsImpostor&&e.physicsImpostor&&this.physicsImpostor.createJoint(e.physicsImpostor,t.PhysicsJoint.HingeJoint,{mainPivot:i,connectedPivot:r,nativeParams:n})},i.prototype.updatePhysicsBodyPosition=function(){t.Tools.Warn("updatePhysicsBodyPosition() is deprecated, please use updatePhysicsBody()"),this.updatePhysicsBody()},i.prototype.updatePhysicsBody=function(){},Object.defineProperty(i.prototype,"checkCollisions",{get:function(){return this._checkCollisions},set:function(t){this._checkCollisions=t,this.getScene().workerCollisions&&this.getScene().collisionCoordinator.onMeshUpdated(this)},enumerable:!0,configurable:!0}),i.prototype.moveWithCollisions=function(t){this.getAbsolutePosition().subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPositionForCollisions),this._oldPositionForCollisions.addInPlace(this.ellipsoidOffset),this._collider.radius=this.ellipsoid,this.getScene().collisionCoordinator.getNewPosition(this._oldPositionForCollisions,t,this._collider,3,this,this._onCollisionPositionChange,this.uniqueId)},i.prototype.createOrUpdateSubmeshesOctree=function(e,i){void 0===e&&(e=64),void 0===i&&(i=2),this._submeshesOctree||(this._submeshesOctree=new t.Octree(t.Octree.CreationFuncForSubMeshes,e,i)),this.computeWorldMatrix(!0);var r=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree},i.prototype._collideForSubMesh=function(e,i,r){if(this._generatePointsArray(),!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(i)){e._lastColliderTransformMatrix=i.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];for(var n=e.verticesStart,s=e.verticesStart+e.verticesCount,o=n;o<s;o++)e._lastColliderWorldVertices.push(t.Vector3.TransformCoordinates(this._positions[o],i))}r._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial()),r.collisionFound&&(r.collidedMesh=this)},i.prototype._processCollisionsForSubMeshes=function(t,e){var i,r;if(this._submeshesOctree&&this.useOctreeForCollisions){var n=t.velocityWorldLength+Math.max(t.radius.x,t.radius.y,t.radius.z),s=this._submeshesOctree.intersects(t.basePointWorld,n);r=s.length,i=s.data}else i=this.subMeshes,r=i.length;for(var o=0;o<r;o++){var a=i[o];r>1&&!a._checkCollision(t)||this._collideForSubMesh(a,e,t)}},i.prototype._checkCollision=function(e){this._boundingInfo._checkCollision(e)&&(t.Matrix.ScalingToRef(1/e.radius.x,1/e.radius.y,1/e.radius.z,this._collisionsScalingMatrix),this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubMeshes(e,this._collisionsTransformMatrix))},i.prototype._generatePointsArray=function(){return!1},i.prototype.intersects=function(e,i){var r=new t.PickingInfo;if(!(this.subMeshes&&this._boundingInfo&&e.intersectsSphere(this._boundingInfo.boundingSphere)&&e.intersectsBox(this._boundingInfo.boundingBox)))return r;if(!this._generatePointsArray())return r;var n,s,o=null;if(this._submeshesOctree&&this.useOctreeForPicking){var a=t.Ray.Transform(e,this.getWorldMatrix()),h=this._submeshesOctree.intersectsRay(a);s=h.length,n=h.data}else n=this.subMeshes,s=n.length;for(var l=0;l<s;l++){var c=n[l];if(!(s>1)||c.canIntersects(e)){var u=c.intersects(e,this._positions,this.getIndices(),i);if(u&&(i||!o||u.distance<o.distance)&&(o=u,o.subMeshId=l,i))break}}if(o){var p=this.getWorldMatrix(),d=t.Vector3.TransformCoordinates(e.origin,p),f=e.direction.clone();f=f.scale(o.distance);var m=t.Vector3.TransformNormal(f,p),_=d.add(m);return r.hit=!0,r.distance=t.Vector3.Distance(d,_),r.pickedPoint=_,r.pickedMesh=this,r.bu=o.bu,r.bv=o.bv,r.faceId=o.faceId,r.subMeshId=o.subMeshId,r}return r},i.prototype.clone=function(t,e,i){return null},i.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array},i.prototype.dispose=function(t){var i,r=this;for(this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this.skeleton=null,this.getScene().stopAnimation(this),this.physicsImpostor&&this.physicsImpostor.dispose(),i=0;i<this._intersectionsInProgress.length;i++){var n=this._intersectionsInProgress[i],s=n._intersectionsInProgress.indexOf(this);n._intersectionsInProgress.splice(s,1)}if(this._intersectionsInProgress=[],this.getScene().lights.forEach(function(t){var e=t.includedOnlyMeshes.indexOf(r);e!==-1&&t.includedOnlyMeshes.splice(e,1),(e=t.excludedMeshes.indexOf(r))!==-1&&t.excludedMeshes.splice(e,1);var i=t.getShadowGenerator();i&&(e=i.getShadowMap().renderList.indexOf(r))!==-1&&i.getShadowMap().renderList.splice(e,1)}),this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this.releaseSubMeshes(),this.getScene().getEngine().unbindAllAttributes(),this.getScene().removeMesh(this),t){var o=this.getChildMeshes(!0);for(i=0;i<o.length;i++){var a=o[i];a.parent=null,a.computeWorldMatrix(!0)}}else{for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter===this&&(this.getScene().particleSystems[i].dispose(),i--);var h=this.getDescendants(!0);for(i=0;i<h.length;i++)h[i].dispose()}this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this._isDisposed=!0,e.prototype.dispose.call(this)},i.prototype.getDirection=function(e){var i=t.Vector3.Zero();return this.getDirectionToRef(e,i),i},i.prototype.getDirectionToRef=function(e,i){t.Vector3.TransformNormalToRef(e,this.getWorldMatrix(),i)},i.prototype.setPivotPoint=function(e,i){void 0===i&&(i=t.Space.LOCAL),0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);var r=this.getWorldMatrix();if(i==t.Space.WORLD){var n=t.Tmp.Matrix[0];r.invertToRef(n),e=t.Vector3.TransformCoordinates(e,n)}t.Vector3.TransformCoordinatesToRef(e,r,this.position),this._pivotMatrix.m[12]=-e.x,this._pivotMatrix.m[13]=-e.y,this._pivotMatrix.m[14]=-e.z,this._cache.pivotMatrixUpdated=!0},i.prototype.getPivotPoint=function(){var e=t.Vector3.Zero();return this.getPivotPointToRef(e),e},i.prototype.getPivotPointToRef=function(t){t.x=-this._pivotMatrix.m[12],t.y=-this._pivotMatrix.m[13],t.z=-this._pivotMatrix.m[14]},i.prototype.getAbsolutePivotPoint=function(){var e=t.Vector3.Zero();return this.getAbsolutePivotPointToRef(e),e},i.prototype.getAbsolutePivotPointToRef=function(e){e.x=this._pivotMatrix.m[12],e.y=this._pivotMatrix.m[13],e.z=this._pivotMatrix.m[14],this.getPivotPointToRef(e),t.Vector3.TransformCoordinatesToRef(e,this.getWorldMatrix(),e)},i._BILLBOARDMODE_NONE=0,i._BILLBOARDMODE_X=1,i._BILLBOARDMODE_Y=2,i._BILLBOARDMODE_Z=4,i._BILLBOARDMODE_ALL=7,i._rotationAxisCache=new t.Quaternion,i._lookAtVectorCache=new t.Vector3(0,0,0),i}(t.Node);t.AbstractMesh=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r){e.call(this,i,r),this.diffuse=new t.Color3(1,1,1),this.specular=new t.Color3(1,1,1),this.intensity=1,this.range=Number.MAX_VALUE,this.includeOnlyWithLayerMask=0,this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this.excludeWithLayerMask=0,this.lightmapMode=0,this.radius=1e-5,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,r.addLight(this)}return o(i,e),Object.defineProperty(i,"LIGHTMAP_DEFAULT",{get:function(){return i._LIGHTMAP_DEFAULT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LIGHTMAP_SPECULAR",{get:function(){return i._LIGHTMAP_SPECULAR},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LIGHTMAP_SHADOWSONLY",{get:function(){return i._LIGHTMAP_SHADOWSONLY},enumerable:!0,configurable:!0}),i.prototype.toString=function(t){var e="Name: "+this.name;if(e+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var i=0;i<this.animations.length;i++)e+=", animation[0]: "+this.animations[i].toString(t);return e},i.prototype.getShadowGenerator=function(){return this._shadowGenerator},i.prototype.getAbsolutePosition=function(){return t.Vector3.Zero()},i.prototype.transferToEffect=function(t,e,i){},i.prototype._getWorldMatrix=function(){return t.Matrix.Identity()},i.prototype.canAffectMesh=function(t){return!t||!(this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(t)===-1)&&(!(this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(t)!==-1)&&((0===this.includeOnlyWithLayerMask||0!=(this.includeOnlyWithLayerMask&t.layerMask))&&!(0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&t.layerMask)))},i.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId();var e=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=t.Matrix.Identity()),e.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._markSyncedWithParent(),this._parentedWorldMatrix):e},i.prototype.dispose=function(){this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this),this.getScene().removeLight(this),e.prototype.dispose.call(this)},i.prototype.getTypeID=function(){return 0},i.prototype.clone=function(e){return t.SerializationHelper.Clone(i.GetConstructorFromName(this.getTypeID(),e,this.getScene()),this)},i.prototype.serialize=function(){var e=t.SerializationHelper.Serialize(this);return e.type=this.getTypeID(),this.parent&&(e.parentId=this.parent.id),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(function(t){e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(t){e.includedOnlyMeshesIds.push(t.id)})),t.Animation.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e},i.GetConstructorFromName=function(e,i,r){switch(e){case 0:return function(){return new t.PointLight(i,t.Vector3.Zero(),r)};case 1:return function(){return new t.DirectionalLight(i,t.Vector3.Zero(),r)};case 2:return function(){return new t.SpotLight(i,t.Vector3.Zero(),t.Vector3.Zero(),0,0,r)};case 3:return function(){return new t.HemisphericLight(i,t.Vector3.Zero(),r)}}},i.Parse=function(e,r){var n=t.SerializationHelper.Parse(i.GetConstructorFromName(e.type,e.name,r),e,r);if(e.excludedMeshesIds&&(n._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(n._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId&&(n._waitingParentId=e.parentId),e.animations){for(var s=0;s<e.animations.length;s++){var o=e.animations[s];n.animations.push(t.Animation.Parse(o))}t.Node.ParseAnimationRanges(n,e,r)}return e.autoAnimate&&r.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),n},i._LIGHTMAP_DEFAULT=0,i._LIGHTMAP_SPECULAR=1,i._LIGHTMAP_SHADOWSONLY=2,s([t.serializeAsColor3()],i.prototype,"diffuse",void 0),s([t.serializeAsColor3()],i.prototype,"specular",void 0),s([t.serialize()],i.prototype,"intensity",void 0),s([t.serialize()],i.prototype,"range",void 0),s([t.serialize()],i.prototype,"includeOnlyWithLayerMask",void 0),s([t.serialize()],i.prototype,"excludeWithLayerMask",void 0),s([t.serialize()],i.prototype,"lightmapMode",void 0),s([t.serialize()],i.prototype,"radius",void 0),i}(t.Node);t.Light=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r){e.call(this,t,r),this.position=i}return o(i,e),i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},i.prototype.computeTransformedPosition=function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=t.Vector3.Zero()),t.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),!0)},i.prototype.transferToEffect=function(t,e){if(this.parent&&this.parent.getWorldMatrix)return this.computeTransformedPosition(),void t.setFloat4(e,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0);t.setFloat4(e,this.position.x,this.position.y,this.position.z,0)},i.prototype.needCube=function(){return!0},i.prototype.supportsVSM=function(){return!1},i.prototype.needRefreshPerFrame=function(){return!1},i.prototype.getShadowDirection=function(e){switch(e){case 0:return new t.Vector3(1,0,0);case 1:return new t.Vector3(-1,0,0);case 2:return new t.Vector3(0,-1,0);case 3:return new t.Vector3(0,1,0);case 4:return new t.Vector3(0,0,1);case 5:return new t.Vector3(0,0,-1)}return t.Vector3.Zero()},i.prototype.setShadowProjectionMatrix=function(e,i,r){var n=this.getScene().activeCamera;t.Matrix.PerspectiveFovLHToRef(Math.PI/2,1,n.minZ,n.maxZ,e)},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=t.Matrix.Identity()),t.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i.prototype.getTypeID=function(){return 0},s([t.serializeAsVector3()],i.prototype,"position",void 0),i}(t.Light);t.PointLight=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r,n,s,o){e.call(this,t,o),this.position=i,this.direction=r,this.angle=n,this.exponent=s}return o(i,e),i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},i.prototype.setShadowProjectionMatrix=function(e,i,r){var n=this.getScene().activeCamera;t.Matrix.PerspectiveFovLHToRef(this.angle,1,n.minZ,n.maxZ,e)},i.prototype.needCube=function(){return!1},i.prototype.supportsVSM=function(){return!0},i.prototype.needRefreshPerFrame=function(){return!1},i.prototype.getShadowDirection=function(t){return this.direction},i.prototype.setDirectionToTarget=function(e){return this.direction=t.Vector3.Normalize(e.subtract(this.position)),this.direction},i.prototype.computeTransformedPosition=function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=t.Vector3.Zero()),t.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),!0)},i.prototype.transferToEffect=function(e,i,r){var n;this.parent&&this.parent.getWorldMatrix?(this._transformedDirection||(this._transformedDirection=t.Vector3.Zero()),this.computeTransformedPosition(),t.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),e.setFloat4(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent),n=t.Vector3.Normalize(this._transformedDirection)):(e.setFloat4(i,this.position.x,this.position.y,this.position.z,this.exponent),n=t.Vector3.Normalize(this.direction)),e.setFloat4(r,n.x,n.y,n.z,Math.cos(.5*this.angle))},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=t.Matrix.Identity()),t.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i.prototype.getTypeID=function(){return 2},i.prototype.getRotation=function(){this.direction.normalize();var e=t.Vector3.Cross(this.direction,t.Axis.Y),i=t.Vector3.Cross(e,this.direction);return t.Vector3.RotationFromAxis(e,i,this.direction)},s([t.serializeAsVector3()],i.prototype,"position",void 0),s([t.serializeAsVector3()],i.prototype,"direction",void 0),s([t.serialize()],i.prototype,"angle",void 0),s([t.serialize()],i.prototype,"exponent",void 0),i}(t.Light);t.SpotLight=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n){e.call(this,i,n),this.groundColor=new t.Color3(0,0,0),this.direction=r}return o(i,e),i.prototype.setDirectionToTarget=function(e){return this.direction=t.Vector3.Normalize(e.subtract(t.Vector3.Zero())),this.direction},i.prototype.getShadowGenerator=function(){return null},i.prototype.transferToEffect=function(e,i,r){var n=t.Vector3.Normalize(this.direction);e.setFloat4(i,n.x,n.y,n.z,0),e.setColor3(r,this.groundColor.scale(this.intensity))},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=t.Matrix.Identity()),this._worldMatrix},i.prototype.getTypeID=function(){return 3},s([t.serializeAsColor3()],i.prototype,"groundColor",void 0),s([t.serializeAsVector3()],i.prototype,"direction",void 0),i}(t.Light);t.HemisphericLight=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r){e.call(this,t,r),this.shadowOrthoScale=.5,this.autoUpdateExtends=!0,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=i.scale(-1),this.direction=i}return o(i,e),i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},i.prototype.setDirectionToTarget=function(e){return this.direction=t.Vector3.Normalize(e.subtract(this.position)),this.direction},i.prototype.setShadowProjectionMatrix=function(e,i,r){var n=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var s=t.Vector3.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var o=0;o<r.length;o++){var a=r[o];if(a){var h=a.getBoundingInfo();if(h)for(var l=h.boundingBox,c=0;c<l.vectorsWorld.length;c++)t.Vector3.TransformCoordinatesToRef(l.vectorsWorld[c],i,s),s.x<this._orthoLeft&&(this._orthoLeft=s.x),s.y<this._orthoBottom&&(this._orthoBottom=s.y),s.x>this._orthoRight&&(this._orthoRight=s.x),s.y>this._orthoTop&&(this._orthoTop=s.y)}}}var u=this._orthoRight-this._orthoLeft,p=this._orthoTop-this._orthoBottom;t.Matrix.OrthoOffCenterLHToRef(this._orthoLeft-u*this.shadowOrthoScale,this._orthoRight+u*this.shadowOrthoScale,this._orthoBottom-p*this.shadowOrthoScale,this._orthoTop+p*this.shadowOrthoScale,-n.maxZ,n.maxZ,e)},i.prototype.supportsVSM=function(){return!0},i.prototype.needRefreshPerFrame=function(){return!0},i.prototype.needCube=function(){return!1},i.prototype.getShadowDirection=function(t){return this.direction},i.prototype.computeTransformedPosition=function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=t.Vector3.Zero()),t.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),!0)},i.prototype.transferToEffect=function(e,i){if(this.parent&&this.parent.getWorldMatrix)return this._transformedDirection||(this._transformedDirection=t.Vector3.Zero()),t.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),void e.setFloat4(i,this._transformedDirection.x,this._transformedDirection.y,this._transformedDirection.z,1);e.setFloat4(i,this.direction.x,this.direction.y,this.direction.z,1)},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=t.Matrix.Identity()),t.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i.prototype.getTypeID=function(){return 1},s([t.serializeAsVector3()],i.prototype,"position",void 0),s([t.serializeAsVector3()],i.prototype,"direction",void 0),s([t.serialize()],i.prototype,"shadowOrthoScale",void 0),s([t.serialize()],i.prototype,"autoUpdateExtends",void 0),i}(t.Light);t.DirectionalLight=e}(r||(r={}));var r;!function(t){var e=function(){function e(i,r){var n=this;this._filter=e.FILTER_NONE,this.blurScale=2,this._blurBoxOffset=0,this._bias=5e-5,this._lightDirection=t.Vector3.Zero(),this.forceBackFacesOnly=!1,this._darkness=0,this._transparencyShadow=!1,this._viewMatrix=t.Matrix.Zero(),this._projectionMatrix=t.Matrix.Zero(),this._transformMatrix=t.Matrix.Zero(),this._worldViewProjection=t.Matrix.Zero(),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._useFullFloat=!0,this._light=r,this._scene=r.getScene(),this._mapSize=i,r._shadowGenerator=this;var s,o=this._scene.getEngine().getCaps();o.textureFloat&&o.textureFloatLinearFiltering&&o.textureFloatRender?(this._useFullFloat=!0,s=t.Engine.TEXTURETYPE_FLOAT):(this._useFullFloat=!1,s=t.Engine.TEXTURETYPE_UNSIGNED_INT),this._shadowMap=new t.RenderTargetTexture(r.name+"_shadowMap",i,this._scene,!1,!0,s,r.needCube()),this._shadowMap.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(t.Texture.NEAREST_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.onBeforeRenderObservable.add(function(t){n._currentFaceIndex=t}),this._shadowMap.onAfterUnbindObservable.add(function(){n.useBlurVarianceShadowMap&&(n._shadowMap2||(n._shadowMap2=new t.RenderTargetTexture(r.name+"_shadowMap",i,n._scene,!1,!0,s),n._shadowMap2.wrapU=t.Texture.CLAMP_ADDRESSMODE,n._shadowMap2.wrapV=t.Texture.CLAMP_ADDRESSMODE,n._shadowMap2.updateSamplingMode(t.Texture.TRILINEAR_SAMPLINGMODE),n._downSamplePostprocess=new t.PassPostProcess("downScale",1/n.blurScale,null,t.Texture.BILINEAR_SAMPLINGMODE,n._scene.getEngine()),n._downSamplePostprocess.onApplyObservable.add(function(t){t.setTexture("textureSampler",n._shadowMap)}),n.blurBoxOffset=1),n._scene.postProcessManager.directRender([n._downSamplePostprocess,n._boxBlurPostprocess],n._shadowMap2.getInternalTexture()))});var a=function(e){var i=e.getRenderingMesh(),r=n._scene,s=r.getEngine();s.setState(e.getMaterial().backFaceCulling);var o=i._getInstancesRenderList(e._id);if(!o.mustReturn){var a=null!==s.getCaps().instancedArrays&&null!==o.visibleInstances[e._id]&&void 0!==o.visibleInstances[e._id];if(n.isReady(e,a)){s.enableEffect(n._effect),i._bind(e,n._effect,t.Material.TriangleFillMode);var h=e.getMaterial();if(n._effect.setMatrix("viewProjection",n.getTransformMatrix()),n._effect.setVector3("lightPosition",n.getLight().position),n.getLight().needCube()&&n._effect.setFloat2("depthValues",r.activeCamera.minZ,r.activeCamera.maxZ),h&&h.needAlphaTesting()){var l=h.getAlphaTestTexture();n._effect.setTexture("diffuseSampler",l),n._effect.setMatrix("diffuseMatrix",l.getTextureMatrix())}i.useBones&&i.computeBonesUsingShaders&&n._effect.setMatrices("mBones",i.skeleton.getTransformMatrices(i)),n.forceBackFacesOnly&&s.setState(!0,0,!1,!0),i._processRendering(e,n._effect,t.Material.TriangleFillMode,o,a,function(t,e){return n._effect.setMatrix("world",e)}),n.forceBackFacesOnly&&s.setState(!0,0,!1,!1)}else n._shadowMap.resetRefreshCounter()}};this._shadowMap.customRenderFunction=function(t,e,i){var r;for(r=0;r<t.length;r++)a(t.data[r]);for(r=0;r<e.length;r++)a(e.data[r]);if(n._transparencyShadow)for(r=0;r<i.length;r++)a(i.data[r])},this._shadowMap.onClearObservable.add(function(e){n.useBlurVarianceShadowMap||n.useVarianceShadowMap?e.clear(new t.Color4(0,0,0,0),!0,!0,!0):e.clear(new t.Color4(1,1,1,1),!0,!0,!0)})}return Object.defineProperty(e,"FILTER_NONE",{get:function(){return e._FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(e,"FILTER_VARIANCESHADOWMAP",{get:function(){return e._FILTER_VARIANCESHADOWMAP},enumerable:!0,configurable:!0}),Object.defineProperty(e,"FILTER_POISSONSAMPLING",{get:function(){return e._FILTER_POISSONSAMPLING},enumerable:!0,configurable:!0}),Object.defineProperty(e,"FILTER_BLURVARIANCESHADOWMAP",{get:function(){return e._FILTER_BLURVARIANCESHADOWMAP},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bias",{get:function(){return this._bias},set:function(t){this._bias=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(e){var i=this;this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._boxBlurPostprocess&&this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=new t.PostProcess("DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1/this.blurScale,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define OFFSET "+e),this._boxBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2("screenSize",i._mapSize/i.blurScale,i._mapSize/i.blurScale)}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"filter",{get:function(){return this._filter},set:function(e){this._filter!==e&&(this._filter=e,this.useVarianceShadowMap||this.useBlurVarianceShadowMap||this.usePoissonSampling?(this._shadowMap.anisotropicFilteringLevel=16,this._shadowMap.updateSamplingMode(t.Texture.BILINEAR_SAMPLINGMODE)):(this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(t.Texture.NEAREST_SAMPLINGMODE)))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useVarianceShadowMap",{get:function(){return this.filter===e.FILTER_VARIANCESHADOWMAP&&this._light.supportsVSM()},set:function(t){this.filter=t?e.FILTER_VARIANCESHADOWMAP:e.FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"usePoissonSampling",{get:function(){return this.filter===e.FILTER_POISSONSAMPLING||!this._light.supportsVSM()&&(this.filter===e.FILTER_VARIANCESHADOWMAP||this.filter===e.FILTER_BLURVARIANCESHADOWMAP)},set:function(t){this.filter=t?e.FILTER_POISSONSAMPLING:e.FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useBlurVarianceShadowMap",{get:function(){return this.filter===e.FILTER_BLURVARIANCESHADOWMAP&&this._light.supportsVSM()},set:function(t){this.filter=t?e.FILTER_BLURVARIANCESHADOWMAP:e.FILTER_NONE},enumerable:!0,configurable:!0}),e.prototype.isReady=function(e,i){var r=[];this._useFullFloat&&r.push("#define FULLFLOAT"),(this.useVarianceShadowMap||this.useBlurVarianceShadowMap)&&r.push("#define VSM"),this.getLight().needCube()&&r.push("#define CUBEMAP");var n=[t.VertexBuffer.PositionKind],s=e.getMesh(),o=e.getMaterial();if(o&&o.needAlphaTesting()&&(r.push("#define ALPHATEST"),s.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(n.push(t.VertexBuffer.UVKind),r.push("#define UV1")),s.isVerticesDataPresent(t.VertexBuffer.UV2Kind))){1===o.getAlphaTestTexture().coordinatesIndex&&(n.push(t.VertexBuffer.UV2Kind),r.push("#define UV2"))}s.useBones&&s.computeBonesUsingShaders?(n.push(t.VertexBuffer.MatricesIndicesKind),n.push(t.VertexBuffer.MatricesWeightsKind),s.numBoneInfluencers>4&&(n.push(t.VertexBuffer.MatricesIndicesExtraKind),n.push(t.VertexBuffer.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),r.push("#define BonesPerMesh "+(s.skeleton.bones.length+1))):r.push("#define NUM_BONE_INFLUENCERS 0"),i&&(r.push("#define INSTANCES"),n.push("world0"),n.push("world1"),n.push("world2"),n.push("world3"));var a=r.join("\n");return this._cachedDefines!==a&&(this._cachedDefines=a,this._effect=this._scene.getEngine().createEffect("shadowMap",n,["world","mBones","viewProjection","diffuseMatrix","lightPosition","depthValues"],["diffuseSampler"],a)),this._effect.isReady()},e.prototype.getShadowMap=function(){return this._shadowMap},e.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},e.prototype.getLight=function(){return this._light},e.prototype.getTransformMatrix=function(){var e=this._scene;if(this._currentRenderID===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderID=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;var i=this._light.position;return t.Vector3.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(t.Vector3.Dot(this._lightDirection,t.Vector3.Up()))&&(this._lightDirection.z=1e-13),this._light.computeTransformedPosition()&&(i=this._light.transformedPosition),!this._light.needRefreshPerFrame()&&this._cachedPosition&&this._cachedDirection&&i.equals(this._cachedPosition)&&this._lightDirection.equals(this._cachedDirection)||(this._cachedPosition=i.clone(),this._cachedDirection=this._lightDirection.clone(),t.Matrix.LookAtLHToRef(i,i.add(this._lightDirection),t.Vector3.Up(),this._viewMatrix),this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,this.getShadowMap().renderList),this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)),this._transformMatrix},e.prototype.getDarkness=function(){return this._darkness},e.prototype.setDarkness=function(t){this._darkness=t>=1?1:t<=0?0:t},e.prototype.setTransparencyShadow=function(t){this._transparencyShadow=t},e.prototype._packHalf=function(e){var i=255*e,r=i-Math.floor(i);return new t.Vector2(e-r/255,r)},e.prototype.dispose=function(){this._shadowMap.dispose(),this._shadowMap2&&this._shadowMap2.dispose(),this._downSamplePostprocess&&this._downSamplePostprocess.dispose(),this._boxBlurPostprocess&&this._boxBlurPostprocess.dispose()},e.prototype.serialize=function(){var t={};t.lightId=this._light.id,t.mapSize=this.getShadowMap().getRenderSize(),t.useVarianceShadowMap=this.useVarianceShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.forceBackFacesOnly=this.forceBackFacesOnly,t.renderList=[];for(var e=0;e<this.getShadowMap().renderList.length;e++){var i=this.getShadowMap().renderList[e];t.renderList.push(i.id)}return t},e.Parse=function(t,i){for(var r=i.getLightByID(t.lightId),n=new e(t.mapSize,r),s=0;s<t.renderList.length;s++){i.getMeshesByID(t.renderList[s]).forEach(function(t){n.getShadowMap().renderList.push(t)})}return t.usePoissonSampling?n.usePoissonSampling=!0:t.useVarianceShadowMap?n.useVarianceShadowMap=!0:t.useBlurVarianceShadowMap&&(n.useBlurVarianceShadowMap=!0,t.blurScale&&(n.blurScale=t.blurScale),t.blurBoxOffset&&(n.blurBoxOffset=t.blurBoxOffset)),void 0!==t.bias&&(n.bias=t.bias),n.forceBackFacesOnly=t.forceBackFacesOnly,n},e._FILTER_NONE=0,e._FILTER_VARIANCESHADOWMAP=1,e._FILTER_POISSONSAMPLING=2,e._FILTER_BLURVARIANCESHADOWMAP=3,e}();t.ShadowGenerator=e}(r||(r={}));var r;!function(t){var e=function(t,e,i,r){return!(t.x>i.x+r)&&(!(i.x-r>e.x)&&(!(t.y>i.y+r)&&(!(i.y-r>e.y)&&(!(t.z>i.z+r)&&!(i.z-r>e.z)))))},i=function(){var t={root:0,found:!1};return function(e,i,r,n){t.root=0,t.found=!1;var s=i*i-4*e*r;if(s<0)return t;var o=Math.sqrt(s),a=(-i-o)/(2*e),h=(-i+o)/(2*e);if(a>h){var l=h;h=a,a=l}return a>0&&a<n?(t.root=a,t.found=!0,t):h>0&&h<n?(t.root=h,t.found=!0,t):t}}(),r=function(){function r(){this.radius=new t.Vector3(1,1,1),this.retry=0,this.basePointWorld=t.Vector3.Zero(),this.velocityWorld=t.Vector3.Zero(),this.normalizedVelocity=t.Vector3.Zero(),this._collisionPoint=t.Vector3.Zero(),this._planeIntersectionPoint=t.Vector3.Zero(),this._tempVector=t.Vector3.Zero(),this._tempVector2=t.Vector3.Zero(),this._tempVector3=t.Vector3.Zero(),this._tempVector4=t.Vector3.Zero(),this._edge=t.Vector3.Zero(),this._baseToVertex=t.Vector3.Zero(),this._destinationPoint=t.Vector3.Zero(),this._slidePlaneNormal=t.Vector3.Zero(),this._displacementVector=t.Vector3.Zero()}return r.prototype._initialize=function(e,i,r){this.velocity=i,t.Vector3.NormalizeToRef(i,this.normalizedVelocity),this.basePoint=e,e.multiplyToRef(this.radius,this.basePointWorld),i.multiplyToRef(this.radius,this.velocityWorld),this.velocityWorldLength=this.velocityWorld.length(),this.epsilon=r,this.collisionFound=!1},r.prototype._checkPointInTriangle=function(e,i,r,n,s){i.subtractToRef(e,this._tempVector),r.subtractToRef(e,this._tempVector2),t.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var o=t.Vector3.Dot(this._tempVector4,s);return!(o<0)&&(n.subtractToRef(e,this._tempVector3),t.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),!((o=t.Vector3.Dot(this._tempVector4,s))<0)&&(t.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),(o=t.Vector3.Dot(this._tempVector4,s))>=0))},r.prototype._canDoCollision=function(i,r,n,s){var o=t.Vector3.Distance(this.basePointWorld,i),a=Math.max(this.radius.x,this.radius.y,this.radius.z);return!(o>this.velocityWorldLength+a+r)&&!!e(n,s,this.basePointWorld,this.velocityWorldLength+a)},r.prototype._testTriangle=function(e,r,n,s,o,a){var h,l=!1;r||(r=[]),r[e]||(r[e]=new t.Plane(0,0,0,0),r[e].copyFromPoints(n,s,o));var c=r[e];if(a||c.isFrontFacingTo(this.normalizedVelocity,0)){var u=c.signedDistanceTo(this.basePoint),p=t.Vector3.Dot(c.normal,this.velocity);if(0==p){if(Math.abs(u)>=1)return;l=!0,h=0}else{h=(-1-u)/p;var d=(1-u)/p;if(h>d){var f=d;d=h,h=f}if(h>1||d<0)return;h<0&&(h=0),h>1&&(h=1)}this._collisionPoint.copyFromFloats(0,0,0);var m=!1,_=1;if(l||(this.basePoint.subtractToRef(c.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(h,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,n,s,o,c.normal)&&(m=!0,_=h,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!m){var g=this.velocity.lengthSquared(),y=g;this.basePoint.subtractToRef(n,this._tempVector);var v=2*t.Vector3.Dot(this.velocity,this._tempVector),x=this._tempVector.lengthSquared()-1,b=i(y,v,x,_);b.found&&(_=b.root,m=!0,this._collisionPoint.copyFrom(n)),this.basePoint.subtractToRef(s,this._tempVector),v=2*t.Vector3.Dot(this.velocity,this._tempVector),x=this._tempVector.lengthSquared()-1,b=i(y,v,x,_),b.found&&(_=b.root,m=!0,this._collisionPoint.copyFrom(s)),this.basePoint.subtractToRef(o,this._tempVector),v=2*t.Vector3.Dot(this.velocity,this._tempVector),x=this._tempVector.lengthSquared()-1,b=i(y,v,x,_),b.found&&(_=b.root,m=!0,this._collisionPoint.copyFrom(o)),s.subtractToRef(n,this._edge),n.subtractToRef(this.basePoint,this._baseToVertex);var P=this._edge.lengthSquared(),T=t.Vector3.Dot(this._edge,this.velocity),S=t.Vector3.Dot(this._edge,this._baseToVertex);if(y=P*-g+T*T,v=P*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*T*S,x=P*(1-this._baseToVertex.lengthSquared())+S*S,b=i(y,v,x,_),b.found){var A=(T*b.root-S)/P;A>=0&&A<=1&&(_=b.root,m=!0,this._edge.scaleInPlace(A),n.addToRef(this._edge,this._collisionPoint))}o.subtractToRef(s,this._edge),s.subtractToRef(this.basePoint,this._baseToVertex),P=this._edge.lengthSquared(),T=t.Vector3.Dot(this._edge,this.velocity),S=t.Vector3.Dot(this._edge,this._baseToVertex),y=P*-g+T*T,v=P*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*T*S,x=P*(1-this._baseToVertex.lengthSquared())+S*S,b=i(y,v,x,_),b.found&&(A=(T*b.root-S)/P)>=0&&A<=1&&(_=b.root,m=!0,this._edge.scaleInPlace(A),s.addToRef(this._edge,this._collisionPoint)),n.subtractToRef(o,this._edge),o.subtractToRef(this.basePoint,this._baseToVertex),P=this._edge.lengthSquared(),T=t.Vector3.Dot(this._edge,this.velocity),S=t.Vector3.Dot(this._edge,this._baseToVertex),y=P*-g+T*T,v=P*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*T*S,x=P*(1-this._baseToVertex.lengthSquared())+S*S,b=i(y,v,x,_),b.found&&(A=(T*b.root-S)/P)>=0&&A<=1&&(_=b.root,m=!0,this._edge.scaleInPlace(A),o.addToRef(this._edge,this._collisionPoint))}if(m){var C=_*this.velocity.length();(!this.collisionFound||C<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=C,this.collisionFound=!0)}}},r.prototype._collide=function(t,e,i,r,n,s,o){for(var a=r;a<n;a+=3){var h=e[i[a]-s],l=e[i[a+1]-s],c=e[i[a+2]-s];this._testTriangle(a,t,c,l,h,o)}},r.prototype._getResponse=function(e,i){e.addToRef(i,this._destinationPoint),i.scaleInPlace(this.nearestDistance/i.length()),this.basePoint.addToRef(i,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(t.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,i)},r}();t.Collider=r}(r||(r={}));var r;!function(t){t.CollisionWorker="",function(t){t[t.INIT=0]="INIT",t[t.UPDATE=1]="UPDATE",t[t.COLLIDE=2]="COLLIDE"}(t.WorkerTaskType||(t.WorkerTaskType={}));var e=t.WorkerTaskType;!function(t){t[t.SUCCESS=0]="SUCCESS",t[t.UNKNOWN_ERROR=1]="UNKNOWN_ERROR"}(t.WorkerReplyType||(t.WorkerReplyType={}));var i=t.WorkerReplyType,r=function(){function r(){var n=this;this._scaledPosition=t.Vector3.Zero(),this._scaledVelocity=t.Vector3.Zero(),this.onMeshUpdated=function(t){n._addUpdateMeshesList[t.uniqueId]=r.SerializeMesh(t)},this.onGeometryUpdated=function(t){n._addUpdateGeometriesList[t.id]=r.SerializeGeometry(t)},this._afterRender=function(){if(n._init&&!(0==n._toRemoveGeometryArray.length&&0==n._toRemoveMeshesArray.length&&0==Object.keys(n._addUpdateGeometriesList).length&&0==Object.keys(n._addUpdateMeshesList).length||n._runningUpdated>4)){++n._runningUpdated;var t={updatedMeshes:n._addUpdateMeshesList,updatedGeometries:n._addUpdateGeometriesList,removedGeometries:n._toRemoveGeometryArray,removedMeshes:n._toRemoveMeshesArray},i={payload:t,taskType:e.UPDATE},r=[];for(var s in t.updatedGeometries)t.updatedGeometries.hasOwnProperty(s)&&(r.push(i.payload.updatedGeometries[s].indices.buffer),r.push(i.payload.updatedGeometries[s].normals.buffer),r.push(i.payload.updatedGeometries[s].positions.buffer));n._worker.postMessage(i,r),n._addUpdateMeshesList={},n._addUpdateGeometriesList={},n._toRemoveGeometryArray=[],n._toRemoveMeshesArray=[]}},this._onMessageFromWorker=function(r){var s=r.data;if(s.error!=i.SUCCESS)return void t.Tools.Warn("error returned from worker!");switch(s.taskType){case e.INIT:n._init=!0,n._scene.meshes.forEach(function(t){n.onMeshAdded(t)}),n._scene.getGeometries().forEach(function(t){n.onGeometryAdded(t)});break;case e.UPDATE:n._runningUpdated--;break;case e.COLLIDE:n._runningCollisionTask=!1;var o=s.payload;if(!n._collisionsCallbackArray[o.collisionId])return;n._collisionsCallbackArray[o.collisionId](o.collisionId,t.Vector3.FromArray(o.newPosition),n._scene.getMeshByUniqueID(o.collidedMeshUniqueId)),n._collisionsCallbackArray[o.collisionId]=void 0}},this._collisionsCallbackArray=[],this._init=!1,this._runningUpdated=0,this._runningCollisionTask=!1,this._addUpdateMeshesList={},this._addUpdateGeometriesList={},this._toRemoveGeometryArray=[],this._toRemoveMeshesArray=[]}return r.prototype.getNewPosition=function(t,i,r,n,s,o,a){if(this._init&&!this._collisionsCallbackArray[a]&&!this._collisionsCallbackArray[a+1e5]){t.divideToRef(r.radius,this._scaledPosition),i.divideToRef(r.radius,this._scaledVelocity),this._collisionsCallbackArray[a]=o;var h={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:r.radius.asArray()},collisionId:a,excludedMeshUniqueId:s?s.uniqueId:null,maximumRetry:n},l={payload:h,taskType:e.COLLIDE};this._worker.postMessage(l)}},r.prototype.init=function(i){this._scene=i,this._scene.registerAfterRender(this._afterRender);var r=t.WorkerIncluded?t.Engine.CodeRepository+"Collisions/babylon.collisionWorker.js":URL.createObjectURL(new Blob([t.CollisionWorker],{type:"application/javascript"}));this._worker=new Worker(r),this._worker.onmessage=this._onMessageFromWorker;var n={payload:{},taskType:e.INIT};this._worker.postMessage(n)},r.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender),this._worker.terminate()},r.prototype.onMeshAdded=function(t){t.registerAfterWorldMatrixUpdate(this.onMeshUpdated),this.onMeshUpdated(t)},r.prototype.onMeshRemoved=function(t){this._toRemoveMeshesArray.push(t.uniqueId)},r.prototype.onGeometryAdded=function(t){t.onGeometryUpdated=this.onGeometryUpdated,this.onGeometryUpdated(t)},r.prototype.onGeometryDeleted=function(t){this._toRemoveGeometryArray.push(t.id)},r.SerializeMesh=function(e){var i=[];e.subMeshes&&(i=e.subMeshes.map(function(t,e){return{position:e,verticesStart:t.verticesStart,verticesCount:t.verticesCount,indexStart:t.indexStart,indexCount:t.indexCount,hasMaterial:!!t.getMaterial(),sphereCenter:t.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:t.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:t.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:t.getBoundingInfo().boundingBox.maximumWorld.asArray()}}));var r=null;return e instanceof t.Mesh?r=e.geometry?e.geometry.id:null:e instanceof t.InstancedMesh&&(r=e.sourceMesh&&e.sourceMesh.geometry?e.sourceMesh.geometry.id:null),{uniqueId:e.uniqueId,id:e.id,name:e.name,geometryId:r,sphereCenter:e.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:e.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:e.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:e.getBoundingInfo().boundingBox.maximumWorld.asArray(),worldMatrixFromCache:e.worldMatrixFromCache.asArray(),subMeshes:i,checkCollisions:e.checkCollisions}},r.SerializeGeometry=function(e){return{id:e.id,positions:new Float32Array(e.getVerticesData(t.VertexBuffer.PositionKind)||[]),normals:new Float32Array(e.getVerticesData(t.VertexBuffer.NormalKind)||[]),indices:new Int32Array(e.getIndices()||[])}},r}();t.CollisionCoordinatorWorker=r;var n=function(){function e(){this._scaledPosition=t.Vector3.Zero(),this._scaledVelocity=t.Vector3.Zero(),this._finalPosition=t.Vector3.Zero()}return e.prototype.getNewPosition=function(t,e,i,r,n,s,o){t.divideToRef(i.radius,this._scaledPosition),e.divideToRef(i.radius,this._scaledVelocity),i.collidedMesh=null,i.retry=0,i.initialVelocity=this._scaledVelocity,i.initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,n),this._finalPosition.multiplyInPlace(i.radius),s(o,this._finalPosition,i.collidedMesh)},e.prototype.init=function(t){this._scene=t},e.prototype.destroy=function(){},e.prototype.onMeshAdded=function(t){},e.prototype.onMeshUpdated=function(t){},e.prototype.onMeshRemoved=function(t){},e.prototype.onGeometryAdded=function(t){},e.prototype.onGeometryUpdated=function(t){},e.prototype.onGeometryDeleted=function(t){},e.prototype._collideWithWorld=function(e,i,r,n,s,o){void 0===o&&(o=null);var a=10*t.Engine.CollisionsEpsilon;if(r.retry>=n)return void s.copyFrom(e);r._initialize(e,i,a);for(var h=0;h<this._scene.meshes.length;h++){var l=this._scene.meshes[h];l.isEnabled()&&l.checkCollisions&&l.subMeshes&&l!==o&&l._checkCollision(r)}return r.collisionFound?(0===i.x&&0===i.y&&0===i.z||r._getResponse(e,i),i.length()<=a?void s.copyFrom(e):(r.retry++,void this._collideWithWorld(e,i,r,n,s,o))):void e.addToRef(i,s)},e}();t.CollisionCoordinatorLegacy=n}(r||(r={}));var r;!function(t){var e=function(e){function i(r,n,s){e.call(this,r,s),this.upVector=t.Vector3.Up(),this.orthoLeft=null,this.orthoRight=null,this.orthoBottom=null,this.orthoTop=null,this.fov=.8,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this.mode=i.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new t.Viewport(0,0,1,1),this.layerMask=268435455,this.fovMode=i.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=i.RIG_MODE_NONE,this._rigCameras=new Array,this._computedViewMatrix=t.Matrix.Identity(),this._projectionMatrix=new t.Matrix,this._doNotComputeProjectionMatrix=!1,this._postProcesses=new Array,this._transformMatrix=t.Matrix.Zero(),this._webvrViewMatrix=t.Matrix.Identity(),this._activeMeshes=new t.SmartArray(256),this._globalPosition=t.Vector3.Zero(),this._refreshFrustumPlanes=!0,s.addCamera(this),s.activeCamera||(s.activeCamera=this),this.position=n}return o(i,e),Object.defineProperty(i,"PERSPECTIVE_CAMERA",{get:function(){return i._PERSPECTIVE_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ORTHOGRAPHIC_CAMERA",{get:function(){return i._ORTHOGRAPHIC_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOVMODE_VERTICAL_FIXED",{get:function(){return i._FOVMODE_VERTICAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOVMODE_HORIZONTAL_FIXED",{get:function(){return i._FOVMODE_HORIZONTAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_NONE",{get:function(){return i._RIG_MODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_ANAGLYPH",{get:function(){return i._RIG_MODE_STEREOSCOPIC_ANAGLYPH},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL",{get:function(){return i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED",{get:function(){return i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_OVERUNDER",{get:function(){return i._RIG_MODE_STEREOSCOPIC_OVERUNDER},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_VR",{get:function(){return i._RIG_MODE_VR},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_WEBVR",{get:function(){return i._RIG_MODE_WEBVR},enumerable:!0,configurable:!0}),i.prototype.toString=function(t){var e="Name: "+this.name;if(e+=", type: "+this.getTypeName(),this.animations)for(var i=0;i<this.animations.length;i++)e+=", animation[0]: "+this.animations[i].toString(t);return e},Object.defineProperty(i.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:!0,configurable:!0}),i.prototype.getActiveMeshes=function(){return this._activeMeshes},i.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},i.prototype._initCache=function(){e.prototype._initCache.call(this),this._cache.position=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},i.prototype._updateCache=function(t){t||e.prototype._updateCache.call(this);var i=this.getEngine();this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector),this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=i.getAspectRatio(this),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=i.getRenderWidth(),this._cache.renderHeight=i.getRenderHeight()},i.prototype._updateFromScene=function(){this.updateCache(),this.update()},i.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},i.prototype._isSynchronizedViewMatrix=function(){return!!e.prototype._isSynchronized.call(this)&&(this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent())},i.prototype._isSynchronizedProjectionMatrix=function(){var t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!t)return!1;var e=this.getEngine();return t=this.mode===i.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===e.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===e.getRenderWidth()&&this._cache.renderHeight===e.getRenderHeight()},i.prototype.attachControl=function(t,e){},i.prototype.detachControl=function(t){},i.prototype.update=function(){this.cameraRigMode!==i.RIG_MODE_NONE&&this._updateRigCameras(),this._checkInputs()},i.prototype._checkInputs=function(){},i.prototype._cascadePostProcessesToRigCams=function(){this._postProcesses.length>0&&this._postProcesses[0].markTextureDirty();for(var e=0,i=this._rigCameras.length;e<i;e++){var r=this._rigCameras[e],n=r._rigPostProcess;if(n){n instanceof t.PassPostProcess&&(r.isIntermediate=0===this._postProcesses.length),r._postProcesses=this._postProcesses.slice(0).concat(n),n.markTextureDirty()}else r._postProcesses=this._postProcesses.slice(0)}},i.prototype.attachPostProcess=function(e,i){return void 0===i&&(i=null),!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(t.Tools.Error("You're trying to reuse a post process not defined as reusable."),0):(null==i||i<0?this._postProcesses.push(e):this._postProcesses.splice(i,0,e),this._cascadePostProcessesToRigCams(),this._postProcesses.indexOf(e))},i.prototype.detachPostProcess=function(t,e){void 0===e&&(e=null);var i,r,n=[];if(e)for(e=e instanceof Array?e:[e],i=e.length-1;i>=0;i--)this._postProcesses[e[i]]===t?this._postProcesses.splice(r,1):n.push(i);else{var s=this._postProcesses.indexOf(t);s!==-1&&this._postProcesses.splice(s,1)}return this._cascadePostProcessesToRigCams(),n},i.prototype.getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=t.Matrix.Identity()),this.getViewMatrix().invertToRef(this._worldMatrix),this._worldMatrix},i.prototype._getViewMatrix=function(){return t.Matrix.Identity()},i.prototype.getViewMatrix=function(e){return this._computedViewMatrix=this._computeViewMatrix(e),!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._refreshFrustumPlanes=!0,this.parent&&this.parent.getWorldMatrix?(this._worldMatrix||(this._worldMatrix=t.Matrix.Identity()),this._computedViewMatrix.invertToRef(this._worldMatrix),this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix),this._globalPosition.copyFromFloats(this._computedViewMatrix.m[12],this._computedViewMatrix.m[13],this._computedViewMatrix.m[14]),this._computedViewMatrix.invert(),this._markSyncedWithParent()):this._globalPosition.copyFrom(this.position),this._currentRenderId=this.getScene().getRenderId(),this._computedViewMatrix)},i.prototype._computeViewMatrix=function(t){return!t&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._computedViewMatrix)},i.prototype.freezeProjectionMatrix=function(t){this._doNotComputeProjectionMatrix=!0,void 0!==t&&(this._projectionMatrix=t)},i.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},i.prototype.getProjectionMatrix=function(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._refreshFrustumPlanes=!0;var r=this.getEngine(),n=this.getScene();if(this.mode===i.PERSPECTIVE_CAMERA)return this.minZ<=0&&(this.minZ=.1),n.useRightHandedSystem?t.Matrix.PerspectiveFovRHToRef(this.fov,r.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED):t.Matrix.PerspectiveFovLHToRef(this.fov,r.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED),this._projectionMatrix;var s=r.getRenderWidth()/2,o=r.getRenderHeight()/2;return n.useRightHandedSystem?t.Matrix.OrthoOffCenterRHToRef(this.orthoLeft||-s,this.orthoRight||s,this.orthoBottom||-o,this.orthoTop||o,this.minZ,this.maxZ,this._projectionMatrix):t.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-s,this.orthoRight||s,this.orthoBottom||-o,this.orthoTop||o,this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix},i.prototype.getTranformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},i.prototype.updateFrustumPlanes=function(){this._refreshFrustumPlanes&&(this.getTranformationMatrix(),this._frustumPlanes?t.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=t.Frustum.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},i.prototype.isInFrustum=function(t){return this.updateFrustumPlanes(),t.isInFrustum(this._frustumPlanes)},i.prototype.isCompletelyInFrustum=function(t){return this.updateFrustumPlanes(),t.isCompletelyInFrustum(this._frustumPlanes)},i.prototype.dispose=function(){for(this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;)this._rigCameras.pop().dispose();for(var t=0;t<this._postProcesses.length;++t)this._postProcesses[t].dispose(this);e.prototype.dispose.call(this)},i.prototype.setCameraRigMode=function(e,r){for(;this._rigCameras.length>0;)this._rigCameras.pop().dispose();switch(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=r.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=t.Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==i.RIG_MODE_NONE&&(this._rigCameras.push(this.createRigCamera(this.name+"_L",0)),this._rigCameras.push(this.createRigCamera(this.name+"_R",1))),this.cameraRigMode){case i.RIG_MODE_STEREOSCOPIC_ANAGLYPH:this._rigCameras[0]._rigPostProcess=new t.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]),this._rigCameras[1]._rigPostProcess=new t.AnaglyphPostProcess(this.name+"_anaglyph",1,this._rigCameras);break;case i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case i.RIG_MODE_STEREOSCOPIC_OVERUNDER:var n=this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;this._rigCameras[0]._rigPostProcess=new t.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]),this._rigCameras[1]._rigPostProcess=new t.StereoscopicInterlacePostProcess(this.name+"_stereoInterlace",this._rigCameras,n);break;case i.RIG_MODE_VR:var s=r.vrCameraMetrics||t.VRCameraMetrics.GetDefault();this._rigCameras[0]._cameraRigParams.vrMetrics=s,this._rigCameras[0].viewport=new t.Viewport(0,0,.5,1),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new t.Matrix,this._rigCameras[0]._cameraRigParams.vrHMatrix=s.leftHMatrix,this._rigCameras[0]._cameraRigParams.vrPreViewMatrix=s.leftPreViewMatrix,this._rigCameras[0].getProjectionMatrix=this._rigCameras[0]._getVRProjectionMatrix,this._rigCameras[1]._cameraRigParams.vrMetrics=s,this._rigCameras[1].viewport=new t.Viewport(.5,0,.5,1),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new t.Matrix,this._rigCameras[1]._cameraRigParams.vrHMatrix=s.rightHMatrix,this._rigCameras[1]._cameraRigParams.vrPreViewMatrix=s.rightPreViewMatrix,this._rigCameras[1].getProjectionMatrix=this._rigCameras[1]._getVRProjectionMatrix,s.compensateDistortion&&(this._rigCameras[0]._rigPostProcess=new t.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Left",this._rigCameras[0],!1,s),this._rigCameras[1]._rigPostProcess=new t.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Right",this._rigCameras[1],!0,s));break;case i.RIG_MODE_WEBVR:r.vrDisplay&&(this._rigCameras[0].viewport=new t.Viewport(0,0,.5,1),this._rigCameras[0].setCameraRigParameter("left",!0),this._rigCameras[0].setCameraRigParameter("frameData",r.frameData),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new t.Matrix,this._rigCameras[0].getProjectionMatrix=this._getWebVRProjectionMatrix,this._rigCameras[1].viewport=new t.Viewport(.5,0,.5,1),this._rigCameras[1].setCameraRigParameter("frameData",r.frameData),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new t.Matrix,this._rigCameras[1].getProjectionMatrix=this._getWebVRProjectionMatrix)}this._cascadePostProcessesToRigCams(),this.update()},i.prototype._getVRProjectionMatrix=function(){return t.Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},i.prototype._getWebVRProjectionMatrix=function(){var e=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return[8,9,10,11].forEach(function(t){e[t]*=-1}),t.Matrix.FromArrayToRef(e,0,this._projectionMatrix),this._projectionMatrix},i.prototype._getWebVRViewMatrix=function(){var e=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return[8,9,10,11].forEach(function(t){e[t]*=-1}),t.Matrix.FromArrayToRef(e,0,this._webvrViewMatrix),this._webvrViewMatrix},i.prototype.setCameraRigParameter=function(e,i){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=i,"interaxialDistance"===e&&(this._cameraRigParams.stereoHalfAngle=t.Tools.ToRadians(i/.0637))},i.prototype.createRigCamera=function(t,e){return null},i.prototype._updateRigCameras=function(){for(var t=0;t<this._rigCameras.length;t++)this._rigCameras[t].minZ=this.minZ,this._rigCameras[t].maxZ=this.maxZ,this._rigCameras[t].fov=this.fov;this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},i.prototype._setupInputs=function(){},i.prototype.serialize=function(){var e=t.SerializationHelper.Serialize(this);return e.type=this.getTypeName(),this.parent&&(e.parentId=this.parent.id),this.inputs&&this.inputs.serialize(e),t.Animation.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e},i.prototype.getTypeName=function(){return"Camera"},i.prototype.clone=function(e){return t.SerializationHelper.Clone(i.GetConstructorFromName(this.getTypeName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this)},i.prototype.getDirection=function(e){var i=t.Vector3.Zero();return this.getDirectionToRef(e,i),i},i.prototype.getDirectionToRef=function(e,i){t.Vector3.TransformNormalToRef(e,this.getWorldMatrix(),i)},i.GetConstructorFromName=function(e,i,r,n,s){switch(void 0===n&&(n=0),void 0===s&&(s=!0),e){case"ArcRotateCamera":return function(){return new t.ArcRotateCamera(i,0,0,1,t.Vector3.Zero(),r)};case"DeviceOrientationCamera":return function(){return new t.DeviceOrientationCamera(i,t.Vector3.Zero(),r)};case"FollowCamera":return function(){return new t.FollowCamera(i,t.Vector3.Zero(),r)};case"ArcFollowCamera":return function(){return new t.ArcFollowCamera(i,0,0,1,null,r)};case"GamepadCamera":return function(){return new t.GamepadCamera(i,t.Vector3.Zero(),r)};case"TouchCamera":return function(){return new t.TouchCamera(i,t.Vector3.Zero(),r)};case"VirtualJoysticksCamera":return function(){return new t.VirtualJoysticksCamera(i,t.Vector3.Zero(),r)};case"WebVRFreeCamera":return function(){return new t.WebVRFreeCamera(i,t.Vector3.Zero(),r)};case"VRDeviceOrientationFreeCamera":return function(){return new t.VRDeviceOrientationFreeCamera(i,t.Vector3.Zero(),r)};case"AnaglyphArcRotateCamera":return function(){return new t.AnaglyphArcRotateCamera(i,0,0,1,t.Vector3.Zero(),n,r)};case"AnaglyphFreeCamera":return function(){return new t.AnaglyphFreeCamera(i,t.Vector3.Zero(),n,r)};case"AnaglyphGamepadCamera":return function(){return new t.AnaglyphGamepadCamera(i,t.Vector3.Zero(),n,r)};case"AnaglyphUniversalCamera":return function(){return new t.AnaglyphUniversalCamera(i,t.Vector3.Zero(),n,r)};case"StereoscopicArcRotateCamera":return function(){return new t.StereoscopicArcRotateCamera(i,0,0,1,t.Vector3.Zero(),n,s,r)};case"StereoscopicFreeCamera":return function(){return new t.StereoscopicFreeCamera(i,t.Vector3.Zero(),n,s,r)};case"StereoscopicGamepadCamera":return function(){return new t.StereoscopicGamepadCamera(i,t.Vector3.Zero(),n,s,r)};case"StereoscopicUniversalCamera":return function(){return new t.StereoscopicUniversalCamera(i,t.Vector3.Zero(),n,s,r)};case"FreeCamera":return function(){return new t.UniversalCamera(i,t.Vector3.Zero(),r)};default:return function(){return new t.UniversalCamera(i,t.Vector3.Zero(),r)}}},i.Parse=function(e,r){var n=e.type,s=i.GetConstructorFromName(n,e.name,r,e.interaxial_distance,e.isStereoscopicSideBySide),o=t.SerializationHelper.Parse(s,e,r);if(e.parentId&&(o._waitingParentId=e.parentId),o.inputs&&(o.inputs.parse(e),o._setupInputs()),e.target&&o.setTarget&&o.setTarget(t.Vector3.FromArray(e.target)),e.cameraRigMode){var a=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};o.setCameraRigMode(e.cameraRigMode,a)}if(e.animations){for(var h=0;h<e.animations.length;h++){var l=e.animations[h];o.animations.push(t.Animation.Parse(l))}t.Node.ParseAnimationRanges(o,e,r)}return e.autoAnimate&&r.beginAnimation(o,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),o},i._PERSPECTIVE_CAMERA=0,i._ORTHOGRAPHIC_CAMERA=1,i._FOVMODE_VERTICAL_FIXED=0,i._FOVMODE_HORIZONTAL_FIXED=1,i._RIG_MODE_NONE=0,i._RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,i._RIG_MODE_STEREOSCOPIC_OVERUNDER=13,i._RIG_MODE_VR=20,i._RIG_MODE_WEBVR=21,i.ForceAttachControlToAlwaysPreventDefault=!1,s([t.serializeAsVector3()],i.prototype,"position",void 0),s([t.serializeAsVector3()],i.prototype,"upVector",void 0),s([t.serialize()],i.prototype,"orthoLeft",void 0),s([t.serialize()],i.prototype,"orthoRight",void 0),s([t.serialize()],i.prototype,"orthoBottom",void 0),s([t.serialize()],i.prototype,"orthoTop",void 0),s([t.serialize()],i.prototype,"fov",void 0),s([t.serialize()],i.prototype,"minZ",void 0),s([t.serialize()],i.prototype,"maxZ",void 0),s([t.serialize()],i.prototype,"inertia",void 0),s([t.serialize()],i.prototype,"mode",void 0),s([t.serialize()],i.prototype,"layerMask",void 0),s([t.serialize()],i.prototype,"fovMode",void 0),s([t.serialize()],i.prototype,"cameraRigMode",void 0),s([t.serialize()],i.prototype,"interaxialDistance",void 0),s([t.serialize()],i.prototype,"isStereoscopicSideBySide",void 0),i}(t.Node);t.Camera=e}(r||(r={}));var r;!function(t){t.CameraInputTypes={};var e=function(){function e(t){this.attached={},this.camera=t,this.checkInputs=function(){}}return e.prototype.add=function(e){var i=e.getSimpleName();if(this.attached[i])return void t.Tools.Warn("camera input of type "+i+" already exists on camera");this.attached[i]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedElement&&e.attachControl(this.attachedElement)},e.prototype.remove=function(t){for(var e in this.attached){var i=this.attached[e];i===t&&(i.detachControl(this.attachedElement),delete this.attached[e],this.rebuildInputCheck())}},e.prototype.removeByType=function(t){for(var e in this.attached){var i=this.attached[e];i.getTypeName()===t&&(i.detachControl(this.attachedElement),delete this.attached[e],this.rebuildInputCheck())}},e.prototype._addCheckInputs=function(t){var e=this.checkInputs;return function(){e(),t()}},e.prototype.attachInput=function(t){t.attachControl(this.attachedElement,this.noPreventDefault)},e.prototype.attachElement=function(e,i){if(!this.attachedElement){i=!t.Camera.ForceAttachControlToAlwaysPreventDefault&&i,this.attachedElement=e,this.noPreventDefault=i;for(var r in this.attached){this.attached[r];this.attached[r].attachControl(e,i)}}},e.prototype.detachElement=function(t){if(this.attachedElement===t){for(var e in this.attached){this.attached[e];this.attached[e].detachControl(t)}this.attachedElement=null}},e.prototype.rebuildInputCheck=function(){this.checkInputs=function(){};for(var t in this.attached){var e=this.attached[t];e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e)))}},e.prototype.clear=function(){this.attachedElement&&this.detachElement(this.attachedElement),this.attached={},this.attachedElement=null,this.checkInputs=function(){}},e.prototype.serialize=function(e){var i={};for(var r in this.attached){var n=this.attached[r],s=t.SerializationHelper.Serialize(n);i[n.getTypeName()]=s}e.inputsmgr=i},e.prototype.parse=function(e){var i=e.inputsmgr;if(i){this.clear();for(var r in i){var n=t.CameraInputTypes[r];if(n){var s=i[r],o=t.SerializationHelper.Parse(function(){return new n},s,null);this.add(o)}}}else for(var r in this.attached){var n=t.CameraInputTypes[this.attached[r].getTypeName()];if(n){var o=t.SerializationHelper.Parse(function(){return new n},e,null);this.remove(this.attached[r]),this.add(o)}}},e}();t.CameraInputsManager=e}(r||(r={}));var r;!function(t){var e=function(){function e(t){void 0===t&&(t=!0),this.touchEnabled=t,this.buttons=[0,1,2],this.angularSensibility=2e3}return e.prototype.attachControl=function(e,i){var r=this,n=this.camera.getEngine();this._pointerInput||(this._pointerInput=function(s,o){var a=s.event;if((r.touchEnabled||"touch"!==a.pointerType)&&(s.type===t.PointerEventTypes.POINTERMOVE||r.buttons.indexOf(a.button)!==-1))if(s.type===t.PointerEventTypes.POINTERDOWN){try{a.srcElement.setPointerCapture(a.pointerId)}catch(t){}r.previousPosition={x:a.clientX,y:a.clientY},i||(a.preventDefault(),e.focus())}else if(s.type===t.PointerEventTypes.POINTERUP){try{a.srcElement.releasePointerCapture(a.pointerId)}catch(t){}r.previousPosition=null,i||a.preventDefault()}else if(s.type===t.PointerEventTypes.POINTERMOVE){if(!r.previousPosition||n.isPointerLock)return;var h=a.clientX-r.previousPosition.x,l=a.clientY-r.previousPosition.y;r.camera.getScene().useRightHandedSystem?r.camera.cameraRotation.y-=h/r.angularSensibility:r.camera.cameraRotation.y+=h/r.angularSensibility,r.camera.cameraRotation.x+=l/r.angularSensibility,r.previousPosition={x:a.clientX,y:a.clientY},i||a.preventDefault()}}),this._onMouseMove=function(t){if(n.isPointerLock){var e=t.movementX||t.mozMovementX||t.webkitMovementX||t.msMovementX||0,s=t.movementY||t.mozMovementY||t.webkitMovementY||t.msMovementY||0;r.camera.getScene().useRightHandedSystem?r.camera.cameraRotation.y-=e/r.angularSensibility:r.camera.cameraRotation.y+=e/r.angularSensibility,r.camera.cameraRotation.x+=s/r.angularSensibility,r.previousPosition=null,i||t.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,t.PointerEventTypes.POINTERDOWN|t.PointerEventTypes.POINTERUP|t.PointerEventTypes.POINTERMOVE),e.addEventListener("mousemove",this._onMouseMove,!1)},e.prototype.detachControl=function(t){this._observer&&t&&(this.camera.getScene().onPointerObservable.remove(this._observer),t.removeEventListener("mousemove",this._onMouseMove),this._observer=null,this._onMouseMove=null,this.previousPosition=null)},e.prototype.getTypeName=function(){return"FreeCameraMouseInput"},e.prototype.getSimpleName=function(){return"mouse"},s([t.serialize()],e.prototype,"buttons",void 0),s([t.serialize()],e.prototype,"angularSensibility",void 0),e}();t.FreeCameraMouseInput=e,t.CameraInputTypes.FreeCameraMouseInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39]}return e.prototype.attachControl=function(e,i){var r=this;this._onKeyDown||(e.tabIndex=1,this._onKeyDown=function(t){if(r.keysUp.indexOf(t.keyCode)!==-1||r.keysDown.indexOf(t.keyCode)!==-1||r.keysLeft.indexOf(t.keyCode)!==-1||r.keysRight.indexOf(t.keyCode)!==-1){r._keys.indexOf(t.keyCode)===-1&&r._keys.push(t.keyCode),i||t.preventDefault()}},this._onKeyUp=function(t){if(r.keysUp.indexOf(t.keyCode)!==-1||r.keysDown.indexOf(t.keyCode)!==-1||r.keysLeft.indexOf(t.keyCode)!==-1||r.keysRight.indexOf(t.keyCode)!==-1){var e=r._keys.indexOf(t.keyCode);e>=0&&r._keys.splice(e,1),i||t.preventDefault()}},e.addEventListener("keydown",this._onKeyDown,!1),e.addEventListener("keyup",this._onKeyUp,!1),t.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]))},e.prototype.detachControl=function(e){this._onKeyDown&&(e.removeEventListener("keydown",this._onKeyDown),e.removeEventListener("keyup",this._onKeyUp),t.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]),this._keys=[],this._onKeyDown=null,this._onKeyUp=null)},e.prototype.checkInputs=function(){if(this._onKeyDown)for(var e=this.camera,i=0;i<this._keys.length;i++){var r=this._keys[i],n=e._computeLocalCameraSpeed();this.keysLeft.indexOf(r)!==-1?e._localDirection.copyFromFloats(-n,0,0):this.keysUp.indexOf(r)!==-1?e._localDirection.copyFromFloats(0,0,n):this.keysRight.indexOf(r)!==-1?e._localDirection.copyFromFloats(n,0,0):this.keysDown.indexOf(r)!==-1&&e._localDirection.copyFromFloats(0,0,-n),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),t.Vector3.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}},e.prototype.getTypeName=function(){return"FreeCameraKeyboardMoveInput"},e.prototype._onLostFocus=function(t){this._keys=[]},e.prototype.getSimpleName=function(){return"keyboard"},s([t.serialize()],e.prototype,"keysUp",void 0),s([t.serialize()],e.prototype,"keysDown",void 0),s([t.serialize()],e.prototype,"keysLeft",void 0),s([t.serialize()],e.prototype,"keysRight",void 0),e}();t.FreeCameraKeyboardMoveInput=e,t.CameraInputTypes.FreeCameraKeyboardMoveInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this._offsetX=null,this._offsetY=null,this._pointerCount=0,this._pointerPressed=[],this.touchAngularSensibility=2e5,this.touchMoveSensibility=250}return e.prototype.attachControl=function(e,i){var r,n=this;void 0===this._pointerInput&&(this._onLostFocus=function(t){n._offsetX=null,n._offsetY=null},this._pointerInput=function(e,s){var o=e.event;if("mouse"!==o.pointerType)if(e.type===t.PointerEventTypes.POINTERDOWN){if(i||o.preventDefault(),n._pointerPressed.push(o.pointerId),1!==n._pointerPressed.length)return;r={x:o.clientX,y:o.clientY}}else if(e.type===t.PointerEventTypes.POINTERUP){i||o.preventDefault();var a=n._pointerPressed.indexOf(o.pointerId);if(a===-1)return;if(n._pointerPressed.splice(a,1),0!=a)return;r=null,n._offsetX=null,n._offsetY=null}else if(e.type===t.PointerEventTypes.POINTERMOVE){if(i||o.preventDefault(),!r)return;var a=n._pointerPressed.indexOf(o.pointerId);if(0!=a)return;n._offsetX=o.clientX-r.x,n._offsetY=-(o.clientY-r.y)}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,t.PointerEventTypes.POINTERDOWN|t.PointerEventTypes.POINTERUP|t.PointerEventTypes.POINTERMOVE),e.addEventListener("blur",this._onLostFocus)},e.prototype.detachControl=function(t){this._pointerInput&&t&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null,this._pointerPressed=[],this._offsetX=null,this._offsetY=null,this._pointerCount=0)},e.prototype.checkInputs=function(){if(this._offsetX){var e=this.camera;if(e.cameraRotation.y+=this._offsetX/this.touchAngularSensibility,this._pointerPressed.length>1)e.cameraRotation.x+=-this._offsetY/this.touchAngularSensibility;else{var i=e._computeLocalCameraSpeed(),r=new t.Vector3(0,0,i*this._offsetY/this.touchMoveSensibility);t.Matrix.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(t.Vector3.TransformCoordinates(r,e._cameraRotationMatrix))}}},e.prototype.getTypeName=function(){return"FreeCameraTouchInput"},e.prototype.getSimpleName=function(){return"touch"},s([t.serialize()],e.prototype,"touchAngularSensibility",void 0),s([t.serialize()],e.prototype,"touchMoveSensibility",void 0),e}();t.FreeCameraTouchInput=e,t.CameraInputTypes.FreeCameraTouchInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){var e=this;this._screenOrientationAngle=0,this._screenQuaternion=new t.Quaternion,this._alpha=0,this._beta=0,this._gamma=0,this._orientationChanged=function(){e._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,e._screenOrientationAngle=-t.Tools.ToRadians(e._screenOrientationAngle/2),e._screenQuaternion.copyFromFloats(0,Math.sin(e._screenOrientationAngle),0,Math.cos(e._screenOrientationAngle))},this._deviceOrientation=function(t){e._alpha=t.alpha,e._beta=t.beta,e._gamma=t.gamma},this._constantTranform=new t.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}return Object.defineProperty(e.prototype,"camera",{get:function(){return this._camera},set:function(e){this._camera=e,this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new t.Quaternion)},enumerable:!0,configurable:!0}),e.prototype.attachControl=function(t,e){window.addEventListener("orientationchange",this._orientationChanged),window.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()},e.prototype.detachControl=function(t){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation)},e.prototype.checkInputs=function(){this._alpha&&(t.Quaternion.RotationYawPitchRollToRef(t.Tools.ToRadians(this._alpha),t.Tools.ToRadians(this._beta),-t.Tools.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)},e.prototype.getTypeName=function(){return"FreeCameraDeviceOrientationInput"},e.prototype.getSimpleName=function(){return"deviceOrientation"},e}();t.FreeCameraDeviceOrientationInput=e,t.CameraInputTypes.FreeCameraDeviceOrientationInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40}return e.prototype.attachControl=function(e,i){var r=this;this._gamepads=new t.Gamepads(function(t){r._onNewGameConnected(t)})},e.prototype.detachControl=function(t){this._gamepads&&this._gamepads.dispose(),this.gamepad=null},e.prototype.checkInputs=function(){if(this.gamepad){var e=this.camera,i=this.gamepad.leftStick,r=i.x/this.gamepadMoveSensibility,n=i.y/this.gamepadMoveSensibility;i.x=Math.abs(r)>.005?0+r:0,i.y=Math.abs(n)>.005?0+n:0;var s=this.gamepad.rightStick,o=s.x/this.gamepadAngularSensibility,a=s.y/this.gamepadAngularSensibility;s.x=Math.abs(o)>.001?0+o:0,s.y=Math.abs(a)>.001?0+a:0;var h=t.Matrix.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),l=50*e._computeLocalCameraSpeed(),c=t.Vector3.TransformCoordinates(new t.Vector3(i.x*l,0,-i.y*l),h);e.cameraDirection=e.cameraDirection.add(c),e.cameraRotation=e.cameraRotation.add(new t.Vector2(s.y,s.x))}},e.prototype._onNewGameConnected=function(t){0===t.index&&(this.gamepad=t)},e.prototype.getTypeName=function(){return"FreeCameraGamepadInput"},e.prototype.getSimpleName=function(){return"gamepad"},s([t.serialize()],e.prototype,"gamepadAngularSensibility",void 0),s([t.serialize()],e.prototype,"gamepadMoveSensibility",void 0),e}();t.FreeCameraGamepadInput=e,t.CameraInputTypes.FreeCameraGamepadInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39]}return e.prototype.attachControl=function(e,i){var r=this;e.tabIndex=1,this._onKeyDown=function(t){if(r.keysUp.indexOf(t.keyCode)!==-1||r.keysDown.indexOf(t.keyCode)!==-1||r.keysLeft.indexOf(t.keyCode)!==-1||r.keysRight.indexOf(t.keyCode)!==-1){r._keys.indexOf(t.keyCode)===-1&&r._keys.push(t.keyCode),t.preventDefault&&(i||t.preventDefault())}},this._onKeyUp=function(t){if(r.keysUp.indexOf(t.keyCode)!==-1||r.keysDown.indexOf(t.keyCode)!==-1||r.keysLeft.indexOf(t.keyCode)!==-1||r.keysRight.indexOf(t.keyCode)!==-1){var e=r._keys.indexOf(t.keyCode);e>=0&&r._keys.splice(e,1),t.preventDefault&&(i||t.preventDefault())}},this._onLostFocus=function(){r._keys=[]},e.addEventListener("keydown",this._onKeyDown,!1),e.addEventListener("keyup",this._onKeyUp,!1),t.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])},e.prototype.detachControl=function(e){e&&(e.removeEventListener("keydown",this._onKeyDown),e.removeEventListener("keyup",this._onKeyUp)),t.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]),this._keys=[],this._onKeyDown=null,this._onKeyUp=null,this._onLostFocus=null},e.prototype.checkInputs=function(){if(this._onKeyDown)for(var t=this.camera,e=0;e<this._keys.length;e++){var i=this._keys[e];this.keysLeft.indexOf(i)!==-1?t.inertialAlphaOffset-=.01:this.keysUp.indexOf(i)!==-1?t.inertialBetaOffset-=.01:this.keysRight.indexOf(i)!==-1?t.inertialAlphaOffset+=.01:this.keysDown.indexOf(i)!==-1&&(t.inertialBetaOffset+=.01)}},e.prototype.getTypeName=function(){return"ArcRotateCameraKeyboardMoveInput"},e.prototype.getSimpleName=function(){return"keyboard"},s([t.serialize()],e.prototype,"keysUp",void 0),s([t.serialize()],e.prototype,"keysDown",void 0),s([t.serialize()],e.prototype,"keysLeft",void 0),s([t.serialize()],e.prototype,"keysRight",void 0),e}();t.ArcRotateCameraKeyboardMoveInput=e,t.CameraInputTypes.ArcRotateCameraKeyboardMoveInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this.wheelPrecision=3}return e.prototype.attachControl=function(e,i){var r=this;this._wheel=function(e,n){if(e.type===t.PointerEventTypes.POINTERWHEEL){var s=e.event,o=0;s.wheelDelta?o=s.wheelDelta/(40*r.wheelPrecision):s.detail&&(o=-s.detail/r.wheelPrecision),o&&(r.camera.inertialRadiusOffset+=o),s.preventDefault&&(i||s.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,t.PointerEventTypes.POINTERWHEEL)},e.prototype.detachControl=function(t){this._observer&&t&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},e.prototype.getTypeName=function(){return"ArcRotateCameraMouseWheelInput"},e.prototype.getSimpleName=function(){return"mousewheel"},s([t.serialize()],e.prototype,"wheelPrecision",void 0),e}();t.ArcRotateCameraMouseWheelInput=e,t.CameraInputTypes.ArcRotateCameraMouseWheelInput=e}(r||(r={}));var r;!function(t){var e=(t.Tools.GetPointerPrefix(),function(){function e(){this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=6,this.panningSensibility=50,this._isPanClick=!1,this.pinchInwards=!0}return e.prototype.attachControl=function(e,i){var r,n,s,o=this,a=this.camera.getEngine(),h=0;this._pointerInput=function(a,l){var c=a.event;if(a.type===t.PointerEventTypes.POINTERMOVE||o.buttons.indexOf(c.button)!==-1)if(a.type===t.PointerEventTypes.POINTERDOWN){try{c.srcElement.setPointerCapture(c.pointerId)}catch(t){}o._isPanClick=c.button===o.camera._panningMouseButton,r={x:c.clientX,y:c.clientY,pointerId:c.pointerId,type:c.pointerType},void 0===n?n=r:void 0===s&&(s=r),i||(c.preventDefault(),e.focus())}else if(a.type===t.PointerEventTypes.POINTERUP){try{c.srcElement.releasePointerCapture(c.pointerId)}catch(t){}r=null,h=0,n=s=void 0,i||c.preventDefault()}else if(a.type===t.PointerEventTypes.POINTERMOVE)if(i||c.preventDefault(),n&&void 0===s){if(0!==o.panningSensibility&&(c.ctrlKey&&o.camera._useCtrlForPanning||!o.camera._useCtrlForPanning&&o._isPanClick))o.camera.inertialPanningX+=-(c.clientX-r.x)/o.panningSensibility,o.camera.inertialPanningY+=(c.clientY-r.y)/o.panningSensibility;else{var u=c.clientX-r.x,p=c.clientY-r.y;o.camera.inertialAlphaOffset-=u/o.angularSensibilityX,o.camera.inertialBetaOffset-=p/o.angularSensibilityY}r.x=c.clientX,r.y=c.clientY}else if(n&&s){var d=n.pointerId===c.pointerId?n:s;d.x=c.clientX,d.y=c.clientY;var f=o.pinchInwards?1:-1,m=n.x-s.x,_=n.y-s.y,g=m*m+_*_;if(0===h)return void(h=g);g!==h&&(o.camera.inertialRadiusOffset+=(g-h)/(o.pinchPrecision*((o.angularSensibilityX+o.angularSensibilityY)/2)*f),h=g)}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,t.PointerEventTypes.POINTERDOWN|t.PointerEventTypes.POINTERUP|t.PointerEventTypes.POINTERMOVE),this._onContextMenu=function(t){t.preventDefault()},this.camera._useCtrlForPanning||e.addEventListener("contextmenu",this._onContextMenu,!1),this._onLostFocus=function(){n=s=void 0,h=0,r=null},this._onMouseMove=function(t){if(a.isPointerLock){var e=t.movementX||t.mozMovementX||t.webkitMovementX||t.msMovementX||0,r=t.movementY||t.mozMovementY||t.webkitMovementY||t.msMovementY||0;o.camera.inertialAlphaOffset-=e/o.angularSensibilityX,o.camera.inertialBetaOffset-=r/o.angularSensibilityY,i||t.preventDefault()}},this._onGestureStart=function(t){void 0!==window.MSGesture&&(o._MSGestureHandler||(o._MSGestureHandler=new MSGesture,o._MSGestureHandler.target=e),o._MSGestureHandler.addPointer(t.pointerId))},this._onGesture=function(t){o.camera.radius*=t.scale,t.preventDefault&&(i||(t.stopPropagation(),t.preventDefault()))},e.addEventListener("mousemove",this._onMouseMove,!1),e.addEventListener("MSPointerDown",this._onGestureStart,!1),e.addEventListener("MSGestureChange",this._onGesture,!1),e.addEventListener("keydown",this._onKeyDown,!1),e.addEventListener("keyup",this._onKeyUp,!1),t.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])},e.prototype.detachControl=function(e){e&&this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,e.removeEventListener("contextmenu",this._onContextMenu),e.removeEventListener("mousemove",this._onMouseMove),e.removeEventListener("MSPointerDown",this._onGestureStart),e.removeEventListener("MSGestureChange",this._onGesture),e.removeEventListener("keydown",this._onKeyDown),e.removeEventListener("keyup",this._onKeyUp),this._isPanClick=!1,this.pinchInwards=!0,this._onKeyDown=null,this._onKeyUp=null,this._onMouseMove=null,this._onGestureStart=null,this._onGesture=null,this._MSGestureHandler=null,this._onLostFocus=null,this._onContextMenu=null),t.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])},e.prototype.getTypeName=function(){return"ArcRotateCameraPointersInput"},e.prototype.getSimpleName=function(){return"pointers"},s([t.serialize()],e.prototype,"buttons",void 0),s([t.serialize()],e.prototype,"angularSensibilityX",void 0),s([t.serialize()],e.prototype,"angularSensibilityY",void 0),s([t.serialize()],e.prototype,"pinchPrecision",void 0),s([t.serialize()],e.prototype,"panningSensibility",void 0),e}());t.ArcRotateCameraPointersInput=e,t.CameraInputTypes.ArcRotateCameraPointersInput=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40}return e.prototype.attachControl=function(e,i){var r=this;this._gamepads=new t.Gamepads(function(t){r._onNewGameConnected(t)})},e.prototype.detachControl=function(t){this._gamepads&&this._gamepads.dispose(),this.gamepad=null},e.prototype.checkInputs=function(){if(this.gamepad){var t=this.camera,e=this.gamepad.rightStick;if(0!=e.x){var i=e.x/this.gamepadRotationSensibility;0!=i&&Math.abs(i)>.005&&(t.inertialAlphaOffset+=i)}if(0!=e.y){var r=e.y/this.gamepadRotationSensibility;0!=r&&Math.abs(r)>.005&&(t.inertialBetaOffset+=r)}var n=this.gamepad.leftStick;if(0!=n.y){var s=n.y/this.gamepadMoveSensibility;0!=s&&Math.abs(s)>.005&&(this.camera.inertialRadiusOffset-=s)}}},e.prototype._onNewGameConnected=function(t){0===t.index&&(this.gamepad=t)},e.prototype.getTypeName=function(){return"ArcRotateCameraGamepadInput"},e.prototype.getSimpleName=function(){return"gamepad"},s([t.serialize()],e.prototype,"gamepadRotationSensibility",void 0),s([t.serialize()],e.prototype,"gamepadMoveSensibility",void 0),e}();t.ArcRotateCameraGamepadInput=e,t.CameraInputTypes.ArcRotateCameraGamepadInput=e}(r||(r={}));var r;!function(t){var e=function(){function t(){this.alphaCorrection=1,this.betaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._beta=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}return t.prototype.attachControl=function(t,e){this.camera.attachControl(t,e),window.addEventListener("deviceorientation",this._deviceOrientationHandler)},t.prototype._onOrientationEvent=function(t){this.camera;this._alpha=0|+t.alpha,this._beta=0|+t.beta,this._gamma=0|+t.gamma,this._dirty=!0},t.prototype.checkInputs=function(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)},t.prototype.detachControl=function(t){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},t.prototype.getTypeName=function(){return"ArcRotateCameraVRDeviceOrientationInput"},t.prototype.getSimpleName=function(){return"VRDeviceOrientation"},t}();t.ArcRotateCameraVRDeviceOrientationInput=e,t.CameraInputTypes.ArcRotateCameraVRDeviceOrientationInput=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n){e.call(this,i,r,n),this.cameraDirection=new t.Vector3(0,0,0),this.cameraRotation=new t.Vector2(0,0),this.rotation=new t.Vector3(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.lockedTarget=null,this._currentTarget=t.Vector3.Zero(),this._viewMatrix=t.Matrix.Zero(),this._camMatrix=t.Matrix.Zero(),this._cameraTransformMatrix=t.Matrix.Zero(),this._cameraRotationMatrix=t.Matrix.Zero(),this._referencePoint=new t.Vector3(0,0,1),this._defaultUpVector=new t.Vector3(0,1,0),this._transformedReferencePoint=t.Vector3.Zero(),this._lookAtTemp=t.Matrix.Zero(),this._tempMatrix=t.Matrix.Zero()}return o(i,e),i.prototype.getFrontPosition=function(t){var e=this.getTarget().subtract(this.position);return e.normalize(),e.scaleInPlace(t),this.globalPosition.add(e)},i.prototype._getLockedTargetPosition=function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null},i.prototype._initCache=function(){e.prototype._initCache.call(this),this._cache.lockedTarget=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new t.Quaternion(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.prototype._updateCache=function(t){t||e.prototype._updateCache.call(this);var i=this._getLockedTargetPosition();i?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(i):this._cache.lockedTarget=i.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)},i.prototype._isSynchronizedViewMatrix=function(){if(!e.prototype._isSynchronizedViewMatrix.call(this))return!1;var t=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(t):!t)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))},i.prototype._computeLocalCameraSpeed=function(){var t=this.getEngine();return this.speed*Math.sqrt(t.getDeltaTime()/(100*t.getFps()))},i.prototype.setTarget=function(e){this.upVector.normalize(),t.Matrix.LookAtLHToRef(this.position,e,this._defaultUpVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var i=e.subtract(this.position);i.x>=0?this.rotation.y=-Math.atan(i.z/i.x)+Math.PI/2:this.rotation.y=-Math.atan(i.z/i.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&t.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)},i.prototype.getTarget=function(){return this._currentTarget},i.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},i.prototype._updatePosition=function(){this.position.addInPlace(this.cameraDirection)},i.prototype._checkInputs=function(){var i=this._decideIfNeedsToMove(),r=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(i&&this._updatePosition(),r&&(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,!this.noRotationConstraint)){var n=Math.PI/2*.95;this.rotation.x>n&&(this.rotation.x=n),this.rotation.x<-n&&(this.rotation.x=-n)}i&&(Math.abs(this.cameraDirection.x)<t.Epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<t.Epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<t.Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),r&&(Math.abs(this.cameraRotation.x)<t.Epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<t.Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),e.prototype._checkInputs.call(this)},i.prototype._updateCameraRotationMatrix=function(){this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix),t.Vector3.TransformNormalToRef(this._defaultUpVector,this._cameraRotationMatrix,this.upVector)):t.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)},i.prototype._getViewMatrix=function(){return this.lockedTarget?this._currentTarget.copyFrom(this._getLockedTargetPosition()):(this._updateCameraRotationMatrix(),t.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget)),this.getScene().useRightHandedSystem?t.Matrix.LookAtRHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix):t.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix),this._viewMatrix},i.prototype.createRigCamera=function(e,r){if(this.cameraRigMode!==t.Camera.RIG_MODE_NONE){var n=new i(e,this.position.clone(),this.getScene());return this.cameraRigMode!==t.Camera.RIG_MODE_VR&&this.cameraRigMode!==t.Camera.RIG_MODE_WEBVR||(this.rotationQuaternion||(this.rotationQuaternion=new t.Quaternion),n._cameraRigParams={},n.rotationQuaternion=new t.Quaternion),n}return null},i.prototype._updateRigCameras=function(){var i=this._rigCameras[0],r=this._rigCameras[1];switch(this.cameraRigMode){case t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:var n=this.cameraRigMode===t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*n,i.position),this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*s,r.position),i.setTarget(this.getTarget()),r.setTarget(this.getTarget());break;case t.Camera.RIG_MODE_VR:case t.Camera.RIG_MODE_WEBVR:i.rotationQuaternion?(i.rotationQuaternion.copyFrom(this.rotationQuaternion),r.rotationQuaternion.copyFrom(this.rotationQuaternion)):(i.rotation.copyFrom(this.rotation),r.rotation.copyFrom(this.rotation)),i.position.copyFrom(this.position),r.position.copyFrom(this.position)}e.prototype._updateRigCameras.call(this)},i.prototype._getRigCamPosition=function(e,i){this._rigCamTransformMatrix||(this._rigCamTransformMatrix=new t.Matrix);var r=this.getTarget();t.Matrix.Translation(-r.x,-r.y,-r.z).multiplyToRef(t.Matrix.RotationY(e),this._rigCamTransformMatrix),this._rigCamTransformMatrix=this._rigCamTransformMatrix.multiply(t.Matrix.Translation(r.x,r.y,r.z)),t.Vector3.TransformCoordinatesToRef(this.position,this._rigCamTransformMatrix,i)},i.prototype.getTypeName=function(){return"TargetCamera"},s([t.serializeAsVector3()],i.prototype,"rotation",void 0),s([t.serialize()],i.prototype,"speed",void 0),s([t.serializeAsMeshReference("lockedTargetId")],i.prototype,"lockedTarget",void 0),i}(t.Camera);t.TargetCamera=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n){var s=this;e.call(this,i,r,n),this.ellipsoid=new t.Vector3(.5,1,.5),this.checkCollisions=!1,this.applyGravity=!1,this._collider=new t.Collider,this._needMoveForGravity=!1,this._oldPosition=t.Vector3.Zero(),this._diffPosition=t.Vector3.Zero(),this._newPosition=t.Vector3.Zero(),this._onCollisionPositionChange=function(e,i,r){void 0===r&&(r=null),s.getScene().workerCollisions&&i.multiplyInPlace(s._collider.radius),function(e){s._newPosition.copyFrom(e),s._newPosition.subtractToRef(s._oldPosition,s._diffPosition);s.position.clone();s._diffPosition.length()>t.Engine.CollisionsEpsilon&&(s.position.addInPlace(s._diffPosition),s.onCollide&&r&&s.onCollide(r))}(i)},this.inputs=new t.FreeCameraInputsManager(this),this.inputs.addKeyboard().addMouse()}return o(i,e),Object.defineProperty(i.prototype,"angularSensibility",{get:function(){var t=this.inputs.attached.mouse;if(t)return t.angularSensibility},set:function(t){var e=this.inputs.attached.mouse;e&&(e.angularSensibility=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysUp",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysUp},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysUp=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysDown",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysDown},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysDown=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysLeft",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysLeft},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysLeft=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysRight",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysRight},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysRight=t)},enumerable:!0,configurable:!0}),i.prototype.attachControl=function(t,e){this.inputs.attachElement(t,e)},i.prototype.detachControl=function(e){this.inputs.detachElement(e),this.cameraDirection=new t.Vector3(0,0,0),this.cameraRotation=new t.Vector2(0,0)},i.prototype._collideWithWorld=function(e){var i;i=this.parent?t.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,i.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._collider.radius=this.ellipsoid;var r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),this.getScene().collisionCoordinator.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},i.prototype._checkInputs=function(){this._localDirection||(this._localDirection=t.Vector3.Zero(),this._transformedDirection=t.Vector3.Zero()),this.inputs.checkInputs(),e.prototype._checkInputs.call(this)},i.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},i.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):this.position.addInPlace(this.cameraDirection)},i.prototype.dispose=function(){this.inputs.clear(),e.prototype.dispose.call(this)},i.prototype.getTypeName=function(){return"FreeCamera"},s([t.serializeAsVector3()],i.prototype,"ellipsoid",void 0),s([t.serialize()],i.prototype,"checkCollisions",void 0),s([t.serialize()],i.prototype,"applyGravity",void 0),i}(t.TargetCamera);t.FreeCamera=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t){e.call(this,t)}return o(i,e),i.prototype.addKeyboard=function(){return this.add(new t.FreeCameraKeyboardMoveInput),this},i.prototype.addMouse=function(e){return void 0===e&&(e=!0),this.add(new t.FreeCameraMouseInput(e)),this},i.prototype.addGamepad=function(){return this.add(new t.FreeCameraGamepadInput),this},i.prototype.addDeviceOrientation=function(){return this.add(new t.FreeCameraDeviceOrientationInput),this},i.prototype.addTouch=function(){return this.add(new t.FreeCameraTouchInput),this},i.prototype.addVirtualJoystick=function(){return this.add(new t.FreeCameraVirtualJoystickInput),this},i}(t.CameraInputsManager);t.FreeCameraInputsManager=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r,n){e.call(this,t,i,r),this.radius=12,this.rotationOffset=0,this.heightOffset=4,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=n}return o(i,e),i.prototype.getRadians=function(t){return t*Math.PI/180},i.prototype.follow=function(e){if(e){var i;if(e.rotationQuaternion){var r=new t.Matrix;e.rotationQuaternion.toRotationMatrix(r),i=Math.atan2(r.m[8],r.m[10])}else i=e.rotation.y;var n=this.getRadians(this.rotationOffset)+i,s=e.position.x+Math.sin(n)*this.radius,o=e.position.z+Math.cos(n)*this.radius,a=s-this.position.x,h=e.position.y+this.heightOffset-this.position.y,l=o-this.position.z,c=a*this.cameraAcceleration*2,u=h*this.cameraAcceleration,p=l*this.cameraAcceleration*2;(c>this.maxCameraSpeed||c<-this.maxCameraSpeed)&&(c=c<1?-this.maxCameraSpeed:this.maxCameraSpeed),(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(p>this.maxCameraSpeed||p<-this.maxCameraSpeed)&&(p=p<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new t.Vector3(this.position.x+c,this.position.y+u,this.position.z+p),this.setTarget(e.position)}},i.prototype._checkInputs=function(){e.prototype._checkInputs.call(this),this.follow(this.lockedTarget)},i.prototype.getTypeName=function(){return"FollowCamera"},s([t.serialize()],i.prototype,"radius",void 0),s([t.serialize()],i.prototype,"rotationOffset",void 0),s([t.serialize()],i.prototype,"heightOffset",void 0),s([t.serialize()],i.prototype,"cameraAcceleration",void 0),s([t.serialize()],i.prototype,"maxCameraSpeed",void 0),s([t.serializeAsMeshReference("lockedTargetId")],i.prototype,"lockedTarget",void 0),i}(t.TargetCamera);t.FollowCamera=e;var i=function(e){function i(i,r,n,s,o,a){e.call(this,i,t.Vector3.Zero(),a),this.alpha=r,this.beta=n,this.radius=s,this.target=o,this._cartesianCoordinates=t.Vector3.Zero(),this.follow()}return o(i,e),i.prototype.follow=function(){this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta),this.position=this.target.position.add(this._cartesianCoordinates),this.setTarget(this.target.position)},i.prototype._checkInputs=function(){e.prototype._checkInputs.call(this),this.follow()},i.prototype.getTypeName=function(){return"ArcFollowCamera"},i}(t.TargetCamera);t.ArcFollowCamera=i}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r){t.call(this,e,i,r),this.inputs.addTouch(),this._setupInputs()}return o(e,t),Object.defineProperty(e.prototype,"touchAngularSensibility",{get:function(){var t=this.inputs.attached.touch;if(t)return t.touchAngularSensibility},set:function(t){var e=this.inputs.attached.touch;e&&(e.touchAngularSensibility=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"touchMoveSensibility",{get:function(){var t=this.inputs.attached.touch;if(t)return t.touchMoveSensibility},set:function(t){var e=this.inputs.attached.touch;e&&(e.touchMoveSensibility=t)},enumerable:!0,configurable:!0}),e.prototype.getTypeName=function(){return"TouchCamera"},e.prototype._setupInputs=function(){var t=this.inputs.attached.mouse;t&&(t.touchEnabled=!1)},e}(t.FreeCamera);t.TouchCamera=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a){var h=this;e.call(this,i,t.Vector3.Zero(),a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.zoomOnFactor=1,this.targetScreenOffset=t.Vector2.Zero(),this.allowUpsideDown=!0,this._viewMatrix=new t.Matrix,this.panningAxis=new t.Vector3(1,1,0),this.checkCollisions=!1,this.collisionRadius=new t.Vector3(.5,.5,.5),this._collider=new t.Collider,this._previousPosition=t.Vector3.Zero(),this._collisionVelocity=t.Vector3.Zero(),this._newPosition=t.Vector3.Zero(),this._onCollisionPositionChange=function(e,i,r){void 0===r&&(r=null),h.getScene().workerCollisions&&h.checkCollisions&&i.multiplyInPlace(h._collider.radius),r?(h.setPosition(i),h.onCollide&&h.onCollide(r)):h._previousPosition.copyFrom(h.position);var n=Math.cos(h.alpha),s=Math.sin(h.alpha),o=Math.cos(h.beta),a=Math.sin(h.beta);0===a&&(a=1e-4);var l=h._getTargetPosition();l.addToRef(new t.Vector3(h.radius*n*a,h.radius*o,h.radius*s*a),h._newPosition),h.position.copyFrom(h._newPosition);var c=h.upVector;h.allowUpsideDown&&h.beta<0&&(c=c.clone(),c=c.negate()),t.Matrix.LookAtLHToRef(h.position,l,c,h._viewMatrix),h._viewMatrix.m[12]+=h.targetScreenOffset.x,h._viewMatrix.m[13]+=h.targetScreenOffset.y,h._collisionTriggered=!1},this.target=o?o:t.Vector3.Zero(),this.alpha=r,this.beta=n,this.radius=s,this.getViewMatrix(),this.inputs=new t.ArcRotateCameraInputsManager(this),this.inputs.addKeyboard().addMouseWheel().addPointers().addGamepad()}return o(i,e),Object.defineProperty(i.prototype,"angularSensibilityX",{get:function(){var t=this.inputs.attached.pointers;if(t)return t.angularSensibilityX},set:function(t){var e=this.inputs.attached.pointers;e&&(e.angularSensibilityX=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"angularSensibilityY",{get:function(){var t=this.inputs.attached.pointers;if(t)return t.angularSensibilityY},set:function(t){var e=this.inputs.attached.pointers;e&&(e.angularSensibilityY=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pinchPrecision",{get:function(){var t=this.inputs.attached.pointers;if(t)return t.pinchPrecision},set:function(t){var e=this.inputs.attached.pointers;e&&(e.pinchPrecision=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"panningSensibility",{get:function(){var t=this.inputs.attached.pointers;if(t)return t.panningSensibility},set:function(t){var e=this.inputs.attached.pointers;e&&(e.panningSensibility=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysUp",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysUp},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysUp=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysDown",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysDown},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysDown=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysLeft",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysLeft},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysLeft=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysRight",{get:function(){var t=this.inputs.attached.keyboard;if(t)return t.keysRight},set:function(t){var e=this.inputs.attached.keyboard;e&&(e.keysRight=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"wheelPrecision",{get:function(){var t=this.inputs.attached.mousewheel;if(t)return t.wheelPrecision},set:function(t){var e=this.inputs.attached.mousewheel;e&&(e.wheelPrecision=t)},enumerable:!0,configurable:!0}),i.prototype._initCache=function(){e.prototype._initCache.call(this),this._cache.target=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=t.Vector2.Zero()},i.prototype._updateCache=function(t){t||e.prototype._updateCache.call(this),this._cache.target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)},i.prototype._getTargetPosition=function(){if(this.target.getAbsolutePosition){var t=this.target.getAbsolutePosition();return this._targetBoundingCenter?t.add(this._targetBoundingCenter):t}return this.target},i.prototype._isSynchronizedViewMatrix=function(){return!!e.prototype._isSynchronizedViewMatrix.call(this)&&(this._cache.target.equals(this.target)&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset))},i.prototype.attachControl=function(t,e,i,r){var n=this;void 0===i&&(i=!0),void 0===r&&(r=2),this._useCtrlForPanning=i,this._panningMouseButton=r,this.inputs.attachElement(t,e),this._reset=function(){n.inertialAlphaOffset=0,n.inertialBetaOffset=0,n.inertialRadiusOffset=0}},i.prototype.detachControl=function(t){this.inputs.detachElement(t),this._reset&&this._reset()},i.prototype._checkInputs=function(){this._collisionTriggered||(this.inputs.checkInputs(),0===this.inertialAlphaOffset&&0===this.inertialBetaOffset&&0===this.inertialRadiusOffset||(this.getScene().useRightHandedSystem?this.alpha-=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset:this.alpha+=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<t.Epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<t.Epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<t.Epsilon&&(this.inertialRadiusOffset=0)),0===this.inertialPanningX&&0===this.inertialPanningY||(this._localDirection||(this._localDirection=t.Vector3.Zero(),this._transformedDirection=t.Vector3.Zero()),this.inertialPanningX*=this.inertia,this.inertialPanningY*=this.inertia,Math.abs(this.inertialPanningX)<t.Epsilon&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<t.Epsilon&&(this.inertialPanningY=0),this._localDirection.copyFromFloats(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY),this._localDirection.multiplyInPlace(this.panningAxis),this._viewMatrix.invertToRef(this._cameraTransformMatrix),t.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.panningAxis.y||(this._transformedDirection.y=0),this.target.getAbsolutePosition||this.target.addInPlace(this._transformedDirection)),this._checkLimits(),e.prototype._checkInputs.call(this))},i.prototype._checkLimits=function(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit)},i.prototype.rebuildAnglesAndRadius=function(){var t=this.position.subtract(this._getTargetPosition());this.radius=t.length(),this.alpha=Math.acos(t.x/Math.sqrt(Math.pow(t.x,2)+Math.pow(t.z,2))),t.z<0&&(this.alpha=2*Math.PI-this.alpha),this.beta=Math.acos(t.y/this.radius),this._checkLimits()},i.prototype.setPosition=function(t){this.position.equals(t)||(this.position.copyFrom(t),this.rebuildAnglesAndRadius())},i.prototype.setTarget=function(t,e){void 0===e&&(e=!1),this._getTargetPosition().equals(t)||(e&&t.getBoundingInfo?this._targetBoundingCenter=t.getBoundingInfo().boundingBox.center.clone():this._targetBoundingCenter=null,this.target=t,this.rebuildAnglesAndRadius())},i.prototype._getViewMatrix=function(){var e=Math.cos(this.alpha),i=Math.sin(this.alpha),r=Math.cos(this.beta),n=Math.sin(this.beta);0===n&&(n=1e-4);var s=this._getTargetPosition();if(s.addToRef(new t.Vector3(this.radius*e*n,this.radius*r,this.radius*i*n),this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions)this._collider.radius=this.collisionRadius,this._newPosition.subtractToRef(this.position,this._collisionVelocity),this._collisionTriggered=!0,this.getScene().collisionCoordinator.getNewPosition(this.position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId);else{this.position.copyFrom(this._newPosition);var o=this.upVector;this.allowUpsideDown&&this.beta<0&&(o=o.clone(),o=o.negate()),this.getScene().useRightHandedSystem?t.Matrix.LookAtRHToRef(this.position,s,o,this._viewMatrix):t.Matrix.LookAtLHToRef(this.position,s,o,this._viewMatrix),this._viewMatrix.m[12]+=this.targetScreenOffset.x,this._viewMatrix.m[13]+=this.targetScreenOffset.y}return this._currentTarget=s,this._viewMatrix},i.prototype.zoomOn=function(e,i){void 0===i&&(i=!1),e=e||this.getScene().meshes;var r=t.Mesh.MinMax(e),n=t.Vector3.Distance(r.min,r.max);this.radius=n*this.zoomOnFactor,this.focusOn({min:r.min,max:r.max,distance:n},i)},i.prototype.focusOn=function(e,i){void 0===i&&(i=!1);var r,n;void 0===e.min?(r=e||this.getScene().meshes,r=t.Mesh.MinMax(r),n=t.Vector3.Distance(r.min,r.max)):(r=e,n=e.distance),this.target=t.Mesh.Center(r),i||(this.maxZ=2*n)},i.prototype.createRigCamera=function(e,r){var n;switch(this.cameraRigMode){case t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case t.Camera.RIG_MODE_VR:n=this._cameraRigParams.stereoHalfAngle*(0===r?1:-1);break;case t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:n=this._cameraRigParams.stereoHalfAngle*(0===r?-1:1)}var s=new i(e,this.alpha+n,this.beta,this.radius,this.target,this.getScene());return s._cameraRigParams={},s},i.prototype._updateRigCameras=function(){var i=this._rigCameras[0],r=this._rigCameras[1];switch(i.beta=r.beta=this.beta,i.radius=r.radius=this.radius,this.cameraRigMode){case t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case t.Camera.RIG_MODE_VR:i.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,r.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,r.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}e.prototype._updateRigCameras.call(this)},i.prototype.dispose=function(){this.inputs.clear(),e.prototype.dispose.call(this)},i.prototype.getTypeName=function(){return"ArcRotateCamera"},s([t.serialize()],i.prototype,"alpha",void 0),s([t.serialize()],i.prototype,"beta",void 0),s([t.serialize()],i.prototype,"radius",void 0),s([t.serializeAsVector3()],i.prototype,"target",void 0),s([t.serialize()],i.prototype,"inertialAlphaOffset",void 0),s([t.serialize()],i.prototype,"inertialBetaOffset",void 0),s([t.serialize()],i.prototype,"inertialRadiusOffset",void 0),s([t.serialize()],i.prototype,"lowerAlphaLimit",void 0),s([t.serialize()],i.prototype,"upperAlphaLimit",void 0),s([t.serialize()],i.prototype,"lowerBetaLimit",void 0),s([t.serialize()],i.prototype,"upperBetaLimit",void 0),s([t.serialize()],i.prototype,"lowerRadiusLimit",void 0),s([t.serialize()],i.prototype,"upperRadiusLimit",void 0),s([t.serialize()],i.prototype,"inertialPanningX",void 0),s([t.serialize()],i.prototype,"inertialPanningY",void 0),s([t.serialize()],i.prototype,"zoomOnFactor",void 0),s([t.serialize()],i.prototype,"allowUpsideDown",void 0),i}(t.TargetCamera);t.ArcRotateCamera=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t){e.call(this,t)}return o(i,e),i.prototype.addMouseWheel=function(){return this.add(new t.ArcRotateCameraMouseWheelInput),this},i.prototype.addPointers=function(){return this.add(new t.ArcRotateCameraPointersInput),this},i.prototype.addKeyboard=function(){return this.add(new t.ArcRotateCameraKeyboardMoveInput),this},i.prototype.addGamepad=function(){return this.add(new t.ArcRotateCameraGamepadInput),this},i.prototype.addVRDeviceOrientation=function(){return this.add(new t.ArcRotateCameraVRDeviceOrientationInput),this},i}(t.CameraInputsManager);t.ArcRotateCameraInputsManager=e}(r||(r={}));var r;!function(t){var e=function(){function e(t){this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderinGroupInfo=null,this._scene=t;for(var i=e.MIN_RENDERINGGROUPS;i<e.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]=!0}return e.prototype._renderParticles=function(t,e){if(0!==this._scene._activeParticleSystems.length){var i=this._scene.activeCamera;this._scene._particlesDuration.beginMonitoring();for(var r=0;r<this._scene._activeParticleSystems.length;r++){var n=this._scene._activeParticleSystems.data[r];n.renderingGroupId===t&&0!=(i.layerMask&n.layerMask)&&(this._clearDepthStencilBuffer(),n.emitter.position&&e&&e.indexOf(n.emitter)===-1||this._scene._activeParticles.addCount(n.render(),!1))}this._scene._particlesDuration.endMonitoring(!1)}},e.prototype._renderSprites=function(t){if(this._scene.spritesEnabled&&0!==this._scene.spriteManagers.length){var e=this._scene.activeCamera;this._scene._spritesDuration.beginMonitoring();for(var i=0;i<this._scene.spriteManagers.length;i++){var r=this._scene.spriteManagers[i];r.renderingGroupId===t&&0!=(e.layerMask&r.layerMask)&&(this._clearDepthStencilBuffer(),r.render())}this._scene._spritesDuration.endMonitoring(!1)}},e.prototype._clearDepthStencilBuffer=function(){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(0,!1,!0,!0),this._depthStencilBufferAlreadyCleaned=!0)},e.prototype._renderSpritesAndParticles=function(){this._currentRenderSprites&&this._renderSprites(this._currentIndex),this._currentRenderParticles&&this._renderParticles(this._currentIndex,this._currentActiveMeshes)},e.prototype.render=function(i,r,n,s){var o=this._scene.onRenderingGroupObservable.hasObservers()?this._scene.onRenderingGroupObservable:null,a=null;o&&(this._renderinGroupInfo||(this._renderinGroupInfo=new t.RenderingGroupInfo),a=this._renderinGroupInfo,a.scene=this._scene,a.camera=this._scene.activeCamera),this._currentActiveMeshes=r,this._currentRenderParticles=n,this._currentRenderSprites=s;for(var h=e.MIN_RENDERINGGROUPS;h<e.MAX_RENDERINGGROUPS;h++){this._depthStencilBufferAlreadyCleaned=h===e.MIN_RENDERINGGROUPS;var l=this._renderingGroups[h],c=!1;if(this._currentIndex=h,l){var u=0;o&&(u=Math.pow(2,h),a.renderStage=t.RenderingGroupInfo.STAGE_PRECLEAR,a.renderingGroupId=h,o.notifyObservers(a,u)),this._autoClearDepthStencil[h]&&this._clearDepthStencilBuffer(),o&&(a.renderStage=t.RenderingGroupInfo.STAGE_PREOPAQUE,o.notifyObservers(a,u)),l.onBeforeTransparentRendering||(l.onBeforeTransparentRendering=this._renderSpritesAndParticles.bind(this)),o&&(a.renderStage=t.RenderingGroupInfo.STAGE_PRETRANSPARENT,o.notifyObservers(a,u)),l.render(i)||(this._renderingGroups.splice(h,1),c=!0,this._renderSpritesAndParticles()),o&&(a.renderStage=t.RenderingGroupInfo.STAGE_POSTTRANSPARENT,o.notifyObservers(a,u))}else if(this._renderSpritesAndParticles(),o){var u=Math.pow(2,h);a.renderStage=t.RenderingGroupInfo.STAGE_PRECLEAR,a.renderingGroupId=h,o.notifyObservers(a,u),a.renderStage=t.RenderingGroupInfo.STAGE_POSTTRANSPARENT,o.notifyObservers(a,u)}c&&h--}},e.prototype.reset=function(){for(var t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){var i=this._renderingGroups[t];i&&i.prepare()}},e.prototype.dispatch=function(e){var i=e.getMesh(),r=i.renderingGroupId||0;this._renderingGroups[r]||(this._renderingGroups[r]=new t.RenderingGroup(r,this._scene,this._customOpaqueSortCompareFn[r],this._customAlphaTestSortCompareFn[r],this._customTransparentSortCompareFn[r])),this._renderingGroups[r].dispatch(e)},e.prototype.setRenderingOrder=function(t,e,i,r){if(void 0===e&&(e=null),void 0===i&&(i=null),void 0===r&&(r=null),this._customOpaqueSortCompareFn[t]=e,this._customAlphaTestSortCompareFn[t]=i,this._customTransparentSortCompareFn[t]=r,this._renderingGroups[t]){var n=this._renderingGroups[t];n.opaqueSortCompareFn=this._customOpaqueSortCompareFn[t],n.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[t],n.transparentSortCompareFn=this._customTransparentSortCompareFn[t]}},e.prototype.setRenderingAutoClearDepthStencil=function(t,e){this._autoClearDepthStencil[t]=e},e.MAX_RENDERINGGROUPS=4,e.MIN_RENDERINGGROUPS=0,e}();t.RenderingManager=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s){void 0===r&&(r=null),void 0===n&&(n=null),void 0===s&&(s=null),this.index=e,this._opaqueSubMeshes=new t.SmartArray(256),this._transparentSubMeshes=new t.SmartArray(256),this._alphaTestSubMeshes=new t.SmartArray(256),this._scene=i,this.opaqueSortCompareFn=r,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=s}return Object.defineProperty(e.prototype,"opaqueSortCompareFn",{set:function(t){this._opaqueSortCompareFn=t,this._renderOpaque=t?this.renderOpaqueSorted:e.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alphaTestSortCompareFn",{set:function(t){this._alphaTestSortCompareFn=t,this._renderAlphaTest=t?this.renderAlphaTestSorted:e.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transparentSortCompareFn",{set:function(t){this._transparentSortCompareFn=t?t:e.defaultTransparentSortCompare,this._renderTransparent=this.renderTransparentSorted},enumerable:!0,configurable:!0}),e.prototype.render=function(e){if(e)return e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes),!0;if(0===this._opaqueSubMeshes.length&&0===this._alphaTestSubMeshes.length&&0===this._transparentSubMeshes.length)return this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),!1;var i=this._scene.getEngine();return this._renderOpaque(this._opaqueSubMeshes),i.setAlphaTesting(!0),this._renderAlphaTest(this._alphaTestSubMeshes),i.setAlphaTesting(!1),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._renderTransparent(this._transparentSubMeshes),i.setAlphaMode(t.Engine.ALPHA_DISABLE),!0},e.prototype.renderOpaqueSorted=function(t){return e.renderSorted(t,this._opaqueSortCompareFn,this._scene.activeCamera.globalPosition,!1)},e.prototype.renderAlphaTestSorted=function(t){return e.renderSorted(t,this._alphaTestSortCompareFn,this._scene.activeCamera.globalPosition,!1)},e.prototype.renderTransparentSorted=function(t){return e.renderSorted(t,this._transparentSortCompareFn,this._scene.activeCamera.globalPosition,!0)},e.renderSorted=function(t,e,i,r){for(var n,s=0;s<t.length;s++)n=t.data[s],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=n.getBoundingInfo().boundingSphere.centerWorld.subtract(i).length();var o=t.data.slice(0,t.length);for(o.sort(e),s=0;s<o.length;s++)n=o[s],n.render(r)},e.renderUnsorted=function(t){for(var e=0;e<t.length;e++){t.data[e].render(!1)}},e.defaultTransparentSortCompare=function(t,i){return t._alphaIndex>i._alphaIndex?1:t._alphaIndex<i._alphaIndex?-1:e.backToFrontSortCompare(t,i)},e.backToFrontSortCompare=function(t,e){return t._distanceToCamera<e._distanceToCamera?1:t._distanceToCamera>e._distanceToCamera?-1:0},e.frontToBackSortCompare=function(t,e){return t._distanceToCamera<e._distanceToCamera?-1:t._distanceToCamera>e._distanceToCamera?1:0},e.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset()},e.prototype.dispatch=function(t){var e=t.getMaterial(),i=t.getMesh();e.needAlphaBlending()||i.visibility<1||i.hasVertexAlpha?this._transparentSubMeshes.push(t):e.needAlphaTesting()?this._alphaTestSubMeshes.push(t):this._opaqueSubMeshes.push(t)},e}();t.RenderingGroup=e}(r||(r={}));var r;!function(t){var e=function(){function t(){}return Object.defineProperty(t,"POINTERDOWN",{get:function(){return t._POINTERDOWN},enumerable:!0,configurable:!0}),Object.defineProperty(t,"POINTERUP",{get:function(){return t._POINTERUP},enumerable:!0,configurable:!0}),Object.defineProperty(t,"POINTERMOVE",{get:function(){return t._POINTERMOVE},enumerable:!0,configurable:!0}),Object.defineProperty(t,"POINTERWHEEL",{get:function(){return t._POINTERWHEEL},enumerable:!0,configurable:!0}),Object.defineProperty(t,"POINTERPICK",{get:function(){return t._POINTERPICK},enumerable:!0,configurable:!0}),t._POINTERDOWN=1,t._POINTERUP=2,t._POINTERMOVE=4,t._POINTERWHEEL=8,t._POINTERPICK=16,t}();t.PointerEventTypes=e;var i=function(){function t(t,e){this.type=t,this.event=e}return t}();t.PointerInfoBase=i;var r=function(e){function i(i,r,n,s){e.call(this,i,r),this.skipOnPointerObservable=!1,this.localPosition=new t.Vector2(n,s)}return o(i,e),i}(i);t.PointerInfoPre=r;var n=function(t){function e(e,i,r){t.call(this,e,i),this.pickInfo=r}return o(e,t),e}(i);t.PointerInfo=n;var s=function(){function t(){}return t.STAGE_PRECLEAR=1,t.STAGE_PREOPAQUE=2,t.STAGE_PRETRANSPARENT=3,t.STAGE_POSTTRANSPARENT=4,t}();t.RenderingGroupInfo=s;var a=function(){function i(e){this.autoClear=!0,this.clearColor=new t.Color3(.2,.2,.3),this.ambientColor=new t.Color3(0,0,0),this.forceWireframe=!1,this.forcePointsCloud=!1,this.forceShowBoundingBoxes=!1,this.animationsEnabled=!0,this.constantlyUpdateMeshUnderPointer=!1,this.useRightHandedSystem=!1,this.hoverCursor="pointer",this.metadata=null,this.onDisposeObservable=new t.Observable,this.onBeforeRenderObservable=new t.Observable,this.onAfterRenderObservable=new t.Observable,this.onReadyObservable=new t.Observable,this.onBeforeCameraRenderObservable=new t.Observable,this.onAfterCameraRenderObservable=new t.Observable,this.onNewCameraAddedObservable=new t.Observable,this.onCameraRemovedObservable=new t.Observable,this.onNewLightAddedObservable=new t.Observable,this.onLightRemovedObservable=new t.Observable,this.onNewGeometryAddedObservable=new t.Observable,this.onGeometryRemovedObservable=new t.Observable,this.onNewMeshAddedObservable=new t.Observable,this.onMeshRemovedObservable=new t.Observable,this.onRenderingGroupObservable=new t.Observable,this.animations=[],this.onPrePointerObservable=new t.Observable,this.onPointerObservable=new t.Observable,this.cameraToUseForPointers=null,this._startingPointerPosition=new t.Vector2(0,0),this._startingPointerTime=0,this.fogEnabled=!0,this.fogMode=i.FOGMODE_NONE,this.fogColor=new t.Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.shadowsEnabled=!0,this.lightsEnabled=!0,this.lights=new Array,this.cameras=new Array,this.activeCameras=new Array,this.meshes=new Array,this._geometries=new Array,this.materials=new Array,this.multiMaterials=new Array,this.texturesEnabled=!0,this.textures=new Array,this.particlesEnabled=!0,this.particleSystems=new Array,this.spritesEnabled=!0,this.spriteManagers=new Array,this.layers=new Array,this.highlightLayers=new Array,this.skeletonsEnabled=!0,this.skeletons=new Array,this.lensFlaresEnabled=!0,this.lensFlareSystems=new Array,this.collisionsEnabled=!0,this.gravity=new t.Vector3(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this.reflectionProbes=new Array,this._actionManagers=new Array,this._meshesForIntersections=new t.SmartArray(256),this.proceduralTexturesEnabled=!0,this._proceduralTextures=new Array,this.soundTracks=new Array,this._audioEnabled=!0,this._headphone=!1,this._totalMeshesCounter=new t.PerfCounter,this._totalLightsCounter=new t.PerfCounter,this._totalMaterialsCounter=new t.PerfCounter,this._totalTexturesCounter=new t.PerfCounter,this._totalVertices=new t.PerfCounter,this._activeIndices=new t.PerfCounter,this._activeParticles=new t.PerfCounter,this._lastFrameDuration=new t.PerfCounter,this._evaluateActiveMeshesDuration=new t.PerfCounter,this._renderTargetsDuration=new t.PerfCounter,this._particlesDuration=new t.PerfCounter,this._renderDuration=new t.PerfCounter,this._spritesDuration=new t.PerfCounter,this._activeBones=new t.PerfCounter,this._renderId=0,this._executeWhenReadyTimeoutId=-1,this._intermediateRendering=!1,this._toBeDisposed=new t.SmartArray(256),this._pendingData=[],this._activeMeshes=new t.SmartArray(256),this._processedMaterials=new t.SmartArray(256),this._renderTargets=new t.SmartArray(256),this._activeParticleSystems=new t.SmartArray(256),this._activeSkeletons=new t.SmartArray(32),this._softwareSkinnedMeshes=new t.SmartArray(32),this._activeAnimatables=new Array,this._transformMatrix=t.Matrix.Zero(),this._edgesRenderers=new t.SmartArray(16),this._uniqueIdCounter=0,this._engine=e,e.scenes.push(this),this._externalData=new t.StringDictionary,this._uid=null,this._renderingManager=new t.RenderingManager(this),this.postProcessManager=new t.PostProcessManager(this),this.postProcessRenderPipelineManager=new t.PostProcessRenderPipelineManager,this._boundingBoxRenderer=new t.BoundingBoxRenderer(this),t.OutlineRenderer&&(this._outlineRenderer=new t.OutlineRenderer(this)),this.attachControl(),t.SoundTrack&&(this.mainSoundTrack=new t.SoundTrack(this,{mainTrack:!0})),t.SimplificationQueue&&(this.simplificationQueue=new t.SimplificationQueue),this.workerCollisions=!1}return Object.defineProperty(i,"FOGMODE_NONE",{get:function(){return i._FOGMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOGMODE_EXP",{get:function(){return i._FOGMODE_EXP},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOGMODE_EXP2",{get:function(){return i._FOGMODE_EXP2},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOGMODE_LINEAR",{get:function(){return i._FOGMODE_LINEAR},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"beforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"afterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"beforeCameraRender",{set:function(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"afterCameraRender",{set:function(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"unTranslatedPointer",{get:function(){return new t.Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"defaultMaterial",{get:function(){return this._defaultMaterial||(this._defaultMaterial=new t.StandardMaterial("default material",this)),this._defaultMaterial},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new t.DebugLayer(this)),this._debugLayer},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"workerCollisions",{get:function(){return this._workerCollisions},set:function(e){e=e&&!!Worker,this._workerCollisions=e,this.collisionCoordinator&&this.collisionCoordinator.destroy(),this.collisionCoordinator=e?new t.CollisionCoordinatorWorker:new t.CollisionCoordinatorLegacy,this.collisionCoordinator.init(this)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"SelectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:!0,configurable:!0}),i.prototype.getCachedMaterial=function(){return this._cachedMaterial},i.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer},i.prototype.getOutlineRenderer=function(){return this._outlineRenderer},i.prototype.getEngine=function(){return this._engine},i.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(i.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:!0,configurable:!0}),i.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(i.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:!0,configurable:!0}),i.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(i.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:!0,configurable:!0}),i.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(i.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:!0,configurable:!0}),i.prototype.getLastFrameDuration=function(){return this._lastFrameDuration.current},Object.defineProperty(i.prototype,"lastFramePerfCounter",{get:function(){return this._lastFrameDuration},enumerable:!0,configurable:!0}),i.prototype.getEvaluateActiveMeshesDuration=function(){return this._evaluateActiveMeshesDuration.current},Object.defineProperty(i.prototype,"evaluateActiveMeshesDurationPerfCounter",{get:function(){return this._evaluateActiveMeshesDuration},enumerable:!0,configurable:!0}),i.prototype.getActiveMeshes=function(){return this._activeMeshes},i.prototype.getRenderTargetsDuration=function(){return this._renderTargetsDuration.current},i.prototype.getRenderDuration=function(){return this._renderDuration.current},Object.defineProperty(i.prototype,"renderDurationPerfCounter",{get:function(){return this._renderDuration},enumerable:!0,configurable:!0}),i.prototype.getParticlesDuration=function(){return this._particlesDuration.current},Object.defineProperty(i.prototype,"particlesDurationPerfCounter",{get:function(){return this._particlesDuration},enumerable:!0,configurable:!0}),i.prototype.getSpritesDuration=function(){return this._spritesDuration.current},Object.defineProperty(i.prototype,"spriteDuractionPerfCounter",{get:function(){return this._spritesDuration},enumerable:!0,configurable:!0}),i.prototype.getAnimationRatio=function(){return this._animationRatio},i.prototype.getRenderId=function(){return this._renderId},i.prototype.incrementRenderId=function(){this._renderId++},i.prototype._updatePointerPosition=function(t){var e=this._engine.getRenderingCanvasClientRect();this._pointerX=t.clientX-e.left,this._pointerY=t.clientY-e.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY,this.cameraToUseForPointers&&(this._pointerX=this._pointerX-this.cameraToUseForPointers.viewport.x*this._engine.getRenderWidth(),this._pointerY=this._pointerY-this.cameraToUseForPointers.viewport.y*this._engine.getRenderHeight())},i.prototype.attachControl=function(i,s,o){var a=this;void 0===i&&(i=!0),void 0===s&&(s=!0),void 0===o&&(o=!0);var h=function(t){return t.isPickable&&t.actionManager&&t.actionManager.hasPointerTriggers};this._onPointerMove=function(t){if(a._updatePointerPosition(t),a.onPrePointerObservable.hasObservers()){var i="mousewheel"===t.type||"DOMMouseScroll"===t.type?e.POINTERWHEEL:e.POINTERMOVE,s=new r(i,t,a._unTranslatedPointerX,a._unTranslatedPointerY);if(a.onPrePointerObservable.notifyObservers(s,i),s.skipOnPointerObservable)return}if(a.cameraToUseForPointers||a.activeCamera){var o=a._engine.getRenderingCanvas();a.pointerMovePredicate||(a.pointerMovePredicate=function(t){return t.isPickable&&t.isVisible&&t.isReady()&&(a.constantlyUpdateMeshUnderPointer||null!==t.actionManager&&void 0!==t.actionManager)});var l=a.pick(a._unTranslatedPointerX,a._unTranslatedPointerY,a.pointerMovePredicate,!1,a.cameraToUseForPointers);if(l.hit&&l.pickedMesh?(a.setPointerOverSprite(null),a.setPointerOverMesh(l.pickedMesh),a._pointerOverMesh.actionManager&&a._pointerOverMesh.actionManager.hasPointerTriggers?a._pointerOverMesh.actionManager.hoverCursor?o.style.cursor=a._pointerOverMesh.actionManager.hoverCursor:o.style.cursor=a.hoverCursor:o.style.cursor=""):(a.setPointerOverMesh(null),l=a.pickSprite(a._unTranslatedPointerX,a._unTranslatedPointerY,h,!1,a.cameraToUseForPointers),l.hit&&l.pickedSprite?(a.setPointerOverSprite(l.pickedSprite),a._pointerOverSprite.actionManager&&a._pointerOverSprite.actionManager.hoverCursor?o.style.cursor=a._pointerOverSprite.actionManager.hoverCursor:o.style.cursor=a.hoverCursor):(a.setPointerOverSprite(null),o.style.cursor="")),a.onPointerMove&&a.onPointerMove(t,l),a.onPointerObservable.hasObservers()){var i="mousewheel"===t.type||"DOMMouseScroll"===t.type?e.POINTERWHEEL:e.POINTERMOVE,s=new n(i,t,l);a.onPointerObservable.notifyObservers(s,i)}}},this._onPointerDown=function(i){if(a._updatePointerPosition(i),a.onPrePointerObservable.hasObservers()){var s=e.POINTERDOWN,o=new r(s,i,a._unTranslatedPointerX,a._unTranslatedPointerY);if(a.onPrePointerObservable.notifyObservers(o,s),o.skipOnPointerObservable)return}if(a.cameraToUseForPointers||a.activeCamera){a._startingPointerPosition.x=a._pointerX,a._startingPointerPosition.y=a._pointerY,a._startingPointerTime=(new Date).getTime(),a.pointerDownPredicate||(a.pointerDownPredicate=function(t){return t.isPickable&&t.isVisible&&t.isReady()}),a._pickedDownMesh=null;var l=a.pick(a._unTranslatedPointerX,a._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers);if(l.hit&&l.pickedMesh&&l.pickedMesh.actionManager){if(a._pickedDownMesh=l.pickedMesh,l.pickedMesh.actionManager.hasPickTriggers){switch(i.button){case 0:l.pickedMesh.actionManager.processTrigger(t.ActionManager.OnLeftPickTrigger,t.ActionEvent.CreateNew(l.pickedMesh,i));break;case 1:l.pickedMesh.actionManager.processTrigger(t.ActionManager.OnCenterPickTrigger,t.ActionEvent.CreateNew(l.pickedMesh,i));break;case 2:l.pickedMesh.actionManager.processTrigger(t.ActionManager.OnRightPickTrigger,t.ActionEvent.CreateNew(l.pickedMesh,i))}l.pickedMesh.actionManager&&l.pickedMesh.actionManager.processTrigger(t.ActionManager.OnPickDownTrigger,t.ActionEvent.CreateNew(l.pickedMesh,i))}if(l.pickedMesh.actionManager&&l.pickedMesh.actionManager.hasSpecificTrigger(t.ActionManager.OnLongPressTrigger)){var c=a;window.setTimeout(function(){var e=c.pick(c._unTranslatedPointerX,c._unTranslatedPointerY,function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(t.ActionManager.OnLongPressTrigger)},!1,c.cameraToUseForPointers);e.hit&&e.pickedMesh&&e.pickedMesh.actionManager&&0!==c._startingPointerTime&&(new Date).getTime()-c._startingPointerTime>t.ActionManager.LongPressDelay&&Math.abs(c._startingPointerPosition.x-c._pointerX)<t.ActionManager.DragMovementThreshold&&Math.abs(c._startingPointerPosition.y-c._pointerY)<t.ActionManager.DragMovementThreshold&&(c._startingPointerTime=0,e.pickedMesh.actionManager.processTrigger(t.ActionManager.OnLongPressTrigger,t.ActionEvent.CreateNew(e.pickedMesh,i)))},t.ActionManager.LongPressDelay)}}if(a.onPointerDown&&a.onPointerDown(i,l),a.onPointerObservable.hasObservers()){var s=e.POINTERDOWN,o=new n(s,i,l);a.onPointerObservable.notifyObservers(o,s)}if(a._pickedDownSprite=null,a.spriteManagers.length>0&&(l=a.pickSprite(a._unTranslatedPointerX,a._unTranslatedPointerY,h,!1,a.cameraToUseForPointers),l.hit&&l.pickedSprite&&l.pickedSprite.actionManager)){switch(a._pickedDownSprite=l.pickedSprite,i.button){case 0:l.pickedSprite.actionManager.processTrigger(t.ActionManager.OnLeftPickTrigger,t.ActionEvent.CreateNewFromSprite(l.pickedSprite,a,i));break;case 1:l.pickedSprite.actionManager.processTrigger(t.ActionManager.OnCenterPickTrigger,t.ActionEvent.CreateNewFromSprite(l.pickedSprite,a,i));break;case 2:l.pickedSprite.actionManager.processTrigger(t.ActionManager.OnRightPickTrigger,t.ActionEvent.CreateNewFromSprite(l.pickedSprite,a,i))}l.pickedSprite.actionManager&&l.pickedSprite.actionManager.processTrigger(t.ActionManager.OnPickDownTrigger,t.ActionEvent.CreateNewFromSprite(l.pickedSprite,a,i))}}},this._onPointerUp=function(i){if(a._updatePointerPosition(i),a.onPrePointerObservable.hasObservers()){var s=e.POINTERUP,o=new r(s,i,a._unTranslatedPointerX,a._unTranslatedPointerY);if(a.onPrePointerObservable.notifyObservers(o,s),o.skipOnPointerObservable)return}if(a.cameraToUseForPointers||a.activeCamera){a.pointerUpPredicate||(a.pointerUpPredicate=function(t){return t.isPickable&&t.isVisible&&t.isReady()});var l=a.pick(a._unTranslatedPointerX,a._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);if(l.hit&&l.pickedMesh){if(null!=a._pickedDownMesh&&l.pickedMesh==a._pickedDownMesh&&(a.onPointerPick&&a.onPointerPick(i,l),a.onPointerObservable.hasObservers())){var s=e.POINTERPICK,o=new n(s,i,l);a.onPointerObservable.notifyObservers(o,s)}l.pickedMesh.actionManager&&(l.pickedMesh.actionManager.processTrigger(t.ActionManager.OnPickUpTrigger,t.ActionEvent.CreateNew(l.pickedMesh,i)),l.pickedMesh.actionManager&&Math.abs(a._startingPointerPosition.x-a._pointerX)<t.ActionManager.DragMovementThreshold&&Math.abs(a._startingPointerPosition.y-a._pointerY)<t.ActionManager.DragMovementThreshold&&l.pickedMesh.actionManager.processTrigger(t.ActionManager.OnPickTrigger,t.ActionEvent.CreateNew(l.pickedMesh,i)))}if(a._pickedDownMesh&&a._pickedDownMesh.actionManager&&a._pickedDownMesh!==l.pickedMesh&&a._pickedDownMesh.actionManager.processTrigger(t.ActionManager.OnPickOutTrigger,t.ActionEvent.CreateNew(a._pickedDownMesh,i)),a.onPointerUp&&a.onPointerUp(i,l),a.onPointerObservable.hasObservers()){var s=e.POINTERUP,o=new n(s,i,l);a.onPointerObservable.notifyObservers(o,s)}a._startingPointerTime=0,a.spriteManagers.length>0&&(l=a.pickSprite(a._unTranslatedPointerX,a._unTranslatedPointerY,h,!1,a.cameraToUseForPointers),l.hit&&l.pickedSprite&&l.pickedSprite.actionManager&&(l.pickedSprite.actionManager.processTrigger(t.ActionManager.OnPickUpTrigger,t.ActionEvent.CreateNewFromSprite(l.pickedSprite,a,i)),l.pickedSprite.actionManager&&Math.abs(a._startingPointerPosition.x-a._pointerX)<t.ActionManager.DragMovementThreshold&&Math.abs(a._startingPointerPosition.y-a._pointerY)<t.ActionManager.DragMovementThreshold&&l.pickedSprite.actionManager.processTrigger(t.ActionManager.OnPickTrigger,t.ActionEvent.CreateNewFromSprite(l.pickedSprite,a,i))),a._pickedDownSprite&&a._pickedDownSprite.actionManager&&a._pickedDownSprite!==l.pickedSprite&&a._pickedDownSprite.actionManager.processTrigger(t.ActionManager.OnPickOutTrigger,t.ActionEvent.CreateNewFromSprite(a._pickedDownSprite,a,i)))}},this._onKeyDown=function(e){a.actionManager&&a.actionManager.processTrigger(t.ActionManager.OnKeyDownTrigger,t.ActionEvent.CreateNewFromScene(a,e))},this._onKeyUp=function(e){a.actionManager&&a.actionManager.processTrigger(t.ActionManager.OnKeyUpTrigger,t.ActionEvent.CreateNewFromScene(a,e))};var l=t.Tools.GetPointerPrefix(),c=this._engine.getRenderingCanvas();o&&(c.addEventListener(l+"move",this._onPointerMove,!1),c.addEventListener("mousewheel",this._onPointerMove,!1),c.addEventListener("DOMMouseScroll",this._onPointerMove,!1)),s&&c.addEventListener(l+"down",this._onPointerDown,!1),i&&c.addEventListener(l+"up",this._onPointerUp,!1),c.tabIndex=1,c.addEventListener("keydown",this._onKeyDown,!1),c.addEventListener("keyup",this._onKeyUp,!1)},i.prototype.detachControl=function(){var e=t.Tools.GetPointerPrefix(),i=this._engine.getRenderingCanvas();i.removeEventListener(e+"move",this._onPointerMove),i.removeEventListener(e+"down",this._onPointerDown),i.removeEventListener(e+"up",this._onPointerUp),i.removeEventListener("mousewheel",this._onPointerMove),i.removeEventListener("DOMMouseScroll",this._onPointerMove),i.removeEventListener("keydown",this._onKeyDown),i.removeEventListener("keyup",this._onKeyUp)},i.prototype.isReady=function(){if(this._pendingData.length>0)return!1;var e;for(e=0;e<this._geometries.length;e++){if(this._geometries[e].delayLoadState===t.Engine.DELAYLOADSTATE_LOADING)return!1}for(e=0;e<this.meshes.length;e++){var i=this.meshes[e];if(!i.isReady())return!1;var r=i.material;if(r&&!r.isReady(i))return!1}return!0},i.prototype.resetCachedMaterial=function(){this._cachedMaterial=null},i.prototype.registerBeforeRender=function(t){this.onBeforeRenderObservable.add(t)},i.prototype.unregisterBeforeRender=function(t){this.onBeforeRenderObservable.removeCallback(t)},i.prototype.registerAfterRender=function(t){this.onAfterRenderObservable.add(t)},i.prototype.unregisterAfterRender=function(t){this.onAfterRenderObservable.removeCallback(t)},i.prototype._addPendingData=function(t){this._pendingData.push(t)},i.prototype._removePendingData=function(t){var e=this._pendingData.indexOf(t);e!==-1&&this._pendingData.splice(e,1)},i.prototype.getWaitingItemsCount=function(){return this._pendingData.length},i.prototype.executeWhenReady=function(t){var e=this;this.onReadyObservable.add(t),this._executeWhenReadyTimeoutId===-1&&(this._executeWhenReadyTimeoutId=setTimeout(function(){e._checkIsReady()},150))},i.prototype._checkIsReady=function(){var t=this;if(this.isReady())return this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=-1);this._executeWhenReadyTimeoutId=setTimeout(function(){t._checkIsReady()},150)},i.prototype.beginAnimation=function(e,i,r,n,s,o,a){if(void 0===s&&(s=1),this.stopAnimation(e),a||(a=new t.Animatable(this,e,i,r,n,s,o)),e.animations&&a.appendAnimations(e,e.animations),e.getAnimatables)for(var h=e.getAnimatables(),l=0;l<h.length;l++)this.beginAnimation(h[l],i,r,n,s,o,a);return a.reset(),a},i.prototype.beginDirectAnimation=function(e,i,r,n,s,o,a){return void 0===o&&(o=1),new t.Animatable(this,e,r,n,s,o,a,i)},i.prototype.getAnimatableByTarget=function(t){for(var e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===t)return this._activeAnimatables[e];return null},Object.defineProperty(i.prototype,"Animatables",{get:function(){return this._activeAnimatables},enumerable:!0,configurable:!0}),i.prototype.stopAnimation=function(t,e){var i=this.getAnimatableByTarget(t);i&&i.stop(e)},i.prototype._animate=function(){if(this.animationsEnabled&&0!==this._activeAnimatables.length){if(!this._animationStartDate){if(this._pendingData.length>0)return;this._animationStartDate=t.Tools.Now}for(var e=t.Tools.Now,i=e-this._animationStartDate,r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r]._animate(i)}},i.prototype.getViewMatrix=function(){return this._viewMatrix},i.prototype.getProjectionMatrix=function(){return this._projectionMatrix},i.prototype.getTransformMatrix=function(){return this._transformMatrix},i.prototype.setTransformMatrix=function(e,i){this._viewMatrix=e,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?t.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=t.Frustum.GetPlanes(this._transformMatrix)},i.prototype.addMesh=function(t){t.uniqueId=this._uniqueIdCounter++;this.meshes.push(t);this.collisionCoordinator.onMeshAdded(t),this.onNewMeshAddedObservable.notifyObservers(t)},i.prototype.removeMesh=function(t){var e=this.meshes.indexOf(t);return e!==-1&&this.meshes.splice(e,1),this.collisionCoordinator.onMeshRemoved(t),this.onMeshRemovedObservable.notifyObservers(t),e},i.prototype.removeSkeleton=function(t){var e=this.skeletons.indexOf(t);return e!==-1&&this.skeletons.splice(e,1),e},i.prototype.removeLight=function(t){var e=this.lights.indexOf(t);return e!==-1&&this.lights.splice(e,1),this.onLightRemovedObservable.notifyObservers(t),e},i.prototype.removeCamera=function(t){var e=this.cameras.indexOf(t);e!==-1&&this.cameras.splice(e,1);var i=this.activeCameras.indexOf(t);return i!==-1&&this.activeCameras.splice(i,1),this.activeCamera===t&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(t),e},i.prototype.addLight=function(t){t.uniqueId=this._uniqueIdCounter++;this.lights.push(t);this.onNewLightAddedObservable.notifyObservers(t)},i.prototype.addCamera=function(t){t.uniqueId=this._uniqueIdCounter++;this.cameras.push(t);this.onNewCameraAddedObservable.notifyObservers(t)},i.prototype.switchActiveCamera=function(t,e){void 0===e&&(e=!0);var i=this._engine.getRenderingCanvas();this.activeCamera.detachControl(i),this.activeCamera=t,e&&t.attachControl(i)},i.prototype.setActiveCameraByID=function(t){var e=this.getCameraByID(t);return e?(this.activeCamera=e,e):null},i.prototype.setActiveCameraByName=function(t){var e=this.getCameraByName(t);return e?(this.activeCamera=e,e):null},i.prototype.getMaterialByID=function(t){for(var e=0;e<this.materials.length;e++)if(this.materials[e].id===t)return this.materials[e];return null},i.prototype.getMaterialByName=function(t){for(var e=0;e<this.materials.length;e++)if(this.materials[e].name===t)return this.materials[e];return null},i.prototype.getLensFlareSystemByName=function(t){for(var e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===t)return this.lensFlareSystems[e];return null},i.prototype.getLensFlareSystemByID=function(t){for(var e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===t)return this.lensFlareSystems[e];return null},i.prototype.getCameraByID=function(t){for(var e=0;e<this.cameras.length;e++)if(this.cameras[e].id===t)return this.cameras[e];return null},i.prototype.getCameraByUniqueID=function(t){for(var e=0;e<this.cameras.length;e++)if(this.cameras[e].uniqueId===t)return this.cameras[e];return null},i.prototype.getCameraByName=function(t){for(var e=0;e<this.cameras.length;e++)if(this.cameras[e].name===t)return this.cameras[e];return null},i.prototype.getBoneByID=function(t){for(var e=0;e<this.skeletons.length;e++)for(var i=this.skeletons[e],r=0;r<i.bones.length;r++)if(i.bones[r].id===t)return i.bones[r];return null},i.prototype.getBoneByName=function(t){for(var e=0;e<this.skeletons.length;e++)for(var i=this.skeletons[e],r=0;r<i.bones.length;r++)if(i.bones[r].name===t)return i.bones[r];return null},i.prototype.getLightByName=function(t){for(var e=0;e<this.lights.length;e++)if(this.lights[e].name===t)return this.lights[e];return null},i.prototype.getLightByID=function(t){for(var e=0;e<this.lights.length;e++)if(this.lights[e].id===t)return this.lights[e];return null},i.prototype.getLightByUniqueID=function(t){for(var e=0;e<this.lights.length;e++)if(this.lights[e].uniqueId===t)return this.lights[e];return null},i.prototype.getParticleSystemByID=function(t){for(var e=0;e<this.particleSystems.length;e++)if(this.particleSystems[e].id===t)return this.particleSystems[e];return null},i.prototype.getGeometryByID=function(t){for(var e=0;e<this._geometries.length;e++)if(this._geometries[e].id===t)return this._geometries[e];return null},i.prototype.pushGeometry=function(t,e){return!(!e&&this.getGeometryByID(t.id))&&(this._geometries.push(t),this.collisionCoordinator.onGeometryAdded(t),this.onNewGeometryAddedObservable.notifyObservers(t),!0)},i.prototype.removeGeometry=function(t){var e=this._geometries.indexOf(t);return e>-1&&(this._geometries.splice(e,1),this.collisionCoordinator.onGeometryDeleted(t),this.onGeometryRemovedObservable.notifyObservers(t),!0)},i.prototype.getGeometries=function(){return this._geometries},i.prototype.getMeshByID=function(t){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].id===t)return this.meshes[e];return null},i.prototype.getMeshesByID=function(t){return this.meshes.filter(function(e){return e.id===t})},i.prototype.getMeshByUniqueID=function(t){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].uniqueId===t)return this.meshes[e];return null},i.prototype.getLastMeshByID=function(t){for(var e=this.meshes.length-1;e>=0;e--)if(this.meshes[e].id===t)return this.meshes[e];return null},i.prototype.getLastEntryByID=function(t){var e;for(e=this.meshes.length-1;e>=0;e--)if(this.meshes[e].id===t)return this.meshes[e];for(e=this.cameras.length-1;e>=0;e--)if(this.cameras[e].id===t)return this.cameras[e];for(e=this.lights.length-1;e>=0;e--)if(this.lights[e].id===t)return this.lights[e];return null},i.prototype.getNodeByID=function(t){var e=this.getMeshByID(t);if(e)return e;var i=this.getLightByID(t);if(i)return i;var r=this.getCameraByID(t);return r?r:this.getBoneByID(t)},i.prototype.getNodeByName=function(t){var e=this.getMeshByName(t);if(e)return e;var i=this.getLightByName(t);if(i)return i;var r=this.getCameraByName(t);return r?r:this.getBoneByName(t)},i.prototype.getMeshByName=function(t){for(var e=0;e<this.meshes.length;e++)if(this.meshes[e].name===t)return this.meshes[e];return null},i.prototype.getSoundByName=function(e){var i;if(t.AudioEngine){for(i=0;i<this.mainSoundTrack.soundCollection.length;i++)if(this.mainSoundTrack.soundCollection[i].name===e)return this.mainSoundTrack.soundCollection[i];for(var r=0;r<this.soundTracks.length;r++)for(i=0;i<this.soundTracks[r].soundCollection.length;i++)if(this.soundTracks[r].soundCollection[i].name===e)return this.soundTracks[r].soundCollection[i]}return null},i.prototype.getLastSkeletonByID=function(t){for(var e=this.skeletons.length-1;e>=0;e--)if(this.skeletons[e].id===t)return this.skeletons[e];return null},i.prototype.getSkeletonById=function(t){for(var e=0;e<this.skeletons.length;e++)if(this.skeletons[e].id===t)return this.skeletons[e];return null},i.prototype.getSkeletonByName=function(t){for(var e=0;e<this.skeletons.length;e++)if(this.skeletons[e].name===t)return this.skeletons[e];return null},i.prototype.isActiveMesh=function(t){return this._activeMeshes.indexOf(t)!==-1},Object.defineProperty(i.prototype,"uid",{get:function(){return this._uid||(this._uid=t.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),i.prototype.addExternalData=function(t,e){return this._externalData.add(t,e)},i.prototype.getExternalData=function(t){return this._externalData.get(t)},i.prototype.getOrAddExternalDataWithFactory=function(t,e){return this._externalData.getOrAddWithFactory(t,e)},i.prototype.removeExternalData=function(t){return this._externalData.remove(t)},i.prototype._evaluateSubMesh=function(t,e){if(e.alwaysSelectAsActiveMesh||1===e.subMeshes.length||t.isInFrustum(this._frustumPlanes)){var i=t.getMaterial();e.showSubMeshesBoundingBox&&this._boundingBoxRenderer.renderList.push(t.getBoundingInfo().boundingBox),i&&(i.getRenderTargetTextures&&this._processedMaterials.indexOf(i)===-1&&(this._processedMaterials.push(i),this._renderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._activeIndices.addCount(t.indexCount,!1),this._renderingManager.dispatch(t))}},i.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},i.prototype._evaluateActiveMeshes=function(){this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._boundingBoxRenderer.reset(),this._edgesRenderers.reset();var e,i;if(this._selectionOctree){var r=this._selectionOctree.select(this._frustumPlanes);e=r.data,i=r.length}else i=this.meshes.length,e=this.meshes;for(var n=0;n<i;n++){var s=e[n];if(!s.isBlocked&&(this._totalVertices.addCount(s.getTotalVertices(),!1),s.isReady()&&s.isEnabled())){s.computeWorldMatrix(),s.actionManager&&s.actionManager.hasSpecificTriggers([t.ActionManager.OnIntersectionEnterTrigger,t.ActionManager.OnIntersectionExitTrigger])&&this._meshesForIntersections.pushNoDuplicate(s);var o=s.getLOD(this.activeCamera);o&&(s._preActivate(),(s.alwaysSelectAsActiveMesh||s.isVisible&&s.visibility>0&&0!=(s.layerMask&this.activeCamera.layerMask)&&s.isInFrustum(this._frustumPlanes))&&(this._activeMeshes.push(s),this.activeCamera._activeMeshes.push(s),s._activate(this._renderId),this._activeMesh(s,o)))}}this._particlesDuration.beginMonitoring();t.Tools.Now;if(this.particlesEnabled){t.Tools.StartPerformanceCounter("Particles",this.particleSystems.length>0);for(var a=0;a<this.particleSystems.length;a++){var h=this.particleSystems[a];h.isStarted()&&(!h.emitter.position||h.emitter&&h.emitter.isEnabled())&&(this._activeParticleSystems.push(h),h.animate())}t.Tools.EndPerformanceCounter("Particles",this.particleSystems.length>0)}this._particlesDuration.endMonitoring(!1)},i.prototype._activeMesh=function(t,e){if(e.skeleton&&this.skeletonsEnabled&&(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&e.skeleton.prepare(),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)),(t.showBoundingBox||this.forceShowBoundingBoxes)&&this._boundingBoxRenderer.renderList.push(t.getBoundingInfo().boundingBox),t._edgesRenderer&&this._edgesRenderers.push(t._edgesRenderer),e&&e.subMeshes){var i,r;if(e._submeshesOctree&&e.useOctreeForRenderingSelection){var n=e._submeshesOctree.select(this._frustumPlanes);i=n.length,r=n.data}else r=e.subMeshes,i=r.length;for(var s=0;s<i;s++){var o=r[s];this._evaluateSubMesh(o,e)}}},i.prototype.updateTransformMatrix=function(t){this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(t))},i.prototype._renderForCamera=function(e){var i=this._engine;t.Tools.Now;if(this.activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");t.Tools.StartPerformanceCounter("Rendering camera "+this.activeCamera.name),i.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshesDuration.beginMonitoring(),t.Tools.StartPerformanceCounter("Active meshes evaluation"),this._evaluateActiveMeshes(),this._evaluateActiveMeshesDuration.endMonitoring(!1),t.Tools.EndPerformanceCounter("Active meshes evaluation");for(var r=0;r<this._softwareSkinnedMeshes.length;r++){var n=this._softwareSkinnedMeshes.data[r];n.applySkeleton(n.skeleton)}this._renderTargetsDuration.beginMonitoring();var s=!1;t.Tools.Now;if(this.renderTargetsEnabled&&this._renderTargets.length>0){this._intermediateRendering=!0,t.Tools.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var o=0;o<this._renderTargets.length;o++){var a=this._renderTargets.data[o];if(a._shouldRender()){this._renderId++;var h=a.activeCamera&&a.activeCamera!==this.activeCamera;a.render(h,this.dumpNextRenderTargets)}}t.Tools.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._intermediateRendering=!1,this._renderId++,s=!0}var l=this._engine.getStencilBuffer(),c=!1;if(this.renderTargetsEnabled&&this.highlightLayers&&this.highlightLayers.length>0){this._intermediateRendering=!0;for(var u=0;u<this.highlightLayers.length;u++){var p=this.highlightLayers[u];if(p.shouldRender()&&(!p.camera||p.camera.cameraRigMode===t.Camera.RIG_MODE_NONE&&e===p.camera||p.camera.cameraRigMode!==t.Camera.RIG_MODE_NONE&&p.camera._rigCameras.indexOf(e)>-1)){c=!0;var a=p._mainTexture;a._shouldRender()&&(this._renderId++,a.render(!1,!1),s=!0)}}this._intermediateRendering=!1,this._renderId++}s&&i.restoreDefaultFramebuffer(),this._renderTargetsDuration.endMonitoring(!1),this.postProcessManager._prepareFrame(),this._renderDuration.beginMonitoring();var d,f;if(this.layers.length){for(i.setDepthBuffer(!1),d=0;d<this.layers.length;d++)f=this.layers[d],f.isBackground&&f.render();i.setDepthBuffer(!0)}t.Tools.StartPerformanceCounter("Main render"),c&&this._engine.setStencilBuffer(!0),this._renderingManager.render(null,null,!0,!0),c&&this._engine.setStencilBuffer(l),t.Tools.EndPerformanceCounter("Main render"),this._boundingBoxRenderer.render();for(var m=0;m<this._edgesRenderers.length;m++)this._edgesRenderers.data[m].render();if(this.lensFlaresEnabled){t.Tools.StartPerformanceCounter("Lens flares",this.lensFlareSystems.length>0);for(var _=0;_<this.lensFlareSystems.length;_++){var g=this.lensFlareSystems[_];0!=(e.layerMask&g.layerMask)&&g.render()}t.Tools.EndPerformanceCounter("Lens flares",this.lensFlareSystems.length>0)}if(this.layers.length){for(i.setDepthBuffer(!1),d=0;d<this.layers.length;d++)f=this.layers[d],f.isBackground||f.render();i.setDepthBuffer(!0)}if(c){i.setDepthBuffer(!1);for(var u=0;u<this.highlightLayers.length;u++)this.highlightLayers[u].shouldRender()&&this.highlightLayers[u].render();i.setDepthBuffer(!0)}this._renderDuration.endMonitoring(!1),this.postProcessManager._finalizeFrame(e.isIntermediate),this.activeCamera._updateFromScene(),this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera),t.Tools.EndPerformanceCounter("Rendering camera "+this.activeCamera.name)},i.prototype._processSubCameras=function(e){if(e.cameraRigMode===t.Camera.RIG_MODE_NONE)return void this._renderForCamera(e);for(var i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i]);this.activeCamera=e,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix()),this.activeCamera._updateFromScene()},i.prototype._checkIntersections=function(){for(var e=0;e<this._meshesForIntersections.length;e++)for(var i=this._meshesForIntersections.data[e],r=0;r<i.actionManager.actions.length;r++){var n=i.actionManager.actions[r];if(n.trigger===t.ActionManager.OnIntersectionEnterTrigger||n.trigger===t.ActionManager.OnIntersectionExitTrigger){var s=n.getTriggerParameter(),o=s instanceof t.AbstractMesh?s:s.mesh,a=o.intersectsMesh(i,s.usePreciseIntersection),h=i._intersectionsInProgress.indexOf(o);a&&h===-1?n.trigger===t.ActionManager.OnIntersectionEnterTrigger?(n._executeCurrent(t.ActionEvent.CreateNew(i,null,o)),i._intersectionsInProgress.push(o)):n.trigger===t.ActionManager.OnIntersectionExitTrigger&&i._intersectionsInProgress.push(o):!a&&h>-1&&(n.trigger===t.ActionManager.OnIntersectionExitTrigger&&n._executeCurrent(t.ActionEvent.CreateNew(i,null,o)),i.actionManager.hasSpecificTrigger(t.ActionManager.OnIntersectionExitTrigger)&&n.trigger!==t.ActionManager.OnIntersectionExitTrigger||i._intersectionsInProgress.splice(h,1))}}},i.prototype.render=function(){this._lastFrameDuration.beginMonitoring(),this._particlesDuration.fetchNewFrame(),this._spritesDuration.fetchNewFrame(),this._activeParticles.fetchNewFrame(),this._renderDuration.fetchNewFrame(),this._renderTargetsDuration.fetchNewFrame(),this._evaluateActiveMeshesDuration.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this.getEngine().drawCallsPerfCounter.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),t.Tools.StartPerformanceCounter("Scene rendering"),this.actionManager&&this.actionManager.processTrigger(t.ActionManager.OnEveryFrameTrigger,null),this.simplificationQueue&&!this.simplificationQueue.running&&this.simplificationQueue.executeNext();var e=Math.max(i.MinDeltaTime,Math.min(this._engine.getDeltaTime(),i.MaxDeltaTime));this._animationRatio=.06*e,this._animate(),this._physicsEngine&&(t.Tools.StartPerformanceCounter("Physics"),this._physicsEngine._step(e/1e3),t.Tools.EndPerformanceCounter("Physics")),this.onBeforeRenderObservable.notifyObservers(this),this._renderTargetsDuration.beginMonitoring();var r=(t.Tools.Now,this.getEngine()),n=this.activeCamera;if(this.renderTargetsEnabled){t.Tools.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);for(var s=0;s<this.customRenderTargets.length;s++){var o=this.customRenderTargets[s];if(o._shouldRender()){if(this._renderId++,this.activeCamera=o.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");r.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),o.render(n!==this.activeCamera,this.dumpNextRenderTargets)}}t.Tools.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._renderId++}if(this.customRenderTargets.length>0&&r.restoreDefaultFramebuffer(),this._renderTargetsDuration.endMonitoring(),this.activeCamera=n,this.proceduralTexturesEnabled){t.Tools.StartPerformanceCounter("Procedural textures",this._proceduralTextures.length>0);for(var a=0;a<this._proceduralTextures.length;a++){var h=this._proceduralTextures[a];h._shouldRender()&&h.render()}t.Tools.EndPerformanceCounter("Procedural textures",this._proceduralTextures.length>0)}if(this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,!0,!0),this.shadowsEnabled)for(var l=0;l<this.lights.length;l++){var c=this.lights[l],u=c.getShadowGenerator();c.isEnabled()&&u&&u.getShadowMap().getScene().textures.indexOf(u.getShadowMap())!==-1&&this._renderTargets.push(u.getShadowMap())}if(this._depthRenderer&&this._renderTargets.push(this._depthRenderer.getDepthMap()),this.postProcessRenderPipelineManager.update(),this.activeCameras.length>0)for(var p=0;p<this.activeCameras.length;p++)p>0&&this._engine.clear(0,!1,!0,!0),this._processSubCameras(this.activeCameras[p]);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera)}this._checkIntersections(),t.AudioEngine&&this._updateAudioParameters(),this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this);for(var d=0;d<this._toBeDisposed.length;d++)this._toBeDisposed.data[d].dispose(),this._toBeDisposed[d]=null;this._toBeDisposed.reset(),this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),t.Tools.EndPerformanceCounter("Scene rendering"),this._lastFrameDuration.endMonitoring(),this._totalMeshesCounter.addCount(this.meshes.length,!0),this._totalLightsCounter.addCount(this.lights.length,!0),this._totalMaterialsCounter.addCount(this.materials.length,!0),this._totalTexturesCounter.addCount(this.textures.length,!0),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0)},i.prototype._updateAudioParameters=function(){if(this.audioEnabled&&(0!==this.mainSoundTrack.soundCollection.length||1!==this.soundTracks.length)){var e,i=t.Engine.audioEngine;if((e=this.activeCameras.length>0?this.activeCameras[0]:this.activeCamera)&&i.canUseWebAudio){i.audioContext.listener.setPosition(e.position.x,e.position.y,e.position.z);var r=t.Matrix.Invert(e.getViewMatrix()),n=t.Vector3.TransformNormal(new t.Vector3(0,0,-1),r);n.normalize(),i.audioContext.listener.setOrientation(n.x,n.y,n.z,0,1,0);var s;for(s=0;s<this.mainSoundTrack.soundCollection.length;s++){var o=this.mainSoundTrack.soundCollection[s];o.useCustomAttenuation&&o.updateDistanceFromListener()}for(s=0;s<this.soundTracks.length;s++)for(var a=0;a<this.soundTracks[s].soundCollection.length;a++)o=this.soundTracks[s].soundCollection[a],o.useCustomAttenuation&&o.updateDistanceFromListener()}}},Object.defineProperty(i.prototype,"audioEnabled",{get:function(){return this._audioEnabled},set:function(e){this._audioEnabled=e,t.AudioEngine&&(this._audioEnabled?this._enableAudio():this._disableAudio())},enumerable:!0,configurable:!0}),i.prototype._disableAudio=function(){var t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)this.mainSoundTrack.soundCollection[t].pause();for(t=0;t<this.soundTracks.length;t++)for(var e=0;e<this.soundTracks[t].soundCollection.length;e++)this.soundTracks[t].soundCollection[e].pause()},i.prototype._enableAudio=function(){var t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)this.mainSoundTrack.soundCollection[t].isPaused&&this.mainSoundTrack.soundCollection[t].play();for(t=0;t<this.soundTracks.length;t++)for(var e=0;e<this.soundTracks[t].soundCollection.length;e++)this.soundTracks[t].soundCollection[e].isPaused&&this.soundTracks[t].soundCollection[e].play()},Object.defineProperty(i.prototype,"headphone",{get:function(){return this._headphone},set:function(e){this._headphone=e,t.AudioEngine&&(this._headphone?this._switchAudioModeForHeadphones():this._switchAudioModeForNormalSpeakers())},enumerable:!0,configurable:!0}),i.prototype._switchAudioModeForHeadphones=function(){this.mainSoundTrack.switchPanningModelToHRTF();for(var t=0;t<this.soundTracks.length;t++)this.soundTracks[t].switchPanningModelToHRTF()},i.prototype._switchAudioModeForNormalSpeakers=function(){this.mainSoundTrack.switchPanningModelToEqualPower();for(var t=0;t<this.soundTracks.length;t++)this.soundTracks[t].switchPanningModelToEqualPower()},i.prototype.enableDepthRenderer=function(){return this._depthRenderer?this._depthRenderer:(this._depthRenderer=new t.DepthRenderer(this),this._depthRenderer)},i.prototype.disableDepthRenderer=function(){this._depthRenderer&&(this._depthRenderer.dispose(),this._depthRenderer=null)},i.prototype.freezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].freeze()},i.prototype.unfreezeMaterials=function(){for(var t=0;t<this.materials.length;t++)this.materials[t].unfreeze()},i.prototype.dispose=function(){this.beforeRender=null,this.afterRender=null,this.skeletons=[],this._boundingBoxRenderer.dispose(),this._depthRenderer&&this._depthRenderer.dispose(),this._debugLayer&&this._debugLayer.hide(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.detachControl(),t.AudioEngine&&this.disposeSounds();var e,i=this._engine.getRenderingCanvas();for(e=0;e<this.cameras.length;e++)this.cameras[e].detachControl(i);for(;this.lights.length;)this.lights[0].dispose();for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.cameras.length;)this.cameras[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.highlightLayers.length;)this.highlightLayers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this.postProcessManager.dispose(),this._physicsEngine&&this.disablePhysicsEngine(),e=this._engine.scenes.indexOf(this),e>-1&&this._engine.scenes.splice(e,1),this._engine.wipeCaches()},i.prototype.disposeSounds=function(){this.mainSoundTrack.dispose();for(var t=0;t<this.soundTracks.length;t++)this.soundTracks[t].dispose()},i.prototype.getWorldExtends=function(){for(var e=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new t.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r=0;r<this.meshes.length;r++){var n=this.meshes[r];n.computeWorldMatrix(!0);var s=n.getBoundingInfo().boundingBox.minimumWorld,o=n.getBoundingInfo().boundingBox.maximumWorld;t.Tools.CheckExtends(s,e,i),t.Tools.CheckExtends(o,e,i)}return{min:e,max:i}},i.prototype.createOrUpdateSelectionOctree=function(e,i){void 0===e&&(e=64),void 0===i&&(i=2),this._selectionOctree||(this._selectionOctree=new t.Octree(t.Octree.CreationFuncForMeshes,e,i));var r=this.getWorldExtends();return this._selectionOctree.update(r.min,r.max,this.meshes),this._selectionOctree},i.prototype.createPickingRay=function(e,i,r,n,s){void 0===s&&(s=!1);var o=this._engine;if(!n){if(!this.activeCamera)throw new Error("Active camera not set");n=this.activeCamera}var a=n.viewport,h=a.toGlobal(o.getRenderWidth(),o.getRenderHeight());return e=e/this._engine.getHardwareScalingLevel()-h.x,i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-h.y-h.height),t.Ray.CreateNew(e,i,h.width,h.height,r?r:t.Matrix.Identity(),s?t.Matrix.Identity():n.getViewMatrix(),n.getProjectionMatrix())},i.prototype.createPickingRayInCameraSpace=function(e,i,r){var n=this._engine;if(!r){if(!this.activeCamera)throw new Error("Active camera not set");r=this.activeCamera}var s=r.viewport,o=s.toGlobal(n.getRenderWidth(),n.getRenderHeight()),a=t.Matrix.Identity();return e=e/this._engine.getHardwareScalingLevel()-o.x,i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-o.y-o.height),t.Ray.CreateNew(e,i,o.width,o.height,a,a,r.getProjectionMatrix())},i.prototype._internalPick=function(e,i,r){for(var n=null,s=0;s<this.meshes.length;s++){var o=this.meshes[s];if(i){if(!i(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var a=o.getWorldMatrix(),h=e(a),l=o.intersects(h,r);if(l&&l.hit&&(r||null==n||!(l.distance>=n.distance))&&(n=l,r))break}return n||new t.PickingInfo},i.prototype._internalMultiPick=function(t,e){for(var i=new Array,r=0;r<this.meshes.length;r++){var n=this.meshes[r];if(e){if(!e(n))continue}else if(!n.isEnabled()||!n.isVisible||!n.isPickable)continue;var s=n.getWorldMatrix(),o=t(s),a=n.intersects(o,!1);a&&a.hit&&i.push(a)}return i},i.prototype._internalPickSprites=function(e,i,r,n){var s=null;if(n=n||this.activeCamera,this.spriteManagers.length>0)for(var o=0;o<this.spriteManagers.length;o++){var a=this.spriteManagers[o];if(a.isPickable){var h=a.intersects(e,n,i,r);if(h&&h.hit&&(r||null==s||!(h.distance>=s.distance))&&(s=h,r))break}}return s||new t.PickingInfo},i.prototype.pick=function(t,e,i,r,n){var s=this;return this._internalPick(function(i){return s.createPickingRay(t,e,i,n)},i,r)},i.prototype.pickSprite=function(t,e,i,r,n){return this._internalPickSprites(this.createPickingRayInCameraSpace(t,e,n),i,r,n)},i.prototype.pickWithRay=function(e,i,r){var n=this;return this._internalPick(function(i){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=t.Matrix.Identity()),i.invertToRef(n._pickWithRayInverseMatrix),t.Ray.Transform(e,n._pickWithRayInverseMatrix)},i,r)},i.prototype.multiPick=function(t,e,i,r){var n=this;return this._internalMultiPick(function(i){return n.createPickingRay(t,e,i,r)},i)},i.prototype.multiPickWithRay=function(e,i){var r=this;return this._internalMultiPick(function(i){return r._pickWithRayInverseMatrix||(r._pickWithRayInverseMatrix=t.Matrix.Identity()),i.invertToRef(r._pickWithRayInverseMatrix),t.Ray.Transform(e,r._pickWithRayInverseMatrix)},i)},i.prototype.setPointerOverMesh=function(e){this._pointerOverMesh!==e&&(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(t.ActionManager.OnPointerOutTrigger,t.ActionEvent.CreateNew(this._pointerOverMesh)),this._pointerOverMesh=e,this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(t.ActionManager.OnPointerOverTrigger,t.ActionEvent.CreateNew(this._pointerOverMesh)))},i.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},i.prototype.setPointerOverSprite=function(e){this._pointerOverSprite!==e&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(t.ActionManager.OnPointerOutTrigger,t.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=e,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(t.ActionManager.OnPointerOverTrigger,t.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)))},i.prototype.getPointerOverSprite=function(){return this._pointerOverSprite},i.prototype.getPhysicsEngine=function(){return this._physicsEngine},i.prototype.enablePhysics=function(e,i){if(this._physicsEngine)return!0;try{return this._physicsEngine=new t.PhysicsEngine(e,i),!0}catch(e){return t.Tools.Error(e.message),!1}},i.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=void 0)},i.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},i.prototype.setGravity=function(e){t.Tools.Warn("Deprecated, please use 'scene.getPhysicsEngine().setGravity()'"),this._physicsEngine&&this._physicsEngine.setGravity(e)},i.prototype.createCompoundImpostor=function(e,i){t.Tools.Warn("Scene.createCompoundImpostor is deprecated. Please use PhysicsImpostor parent/child"),e.parts&&(i=e,e=e.parts);var r=e[0].mesh;r.physicsImpostor=new t.PhysicsImpostor(r,e[0].impostor,i,this);for(var n=1;n<e.length;n++){var s=e[n].mesh;s.parent!==r&&(s.position=s.position.subtract(r.position),s.parent=r),s.physicsImpostor=new t.PhysicsImpostor(s,e[n].impostor,i,this)}r.physicsImpostor.forceUpdate()},i.prototype.deleteCompoundImpostor=function(t){var e=t.parts[0].mesh;e.physicsImpostor.dispose(),e.physicsImpostor=null},i.prototype.createDefaultCameraOrLight=function(){if(0===this.lights.length&&new t.HemisphericLight("default light",t.Vector3.Up(),this),!this.activeCamera){var e=new t.FreeCamera("default camera",t.Vector3.Zero(),this),i=this.getWorldExtends(),r=i.min.add(i.max.subtract(i.min).scale(.5));e.position=new t.Vector3(r.x,r.y,i.min.z-(i.max.z-i.min.z)),e.setTarget(r),this.activeCamera=e}},i.prototype._getByTags=function(e,i,r){if(void 0===i)return e;var n=[];r=r||function(t){};for(var s in e){var o=e[s];t.Tags.MatchesQuery(o,i)&&(n.push(o),r(o))}return n},i.prototype.getMeshesByTags=function(t,e){return this._getByTags(this.meshes,t,e)},i.prototype.getCamerasByTags=function(t,e){return this._getByTags(this.cameras,t,e)},i.prototype.getLightsByTags=function(t,e){return this._getByTags(this.lights,t,e)},i.prototype.getMaterialByTags=function(t,e){return this._getByTags(this.materials,t,e).concat(this._getByTags(this.multiMaterials,t,e))},i.prototype.setRenderingOrder=function(t,e,i,r){void 0===e&&(e=null),void 0===i&&(i=null),void 0===r&&(r=null),this._renderingManager.setRenderingOrder(t,e,i,r)},i.prototype.setRenderingAutoClearDepthStencil=function(t,e){this._renderingManager.setRenderingAutoClearDepthStencil(t,e)},i._FOGMODE_NONE=0,i._FOGMODE_EXP=1,i._FOGMODE_EXP2=2,i._FOGMODE_LINEAR=3,i.MinDeltaTime=1,i.MaxDeltaTime=1e3,i}();t.Scene=a}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s,o){e instanceof t.Mesh?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=r,this._data=i,this._strideSize=n,s||this.create(),this._instanced=o}return e.prototype.createVertexBuffer=function(e,i,r,n){return new t.VertexBuffer(this._engine,this,e,this._updatable,!0,n?n:this._strideSize,this._instanced,i,r)},e.prototype.isUpdatable=function(){return this._updatable},e.prototype.getData=function(){return this._data},e.prototype.getBuffer=function(){return this._buffer},e.prototype.getStrideSize=function(){return this._strideSize},e.prototype.getIsInstanced=function(){return this._instanced},e.prototype.create=function(t){!t&&this._buffer||(t=t||this._data,this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,t),this._data=t):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(t),this._data=t):this._buffer=this._engine.createVertexBuffer(t))},e.prototype.update=function(t){this.create(t)},e.prototype.updateDirectly=function(t,e,i){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,t,e,i?i*this.getStrideSize():void 0),this._data=null)},e.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)},e}();t.Buffer=e}(r||(r={}));var r;!function(t){var e=function(){function e(i,r,n,s,o,a,h,l,c){if(!a)switch(n){case e.PositionKind:a=3;break;case e.NormalKind:a=3;break;case e.UVKind:case e.UV2Kind:case e.UV3Kind:case e.UV4Kind:case e.UV5Kind:case e.UV6Kind:a=2;break;case e.ColorKind:a=4;break;case e.MatricesIndicesKind:case e.MatricesIndicesExtraKind:a=4;break;case e.MatricesWeightsKind:case e.MatricesWeightsExtraKind:a=4}r instanceof t.Buffer?(a||(a=r.getStrideSize()),this._buffer=r,this._ownsBuffer=!1):(this._buffer=new t.Buffer(i,r,s,a,o,h),this._ownsBuffer=!0),this._stride=a,this._offset=l?l:0,this._size=c?c:a,this._kind=n}return e.prototype.getKind=function(){return this._kind},e.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},e.prototype.getData=function(){return this._buffer.getData()},e.prototype.getBuffer=function(){return this._buffer.getBuffer()},e.prototype.getStrideSize=function(){return this._stride},e.prototype.getOffset=function(){return this._offset},e.prototype.getSize=function(){return this._size},e.prototype.getIsInstanced=function(){return this._buffer.getIsInstanced()},e.prototype.create=function(t){return this._buffer.create(t)},e.prototype.update=function(t){return this._buffer.update(t)},e.prototype.updateDirectly=function(t,e){return this._buffer.updateDirectly(t,e)},e.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},Object.defineProperty(e,"PositionKind",{get:function(){return e._PositionKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"NormalKind",{get:function(){return e._NormalKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"UVKind",{get:function(){return e._UVKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"UV2Kind",{get:function(){return e._UV2Kind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"UV3Kind",{get:function(){return e._UV3Kind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"UV4Kind",{get:function(){return e._UV4Kind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"UV5Kind",{get:function(){return e._UV5Kind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"UV6Kind",{get:function(){return e._UV6Kind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"ColorKind",{get:function(){return e._ColorKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MatricesIndicesKind",{get:function(){return e._MatricesIndicesKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MatricesWeightsKind",{get:function(){return e._MatricesWeightsKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MatricesIndicesExtraKind",{get:function(){return e._MatricesIndicesExtraKind},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MatricesWeightsExtraKind",{get:function(){return e._MatricesWeightsExtraKind},enumerable:!0,configurable:!0}),e._PositionKind="position",e._NormalKind="normal",e._UVKind="uv",e._UV2Kind="uv2",e._UV3Kind="uv3",e._UV4Kind="uv4",e._UV5Kind="uv5",e._UV6Kind="uv6",e._ColorKind="color",e._MatricesIndicesKind="matricesIndices",e._MatricesWeightsKind="matricesWeights",e._MatricesIndicesExtraKind="matricesIndicesExtra",e._MatricesWeightsExtraKind="matricesWeightsExtra",e}();t.VertexBuffer=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i){e.call(this,t,i.getScene()),i.instances.push(this),this._sourceMesh=i,this.position.copyFrom(i.position),this.rotation.copyFrom(i.rotation),this.scaling.copyFrom(i.scaling),i.rotationQuaternion&&(this.rotationQuaternion=i.rotationQuaternion.clone()),this.infiniteDistance=i.infiniteDistance,this.setPivotMatrix(i.getPivotMatrix()),this.refreshBoundingInfo(),this._syncSubMeshes()}return o(i,e),Object.defineProperty(i.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},enumerable:!0,configurable:!0}),i.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()},Object.defineProperty(i.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!0,configurable:!0}),i.prototype.getVerticesData=function(t,e){return this._sourceMesh.getVerticesData(t,e)},i.prototype.isVerticesDataPresent=function(t){return this._sourceMesh.isVerticesDataPresent(t)},i.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(i.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!0,configurable:!0}),i.prototype.refreshBoundingInfo=function(){var e=this._sourceMesh.getBoundingInfo();this._boundingInfo=new t.BoundingInfo(e.minimum.clone(),e.maximum.clone()),this._updateBoundingInfo()},i.prototype._preActivate=function(){this._currentLOD&&this._currentLOD._preActivate()},i.prototype._activate=function(t){this._currentLOD&&this._currentLOD._registerInstanceForRenderId(this,t)},i.prototype.getLOD=function(t){return this._currentLOD=this.sourceMesh.getLOD(this.getScene().activeCamera,this.getBoundingInfo().boundingSphere),this._currentLOD===this.sourceMesh?this:this._currentLOD},i.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var t=0;t<this._sourceMesh.subMeshes.length;t++)this._sourceMesh.subMeshes[t].clone(this,this._sourceMesh)},i.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},i.prototype.clone=function(e,i,r){var n=this._sourceMesh.createInstance(e);if(t.Tools.DeepCopy(this,n,["name","subMeshes"],[]),this.refreshBoundingInfo(),i&&(n.parent=i),!r)for(var s=0;s<this.getScene().meshes.length;s++){var o=this.getScene().meshes[s];o.parent===this&&o.clone(o.name,n)}return n.computeWorldMatrix(!0),n},i.prototype.dispose=function(t){var i=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(i,1),e.prototype.dispose.call(this,t)},i}(t.AbstractMesh);t.InstancedMesh=e}(r||(r={}));var r;!function(t){var e=function(){function t(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array}return t}();t._InstancesBatch=e;var i=function(i){function r(n,s,o,a,h,l){if(void 0===o&&(o=null),void 0===l&&(l=!0),i.call(this,n,s),this.onBeforeRenderObservable=new t.Observable,this.onAfterRenderObservable=new t.Observable,this.onBeforeDrawObservable=new t.Observable,this.delayLoadState=t.Engine.DELAYLOADSTATE_NONE,this.instances=new Array,this._LODLevels=new Array,this._visibleInstances={},this._renderIdForInstances=new Array,this._batchCache=new e,this._instancesBufferSize=2048,this._sideOrientation=r._DEFAULTSIDE,this._areNormalsFrozen=!1,a){a._geometry&&a._geometry.applyToMesh(this),t.Tools.DeepCopy(a,this,["name","material","skeleton","instances","parent"],["_poseMatrix"]),this.parent=a.parent,this.setPivotMatrix(a.getPivotMatrix()),this.id=n+"."+a.id,this.material=a.material;var c;if(!h)for(c=0;c<s.meshes.length;c++){var u=s.meshes[c];if(u.parent===a){u.clone(n+"."+u.name,this,h)}}var p=this.getScene().getPhysicsEngine();if(l&&p){var d=p.getImpostorForPhysicsObject(a);d&&(this.physicsImpostor=d.clone(this))}for(c=0;c<s.particleSystems.length;c++){var f=s.particleSystems[c];f.emitter===a&&f.clone(f.name,this)}this.computeWorldMatrix(!0)}null!==o&&(this.parent=o)}return o(r,i),Object.defineProperty(r,"FRONTSIDE",{get:function(){return r._FRONTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"BACKSIDE",{get:function(){return r._BACKSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"DOUBLESIDE",{get:function(){return r._DOUBLESIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"DEFAULTSIDE",{get:function(){return r._DEFAULTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"NO_CAP",{get:function(){return r._NO_CAP},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CAP_START",{get:function(){return r._CAP_START},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CAP_END",{get:function(){return r._CAP_END},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CAP_ALL",{get:function(){return r._CAP_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"onBeforeDraw",{set:function(t){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(t)},enumerable:!0,configurable:!0}),r.prototype.toString=function(e){var r=i.prototype.toString.call(this,e);if(r+=", n vertices: "+this.getTotalVertices(),r+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var n=0;n<this.animations.length;n++)r+=", animation[0]: "+this.animations[n].toString(e);return e&&(r+=", flat shading: "+(this._geometry?this.getVerticesData(t.VertexBuffer.PositionKind).length/3===this.getIndices().length?"YES":"NO":"UNKNOWN")),r},Object.defineProperty(r.prototype,"hasLODLevels",{get:function(){return this._LODLevels.length>0},enumerable:!0,configurable:!0}),r.prototype._sortLODLevels=function(){this._LODLevels.sort(function(t,e){return t.distance<e.distance?1:t.distance>e.distance?-1:0})},r.prototype.addLODLevel=function(e,i){if(i&&i._masterMesh)return t.Tools.Warn("You cannot use a mesh as LOD level twice"),this;var r=new t.Internals.MeshLODLevel(e,i);return this._LODLevels.push(r),i&&(i._masterMesh=this),this._sortLODLevels(),this},r.prototype.getLODLevelAtDistance=function(t){for(var e=0;e<this._LODLevels.length;e++){var i=this._LODLevels[e];if(i.distance===t)return i.mesh}return null},r.prototype.removeLODLevel=function(t){for(var e=0;e<this._LODLevels.length;e++)this._LODLevels[e].mesh===t&&(this._LODLevels.splice(e,1),t&&(t._masterMesh=null));return this._sortLODLevels(),this},r.prototype.getLOD=function(t,e){if(!this._LODLevels||0===this._LODLevels.length)return this;var i=(e?e:this.getBoundingInfo().boundingSphere).centerWorld.subtract(t.globalPosition).length();if(this._LODLevels[this._LODLevels.length-1].distance>i)return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this._LODLevels[this._LODLevels.length-1].mesh),this;for(var r=0;r<this._LODLevels.length;r++){var n=this._LODLevels[r];if(n.distance<i)return n.mesh&&(n.mesh._preActivate(),n.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)),this.onLODLevelSelection&&this.onLODLevelSelection(i,this,n.mesh),n.mesh}return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this),this},Object.defineProperty(r.prototype,"geometry",{get:function(){return this._geometry},enumerable:!0,configurable:!0}),r.prototype.getTotalVertices=function(){return this._geometry?this._geometry.getTotalVertices():0},r.prototype.getVerticesData=function(t,e){return this._geometry?this._geometry.getVerticesData(t,e):null},r.prototype.getVertexBuffer=function(t){if(this._geometry)return this._geometry.getVertexBuffer(t)},r.prototype.isVerticesDataPresent=function(t){return this._geometry?this._geometry.isVerticesDataPresent(t):!!this._delayInfo&&this._delayInfo.indexOf(t)!==-1},r.prototype.getVerticesDataKinds=function(){if(!this._geometry){var t=[];return this._delayInfo&&this._delayInfo.forEach(function(e,i,r){t.push(e)}),t}return this._geometry.getVerticesDataKinds()},r.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},r.prototype.getIndices=function(t){return this._geometry?this._geometry.getIndices(t):[]},Object.defineProperty(r.prototype,"isBlocked",{get:function(){return null!==this._masterMesh&&void 0!==this._masterMesh},enumerable:!0,configurable:!0}),r.prototype.isReady=function(){return this.delayLoadState!==t.Engine.DELAYLOADSTATE_LOADING&&i.prototype.isReady.call(this)},r.prototype.isDisposed=function(){return this._isDisposed},Object.defineProperty(r.prototype,"sideOrientation",{get:function(){return this._sideOrientation},set:function(t){this._sideOrientation=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"areNormalsFrozen",{get:function(){return this._areNormalsFrozen},enumerable:!0,configurable:!0}),r.prototype.freezeNormals=function(){this._areNormalsFrozen=!0},r.prototype.unfreezeNormals=function(){this._areNormalsFrozen=!1},Object.defineProperty(r.prototype,"overridenInstanceCount",{set:function(t){this._overridenInstanceCount=t},enumerable:!0,configurable:!0}),r.prototype._preActivate=function(){var t=this.getScene().getRenderId();this._preActivateId!==t&&(this._preActivateId=t,this._visibleInstances=null)},r.prototype._preActivateForIntermediateRendering=function(t){this._visibleInstances&&(this._visibleInstances.intermediateDefaultRenderId=t)},r.prototype._registerInstanceForRenderId=function(t,e){this._visibleInstances||(this._visibleInstances={},this._visibleInstances.defaultRenderId=e,this._visibleInstances.selfDefaultRenderId=this._renderId),this._visibleInstances[e]||(this._visibleInstances[e]=new Array),this._visibleInstances[e].push(t)},r.prototype.refreshBoundingInfo=function(){if(!this._boundingInfo.isLocked){var e=this.getVerticesData(t.VertexBuffer.PositionKind);if(e){var i=t.Tools.ExtractMinAndMax(e,0,this.getTotalVertices());this._boundingInfo=new t.BoundingInfo(i.minimum,i.maximum)}if(this.subMeshes)for(var r=0;r<this.subMeshes.length;r++)this.subMeshes[r].refreshBoundingInfo();this._updateBoundingInfo()}},r.prototype._createGlobalSubMesh=function(){var e=this.getTotalVertices();return e&&this.getIndices()?(this.releaseSubMeshes(),new t.SubMesh(0,0,e,0,this.getTotalIndices(),this)):null},r.prototype.subdivide=function(e){if(!(e<1)){for(var i=this.getTotalIndices(),r=i/e|0,n=0;r%3!=0;)r++;this.releaseSubMeshes();for(var s=0;s<e&&!(n>=i);s++)t.SubMesh.CreateFromIndices(0,n,Math.min(r,i-n),this),n+=r;this.synchronizeInstances()}},r.prototype.setVerticesData=function(e,i,r,n){if(this._geometry)this._geometry.setVerticesData(e,i,r,n);else{var s=new t.VertexData;s.set(i,e);var o=this.getScene();new t.Geometry(t.Geometry.RandomId(),o,s,r,this)}},r.prototype.setVerticesBuffer=function(e){if(!this._geometry){var i=this.getScene();new t.Geometry(t.Geometry.RandomId(),i).applyToMesh(this)}this._geometry.setVerticesBuffer(e)},r.prototype.updateVerticesData=function(t,e,i,r){this._geometry&&(r?(this.makeGeometryUnique(),this.updateVerticesData(t,e,i,!1)):this._geometry.updateVerticesData(t,e,i))},r.prototype.updateVerticesDataDirectly=function(e,i,r,n){t.Tools.Warn("Mesh.updateVerticesDataDirectly deprecated since 2.3."),this._geometry&&(n?(this.makeGeometryUnique(),this.updateVerticesDataDirectly(e,i,r,!1)):this._geometry.updateVerticesDataDirectly(e,i,r))},r.prototype.updateMeshPositions=function(e,i){void 0===i&&(i=!0);var r=this.getVerticesData(t.VertexBuffer.PositionKind);if(e(r),this.updateVerticesData(t.VertexBuffer.PositionKind,r,!1,!1),i){var n=this.getIndices(),s=this.getVerticesData(t.VertexBuffer.NormalKind);t.VertexData.ComputeNormals(r,n,s),this.updateVerticesData(t.VertexBuffer.NormalKind,s,!1,!1)}},r.prototype.makeGeometryUnique=function(){if(this._geometry){var e=this._geometry,i=this._geometry.copy(t.Geometry.RandomId());e.releaseForMesh(this,!0),i.applyToMesh(this)}},r.prototype.setIndices=function(e,i){if(this._geometry)this._geometry.setIndices(e,i);else{var r=new t.VertexData;r.indices=e;var n=this.getScene();new t.Geometry(t.Geometry.RandomId(),n,r,!1,this)}},r.prototype.toLeftHanded=function(){this._geometry&&this._geometry.toLeftHanded()},r.prototype._bind=function(e,i,r){var n,s=this.getScene().getEngine();if(this._unIndexed)n=null;else switch(r){case t.Material.PointFillMode:n=null;break;case t.Material.WireFrameFillMode:n=e.getLinesIndexBuffer(this.getIndices(),s);break;default:case t.Material.TriangleFillMode:n=this._unIndexed?null:this._geometry.getIndexBuffer()}s.bindBuffers(this._geometry.getVertexBuffers(),n,i)},r.prototype._draw=function(e,i,r){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){this.onBeforeDrawObservable.notifyObservers(this);var n=this.getScene().getEngine();switch(i){case t.Material.PointFillMode:n.drawPointClouds(e.verticesStart,e.verticesCount,r);break;case t.Material.WireFrameFillMode:this._unIndexed?n.drawUnIndexed(!1,e.verticesStart,e.verticesCount,r):n.draw(!1,0,r>0?e.linesIndexCount/2:e.linesIndexCount,r);break;default:this._unIndexed?n.drawUnIndexed(!0,e.verticesStart,e.verticesCount,r):n.draw(!0,e.indexStart,e.indexCount,r)}}},r.prototype.registerBeforeRender=function(t){this.onBeforeRenderObservable.add(t)},r.prototype.unregisterBeforeRender=function(t){this.onBeforeRenderObservable.removeCallback(t)},r.prototype.registerAfterRender=function(t){this.onAfterRenderObservable.add(t)},r.prototype.unregisterAfterRender=function(t){this.onAfterRenderObservable.removeCallback(t)},r.prototype._getInstancesRenderList=function(t){var e=this.getScene();if(this._batchCache.mustReturn=!1,this._batchCache.renderSelf[t]=this.isEnabled()&&this.isVisible,this._batchCache.visibleInstances[t]=null,this._visibleInstances){var i=e.getRenderId(),r=e._isInIntermediateRendering()?this._visibleInstances.intermediateDefaultRenderId:this._visibleInstances.defaultRenderId;this._batchCache.visibleInstances[t]=this._visibleInstances[i];var n=this._renderId;if(!this._batchCache.visibleInstances[t]&&r&&(this._batchCache.visibleInstances[t]=this._visibleInstances[r],i=Math.max(r,i),n=Math.max(this._visibleInstances.selfDefaultRenderId,i)),this._batchCache.visibleInstances[t]&&this._batchCache.visibleInstances[t].length){if(this._renderIdForInstances[t]===i)return this._batchCache.mustReturn=!0,this._batchCache;i!==n&&(this._batchCache.renderSelf[t]=!1)}this._renderIdForInstances[t]=i}return this._batchCache},r.prototype._renderWithInstances=function(e,i,r,n,s){for(var o=r.visibleInstances[e._id],a=o.length+1,h=16*a*4,l=this._instancesBufferSize,c=this._instancesBuffer;this._instancesBufferSize<h;)this._instancesBufferSize*=2;this._instancesData&&l==this._instancesBufferSize||(this._instancesData=new Float32Array(this._instancesBufferSize/4));var u=0,p=0,d=this.getWorldMatrix();if(r.renderSelf[e._id]&&(d.copyToArray(this._instancesData,u),u+=16,p++),o)for(var f=0;f<o.length;f++){var m=o[f];m.getWorldMatrix().copyToArray(this._instancesData,u),u+=16,p++}c&&l==this._instancesBufferSize?c.updateDirectly(this._instancesData,0,p):(c&&c.dispose(),c=new t.Buffer(s,this._instancesData,!0,16,!1,!0),this._instancesBuffer=c,this.setVerticesBuffer(c.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(c.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(c.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(c.createVertexBuffer("world3",12,4))),s.bindBuffers(this.geometry.getVertexBuffers(),this.geometry.getIndexBuffer(),n),this._draw(e,i,p),s.unbindInstanceAttributes()},r.prototype._processRendering=function(t,e,i,r,n,s,o){var a=this.getScene(),h=a.getEngine();if(n)this._renderWithInstances(t,i,r,e,h);else if(r.renderSelf[t._id]&&(s&&s(!1,this.getWorldMatrix(),o),this._draw(t,i,this._overridenInstanceCount)),r.visibleInstances[t._id])for(var l=0;l<r.visibleInstances[t._id].length;l++){var c=r.visibleInstances[t._id][l],u=c.getWorldMatrix();s&&s(!0,u,o),this._draw(t,i)}},r.prototype.render=function(e,i){var r=this.getScene(),n=this._getInstancesRenderList(e._id);if(!n.mustReturn&&this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){this.onBeforeRenderObservable.notifyObservers(this);var s=r.getEngine(),o=null!==s.getCaps().instancedArrays&&null!==n.visibleInstances[e._id]&&void 0!==n.visibleInstances[e._id],a=e.getMaterial();if(a&&a.isReady(this,o)){var h=s.getDepthWrite();this.renderOutline&&(s.setDepthWrite(!1),r.getOutlineRenderer().render(e,n),s.setDepthWrite(h)),a._preBind();var l=a.getEffect(),c=r.forcePointsCloud?t.Material.PointFillMode:r.forceWireframe?t.Material.WireFrameFillMode:a.fillMode;this._bind(e,l,c);var u=this.getWorldMatrix();if(a.bind(u,this),i&&s.setAlphaMode(a.alphaMode),this._processRendering(e,l,c,n,o,this._onBeforeDraw,a),a.unbind(),this.renderOutline&&h&&(s.setDepthWrite(!0),s.setColorWrite(!1),r.getOutlineRenderer().render(e,n),s.setColorWrite(!0)),this.renderOverlay){var p=s.getAlphaMode();s.setAlphaMode(t.Engine.ALPHA_COMBINE),r.getOutlineRenderer().render(e,n,!0),s.setAlphaMode(p)}this.onAfterRenderObservable.notifyObservers(this)}}},r.prototype._onBeforeDraw=function(t,e,i){t&&i.bindOnlyWorldMatrix(e)},r.prototype.getEmittedParticleSystems=function(){for(var t=new Array,e=0;e<this.getScene().particleSystems.length;e++){var i=this.getScene().particleSystems[e];i.emitter===this&&t.push(i)}return t},r.prototype.getHierarchyEmittedParticleSystems=function(){var t=new Array,e=this.getDescendants();e.push(this);for(var i=0;i<this.getScene().particleSystems.length;i++){var r=this.getScene().particleSystems[i];e.indexOf(r.emitter)!==-1&&t.push(r)}return t},r.prototype._checkDelayState=function(){var e=this.getScene();this._geometry?this._geometry.load(e):this.delayLoadState===t.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=t.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(this,e))},r.prototype._queueLoad=function(e,i){var r=this;i._addPendingData(e);var n=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;t.Tools.LoadFile(this.delayLoadingFile,function(e){e instanceof ArrayBuffer?r._delayLoadingFunction(e,r):r._delayLoadingFunction(JSON.parse(e),r),r.delayLoadState=t.Engine.DELAYLOADSTATE_LOADED,i._removePendingData(r)},function(){},i.database,n)},r.prototype.isInFrustum=function(e){return this.delayLoadState!==t.Engine.DELAYLOADSTATE_LOADING&&(!!i.prototype.isInFrustum.call(this,e)&&(this._checkDelayState(),!0))},r.prototype.setMaterialByID=function(t){var e,i=this.getScene().materials;for(e=0;e<i.length;e++)if(i[e].id===t)return void(this.material=i[e]);var r=this.getScene().multiMaterials;for(e=0;e<r.length;e++)if(r[e].id===t)return void(this.material=r[e])},r.prototype.getAnimatables=function(){var t=[];return this.material&&t.push(this.material),this.skeleton&&t.push(this.skeleton),t},r.prototype.bakeTransformIntoVertices=function(e){if(this.isVerticesDataPresent(t.VertexBuffer.PositionKind)){var i=this.subMeshes.splice(0);this._resetPointsArrayCache();var r,n=this.getVerticesData(t.VertexBuffer.PositionKind),s=[];for(r=0;r<n.length;r+=3)t.Vector3.TransformCoordinates(t.Vector3.FromArray(n,r),e).toArray(s,r);if(this.setVerticesData(t.VertexBuffer.PositionKind,s,this.getVertexBuffer(t.VertexBuffer.PositionKind).isUpdatable()),this.isVerticesDataPresent(t.VertexBuffer.NormalKind)){for(n=this.getVerticesData(t.VertexBuffer.NormalKind),s=[],r=0;r<n.length;r+=3)t.Vector3.TransformNormal(t.Vector3.FromArray(n,r),e).normalize().toArray(s,r);this.setVerticesData(t.VertexBuffer.NormalKind,s,this.getVertexBuffer(t.VertexBuffer.NormalKind).isUpdatable()),e.m[0]*e.m[5]*e.m[10]<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=i}}},r.prototype.bakeCurrentTransformIntoVertices=function(){this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=t.Quaternion.Identity()),this._worldMatrix=t.Matrix.Identity()},r.prototype._resetPointsArrayCache=function(){this._positions=null},r.prototype._generatePointsArray=function(){if(this._positions)return!0;this._positions=[];var e=this.getVerticesData(t.VertexBuffer.PositionKind);if(!e)return!1;for(var i=0;i<e.length;i+=3)this._positions.push(t.Vector3.FromArray(e,i));return!0},r.prototype.clone=function(t,e,i,n){return void 0===n&&(n=!0),new r(t,this.getScene(),e,this,i,n)},r.prototype.dispose=function(t){for(this._geometry&&this._geometry.releaseForMesh(this,!0),this._instancesBuffer&&(this._instancesBuffer.dispose(),this._instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var e=this.getScene().highlightLayers,r=0;r<e.length;r++){var n=e[r];n&&(n.removeMesh(this),n.removeExcludedMesh(this))}i.prototype.dispose.call(this,t)},r.prototype.applyDisplacementMap=function(e,i,r,n){var s=this,o=this.getScene(),a=function(t){var e=document.createElement("canvas"),o=e.getContext("2d"),a=t.width,h=t.height;e.width=a,e.height=h,o.drawImage(t,0,0);var l=o.getImageData(0,0,a,h).data;s.applyDisplacementMapFromBuffer(l,a,h,i,r),n&&n(s)};t.Tools.LoadImage(e,a,function(){},o.database)},r.prototype.applyDisplacementMapFromBuffer=function(e,i,r,n,s){if(!this.isVerticesDataPresent(t.VertexBuffer.PositionKind)||!this.isVerticesDataPresent(t.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(t.VertexBuffer.UVKind))return void t.Tools.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing");for(var o=this.getVerticesData(t.VertexBuffer.PositionKind),a=this.getVerticesData(t.VertexBuffer.NormalKind),h=this.getVerticesData(t.VertexBuffer.UVKind),l=t.Vector3.Zero(),c=t.Vector3.Zero(),u=t.Vector2.Zero(),p=0;p<o.length;p+=3){t.Vector3.FromArrayToRef(o,p,l),t.Vector3.FromArrayToRef(a,p,c),t.Vector2.FromArrayToRef(h,p/3*2,u);var d=Math.abs(u.x)*i%i|0,f=Math.abs(u.y)*r%r|0,m=4*(d+f*i),_=e[m]/255,g=e[m+1]/255,y=e[m+2]/255,v=.3*_+.59*g+.11*y;c.normalize(),c.scaleInPlace(n+(s-n)*v),l=l.add(c),l.toArray(o,p)}t.VertexData.ComputeNormals(o,this.getIndices(),a),this.updateVerticesData(t.VertexBuffer.PositionKind,o),this.updateVerticesData(t.VertexBuffer.NormalKind,a)},r.prototype.convertToFlatShadedMesh=function(){var e,i,r=this.getVerticesDataKinds(),n=[],s=[],o=[],a=!1;for(e=0;e<r.length;e++){i=r[e];var h=this.getVertexBuffer(i);i!==t.VertexBuffer.NormalKind?(n[i]=h,s[i]=n[i].getData(),o[i]=[]):(a=h.isUpdatable(),r.splice(e,1),e--)}var l,c=this.subMeshes.slice(0),u=this.getIndices(),p=this.getTotalIndices();for(l=0;l<p;l++){var d=u[l];for(e=0;e<r.length;e++){i=r[e];for(var f=n[i].getStrideSize(),m=0;m<f;m++)o[i].push(s[i][d*f+m])}}var _=[],g=o[t.VertexBuffer.PositionKind];for(l=0;l<p;l+=3){u[l]=l,u[l+1]=l+1,u[l+2]=l+2;for(var y=t.Vector3.FromArray(g,3*l),v=t.Vector3.FromArray(g,3*(l+1)),x=t.Vector3.FromArray(g,3*(l+2)),b=y.subtract(v),P=x.subtract(v),T=t.Vector3.Normalize(t.Vector3.Cross(b,P)),S=0;S<3;S++)_.push(T.x),_.push(T.y),_.push(T.z)}for(this.setIndices(u),this.setVerticesData(t.VertexBuffer.NormalKind,_,a),e=0;e<r.length;e++)i=r[e],this.setVerticesData(i,o[i],n[i].isUpdatable());this.releaseSubMeshes();for(var A=0;A<c.length;A++){var C=c[A];new t.SubMesh(C.materialIndex,C.indexStart,C.indexCount,C.indexStart,C.indexCount,this)}this.synchronizeInstances()},r.prototype.convertToUnIndexedMesh=function(){var e,i,r=this.getVerticesDataKinds(),n=[],s=[],o=[];for(e=0;e<r.length;e++){i=r[e];var a=this.getVertexBuffer(i);n[i]=a,s[i]=n[i].getData(),o[i]=[]}var h,l=this.subMeshes.slice(0),c=this.getIndices(),u=this.getTotalIndices();for(h=0;h<u;h++){var p=c[h];for(e=0;e<r.length;e++){i=r[e];for(var d=n[i].getStrideSize(),f=0;f<d;f++)o[i].push(s[i][p*d+f])}}for(h=0;h<u;h+=3)c[h]=h,c[h+1]=h+1,c[h+2]=h+2;for(this.setIndices(c),e=0;e<r.length;e++)i=r[e],this.setVerticesData(i,o[i],n[i].isUpdatable());this.releaseSubMeshes();for(var m=0;m<l.length;m++){var _=l[m];new t.SubMesh(_.materialIndex,_.indexStart,_.indexCount,_.indexStart,_.indexCount,this)}this._unIndexed=!0,this.synchronizeInstances()},r.prototype.flipFaces=function(e){void 0===e&&(e=!1);var i,r=t.VertexData.ExtractFromMesh(this);if(e&&this.isVerticesDataPresent(t.VertexBuffer.NormalKind))for(i=0;i<r.normals.length;i++)r.normals[i]*=-1;var n;for(i=0;i<r.indices.length;i+=3)n=r.indices[i+1],r.indices[i+1]=r.indices[i+2],r.indices[i+2]=n;r.applyToMesh(this)},r.prototype.createInstance=function(e){return new t.InstancedMesh(e,this)},r.prototype.synchronizeInstances=function(){for(var t=0;t<this.instances.length;t++){this.instances[t]._syncSubMeshes()}},r.prototype.simplify=function(e,i,r,n){void 0===i&&(i=!0),void 0===r&&(r=t.SimplificationType.QUADRATIC),this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:i,mesh:this,simplificationType:r,successCallback:n})},r.prototype.optimizeIndices=function(e){for(var i=this,r=this.getIndices(),n=this.getVerticesData(t.VertexBuffer.PositionKind),s=[],o=0;o<n.length;o+=3)s.push(t.Vector3.FromArray(n,o));var a=[];t.AsyncLoop.SyncAsyncForLoop(s.length,40,function(t){for(var e=s.length-1-t,i=s[e],r=0;r<e;++r){var n=s[r];if(i.equals(n)){a[e]=r;break}}},function(){for(var t=0;t<r.length;++t)r[t]=a[r[t]]||r[t];var n=i.subMeshes.slice(0);i.setIndices(r),i.subMeshes=n,e&&e(i)})},r.Parse=function(e,i,n){var s=new r(e.name,i);if(s.id=e.id,t.Tags.AddTagsTo(s,e.tags),s.position=t.Vector3.FromArray(e.position),void 0!==e.metadata&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=t.Quaternion.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=t.Vector3.FromArray(e.rotation)),s.scaling=t.Vector3.FromArray(e.scaling),e.localMatrix?s.setPivotMatrix(t.Matrix.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(t.Matrix.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,void 0!==e.applyFog&&(s.applyFog=e.applyFog),void 0!==e.pickable&&(s.isPickable=e.pickable),void 0!==e.alphaIndex&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,s.billboardMode=e.billboardMode,void 0!==e.visibility&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,void 0!==e.isBlocker&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingFreezeWorldMatrix=e.freezeWorldMatrix),e.parentId&&(s._waitingParentId=e.parentId),void 0!==e.actions&&(s._waitingActions=e.actions),void 0!==e.overlayAlpha&&(s.overlayAlpha=e.overlayAlpha),void 0!==e.overlayColor&&(s.overlayColor=t.Color3.FromArray(e.overlayColor)),void 0!==e.renderOverlay&&(s.renderOverlay=e.renderOverlay),s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=t.Engine.DELAYLOADSTATE_NOTLOADED,s.delayLoadingFile=n+e.delayLoadingFile,s._boundingInfo=new t.BoundingInfo(t.Vector3.FromArray(e.boundingBoxMinimum),t.Vector3.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(t.VertexBuffer.UVKind),e.hasUVs2&&s._delayInfo.push(t.VertexBuffer.UV2Kind),e.hasUVs3&&s._delayInfo.push(t.VertexBuffer.UV3Kind),e.hasUVs4&&s._delayInfo.push(t.VertexBuffer.UV4Kind),e.hasUVs5&&s._delayInfo.push(t.VertexBuffer.UV5Kind),e.hasUVs6&&s._delayInfo.push(t.VertexBuffer.UV6Kind),e.hasColors&&s._delayInfo.push(t.VertexBuffer.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(t.VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(t.VertexBuffer.MatricesWeightsKind),s._delayLoadingFunction=t.Geometry.ImportGeometry,t.SceneLoader.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):t.Geometry.ImportGeometry(e,s),e.materialId?s.setMaterialByID(e.materialId):s.material=null,e.skeletonId>-1&&(s.skeleton=i.getLastSkeletonByID(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(var o=0;o<e.animations.length;o++){var a=e.animations[o];s.animations.push(t.Animation.Parse(a))}t.Node.ParseAnimationRanges(s,e,i)}if(e.autoAnimate&&i.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&(s.physicsImpostor=new t.PhysicsImpostor(s,e.physicsImpostor,{mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution},i)),e.instances)for(var h=0;h<e.instances.length;h++){var l=e.instances[h],c=s.createInstance(l.name);if(t.Tags.AddTagsTo(c,l.tags),c.position=t.Vector3.FromArray(l.position),l.parentId&&(c._waitingParentId=l.parentId),l.rotationQuaternion?c.rotationQuaternion=t.Quaternion.FromArray(l.rotationQuaternion):l.rotation&&(c.rotation=t.Vector3.FromArray(l.rotation)),c.scaling=t.Vector3.FromArray(l.scaling),c.checkCollisions=s.checkCollisions,e.animations){for(o=0;o<e.animations.length;o++)a=e.animations[o],c.animations.push(t.Animation.Parse(a));t.Node.ParseAnimationRanges(c,e,i)}}return s},r.CreateRibbon=function(e,i,r,n,s,o,a,h,l){return t.MeshBuilder.CreateRibbon(e,{pathArray:i,closeArray:r,closePath:n,offset:s,updatable:a,sideOrientation:h,instance:l},o)},r.CreateDisc=function(e,i,r,n,s,o){var a={radius:i,tessellation:r,sideOrientation:o,updatable:s};return t.MeshBuilder.CreateDisc(e,a,n)},r.CreateBox=function(e,i,r,n,s){var o={size:i,sideOrientation:s,updatable:n};return t.MeshBuilder.CreateBox(e,o,r)},r.CreateSphere=function(e,i,r,n,s,o){var a={segments:i,diameterX:r,diameterY:r,diameterZ:r,sideOrientation:o,updatable:s};return t.MeshBuilder.CreateSphere(e,a,n)},r.CreateCylinder=function(e,i,n,s,o,a,h,l,c){void 0!==h&&h instanceof t.Scene||(void 0!==h&&(c=l||r.DEFAULTSIDE,l=h),h=a,a=1);var u={height:i,diameterTop:n,diameterBottom:s,tessellation:o,subdivisions:a,sideOrientation:c,updatable:l};return t.MeshBuilder.CreateCylinder(e,u,h)},r.CreateTorus=function(e,i,r,n,s,o,a){var h={diameter:i,thickness:r,tessellation:n,sideOrientation:a,updatable:o};return t.MeshBuilder.CreateTorus(e,h,s)},r.CreateTorusKnot=function(e,i,r,n,s,o,a,h,l,c){var u={radius:i,tube:r,radialSegments:n,tubularSegments:s,p:o,q:a,sideOrientation:c,updatable:l};return t.MeshBuilder.CreateTorusKnot(e,u,h)},r.CreateLines=function(e,i,r,n,s){var o={points:i,updatable:n,instance:s};return t.MeshBuilder.CreateLines(e,o,r)},r.CreateDashedLines=function(e,i,r,n,s,o,a,h){var l={points:i,dashSize:r,gapSize:n,dashNb:s,updatable:a,instance:h};return t.MeshBuilder.CreateDashedLines(e,l,o)},r.ExtrudeShape=function(e,i,n,s,o,a,h,l,c,u){var p={shape:i,path:n,scale:s,rotation:o,cap:0===a?0:a||r.NO_CAP,sideOrientation:c,instance:u,updatable:l};return t.MeshBuilder.ExtrudeShape(e,p,h)},r.ExtrudeShapeCustom=function(e,i,n,s,o,a,h,l,c,u,p,d){var f={shape:i,path:n,scaleFunction:s,rotationFunction:o,ribbonCloseArray:a,ribbonClosePath:h,cap:0===l?0:l||r.NO_CAP,sideOrientation:p,instance:d,updatable:u};return t.MeshBuilder.ExtrudeShapeCustom(e,f,c)},r.CreateLathe=function(e,i,r,n,s,o,a){var h={shape:i,radius:r,tessellation:n,sideOrientation:a,updatable:o};return t.MeshBuilder.CreateLathe(e,h,s)},r.CreatePlane=function(e,i,r,n,s){var o={size:i,width:i,height:i,sideOrientation:s,updatable:n};return t.MeshBuilder.CreatePlane(e,o,r)},r.CreateGround=function(e,i,r,n,s,o){var a={width:i,height:r,subdivisions:n,updatable:o};return t.MeshBuilder.CreateGround(e,a,s)},r.CreateTiledGround=function(e,i,r,n,s,o,a,h,l){var c={xmin:i,zmin:r,xmax:n,zmax:s,subdivisions:o,precision:a,updatable:l};return t.MeshBuilder.CreateTiledGround(e,c,h)},r.CreateGroundFromHeightMap=function(e,i,r,n,s,o,a,h,l,c){var u={width:r,height:n,subdivisions:s,minHeight:o,maxHeight:a,updatable:l,onReady:c};return t.MeshBuilder.CreateGroundFromHeightMap(e,i,u,h)},r.CreateTube=function(e,i,r,n,s,o,a,h,l,c){var u={path:i,radius:r,tessellation:n,radiusFunction:s,arc:1,cap:o,updatable:h,sideOrientation:l,instance:c};return t.MeshBuilder.CreateTube(e,u,a)},r.CreatePolyhedron=function(e,i,r){return t.MeshBuilder.CreatePolyhedron(e,i,r)},r.CreateIcoSphere=function(e,i,r){return t.MeshBuilder.CreateIcoSphere(e,i,r)},r.CreateDecal=function(e,i,r,n,s,o){var a={position:r,normal:n,size:s,angle:o};return t.MeshBuilder.CreateDecal(e,i,a)},r.prototype.setPositionsForCPUSkinning=function(){var e;return this._sourcePositions||(e=this.getVerticesData(t.VertexBuffer.PositionKind),this._sourcePositions=new Float32Array(e),this.getVertexBuffer(t.VertexBuffer.PositionKind).isUpdatable()||this.setVerticesData(t.VertexBuffer.PositionKind,e,!0)),this._sourcePositions},r.prototype.setNormalsForCPUSkinning=function(){var e;return this._sourceNormals||(e=this.getVerticesData(t.VertexBuffer.NormalKind),this._sourceNormals=new Float32Array(e),this.getVertexBuffer(t.VertexBuffer.NormalKind).isUpdatable()||this.setVerticesData(t.VertexBuffer.NormalKind,e,!0)),this._sourceNormals},r.prototype.applySkeleton=function(e){if(this.geometry&&this.geometry._softwareSkinningRenderId!=this.getScene().getRenderId()){if(this.geometry._softwareSkinningRenderId=this.getScene().getRenderId(),!this.isVerticesDataPresent(t.VertexBuffer.PositionKind))return this;if(!this.isVerticesDataPresent(t.VertexBuffer.NormalKind))return this;if(!this.isVerticesDataPresent(t.VertexBuffer.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(t.VertexBuffer.MatricesWeightsKind))return this;if(!this._sourcePositions){var i=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=i}this._sourceNormals||this.setNormalsForCPUSkinning();var r=this.getVerticesData(t.VertexBuffer.PositionKind);r instanceof Float32Array||(r=new Float32Array(r));var n=this.getVerticesData(t.VertexBuffer.NormalKind);n instanceof Float32Array||(n=new Float32Array(n));for(var s,o=this.getVerticesData(t.VertexBuffer.MatricesIndicesKind),a=this.getVerticesData(t.VertexBuffer.MatricesWeightsKind),h=this.numBoneInfluencers>4,l=h?this.getVerticesData(t.VertexBuffer.MatricesIndicesExtraKind):null,c=h?this.getVerticesData(t.VertexBuffer.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),p=t.Vector3.Zero(),d=new t.Matrix,f=new t.Matrix,m=0,_=0;_<r.length;_+=3,m+=4){var g;for(s=0;s<4&&(g=a[m+s])>0;s++)t.Matrix.FromFloat32ArrayToRefScaled(u,16*o[m+s],g,f),d.addToSelf(f);if(h)for(s=0;s<4&&(g=c[m+s])>0;s++)t.Matrix.FromFloat32ArrayToRefScaled(u,16*l[m+s],g,f),d.addToSelf(f);t.Vector3.TransformCoordinatesFromFloatsToRef(this._sourcePositions[_],this._sourcePositions[_+1],this._sourcePositions[_+2],d,p),p.toArray(r,_),t.Vector3.TransformNormalFromFloatsToRef(this._sourceNormals[_],this._sourceNormals[_+1],this._sourceNormals[_+2],d,p),p.toArray(n,_),d.reset()}return this.updateVerticesData(t.VertexBuffer.PositionKind,r),this.updateVerticesData(t.VertexBuffer.NormalKind,n),this}},r.MinMax=function(t){var e=null,i=null;return t.forEach(function(t,r,n){var s=t.getBoundingInfo().boundingBox;e?(e.MinimizeInPlace(s.minimumWorld),i.MaximizeInPlace(s.maximumWorld)):(e=s.minimumWorld,i=s.maximumWorld)}),{min:e,max:i}},r.Center=function(e){var i=e instanceof Array?t.Mesh.MinMax(e):e;return t.Vector3.Center(i.min,i.max)},r.MergeMeshes=function(e,i,n,s){void 0===i&&(i=!0);var o;if(!n){var a=0;for(o=0;o<e.length;o++)if(e[o]&&(a+=e[o].getTotalVertices())>65536)return t.Tools.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}var h,l,c;for(o=0;o<e.length;o++)e[o]&&(e[o].computeWorldMatrix(!0),l=t.VertexData.ExtractFromMesh(e[o],!0),l.transform(e[o].getWorldMatrix()),h?h.merge(l):(h=l,c=e[o]));if(s||(s=new r(c.name+"_merged",c.getScene())),h.applyToMesh(s),s.material=c.material,s.checkCollisions=c.checkCollisions,i)for(o=0;o<e.length;o++)e[o]&&e[o].dispose();return s},r._FRONTSIDE=0,r._BACKSIDE=1,r._DOUBLESIDE=2,r._DEFAULTSIDE=0,r._NO_CAP=0,r._CAP_START=1,r._CAP_END=2,r._CAP_ALL=3,r}(t.AbstractMesh);t.Mesh=i}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i,r,n,s,o,a){void 0===a&&(a=!0),this.materialIndex=t,this.verticesStart=e,this.verticesCount=i,this.indexStart=r,this.indexCount=n,this._renderId=0,this._mesh=s,this._renderingMesh=o||s,s.subMeshes.push(this),this._trianglePlanes=[],this._id=s.subMeshes.length-1,a&&(this.refreshBoundingInfo(),s.computeWorldMatrix(!0))}return Object.defineProperty(e.prototype,"IsGlobal",{get:function(){return 0===this.verticesStart&&this.verticesCount==this._mesh.getTotalVertices()},enumerable:!0,configurable:!0}),e.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},e.prototype.getMesh=function(){return this._mesh},e.prototype.getRenderingMesh=function(){return this._renderingMesh},e.prototype.getMaterial=function(){var e=this._renderingMesh.material;if(e&&e instanceof t.MultiMaterial){return e.getSubMaterial(this.materialIndex)}return e?e:this._mesh.getScene().defaultMaterial},e.prototype.refreshBoundingInfo=function(){if(this._lastColliderWorldVertices=null,!this.IsGlobal){var e=this._renderingMesh.getVerticesData(t.VertexBuffer.PositionKind);if(!e)return void(this._boundingInfo=this._mesh._boundingInfo);var i,r=this._renderingMesh.getIndices();i=0===this.indexStart&&this.indexCount===r.length?{minimum:this._renderingMesh.getBoundingInfo().minimum.clone(),maximum:this._renderingMesh.getBoundingInfo().maximum.clone()}:t.Tools.ExtractMinAndMaxIndexed(e,r,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias),this._boundingInfo=new t.BoundingInfo(i.minimum,i.maximum)}},e.prototype._checkCollision=function(t){return this.getBoundingInfo()._checkCollision(t)},e.prototype.updateBoundingInfo=function(t){this.getBoundingInfo()||this.refreshBoundingInfo(),this.getBoundingInfo().update(t)},e.prototype.isInFrustum=function(t){return this.getBoundingInfo().isInFrustum(t)},e.prototype.isCompletelyInFrustum=function(t){return this.getBoundingInfo().isCompletelyInFrustum(t)},e.prototype.render=function(t){this._renderingMesh.render(this,t)},e.prototype.getLinesIndexBuffer=function(t,e){if(!this._linesIndexBuffer){for(var i=[],r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(t[r],t[r+1],t[r+1],t[r+2],t[r+2],t[r]);this._linesIndexBuffer=e.createIndexBuffer(i),this.linesIndexCount=i.length}return this._linesIndexBuffer},e.prototype.canIntersects=function(t){return t.intersectsBox(this.getBoundingInfo().boundingBox)},e.prototype.intersects=function(e,i,r,n){var s=null;if(this._mesh instanceof t.LinesMesh)for(var o=this._mesh,a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){var h=i[r[a]],l=i[r[a+1]],c=e.intersectionSegment(h,l,o.intersectionThreshold);if(!(c<0)&&(n||!s||c<s.distance)&&(s=new t.IntersectionInfo(null,null,c),n))break}else for(var a=this.indexStart;a<this.indexStart+this.indexCount;a+=3){var h=i[r[a]],l=i[r[a+1]],u=i[r[a+2]],p=e.intersectsTriangle(h,l,u);if(p){if(p.distance<0)continue;if((n||!s||p.distance<s.distance)&&(s=p,s.faceId=a/3,n))break}}return s},e.prototype.clone=function(i,r){var n=new e(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,i,r,!1);return this.IsGlobal||(n._boundingInfo=new t.BoundingInfo(this.getBoundingInfo().minimum,this.getBoundingInfo().maximum)),n},e.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1)},e.CreateFromIndices=function(t,i,r,n,s){var o=Number.MAX_VALUE,a=-Number.MAX_VALUE;s=s||n;for(var h=s.getIndices(),l=i;l<i+r;l++){var c=h[l];c<o&&(o=c),c>a&&(a=c)}return new e(t,o,a-o+1,i,r,n,s)},e}();t.SubMesh=e}(r||(r={}));var r;!function(t){var e=function(){function e(){}return e.updateSideOrientation=function(e,i){return e==t.Mesh.DOUBLESIDE?t.Mesh.DOUBLESIDE:void 0===e||null===e?t.Mesh.FRONTSIDE:e},e.CreateBox=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateBox(i).applyToMesh(n,i.updatable),n},e.CreateSphere=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateSphere(i).applyToMesh(n,i.updatable),n},e.CreateDisc=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateDisc(i).applyToMesh(n,i.updatable),n},e.CreateIcoSphere=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateIcoSphere(i).applyToMesh(n,i.updatable),n},e.CreateRibbon=function(e,i,r){var n=i.pathArray,s=i.closeArray,o=i.closePath,a=(i.offset,this.updateSideOrientation(i.sideOrientation,r)),h=i.instance,l=i.updatable;if(h){t.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,t.Tmp.Vector3[0]),t.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,t.Tmp.Vector3[1]);var c=function(e){for(var i=n[0].length,r=0,s=h.sideOrientation===t.Mesh.DOUBLESIDE?2:1,o=1;o<=s;o++)for(var a=0;a<n.length;a++){var l=n[a],c=l.length;i=i<c?i:c;for(var u=0;u<i;)e[r]=l[u].x,e[r+1]=l[u].y,e[r+2]=l[u].z,l[u].x<t.Tmp.Vector3[0].x&&(t.Tmp.Vector3[0].x=l[u].x),l[u].x>t.Tmp.Vector3[1].x&&(t.Tmp.Vector3[1].x=l[u].x),l[u].y<t.Tmp.Vector3[0].y&&(t.Tmp.Vector3[0].y=l[u].y),l[u].y>t.Tmp.Vector3[1].y&&(t.Tmp.Vector3[1].y=l[u].y),l[u].z<t.Tmp.Vector3[0].z&&(t.Tmp.Vector3[0].z=l[u].z),l[u].z>t.Tmp.Vector3[1].z&&(t.Tmp.Vector3[1].z=l[u].z),u++,r+=3;h._closePath&&(e[r]=l[0].x,e[r+1]=l[0].y,e[r+2]=l[0].z,r+=3)}},u=h.getVerticesData(t.VertexBuffer.PositionKind);if(c(u),h._boundingInfo=new t.BoundingInfo(t.Tmp.Vector3[0],t.Tmp.Vector3[1]),h._boundingInfo.update(h._worldMatrix),h.updateVerticesData(t.VertexBuffer.PositionKind,u,!1,!1),!h.areNormalsFrozen){var p=h.getIndices(),d=h.getVerticesData(t.VertexBuffer.NormalKind);if(t.VertexData.ComputeNormals(u,p,d),h._closePath)for(var f=0,m=0,_=0;_<n.length;_++)f=3*h._idx[_],m=_+1<n.length?3*(h._idx[_+1]-1):d.length-3,d[f]=.5*(d[f]+d[m]),d[f+1]=.5*(d[f+1]+d[m+1]),d[f+2]=.5*(d[f+2]+d[m+2]),d[m]=d[f],d[m+1]=d[f+1],d[m+2]=d[f+2];h.updateVerticesData(t.VertexBuffer.NormalKind,d,!1,!1)}return h}var g=new t.Mesh(e,r);g.sideOrientation=a;var y=t.VertexData.CreateRibbon(i);return o&&(g._idx=y._idx),g._closePath=o,g._closeArray=s,y.applyToMesh(g,l),g},e.CreateCylinder=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateCylinder(i).applyToMesh(n,i.updatable),n},e.CreateTorus=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateTorus(i).applyToMesh(n,i.updatable),n},e.CreateTorusKnot=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreateTorusKnot(i).applyToMesh(n,i.updatable),n},e.CreateLineSystem=function(e,i,r){var n=i.instance,s=i.lines;if(n){var o=function(t){for(var e=0,i=0;i<s.length;i++)for(var r=s[i],n=0;n<r.length;n++)t[e]=r[n].x,t[e+1]=r[n].y,t[e+2]=r[n].z,e+=3};return n.updateMeshPositions(o,!1),n}var a=new t.LinesMesh(e,r);return t.VertexData.CreateLineSystem(i).applyToMesh(a,i.updatable),a},e.CreateLines=function(t,i,r){return e.CreateLineSystem(t,{lines:[i.points],updatable:i.updatable,instance:i.instance},r)},e.CreateDashedLines=function(e,i,r){var n=i.points,s=i.instance,o=i.gapSize,a=(i.dashNb,i.dashSize);if(s){var h=function(e){var i=t.Vector3.Zero(),r=e.length/6,o=0,a=0,h=0,l=0,c=0,u=0,p=0,d=0;for(p=0;p<n.length-1;p++)n[p+1].subtractToRef(n[p],i),o+=i.length();for(h=o/r,l=s.dashSize*h/(s.dashSize+s.gapSize),p=0;p<n.length-1;p++)for(n[p+1].subtractToRef(n[p],i),a=Math.floor(i.length()/h),i.normalize(),d=0;d<a&&u<e.length;)c=h*d,e[u]=n[p].x+c*i.x,e[u+1]=n[p].y+c*i.y,e[u+2]=n[p].z+c*i.z,e[u+3]=n[p].x+(c+l)*i.x,e[u+4]=n[p].y+(c+l)*i.y,e[u+5]=n[p].z+(c+l)*i.z,u+=6,d++;for(;u<e.length;)e[u]=n[p].x,e[u+1]=n[p].y,e[u+2]=n[p].z,u+=3};return s.updateMeshPositions(h,!1),s}var l=new t.LinesMesh(e,r);return t.VertexData.CreateDashedLines(i).applyToMesh(l,i.updatable),l.dashSize=a,l.gapSize=o,l},e.ExtrudeShape=function(i,r,n){var s=r.path,o=r.shape,a=r.scale||1,h=r.rotation||0,l=0===r.cap?0:r.cap||t.Mesh.NO_CAP,c=r.updatable,u=this.updateSideOrientation(r.sideOrientation,n),p=r.instance,d=r.invertUV||!1;return e._ExtrudeShapeGeneric(i,o,s,a,h,null,null,!1,!1,l,!1,n,c,u,p,d)},e.ExtrudeShapeCustom=function(i,r,n){var s=r.path,o=r.shape,a=r.scaleFunction||function(){return 1},h=r.rotationFunction||function(){return 0},l=r.ribbonCloseArray||!1,c=r.ribbonClosePath||!1,u=0===r.cap?0:r.cap||t.Mesh.NO_CAP,p=r.updatable,d=this.updateSideOrientation(r.sideOrientation,n),f=r.instance,m=r.invertUV||!1;return e._ExtrudeShapeGeneric(i,o,s,null,null,a,h,l,c,u,!0,n,p,d,f,m)},e.CreateLathe=function(i,r,n){var s,o=r.arc<=0||r.arc>1?1:r.arc||1,a=void 0===r.closed||r.closed,h=r.shape,l=r.radius||1,c=r.tessellation||64,u=r.updatable,p=this.updateSideOrientation(r.sideOrientation,n),d=r.cap||t.Mesh.NO_CAP,f=2*Math.PI,m=new Array,_=r.invertUV||!1,g=0,y=0,v=f/c*o,x=new Array;for(g=0;g<=c;g++){var x=[];for(d!=t.Mesh.CAP_START&&d!=t.Mesh.CAP_ALL||(x.push(new t.Vector3(0,h[0].y,0)),x.push(new t.Vector3(Math.cos(g*v)*h[0].x*l,h[0].y,Math.sin(g*v)*h[0].x*l))),y=0;y<h.length;y++)s=new t.Vector3(Math.cos(g*v)*h[y].x*l,h[y].y,Math.sin(g*v)*h[y].x*l),x.push(s);d!=t.Mesh.CAP_END&&d!=t.Mesh.CAP_ALL||(x.push(new t.Vector3(Math.cos(g*v)*h[h.length-1].x*l,h[h.length-1].y,Math.sin(g*v)*h[h.length-1].x*l)),x.push(new t.Vector3(0,h[h.length-1].y,0))),m.push(x)}return e.CreateRibbon(i,{pathArray:m,closeArray:a,sideOrientation:p,updatable:u,invertUV:_},n)},e.CreatePlane=function(e,i,r){var n=new t.Mesh(e,r);if(i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreatePlane(i).applyToMesh(n,i.updatable),i.sourcePlane){n.translate(i.sourcePlane.normal,i.sourcePlane.d);var s=Math.acos(t.Vector3.Dot(i.sourcePlane.normal,t.Axis.Z)),o=t.Vector3.Cross(t.Axis.Z,i.sourcePlane.normal);n.rotate(o,s)}return n},e.CreateGround=function(e,i,r){var n=new t.GroundMesh(e,r);return n._setReady(!1),n._subdivisionsX=i.subdivisionsX||i.subdivisions||1,n._subdivisionsY=i.subdivisionsY||i.subdivisions||1,n._width=i.width||1,n._height=i.height||1,n._maxX=n._width/2,n._maxZ=n._height/2,n._minX=-n._maxX,n._minZ=-n._maxZ,t.VertexData.CreateGround(i).applyToMesh(n,i.updatable),n._setReady(!0),n},e.CreateTiledGround=function(e,i,r){var n=new t.Mesh(e,r);return t.VertexData.CreateTiledGround(i).applyToMesh(n,i.updatable),n},e.CreateGroundFromHeightMap=function(e,i,r,n){var s=r.width||10,o=r.height||10,a=r.subdivisions||1,h=r.minHeight||0,l=r.maxHeight||10,c=r.updatable,u=r.onReady,p=new t.GroundMesh(e,n);p._subdivisionsX=a,p._subdivisionsY=a,p._width=s,p._height=o,p._maxX=p._width/2,p._maxZ=p._height/2,p._minX=-p._maxX,p._minZ=-p._maxZ,p._setReady(!1);var d=function(e){var i=document.createElement("canvas"),r=i.getContext("2d"),n=e.width,d=e.height;i.width=n,i.height=d,r.drawImage(e,0,0);var f=r.getImageData(0,0,n,d).data;t.VertexData.CreateGroundFromHeightMap({width:s,height:o,subdivisions:a,minHeight:h,maxHeight:l,buffer:f,bufferWidth:n,bufferHeight:d}).applyToMesh(p,c),p._setReady(!0),u&&u(p)};return t.Tools.LoadImage(i,d,function(){},n.database),p},e.CreateTube=function(i,r,n){var s=r.path,o=r.radius||1,a=r.tessellation||64,h=r.radiusFunction,l=r.cap||t.Mesh.NO_CAP,c=r.invertUV||!1,u=r.updatable,p=this.updateSideOrientation(r.sideOrientation,n),d=r.instance;r.arc=r.arc<=0||r.arc>1?1:r.arc||1;var f,m,_=function(e,i,r,n,s,o,a,h){for(var l,c,u,p,d=i.getTangents(),f=i.getNormals(),m=i.getDistances(),_=2*Math.PI,g=_/s*h,y=function(){return n},v=o||y,x=t.Tmp.Matrix[0],b=a===t.Mesh._NO_CAP||a===t.Mesh.CAP_END?0:2,P=0;P<e.length;P++){c=v(P,m[P]),l=Array(),u=f[P];for(var T=0;T<s;T++)t.Matrix.RotationAxisToRef(d[P],g*T,x),p=l[T]?l[T]:t.Vector3.Zero(),t.Vector3.TransformCoordinatesToRef(u,x,p),p.scaleInPlace(c).addInPlace(e[P]),l[T]=p;r[b]=l,b++}var S=function(t,i){for(var r=Array(),n=0;n<t;n++)r.push(e[i]);return r};switch(a){case t.Mesh.NO_CAP:break;case t.Mesh.CAP_START:r[0]=S(s,0),r[1]=r[2].slice(0);break;case t.Mesh.CAP_END:r[b]=r[b-1].slice(0),r[b+1]=S(s,e.length-1);break;case t.Mesh.CAP_ALL:r[0]=S(s,0),r[1]=r[2].slice(0),r[b]=r[b-1].slice(0),r[b+1]=S(s,e.length-1)}return r};if(d){var g=r.arc||d.arc;return f=d.path3D.update(s),m=_(s,f,d.pathArray,o,d.tessellation,h,d.cap,g),d=e.CreateRibbon(null,{pathArray:m,instance:d}),d.path3D=f,d.pathArray=m,d.arc=g,d}f=new t.Path3D(s);var y=new Array;l=l<0||l>3?0:l,m=_(s,f,y,o,a,h,l,r.arc);var v=e.CreateRibbon(i,{pathArray:m,closePath:!0,closeArray:!1,updatable:u,sideOrientation:p,invertUV:c},n);return v.pathArray=m,v.path3D=f,v.tessellation=a,v.cap=l,v.arc=r.arc,v},e.CreatePolyhedron=function(e,i,r){var n=new t.Mesh(e,r);return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),t.VertexData.CreatePolyhedron(i).applyToMesh(n,i.updatable),n},e.CreateDecal=function(e,i,r){var n=i.getIndices(),s=i.getVerticesData(t.VertexBuffer.PositionKind),o=i.getVerticesData(t.VertexBuffer.NormalKind),a=r.position||t.Vector3.Zero(),h=r.normal||t.Vector3.Up(),l=r.size||new t.Vector3(1,1,1),c=r.angle||0;if(!h){var u=new t.Vector3(0,0,1),p=i.getScene().activeCamera,d=t.Vector3.TransformCoordinates(u,p.getWorldMatrix());h=p.globalPosition.subtract(d)}var f=-Math.atan2(h.z,h.x)-Math.PI/2,m=Math.sqrt(h.x*h.x+h.z*h.z),_=Math.atan2(h.y,m),g=t.Matrix.RotationYawPitchRoll(f,_,c).multiply(t.Matrix.Translation(a.x,a.y,a.z)),y=t.Matrix.Invert(g),v=i.getWorldMatrix(),x=v.multiply(y),b=new t.VertexData;b.indices=[],b.positions=[],b.normals=[],b.uvs=[];for(var P=0,T=function(e){var i=n[e],r=new t.PositionNormalVertex;return r.position=new t.Vector3(s[3*i],s[3*i+1],s[3*i+2]),r.position=t.Vector3.TransformCoordinates(r.position,x),r.normal=new t.Vector3(o[3*i],o[3*i+1],o[3*i+2]),r},S=function(e,i){if(0===e.length)return e;for(var r=.5*Math.abs(t.Vector3.Dot(l,i)),n=function(e,n){var s=t.Vector3.GetClipFactor(e.position,n.position,i,r);return new t.PositionNormalVertex(t.Vector3.Lerp(e.position,n.position,s),t.Vector3.Lerp(e.normal,n.normal,s))},s=new Array,o=0;o<e.length;o+=3){var a,h,c,u,p,d,f,m=t.Vector3.Dot(e[o].position,i)-r,_=t.Vector3.Dot(e[o+1].position,i)-r,g=t.Vector3.Dot(e[o+2].position,i)-r;switch(a=m>0,h=_>0,c=g>0,(a?1:0)+(h?1:0)+(c?1:0)){case 0:s.push(e[o]),s.push(e[o+1]),s.push(e[o+2]);break;case 1:if(a&&(u=e[o+1],p=e[o+2],d=n(e[o],u),f=n(e[o],p)),h){u=e[o],p=e[o+2],d=n(e[o+1],u),f=n(e[o+1],p),s.push(d),s.push(p.clone()),s.push(u.clone()),s.push(p.clone()),s.push(d.clone()),s.push(f);break}c&&(u=e[o],p=e[o+1],d=n(e[o+2],u),f=n(e[o+2],p)),s.push(u.clone()),s.push(p.clone()),s.push(d),s.push(f),s.push(d.clone()),s.push(p.clone());break;case 2:a||(u=e[o].clone(),p=n(u,e[o+1]),d=n(u,e[o+2]),s.push(u),s.push(p),s.push(d)),h||(u=e[o+1].clone(),p=n(u,e[o+2]),d=n(u,e[o]),s.push(u),s.push(p),s.push(d)),c||(u=e[o+2].clone(),p=n(u,e[o]),d=n(u,e[o+1]),s.push(u),s.push(p),s.push(d));break;case 3:}}return s},A=0;A<n.length;A+=3){var C=new Array;if(C.push(T(A)),C.push(T(A+1)),C.push(T(A+2)),C=S(C,new t.Vector3(1,0,0)),C=S(C,new t.Vector3(-1,0,0)),C=S(C,new t.Vector3(0,1,0)),C=S(C,new t.Vector3(0,-1,0)),C=S(C,new t.Vector3(0,0,1)),C=S(C,new t.Vector3(0,0,-1)),0!==C.length)for(var E=0;E<C.length;E++){var M=C[E];b.indices.push(P),M.position.toArray(b.positions,3*P),M.normal.toArray(b.normals,3*P),b.uvs.push(.5+M.position.x/l.x),b.uvs.push(.5+M.position.y/l.y),P++}}var D=new t.Mesh(e,i.getScene());return b.applyToMesh(D),D.position=a.clone(),D.rotation=new t.Vector3(_,f,c),D},e._ExtrudeShapeGeneric=function(i,r,n,s,o,a,h,l,c,u,p,d,f,m,_,g){var y,v,x=function(e,i,r,n,s,o,a,h,l,c){for(var u=r.getTangents(),p=r.getNormals(),d=r.getBinormals(),f=r.getDistances(),m=0,_=function(){return s},g=function(){return o},y=c?h:g,v=c?a:_,x=l===t.Mesh.NO_CAP||l===t.Mesh.CAP_END?0:2,b=t.Tmp.Matrix[0],P=0;P<i.length;P++){for(var T=new Array,S=y(P,f[P]),A=v(P,f[P]),C=0;C<e.length;C++){t.Matrix.RotationAxisToRef(u[P],m,b);var E=u[P].scale(e[C].z).add(p[P].scale(e[C].x)).add(d[P].scale(e[C].y)),M=T[C]?T[C]:t.Vector3.Zero();t.Vector3.TransformCoordinatesToRef(E,b,M),M.scaleInPlace(A).addInPlace(i[P]),T[C]=M}n[x]=T,m+=S,x++}var D=function(e){var i,r=Array(),n=t.Vector3.Zero();for(i=0;i<e.length;i++)n.addInPlace(e[i]);for(n.scaleInPlace(1/e.length),i=0;i<e.length;i++)r.push(n);return r};switch(l){case t.Mesh.NO_CAP:break;case t.Mesh.CAP_START:n[0]=D(n[2]),n[1]=n[2].slice(0);break;case t.Mesh.CAP_END:n[x]=n[x-1],n[x+1]=D(n[x-1]);break;case t.Mesh.CAP_ALL:n[0]=D(n[2]),n[1]=n[2].slice(0),n[x]=n[x-1],n[x+1]=D(n[x-1])}return n};if(_)return y=_.path3D.update(n),v=x(r,n,_.path3D,_.pathArray,s,o,a,h,_.cap,p),_=t.Mesh.CreateRibbon(null,v,null,null,null,d,null,null,_);y=new t.Path3D(n);var b=new Array;u=u<0||u>3?0:u,v=x(r,n,y,b,s,o,a,h,u,p);var P=e.CreateRibbon(i,{pathArray:v,closeArray:l,closePath:c,updatable:f,sideOrientation:m,invertUV:g},d);return P.pathArray=v,P.path3D=y,P.cap=u,P},e}();t.MeshBuilder=e}(r||(r={}));var r;!function(t){var e=function(){function e(e){this.hasAlpha=!1,this.getAlphaFromRGB=!1,this.level=1,this.coordinatesIndex=0,this.coordinatesMode=t.Texture.EXPLICIT_MODE,this.wrapU=t.Texture.WRAP_ADDRESSMODE,this.wrapV=t.Texture.WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=4,this.isCube=!1,this.isRenderTarget=!1,this.animations=new Array,this.onDisposeObservable=new t.Observable,this.delayLoadState=t.Engine.DELAYLOADSTATE_NONE,this._scene=e,this._scene.textures.push(this),this._uid=null}return Object.defineProperty(e.prototype,"uid",{get:function(){return this._uid||(this._uid=t.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return this.name},Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getTextureMatrix=function(){return null},e.prototype.getReflectionTextureMatrix=function(){return null},e.prototype.getInternalTexture=function(){return this._texture},e.prototype.isReady=function(){return this.delayLoadState===t.Engine.DELAYLOADSTATE_NOTLOADED||!!this._texture&&this._texture.isReady},e.prototype.getSize=function(){return this._texture._width?new t.Size(this._texture._width,this._texture._height):this._texture._size?new t.Size(this._texture._size,this._texture._size):t.Size.Zero()},e.prototype.getBaseSize=function(){return this.isReady()&&this._texture?this._texture._size?new t.Size(this._texture._size,this._texture._size):new t.Size(this._texture._baseWidth,this._texture._baseHeight):t.Size.Zero()},e.prototype.scale=function(t){},Object.defineProperty(e.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype._removeFromCache=function(t,e){for(var i=this._scene.getEngine().getLoadedTexturesCache(),r=0;r<i.length;r++){var n=i[r];if(n.url===t&&n.noMipmap===e)return void i.splice(r,1)}},e.prototype._getFromCache=function(t,e,i){for(var r=this._scene.getEngine().getLoadedTexturesCache(),n=0;n<r.length;n++){var s=r[n];if(s.url===t&&s.noMipmap===e&&(!i||i===s.samplingMode))return s.references++,s}return null},e.prototype.delayLoad=function(){},e.prototype.clone=function(){return null},e.prototype.releaseInternalTexture=function(){this._texture&&(this._scene.getEngine().releaseInternalTexture(this._texture),delete this._texture)},e.prototype.dispose=function(){this.getScene().stopAnimation(this);var t=this._scene.textures.indexOf(this);t>=0&&this._scene.textures.splice(t,1),void 0!==this._texture&&(this.releaseInternalTexture(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear())},e.prototype.serialize=function(){if(!this.name)return null;var e=t.SerializationHelper.Serialize(this);return t.Animation.AppendSerializedAnimations(this,e),e},s([t.serialize()],e.prototype,"name",void 0),s([t.serialize()],e.prototype,"hasAlpha",void 0),s([t.serialize()],e.prototype,"getAlphaFromRGB",void 0),s([t.serialize()],e.prototype,"level",void 0),s([t.serialize()],e.prototype,"coordinatesIndex",void 0),s([t.serialize()],e.prototype,"coordinatesMode",void 0),s([t.serialize()],e.prototype,"wrapU",void 0),s([t.serialize()],e.prototype,"wrapV",void 0),s([t.serialize()],e.prototype,"anisotropicFilteringLevel",void 0),s([t.serialize()],e.prototype,"isCube",void 0),s([t.serialize()],e.prototype,"isRenderTarget",void 0),e}();t.BaseTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(r,n,s,o,a,h,l,c,u){var p=this;if(void 0===s&&(s=!1),void 0===o&&(o=!0),void 0===a&&(a=i.TRILINEAR_SAMPLINGMODE),void 0===h&&(h=null),void 0===l&&(l=null),void 0===c&&(c=null),void 0===u&&(u=!1),e.call(this,n),this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.name=r,this.url=r,this._noMipmap=s,this._invertY=o,this._samplingMode=a,this._buffer=c,this._deleteBuffer=u,r){this._texture=this._getFromCache(r,s,a);var d=function(){p._onLoadObservarble&&p._onLoadObservarble.hasObservers()&&p.onLoadObservable.notifyObservers(!0),h&&h()};this._texture?this._texture.isReady?t.Tools.SetImmediate(function(){return d()}):this._texture.onLoadedCallbacks.push(d):n.useDelayedTextureLoading?(this.delayLoadState=t.Engine.DELAYLOADSTATE_NOTLOADED,this._delayedOnLoad=d,this._delayedOnError=l):(this._texture=n.getEngine().createTexture(r,s,o,n,this._samplingMode,d,l,this._buffer),u&&delete this._buffer)}}return o(i,e),Object.defineProperty(i.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!0,configurable:!0}),i.prototype.delayLoad=function(){this.delayLoadState===t.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=t.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap,this._samplingMode),this._texture||(this._texture=this.getScene().getEngine().createTexture(this.url,this._noMipmap,this._invertY,this.getScene(),this._samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer),this._deleteBuffer&&delete this._buffer))},i.prototype.updateSamplingMode=function(t){this._texture&&(this._samplingMode=t,this.getScene().getEngine().updateTextureSamplingMode(t,this._texture))},i.prototype._prepareRowForTextureGeneration=function(e,i,r,n){e*=this.uScale,i*=this.vScale,e-=.5*this.uScale,i-=.5*this.vScale,r-=.5,t.Vector3.TransformCoordinatesFromFloatsToRef(e,i,r,this._rowGenerationMatrix,n),n.x+=.5*this.uScale+this.uOffset,n.y+=.5*this.vScale+this.vOffset,n.z+=.5},i.prototype.getTextureMatrix=function(){return this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng?this._cachedTextureMatrix:(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=t.Matrix.Zero(),this._rowGenerationMatrix=new t.Matrix,this._t0=t.Vector3.Zero(),this._t1=t.Vector3.Zero(),this._t2=t.Vector3.Zero()),t.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),t.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z,this._cachedTextureMatrix)},i.prototype.getReflectionTextureMatrix=function(){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)return this._cachedTextureMatrix;switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=t.Matrix.Zero(),this._projectionModeMatrix=t.Matrix.Zero()),this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case i.PLANAR_MODE:t.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break;case i.PROJECTION_MODE:t.Matrix.IdentityToRef(this._projectionModeMatrix),this._projectionModeMatrix.m[0]=.5,this._projectionModeMatrix.m[5]=-.5,this._projectionModeMatrix.m[10]=0,this._projectionModeMatrix.m[12]=.5,this._projectionModeMatrix.m[13]=.5,this._projectionModeMatrix.m[14]=1,this._projectionModeMatrix.m[15]=1,this.getScene().getProjectionMatrix().multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:t.Matrix.IdentityToRef(this._cachedTextureMatrix)}return this._cachedTextureMatrix},i.prototype.clone=function(){var e=this;return t.SerializationHelper.Clone(function(){return new i(e._texture.url,e.getScene(),e._noMipmap,e._invertY,e._samplingMode)},this)},Object.defineProperty(i.prototype,"onLoadObservable",{get:function(){return this._onLoadObservarble||(this._onLoadObservarble=new t.Observable),this._onLoadObservarble},enumerable:!0,configurable:!0}),i.CreateFromBase64String=function(t,e,r,n,s,o,a,h){return void 0===o&&(o=i.TRILINEAR_SAMPLINGMODE),void 0===a&&(a=null),void 0===h&&(h=null),new i("data:"+e,r,n,s,o,a,h,t)},i.Parse=function(e,r,n){if(e.customType){return t.Tools.Instantiate(e.customType).Parse(e,r,n)}if(e.isCube)return t.CubeTexture.Parse(e,r,n);if(!e.name&&!e.isRenderTarget)return null;var s=t.SerializationHelper.Parse(function(){if(e.mirrorPlane){var s=new t.MirrorTexture(e.name,e.renderTargetSize,r);return s._waitingRenderList=e.renderList,s.mirrorPlane=t.Plane.FromArray(e.mirrorPlane),s}if(e.isRenderTarget){var o=new t.RenderTargetTexture(e.name,e.renderTargetSize,r);return o._waitingRenderList=e.renderList,o}return e.base64String?i.CreateFromBase64String(e.base64String,e.name,r):new i(n+e.name,r)},e,r);if(e.animations)for(var o=0;o<e.animations.length;o++){var a=e.animations[o];s.animations.push(t.Animation.Parse(a))}return s},i.LoadFromDataString=function(t,e,r,n,s,o,a,h,l){return void 0===n&&(n=!1),void 0===s&&(s=!1),void 0===o&&(o=!0),void 0===a&&(a=i.TRILINEAR_SAMPLINGMODE),void 0===h&&(h=null),void 0===l&&(l=null),"data:"!==t.substr(0,5)&&(t="data:"+t),new i(t,r,s,o,a,h,l,e,n)},i.NEAREST_SAMPLINGMODE=1,i.BILINEAR_SAMPLINGMODE=2,i.TRILINEAR_SAMPLINGMODE=3,i.EXPLICIT_MODE=0,i.SPHERICAL_MODE=1,i.PLANAR_MODE=2,i.CUBIC_MODE=3,i.PROJECTION_MODE=4,i.SKYBOX_MODE=5,i.INVCUBIC_MODE=6,i.EQUIRECTANGULAR_MODE=7,i.FIXED_EQUIRECTANGULAR_MODE=8,i.CLAMP_ADDRESSMODE=0,i.WRAP_ADDRESSMODE=1,i.MIRROR_ADDRESSMODE=2,s([t.serialize()],i.prototype,"url",void 0),s([t.serialize()],i.prototype,"uOffset",void 0),s([t.serialize()],i.prototype,"vOffset",void 0),s([t.serialize()],i.prototype,"uScale",void 0),s([t.serialize()],i.prototype,"vScale",void 0),s([t.serialize()],i.prototype,"uAng",void 0),s([t.serialize()],i.prototype,"vAng",void 0),s([t.serialize()],i.prototype,"wAng",void 0),i}(t.BaseTexture);t.Texture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h){if(void 0===a&&(a=null),void 0===h&&(h=null),e.call(this,r),this.coordinatesMode=t.Texture.CUBIC_MODE,this.name=i,this.url=i,this._noMipmap=s,this.hasAlpha=!1,i||o){if(this._texture=this._getFromCache(i,s),!o){n||(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),o=[];for(var l=0;l<n.length;l++)o.push(i+n[l]);this._extensions=n}this._files=o,this._texture?a&&(this._texture.isReady?t.Tools.SetImmediate(function(){return a()}):this._texture.onLoadedCallbacks.push(a)):r.useDelayedTextureLoading?this.delayLoadState=t.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=r.getEngine().createCubeTexture(i,r,o,s,a,h),this.isCube=!0,this._textureMatrix=t.Matrix.Identity()}}return o(i,e),i.CreateFromImages=function(t,e,r){return new i("",e,null,r,t)},i.prototype.delayLoad=function(){this.delayLoadState===t.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=t.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this.getScene().getEngine().createCubeTexture(this.url,this.getScene(),this._files,this._noMipmap)))},i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},i.Parse=function(e,i,r){var n=t.SerializationHelper.Parse(function(){return new t.CubeTexture(r+e.name,i,e.extensions)},e,i);if(e.animations)for(var s=0;s<e.animations.length;s++){var o=e.animations[s];n.animations.push(t.Animation.Parse(o))}return n},i.prototype.clone=function(){var e=this;return t.SerializationHelper.Clone(function(){return new i(e.url,e.getScene(),e._extensions,e._noMipmap,e._files)},this)},i}(t.BaseTexture);t.CubeTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h,l,c,u){void 0===o&&(o=!0),void 0===a&&(a=t.Engine.TEXTURETYPE_UNSIGNED_INT),void 0===h&&(h=!1),void 0===l&&(l=t.Texture.TRILINEAR_SAMPLINGMODE),void 0===c&&(c=!0),void 0===u&&(u=!1),e.call(this,null,n,!s),this.isCube=h,this.renderList=new Array,this.renderParticles=!0,this.renderSprites=!1,this.coordinatesMode=t.Texture.PROJECTION_MODE,this.onAfterUnbindObservable=new t.Observable,this.onBeforeRenderObservable=new t.Observable,this.onAfterRenderObservable=new t.Observable,this.onClearObservable=new t.Observable,this._currentRefreshId=-1,this._refreshRate=1,this.name=i,this.isRenderTarget=!0,this._size=r,this._generateMipMaps=s,this._doNotChangeAspectRatio=o,l===t.Texture.NEAREST_SAMPLINGMODE&&(this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE),h?(this._texture=n.getEngine().createRenderTargetCubeTexture(r,{generateMipMaps:s,samplingMode:l,generateDepthBuffer:c,generateStencilBuffer:u}),this.coordinatesMode=t.Texture.INVCUBIC_MODE,this._textureMatrix=t.Matrix.Identity()):this._texture=n.getEngine().createRenderTargetTexture(r,{generateMipMaps:s,type:a,samplingMode:l,generateDepthBuffer:c,generateStencilBuffer:u}),this._renderingManager=new t.RenderingManager(n)}return o(i,e),Object.defineProperty(i,"REFRESHRATE_RENDER_ONCE",{get:function(){return i._REFRESHRATE_RENDER_ONCE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"REFRESHRATE_RENDER_ONEVERYFRAME",{get:function(){return i._REFRESHRATE_RENDER_ONEVERYFRAME},enumerable:!0,configurable:!0}),Object.defineProperty(i,"REFRESHRATE_RENDER_ONEVERYTWOFRAMES",{get:function(){return i._REFRESHRATE_RENDER_ONEVERYTWOFRAMES},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onAfterUnbind",{set:function(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onClear",{set:function(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)},enumerable:!0,configurable:!0}),i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(t){this._refreshRate=t,this.resetRefreshCounter()},enumerable:!0,configurable:!0}),i.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},i.prototype.isReady=function(){return!!this.getScene().renderTargetsEnabled&&e.prototype.isReady.call(this)},i.prototype.getRenderSize=function(){return this._size},Object.defineProperty(i.prototype,"canRescale",{get:function(){return!0},enumerable:!0,configurable:!0}),i.prototype.scale=function(t){var e=this._size*t;this.resize(e,this._generateMipMaps)},i.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:e.prototype.getReflectionTextureMatrix.call(this)},i.prototype.resize=function(t,e){this.releaseInternalTexture(),this.isCube?this._texture=this.getScene().getEngine().createRenderTargetCubeTexture(t):this._texture=this.getScene().getEngine().createRenderTargetTexture(t,e)},i.prototype.render=function(t,e){var i=this.getScene();if(void 0!==this.useCameraPostProcesses&&(t=this.useCameraPostProcesses),this.activeCamera&&this.activeCamera!==i.activeCamera&&i.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(!0)),this._waitingRenderList){this.renderList=[];for(var r=0;r<this._waitingRenderList.length;r++){var n=this._waitingRenderList[r];this.renderList.push(i.getMeshByID(n))}delete this._waitingRenderList}if(this.renderListPredicate){this.renderList.splice(0);for(var s=this.getScene().meshes,r=0;r<s.length;r++){var o=s[r];this.renderListPredicate(o)&&this.renderList.push(o)}}if(!this.renderList||0!==this.renderList.length){this._renderingManager.reset();for(var a=this.renderList?this.renderList:i.getActiveMeshes().data,h=this.renderList?this.renderList.length:i.getActiveMeshes().length,l=i.getRenderId(),c=0;c<h;c++){var o=a[c];if(o){if(!o.isReady()){this.resetRefreshCounter();continue}if(o._preActivateForIntermediateRendering(l),o.isEnabled()&&o.isVisible&&o.subMeshes&&0!=(o.layerMask&i.activeCamera.layerMask)){o._activate(l);for(var u=0;u<o.subMeshes.length;u++){var p=o.subMeshes[u];i._activeIndices.addCount(p.indexCount,!1),this._renderingManager.dispatch(p)}}}}if(this.isCube)for(var d=0;d<6;d++)this.renderToTarget(d,a,h,t,e),i.incrementRenderId(),i.resetCachedMaterial();else this.renderToTarget(0,a,h,t,e);this.onAfterUnbindObservable.notifyObservers(this),this.activeCamera&&this.activeCamera!==i.activeCamera&&i.setTransformMatrix(i.activeCamera.getViewMatrix(),i.activeCamera.getProjectionMatrix(!0)),i.resetCachedMaterial()}},i.prototype.renderToTarget=function(e,i,r,n,s){var o=this.getScene(),a=o.getEngine();n&&o.postProcessManager._prepareFrame(this._texture)||(this.isCube?a.bindFramebuffer(this._texture,e):a.bindFramebuffer(this._texture)),this.onBeforeRenderObservable.notifyObservers(e),this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(a):a.clear(o.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||o.updateTransformMatrix(!0),this._renderingManager.render(this.customRenderFunction,i,this.renderParticles,this.renderSprites),n&&o.postProcessManager._finalizeFrame(!1,this._texture,e),this._doNotChangeAspectRatio||o.updateTransformMatrix(!0),this.onAfterRenderObservable.notifyObservers(e),s&&t.Tools.DumpFramebuffer(this._size,this._size,a),this.isCube&&5!==e||(this.isCube&&5===e&&a.generateMipMapsForCubemap(this._texture),a.unBindFramebuffer(this._texture,this.isCube))},i.prototype.setRenderingOrder=function(t,e,i,r){void 0===e&&(e=null),void 0===i&&(i=null),void 0===r&&(r=null),this._renderingManager.setRenderingOrder(t,e,i,r)},i.prototype.setRenderingAutoClearDepthStencil=function(t,e){this._renderingManager.setRenderingAutoClearDepthStencil(t,e)},i.prototype.clone=function(){var t=this.getSize(),e=new i(this.name,t.width,this.getScene(),this._generateMipMaps);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.coordinatesMode=this.coordinatesMode,e.renderList=this.renderList.slice(0),e},i.prototype.serialize=function(){if(!this.name)return null;var t=e.prototype.serialize.call(this);t.renderTargetSize=this.getRenderSize(),t.renderList=[];for(var i=0;i<this.renderList.length;i++)t.renderList.push(this.renderList[i].id);return t},i._REFRESHRATE_RENDER_ONCE=0,i._REFRESHRATE_RENDER_ONEVERYFRAME=1,i._REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,i}(t.Texture);t.RenderTargetTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h){void 0===a&&(a=!0),void 0===h&&(h=!1),e.call(this,null,s,!a),this.isCube=h,this.isEnabled=!0,this._currentRefreshId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._textures=new Array,this._floats=new Array,this._floatsArrays={},this._colors3=new Array,this._colors4=new Array,this._vectors2=new Array,this._vectors3=new Array,this._matrices=new Array,this._fallbackTextureUsed=!1,s._proceduralTextures.push(this),this.name=i,this.isRenderTarget=!0,this._size=r,this._generateMipMaps=a,this.setFragment(n),this._fallbackTexture=o;var l=s.getEngine();h?(this._texture=l.createRenderTargetCubeTexture(r,{generateMipMaps:a}),this.setFloat("face",0)):this._texture=l.createRenderTargetTexture(r,a);var c=[];c.push(1,1),c.push(-1,1),c.push(-1,-1),c.push(1,-1),this._vertexBuffers[t.VertexBuffer.PositionKind]=new t.VertexBuffer(l,c,t.VertexBuffer.PositionKind,!1,!1,2);var u=[];u.push(0),u.push(1),u.push(2),u.push(0),u.push(2),u.push(3),this._indexBuffer=l.createIndexBuffer(u)}return o(i,e),i.prototype.reset=function(){if(void 0!==this._effect){this.getScene().getEngine()._releaseEffect(this._effect)}},i.prototype.isReady=function(){var e,i=this,r=this.getScene().getEngine();return!!this._fragment&&(!!this._fallbackTextureUsed||(e=void 0!==this._fragment.fragmentElement?{vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:{vertex:"procedural",fragment:this._fragment},this._effect=r.createEffect(e,[t.VertexBuffer.PositionKind],this._uniforms,this._samplers,"",null,null,function(){i.releaseInternalTexture(),i._fallbackTexture&&(i._texture=i._fallbackTexture._texture,i._texture.references++),i._fallbackTextureUsed=!0}),this._effect.isReady()))},i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},i.prototype.setFragment=function(t){this._fragment=t},Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(t){this._refreshRate=t,this.resetRefreshCounter()},enumerable:!0,configurable:!0}),i.prototype._shouldRender=function(){return!!(this.isEnabled&&this.isReady()&&this._texture)&&(!this._fallbackTextureUsed&&(this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)))},i.prototype.getRenderSize=function(){return this._size},i.prototype.resize=function(t,e){this._fallbackTextureUsed||(this.releaseInternalTexture(),this._texture=this.getScene().getEngine().createRenderTargetTexture(t,e))},i.prototype._checkUniform=function(t){this._uniforms.indexOf(t)===-1&&this._uniforms.push(t)},i.prototype.setTexture=function(t,e){return this._samplers.indexOf(t)===-1&&this._samplers.push(t),this._textures[t]=e,this},i.prototype.setFloat=function(t,e){return this._checkUniform(t),this._floats[t]=e,this},i.prototype.setFloats=function(t,e){return this._checkUniform(t),this._floatsArrays[t]=e,this},i.prototype.setColor3=function(t,e){return this._checkUniform(t),this._colors3[t]=e,this},i.prototype.setColor4=function(t,e){return this._checkUniform(t),this._colors4[t]=e,this},i.prototype.setVector2=function(t,e){return this._checkUniform(t),this._vectors2[t]=e,this},i.prototype.setVector3=function(t,e){return this._checkUniform(t),this._vectors3[t]=e,this},i.prototype.setMatrix=function(t,e){return this._checkUniform(t),this._matrices[t]=e,this},i.prototype.render=function(t){var e=this.getScene(),i=e.getEngine();i.enableEffect(this._effect),i.setState(!1);for(var r in this._textures)this._effect.setTexture(r,this._textures[r]);for(r in this._floats)this._effect.setFloat(r,this._floats[r]);for(r in this._floatsArrays)this._effect.setArray(r,this._floatsArrays[r]);for(r in this._colors3)this._effect.setColor3(r,this._colors3[r]);for(r in this._colors4){var n=this._colors4[r];this._effect.setFloat4(r,n.r,n.g,n.b,n.a)}for(r in this._vectors2)this._effect.setVector2(r,this._vectors2[r]);for(r in this._vectors3)this._effect.setVector3(r,this._vectors3[r]);for(r in this._matrices)this._effect.setMatrix(r,this._matrices[r]);if(i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this.isCube)for(var s=0;s<6;s++)i.bindFramebuffer(this._texture,s),this._effect.setFloat("face",s),i.clear(e.clearColor,!0,!0,!0),i.draw(!0,0,6),5===s&&i.generateMipMapsForCubemap(this._texture);else i.bindFramebuffer(this._texture),i.clear(e.clearColor,!0,!0,!0),i.draw(!0,0,6);i.unBindFramebuffer(this._texture,this.isCube),this.onGenerated&&this.onGenerated()},i.prototype.clone=function(){var t=this.getSize(),e=new i(this.name,t.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.coordinatesMode=this.coordinatesMode,e},i.prototype.dispose=function(){var i=this.getScene()._proceduralTextures.indexOf(this);i>=0&&this.getScene()._proceduralTextures.splice(i,1);var r=this._vertexBuffers[t.VertexBuffer.PositionKind];r&&(r.dispose(),this._vertexBuffers[t.VertexBuffer.PositionKind]=null),this._indexBuffer&&this.getScene().getEngine()._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),e.prototype.dispose.call(this)},i}(t.Texture);t.ProceduralTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s){var o=this;e.call(this,i,r,n,s,!0),this.mirrorPlane=new t.Plane(0,1,0,1),this._transformMatrix=t.Matrix.Zero(),this._mirrorMatrix=t.Matrix.Zero(),this.onBeforeRenderObservable.add(function(){t.Matrix.ReflectionToRef(o.mirrorPlane,o._mirrorMatrix),o._savedViewMatrix=n.getViewMatrix(),o._mirrorMatrix.multiplyToRef(o._savedViewMatrix,o._transformMatrix),n.setTransformMatrix(o._transformMatrix,n.getProjectionMatrix()),n.clipPlane=o.mirrorPlane,n.getEngine().cullBackFaces=!1,n._mirroredCameraPosition=t.Vector3.TransformCoordinates(n.activeCamera.position,o._mirrorMatrix)}),this.onAfterRenderObservable.add(function(){n.setTransformMatrix(o._savedViewMatrix,n.getProjectionMatrix()),n.getEngine().cullBackFaces=!0,n._mirroredCameraPosition=null,delete n.clipPlane})}return o(i,e),i.prototype.clone=function(){var t=this.getSize(),e=new i(this.name,t.width,this.getScene(),this._generateMipMaps);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.mirrorPlane=this.mirrorPlane.clone(),e.renderList=this.renderList.slice(0),e},i.prototype.serialize=function(){if(!this.name)return null;var t=e.prototype.serialize.call(this);return t.mirrorPlane=this.mirrorPlane.asArray(),t},i}(t.RenderTargetTexture);t.MirrorTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s){var o=this;e.call(this,i,r,n,s,!0),this.refractionPlane=new t.Plane(0,1,0,1),this.depth=2,this.onBeforeRenderObservable.add(function(){n.clipPlane=o.refractionPlane}),this.onAfterRenderObservable.add(function(){delete n.clipPlane})}return o(i,e),i.prototype.clone=function(){var t=this.getSize(),e=new i(this.name,t.width,this.getScene(),this._generateMipMaps);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.refractionPlane=this.refractionPlane.clone(),e.renderList=this.renderList.slice(0),e.depth=this.depth,e},i.prototype.serialize=function(){if(!this.name)return null;var t=e.prototype.serialize.call(this);return t.mirrorPlane=this.refractionPlane.asArray(),t.depth=this.depth,t},i}(t.RenderTargetTexture);t.RefractionTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){void 0===o&&(o=t.Texture.TRILINEAR_SAMPLINGMODE),e.call(this,null,n,!s),this.name=i,this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=s,r.getContext?(this._canvas=r,this._texture=n.getEngine().createDynamicTexture(r.width,r.height,s,o)):(this._canvas=document.createElement("canvas"),r.width?this._texture=n.getEngine().createDynamicTexture(r.width,r.height,s,o):this._texture=n.getEngine().createDynamicTexture(r,r,s,o));var a=this.getSize();this._canvas.width=a.width,this._canvas.height=a.height,this._context=this._canvas.getContext("2d")}return o(i,e),Object.defineProperty(i.prototype,"canRescale",{get:function(){return!0},enumerable:!0,configurable:!0}),i.prototype.scale=function(t){var e=this.getSize();e.width*=t,e.height*=t,this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this.getScene().getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this._samplingMode)},i.prototype.getContext=function(){return this._context},i.prototype.clear=function(){var t=this.getSize();this._context.fillRect(0,0,t.width,t.height)},i.prototype.update=function(t){this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===t||t)},i.prototype.drawText=function(t,e,i,r,n,s,o,a){void 0===a&&(a=!0);var h=this.getSize();if(s&&(this._context.fillStyle=s,this._context.fillRect(0,0,h.width,h.height)),this._context.font=r,null===e){var l=this._context.measureText(t);e=(h.width-l.width)/2}this._context.fillStyle=n,this._context.fillText(t,e,i),a&&this.update(o)},i.prototype.clone=function(){var t=this.getSize(),e=new i(this.name,t,this.getScene(),this._generateMipMaps);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e},i}(t.Texture);t.DynamicTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a){var h=this;void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===a&&(a=t.Texture.TRILINEAR_SAMPLINGMODE),e.call(this,null,n,!s,o),this._autoLaunch=!0;var l;this.name=i,r instanceof HTMLVideoElement?this.video=r:(l=r,this.video=document.createElement("video"),this.video.autoplay=!1,this.video.loop=!0),this._generateMipMaps=s,this._samplingMode=a,t.Tools.IsExponentOfTwo(this.video.videoWidth)&&t.Tools.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=t.Texture.WRAP_ADDRESSMODE,this.wrapV=t.Texture.WRAP_ADDRESSMODE):(this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),l?(this.video.addEventListener("canplaythrough",function(){h._createTexture()}),l.forEach(function(t){var e=document.createElement("source");e.src=t,h.video.appendChild(e)})):this._createTexture(),this._lastUpdate=t.Tools.Now}return o(i,e),i.prototype._createTexture=function(){this._texture=this.getScene().getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this._samplingMode),this._texture.isReady=!0},i.prototype.update=function(){this._autoLaunch&&(this._autoLaunch=!1,this.video.play());var e=t.Tools.Now;return!(e-this._lastUpdate<15||this.video.readyState!==this.video.HAVE_ENOUGH_DATA)&&(this._lastUpdate=e,this.getScene().getEngine().updateVideoTexture(this._texture,this.video,this._invertY),!0)},i}(t.Texture);t.VideoTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r,n,s,o){e.call(this,t,r,null,n,s,o),this._animate=!0,this._time=0,this._texturePath=i,this.loadJson(i),this.refreshRate=1}return o(i,e),i.prototype.loadJson=function(e){function i(){t.Tools.Log("No config file found in "+e+" trying to use ShadersStore or DOM element");try{n.setFragment(n._texturePath)}catch(e){t.Tools.Error("No json or ShaderStore or DOM element found for CustomProceduralTexture")}}var r=this,n=this,s=e+"/config.json",o=new XMLHttpRequest;o.open("GET",s,!0),o.addEventListener("load",function(){if(200===o.status||t.Tools.ValidateXHRData(o,1))try{r._config=JSON.parse(o.response),r.updateShaderUniforms(),r.updateTextures(),r.setFragment(r._texturePath+"/custom"),r._animate=r._config.animate,r.refreshRate=r._config.refreshrate}catch(t){i()}else i()},!1),o.addEventListener("error",function(){i()},!1);try{o.send()}catch(e){t.Tools.Error("CustomProceduralTexture: Error on XHR send request.")}},i.prototype.isReady=function(){if(!e.prototype.isReady.call(this))return!1;for(var t in this._textures){if(!this._textures[t].isReady())return!1}return!0},i.prototype.render=function(t){this._animate&&(this._time+=.03*this.getScene().getAnimationRatio(),this.updateShaderUniforms()),e.prototype.render.call(this,t)},i.prototype.updateTextures=function(){for(var e=0;e<this._config.sampler2Ds.length;e++)this.setTexture(this._config.sampler2Ds[e].sample2Dname,new t.Texture(this._texturePath+"/"+this._config.sampler2Ds[e].textureRelativeUrl,this.getScene()))},i.prototype.updateShaderUniforms=function(){if(this._config)for(var e=0;e<this._config.uniforms.length;e++){var i=this._config.uniforms[e];switch(i.type){case"float":this.setFloat(i.name,i.value);break;case"color3":this.setColor3(i.name,new t.Color3(i.r,i.g,i.b));break;case"color4":this.setColor4(i.name,new t.Color4(i.r,i.g,i.b,i.a));break;case"vector2":this.setVector2(i.name,new t.Vector2(i.x,i.y));break;case"vector3":this.setVector3(i.name,new t.Vector3(i.x,i.y,i.z))}}this.setFloat("time",this._time)},Object.defineProperty(i.prototype,"animate",{get:function(){return this._animate},set:function(t){this._animate=t},enumerable:!0,configurable:!0}),i}(t.ProceduralTexture);t.CustomProceduralTexture=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this._defines={},this._currentRank=32,this._maxRank=-1}return e.prototype.addFallback=function(t,e){this._defines[t]||(t<this._currentRank&&(this._currentRank=t),t>this._maxRank&&(this._maxRank=t),this._defines[t]=new Array),this._defines[t].push(e)},e.prototype.addCPUSkinningFallback=function(t,e){this._meshRank=t,this._mesh=e,t>this._maxRank&&(this._maxRank=t)},Object.defineProperty(e.prototype,"isMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:!0,configurable:!0}),e.prototype.reduce=function(e){for(var i=this._defines[this._currentRank],r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");return this._mesh&&this._currentRank===this._meshRank&&(this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t.Tools.Log("Falling back to CPU skinning for "+this._mesh.name)),this._currentRank++,e},e}();t.EffectFallbacks=e;var i=function(){function e(t,e,i,r,n,s,o,a,h,l){var c=this;this._isReady=!1,this._compilationError="",this._valueCache={},this._engine=n,this.name=t,this.defines=s,this._uniformsNames=i.concat(r),this._samplers=r,this._attributesNames=e,this.onError=h,this.onCompiled=a,this._indexParameters=l;var u,p;t.vertexElement?(u=document.getElementById(t.vertexElement))||(u=t.vertexElement):u=t.vertex||t,t.fragmentElement?(p=document.getElementById(t.fragmentElement))||(p=t.fragmentElement):p=t.fragment||t,this._loadVertexShader(u,function(t){c._processIncludes(t,function(t){c._loadFragmentShader(p,function(i){c._processIncludes(i,function(i){c._prepareEffect(t,i,e,s,o)})})})})}return e.prototype.isReady=function(){return this._isReady},e.prototype.getProgram=function(){return this._program},e.prototype.getAttributesNames=function(){return this._attributesNames},e.prototype.getAttributeLocation=function(t){return this._attributes[t]},e.prototype.getAttributeLocationByName=function(t){var e=this._attributesNames.indexOf(t);return this._attributes[e]},e.prototype.getAttributesCount=function(){return this._attributes.length},e.prototype.getUniformIndex=function(t){return this._uniformsNames.indexOf(t)},e.prototype.getUniform=function(t){return this._uniforms[this._uniformsNames.indexOf(t)]},e.prototype.getSamplers=function(){return this._samplers},e.prototype.getCompilationError=function(){return this._compilationError},e.prototype.getVertexShaderSource=function(){return this._engine.getVertexShaderSource(this._program)},e.prototype.getFragmentShaderSource=function(){return this._engine.getFragmentShaderSource(this._program)},e.prototype._loadVertexShader=function(i,r){if(i instanceof HTMLElement){return void r(t.Tools.GetDOMTextContent(i))}if("base64:"===i.substr(0,7)){return void r(window.atob(i.substr(7)))}if(e.ShadersStore[i+"VertexShader"])return void r(e.ShadersStore[i+"VertexShader"]);var n;n="."===i[0]||"/"===i[0]||i.indexOf("http")>-1?i:t.Engine.ShadersRepository+i,t.Tools.LoadFile(n+".vertex.fx",r)},e.prototype._loadFragmentShader=function(i,r){if(i instanceof HTMLElement){return void r(t.Tools.GetDOMTextContent(i))}if("base64:"===i.substr(0,7)){return void r(window.atob(i.substr(7)))}if(e.ShadersStore[i+"PixelShader"])return void r(e.ShadersStore[i+"PixelShader"]);if(e.ShadersStore[i+"FragmentShader"])return void r(e.ShadersStore[i+"FragmentShader"]);var n;n="."===i[0]||"/"===i[0]||i.indexOf("http")>-1?i:t.Engine.ShadersRepository+i,t.Tools.LoadFile(n+".fragment.fx",r)},e.prototype._dumpShadersName=function(){this.name.vertexElement?(t.Tools.Error("Vertex shader:"+this.name.vertexElement),t.Tools.Error("Fragment shader:"+this.name.fragmentElement)):this.name.vertex?(t.Tools.Error("Vertex shader:"+this.name.vertex),t.Tools.Error("Fragment shader:"+this.name.fragment)):(t.Tools.Error("Vertex shader:"+this.name),t.Tools.Error("Fragment shader:"+this.name))},e.prototype._processIncludes=function(i,r){for(var n=this,s=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,o=s.exec(i),a=new String(i);null!=o;){var h=o[1];if(!e.IncludesShadersStore[h]){var l=t.Engine.ShadersRepository+"ShadersInclude/"+h+".fx";return void t.Tools.LoadFile(l,function(t){e.IncludesShadersStore[h]=t,n._processIncludes(a,r)})}var c=e.IncludesShadersStore[h];if(o[2])for(var u=o[3].split(","),p=0;p<u.length;p+=2){var d=new RegExp(u[p],"g"),f=u[p+1];c=c.replace(d,f)}if(o[4]){var m=o[5];if(m.indexOf("..")!==-1){var _=m.split(".."),g=parseInt(_[0]),y=parseInt(_[1]),v=c.slice(0);c="",isNaN(y)&&(y=this._indexParameters[_[1]]);for(var x=g;x<=y;x++)c+=v.replace(/\{X\}/g,x)+"\n"}else c=c.replace(/\{X\}/g,m)}a=a.replace(o[0],c),o=s.exec(i)}r(a)},e.prototype._processPrecision=function(t){return t.indexOf("precision highp float")===-1?t=this._engine.getCaps().highPrecisionShaderSupported?"precision highp float;\n"+t:"precision mediump float;\n"+t:this._engine.getCaps().highPrecisionShaderSupported||(t=t.replace("precision highp float","precision mediump float")),t},e.prototype._prepareEffect=function(e,i,r,n,s){try{var o=this._engine;e=this._processPrecision(e),i=this._processPrecision(i),this._program=o.createShaderProgram(e,i,n),this._uniforms=o.getUniforms(this._program,this._uniformsNames),this._attributes=o.getAttributes(this._program,r);var a;for(a=0;a<this._samplers.length;a++){null==this.getUniform(this._samplers[a])&&(this._samplers.splice(a,1),a--)}o.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this)}catch(o){this._compilationError=o.message,t.Tools.Error("Unable to compile effect: "),t.Tools.Error("Defines: "+n),t.Tools.Error("Error: "+this._compilationError),this._dumpShadersName(),s&&s.isMoreFallbacks?(t.Tools.Error("Trying next fallback."),n=s.reduce(n),this._prepareEffect(e,i,r,n,s)):this.onError&&this.onError(this,this._compilationError)}},Object.defineProperty(e.prototype,"isSupported",{get:function(){return""===this._compilationError},enumerable:!0,configurable:!0}),e.prototype._bindTexture=function(t,e){this._engine._bindTexture(this._samplers.indexOf(t),e)},e.prototype.setTexture=function(t,e){this._engine.setTexture(this._samplers.indexOf(t),this.getUniform(t),e)},e.prototype.setTextureArray=function(t,e){if(this._samplers.indexOf(t+"Ex")===-1)for(var i=this._samplers.indexOf(t),r=1;r<e.length;r++)this._samplers.splice(i+r,0,t+"Ex");this._engine.setTextureArray(this._samplers.indexOf(t),this.getUniform(t),e)},e.prototype.setTextureFromPostProcess=function(t,e){this._engine.setTextureFromPostProcess(this._samplers.indexOf(t),e)},e.prototype._cacheMatrix=function(e,i){var r=!1,n=this._valueCache[e];n&&n instanceof t.Matrix||(r=!0,n=new t.Matrix);for(var s=n.m,o=i.m,a=0;a<16;a++)s[a]!==o[a]&&(s[a]=o[a],r=!0);return this._valueCache[e]=n,r},e.prototype._cacheFloat2=function(t,e,i){var r=this._valueCache[t];if(!r)return r=[e,i],this._valueCache[t]=r,!0;var n=!1;return r[0]!==e&&(r[0]=e,n=!0),r[1]!==i&&(r[1]=i,n=!0),n},e.prototype._cacheFloat3=function(t,e,i,r){var n=this._valueCache[t];if(!n)return n=[e,i,r],this._valueCache[t]=n,!0;var s=!1;return n[0]!==e&&(n[0]=e,s=!0),n[1]!==i&&(n[1]=i,s=!0),n[2]!==r&&(n[2]=r,s=!0),s},e.prototype._cacheFloat4=function(t,e,i,r,n){var s=this._valueCache[t];if(!s)return s=[e,i,r,n],this._valueCache[t]=s,!0;var o=!1;return s[0]!==e&&(s[0]=e,o=!0),s[1]!==i&&(s[1]=i,o=!0),s[2]!==r&&(s[2]=r,o=!0),s[3]!==n&&(s[3]=n,o=!0),o},e.prototype.setIntArray=function(t,e){return this._valueCache[t]=null,this._engine.setIntArray(this.getUniform(t),e),this},e.prototype.setIntArray2=function(t,e){return this._valueCache[t]=null,this._engine.setIntArray2(this.getUniform(t),e),this},e.prototype.setIntArray3=function(t,e){return this._valueCache[t]=null,this._engine.setIntArray3(this.getUniform(t),e),this},e.prototype.setIntArray4=function(t,e){return this._valueCache[t]=null,this._engine.setIntArray4(this.getUniform(t),e),this},e.prototype.setFloatArray=function(t,e){return this._valueCache[t]=null,this._engine.setFloatArray(this.getUniform(t),e),this},e.prototype.setFloatArray2=function(t,e){return this._valueCache[t]=null,this._engine.setFloatArray2(this.getUniform(t),e),this},e.prototype.setFloatArray3=function(t,e){return this._valueCache[t]=null,this._engine.setFloatArray3(this.getUniform(t),e),this},e.prototype.setFloatArray4=function(t,e){return this._valueCache[t]=null,this._engine.setFloatArray4(this.getUniform(t),e),this},e.prototype.setArray=function(t,e){return this._valueCache[t]=null,this._engine.setArray(this.getUniform(t),e),this},e.prototype.setArray2=function(t,e){return this._valueCache[t]=null,this._engine.setArray2(this.getUniform(t),e),this},e.prototype.setArray3=function(t,e){return this._valueCache[t]=null,this._engine.setArray3(this.getUniform(t),e),this},e.prototype.setArray4=function(t,e){return this._valueCache[t]=null,this._engine.setArray4(this.getUniform(t),e),this},e.prototype.setMatrices=function(t,e){return this._valueCache[t]=null,this._engine.setMatrices(this.getUniform(t),e),this},e.prototype.setMatrix=function(t,e){return this._cacheMatrix(t,e)&&this._engine.setMatrix(this.getUniform(t),e),this},e.prototype.setMatrix3x3=function(t,e){return this._valueCache[t]=null,this._engine.setMatrix3x3(this.getUniform(t),e),this},e.prototype.setMatrix2x2=function(t,e){return this._valueCache[t]=null,this._engine.setMatrix2x2(this.getUniform(t),e),this},e.prototype.setFloat=function(t,e){var i=this._valueCache[t];return void 0!==i&&i===e?this:(this._valueCache[t]=e,this._engine.setFloat(this.getUniform(t),e),this)},e.prototype.setBool=function(t,e){var i=this._valueCache[t];return void 0!==i&&i===e?this:(this._valueCache[t]=e,this._engine.setBool(this.getUniform(t),e?1:0),this)},e.prototype.setVector2=function(t,e){return this._cacheFloat2(t,e.x,e.y)&&this._engine.setFloat2(this.getUniform(t),e.x,e.y),this},e.prototype.setFloat2=function(t,e,i){return this._cacheFloat2(t,e,i)&&this._engine.setFloat2(this.getUniform(t),e,i),this},e.prototype.setVector3=function(t,e){return this._cacheFloat3(t,e.x,e.y,e.z)&&this._engine.setFloat3(this.getUniform(t),e.x,e.y,e.z),this},e.prototype.setFloat3=function(t,e,i,r){return this._cacheFloat3(t,e,i,r)&&this._engine.setFloat3(this.getUniform(t),e,i,r),this},e.prototype.setVector4=function(t,e){return this._cacheFloat4(t,e.x,e.y,e.z,e.w)&&this._engine.setFloat4(this.getUniform(t),e.x,e.y,e.z,e.w),this},e.prototype.setFloat4=function(t,e,i,r,n){return this._cacheFloat4(t,e,i,r,n)&&this._engine.setFloat4(this.getUniform(t),e,i,r,n),this},e.prototype.setColor3=function(t,e){return this._cacheFloat3(t,e.r,e.g,e.b)&&this._engine.setColor3(this.getUniform(t),e),this},e.prototype.setColor4=function(t,e,i){return this._cacheFloat4(t,e.r,e.g,e.b,i)&&this._engine.setColor4(this.getUniform(t),e,i),this},e.ShadersStore={},e.IncludesShadersStore={},e}();t.Effect=i}(r||(r={}));var r;!function(t){var e=function(){function e(){}return e.PrepareDefinesForLights=function(e,i,r,n){void 0===n&&(n=4);for(var s=0,o=!1,a=!1,h=!1,l=!1,c=0;c<e.lights.length;c++){var u=e.lights[c];if(u.isEnabled()){if(u._excludedMeshesIds.length>0){for(var p=0;p<u._excludedMeshesIds.length;p++){var d=e.getMeshByID(u._excludedMeshesIds[p]);d&&u.excludedMeshes.push(d)}u._excludedMeshesIds=[]}if(u._includedOnlyMeshesIds.length>0){for(var f=0;f<u._includedOnlyMeshesIds.length;f++){var m=e.getMeshByID(u._includedOnlyMeshesIds[f]);m&&u.includedOnlyMeshes.push(m)}u._includedOnlyMeshesIds=[]}if(u.canAffectMesh(i)){o=!0,void 0===r["LIGHT"+s]&&(a=!0),r["LIGHT"+s]=!0;var _;if(_=u instanceof t.SpotLight?"SPOTLIGHT"+s:u instanceof t.HemisphericLight?"HEMILIGHT"+s:u instanceof t.PointLight?"POINTLIGHT"+s:"DIRLIGHT"+s,void 0===r[_]&&(a=!0),r[_]=!0,u.specular.equalsFloats(0,0,0)||void 0===r.SPECULARTERM||(r.SPECULARTERM=!0),e.shadowsEnabled){var g=u.getShadowGenerator();i&&i.receiveShadows&&g&&(void 0===r["SHADOW"+s]&&(a=!0),r["SHADOW"+s]=!0,r.SHADOWS=!0,(g.useVarianceShadowMap||g.useBlurVarianceShadowMap)&&(void 0===r["SHADOWVSM"+s]&&(a=!0),r["SHADOWVSM"+s]=!0),g.usePoissonSampling&&(void 0===r["SHADOWPCF"+s]&&(a=!0),r["SHADOWPCF"+s]=!0),h=!0)}if(u.lightmapMode!=t.Light.LIGHTMAP_DEFAULT&&(l=!0,void 0===r["LIGHTMAPEXCLUDED"+s]&&(a=!0),void 0===r["LIGHTMAPNOSPECULAR"+s]&&(a=!0),r["LIGHTMAPEXCLUDED"+s]=!0,u.lightmapMode==t.Light.LIGHTMAP_SHADOWSONLY&&(r["LIGHTMAPNOSPECULAR"+s]=!0)),++s===n)break}}}var y=e.getEngine().getCaps();return h&&y.textureFloat&&y.textureFloatLinearFiltering&&y.textureFloatRender&&(void 0===r.SHADOWFULLFLOAT&&(a=!0),r.SHADOWFULLFLOAT=!0),void 0===r.LIGHTMAPEXCLUDED&&(a=!0),l&&(r.LIGHTMAPEXCLUDED=!0),a&&r.rebuild(),o},e.PrepareUniformsAndSamplersList=function(t,e,i,r){void 0===r&&(r=4);for(var n=0;n<r&&i["LIGHT"+n];n++)t.push("vLightData"+n,"vLightDiffuse"+n,"vLightSpecular"+n,"vLightDirection"+n,"vLightGround"+n,"lightMatrix"+n,"shadowsInfo"+n),e.push("shadowSampler"+n)},e.HandleFallbacksForShadows=function(t,e,i){void 0===i&&(i=4);for(var r=0;r<i&&t["LIGHT"+r];r++)r>0&&e.addFallback(r,"LIGHT"+r),t["SHADOW"+r]&&e.addFallback(0,"SHADOW"+r),t["SHADOWPCF"+r]&&e.addFallback(0,"SHADOWPCF"+r),t["SHADOWVSM"+r]&&e.addFallback(0,"SHADOWVSM"+r)},e.PrepareAttributesForBones=function(e,i,r,n){r.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,i),e.push(t.VertexBuffer.MatricesIndicesKind),e.push(t.VertexBuffer.MatricesWeightsKind),r.NUM_BONE_INFLUENCERS>4&&(e.push(t.VertexBuffer.MatricesIndicesExtraKind),e.push(t.VertexBuffer.MatricesWeightsExtraKind)))},e.PrepareAttributesForInstances=function(t,e){e.INSTANCES&&(t.push("world0"),t.push("world1"),t.push("world2"),t.push("world3"))},e.BindLightShadow=function(t,e,i,r,n,s){var o=t.getShadowGenerator();return i.receiveShadows&&o&&(t.needCube()?s||(s=!0,n.setFloat2("depthValues",e.activeCamera.minZ,e.activeCamera.maxZ)):n.setMatrix("lightMatrix"+r,o.getTransformMatrix()),n.setTexture("shadowSampler"+r,o.getShadowMapForRendering()),n.setFloat3("shadowsInfo"+r,o.getDarkness(),o.blurScale/o.getShadowMap().getSize().width,o.bias)),s},e.BindLightProperties=function(e,i,r){e instanceof t.PointLight?e.transferToEffect(i,"vLightData"+r):e instanceof t.DirectionalLight?e.transferToEffect(i,"vLightData"+r):e instanceof t.SpotLight?e.transferToEffect(i,"vLightData"+r,"vLightDirection"+r):e instanceof t.HemisphericLight&&e.transferToEffect(i,"vLightData"+r,"vLightGround"+r)},e.BindLights=function(i,r,n,s,o){void 0===o&&(o=4);for(var a=0,h=!1,l=0;l<i.lights.length;l++){var c=i.lights[l];if(c.isEnabled()&&c.canAffectMesh(r)&&(e.BindLightProperties(c,n,a),c.diffuse.scaleToRef(c.intensity,t.Tmp.Color3[0]),n.setColor4("vLightDiffuse"+a,t.Tmp.Color3[0],c.range),s.SPECULARTERM&&(c.specular.scaleToRef(c.intensity,t.Tmp.Color3[1]),n.setColor3("vLightSpecular"+a,t.Tmp.Color3[1])),i.shadowsEnabled&&(h=this.BindLightShadow(c,i,r,a,n,h)),++a===o))break}},e.BindFogParameters=function(e,i,r){e.fogEnabled&&i.applyFog&&e.fogMode!==t.Scene.FOGMODE_NONE&&(r.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),r.setColor3("vFogColor",e.fogColor))},e.BindBonesParameters=function(t,e){if(t&&t.useBones&&t.computeBonesUsingShaders){var i=t.skeleton.getTransformMatrices(t);i&&e.setMatrices("mBones",i)}},e.BindLogDepth=function(t,e,i){t.LOGARITHMICDEPTH&&e.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2))},e.BindClipPlane=function(t,e){if(e.clipPlane){var i=e.clipPlane;t.setFloat4("vClipPlane",i.normal.x,i.normal.y,i.normal.z,i.d)}},e}();t.MaterialHelper=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this.isEnabled=!0,this.leftColor=t.Color3.White(),this.rightColor=t.Color3.Black(),this.bias=0,this.power=1}return e.prototype.clone=function(){var i=new e;return t.Tools.DeepCopy(this,i),i},e.prototype.serialize=function(){var t={};return t.isEnabled=this.isEnabled,t.leftColor=this.leftColor,t.rightColor=this.rightColor,t.bias=this.bias,t.power=this.power,t},e.Parse=function(i){var r=new e;return r.isEnabled=i.isEnabled,r.leftColor=t.Color3.FromArray(i.leftColor),r.rightColor=t.Color3.FromArray(i.rightColor),r.bias=i.bias,r.power=i.power||1,r},e}();t.FresnelParameters=e}(r||(r={}));var r;!function(t){var e=function(){function t(){}return t.prototype.rebuild=function(){this._keys&&delete this._keys,this._keys=Object.keys(this)},t.prototype.isEqual=function(t){if(this._keys.length!==t._keys.length)return!1;for(var e=0;e<this._keys.length;e++){var i=this._keys[e];if(this[i]!==t[i])return!1}return!0},t.prototype.cloneTo=function(t){this._keys.length!==t._keys.length&&(t._keys=this._keys.slice(0));for(var e=0;e<this._keys.length;e++){var i=this._keys[e];t[i]=this[i]}},t.prototype.reset=function(){for(var t=0;t<this._keys.length;t++){var e=this._keys[t];"number"==typeof this[e]?this[e]=0:this[e]=!1}},t.prototype.toString=function(){for(var t="",e=0;e<this._keys.length;e++){var i=this._keys[e];"number"==typeof this[i]?t+="#define "+i+" "+this[i]+"\n":this[i]&&(t+="#define "+i+"\n")}return t},t}();t.MaterialDefines=e;var i=function(){function e(i,r,n){this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this.alpha=1,this.backFaceCulling=!0,this.doNotSerialize=!1,this.onDisposeObservable=new t.Observable,this.onBindObservable=new t.Observable,this.onUnBindObservable=new t.Observable,this.alphaMode=t.Engine.ALPHA_COMBINE,this.disableDepthWrite=!1,this.fogEnabled=!0,this.pointSize=1,this.zOffset=0,this._wasPreviouslyReady=!1,this._fillMode=e.TriangleFillMode,this.name=i,this.id=i,this._scene=r,r.useRightHandedSystem?this.sideOrientation=e.ClockWiseSideOrientation:this.sideOrientation=e.CounterClockWiseSideOrientation,n||r.materials.push(this)}return Object.defineProperty(e,"TriangleFillMode",{get:function(){return e._TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(e,"WireFrameFillMode",{get:function(){return e._WireFrameFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointFillMode",{get:function(){return e._PointFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(e,"ClockWiseSideOrientation",{get:function(){return e._ClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(e,"CounterClockWiseSideOrientation",{get:function(){return e._CounterClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onBind",{set:function(t){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"wireframe",{get:function(){return this._fillMode===e.WireFrameFillMode},set:function(t){this._fillMode=t?e.WireFrameFillMode:e.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointsCloud",{get:function(){return this._fillMode===e.PointFillMode},set:function(t){this._fillMode=t?e.PointFillMode:e.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillMode",{get:function(){return this._fillMode},set:function(t){this._fillMode=t},enumerable:!0,configurable:!0}),e.prototype.toString=function(t){return"Name: "+this.name},Object.defineProperty(e.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:!0,configurable:!0}),e.prototype.freeze=function(){this.checkReadyOnlyOnce=!0},e.prototype.unfreeze=function(){this.checkReadyOnlyOnce=!1},e.prototype.isReady=function(t,e){return!0},e.prototype.getEffect=function(){return this._effect},e.prototype.getScene=function(){return this._scene},e.prototype.needAlphaBlending=function(){return this.alpha<1},e.prototype.needAlphaTesting=function(){return!1},e.prototype.getAlphaTestTexture=function(){return null},e.prototype.markDirty=function(){this._wasPreviouslyReady=!1},e.prototype._preBind=function(){var t=this._scene.getEngine(),i=this.sideOrientation===e.ClockWiseSideOrientation;t.enableEffect(this._effect),t.setState(this.backFaceCulling,this.zOffset,!1,i)},e.prototype.bind=function(t,e){if(this._scene._cachedMaterial=this,this.onBindObservable.notifyObservers(e),this.disableDepthWrite){var i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}},e.prototype.bindOnlyWorldMatrix=function(t){},e.prototype.unbind=function(){if(this.onUnBindObservable.notifyObservers(this),this.disableDepthWrite){this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState)}},e.prototype.clone=function(t){return null},e.prototype.getBindedMeshes=function(){for(var t=new Array,e=0;e<this._scene.meshes.length;e++){var i=this._scene.meshes[e];i.material===this&&t.push(i)}return t},e.prototype.dispose=function(t,e){this.getScene().stopAnimation(this);var i=this._scene.materials.indexOf(this);for(i>=0&&this._scene.materials.splice(i,1),t&&this._effect&&(this._scene.getEngine()._releaseEffect(this._effect),this._effect=null),i=0;i<this._scene.meshes.length;i++){var r=this._scene.meshes[i];r.material===this&&(r.material=null)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBindObservable.clear(),this.onUnBindObservable.clear()},e.prototype.serialize=function(){return t.SerializationHelper.Serialize(this)},e.ParseMultiMaterial=function(e,i){var r=new t.MultiMaterial(e.name,i);r.id=e.id,t.Tags.AddTagsTo(r,e.tags);for(var n=0;n<e.materials.length;n++){var s=e.materials[n];s?r.subMaterials.push(i.getMaterialByID(s)):r.subMaterials.push(null)}return r},e.Parse=function(e,i,r){return e.customType?t.Tools.Instantiate(e.customType).Parse(e,i,r):t.StandardMaterial.Parse(e,i,r)},e._TriangleFillMode=0,e._WireFrameFillMode=1,e._PointFillMode=2,e._ClockWiseSideOrientation=0,e._CounterClockWiseSideOrientation=1,s([t.serialize()],e.prototype,"id",void 0),s([t.serialize()],e.prototype,"name",void 0),s([t.serialize()],e.prototype,"checkReadyOnEveryCall",void 0),s([t.serialize()],e.prototype,"checkReadyOnlyOnce",void 0),s([t.serialize()],e.prototype,"state",void 0),s([t.serialize()],e.prototype,"alpha",void 0),s([t.serialize()],e.prototype,"backFaceCulling",void 0),s([t.serialize()],e.prototype,"sideOrientation",void 0),s([t.serialize()],e.prototype,"alphaMode",void 0),s([t.serialize()],e.prototype,"disableDepthWrite",void 0),s([t.serialize()],e.prototype,"fogEnabled",void 0),s([t.serialize()],e.prototype,"pointSize",void 0),s([t.serialize()],e.prototype,"zOffset",void 0),s([t.serialize()],e.prototype,"wireframe",null),s([t.serialize()],e.prototype,"pointsCloud",null),s([t.serialize()],e.prototype,"fillMode",null),e}();t.Material=i}(r||(r={}));var r;!function(t){var e=function(t){function e(){t.call(this),this.DIFFUSE=!1,this.AMBIENT=!1,this.OPACITY=!1,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.SPECULAR=!1,this.BUMP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.ALPHATEST=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.UV1=!1,this.UV2=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.INVERTNORMALMAPX=!1,this.INVERTNORMALMAPY=!1,this.SHADOWFULLFLOAT=!1,this.CAMERACOLORGRADING=!1,this.CAMERACOLORCURVES=!1,this.rebuild()}return o(e,t),e}(t.MaterialDefines),i=function(i){function r(r,n){var s=this;i.call(this,r,n),this.ambientColor=new t.Color3(0,0,0),this.diffuseColor=new t.Color3(1,1,1),this.specularColor=new t.Color3(1,1,1),this.emissiveColor=new t.Color3(0,0,0),this.specularPower=64,this.useAlphaFromDiffuseTexture=!1,this.useEmissiveAsIllumination=!1,this.linkEmissiveWithDiffuse=!1,this.useReflectionFresnelFromSpecular=!1,this.useSpecularOverAlpha=!1,this.useReflectionOverAlpha=!1,this.disableLighting=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.useLightmapAsShadowmap=!1,this.useGlossinessFromSpecularMapAlpha=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.cameraColorGradingTexture=null,this.cameraColorCurves=null,this._renderTargets=new t.SmartArray(16),this._worldViewProjectionMatrix=t.Matrix.Zero(),this._globalAmbientColor=new t.Color3(0,0,0),this._defines=new e,this._cachedDefines=new e,this._cachedDefines.BonesPerMesh=-1,this.getRenderTargetTextures=function(){return s._renderTargets.reset(),s.reflectionTexture&&s.reflectionTexture.isRenderTarget&&s._renderTargets.push(s.reflectionTexture),s.refractionTexture&&s.refractionTexture.isRenderTarget&&s._renderTargets.push(s.refractionTexture),s._renderTargets}}return o(r,i),Object.defineProperty(r.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!0,configurable:!0}),r.prototype.needAlphaBlending=function(){return this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled},r.prototype.needAlphaTesting=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha},r.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&this.useAlphaFromDiffuseTexture},r.prototype.getAlphaTestTexture=function(){return this.diffuseTexture},r.prototype._checkCache=function(t,e,i){return!e||this._defines.INSTANCES===i&&!(!e._materialDefines||!e._materialDefines.isEqual(this._defines))},r.prototype.isReady=function(i,n){if(this.isFrozen&&this._wasPreviouslyReady)return!0;var s=this.getScene(),o=s.getEngine(),a=!1,h=!1;if(this._defines.reset(),s.lightsEnabled&&!this.disableLighting&&(h=t.MaterialHelper.PrepareDefinesForLights(s,i,this._defines,this.maxSimultaneousLights)),!this.checkReadyOnEveryCall&&this._renderId===s.getRenderId()&&this._checkCache(s,i,n))return!0;if(s.texturesEnabled){if(this.diffuseTexture&&r.DiffuseTextureEnabled){if(!this.diffuseTexture.isReady())return!1;a=!0,this._defines.DIFFUSE=!0}if(this.ambientTexture&&r.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;a=!0,this._defines.AMBIENT=!0}if(this.opacityTexture&&r.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;a=!0,this._defines.OPACITY=!0,this.opacityTexture.getAlphaFromRGB&&(this._defines.OPACITYRGB=!0)}if(this.reflectionTexture&&r.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;switch(h=!0,this._defines.REFLECTION=!0,this.roughness>0&&(this._defines.ROUGHNESS=!0),this.useReflectionOverAlpha&&(this._defines.REFLECTIONOVERALPHA=!0),this.reflectionTexture.coordinatesMode===t.Texture.INVCUBIC_MODE&&(this._defines.INVERTCUBICMAP=!0),this._defines.REFLECTIONMAP_3D=this.reflectionTexture.isCube,this.reflectionTexture.coordinatesMode){case t.Texture.CUBIC_MODE:case t.Texture.INVCUBIC_MODE:this._defines.REFLECTIONMAP_CUBIC=!0;break;case t.Texture.EXPLICIT_MODE:this._defines.REFLECTIONMAP_EXPLICIT=!0;break;case t.Texture.PLANAR_MODE:this._defines.REFLECTIONMAP_PLANAR=!0;break;case t.Texture.PROJECTION_MODE:this._defines.REFLECTIONMAP_PROJECTION=!0;break;case t.Texture.SKYBOX_MODE:this._defines.REFLECTIONMAP_SKYBOX=!0;break;case t.Texture.SPHERICAL_MODE:this._defines.REFLECTIONMAP_SPHERICAL=!0;break;case t.Texture.EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case t.Texture.FIXED_EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0}}if(this.emissiveTexture&&r.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;a=!0,this._defines.EMISSIVE=!0}if(this.lightmapTexture&&r.LightmapTextureEnabled){if(!this.lightmapTexture.isReady())return!1;a=!0,this._defines.LIGHTMAP=!0,this._defines.USELIGHTMAPASSHADOWMAP=this.useLightmapAsShadowmap}if(this.specularTexture&&r.SpecularTextureEnabled){if(!this.specularTexture.isReady())return!1;a=!0,this._defines.SPECULAR=!0,this._defines.GLOSSINESS=this.useGlossinessFromSpecularMapAlpha}if(s.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&r.BumpTextureEnabled){if(!this.bumpTexture.isReady())return!1;a=!0,this._defines.BUMP=!0,this.useParallax&&(this._defines.PARALLAX=!0,this.useParallaxOcclusion&&(this._defines.PARALLAXOCCLUSION=!0)),this.invertNormalMapX&&(this._defines.INVERTNORMALMAPX=!0),this.invertNormalMapY&&(this._defines.INVERTNORMALMAPY=!0)}if(this.refractionTexture&&r.RefractionTextureEnabled){if(!this.refractionTexture.isReady())return!1;a=!0,this._defines.REFRACTION=!0,this._defines.REFRACTIONMAP_3D=this.refractionTexture.isCube}if(this.cameraColorGradingTexture&&r.ColorGradingTextureEnabled){if(!this.cameraColorGradingTexture.isReady())return!1;this._defines.CAMERACOLORGRADING=!0}}if(s.clipPlane&&(this._defines.CLIPPLANE=!0),o.getAlphaTesting()&&(this._defines.ALPHATEST=!0),this._shouldUseAlphaFromDiffuseTexture()&&(this._defines.ALPHAFROMDIFFUSE=!0),this.useEmissiveAsIllumination&&(this._defines.EMISSIVEASILLUMINATION=!0),this.linkEmissiveWithDiffuse&&(this._defines.LINKEMISSIVEWITHDIFFUSE=!0),this.useLogarithmicDepth&&(this._defines.LOGARITHMICDEPTH=!0),this.cameraColorCurves&&(this._defines.CAMERACOLORCURVES=!0),(this.pointsCloud||s.forcePointsCloud)&&(this._defines.POINTSIZE=!0),s.fogEnabled&&i&&i.applyFog&&s.fogMode!==t.Scene.FOGMODE_NONE&&this.fogEnabled&&(this._defines.FOG=!0),r.FresnelEnabled&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled||this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled||this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled||this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled)&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(this._defines.DIFFUSEFRESNEL=!0),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&(this._defines.OPACITYFRESNEL=!0),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(this._defines.REFLECTIONFRESNEL=!0,this.useReflectionFresnelFromSpecular&&(this._defines.REFLECTIONFRESNELFROMSPECULAR=!0)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(this._defines.REFRACTIONFRESNEL=!0),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._defines.EMISSIVEFRESNEL=!0),h=!0,this._defines.FRESNEL=!0),this._defines.SPECULARTERM&&this.useSpecularOverAlpha&&(this._defines.SPECULAROVERALPHA=!0),i&&(h&&i.isVerticesDataPresent(t.VertexBuffer.NormalKind)&&(this._defines.NORMAL=!0),a&&(i.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(this._defines.UV1=!0),i.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(this._defines.UV2=!0)),i.useVertexColors&&i.isVerticesDataPresent(t.VertexBuffer.ColorKind)&&(this._defines.VERTEXCOLOR=!0,i.hasVertexAlpha&&(this._defines.VERTEXALPHA=!0)),i.useBones&&i.computeBonesUsingShaders&&(this._defines.NUM_BONE_INFLUENCERS=i.numBoneInfluencers,this._defines.BonesPerMesh=i.skeleton.bones.length+1),n&&(this._defines.INSTANCES=!0)),!this._defines.isEqual(this._cachedDefines)){this._defines.cloneTo(this._cachedDefines),s.resetCachedMaterial();var l=new t.EffectFallbacks;this._defines.REFLECTION&&l.addFallback(0,"REFLECTION"),this._defines.SPECULAR&&l.addFallback(0,"SPECULAR"),this._defines.BUMP&&l.addFallback(0,"BUMP"),this._defines.PARALLAX&&l.addFallback(1,"PARALLAX"),this._defines.PARALLAXOCCLUSION&&l.addFallback(0,"PARALLAXOCCLUSION"),this._defines.SPECULAROVERALPHA&&l.addFallback(0,"SPECULAROVERALPHA"),this._defines.FOG&&l.addFallback(1,"FOG"),this._defines.POINTSIZE&&l.addFallback(0,"POINTSIZE"),this._defines.LOGARITHMICDEPTH&&l.addFallback(0,"LOGARITHMICDEPTH"),t.MaterialHelper.HandleFallbacksForShadows(this._defines,l,this.maxSimultaneousLights),this._defines.SPECULARTERM&&l.addFallback(0,"SPECULARTERM"),this._defines.DIFFUSEFRESNEL&&l.addFallback(1,"DIFFUSEFRESNEL"),this._defines.OPACITYFRESNEL&&l.addFallback(2,"OPACITYFRESNEL"),this._defines.REFLECTIONFRESNEL&&l.addFallback(3,"REFLECTIONFRESNEL"),this._defines.EMISSIVEFRESNEL&&l.addFallback(4,"EMISSIVEFRESNEL"),this._defines.FRESNEL&&l.addFallback(4,"FRESNEL");var c=[t.VertexBuffer.PositionKind];this._defines.NORMAL&&c.push(t.VertexBuffer.NormalKind),this._defines.UV1&&c.push(t.VertexBuffer.UVKind),this._defines.UV2&&c.push(t.VertexBuffer.UV2Kind),this._defines.VERTEXCOLOR&&c.push(t.VertexBuffer.ColorKind),t.MaterialHelper.PrepareAttributesForBones(c,i,this._defines,l),t.MaterialHelper.PrepareAttributesForInstances(c,this._defines);var u=this._defines.toString(),p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","depthValues","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","logarithmicDepthConstant"],d=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"];this._defines.CAMERACOLORCURVES&&t.ColorCurves.PrepareUniforms(p),this._defines.CAMERACOLORGRADING&&t.ColorGradingTexture.PrepareUniformsAndSamplers(p,d),t.MaterialHelper.PrepareUniformsAndSamplersList(p,d,this._defines,this.maxSimultaneousLights),this._effect=s.getEngine().createEffect("default",c,p,d,u,l,this.onCompiled,this.onError,{maxSimultaneousLights:this.maxSimultaneousLights-1})}return!!this._effect.isReady()&&(this._renderId=s.getRenderId(),this._wasPreviouslyReady=!0,i&&(i._materialDefines||(i._materialDefines=new e),this._defines.cloneTo(i._materialDefines)),!0)},r.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null),this.refractionTexture&&this.refractionTexture.isRenderTarget&&this._effect.setTexture("refraction2DSampler",null),i.prototype.unbind.call(this)},r.prototype.bindOnlyWorldMatrix=function(t){this._effect.setMatrix("world",t)},r.prototype.bind=function(e,n){var s=this.getScene();if(this.bindOnlyWorldMatrix(e),t.MaterialHelper.BindBonesParameters(n,this._effect),s.getCachedMaterial()!==this){if(this._effect.setMatrix("viewProjection",s.getTransformMatrix()),r.FresnelEnabled&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(this._effect.setColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),this._effect.setColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._effect.setColor4("opacityParts",new t.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(this._effect.setColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),this._effect.setColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(this._effect.setColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),this._effect.setColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._effect.setColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._effect.setColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this.diffuseTexture&&r.DiffuseTextureEnabled&&(this._effect.setTexture("diffuseSampler",this.diffuseTexture),this._effect.setFloat2("vDiffuseInfos",this.diffuseTexture.coordinatesIndex,this.diffuseTexture.level),this._effect.setMatrix("diffuseMatrix",this.diffuseTexture.getTextureMatrix())),this.ambientTexture&&r.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat2("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&r.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&r.ReflectionTextureEnabled&&(this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat2("vReflectionInfos",this.reflectionTexture.level,this.roughness)),this.emissiveTexture&&r.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.lightmapTexture&&r.LightmapTextureEnabled&&(this._effect.setTexture("lightmapSampler",this.lightmapTexture),this._effect.setFloat2("vLightmapInfos",this.lightmapTexture.coordinatesIndex,this.lightmapTexture.level),this._effect.setMatrix("lightmapMatrix",this.lightmapTexture.getTextureMatrix())),this.specularTexture&&r.SpecularTextureEnabled&&(this._effect.setTexture("specularSampler",this.specularTexture),this._effect.setFloat2("vSpecularInfos",this.specularTexture.coordinatesIndex,this.specularTexture.level),this._effect.setMatrix("specularMatrix",this.specularTexture.getTextureMatrix())),this.bumpTexture&&s.getEngine().getCaps().standardDerivatives&&r.BumpTextureEnabled&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat3("vBumpInfos",this.bumpTexture.coordinatesIndex,1/this.bumpTexture.level,this.parallaxScaleBias),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),this.refractionTexture&&r.RefractionTextureEnabled){var o=1;this.refractionTexture.isCube?this._effect.setTexture("refractionCubeSampler",this.refractionTexture):(this._effect.setTexture("refraction2DSampler",this.refractionTexture),this._effect.setMatrix("refractionMatrix",this.refractionTexture.getReflectionTextureMatrix()),this.refractionTexture.depth&&(o=this.refractionTexture.depth)),this._effect.setFloat4("vRefractionInfos",this.refractionTexture.level,this.indexOfRefraction,o,this.invertRefractionY?-1:1)}this.cameraColorGradingTexture&&r.ColorGradingTextureEnabled&&t.ColorGradingTexture.Bind(this.cameraColorGradingTexture,this._effect)}t.MaterialHelper.BindClipPlane(this._effect,s),this.pointsCloud&&this._effect.setFloat("pointSize",this.pointSize),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this._effect.setVector3("vEyePosition",s._mirroredCameraPosition?s._mirroredCameraPosition:s.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this._defines.SPECULARTERM&&this._effect.setColor4("vSpecularColor",this.specularColor,this.specularPower),this._effect.setColor3("vEmissiveColor",this.emissiveColor)}s.getCachedMaterial()===this&&this.isFrozen||(this._effect.setColor4("vDiffuseColor",this.diffuseColor,this.alpha*n.visibility),s.lightsEnabled&&!this.disableLighting&&t.MaterialHelper.BindLights(s,n,this._effect,this._defines,this.maxSimultaneousLights),(s.fogEnabled&&n.applyFog&&s.fogMode!==t.Scene.FOGMODE_NONE||this.reflectionTexture||this.refractionTexture)&&this._effect.setMatrix("view",s.getViewMatrix()),t.MaterialHelper.BindFogParameters(s,n,this._effect),t.MaterialHelper.BindLogDepth(this._defines,this._effect,s),this.cameraColorCurves&&t.ColorCurves.Bind(this.cameraColorCurves,this._effect)),i.prototype.bind.call(this,e,n)},r.prototype.getAnimatables=function(){var t=[];return this.diffuseTexture&&this.diffuseTexture.animations&&this.diffuseTexture.animations.length>0&&t.push(this.diffuseTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&t.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&t.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&t.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&t.push(this.emissiveTexture),this.specularTexture&&this.specularTexture.animations&&this.specularTexture.animations.length>0&&t.push(this.specularTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&t.push(this.bumpTexture),this.lightmapTexture&&this.lightmapTexture.animations&&this.lightmapTexture.animations.length>0&&t.push(this.lightmapTexture),this.refractionTexture&&this.refractionTexture.animations&&this.refractionTexture.animations.length>0&&t.push(this.refractionTexture),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.animations&&this.cameraColorGradingTexture.animations.length>0&&t.push(this.cameraColorGradingTexture),t},r.prototype.dispose=function(t,e){e&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.specularTexture&&this.specularTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),this.lightmapTexture&&this.lightmapTexture.dispose(),this.refractionTexture&&this.refractionTexture.dispose(),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.dispose()),i.prototype.dispose.call(this,t,e)},r.prototype.clone=function(e){var i=this;return t.SerializationHelper.Clone(function(){return new r(e,i.getScene())},this)},r.prototype.serialize=function(){return t.SerializationHelper.Serialize(this)},r.Parse=function(e,i,n){return t.SerializationHelper.Parse(function(){return new r(e.name,i)},e,i,n)},r.DiffuseTextureEnabled=!0,r.AmbientTextureEnabled=!0,r.OpacityTextureEnabled=!0,r.ReflectionTextureEnabled=!0,r.EmissiveTextureEnabled=!0,r.SpecularTextureEnabled=!0,r.BumpTextureEnabled=!0,r.FresnelEnabled=!0,r.LightmapTextureEnabled=!0,r.RefractionTextureEnabled=!0,r.ColorGradingTextureEnabled=!0,s([t.serializeAsTexture()],r.prototype,"diffuseTexture",void 0),s([t.serializeAsTexture()],r.prototype,"ambientTexture",void 0),s([t.serializeAsTexture()],r.prototype,"opacityTexture",void 0),s([t.serializeAsTexture()],r.prototype,"reflectionTexture",void 0),s([t.serializeAsTexture()],r.prototype,"emissiveTexture",void 0),s([t.serializeAsTexture()],r.prototype,"specularTexture",void 0),s([t.serializeAsTexture()],r.prototype,"bumpTexture",void 0),s([t.serializeAsTexture()],r.prototype,"lightmapTexture",void 0),s([t.serializeAsTexture()],r.prototype,"refractionTexture",void 0),s([t.serializeAsColor3("ambient")],r.prototype,"ambientColor",void 0),s([t.serializeAsColor3("diffuse")],r.prototype,"diffuseColor",void 0),s([t.serializeAsColor3("specular")],r.prototype,"specularColor",void 0),s([t.serializeAsColor3("emissive")],r.prototype,"emissiveColor",void 0),s([t.serialize()],r.prototype,"specularPower",void 0),s([t.serialize()],r.prototype,"useAlphaFromDiffuseTexture",void 0),s([t.serialize()],r.prototype,"useEmissiveAsIllumination",void 0),s([t.serialize()],r.prototype,"linkEmissiveWithDiffuse",void 0),s([t.serialize()],r.prototype,"useReflectionFresnelFromSpecular",void 0),s([t.serialize()],r.prototype,"useSpecularOverAlpha",void 0),s([t.serialize()],r.prototype,"useReflectionOverAlpha",void 0),s([t.serialize()],r.prototype,"disableLighting",void 0),s([t.serialize()],r.prototype,"useParallax",void 0),s([t.serialize()],r.prototype,"useParallaxOcclusion",void 0),s([t.serialize()],r.prototype,"parallaxScaleBias",void 0),s([t.serialize()],r.prototype,"roughness",void 0),s([t.serialize()],r.prototype,"indexOfRefraction",void 0),s([t.serialize()],r.prototype,"invertRefractionY",void 0),s([t.serialize()],r.prototype,"useLightmapAsShadowmap",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"diffuseFresnelParameters",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"opacityFresnelParameters",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"reflectionFresnelParameters",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"refractionFresnelParameters",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"emissiveFresnelParameters",void 0),s([t.serialize()],r.prototype,"useGlossinessFromSpecularMapAlpha",void 0),s([t.serialize()],r.prototype,"maxSimultaneousLights",void 0),s([t.serialize()],r.prototype,"invertNormalMapX",void 0),s([t.serialize()],r.prototype,"invertNormalMapY",void 0),s([t.serializeAsTexture()],r.prototype,"cameraColorGradingTexture",void 0),s([t.serializeAsColorCurves()],r.prototype,"cameraColorCurves",void 0),s([t.serialize()],r.prototype,"useLogarithmicDepth",null),r}(t.Material);t.StandardMaterial=i}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i){e.call(this,t,i,!0),this.subMaterials=new Array,i.multiMaterials.push(this)}return o(i,e),i.prototype.getSubMaterial=function(t){return t<0||t>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[t]},i.prototype.isReady=function(t){for(var e=0;e<this.subMaterials.length;e++){if(this.subMaterials[e]&&!this.subMaterials[e].isReady(t))return!1}return!0},i.prototype.clone=function(t,e){for(var r=new i(t,this.getScene()),n=0;n<this.subMaterials.length;n++){var s=null;s=e?this.subMaterials[n].clone(t+"-"+this.subMaterials[n].name):this.subMaterials[n],r.subMaterials.push(s)}return r},i.prototype.serialize=function(){var e={};e.name=this.name,e.id=this.id,e.tags=t.Tags.GetTags(this),e.materials=[];for(var i=0;i<this.subMaterials.length;i++){var r=this.subMaterials[i];r?e.materials.push(r.id):e.materials.push(null)}return e},i}(t.Material);t.MultiMaterial=e}(r||(r={}));var r;!function(t){var e=function(){function e(){}return Object.defineProperty(e,"NO_LOGGING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MINIMAL_LOGGING",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(e,"SUMMARY_LOGGING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(e,"DETAILED_LOGGING",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(e,"ForceFullSceneLoadingForIncremental",{get:function(){return e._ForceFullSceneLoadingForIncremental},set:function(t){e._ForceFullSceneLoadingForIncremental=t},enumerable:!0,configurable:!0}),Object.defineProperty(e,"ShowLoadingScreen",{get:function(){return e._ShowLoadingScreen},set:function(t){e._ShowLoadingScreen=t},enumerable:!0,configurable:!0}),Object.defineProperty(e,"loggingLevel",{get:function(){return e._loggingLevel},set:function(t){e._loggingLevel=t},enumerable:!0,configurable:!0}),e._getDefaultPlugin=function(){return e._registeredPlugins[".babylon"]},e._getPluginForExtension=function(t){var i=e._registeredPlugins[t];return i?i:e._getDefaultPlugin()},e._getPluginForFilename=function(t){t.name&&(t=t.name);var i=t.lastIndexOf("."),r=t.indexOf("?");r===-1&&(r=t.length);var n=t.substring(i,r).toLowerCase();return e._getPluginForExtension(n)},e._getDirectLoad=function(t){return t.substr&&"data:"===t.substr(0,5)?t.substr(5):null},e.GetPluginForExtension=function(t){return e._getPluginForExtension(t).plugin},e.RegisterPlugin=function(t){if("string"==typeof t.extensions){var i=t.extensions;e._registeredPlugins[i.toLowerCase()]={plugin:t,isBinary:!1}}else{var r=t.extensions;Object.keys(r).forEach(function(i){e._registeredPlugins[i.toLowerCase()]={plugin:t,isBinary:r[i].isBinary}})}},e.ImportMesh=function(i,r,n,s,o,a,h){if(n.substr&&"/"===n.substr(0,1))return void t.Tools.Error("Wrong sceneFilename parameter");if(n.substr&&"/"===n.substr(0,1))return void t.Tools.Error("Wrong sceneFilename parameter");var l=e._getDirectLoad(n),c={};s._addPendingData(c);var u=function(u){s.database=p;var d=l?e._getDefaultPlugin():e._getPluginForFilename(n),f=d.plugin,m=d.isBinary,_=function(t){var e=[],a=[],l=[];try{if(f.importMesh){if(!f.importMesh(i,s,t,r,e,a,l))return h&&h(s,"Unable to import meshes from "+r+n),void s._removePendingData(c);o&&(s.importedMeshesFiles.push(r+n),o(e,a,l),s._removePendingData(c))}else{f.importMeshAsync(i,s,t,r,function(t,e,i){o&&(s.importedMeshesFiles.push(r+n),o(t,e,i),s._removePendingData(c))},function(){h&&h(s,"Unable to import meshes from "+r+n),s._removePendingData(c)})}}catch(t){h&&h(s,"Unable to import meshes from "+r+n,t),s._removePendingData(c)}};if(l)return void _(l);t.Tools.LoadFile(r+n,function(t){_(t)},a,p,m)};if(s.getEngine().enableOfflineSupport&&!l)var p=new t.Database(r+n,u);else u(!0)},e.Load=function(i,r,n,s,o,a){e.Append(i,r,new t.Scene(n),s,o,a)},e.Append=function(i,r,n,s,o,a){if(r.substr&&"/"===r.substr(0,1))return void t.Tools.Error("Wrong sceneFilename parameter");var h,l=e._getDirectLoad(r),c=l?e._getDefaultPlugin():e._getPluginForFilename(r),u=c.plugin,p=c.isBinary,d={};n._addPendingData(d),e.ShowLoadingScreen&&n.getEngine().displayLoadingUI();var f=function(t){if(n.database=h,u.load){if(!u.load(n,t,i))return a&&a(n),n._removePendingData(d),void n.getEngine().hideLoadingUI();s&&s(n),n._removePendingData(d)}else{u.loadAsync(n,t,i,function(){s&&s(n),n._removePendingData(d)},function(){a&&a(n),n._removePendingData(d),n.getEngine().hideLoadingUI()})}e.ShowLoadingScreen&&n.executeWhenReady(function(){n.getEngine().hideLoadingUI()})},m=function(e){t.Tools.LoadFile(i+r,f,o,h,p)};if(l)return void f(l);i.indexOf("file:")===-1?n.getEngine().enableOfflineSupport?h=new t.Database(i+r,m):m(!0):t.Tools.ReadFile(r,f,o,p)},e._ForceFullSceneLoadingForIncremental=!1,e._ShowLoadingScreen=!0,e._loggingLevel=e.NO_LOGGING,e._registeredPlugins={},e}();t.SceneLoader=e}(r||(r={}));var r;!function(t){!function(e){var i=function(e,i,r,n){for(var s=0,o=i.materials.length;s<o;s++){var a=i.materials[s];if(a.id===e)return t.Material.Parse(a,r,n)}return null},r=function(t,e,i){e=e instanceof Array?e:[e];for(var r in e)if(t.name===e[r])return i.push(t.id),!0;return!(!t.parentId||i.indexOf(t.parentId)===-1)&&(i.push(t.id),!0)},n=function(t,e){return t+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown")};t.SceneLoader.RegisterPlugin({extensions:".babylon",importMesh:function(e,s,o,a,h,l,c){var u="importMesh has failed JSON parse";try{var p=JSON.parse(o);u="";var d,f,m=t.SceneLoader.loggingLevel===t.SceneLoader.DETAILED_LOGGING,_=[],g=[],y=[];for(d=0,f=p.meshes.length;d<f;d++){var v=p.meshes[d];if(!e||r(v,e,y)){if(e instanceof Array&&delete e[e.indexOf(v.name)],v.geometryId&&p.geometries){var x=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(function(e){!x&&p.geometries[e]&&p.geometries[e]instanceof Array&&p.geometries[e].forEach(function(i){if(i.id===v.geometryId){switch(e){case"boxes":t.Geometry.Primitives.Box.Parse(i,s);break;case"spheres":t.Geometry.Primitives.Sphere.Parse(i,s);break;case"cylinders":t.Geometry.Primitives.Cylinder.Parse(i,s);break;case"toruses":t.Geometry.Primitives.Torus.Parse(i,s);break;case"grounds":t.Geometry.Primitives.Ground.Parse(i,s);break;case"planes":t.Geometry.Primitives.Plane.Parse(i,s);break;case"torusKnots":t.Geometry.Primitives.TorusKnot.Parse(i,s);break;case"vertexData":t.Geometry.Parse(i,s,a)}x=!0}})}),x||t.Tools.Warn("Geometry not found for mesh "+v.id)}if(v.materialId){var b=g.indexOf(v.materialId)!==-1;if(!b&&p.multiMaterials)for(var P=0,T=p.multiMaterials.length;P<T;P++){var S=p.multiMaterials[P];if(S.id===v.materialId){for(var A=0,C=S.materials.length;A<C;A++){var E=S.materials[A];g.push(E);var M=i(E,p,s,a);u+="\n\tMaterial "+M.toString(m)}g.push(S.id);var D=t.Material.ParseMultiMaterial(S,s);b=!0,u+="\n\tMulti-Material "+D.toString(m);break}}if(!b){g.push(v.materialId);var M=i(v.materialId,p,s,a);M?u+="\n\tMaterial "+M.toString(m):t.Tools.Warn("Material not found for mesh "+v.id)}}if(v.skeletonId>-1&&s.skeletons){if(!(_.indexOf(v.skeletonId)>-1))for(var R=0,I=p.skeletons.length;R<I;R++){var O=p.skeletons[R];if(O.id===v.skeletonId){var w=t.Skeleton.Parse(O,s);c.push(w),_.push(O.id),u+="\n\tSkeleton "+w.toString(m)}}}var L=t.Mesh.Parse(v,s,a);h.push(L),u+="\n\tMesh "+L.toString(m)}}var F;for(d=0,f=s.meshes.length;d<f;d++)F=s.meshes[d],F._waitingParentId&&(F.parent=s.getLastEntryByID(F._waitingParentId),F._waitingParentId=void 0);for(d=0,f=s.meshes.length;d<f;d++)F=s.meshes[d],F._waitingFreezeWorldMatrix?(F.freezeWorldMatrix(),F._waitingFreezeWorldMatrix=void 0):F.computeWorldMatrix(!0);if(p.particleSystems)for(d=0,f=p.particleSystems.length;d<f;d++){var V=p.particleSystems[d];y.indexOf(V.emitterId)!==-1&&l.push(t.ParticleSystem.Parse(V,s,a))}return!0}catch(e){throw t.Tools.Log(n("importMesh",p?p.producer:"Unknown")+u),u=null,e}finally{null!==u&&t.SceneLoader.loggingLevel!==t.SceneLoader.NO_LOGGING&&t.Tools.Log(n("importMesh",p?p.producer:"Unknown")+(t.SceneLoader.loggingLevel!==t.SceneLoader.MINIMAL_LOGGING?u:""))}},load:function(e,i,r){var s="importScene has failed JSON parse";try{var o=JSON.parse(i);s="";var a=t.SceneLoader.loggingLevel===t.SceneLoader.DETAILED_LOGGING;if(e.useDelayedTextureLoading=o.useDelayedTextureLoading&&!t.SceneLoader.ForceFullSceneLoadingForIncremental,e.autoClear=o.autoClear,e.clearColor=t.Color4.FromArray(o.clearColor),e.ambientColor=t.Color3.FromArray(o.ambientColor),o.gravity&&(e.gravity=t.Vector3.FromArray(o.gravity)),o.fogMode&&0!==o.fogMode)switch(e.fogMode=o.fogMode,e.fogColor=t.Color3.FromArray(o.fogColor),e.fogStart=o.fogStart,e.fogEnd=o.fogEnd,e.fogDensity=o.fogDensity,s+="\tFog mode for scene:  ",e.fogMode){case 1:s+="exp\n";break;case 2:s+="exp2\n";break;case 3:s+="linear\n"}if(o.physicsEnabled){var h;"cannon"===o.physicsEngine?h=new t.CannonJSPlugin:"oimo"===o.physicsEngine&&(h=new t.OimoJSPlugin),s="\tPhysics engine "+(o.physicsEngine?o.physicsEngine:"oimo")+" enabled\n";var l=o.physicsGravity?t.Vector3.FromArray(o.physicsGravity):null;e.enablePhysics(l,h)}void 0!==o.metadata&&(e.metadata=o.metadata),void 0!=o.collisionsEnabled&&(e.collisionsEnabled=o.collisionsEnabled),e.workerCollisions=!!o.workerCollisions;var c,u;for(c=0,u=o.lights.length;c<u;c++){var p=o.lights[c],d=t.Light.Parse(p,e);s+=0===c?"\n\tLights:":"",s+="\n\t\t"+d.toString(a)}if(o.animations)for(c=0,u=o.animations.length;c<u;c++){var f=o.animations[c],m=t.Animation.Parse(f);e.animations.push(m),s+=0===c?"\n\tAnimations:":"",s+="\n\t\t"+m.toString(a)}if(o.autoAnimate&&e.beginAnimation(e,o.autoAnimateFrom,o.autoAnimateTo,o.autoAnimateLoop,o.autoAnimateSpeed||1),o.materials)for(c=0,u=o.materials.length;c<u;c++){var _=o.materials[c],g=t.Material.Parse(_,e,r);s+=0===c?"\n\tMaterials:":"",s+="\n\t\t"+g.toString(a)}if(o.multiMaterials)for(c=0,u=o.multiMaterials.length;c<u;c++){var y=o.multiMaterials[c],v=t.Material.ParseMultiMaterial(y,e);s+=0===c?"\n\tMultiMaterials:":"",s+="\n\t\t"+v.toString(a)}if(o.skeletons)for(c=0,u=o.skeletons.length;c<u;c++){var x=o.skeletons[c],b=t.Skeleton.Parse(x,e);s+=0===c?"\n\tSkeletons:":"",s+="\n\t\t"+b.toString(a)}var P=o.geometries;if(P){var T=P.boxes;if(T)for(c=0,u=T.length;c<u;c++){var S=T[c];t.Geometry.Primitives.Box.Parse(S,e)}var A=P.spheres;if(A)for(c=0,u=A.length;c<u;c++){var C=A[c];t.Geometry.Primitives.Sphere.Parse(C,e)}var E=P.cylinders;if(E)for(c=0,u=E.length;c<u;c++){var M=E[c];t.Geometry.Primitives.Cylinder.Parse(M,e)}var D=P.toruses;if(D)for(c=0,u=D.length;c<u;c++){var R=D[c];t.Geometry.Primitives.Torus.Parse(R,e)}var I=P.grounds;if(I)for(c=0,u=I.length;c<u;c++){var O=I[c];t.Geometry.Primitives.Ground.Parse(O,e)}var w=P.planes;if(w)for(c=0,u=w.length;c<u;c++){var L=w[c];t.Geometry.Primitives.Plane.Parse(L,e)}var F=P.torusKnots;if(F)for(c=0,u=F.length;c<u;c++){var V=F[c];t.Geometry.Primitives.TorusKnot.Parse(V,e)}var N=P.vertexData;if(N)for(c=0,u=N.length;c<u;c++){var z=N[c];t.Geometry.Parse(z,e,r)}}for(c=0,u=o.meshes.length;c<u;c++){var B=o.meshes[c],k=t.Mesh.Parse(B,e,r);s+=0===c?"\n\tMeshes:":"",s+="\n\t\t"+k.toString(a)}for(c=0,u=o.cameras.length;c<u;c++){var U=o.cameras[c],G=t.Camera.Parse(U,e);s+=0===c?"\n\tCameras:":"",s+="\n\t\t"+G.toString(a)}for(o.activeCameraID&&e.setActiveCameraByID(o.activeCameraID),c=0,u=e.cameras.length;c<u;c++){var G=e.cameras[c];G._waitingParentId&&(G.parent=e.getLastEntryByID(G._waitingParentId),G._waitingParentId=void 0)}for(c=0,u=e.lights.length;c<u;c++){var d=e.lights[c];d._waitingParentId&&(d.parent=e.getLastEntryByID(d._waitingParentId),d._waitingParentId=void 0)}var W,j=[];if(t.AudioEngine&&o.sounds)for(c=0,u=o.sounds.length;c<u;c++){var H=o.sounds[c];if(t.Engine.audioEngine.canUseWebAudio)H.url||(H.url=H.name),j[H.url]?t.Sound.Parse(H,e,r,j[H.url]):(W=t.Sound.Parse(H,e,r),j[H.url]=W);else{new t.Sound(H.name,null,e)}}for(j=[],c=0,u=e.meshes.length;c<u;c++){var k=e.meshes[c];k._waitingParentId&&(k.parent=e.getLastEntryByID(k._waitingParentId),k._waitingParentId=void 0),k._waitingActions&&(t.ActionManager.Parse(k._waitingActions,k,e),k._waitingActions=void 0)}for(c=0,u=e.meshes.length;c<u;c++){var X=e.meshes[c];X._waitingFreezeWorldMatrix?(X.freezeWorldMatrix(),X._waitingFreezeWorldMatrix=void 0):X.computeWorldMatrix(!0)}if(o.particleSystems)for(c=0,u=o.particleSystems.length;c<u;c++){var Y=o.particleSystems[c];t.ParticleSystem.Parse(Y,e,r)}if(o.lensFlareSystems)for(c=0,u=o.lensFlareSystems.length;c<u;c++){var Z=o.lensFlareSystems[c];t.LensFlareSystem.Parse(Z,e,r)}if(o.shadowGenerators)for(c=0,u=o.shadowGenerators.length;c<u;c++){var K=o.shadowGenerators[c];t.ShadowGenerator.Parse(K,e)}return o.actions&&t.ActionManager.Parse(o.actions,null,e),!0}catch(e){throw t.Tools.Log(n("importScene",o?o.producer:"Unknown")+s),s=null,e}finally{null!==s&&t.SceneLoader.loggingLevel!==t.SceneLoader.NO_LOGGING&&t.Tools.Log(n("importScene",o?o.producer:"Unknown")+(t.SceneLoader.loggingLevel!==t.SceneLoader.MINIMAL_LOGGING?s:""))}}})}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s,o,a){if(void 0===o&&(o=.01),void 0===a&&(a=t.Texture.TRILINEAR_SAMPLINGMODE),this.name=e,this.sprites=new Array,this.renderingGroupId=0,this.layerMask=268435455,this.fogEnabled=!0,this.isPickable=!1,this.onDisposeObservable=new t.Observable,this._vertexBuffers={},this._capacity=r,this._spriteTexture=new t.Texture(i,s,!0,!1,a),this._spriteTexture.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._spriteTexture.wrapV=t.Texture.CLAMP_ADDRESSMODE,n.width&&n.height)this.cellWidth=n.width,this.cellHeight=n.height;else{if(void 0===n)return;this.cellWidth=n,this.cellHeight=n}this._epsilon=o,this._scene=s,this._scene.spriteManagers.push(this);for(var h=[],l=0,c=0;c<r;c++)h.push(l),h.push(l+1),h.push(l+2),h.push(l),h.push(l+2),h.push(l+3),l+=4;this._indexBuffer=s.getEngine().createIndexBuffer(h),this._vertexData=new Float32Array(16*r*4),this._buffer=new t.Buffer(s.getEngine(),this._vertexData,!0,16);var u=this._buffer.createVertexBuffer(t.VertexBuffer.PositionKind,0,4),p=this._buffer.createVertexBuffer("options",4,4),d=this._buffer.createVertexBuffer("cellInfo",8,4),f=this._buffer.createVertexBuffer(t.VertexBuffer.ColorKind,12,4);this._vertexBuffers[t.VertexBuffer.PositionKind]=u,this._vertexBuffers.options=p,this._vertexBuffers.cellInfo=d,this._vertexBuffers[t.VertexBuffer.ColorKind]=f,this._effectBase=this._scene.getEngine().createEffect("sprites",[t.VertexBuffer.PositionKind,"options","cellInfo",t.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._effectFog=this._scene.getEngine().createEffect("sprites",[t.VertexBuffer.PositionKind,"options","cellInfo",t.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")}return Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texture",{get:function(){return this._spriteTexture},set:function(t){this._spriteTexture=t},enumerable:!0,configurable:!0}),e.prototype._appendSpriteVertex=function(t,e,i,r,n){var s=16*t;0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),this._vertexData[s]=e.position.x,this._vertexData[s+1]=e.position.y,this._vertexData[s+2]=e.position.z,this._vertexData[s+3]=e.angle,this._vertexData[s+4]=e.width,this._vertexData[s+5]=e.height,this._vertexData[s+6]=i,this._vertexData[s+7]=r,this._vertexData[s+8]=e.invertU?1:0,this._vertexData[s+9]=e.invertV?1:0;var o=e.cellIndex/n>>0;this._vertexData[s+10]=e.cellIndex-o*n,this._vertexData[s+11]=o,this._vertexData[s+12]=e.color.r,this._vertexData[s+13]=e.color.g,this._vertexData[s+14]=e.color.b,this._vertexData[s+15]=e.color.a},e.prototype.intersects=function(e,i,r,n){for(var s,o=Math.min(this._capacity,this.sprites.length),a=t.Vector3.Zero(),h=t.Vector3.Zero(),l=Number.MAX_VALUE,c=t.Vector3.Zero(),u=i.getViewMatrix(),p=0;p<o;p++){var d=this.sprites[p];if(d){if(r){if(!r(d))continue}else if(!d.isPickable)continue;if(t.Vector3.TransformCoordinatesToRef(d.position,u,c),a.copyFromFloats(c.x-d.width/2,c.y-d.height/2,c.z),h.copyFromFloats(c.x+d.width/2,c.y+d.height/2,c.z),e.intersectsBoxMinMax(a,h)){var f=t.Vector3.Distance(c,e.origin);if(l>f&&(l=f,s=d,n))break}}}if(s){var m=new t.PickingInfo;return m.hit=!0,m.pickedSprite=s,m.distance=l,m}return null},e.prototype.render=function(){if(this._effectBase.isReady()&&this._effectFog.isReady()&&this._spriteTexture&&this._spriteTexture.isReady()){for(var e=this._scene.getEngine(),i=this._spriteTexture.getBaseSize(),r=e.getDeltaTime(),n=Math.min(this._capacity,this.sprites.length),s=i.width/this.cellWidth,o=0,a=0;a<n;a++){var h=this.sprites[a];h&&(h._animate(r),this._appendSpriteVertex(o++,h,0,0,s),this._appendSpriteVertex(o++,h,1,0,s),this._appendSpriteVertex(o++,h,1,1,s),this._appendSpriteVertex(o++,h,0,1,s))}this._buffer.update(this._vertexData);var l=this._effectBase;this._scene.fogEnabled&&this._scene.fogMode!==t.Scene.FOGMODE_NONE&&this.fogEnabled&&(l=this._effectFog),e.enableEffect(l);var c=this._scene.getViewMatrix();l.setTexture("diffuseSampler",this._spriteTexture),l.setMatrix("view",c),l.setMatrix("projection",this._scene.getProjectionMatrix()),l.setFloat2("textureInfos",this.cellWidth/i.width,this.cellHeight/i.height),this._scene.fogEnabled&&this._scene.fogMode!==t.Scene.FOGMODE_NONE&&this.fogEnabled&&(l.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),l.setColor3("vFogColor",this._scene.fogColor)),e.bindBuffers(this._vertexBuffers,this._indexBuffer,l),e.setDepthFunctionToLessOrEqual(),l.setBool("alphaTest",!0),e.setColorWrite(!1),e.draw(!0,0,6*n),e.setColorWrite(!0),l.setBool("alphaTest",!1),e.setAlphaMode(t.Engine.ALPHA_COMBINE),e.draw(!0,0,6*n),e.setAlphaMode(t.Engine.ALPHA_DISABLE)}},e.prototype.dispose=function(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._spriteTexture&&(this._spriteTexture.dispose(),this._spriteTexture=null);var t=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},e}();t.SpriteManager=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){this.name=e,this.color=new t.Color4(1,1,1,1),this.width=1,this.height=1,this.angle=0,this.cellIndex=0,this.invertU=0,this.invertV=0,this.animations=new Array,this.isPickable=!1,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._frameCount=0,this._time=0,this._manager=i,this._manager.sprites.push(this),this.position=t.Vector3.Zero()}return Object.defineProperty(e.prototype,"size",{get:function(){return this.width},set:function(t){this.width=t,this.height=t},enumerable:!0,configurable:!0}),e.prototype.playAnimation=function(t,e,i,r,n){this._fromIndex=t,this._toIndex=e,this._loopAnimation=i,this._delay=r,this._animationStarted=!0,this._direction=t<e?1:-1,this.cellIndex=t,this._time=0,this._onAnimationEnd=n},e.prototype.stopAnimation=function(){this._animationStarted=!1},e.prototype._animate=function(t){this._animationStarted&&(this._time+=t,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,this.cellIndex===this._toIndex&&(this._loopAnimation?this.cellIndex=this._fromIndex:(this._animationStarted=!1,this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()))))},e.prototype.dispose=function(){for(var t=0;t<this._manager.sprites.length;t++)this._manager.sprites[t]==this&&this._manager.sprites.splice(t,1)},e}();t.Sprite=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s){this.name=e,this.scale=new t.Vector2(1,1),this.offset=new t.Vector2(0,0),this.alphaBlendingMode=t.Engine.ALPHA_COMBINE,this._vertexBuffers={},this.onDisposeObservable=new t.Observable,this.onBeforeRenderObservable=new t.Observable,this.onAfterRenderObservable=new t.Observable,this.texture=i?new t.Texture(i,r,!0):null,this.isBackground=void 0===n||n,this.color=void 0===s?new t.Color4(1,1,1,1):s,this._scene=r,this._scene.layers.push(this);var o=r.getEngine(),a=[];a.push(1,1),a.push(-1,1),a.push(-1,-1),a.push(1,-1);var h=new t.VertexBuffer(o,a,t.VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[t.VertexBuffer.PositionKind]=h;var l=[];l.push(0),l.push(1),l.push(2),l.push(0),l.push(2),l.push(3),this._indexBuffer=o.createIndexBuffer(l),this._effect=o.createEffect("layer",[t.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],""),this._alphaTestEffect=o.createEffect("layer",[t.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"#define ALPHATEST")}return Object.defineProperty(e.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),e.prototype.render=function(){var e=this.alphaTest?this._alphaTestEffect:this._effect;if(e.isReady()&&this.texture&&this.texture.isReady()){var i=this._scene.getEngine();this.onBeforeRenderObservable.notifyObservers(this),i.enableEffect(e),i.setState(!1),e.setTexture("textureSampler",this.texture),e.setMatrix("textureMatrix",this.texture.getTextureMatrix()),e.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),e.setVector2("offset",this.offset),e.setVector2("scale",this.scale),i.bindBuffers(this._vertexBuffers,this._indexBuffer,e),this.alphaTest?i.draw(!0,0,6):(i.setAlphaMode(this.alphaBlendingMode),i.draw(!0,0,6),i.setAlphaMode(t.Engine.ALPHA_DISABLE)),this.onAfterRenderObservable.notifyObservers(this)}},e.prototype.dispose=function(){var e=this._vertexBuffers[t.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[t.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null);var i=this._scene.layers.indexOf(this);this._scene.layers.splice(i,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()},e}();t.Layer=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this.position=t.Vector3.Zero(),this.direction=t.Vector3.Zero(),this.color=new t.Color4(0,0,0,0),this.colorStep=new t.Color4(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.angle=0,this.angularSpeed=0}return e.prototype.copyTo=function(t){t.position.copyFrom(this.position),t.direction.copyFrom(this.direction),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t.size=this.size,t.angle=this.angle,t.angularSpeed=this.angularSpeed},e}();t.Particle=e}(r||(r={}));var r;!function(t){var e=function(t,e){return t===e?t:Math.random()*(e-t)+t},i=function(){function i(r,n,s,o){var a=this;this.name=r,this.animations=[],this.renderingGroupId=0,this.emitter=null,this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.onDisposeObservable=new t.Observable,this.blendMode=i.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.gravity=t.Vector3.Zero(),this.direction1=new t.Vector3(0,1,0),this.direction2=new t.Vector3(0,1,0),this.minEmitBox=new t.Vector3(-.5,-.5,-.5),this.maxEmitBox=new t.Vector3(.5,.5,.5),this.color1=new t.Color4(1,1,1,1),this.color2=new t.Color4(1,1,1,1),this.colorDead=new t.Color4(0,0,0,1),this.textureMask=new t.Color4(1,1,1,1),this.particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new t.Color4(0,0,0,0),this._colorDiff=new t.Color4(0,0,0,0),this._scaledDirection=t.Vector3.Zero(),this._scaledGravity=t.Vector3.Zero(),this._currentRenderId=-1,this._started=!1,this._stopped=!1,this._actualFrame=0,this.id=r,this._capacity=n,this._scene=s,this._customEffect=o,s.particleSystems.push(this);for(var h=[],l=0,c=0;c<n;c++)h.push(l),h.push(l+1),h.push(l+2),h.push(l),h.push(l+2),h.push(l+3),l+=4;this._indexBuffer=s.getEngine().createIndexBuffer(h),this._vertexData=new Float32Array(11*n*4),this._vertexBuffer=new t.Buffer(s.getEngine(),this._vertexData,!0,11);var u=this._vertexBuffer.createVertexBuffer(t.VertexBuffer.PositionKind,0,3),p=this._vertexBuffer.createVertexBuffer(t.VertexBuffer.ColorKind,3,4),d=this._vertexBuffer.createVertexBuffer("options",7,4);this._vertexBuffers[t.VertexBuffer.PositionKind]=u,this._vertexBuffers[t.VertexBuffer.ColorKind]=p,this._vertexBuffers.options=d,this.startDirectionFunction=function(i,r,n,s){var o=e(a.direction1.x,a.direction2.x),h=e(a.direction1.y,a.direction2.y),l=e(a.direction1.z,a.direction2.z);t.Vector3.TransformNormalFromFloatsToRef(o*i,h*i,l*i,r,n)},this.startPositionFunction=function(i,r,n){var s=e(a.minEmitBox.x,a.maxEmitBox.x),o=e(a.minEmitBox.y,a.maxEmitBox.y),h=e(a.minEmitBox.z,a.maxEmitBox.z);t.Vector3.TransformCoordinatesFromFloatsToRef(s,o,h,i,r)},this.updateFunction=function(t){for(var e=0;e<t.length;e++){var i=t[e];i.age+=a._scaledUpdateSpeed,i.age>=i.lifeTime?(a.recycleParticle(i),e--):(i.colorStep.scaleToRef(a._scaledUpdateSpeed,a._scaledColorStep),i.color.addInPlace(a._scaledColorStep),i.color.a<0&&(i.color.a=0),i.angle+=i.angularSpeed*a._scaledUpdateSpeed,i.direction.scaleToRef(a._scaledUpdateSpeed,a._scaledDirection),i.position.addInPlace(a._scaledDirection),a.gravity.scaleToRef(a._scaledUpdateSpeed,a._scaledGravity),i.direction.addInPlace(a._scaledGravity))}}}return Object.defineProperty(i.prototype,"onDispose",{set:function(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)},enumerable:!0,configurable:!0}),i.prototype.recycleParticle=function(t){var e=this.particles.pop();e!==t&&(e.copyTo(t),this._stockParticles.push(e))},i.prototype.getCapacity=function(){return this._capacity},i.prototype.isAlive=function(){return this._alive},i.prototype.isStarted=function(){return this._started},i.prototype.start=function(){this._started=!0,this._stopped=!1,this._actualFrame=0},i.prototype.stop=function(){this._stopped=!0},i.prototype._appendParticleVertex=function(t,e,i,r){var n=11*t;this._vertexData[n]=e.position.x,this._vertexData[n+1]=e.position.y,this._vertexData[n+2]=e.position.z,this._vertexData[n+3]=e.color.r,this._vertexData[n+4]=e.color.g,this._vertexData[n+5]=e.color.b,this._vertexData[n+6]=e.color.a,this._vertexData[n+7]=e.angle,this._vertexData[n+8]=e.size,this._vertexData[n+9]=i,this._vertexData[n+10]=r},i.prototype._update=function(i){this._alive=this.particles.length>0,this.updateFunction(this.particles);var r;r=this.emitter.position?this.emitter.getWorldMatrix():t.Matrix.Translation(this.emitter.x,this.emitter.y,this.emitter.z);for(var n,s=0;s<i&&this.particles.length!==this._capacity;s++){0!==this._stockParticles.length?(n=this._stockParticles.pop(),n.age=0):n=new t.Particle,this.particles.push(n);var o=e(this.minEmitPower,this.maxEmitPower);this.startDirectionFunction(o,r,n.direction,n),n.lifeTime=e(this.minLifeTime,this.maxLifeTime),n.size=e(this.minSize,this.maxSize),n.angularSpeed=e(this.minAngularSpeed,this.maxAngularSpeed),this.startPositionFunction(r,n.position,n);var a=e(0,1);t.Color4.LerpToRef(this.color1,this.color2,a,n.color),this.colorDead.subtractToRef(n.color,this._colorDiff),this._colorDiff.scaleToRef(1/n.lifeTime,n.colorStep)}},i.prototype._getEffect=function(){if(this._customEffect)return this._customEffect;var e=[];this._scene.clipPlane&&e.push("#define CLIPPLANE");var i=e.join("\n");return this._cachedDefines!==i&&(this._cachedDefines=i,this._effect=this._scene.getEngine().createEffect("particles",[t.VertexBuffer.PositionKind,t.VertexBuffer.ColorKind,"options"],["invView","view","projection","vClipPlane","textureMask"],["diffuseSampler"],i)),this._effect},i.prototype.animate=function(){if(this._started){var t=this._getEffect();if(this.emitter&&t.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this._currentRenderId!==this._scene.getRenderId()){this._currentRenderId=this._scene.getRenderId(),this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var e;this.manualEmitCount>-1?(e=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0):(e=this.emitRate*this._scaledUpdateSpeed>>0,this._newPartsExcess+=this.emitRate*this._scaledUpdateSpeed-e),this._newPartsExcess>1&&(e+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?e=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(e),this._stopped&&(this._alive||(this._started=!1,this.disposeOnStop&&this._scene._toBeDisposed.push(this)));for(var i=0,r=0;r<this.particles.length;r++){var n=this.particles[r];this._appendParticleVertex(i++,n,0,0),this._appendParticleVertex(i++,n,1,0),this._appendParticleVertex(i++,n,1,1),this._appendParticleVertex(i++,n,0,1)}this._vertexBuffer.update(this._vertexData)}}},i.prototype.render=function(){var e=this._getEffect();if(!(this.emitter&&e.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this.particles.length))return 0;var r=this._scene.getEngine();r.enableEffect(e),r.setState(!1);var n=this._scene.getViewMatrix();if(e.setTexture("diffuseSampler",this.particleTexture),e.setMatrix("view",n),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._scene.clipPlane){var s=this._scene.clipPlane,o=n.clone();o.invert(),e.setMatrix("invView",o),e.setFloat4("vClipPlane",s.normal.x,s.normal.y,s.normal.z,s.d)}return r.bindBuffers(this._vertexBuffers,this._indexBuffer,e),this.blendMode===i.BLENDMODE_ONEONE?r.setAlphaMode(t.Engine.ALPHA_ONEONE):r.setAlphaMode(t.Engine.ALPHA_COMBINE),this.forceDepthWrite&&r.setDepthWrite(!0),r.draw(!0,0,6*this.particles.length),r.setAlphaMode(t.Engine.ALPHA_DISABLE),this.particles.length},i.prototype.dispose=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null);var t=this._scene.particleSystems.indexOf(this);this._scene.particleSystems.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()},i.prototype.clone=function(e,r){var n=new i(e,this._capacity,this._scene);return t.Tools.DeepCopy(this,n,["particles"]),void 0===r&&(r=this.emitter),n.emitter=r,this.particleTexture&&(n.particleTexture=new t.Texture(this.particleTexture.url,this._scene)),n.start(),n},i.prototype.serialize=function(){var e={};return e.name=this.name,e.id=this.id,this.emitter.position?e.emitterId=this.emitter.id:e.emitter=this.emitter.asArray(),e.capacity=this.getCapacity(),this.particleTexture&&(e.textureName=this.particleTexture.name),t.Animation.AppendSerializedAnimations(this,e),e.minAngularSpeed=this.minAngularSpeed,e.maxAngularSpeed=this.maxAngularSpeed,e.minSize=this.minSize,e.maxSize=this.maxSize,e.minEmitPower=this.minEmitPower,e.maxEmitPower=this.maxEmitPower,e.minLifeTime=this.minLifeTime,e.maxLifeTime=this.maxLifeTime,e.emitRate=this.emitRate,e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e.gravity=this.gravity.asArray(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.color1=this.color1.asArray(),e.color2=this.color2.asArray(),e.colorDead=this.colorDead.asArray(),e.updateSpeed=this.updateSpeed,e.targetStopDuration=this.targetStopDuration,e.textureMask=this.textureMask.asArray(),e.blendMode=this.blendMode,e},i.Parse=function(e,r,n){var s=e.name,o=new i(s,e.capacity,r);if(e.id&&(o.id=e.id),e.textureName&&(o.particleTexture=new t.Texture(n+e.textureName,r),o.particleTexture.name=e.textureName),e.emitterId?o.emitter=r.getLastMeshByID(e.emitterId):o.emitter=t.Vector3.FromArray(e.emitter),e.animations)for(var a=0;a<e.animations.length;a++){var h=e.animations[a];o.animations.push(t.Animation.Parse(h))}return e.autoAnimate&&r.beginAnimation(o,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),o.minAngularSpeed=e.minAngularSpeed,o.maxAngularSpeed=e.maxAngularSpeed,o.minSize=e.minSize,o.maxSize=e.maxSize,o.minLifeTime=e.minLifeTime,o.maxLifeTime=e.maxLifeTime,o.minEmitPower=e.minEmitPower,o.maxEmitPower=e.maxEmitPower,o.emitRate=e.emitRate,o.minEmitBox=t.Vector3.FromArray(e.minEmitBox),o.maxEmitBox=t.Vector3.FromArray(e.maxEmitBox),o.gravity=t.Vector3.FromArray(e.gravity),o.direction1=t.Vector3.FromArray(e.direction1),o.direction2=t.Vector3.FromArray(e.direction2),o.color1=t.Color4.FromArray(e.color1),o.color2=t.Color4.FromArray(e.color2),o.colorDead=t.Color4.FromArray(e.colorDead),o.updateSpeed=e.updateSpeed,o.targetStopDuration=e.targetStopDuration,o.textureMask=t.Color4.FromArray(e.textureMask),o.blendMode=e.blendMode,e.preventAutoStart||o.start(),o},i.BLENDMODE_ONEONE=0,i.BLENDMODE_STANDARD=1,i}();t.ParticleSystem=i}(r||(r={}));var r;!function(t){var e=function(){function t(t,e,i){this.name=t,this.from=e,this.to=i}return t.prototype.clone=function(){return new t(this.name,this.from,this.to)},t}();t.AnimationRange=e;var i=function(){function t(t,e,i){this.frame=t,this.action=e,this.onlyOnce=i,this.isDone=!1}return t}();t.AnimationEvent=i;var r=function(){function e(t){this.path=t,this._onchange=new Array,this.value=0,this.animations=new Array}return e.prototype.getPoint=function(){var e=this.path.getPointAtLengthPosition(this.value);return new t.Vector3(e.x,0,e.y)},e.prototype.moveAhead=function(t){return void 0===t&&(t=.002),this.move(t),this},e.prototype.moveBack=function(t){return void 0===t&&(t=.002),this.move(-t),this},e.prototype.move=function(t){if(Math.abs(t)>1)throw"step size should be less than 1.";return this.value+=t,this.ensureLimits(),this.raiseOnChange(),this},e.prototype.ensureLimits=function(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this},e.prototype.markAsDirty=function(t){return this.ensureLimits(),this.raiseOnChange(),this},e.prototype.raiseOnChange=function(){var t=this;return this._onchange.forEach(function(e){return e(t)}),this},e.prototype.onchange=function(t){return this._onchange.push(t),this},e}();t.PathCursor=r;var n=function(){function i(t,e,r,n,s,o){this.name=t,this.targetProperty=e,this.framePerSecond=r,this.dataType=n,this.loopMode=s,this.enableBlending=o,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._events=new Array,this.allowMatricesInterpolation=!1,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=e.split("."),this.dataType=n,this.loopMode=void 0===s?i.ANIMATIONLOOPMODE_CYCLE:s}return i._PrepareAnimation=function(e,r,n,s,o,a,h,l){var c=void 0;if(!isNaN(parseFloat(o))&&isFinite(o)?c=i.ANIMATIONTYPE_FLOAT:o instanceof t.Quaternion?c=i.ANIMATIONTYPE_QUATERNION:o instanceof t.Vector3?c=i.ANIMATIONTYPE_VECTOR3:o instanceof t.Vector2?c=i.ANIMATIONTYPE_VECTOR2:o instanceof t.Color3?c=i.ANIMATIONTYPE_COLOR3:o instanceof t.Size&&(c=i.ANIMATIONTYPE_SIZE),void 0==c)return null;var u=new i(e,r,n,c,h),p=[{frame:0,value:o},{frame:s,value:a}];return u.setKeys(p),void 0!==l&&u.setEasingFunction(l),u},i.CreateAndStartAnimation=function(t,e,r,n,s,o,a,h,l,c){var u=i._PrepareAnimation(t,r,n,s,o,a,h,l);return e.getScene().beginDirectAnimation(e,[u],0,s,1===u.loopMode,1,c)},i.CreateMergeAndStartAnimation=function(t,e,r,n,s,o,a,h,l,c){var u=i._PrepareAnimation(t,r,n,s,o,a,h,l);return e.animations.push(u),e.getScene().beginAnimation(e,0,s,1===u.loopMode,1,c)},i.prototype.toString=function(t){var e="Name: "+this.name+", property: "+this.targetProperty;if(e+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],e+=", nKeys: "+(this._keys?this._keys.length:"none"),e+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),t){e+=", Ranges: {";var i=!0;for(var r in this._ranges)i&&(e+=", ",i=!1),e+=r;e+="}"}return e},i.prototype.addEvent=function(t){this._events.push(t)},i.prototype.removeEvents=function(t){for(var e=0;e<this._events.length;e++)this._events[e].frame===t&&(this._events.splice(e,1),e--)},i.prototype.createRange=function(t,i,r){this._ranges[t]||(this._ranges[t]=new e(t,i,r))},i.prototype.deleteRange=function(t,e){if(void 0===e&&(e=!0),this._ranges[t]){if(e)for(var i=this._ranges[t].from,r=this._ranges[t].to,n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=i&&this._keys[n].frame<=r&&this._keys.splice(n,1);this._ranges[t]=void 0}},i.prototype.getRange=function(t){return this._ranges[t]},i.prototype.reset=function(){this._offsetsCache={},this._highLimitsCache={},this.currentFrame=0,this._blendingFactor=0,this._originalBlendValue=null},i.prototype.isStopped=function(){return this._stopped},i.prototype.getKeys=function(){return this._keys},i.prototype.getHighestFrame=function(){for(var t=0,e=0,i=this._keys.length;e<i;e++)t<this._keys[e].frame&&(t=this._keys[e].frame);return t},i.prototype.getEasingFunction=function(){return this._easingFunction},i.prototype.setEasingFunction=function(t){this._easingFunction=t},i.prototype.floatInterpolateFunction=function(t,e,i){return t+(e-t)*i},i.prototype.quaternionInterpolateFunction=function(e,i,r){return t.Quaternion.Slerp(e,i,r)},i.prototype.vector3InterpolateFunction=function(e,i,r){return t.Vector3.Lerp(e,i,r)},i.prototype.vector2InterpolateFunction=function(e,i,r){return t.Vector2.Lerp(e,i,r)},i.prototype.sizeInterpolateFunction=function(e,i,r){return t.Size.Lerp(e,i,r)},i.prototype.color3InterpolateFunction=function(e,i,r){return t.Color3.Lerp(e,i,r)},i.prototype.matrixInterpolateFunction=function(e,i,r){return t.Matrix.Lerp(e,i,r)},i.prototype.clone=function(){var t=new i(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(this._keys&&t.setKeys(this._keys),this._ranges){t._ranges={};for(var e in this._ranges)t._ranges[e]=this._ranges[e].clone()}return t},i.prototype.setKeys=function(t){this._keys=t.slice(0),this._offsetsCache={},this._highLimitsCache={}},i.prototype._getKeyValue=function(t){return"function"==typeof t?t():t},i.prototype._interpolate=function(t,e,r,n,s){if(r===i.ANIMATIONLOOPMODE_CONSTANT&&e>0)return s.clone?s.clone():s;this.currentFrame=t;var o=Math.max(0,Math.min(this._keys.length-1,Math.floor(this._keys.length*(t-this._keys[0].frame)/(this._keys[this._keys.length-1].frame-this._keys[0].frame))-1));if(this._keys[o].frame>=t)for(;o-1>=0&&this._keys[o].frame>=t;)o--;for(var a=o;a<this._keys.length;a++)if(this._keys[a+1].frame>=t){var h=this._getKeyValue(this._keys[a].value),l=this._getKeyValue(this._keys[a+1].value),c=(t-this._keys[a].frame)/(this._keys[a+1].frame-this._keys[a].frame);switch(null!=this._easingFunction&&(c=this._easingFunction.ease(c)),this.dataType){case i.ANIMATIONTYPE_FLOAT:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.floatInterpolateFunction(h,l,c);case i.ANIMATIONLOOPMODE_RELATIVE:return n*e+this.floatInterpolateFunction(h,l,c)}break;case i.ANIMATIONTYPE_QUATERNION:var u=null;switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:u=this.quaternionInterpolateFunction(h,l,c);break;case i.ANIMATIONLOOPMODE_RELATIVE:u=this.quaternionInterpolateFunction(h,l,c).add(n.scale(e))}return u;case i.ANIMATIONTYPE_VECTOR3:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.vector3InterpolateFunction(h,l,c);case i.ANIMATIONLOOPMODE_RELATIVE:return this.vector3InterpolateFunction(h,l,c).add(n.scale(e))}case i.ANIMATIONTYPE_VECTOR2:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.vector2InterpolateFunction(h,l,c);case i.ANIMATIONLOOPMODE_RELATIVE:return this.vector2InterpolateFunction(h,l,c).add(n.scale(e))}case i.ANIMATIONTYPE_SIZE:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(h,l,c);case i.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(h,l,c).add(n.scale(e))}case i.ANIMATIONTYPE_COLOR3:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.color3InterpolateFunction(h,l,c);case i.ANIMATIONLOOPMODE_RELATIVE:return this.color3InterpolateFunction(h,l,c).add(n.scale(e))}case i.ANIMATIONTYPE_MATRIX:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:if(this.allowMatricesInterpolation)return this.matrixInterpolateFunction(h,l,c);case i.ANIMATIONLOOPMODE_RELATIVE:return h}}break}return this._getKeyValue(this._keys[this._keys.length-1].value)},i.prototype.setValue=function(e,i){void 0===i&&(i=!1);var r,n;if(this.targetPropertyPath.length>1){for(var s=this._target[this.targetPropertyPath[0]],o=1;o<this.targetPropertyPath.length-1;o++)s=s[this.targetPropertyPath[o]];r=this.targetPropertyPath[this.targetPropertyPath.length-1],n=s}else r=this.targetPropertyPath[0],n=this._target;this.enableBlending&&this._blendingFactor<=1?(this._originalBlendValue||(n[r].clone?this._originalBlendValue=n[r].clone():this._originalBlendValue=n[r]),this._originalBlendValue.prototype?this._originalBlendValue.prototype.Lerp?n[r]=this._originalBlendValue.construtor.prototype.Lerp(e,this._originalBlendValue,this._blendingFactor):n[r]=e:this._originalBlendValue.m?n[r]=t.Matrix.Lerp(this._originalBlendValue,e,this._blendingFactor):n[r]=this._originalBlendValue*(1-this._blendingFactor)+this._blendingFactor*e,this._blendingFactor+=this.blendingSpeed):n[r]=e,this._target.markAsDirty&&this._target.markAsDirty(this.targetProperty)},i.prototype.goToFrame=function(t){t<this._keys[0].frame?t=this._keys[0].frame:t>this._keys[this._keys.length-1].frame&&(t=this._keys[this._keys.length-1].frame);var e=this._interpolate(t,0,this.loopMode);this.setValue(e)},i.prototype.animate=function(e,r,n,s,o,a){if(void 0===a&&(a=!1),!this.targetPropertyPath||this.targetPropertyPath.length<1)return this._stopped=!0,!1;var h=!0;if(0!==this._keys[0].frame){var l={frame:0,value:this._keys[0].value};this._keys.splice(0,0,l)}(r<this._keys[0].frame||r>this._keys[this._keys.length-1].frame)&&(r=this._keys[0].frame),(n<this._keys[0].frame||n>this._keys[this._keys.length-1].frame)&&(n=this._keys[this._keys.length-1].frame),r===n&&r++;var c,u=n-r,p=e*(this.framePerSecond*o)/1e3,d=0;if(p>u&&!s)h=!1,d=this._getKeyValue(this._keys[this._keys.length-1].value);else if(this.loopMode!==i.ANIMATIONLOOPMODE_CYCLE){var f=n.toString()+r.toString();if(!this._offsetsCache[f]){var m=this._interpolate(r,0,i.ANIMATIONLOOPMODE_CYCLE),_=this._interpolate(n,0,i.ANIMATIONLOOPMODE_CYCLE);switch(this.dataType){case i.ANIMATIONTYPE_FLOAT:this._offsetsCache[f]=_-m;break;case i.ANIMATIONTYPE_QUATERNION:this._offsetsCache[f]=_.subtract(m);break;case i.ANIMATIONTYPE_VECTOR3:this._offsetsCache[f]=_.subtract(m);case i.ANIMATIONTYPE_VECTOR2:this._offsetsCache[f]=_.subtract(m);case i.ANIMATIONTYPE_SIZE:this._offsetsCache[f]=_.subtract(m);case i.ANIMATIONTYPE_COLOR3:this._offsetsCache[f]=_.subtract(m)}this._highLimitsCache[f]=_}d=this._highLimitsCache[f],c=this._offsetsCache[f]}if(void 0===c)switch(this.dataType){case i.ANIMATIONTYPE_FLOAT:c=0;break;case i.ANIMATIONTYPE_QUATERNION:c=new t.Quaternion(0,0,0,0);break;case i.ANIMATIONTYPE_VECTOR3:c=t.Vector3.Zero();break;case i.ANIMATIONTYPE_VECTOR2:c=t.Vector2.Zero();break;case i.ANIMATIONTYPE_SIZE:c=t.Size.Zero();break;case i.ANIMATIONTYPE_COLOR3:c=t.Color3.Black()}var g=p/u>>0,y=h?r+p%u:n,v=this._interpolate(y,g,this.loopMode,c,d);this.setValue(v);for(var x=0;x<this._events.length;x++)if(y>=this._events[x].frame){var b=this._events[x];b.isDone||(b.onlyOnce&&(this._events.splice(x,1),x--),b.isDone=!0,b.action())}else this._events[x].isDone&&!this._events[x].onlyOnce&&(this._events[x].isDone=!1);return h||(this._stopped=!0),h},i.prototype.serialize=function(){var t={};t.name=this.name,t.property=this.targetProperty,t.framePerSecond=this.framePerSecond,t.dataType=this.dataType,t.loopBehavior=this.loopMode;var e=this.dataType;t.keys=[];for(var r=this.getKeys(),n=0;n<r.length;n++){var s=r[n],o={};switch(o.frame=s.frame,e){case i.ANIMATIONTYPE_FLOAT:o.values=[s.value];break;case i.ANIMATIONTYPE_QUATERNION:case i.ANIMATIONTYPE_MATRIX:case i.ANIMATIONTYPE_VECTOR3:case i.ANIMATIONTYPE_COLOR3:o.values=s.value.asArray()}t.keys.push(o)}t.ranges=[];for(var a in this._ranges){var h={};h.name=a,h.from=this._ranges[a].from,h.to=this._ranges[a].to,t.ranges.push(h)}return t},Object.defineProperty(i,"ANIMATIONTYPE_FLOAT",{get:function(){return i._ANIMATIONTYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_VECTOR3",{get:function(){return i._ANIMATIONTYPE_VECTOR3},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_VECTOR2",{get:function(){return i._ANIMATIONTYPE_VECTOR2},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_SIZE",{get:function(){return i._ANIMATIONTYPE_SIZE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_QUATERNION",{get:function(){return i._ANIMATIONTYPE_QUATERNION},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_MATRIX",{get:function(){return i._ANIMATIONTYPE_MATRIX},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_COLOR3",{get:function(){return i._ANIMATIONTYPE_COLOR3},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONLOOPMODE_RELATIVE",{get:function(){return i._ANIMATIONLOOPMODE_RELATIVE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONLOOPMODE_CYCLE",{get:function(){return i._ANIMATIONLOOPMODE_CYCLE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONLOOPMODE_CONSTANT",{get:function(){return i._ANIMATIONLOOPMODE_CONSTANT},enumerable:!0,configurable:!0}),i.Parse=function(e){var r,n,s=new i(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),o=e.dataType,a=[];for(n=0;n<e.keys.length;n++){var h=e.keys[n];switch(o){case i.ANIMATIONTYPE_FLOAT:r=h.values[0];break;case i.ANIMATIONTYPE_QUATERNION:r=t.Quaternion.FromArray(h.values);break;case i.ANIMATIONTYPE_MATRIX:r=t.Matrix.FromArray(h.values);break;case i.ANIMATIONTYPE_COLOR3:r=t.Color3.FromArray(h.values);break;case i.ANIMATIONTYPE_VECTOR3:default:r=t.Vector3.FromArray(h.values)}a.push({frame:h.frame,value:r})}if(s.setKeys(a),e.ranges)for(n=0;n<e.ranges.length;n++)r=e.ranges[n],s.createRange(r.name,r.from,r.to);return s},i.AppendSerializedAnimations=function(t,e){if(t.animations){e.animations=[];for(var i=0;i<t.animations.length;i++){var r=t.animations[i];e.animations.push(r.serialize())}}},i._ANIMATIONTYPE_FLOAT=0,i._ANIMATIONTYPE_VECTOR3=1,i._ANIMATIONTYPE_QUATERNION=2,i._ANIMATIONTYPE_MATRIX=3,i._ANIMATIONTYPE_COLOR3=4,i._ANIMATIONTYPE_VECTOR2=5,i._ANIMATIONTYPE_SIZE=6,i._ANIMATIONLOOPMODE_RELATIVE=0,i._ANIMATIONLOOPMODE_CYCLE=1,i._ANIMATIONLOOPMODE_CONSTANT=2,i}();t.Animation=n}(r||(r={}));var r;!function(t){var e=function(){function t(t,e,i,r,n,s,o,a){void 0===i&&(i=0),void 0===r&&(r=100),void 0===n&&(n=!1),void 0===s&&(s=1),this.target=e,this.fromFrame=i,this.toFrame=r,this.loopAnimation=n,this.speedRatio=s,this.onAnimationEnd=o,this._animations=new Array,this._paused=!1,this.animationStarted=!1,a&&this.appendAnimations(e,a),this._scene=t,t._activeAnimatables.push(this)}return t.prototype.getAnimations=function(){return this._animations},t.prototype.appendAnimations=function(t,e){for(var i=0;i<e.length;i++){var r=e[i];r._target=t,this._animations.push(r)}},t.prototype.getAnimationByTargetProperty=function(t){for(var e=this._animations,i=0;i<e.length;i++)if(e[i].targetProperty===t)return e[i];return null},t.prototype.reset=function(){for(var t=this._animations,e=0;e<t.length;e++)t[e].reset();this._localDelayOffset=null,this._pausedDelay=null},t.prototype.enableBlending=function(t){for(var e=this._animations,i=0;i<e.length;i++)e[i].enableBlending=!0,e[i].blendingSpeed=t},t.prototype.disableBlending=function(){for(var t=this._animations,e=0;e<t.length;e++)t[e].enableBlending=!1},t.prototype.goToFrame=function(t){var e=this._animations;if(e[0]){var i=e[0].framePerSecond,r=e[0].currentFrame,n=t-r,s=1e3*n/i;this._localDelayOffset-=s}for(var o=0;o<e.length;o++)e[o].goToFrame(t)},t.prototype.pause=function(){this._paused||(this._paused=!0)},t.prototype.restart=function(){this._paused=!1},t.prototype.stop=function(t){var e=this._scene._activeAnimatables.indexOf(this);if(e>-1){for(var i=this._animations,r=0,e=i.length-1;e>=0;e--)"string"==typeof t&&i[e].name!=t||(i[e].reset(),i.splice(e,1),r++);i.length==r&&(this._scene._activeAnimatables.splice(e,1),this.onAnimationEnd&&this.onAnimationEnd())}},t.prototype._animate=function(t){if(this._paused)return this.animationStarted=!1,this._pausedDelay||(this._pausedDelay=t),!0;this._localDelayOffset?this._pausedDelay&&(this._localDelayOffset+=t-this._pausedDelay,this._pausedDelay=null):this._localDelayOffset=t;var e,i=!1,r=this._animations;for(e=0;e<r.length;e++){var n=r[e],s=n.animate(t-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this.speedRatio);i=i||s}return this.animationStarted=i,i||(e=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(e,1)),!i&&this.onAnimationEnd&&(this.onAnimationEnd(),this.onAnimationEnd=null),i},t}();t.Animatable=e}(r||(r={}));var r;!function(t){var e=function(){function t(){this._easingMode=t.EASINGMODE_EASEIN}return Object.defineProperty(t,"EASINGMODE_EASEIN",{get:function(){return t._EASINGMODE_EASEIN},enumerable:!0,configurable:!0}),Object.defineProperty(t,"EASINGMODE_EASEOUT",{get:function(){return t._EASINGMODE_EASEOUT},enumerable:!0,configurable:!0}),Object.defineProperty(t,"EASINGMODE_EASEINOUT",{get:function(){return t._EASINGMODE_EASEINOUT},enumerable:!0,configurable:!0}),t.prototype.setEasingMode=function(t){var e=Math.min(Math.max(t,0),2);this._easingMode=e},t.prototype.getEasingMode=function(){return this._easingMode},t.prototype.easeInCore=function(t){throw new Error("You must implement this method")},t.prototype.ease=function(e){switch(this._easingMode){case t.EASINGMODE_EASEIN:return this.easeInCore(e);case t.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?.5*(1-this.easeInCore(2*(1-e)))+.5:.5*this.easeInCore(2*e)},t._EASINGMODE_EASEIN=0,t._EASINGMODE_EASEOUT=1,t._EASINGMODE_EASEINOUT=2,t}();t.EasingFunction=e;var i=function(t){function e(){t.apply(this,arguments)}return o(e,t),e.prototype.easeInCore=function(t){return t=Math.max(0,Math.min(1,t)),1-Math.sqrt(1-t*t)},e}(e);t.CircleEase=i;var r=function(t){function e(e){void 0===e&&(e=1),t.call(this),this.amplitude=e}return o(e,t),e.prototype.easeInCore=function(t){var e=Math.max(0,this.amplitude);return Math.pow(t,3)-t*e*Math.sin(3.141592653589793*t)},e}(e);t.BackEase=r;var n=function(t){function e(e,i){void 0===e&&(e=3),void 0===i&&(i=2),t.call(this),this.bounces=e,this.bounciness=i}return o(e,t),e.prototype.easeInCore=function(t){var e=Math.max(0,this.bounces),i=this.bounciness;i<=1&&(i=1.001);var r=Math.pow(i,e),n=1-i,s=(1-r)/n+.5*r,o=t*s,a=Math.log(-o*(1-i)+1)/Math.log(i),h=Math.floor(a),l=h+1,c=(1-Math.pow(i,h))/(n*s),u=(1-Math.pow(i,l))/(n*s),p=.5*(c+u),d=t-p,f=p-c;return-Math.pow(1/i,e-h)/(f*f)*(d-f)*(d+f)},e}(e);t.BounceEase=n;var s=function(t){function e(){t.apply(this,arguments)}return o(e,t),e.prototype.easeInCore=function(t){return t*t*t},e}(e);t.CubicEase=s;var a=function(t){function e(e,i){void 0===e&&(e=3),void 0===i&&(i=3),t.call(this),this.oscillations=e,this.springiness=i}return o(e,t),e.prototype.easeInCore=function(t){var e=Math.max(0,this.oscillations),i=Math.max(0,this.springiness);return(0==i?t:(Math.exp(i*t)-1)/(Math.exp(i)-1))*Math.sin((6.283185307179586*e+1.5707963267948966)*t)},e}(e);t.ElasticEase=a;var h=function(t){function e(e){void 0===e&&(e=2),t.call(this),this.exponent=e}return o(e,t),e.prototype.easeInCore=function(t){return this.exponent<=0?t:(Math.exp(this.exponent*t)-1)/(Math.exp(this.exponent)-1)},e}(e);t.ExponentialEase=h;var l=function(t){function e(e){void 0===e&&(e=2),t.call(this),this.power=e}return o(e,t),e.prototype.easeInCore=function(t){var e=Math.max(0,this.power);return Math.pow(t,e)},e}(e);t.PowerEase=l;var c=function(t){function e(){t.apply(this,arguments)}return o(e,t),e.prototype.easeInCore=function(t){return t*t},e}(e);t.QuadraticEase=c;var u=function(t){function e(){t.apply(this,arguments)}return o(e,t),e.prototype.easeInCore=function(t){return t*t*t*t},e}(e);t.QuarticEase=u;var p=function(t){function e(){t.apply(this,arguments)}return o(e,t),e.prototype.easeInCore=function(t){return t*t*t*t*t},e}(e);t.QuinticEase=p;var d=function(t){function e(){t.apply(this,arguments)}return o(e,t),e.prototype.easeInCore=function(t){return 1-Math.sin(1.5707963267948966*(1-t))},e}(e);t.SineEase=d;var f=function(e){function i(t,i,r,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===n&&(n=1),e.call(this),this.x1=t,this.y1=i,this.x2=r,this.y2=n}return o(i,e),i.prototype.easeInCore=function(e){return t.BezierCurve.interpolate(e,this.x1,this.y1,this.x2,this.y2)},i}(e);t.BezierCurveEase=f}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){e.call(this,i,r.getScene()),this.name=i,this.children=new Array,this.animations=new Array,this._worldTransform=new t.Matrix,this._absoluteTransform=new t.Matrix,this._invertedAbsoluteTransform=new t.Matrix,this._scaleMatrix=t.Matrix.Identity(),this._scaleVector=new t.Vector3(1,1,1),this._negateScaleChildren=new t.Vector3(1,1,1),this._scalingDeterminant=1,this._syncScaleVector=function(){var e=this.getLocalMatrix(),i=e.m[0]*e.m[0]+e.m[1]*e.m[1]+e.m[2]*e.m[2],r=e.m[4]*e.m[4]+e.m[5]*e.m[5]+e.m[6]*e.m[6],n=e.m[8]*e.m[8]+e.m[9]*e.m[9]+e.m[10]*e.m[10],s=e.m[0]*e.m[1]*e.m[2]*e.m[3]<0?-1:1,o=e.m[4]*e.m[5]*e.m[6]*e.m[7]<0?-1:1,a=e.m[8]*e.m[9]*e.m[10]*e.m[11]<0?-1:1;this._scaleVector.x=s*Math.sqrt(i),this._scaleVector.y=o*Math.sqrt(r),this._scaleVector.z=a*Math.sqrt(n),this._parent&&(this._scaleVector.x/=this._parent._negateScaleChildren.x,this._scaleVector.y/=this._parent._negateScaleChildren.y,this._scaleVector.z/=this._parent._negateScaleChildren.z),t.Matrix.FromValuesToRef(this._scaleVector.x,0,0,0,0,this._scaleVector.y,0,0,0,0,this._scaleVector.z,0,0,0,0,1,this._scaleMatrix)},this._skeleton=r,this._matrix=s,this._baseMatrix=s,this._restPose=o?o:s.clone(),r.bones.push(this),n?(this._parent=n,n.children.push(this)):this._parent=null,this._updateDifferenceMatrix(),this.getAbsoluteTransform().determinant()<0&&(this._scalingDeterminant*=-1)}return o(i,e),i.prototype.getParent=function(){return this._parent},i.prototype.getLocalMatrix=function(){return this._matrix},i.prototype.getBaseMatrix=function(){return this._baseMatrix},i.prototype.getRestPose=function(){return this._restPose},i.prototype.returnToRest=function(){this.updateMatrix(this._restPose.clone())},i.prototype.getWorldMatrix=function(){return this._worldTransform},i.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},i.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},i.prototype.updateMatrix=function(t,e){void 0===e&&(e=!0),this._baseMatrix=t.clone(),this._matrix=t.clone(),this._skeleton._markAsDirty(),e&&this._updateDifferenceMatrix()},i.prototype._updateDifferenceMatrix=function(t){t||(t=this._baseMatrix),this._parent?t.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(t),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var e=0;e<this.children.length;e++)this.children[e]._updateDifferenceMatrix()},i.prototype.markAsDirty=function(){this._currentRenderId++,this._skeleton._markAsDirty()},i.prototype.copyAnimationRange=function(e,i,r,n,s){void 0===n&&(n=!1),void 0===s&&(s=null),0===this.animations.length&&(this.animations.push(new t.Animation(this.name,"_matrix",e.animations[0].framePerSecond,t.Animation.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));var o=e.animations[0].getRange(i);if(!o)return!1;for(var a,h,l,c=o.from,u=o.to,p=e.animations[0].getKeys(),d=e.length,f=e.getParent(),m=this.getParent(),_=n&&f&&d&&this.length&&d!==this.length,g=_?m.length/f.length:null,y=n&&!m&&s&&(1!==s.x||1!==s.y||1!==s.z),v=this.animations[0].getKeys(),x=0,b=p.length;x<b;x++)a=p[x],a.frame>=c&&a.frame<=u&&(n?(l=a.value.clone(),_?(h=l.getTranslation(),l.setTranslation(h.scaleInPlace(g))):y?(h=l.getTranslation(),l.setTranslation(h.multiplyInPlace(s))):l=a.value):l=a.value,v.push({frame:a.frame+r,value:l}));return this.animations[0].createRange(i,c+r,u+r),!0},i.prototype.translate=function(e,i,r){void 0===i&&(i=t.Space.LOCAL);var n=this.getLocalMatrix();if(i==t.Space.LOCAL)n.m[12]+=e.x,n.m[13]+=e.y,n.m[14]+=e.z;else{this._skeleton.computeAbsoluteTransforms();var s=t.Tmp.Matrix[0],o=t.Tmp.Vector3[0];r?(s.copyFrom(this._parent.getAbsoluteTransform()),s.multiplyToRef(r.getWorldMatrix(),s)):s.copyFrom(this._parent.getAbsoluteTransform()),s.m[12]=0,s.m[13]=0,s.m[14]=0,s.invert(),t.Vector3.TransformCoordinatesToRef(e,s,o),n.m[12]+=o.x,n.m[13]+=o.y,n.m[14]+=o.z}this.markAsDirty()},i.prototype.setPosition=function(e,i,r){void 0===i&&(i=t.Space.LOCAL);var n=this.getLocalMatrix();if(i==t.Space.LOCAL)n.m[12]=e.x,n.m[13]=e.y,n.m[14]=e.z;else{this._skeleton.computeAbsoluteTransforms();var s=t.Tmp.Matrix[0],o=t.Tmp.Vector3[0];r?(s.copyFrom(this._parent.getAbsoluteTransform()),s.multiplyToRef(r.getWorldMatrix(),s)):s.copyFrom(this._parent.getAbsoluteTransform()),s.invert(),t.Vector3.TransformCoordinatesToRef(e,s,o),n.m[12]=o.x,n.m[13]=o.y,n.m[14]=o.z}this.markAsDirty()},i.prototype.setAbsolutePosition=function(e,i){this.setPosition(e,t.Space.WORLD,i)},i.prototype.setScale=function(t,e,i,r){void 0===r&&(r=!1),this.animations[0]&&!this.animations[0].isStopped()&&(r||(this._negateScaleChildren.x=1/t,this._negateScaleChildren.y=1/e,this._negateScaleChildren.z=1/i),this._syncScaleVector()),this.scale(t/this._scaleVector.x,e/this._scaleVector.y,i/this._scaleVector.z,r)},i.prototype.scale=function(e,i,r,n){void 0===n&&(n=!1);var s=this.getLocalMatrix(),o=t.Tmp.Matrix[0];o.copyFrom(s);var a=t.Tmp.Matrix[1];a.copyFrom(o),a.invert();var h=t.Tmp.Matrix[2];t.Matrix.FromValuesToRef(e,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1,h),this._scaleMatrix.multiplyToRef(h,this._scaleMatrix),this._scaleVector.x*=e,this._scaleVector.y*=i,this._scaleVector.z*=r,s.multiplyToRef(a,s),s.multiplyToRef(h,s),s.multiplyToRef(o,s);var l=this.getParent();l?s.multiplyToRef(l.getAbsoluteTransform(),this.getAbsoluteTransform()):this.getAbsoluteTransform().copyFrom(s);var c=this.children.length;h.invert();for(var u=0;u<c;u++){var p=this.children[u],d=p.getLocalMatrix();d.multiplyToRef(h,d);var f=p.getLocalMatrix();f.m[12]*=e,f.m[13]*=i,f.m[14]*=r}if(this.computeAbsoluteTransforms(),n)for(var u=0;u<c;u++)this.children[u].scale(e,i,r,n);this.markAsDirty()},i.prototype.setYawPitchRoll=function(e,i,r,n,s){void 0===n&&(n=t.Space.LOCAL);var o=t.Tmp.Matrix[0];t.Matrix.RotationYawPitchRollToRef(e,i,r,o);var a=t.Tmp.Matrix[1];this._getNegativeRotationToRef(a,n,s),a.multiplyToRef(o,o),this._rotateWithMatrix(o,n,s)},i.prototype.rotate=function(e,i,r,n){void 0===r&&(r=t.Space.LOCAL);var s=t.Tmp.Matrix[0];s.m[12]=0,s.m[13]=0,s.m[14]=0,t.Matrix.RotationAxisToRef(e,i,s),this._rotateWithMatrix(s,r,n)},i.prototype.setAxisAngle=function(e,i,r,n){void 0===r&&(r=t.Space.LOCAL);var s=t.Tmp.Matrix[0];t.Matrix.RotationAxisToRef(e,i,s);var o=t.Tmp.Matrix[1];this._getNegativeRotationToRef(o,r,n),o.multiplyToRef(s,s),this._rotateWithMatrix(s,r,n)},i.prototype.setRotation=function(e,i,r){void 0===i&&(i=t.Space.LOCAL),this.setYawPitchRoll(e.y,e.x,e.z,i,r)},i.prototype.setRotationQuaternion=function(e,i,r){void 0===i&&(i=t.Space.LOCAL);var n=t.Tmp.Matrix[0];this._getNegativeRotationToRef(n,i,r);var s=t.Tmp.Matrix[1];t.Matrix.FromQuaternionToRef(e,s),n.multiplyToRef(s,s),this._rotateWithMatrix(s,i,r)},i.prototype.setRotationMatrix=function(e,i,r){void 0===i&&(i=t.Space.LOCAL);var n=t.Tmp.Matrix[0];this._getNegativeRotationToRef(n,i,r);var s=t.Tmp.Matrix[1];s.copyFrom(e),n.multiplyToRef(e,s),this._rotateWithMatrix(s,i,r)},i.prototype._rotateWithMatrix=function(e,i,r){void 0===i&&(i=t.Space.LOCAL);var n=this.getLocalMatrix(),s=n.m[12],o=n.m[13],a=n.m[14],h=this.getParent(),l=t.Tmp.Matrix[3],c=t.Tmp.Matrix[4];h?(i==t.Space.WORLD?r?(l.copyFrom(r.getWorldMatrix()),h.getAbsoluteTransform().multiplyToRef(l,l)):l.copyFrom(h.getAbsoluteTransform()):l=h._scaleMatrix,c.copyFrom(l),c.invert(),n.multiplyToRef(l,n),n.multiplyToRef(e,n),n.multiplyToRef(c,n)):i==t.Space.WORLD&&r?(l.copyFrom(r.getWorldMatrix()),c.copyFrom(l),c.invert(),n.multiplyToRef(l,n),n.multiplyToRef(e,n),n.multiplyToRef(c,n)):n.multiplyToRef(e,n),n.m[12]=s,n.m[13]=o,n.m[14]=a,this.computeAbsoluteTransforms(),this.markAsDirty()},i.prototype._getNegativeRotationToRef=function(e,i,r){if(void 0===i&&(i=t.Space.LOCAL),i==t.Space.WORLD){var n=t.Tmp.Matrix[2];if(n.copyFrom(this._scaleMatrix),e.copyFrom(this.getAbsoluteTransform()),r){e.multiplyToRef(r.getWorldMatrix(),e);var s=t.Tmp.Matrix[3];t.Matrix.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,s),n.multiplyToRef(s,n)}e.invert(),n.m[0]*=this._scalingDeterminant,e.multiplyToRef(n,e)}else{e.copyFrom(this.getLocalMatrix()),e.invert();var n=t.Tmp.Matrix[2];if(n.copyFrom(this._scaleMatrix),this._parent){var o=t.Tmp.Matrix[3];o.copyFrom(this._parent._scaleMatrix),o.invert(),o.multiplyToRef(e,e)}else n.m[0]*=this._scalingDeterminant;e.multiplyToRef(n,e)}},i.prototype.getScale=function(){return this._scaleVector.clone()},i.prototype.getScaleToRef=function(t){t.copyFrom(this._scaleVector)},i.prototype.getPosition=function(e,i){void 0===e&&(e=t.Space.LOCAL);var r=t.Vector3.Zero();return this.getPositionToRef(e,i,r),r},i.prototype.getPositionToRef=function(e,i,r){if(void 0===e&&(e=t.Space.LOCAL),e==t.Space.LOCAL){var n=this.getLocalMatrix();r.x=n.m[12],r.y=n.m[13],r.z=n.m[14]}else{this._skeleton.computeAbsoluteTransforms();var s=t.Tmp.Matrix[0];i?(s.copyFrom(this.getAbsoluteTransform()),s.multiplyToRef(i.getWorldMatrix(),s)):s=this.getAbsoluteTransform(),r.x=s.m[12],r.y=s.m[13],r.z=s.m[14]}},i.prototype.getAbsolutePosition=function(e){var i=t.Vector3.Zero();return this.getPositionToRef(t.Space.WORLD,e,i),i},i.prototype.getAbsolutePositionToRef=function(e,i){this.getPositionToRef(t.Space.WORLD,e,i)},i.prototype.computeAbsoluteTransforms=function(){if(this._parent)this._matrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._matrix);var t=this._skeleton.getPoseMatrix();t&&this._absoluteTransform.multiplyToRef(t,this._absoluteTransform)}for(var e=this.children,i=e.length,r=0;r<i;r++)e[r].computeAbsoluteTransforms()},i.prototype.getDirection=function(e,i){var r=t.Vector3.Zero();return this.getDirectionToRef(e,i,r),r},i.prototype.getDirectionToRef=function(e,i,r){this._skeleton.computeAbsoluteTransforms();var n=t.Tmp.Matrix[0];n.copyFrom(this.getAbsoluteTransform()),i&&n.multiplyToRef(i.getWorldMatrix(),n),t.Vector3.TransformNormalToRef(e,n,r),r.normalize()},i.prototype.getRotation=function(e,i){void 0===e&&(e=t.Space.LOCAL);var r=t.Vector3.Zero();return this.getRotationToRef(e,i,r),r},i.prototype.getRotationToRef=function(e,i,r){void 0===e&&(e=t.Space.LOCAL);var n=t.Tmp.Quaternion[0];this.getRotationQuaternionToRef(e,i,n),n.toEulerAnglesToRef(r)},i.prototype.getRotationQuaternion=function(e,i){void 0===e&&(e=t.Space.LOCAL);var r=t.Quaternion.Identity();return this.getRotationQuaternionToRef(e,i,r),r},i.prototype.getRotationQuaternionToRef=function(e,i,r){if(void 0===e&&(e=t.Space.LOCAL),e==t.Space.LOCAL)this.getLocalMatrix().decompose(t.Tmp.Vector3[0],r,t.Tmp.Vector3[1]);else{var n=t.Tmp.Matrix[0],s=this.getAbsoluteTransform();i?s.multiplyToRef(i.getWorldMatrix(),n):n.copyFrom(s),n.m[0]*=this._scalingDeterminant,n.m[1]*=this._scalingDeterminant,n.m[2]*=this._scalingDeterminant,n.decompose(t.Tmp.Vector3[0],r,t.Tmp.Vector3[1])}},i.prototype.getRotationMatrix=function(e,i){void 0===e&&(e=t.Space.LOCAL);var r=t.Matrix.Identity();return this.getRotationMatrixToRef(e,i,r),r},i.prototype.getRotationMatrixToRef=function(e,i,r){if(void 0===e&&(e=t.Space.LOCAL),e==t.Space.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(r);else{var n=t.Tmp.Matrix[0],s=this.getAbsoluteTransform();i?s.multiplyToRef(i.getWorldMatrix(),n):n.copyFrom(s),n.m[0]*=this._scalingDeterminant,n.m[1]*=this._scalingDeterminant,n.m[2]*=this._scalingDeterminant,n.getRotationMatrixToRef(r)}},i.prototype.getAbsolutePositionFromLocal=function(e,i){var r=t.Vector3.Zero();return this.getAbsolutePositionFromLocalToRef(e,i,r),r},i.prototype.getAbsolutePositionFromLocalToRef=function(e,i,r){this._skeleton.computeAbsoluteTransforms();var n=t.Tmp.Matrix[0];i?(n.copyFrom(this.getAbsoluteTransform()),n.multiplyToRef(i.getWorldMatrix(),n)):n=this.getAbsoluteTransform(),t.Vector3.TransformCoordinatesToRef(e,n,r)},i.prototype.getLocalPositionFromAbsolute=function(e,i){var r=t.Vector3.Zero();return this.getLocalPositionFromAbsoluteToRef(e,i,r),r},i.prototype.getLocalPositionFromAbsoluteToRef=function(e,i,r){this._skeleton.computeAbsoluteTransforms();var n=t.Tmp.Matrix[0];n.copyFrom(this.getAbsoluteTransform()),i&&n.multiplyToRef(i.getWorldMatrix(),n),n.invert(),t.Vector3.TransformCoordinatesToRef(e,n,r)},i}(t.Node);t.Bone=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r){if(this.targetPosition=t.Vector3.Zero(),this.poleTargetPosition=t.Vector3.Zero(),this.poleTargetLocalOffset=t.Vector3.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=t.Quaternion.Identity(),this._bone1Mat=t.Matrix.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._tmpVec1=t.Vector3.Zero(),this._tmpVec2=t.Vector3.Zero(),this._tmpVec3=t.Vector3.Zero(),this._tmpVec4=t.Vector3.Zero(),this._tmpVec5=t.Vector3.Zero(),this._tmpMat1=t.Matrix.Identity(),this._tmpMat2=t.Matrix.Identity(),this._tmpQuat1=t.Quaternion.Identity(),this._rightHandedSystem=!1,this._bendAxis=t.Vector3.Right(),this._slerping=!1,this._bone2=i,this._bone1=i.getParent(),this.mesh=e,i.getAbsoluteTransform().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=1),this._bone1.length){var n=this._bone1.getScale(),s=this._bone2.getScale();this._bone1Length=this._bone1.length*n.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*s.y*this.mesh.scaling.y}else if(this._bone1.children[0]){e.computeWorldMatrix(!0);var o=this._bone2.children[0].getAbsolutePosition(e),a=this._bone2.getAbsolutePosition(e),h=this._bone1.getAbsolutePosition(e);this._bone1Length=t.Vector3.Distance(o,a),this._bone2Length=t.Vector3.Distance(a,h)}this._bone1.getRotationMatrixToRef(t.Space.WORLD,e,this._bone1Mat),this.maxAngle=Math.PI,r&&(r.targetMesh&&(this.targetMesh=r.targetMesh,this.targetMesh.computeWorldMatrix(!0)),r.poleTargetMesh?(this.poleTargetMesh=r.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):r.poleTargetBone?this.poleTargetBone=r.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),r.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(r.poleTargetLocalOffset),r.poleAngle&&(this.poleAngle=r.poleAngle),r.bendAxis&&this._bendAxis.copyFrom(r.bendAxis),r.maxAngle&&(this.maxAngle=r.maxAngle),r.slerpAmount&&(this.slerpAmount=r.slerpAmount))}return Object.defineProperty(e.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(t){this._setMaxAngle(t)},enumerable:!0,configurable:!0}),e.prototype._setMaxAngle=function(t){t<0&&(t=0),(t>Math.PI||void 0==t)&&(t=Math.PI),this._maxAngle=t;var e=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(e*e+i*i-2*e*i*Math.cos(t))},e.prototype.update=function(){var e=this._bone1,i=this.targetPosition,r=this.poleTargetPosition,n=this._tmpMat1,s=this._tmpMat2;this.targetMesh&&i.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,r):this.poleTargetMesh&&t.Vector3.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),r);var o=this._tmpVec1,a=this._tmpVec2,h=this._tmpVec3,l=this._tmpVec4,c=this._tmpVec5;e.getAbsolutePositionToRef(this.mesh,o),r.subtractToRef(o,c),0==c.x&&0==c.y&&0==c.z?c.y=1:c.normalize(),i.subtractToRef(o,l),l.normalize(),t.Vector3.CrossToRef(l,c,a),a.normalize(),t.Vector3.CrossToRef(l,a,h),h.normalize(),t.Matrix.FromXYZAxesToRef(h,l,a,n);var u=this._bone1Length,p=this._bone2Length,d=t.Vector3.Distance(o,i);this._maxReach>0&&(d=Math.min(this._maxReach,d));var f=(p*p+d*d-u*u)/(2*p*d),m=(d*d+u*u-p*p)/(2*d*u);f>1&&(f=1),m>1&&(m=1),f<-1&&(f=-1),m<-1&&(m=-1);var _=Math.acos(f),g=Math.acos(m),y=-_-g;this._rightHandedSystem?(t.Matrix.RotationYawPitchRollToRef(0,0,.5*Math.PI,s),s.multiplyToRef(n,n),t.Matrix.RotationAxisToRef(this._bendAxis,g,s),s.multiplyToRef(n,n)):(this._tmpVec1.copyFrom(this._bendAxis),this._tmpVec1.x*=-1,t.Matrix.RotationAxisToRef(this._tmpVec1,-g,s),s.multiplyToRef(n,n)),this.poleAngle&&(t.Matrix.RotationAxisToRef(l,this.poleAngle,s),n.multiplyToRef(s,n)),this.slerpAmount<1?(this._slerping||t.Quaternion.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),t.Quaternion.FromRotationMatrixToRef(n,this._tmpQuat1),t.Quaternion.SlerpToRef(this._bone1Quat,this._tmpQuat1,this.slerpAmount,this._bone1Quat),y=this._bone2Ang*(1-this.slerpAmount)+y*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,t.Space.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(n,t.Space.WORLD,this.mesh),this._bone1Mat.copyFrom(n),this._slerping=!1),this._bone2.setAxisAngle(this._bendAxis,y,t.Space.LOCAL),this._bone2Ang=y},e}();t.BoneIKController=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n){this.upAxis=t.Vector3.Up(),this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this._tmpVec1=t.Vector3.Zero(),this._tmpVec2=t.Vector3.Zero(),this._tmpVec3=t.Vector3.Zero(),this._tmpVec4=t.Vector3.Zero(),this._tmpMat1=t.Matrix.Identity(),this._tmpMat2=t.Matrix.Identity(),this.mesh=e,this.bone=i,this.target=r,n&&(n.adjustYaw&&(this.adjustYaw=n.adjustYaw),n.adjustPitch&&(this.adjustPitch=n.adjustPitch),n.adjustRoll&&(this.adjustRoll=n.adjustRoll))}return e.prototype.update=function(){var e=this.bone,i=this.target,r=this._tmpVec1,n=this._tmpVec2,s=this._tmpVec3,o=this._tmpVec4,a=this._tmpMat1,h=this._tmpMat2;e.getAbsolutePositionToRef(this.mesh,r),i.subtractToRef(r,n),n.normalize(),t.Vector3.CrossToRef(this.upAxis,n,s),s.normalize(),t.Vector3.CrossToRef(n,s,o),o.normalize(),t.Matrix.FromXYZAxesToRef(s,o,n,a),(this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(t.Matrix.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,h),h.multiplyToRef(a,a)),this.bone.setRotationMatrix(a,t.Space.WORLD,this.mesh)},e}();t.BoneLookController=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r){this.name=e,this.id=i,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=t.Matrix.Identity(),this._ranges={},this._lastAbsoluteTransformsUpdateId=-1,this.bones=[],this._scene=r,r.skeletons.push(this),this._isDirty=!0}return e.prototype.getTransformMatrices=function(t){return this.needInitialSkinMatrix&&t._bonesTransformMatrices?t._bonesTransformMatrices:this._transformMatrices},e.prototype.getScene=function(){return this._scene},e.prototype.toString=function(t){var e="Name: "+this.name+", nBones: "+this.bones.length;if(e+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),t){e+=", Ranges: {";var i=!0;for(var r in this._ranges)i&&(e+=", ",i=!1),e+=r;e+="}"}return e},e.prototype.getBoneIndexByName=function(t){for(var e=0,i=this.bones.length;e<i;e++)if(this.bones[e].name===t)return e;return-1},e.prototype.createAnimationRange=function(e,i,r){if(!this._ranges[e]){this._ranges[e]=new t.AnimationRange(e,i,r);for(var n=0,s=this.bones.length;n<s;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].createRange(e,i,r)}},e.prototype.deleteAnimationRange=function(t,e){void 0===e&&(e=!0);for(var i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(t,e);this._ranges[t]=void 0},e.prototype.getAnimationRange=function(t){return this._ranges[t]},e.prototype.getAnimationRanges=function(){var t,e=[],i=0;for(t in this._ranges)e[i]=this._ranges[t],i++;return e},e.prototype.copyAnimationRange=function(e,i,r){if(void 0===r&&(r=!1),this._ranges[i]||!e.getAnimationRange(i))return!1;var n,s,o=!0,a=this._getHighestAnimationFrame()+1,h={},l=e.bones;for(s=0,n=l.length;s<n;s++)h[l[s].name]=l[s];this.bones.length!==l.length&&(t.Tools.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+l.length),o=!1);var c=r&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(s=0,n=this.bones.length;s<n;s++){var u=this.bones[s].name,p=h[u];p?o=o&&this.bones[s].copyAnimationRange(p,i,a,r,c):(t.Tools.Warn("copyAnimationRange: not same rig, missing source bone "+u),o=!1)}var d=e.getAnimationRange(i);return this._ranges[i]=new t.AnimationRange(i,d.from+a,d.to+a),o},e.prototype.returnToRest=function(){for(var t=0;t<this.bones.length;t++)this.bones[t].returnToRest()},e.prototype._getHighestAnimationFrame=function(){for(var t=0,e=0,i=this.bones.length;e<i;e++)if(this.bones[e].animations[0]){var r=this.bones[e].animations[0].getHighestFrame();t<r&&(t=r)}return t},e.prototype.beginAnimation=function(t,e,i,r){var n=this.getAnimationRange(t);return n?this._scene.beginAnimation(this,n.from,n.to,e,i,r):null},e.prototype._markAsDirty=function(){this._isDirty=!0},e.prototype._registerMeshWithPoseMatrix=function(t){this._meshesWithPoseMatrix.push(t)},e.prototype._unregisterMeshWithPoseMatrix=function(t){var e=this._meshesWithPoseMatrix.indexOf(t);e>-1&&this._meshesWithPoseMatrix.splice(e,1)},e.prototype._computeTransformMatrices=function(t,e){for(var i=0;i<this.bones.length;i++){var r=this.bones[i],n=r.getParent();n?r.getLocalMatrix().multiplyToRef(n.getWorldMatrix(),r.getWorldMatrix()):e?r.getLocalMatrix().multiplyToRef(e,r.getWorldMatrix()):r.getWorldMatrix().copyFrom(r.getLocalMatrix()),r.getInvertedAbsoluteTransform().multiplyToArray(r.getWorldMatrix(),t,16*i)}this._identity.copyToArray(t,16*this.bones.length)},e.prototype.prepare=function(){if(this._isDirty){if(this.needInitialSkinMatrix)for(var e=0;e<this._meshesWithPoseMatrix.length;e++){var i=this._meshesWithPoseMatrix[e];i._bonesTransformMatrices&&i._bonesTransformMatrices.length===16*(this.bones.length+1)||(i._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)));for(var r=i.getPoseMatrix(),n=0;n<this.bones.length;n++){var s=this.bones[n];if(!s.getParent()){var o=s.getBaseMatrix();o.multiplyToRef(r,t.Tmp.Matrix[0]),s._updateDifferenceMatrix(t.Tmp.Matrix[0])}}this._computeTransformMatrices(i._bonesTransformMatrices,r)}else this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1))),this._computeTransformMatrices(this._transformMatrices,null);this._isDirty=!1,this._scene._activeBones.addCount(this.bones.length,!1)}},e.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var t=0;t<this.bones.length;t++)this._animatables.push(this.bones[t])}return this._animatables},e.prototype.clone=function(i,r){var n=new e(i,r||i,this._scene);n.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var s=0;s<this.bones.length;s++){var o=this.bones[s],a=null;if(o.getParent()){var h=this.bones.indexOf(o.getParent());a=n.bones[h]}var l=new t.Bone(o.name,n,a,o.getBaseMatrix().clone(),o.getRestPose().clone());t.Tools.DeepCopy(o.animations,l.animations)}if(this._ranges){n._ranges={};for(var c in this._ranges)n._ranges[c]=this._ranges[c].clone()}return this._isDirty=!0,n},e.prototype.enableBlending=function(t){void 0===t&&(t=.01),this.bones.forEach(function(e){e.animations.forEach(function(e){e.enableBlending=!0,e.blendingSpeed=t})})},e.prototype.dispose=function(){this._meshesWithPoseMatrix=[],this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this)},e.prototype.serialize=function(){var t={};t.name=this.name,t.id=this.id,t.dimensionsAtRest=this.dimensionsAtRest,t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(var e=0;e<this.bones.length;e++){var i=this.bones[e],r={parentBoneIndex:i.getParent()?this.bones.indexOf(i.getParent()):-1,name:i.name,matrix:i.getLocalMatrix().toArray(),rest:i.getRestPose().toArray()};t.bones.push(r),i.length&&(r.length=i.length),i.animations&&i.animations.length>0&&(r.animation=i.animations[0].serialize()),t.ranges=[];for(var n in this._ranges){var s={};s.name=n,s.from=this._ranges[n].from,s.to=this._ranges[n].to,t.ranges.push(s)}}return t},e.Parse=function(i,r){var n=new e(i.name,i.id,r);i.dimensionsAtRest&&(n.dimensionsAtRest=t.Vector3.FromArray(i.dimensionsAtRest)),n.needInitialSkinMatrix=i.needInitialSkinMatrix;var s;for(s=0;s<i.bones.length;s++){var o=i.bones[s],a=null;o.parentBoneIndex>-1&&(a=n.bones[o.parentBoneIndex]);var h=o.rest?t.Matrix.FromArray(o.rest):null,l=new t.Bone(o.name,n,a,t.Matrix.FromArray(o.matrix),h);o.length&&(l.length=o.length),o.animation&&l.animations.push(t.Animation.Parse(o.animation))}if(i.ranges)for(s=0;s<i.ranges.length;s++){var c=i.ranges[s];n.createAnimationRange(c.name,c.from,c.to)}return n},e.prototype.computeAbsoluteTransforms=function(t){void 0===t&&(t=!1);var e=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=e||t)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=e)},e.prototype.getPoseMatrix=function(){var t;return this._meshesWithPoseMatrix.length>0&&(t=this._meshesWithPoseMatrix[0].getPoseMatrix()),t},e}();t.Skeleton=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s,o,a,h,l,c,u){void 0===a&&(a=t.Texture.NEAREST_SAMPLINGMODE),void 0===u&&(u=t.Engine.TEXTURETYPE_UNSIGNED_INT),this.name=e,this.width=-1,this.height=-1,this.enablePixelPerfectMode=!1,this._reusable=!1,this._textures=new t.SmartArray(2),this._currentRenderTextureInd=0,this._scaleRatio=new t.Vector2(1,1),this.onActivateObservable=new t.Observable,this.onSizeChangedObservable=new t.Observable,this.onApplyObservable=new t.Observable,this.onBeforeRenderObservable=new t.Observable,this.onAfterRenderObservable=new t.Observable,null!=o?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine()):this._engine=h,this._options=s,this.renderTargetSamplingMode=a?a:t.Texture.NEAREST_SAMPLINGMODE,this._reusable=l||!1,this._textureType=u,this._samplers=n||[],this._samplers.push("textureSampler"),this._fragmentUrl=i,this._parameters=r||[],this._parameters.push("scale"),this.updateEffect(c)}return Object.defineProperty(e.prototype,"onActivate",{set:function(t){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),this._onActivateObserver=this.onActivateObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onSizeChanged",{set:function(t){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onApply",{set:function(t){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onBeforeRender",{set:function(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onAfterRender",{set:function(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)},enumerable:!0,configurable:!0}),e.prototype.updateEffect=function(t){this._effect=this._engine.createEffect({vertex:"postprocess",fragment:this._fragmentUrl},["position"],this._parameters,this._samplers,void 0!==t?t:"")},e.prototype.isReusable=function(){return this._reusable},e.prototype.markTextureDirty=function(){this.width=-1},e.prototype.activate=function(e,i){e=e||this._camera;var r=e.getScene(),n=e.getEngine().getCaps().maxTextureSize,s=(i?i._width:this._engine.getRenderingCanvas().width)*this._options|0,o=(i?i._height:this._engine.getRenderingCanvas().height)*this._options|0,a=this._options.width||s,h=this._options.height||o;if(this.renderTargetSamplingMode!==t.Texture.NEAREST_SAMPLINGMODE&&(this._options.width||(a=t.Tools.GetExponentOfTwo(a,n)),this._options.height||(h=t.Tools.GetExponentOfTwo(h,n))),this.width!==a||this.height!==h){if(this._textures.length>0){for(var l=0;l<this._textures.length;l++)this._engine._releaseTexture(this._textures.data[l]);this._textures.reset()}this.width=a,this.height=h;var c={width:this.width,height:this.height},u={generateMipMaps:!1,generateDepthBuffer:0===e._postProcesses.indexOf(this),generateStencilBuffer:0===e._postProcesses.indexOf(this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType};this._textures.push(this._engine.createRenderTargetTexture(c,u)),this._reusable&&this._textures.push(this._engine.createRenderTargetTexture(c,u)),this.onSizeChangedObservable.notifyObservers(this)}this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(s/a,o/h),this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd],0,s,o)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd])),this.onActivateObservable.notifyObservers(e),this.clearColor?this._engine.clear(this.clearColor,!0,!0,!0):this._engine.clear(r.clearColor,r.autoClear||r.forceWireframe,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2)},Object.defineProperty(e.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:!0,configurable:!0}),e.prototype.apply=function(){return this._effect.isReady()?(this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setAlphaMode(t.Engine.ALPHA_DISABLE),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effect._bindTexture("textureSampler",this._textures.data[this._currentRenderTextureInd]),this._effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effect),this._effect):null},e.prototype.dispose=function(t){if(t=t||this._camera,this._textures.length>0){for(var e=0;e<this._textures.length;e++)this._engine._releaseTexture(this._textures.data[e]);this._textures.reset()}if(t){t.detachPostProcess(this);0===t._postProcesses.indexOf(this)&&t._postProcesses.length>0&&this._camera._postProcesses[0].markTextureDirty(),this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}},e}();t.PostProcess=e}(r||(r={}));var r;!function(t){var e=function(){function e(t){this._vertexBuffers={},this._scene=t}return e.prototype._prepareBuffers=function(){if(!this._vertexBuffers[t.VertexBuffer.PositionKind]){var e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[t.VertexBuffer.PositionKind]=new t.VertexBuffer(this._scene.getEngine(),e,t.VertexBuffer.PositionKind,!1,!1,2);var i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(i)}},e.prototype._prepareFrame=function(t){var e=this._scene.activeCamera._postProcesses;return!(0===e.length||!this._scene.postProcessesEnabled)&&(e[0].activate(this._scene.activeCamera,t),!0)},e.prototype.directRender=function(t,e){for(var i=this._scene.getEngine(),r=0;r<t.length;r++){r<t.length-1?t[r+1].activate(this._scene.activeCamera,e):e?i.bindFramebuffer(e):i.restoreDefaultFramebuffer();var n=t[r],s=n.apply();s&&(n.onBeforeRenderObservable.notifyObservers(s),this._prepareBuffers(),i.bindBuffers(this._vertexBuffers,this._indexBuffer,s),i.draw(!0,0,6),n.onAfterRenderObservable.notifyObservers(s))}i.setDepthBuffer(!0),i.setDepthWrite(!0)},e.prototype._finalizeFrame=function(t,e,i,r){if(r=r||this._scene.activeCamera._postProcesses,0!==r.length&&this._scene.postProcessesEnabled){for(var n=this._scene.getEngine(),s=0,o=r.length;s<o&&(s<o-1?r[s+1].activate(this._scene.activeCamera,e):e?n.bindFramebuffer(e,i):n.restoreDefaultFramebuffer(),!t);s++){var a=r[s],h=a.apply();h&&(a.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),n.bindBuffers(this._vertexBuffers,this._indexBuffer,h),n.draw(!0,0,6),a.onAfterRenderObservable.notifyObservers(h))}n.setDepthBuffer(!0),n.setDepthWrite(!0)}},e.prototype.dispose=function(){var e=this._vertexBuffers[t.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[t.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},e}();t.PostProcessManager=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o){t.call(this,e,"pass",null,null,i,r,n,s,o)}return o(e,t),e}(t.PostProcess);t.PassPostProcess=e}(r||(r={}));var r;!function(t){var e=function(){function t(t,e){this.type=t,this.jointData=e,e.nativeParams=e.nativeParams||{}}return Object.defineProperty(t.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(t){this._physicsJoint,this._physicsJoint=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"physicsPlugin",{set:function(t){this._physicsPlugin=t},enumerable:!0,configurable:!0}),t.prototype.executeNativeFunction=function(t){t(this._physicsPlugin.world,this._physicsJoint)},t.DistanceJoint=0,t.HingeJoint=1,t.BallAndSocketJoint=2,t.WheelJoint=3,t.SliderJoint=4,t.PrismaticJoint=5,t.UniversalJoint=6,t.Hinge2Joint=t.WheelJoint,t.PointToPointJoint=8,t.SpringJoint=9,t.LockJoint=10,t}();t.PhysicsJoint=e;var i=function(t){function i(i){t.call(this,e.DistanceJoint,i)}return o(i,t),i.prototype.updateDistance=function(t,e){this._physicsPlugin.updateDistanceJoint(this,t,e)},i}(e);t.DistanceJoint=i;var r=function(t){function e(e,i){t.call(this,e,i)}return o(e,t),e.prototype.setMotor=function(t,e){this._physicsPlugin.setMotor(this,t,e)},e.prototype.setLimit=function(t,e){this._physicsPlugin.setLimit(this,t,e)},e}(e);t.MotorEnabledJoint=r;var n=function(t){function i(i){t.call(this,e.HingeJoint,i)}return o(i,t),i.prototype.setMotor=function(t,e){this._physicsPlugin.setMotor(this,t,e)},i.prototype.setLimit=function(t,e){this._physicsPlugin.setLimit(this,t,e)},i}(r);t.HingeJoint=n;var s=function(t){function i(i){t.call(this,e.Hinge2Joint,i)}return o(i,t),i.prototype.setMotor=function(t,e,i){void 0===i&&(i=0),this._physicsPlugin.setMotor(this,t,e,i)},i.prototype.setLimit=function(t,e,i){void 0===i&&(i=0),this._physicsPlugin.setLimit(this,t,e,i)},i}(r);t.Hinge2Joint=s}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n){var s=this;if(void 0===r&&(r={mass:0}),this.object=e,this.type=i,this._options=r,this._scene=n,this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=t.Vector3.Zero(),this._tmpPositionWithDelta=t.Vector3.Zero(),this._tmpRotationWithDelta=new t.Quaternion,this.beforeStep=function(){s.object.position.subtractToRef(s._deltaPosition,s._tmpPositionWithDelta),s._deltaRotationConjugated?s.object.rotationQuaternion.multiplyToRef(s._deltaRotationConjugated,s._tmpRotationWithDelta):s._tmpRotationWithDelta.copyFrom(s.object.rotationQuaternion),s._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(s,s._tmpPositionWithDelta,s._tmpRotationWithDelta),s._onBeforePhysicsStepCallbacks.forEach(function(t){t(s)})},this.afterStep=function(){s._onAfterPhysicsStepCallbacks.forEach(function(t){t(s)}),s._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(s),s.object.position.addInPlace(s._deltaPosition),s._deltaRotation&&s.object.rotationQuaternion.multiplyInPlace(s._deltaRotation)},this.onCollide=function(t){if(s._onPhysicsCollideCallbacks.length){var e=s._physicsEngine.getImpostorWithPhysicsBody(t.body);e&&s._onPhysicsCollideCallbacks.filter(function(t){return t.otherImpostors.indexOf(e)!==-1}).forEach(function(t){t.callback(s,e)})}},!this.object)return void t.Tools.Error("No object was provided. A physics object is obligatory");!this._scene&&e.getScene&&(this._scene=e.getScene()),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=t.Quaternion.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new t.Quaternion),this._options.mass=void 0===r.mass?0:r.mass,this._options.friction=void 0===r.friction?.2:r.friction,this._options.restitution=void 0===r.restitution?.2:r.restitution,this._joints=[],this.object.parent||this._init()):t.Tools.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.")}return e.prototype._init=function(){this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this.parent||this._physicsEngine.addImpostor(this)},e.prototype._getPhysicsParent=function(){if(this.object.parent instanceof t.AbstractMesh){return this.object.parent.physicsImpostor}},e.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent},e.prototype.setScalingUpdated=function(t){this.forceUpdate()},e.prototype.forceUpdate=function(){this._init(),this.parent&&this.parent.forceUpdate()},Object.defineProperty(e.prototype,"physicsBody",{get:function(){return this._parent?this._parent.physicsBody:this._physicsBody},set:function(t){this._physicsBody&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=t,this.resetUpdateFlags()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},set:function(t){this._parent=t},enumerable:!0,configurable:!0}),e.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},e.prototype.getObjectExtendSize=function(){return this.object.getBoundingInfo?(this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiply(this.object.scaling)):e.DEFAULT_OBJECT_SIZE},e.prototype.getObjectCenter=function(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.center:this.object.position},e.prototype.getParam=function(t){return this._options[t]},e.prototype.setParam=function(t,e){this._options[t]=e,this._bodyUpdateRequired=!0},e.prototype.setMass=function(t){this.getParam("mass")!==t&&this.setParam("mass",t),this._physicsEngine.getPhysicsPlugin().setBodyMass(this,t)},e.prototype.getLinearVelocity=function(){return this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this)},e.prototype.setLinearVelocity=function(t){this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,t)},e.prototype.getAngularVelocity=function(){return this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this)},e.prototype.setAngularVelocity=function(t){this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,t)},e.prototype.executeNativeFunction=function(t){t(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},e.prototype.registerBeforePhysicsStep=function(t){this._onBeforePhysicsStepCallbacks.push(t)},e.prototype.unregisterBeforePhysicsStep=function(e){var i=this._onBeforePhysicsStepCallbacks.indexOf(e);i>-1?this._onBeforePhysicsStepCallbacks.splice(i,1):t.Tools.Warn("Function to remove was not found")},e.prototype.registerAfterPhysicsStep=function(t){this._onAfterPhysicsStepCallbacks.push(t)},e.prototype.unregisterAfterPhysicsStep=function(e){var i=this._onAfterPhysicsStepCallbacks.indexOf(e);i>-1?this._onAfterPhysicsStepCallbacks.splice(i,1):t.Tools.Warn("Function to remove was not found")},e.prototype.registerOnPhysicsCollide=function(t,e){var i=t instanceof Array?t:[t];this._onPhysicsCollideCallbacks.push({callback:e,otherImpostors:i})},e.prototype.unregisterOnPhysicsCollide=function(e,i){var r=e instanceof Array?e:[e],n=this._onPhysicsCollideCallbacks.indexOf({callback:i,otherImpostors:r});n>-1?this._onPhysicsCollideCallbacks.splice(n,1):t.Tools.Warn("Function to remove was not found")},e.prototype.applyForce=function(t,e){this._physicsEngine.getPhysicsPlugin().applyForce(this,t,e)},e.prototype.applyImpulse=function(t,e){this._physicsEngine.getPhysicsPlugin().applyImpulse(this,t,e)},e.prototype.createJoint=function(e,i,r){var n=new t.PhysicsJoint(i,r);this.addJoint(e,n)},e.prototype.addJoint=function(t,e){this._joints.push({otherImpostor:t,joint:e}),this._physicsEngine.addJoint(this,t,e)},e.prototype.sleep=function(){this._physicsEngine.getPhysicsPlugin().sleepBody(this)},e.prototype.wakeUp=function(){this._physicsEngine.getPhysicsPlugin().wakeUpBody(this)},e.prototype.clone=function(t){return t?new e(t,this.type,this._options,this._scene):null},e.prototype.dispose=function(){var t=this;this._physicsEngine&&(this._joints.forEach(function(e){t._physicsEngine.removeJoint(t,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate())},e.prototype.setDeltaPosition=function(t){this._deltaPosition.copyFrom(t)},e.prototype.setDeltaRotation=function(e){this._deltaRotation||(this._deltaRotation=new t.Quaternion),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()},e.DEFAULT_OBJECT_SIZE=new t.Vector3(1,1,1),e.NoImpostor=0,e.SphereImpostor=1,e.BoxImpostor=2,e.PlaneImpostor=3,e.MeshImpostor=4,e.CylinderImpostor=7,e.ParticleImpostor=8,e.HeightmapImpostor=9,e}();t.PhysicsImpostor=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){if(void 0===i&&(i=new t.CannonJSPlugin),this._physicsPlugin=i,this._impostors=[],this._joints=[],!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new t.Vector3(0,-9.807,0),this.setGravity(e),this.setTimeStep()}return e.prototype.setGravity=function(t){this.gravity=t,this._physicsPlugin.setGravity(this.gravity)},e.prototype.setTimeStep=function(t){void 0===t&&(t=1/60),this._physicsPlugin.setTimeStep(t)},e.prototype.dispose=function(){this._impostors.forEach(function(t){t.dispose()}),this._physicsPlugin.dispose()},e.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},e.prototype.addImpostor=function(t){t.uniqueId=this._impostors.push(t),t.parent||this._physicsPlugin.generatePhysicsBody(t)},e.prototype.removeImpostor=function(t){var e=this._impostors.indexOf(t);if(e>-1){var i=this._impostors.splice(e,1);i.length&&(i[0].physicsBody=null)}},e.prototype.addJoint=function(t,e,i){var r={mainImpostor:t,connectedImpostor:e,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)},e.prototype.removeJoint=function(t,e,i){var r=this._joints.filter(function(r){return r.connectedImpostor===e&&r.joint===i&&r.mainImpostor===t});r.length&&this._physicsPlugin.removeJoint(r[0])},e.prototype._step=function(t){var e=this;this._impostors.forEach(function(t){t.isBodyInitRequired()&&e._physicsPlugin.generatePhysicsBody(t)}),t>.1?t=.1:t<=0&&(t=1/60),this._physicsPlugin.executeStep(t,this._impostors)},e.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},e.prototype.getImpostorForPhysicsObject=function(t){for(var e=0;e<this._impostors.length;++e)if(this._impostors[e].object===t)return this._impostors[e]},e.prototype.getImpostorWithPhysicsBody=function(t){for(var e=0;e<this._impostors.length;++e)if(this._impostors[e].physicsBody===t)return this._impostors[e]},e.NoImpostor=t.PhysicsImpostor.NoImpostor,e.SphereImpostor=t.PhysicsImpostor.SphereImpostor,e.BoxImpostor=t.PhysicsImpostor.BoxImpostor,e.PlaneImpostor=t.PhysicsImpostor.PlaneImpostor,e.MeshImpostor=t.PhysicsImpostor.MeshImpostor,e.CylinderImpostor=t.PhysicsImpostor.CylinderImpostor,e.HeightmapImpostor=t.PhysicsImpostor.HeightmapImpostor,e.CapsuleImpostor=-1,e.ConeImpostor=-1,e.ConvexHullImpostor=-1,e.Epsilon=.001,e}();t.PhysicsEngine=e}(r||(r={}));var r;!function(t){var e=function(){function e(){}return e.prototype.set=function(e,i){switch(i){case t.VertexBuffer.PositionKind:this.positions=e;break;case t.VertexBuffer.NormalKind:this.normals=e;break;case t.VertexBuffer.UVKind:this.uvs=e;break;case t.VertexBuffer.UV2Kind:this.uvs2=e;break;case t.VertexBuffer.UV3Kind:this.uvs3=e;break;case t.VertexBuffer.UV4Kind:this.uvs4=e;break;case t.VertexBuffer.UV5Kind:this.uvs5=e;break;case t.VertexBuffer.UV6Kind:this.uvs6=e;break;case t.VertexBuffer.ColorKind:this.colors=e;break;case t.VertexBuffer.MatricesIndicesKind:this.matricesIndices=e;break;case t.VertexBuffer.MatricesWeightsKind:this.matricesWeights=e;break;case t.VertexBuffer.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case t.VertexBuffer.MatricesWeightsExtraKind:this.matricesWeightsExtra=e}},e.prototype.applyToMesh=function(t,e){this._applyTo(t,e)},e.prototype.applyToGeometry=function(t,e){this._applyTo(t,e)},e.prototype.updateMesh=function(t,e,i){this._update(t)},e.prototype.updateGeometry=function(t,e,i){this._update(t)},e.prototype._applyTo=function(e,i){this.positions&&e.setVerticesData(t.VertexBuffer.PositionKind,this.positions,i),this.normals&&e.setVerticesData(t.VertexBuffer.NormalKind,this.normals,i),this.uvs&&e.setVerticesData(t.VertexBuffer.UVKind,this.uvs,i),this.uvs2&&e.setVerticesData(t.VertexBuffer.UV2Kind,this.uvs2,i),this.uvs3&&e.setVerticesData(t.VertexBuffer.UV3Kind,this.uvs3,i),this.uvs4&&e.setVerticesData(t.VertexBuffer.UV4Kind,this.uvs4,i),this.uvs5&&e.setVerticesData(t.VertexBuffer.UV5Kind,this.uvs5,i),this.uvs6&&e.setVerticesData(t.VertexBuffer.UV6Kind,this.uvs6,i),this.colors&&e.setVerticesData(t.VertexBuffer.ColorKind,this.colors,i),this.matricesIndices&&e.setVerticesData(t.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i),this.matricesWeights&&e.setVerticesData(t.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i),this.matricesIndicesExtra&&e.setVerticesData(t.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,i),this.matricesWeightsExtra&&e.setVerticesData(t.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,i),this.indices&&e.setIndices(this.indices)},e.prototype._update=function(e,i,r){this.positions&&e.updateVerticesData(t.VertexBuffer.PositionKind,this.positions,i,r),this.normals&&e.updateVerticesData(t.VertexBuffer.NormalKind,this.normals,i,r),this.uvs&&e.updateVerticesData(t.VertexBuffer.UVKind,this.uvs,i,r),this.uvs2&&e.updateVerticesData(t.VertexBuffer.UV2Kind,this.uvs2,i,r),this.uvs3&&e.updateVerticesData(t.VertexBuffer.UV3Kind,this.uvs3,i,r),this.uvs4&&e.updateVerticesData(t.VertexBuffer.UV4Kind,this.uvs4,i,r),this.uvs5&&e.updateVerticesData(t.VertexBuffer.UV5Kind,this.uvs5,i,r),this.uvs6&&e.updateVerticesData(t.VertexBuffer.UV6Kind,this.uvs6,i,r),this.colors&&e.updateVerticesData(t.VertexBuffer.ColorKind,this.colors,i,r),this.matricesIndices&&e.updateVerticesData(t.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i,r),this.matricesWeights&&e.updateVerticesData(t.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i,r),this.matricesIndicesExtra&&e.updateVerticesData(t.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,i,r),this.matricesWeightsExtra&&e.updateVerticesData(t.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,i,r),this.indices&&e.setIndices(this.indices)},e.prototype.transform=function(e){var i,r=t.Vector3.Zero();if(this.positions){var n=t.Vector3.Zero();for(i=0;i<this.positions.length;i+=3)t.Vector3.FromArrayToRef(this.positions,i,n),t.Vector3.TransformCoordinatesToRef(n,e,r),this.positions[i]=r.x,this.positions[i+1]=r.y,this.positions[i+2]=r.z}if(this.normals){var s=t.Vector3.Zero();for(i=0;i<this.normals.length;i+=3)t.Vector3.FromArrayToRef(this.normals,i,s),t.Vector3.TransformNormalToRef(s,e,r),this.normals[i]=r.x,this.normals[i+1]=r.y,this.normals[i+2]=r.z}},e.prototype.merge=function(t){if(t.indices){this.indices||(this.indices=[]);for(var e=this.positions?this.positions.length/3:0,i=0;i<t.indices.length;i++)this.indices.push(t.indices[i]+e)}this.positions=this._mergeElement(this.positions,t.positions),this.normals=this._mergeElement(this.normals,t.normals),this.uvs=this._mergeElement(this.uvs,t.uvs),this.uvs2=this._mergeElement(this.uvs2,t.uvs2),this.uvs3=this._mergeElement(this.uvs3,t.uvs3),this.uvs4=this._mergeElement(this.uvs4,t.uvs4),this.uvs5=this._mergeElement(this.uvs5,t.uvs5),this.uvs6=this._mergeElement(this.uvs6,t.uvs6),this.colors=this._mergeElement(this.colors,t.colors),this.matricesIndices=this._mergeElement(this.matricesIndices,t.matricesIndices),this.matricesWeights=this._mergeElement(this.matricesWeights,t.matricesWeights),this.matricesIndicesExtra=this._mergeElement(this.matricesIndicesExtra,t.matricesIndicesExtra),this.matricesWeightsExtra=this._mergeElement(this.matricesWeightsExtra,t.matricesWeightsExtra)},e.prototype._mergeElement=function(t,e){if(!e)return t;if(!t)return e;var i=e.length+t.length,r=t instanceof Float32Array,n=e instanceof Float32Array;if(r){var s=new Float32Array(i);return s.set(t),s.set(e,t.length),s}if(n){for(var o=t.slice(0),a=0,i=e.length;a<i;a++)o.push(e[a]);return o}return t.concat(e)},e.prototype.serialize=function(){var t=this.serialize();return this.positions&&(t.positions=this.positions),this.normals&&(t.normals=this.normals),this.uvs&&(t.uvs=this.uvs),this.uvs2&&(t.uvs2=this.uvs2),this.uvs3&&(t.uvs3=this.uvs3),this.uvs4&&(t.uvs4=this.uvs4),this.uvs5&&(t.uvs5=this.uvs5),this.uvs6&&(t.uvs6=this.uvs6),this.colors&&(t.colors=this.colors),this.matricesIndices&&(t.matricesIndices=this.matricesIndices,t.matricesIndices._isExpanded=!0),this.matricesWeights&&(t.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(t.matricesIndicesExtra=this.matricesIndicesExtra,t.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(t.matricesWeightsExtra=this.matricesWeightsExtra),t.indices=this.indices,t},e.ExtractFromMesh=function(t,i){return e._ExtractFrom(t,i)},e.ExtractFromGeometry=function(t,i){return e._ExtractFrom(t,i)},e._ExtractFrom=function(i,r){var n=new e;return i.isVerticesDataPresent(t.VertexBuffer.PositionKind)&&(n.positions=i.getVerticesData(t.VertexBuffer.PositionKind,r)),i.isVerticesDataPresent(t.VertexBuffer.NormalKind)&&(n.normals=i.getVerticesData(t.VertexBuffer.NormalKind,r)),i.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(n.uvs=i.getVerticesData(t.VertexBuffer.UVKind,r)),i.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(n.uvs2=i.getVerticesData(t.VertexBuffer.UV2Kind,r)),i.isVerticesDataPresent(t.VertexBuffer.UV3Kind)&&(n.uvs3=i.getVerticesData(t.VertexBuffer.UV3Kind,r)),i.isVerticesDataPresent(t.VertexBuffer.UV4Kind)&&(n.uvs4=i.getVerticesData(t.VertexBuffer.UV4Kind,r)),i.isVerticesDataPresent(t.VertexBuffer.UV5Kind)&&(n.uvs5=i.getVerticesData(t.VertexBuffer.UV5Kind,r)),i.isVerticesDataPresent(t.VertexBuffer.UV6Kind)&&(n.uvs6=i.getVerticesData(t.VertexBuffer.UV6Kind,r)),i.isVerticesDataPresent(t.VertexBuffer.ColorKind)&&(n.colors=i.getVerticesData(t.VertexBuffer.ColorKind,r)),i.isVerticesDataPresent(t.VertexBuffer.MatricesIndicesKind)&&(n.matricesIndices=i.getVerticesData(t.VertexBuffer.MatricesIndicesKind,r)),i.isVerticesDataPresent(t.VertexBuffer.MatricesWeightsKind)&&(n.matricesWeights=i.getVerticesData(t.VertexBuffer.MatricesWeightsKind,r)),i.isVerticesDataPresent(t.VertexBuffer.MatricesIndicesExtraKind)&&(n.matricesIndicesExtra=i.getVerticesData(t.VertexBuffer.MatricesIndicesExtraKind,r)),i.isVerticesDataPresent(t.VertexBuffer.MatricesWeightsExtraKind)&&(n.matricesWeightsExtra=i.getVerticesData(t.VertexBuffer.MatricesWeightsExtraKind,r)),n.indices=i.getIndices(r),n},e.CreateRibbon=function(i){var r=i.pathArray,n=i.closeArray||!1,s=i.closePath||!1,o=i.invertUV||!1,a=Math.floor(r[0].length/2),h=i.offset||a;h=h>a?a:Math.floor(h);var l,c,u,p,d=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,f=[],m=[],_=[],g=[],y=[],v=[],x=[],b=[],P=[],T=[];if(r.length<2){var S=[],A=[];for(u=0;u<r[0].length-h;u++)S.push(r[0][u]),A.push(r[0][u+h]);r=[S,A]}var C,E,M=0,D=s?1:0;l=r[0].length;var R,I;for(c=0;c<r.length;c++){for(x[c]=0,y[c]=[0],C=r[c],E=C.length,l=l<E?l:E,p=0;p<E;)f.push(C[p].x,C[p].y,C[p].z),p>0&&(R=C[p].subtract(C[p-1]).length(),I=R+x[c],y[c].push(I),x[c]=I),p++;s&&(p--,f.push(C[0].x,C[0].y,C[0].z),R=C[p].subtract(C[0]).length(),I=R+x[c],y[c].push(I),x[c]=I),P[c]=E+D,T[c]=M,M+=E+D}var O,w,L,F;for(u=0;u<l+D;u++){for(b[u]=0,v[u]=[0],c=0;c<r.length-1;c++)O=r[c],w=r[c+1],u===l?(L=O[0],F=w[0]):(L=O[u],F=w[u]),R=F.subtract(L).length(),I=R+b[u],v[u].push(I),b[u]=I;n&&(O=r[c],w=r[0],u===l&&(F=w[0]),R=F.subtract(L).length(),I=R+b[u],b[u]=I)}var V,N;for(c=0;c<r.length;c++)for(u=0;u<l+D;u++)V=y[c][u]/x[c],N=v[u][c]/b[u],o?g.push(N,V):g.push(V,N);c=0;for(var z=0,B=P[c]-1,k=P[c+1]-1,U=B<k?B:k,G=T[1]-T[0],W=n?P.length:P.length-1;z<=U&&c<W;)m.push(z,z+G,z+1),m.push(z+G+1,z+1,z+G),(z+=1)===U&&(c++,c===P.length-1?(G=T[0]-T[c],B=P[c]-1,k=P[0]-1):(G=T[c+1]-T[c],B=P[c]-1,k=P[c+1]-1),z=T[c],U=B<k?B+z:k+z);if(e.ComputeNormals(f,m,_),s){var j=0,H=0;for(c=0;c<r.length;c++)j=3*T[c],H=c+1<r.length?3*(T[c+1]-1):_.length-3,_[j]=.5*(_[j]+_[H]),_[j+1]=.5*(_[j+1]+_[H+1]),_[j+2]=.5*(_[j+2]+_[H+2]),_[H]=_[j],_[H+1]=_[j+1],_[H+2]=_[j+2]}e._ComputeSides(d,f,m,_,g);var X=new e;return X.indices=m,X.positions=f,X.normals=_,X.uvs=g,s&&(X._idx=T),X},e.CreateBox=function(i){for(var r=[new t.Vector3(0,0,1),new t.Vector3(0,0,-1),new t.Vector3(1,0,0),new t.Vector3(-1,0,0),new t.Vector3(0,1,0),new t.Vector3(0,-1,0)],n=[],s=[],o=[],a=[],h=i.width||i.size||1,l=i.height||i.size||1,c=i.depth||i.size||1,u=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,p=i.faceUV||new Array(6),d=i.faceColors,f=[],m=0;m<6;m++)void 0===p[m]&&(p[m]=new t.Vector4(0,0,1,1)),d&&void 0===d[m]&&(d[m]=new t.Color4(1,1,1,1));for(var _=new t.Vector3(h/2,l/2,c/2),g=0;g<r.length;g++){var y=r[g],v=new t.Vector3(y.y,y.z,y.x),x=t.Vector3.Cross(y,v),b=s.length/3;n.push(b),n.push(b+1),n.push(b+2),n.push(b),n.push(b+2),n.push(b+3);var P=y.subtract(v).subtract(x).multiply(_);s.push(P.x,P.y,P.z),o.push(y.x,y.y,y.z),a.push(p[g].z,p[g].w),d&&f.push(d[g].r,d[g].g,d[g].b,d[g].a),P=y.subtract(v).add(x).multiply(_),s.push(P.x,P.y,P.z),o.push(y.x,y.y,y.z),a.push(p[g].x,p[g].w),d&&f.push(d[g].r,d[g].g,d[g].b,d[g].a),P=y.add(v).add(x).multiply(_),s.push(P.x,P.y,P.z),o.push(y.x,y.y,y.z),a.push(p[g].x,p[g].y),d&&f.push(d[g].r,d[g].g,d[g].b,d[g].a),P=y.add(v).subtract(x).multiply(_),s.push(P.x,P.y,P.z),o.push(y.x,y.y,y.z),a.push(p[g].z,p[g].y),d&&f.push(d[g].r,d[g].g,d[g].b,d[g].a)}e._ComputeSides(u,s,n,o,a);var T=new e;if(T.indices=n,T.positions=s,T.normals=o,T.uvs=a,d){var S=u===t.Mesh.DOUBLESIDE?f.concat(f):f;T.colors=S}return T},e.CreateSphere=function(i){for(var r=i.segments||32,n=i.diameterX||i.diameter||1,s=i.diameterY||i.diameter||1,o=i.diameterZ||i.diameter||1,a=i.arc<=0||i.arc>1?1:i.arc||1,h=i.slice<=0?1:i.slice||1,l=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,c=new t.Vector3(n/2,s/2,o/2),u=2+r,p=2*u,d=[],f=[],m=[],_=[],g=0;g<=u;g++){for(var y=g/u,v=y*Math.PI*h,x=0;x<=p;x++){var b=x/p,P=b*Math.PI*2*a,T=t.Matrix.RotationZ(-v),S=t.Matrix.RotationY(P),A=t.Vector3.TransformCoordinates(t.Vector3.Up(),T),C=t.Vector3.TransformCoordinates(A,S),E=C.multiply(c),M=C.divide(c).normalize();f.push(E.x,E.y,E.z),m.push(M.x,M.y,M.z),_.push(b,y)}if(g>0)for(var D=f.length/3,R=D-2*(p+1);R+p+2<D;R++)d.push(R),d.push(R+1),d.push(R+p+1),d.push(R+p+1),d.push(R+1),d.push(R+p+2)}e._ComputeSides(l,f,d,m,_);var I=new e;return I.indices=d,I.positions=f,I.normals=m,I.uvs=_,I},e.CreateCylinder=function(i){var r,n=i.height||2,s=0===i.diameterTop?0:i.diameterTop||i.diameter||1,o=0===i.diameterBottom?0:i.diameterBottom||i.diameter||1,a=i.tessellation||24,h=i.subdivisions||1,l=i.hasRings,c=i.enclose,u=i.arc<=0||i.arc>1?1:i.arc||1,p=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,d=i.faceUV||new Array(3),f=i.faceColors,m=1!==u&&c?2:0,_=l?h:1,g=2+(1+m)*_;for(r=0;r<g;r++)f&&void 0===f[r]&&(f[r]=new t.Color4(1,1,1,1));for(r=0;r<g;r++)d&&void 0===d[r]&&(d[r]=new t.Vector4(0,0,1,1));var y,v,x,b,P,T,S=[],A=[],C=[],E=[],M=[],D=2*Math.PI*u/a,R=(o-s)/2/n,I=t.Vector3.Zero(),O=t.Vector3.Zero(),w=t.Vector3.Zero(),L=t.Vector3.Zero(),F=t.Vector3.Zero(),V=t.Axis.Y,N=1,z=1,B=0,k=0;for(b=0;b<=h;b++)for(v=b/h,x=(v*(s-o)+o)/2,N=l&&0!==b&&b!==h?2:1,T=0;T<N;T++){for(l&&(z+=T),c&&(z+=2*T),P=0;P<=a;P++)y=P*D,I.x=Math.cos(-y)*x,I.y=-n/2+v*n,I.z=Math.sin(-y)*x,0===s&&b===h?(O.x=C[C.length-3*(a+1)],O.y=C[C.length-3*(a+1)+1],O.z=C[C.length-3*(a+1)+2]):(O.x=I.x,O.z=I.z,O.y=Math.sqrt(O.x*O.x+O.z*O.z)*R,O.normalize()),0===P&&(w.copyFrom(I),L.copyFrom(O)),A.push(I.x,I.y,I.z),C.push(O.x,O.y,O.z),k=l?B!==z?d[z].y:d[z].w:d[z].y+(d[z].w-d[z].y)*v,E.push(d[z].x+(d[z].z-d[z].x)*P/a,k),f&&M.push(f[z].r,f[z].g,f[z].b,f[z].a);1!==u&&c&&(A.push(I.x,I.y,I.z),A.push(0,I.y,0),A.push(0,I.y,0),A.push(w.x,w.y,w.z),t.Vector3.CrossToRef(V,O,F),F.normalize(),C.push(F.x,F.y,F.z,F.x,F.y,F.z),t.Vector3.CrossToRef(L,V,F),F.normalize(),C.push(F.x,F.y,F.z,F.x,F.y,F.z),k=l?B!==z?d[z+1].y:d[z+1].w:d[z+1].y+(d[z+1].w-d[z+1].y)*v,E.push(d[z+1].x,k),E.push(d[z+1].z,k),k=l?B!==z?d[z+2].y:d[z+2].w:d[z+2].y+(d[z+2].w-d[z+2].y)*v,E.push(d[z+2].x,k),E.push(d[z+2].z,k),f&&(M.push(f[z+1].r,f[z+1].g,f[z+1].b,f[z+1].a),M.push(f[z+1].r,f[z+1].g,f[z+1].b,f[z+1].a),M.push(f[z+2].r,f[z+2].g,f[z+2].b,f[z+2].a),M.push(f[z+2].r,f[z+2].g,f[z+2].b,f[z+2].a))),B!==z&&(B=z)}var z,U=1!==u&&c?a+4:a;for(b=0,z=0;z<h;z++){for(P=0;P<a;P++){var G=b*(U+1)+P,W=(b+1)*(U+1)+P,j=b*(U+1)+(P+1),H=(b+1)*(U+1)+(P+1);S.push(G,W,j),S.push(H,j,W)}1!==u&&c&&(S.push(G+2,W+2,j+2),S.push(H+2,j+2,W+2),S.push(G+4,W+4,j+4),S.push(H+4,j+4,W+4)),b=l?b+2:b+1}var X=function(e){var i=e?s/2:o/2;if(0!==i){var r,h,l,c,p=e?d[g-1]:d[0];f&&(c=e?f[g-1]:f[0]);var m=A.length/3,_=e?n/2:-n/2,y=new t.Vector3(0,_,0);A.push(y.x,y.y,y.z),C.push(0,e?1:-1,0),E.push(p.x+.5*(p.z-p.x),p.y+.5*(p.w-p.y)),f&&M.push(c.r,c.g,c.b,c.a);var v=new t.Vector2(.5,.5);for(l=0;l<=a;l++){r=2*Math.PI*l*u/a;var x=Math.cos(-r),b=Math.sin(-r);h=new t.Vector3(x*i,_,b*i);var P=new t.Vector2(x*v.x+.5,b*v.y+.5);A.push(h.x,h.y,h.z),C.push(0,e?1:-1,0),E.push(p.x+(p.z-p.x)*P.x,p.y+(p.w-p.y)*P.y),f&&M.push(c.r,c.g,c.b,c.a)}for(l=0;l<a;l++)e?(S.push(m),S.push(m+(l+2)),S.push(m+(l+1))):(S.push(m),S.push(m+(l+1)),S.push(m+(l+2)))}};X(!1),X(!0),e._ComputeSides(p,A,S,C,E);var Y=new e;return Y.indices=S,Y.positions=A,Y.normals=C,Y.uvs=E,f&&(Y.colors=M),Y},e.CreateTorus=function(i){for(var r=[],n=[],s=[],o=[],a=i.diameter||1,h=i.thickness||.5,l=i.tessellation||16,c=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,u=l+1,p=0;p<=l;p++)for(var d=p/l,f=p*Math.PI*2/l-Math.PI/2,m=t.Matrix.Translation(a/2,0,0).multiply(t.Matrix.RotationY(f)),_=0;_<=l;_++){var g=1-_/l,y=_*Math.PI*2/l+Math.PI,v=Math.cos(y),x=Math.sin(y),b=new t.Vector3(v,x,0),P=b.scale(h/2),T=new t.Vector2(d,g);P=t.Vector3.TransformCoordinates(P,m),b=t.Vector3.TransformNormal(b,m),n.push(P.x,P.y,P.z),s.push(b.x,b.y,b.z),o.push(T.x,T.y);var S=(p+1)%u,A=(_+1)%u;r.push(p*u+_),r.push(p*u+A),r.push(S*u+_),r.push(p*u+A),r.push(S*u+A),r.push(S*u+_)}e._ComputeSides(c,n,r,s,o);var C=new e;return C.indices=r,C.positions=n,C.normals=s,C.uvs=o,C},e.CreateLineSystem=function(t){for(var i=[],r=[],n=t.lines,s=0,o=0;o<n.length;o++)for(var a=n[o],h=0;h<a.length;h++)r.push(a[h].x,a[h].y,a[h].z),h>0&&(i.push(s-1),i.push(s)),s++;var l=new e;return l.indices=i,l.positions=r,l},e.CreateDashedLines=function(i){var r=i.dashSize||3,n=i.gapSize||1,s=i.dashNb||200,o=i.points,a=new Array,h=new Array,l=t.Vector3.Zero(),c=0,u=0,p=0,d=0,f=0,m=0,_=0;for(_=0;_<o.length-1;_++)o[_+1].subtractToRef(o[_],l),c+=l.length();for(p=c/s,d=r*p/(r+n),_=0;_<o.length-1;_++){o[_+1].subtractToRef(o[_],l),u=Math.floor(l.length()/p),l.normalize();for(var g=0;g<u;g++)f=p*g,a.push(o[_].x+f*l.x,o[_].y+f*l.y,o[_].z+f*l.z),a.push(o[_].x+(f+d)*l.x,o[_].y+(f+d)*l.y,o[_].z+(f+d)*l.z),h.push(m,m+1),m+=2}var y=new e;return y.positions=a,y.indices=h,y},e.CreateGround=function(i){var r,n,s=[],o=[],a=[],h=[],l=i.width||1,c=i.height||1,u=i.subdivisionsX||i.subdivisions||1,p=i.subdivisionsY||i.subdivisions||1;for(r=0;r<=p;r++)for(n=0;n<=u;n++){var d=new t.Vector3(n*l/u-l/2,0,(p-r)*c/p-c/2),f=new t.Vector3(0,1,0);o.push(d.x,d.y,d.z),a.push(f.x,f.y,f.z),h.push(n/u,1-r/u)}for(r=0;r<p;r++)for(n=0;n<u;n++)s.push(n+1+(r+1)*(u+1)),s.push(n+1+r*(u+1)),s.push(n+r*(u+1)),s.push(n+(r+1)*(u+1)),s.push(n+1+(r+1)*(u+1)),s.push(n+r*(u+1));var m=new e;return m.indices=s,m.positions=o,m.normals=a,m.uvs=h,m},e.CreateTiledGround=function(i){function r(e,i,r,o){var a=m.length/3,h=d.w+1;for(n=0;n<d.h;n++)for(s=0;s<d.w;s++){var l=[a+s+n*h,a+(s+1)+n*h,a+(s+1)+(n+1)*h,a+s+(n+1)*h];f.push(l[1]),f.push(l[2]),f.push(l[3]),f.push(l[0]),f.push(l[1]),f.push(l[3])}var c=t.Vector3.Zero(),u=new t.Vector3(0,1,0);for(n=0;n<=d.h;n++)for(c.z=n*(o-i)/d.h+i,s=0;s<=d.w;s++)c.x=s*(r-e)/d.w+e,c.y=0,m.push(c.x,c.y,c.z),_.push(u.x,u.y,u.z),g.push(s/d.w,n/d.h)}var n,s,o,a,h=i.xmin||-1,l=i.zmin||-1,c=i.xmax||1,u=i.zmax||1,p=i.subdivisions||{w:1,h:1},d=i.precision||{w:1,h:1},f=[],m=[],_=[],g=[];p.h=p.h<1?1:p.h,p.w=p.w<1?1:p.w,d.w=d.w<1?1:d.w,d.h=d.h<1?1:d.h;var y={w:(c-h)/p.w,h:(u-l)/p.h};for(o=0;o<p.h;o++)for(a=0;a<p.w;a++)r(h+a*y.w,l+o*y.h,h+(a+1)*y.w,l+(o+1)*y.h);var v=new e;return v.indices=f,v.positions=m,v.normals=_,v.uvs=g,v},e.CreateGroundFromHeightMap=function(i){var r,n,s=[],o=[],a=[],h=[];for(r=0;r<=i.subdivisions;r++)for(n=0;n<=i.subdivisions;n++){var l=new t.Vector3(n*i.width/i.subdivisions-i.width/2,0,(i.subdivisions-r)*i.height/i.subdivisions-i.height/2),c=(l.x+i.width/2)/i.width*(i.bufferWidth-1)|0,u=(1-(l.z+i.height/2)/i.height)*(i.bufferHeight-1)|0,p=4*(c+u*i.bufferWidth),d=i.buffer[p]/255,f=i.buffer[p+1]/255,m=i.buffer[p+2]/255,_=.3*d+.59*f+.11*m;l.y=i.minHeight+(i.maxHeight-i.minHeight)*_,o.push(l.x,l.y,l.z),a.push(0,0,0),h.push(n/i.subdivisions,1-r/i.subdivisions)}for(r=0;r<i.subdivisions;r++)for(n=0;n<i.subdivisions;n++)s.push(n+1+(r+1)*(i.subdivisions+1)),s.push(n+1+r*(i.subdivisions+1)),s.push(n+r*(i.subdivisions+1)),s.push(n+(r+1)*(i.subdivisions+1)),s.push(n+1+(r+1)*(i.subdivisions+1)),s.push(n+r*(i.subdivisions+1));e.ComputeNormals(o,s,a);var g=new e;return g.indices=s,g.positions=o,g.normals=a,g.uvs=h,g},e.CreatePlane=function(i){var r=[],n=[],s=[],o=[],a=i.width||i.size||1,h=i.height||i.size||1,l=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,c=a/2,u=h/2;n.push(-c,-u,0),s.push(0,0,-1),o.push(0,0),n.push(c,-u,0),s.push(0,0,-1),o.push(1,0),n.push(c,u,0),s.push(0,0,-1),o.push(1,1),n.push(-c,u,0),s.push(0,0,-1),o.push(0,1),r.push(0),r.push(1),r.push(2),r.push(0),r.push(2),r.push(3),e._ComputeSides(l,n,r,s,o);var p=new e;return p.indices=r,p.positions=n,p.normals=s,p.uvs=o,p},e.CreateDisc=function(i){var r=[],n=[],s=[],o=[],a=i.radius||.5,h=i.tessellation||64,l=i.arc<=0||i.arc>1?1:i.arc||1,c=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE;r.push(0,0,0),o.push(.5,.5);for(var u=2*Math.PI*l,p=u/h,d=0;d<u;d+=p){var f=Math.cos(d),m=Math.sin(d),_=(f+1)/2,g=(1-m)/2;r.push(a*f,a*m,0),o.push(_,g)}1===l&&(r.push(r[3],r[4],r[5]),o.push(o[2],o[3]));for(var y=r.length/3,v=1;v<y-1;v++)n.push(v+1,0,v);e.ComputeNormals(r,n,s),e._ComputeSides(c,r,n,s,o);var x=new e;return x.indices=n,x.positions=r,x.normals=s,x.uvs=o,x},e.CreateIcoSphere=function(i){var r,n=i.sideOrientation||t.Mesh.DEFAULTSIDE,s=i.radius||1,o=void 0===i.flat||i.flat,a=i.subdivisions||4,h=i.radiusX||s,l=i.radiusY||s,c=i.radiusZ||s,u=(1+Math.sqrt(5))/2,p=[-1,u,-0,1,u,0,-1,-u,0,1,-u,0,0,-1,-u,0,1,-u,0,-1,u,0,1,u,u,0,1,u,0,-1,-u,0,1,-u,0,-1],d=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],f=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],m=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],_=138/1024,g=239/1024,y=60/1024,v=26/1024,x=-40/1024,b=20/1024,P=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],T=[],S=[],A=[],C=[],E=0,M=new Array(3),D=new Array(3);for(r=0;r<3;r++)M[r]=t.Vector3.Zero(),D[r]=t.Vector2.Zero();for(var R=0;R<20;R++){for(r=0;r<3;r++){var I=d[3*R+r];M[r].copyFromFloats(p[3*f[I]],p[3*f[I]+1],p[3*f[I]+2]),M[r].normalize().scaleInPlace(s),D[r].copyFromFloats(m[2*I]*_+y+P[R]*x,m[2*I+1]*g+v+P[R]*b)}for(var O=function(e,i,r,n){var s=t.Vector3.Lerp(M[0],M[2],i/a),u=t.Vector3.Lerp(M[1],M[2],i/a),p=a===i?M[2]:t.Vector3.Lerp(s,u,e/(a-i));p.normalize();var d;if(o){var f=t.Vector3.Lerp(M[0],M[2],n/a),m=t.Vector3.Lerp(M[1],M[2],n/a);d=t.Vector3.Lerp(f,m,r/(a-n))}else d=new t.Vector3(p.x,p.y,p.z);d.x/=h,d.y/=l,d.z/=c,d.normalize();var _=t.Vector2.Lerp(D[0],D[2],i/a),g=t.Vector2.Lerp(D[1],D[2],i/a),y=a===i?D[2]:t.Vector2.Lerp(_,g,e/(a-i));S.push(p.x*h,p.y*l,p.z*c),A.push(d.x,d.y,d.z),C.push(y.x,y.y),T.push(E),E++},w=0;w<a;w++)for(var L=0;L+w<a;L++)O(L,w,L+1/3,w+1/3),O(L+1,w,L+1/3,w+1/3),O(L,w+1,L+1/3,w+1/3),L+w+1<a&&(O(L+1,w,L+2/3,w+2/3),O(L+1,w+1,L+2/3,w+2/3),O(L,w+1,L+2/3,w+2/3))}e._ComputeSides(n,S,T,A,C);var F=new e;return F.indices=T,F.positions=S,F.normals=A,F.uvs=C,F},e.CreatePolyhedron=function(i){var r=[];r[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},r[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},r[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},r[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},r[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},r[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},r[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},r[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},r[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},r[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},r[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},r[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},r[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},r[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},r[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var n,s,o,a,h,l,c=i.type<0||i.type>=r.length?0:i.type||0,u=i.size,p=i.sizeX||u||1,d=i.sizeY||u||1,f=i.sizeZ||u||1,m=i.custom||r[c],_=m.face.length,g=i.faceUV||new Array(_),y=i.faceColors,v=void 0===i.flat||i.flat,x=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,b=[],P=[],T=[],S=[],A=[],C=0,E=0,M=[],D=0,R=0;if(v)for(R=0;R<_;R++)y&&void 0===y[R]&&(y[R]=new t.Color4(1,1,1,1)),g&&void 0===g[R]&&(g[R]=new t.Vector4(0,0,1,1));if(v)for(R=0;R<_;R++){var I=m.face[R].length;for(o=2*Math.PI/I,a=.5*Math.tan(o/2),h=.5,D=0;D<I;D++)b.push(m.vertex[m.face[R][D]][0]*p,m.vertex[m.face[R][D]][1]*d,m.vertex[m.face[R][D]][2]*f),M.push(C),C++,n=g[R].x+(g[R].z-g[R].x)*(.5+a),s=g[R].y+(g[R].w-g[R].y)*(h-.5),S.push(n,s),l=a*Math.cos(o)-h*Math.sin(o),h=a*Math.sin(o)+h*Math.cos(o),a=l,y&&A.push(y[R].r,y[R].g,y[R].b,y[R].a);for(D=0;D<I-2;D++)P.push(M[0+E],M[D+2+E],M[D+1+E]);E+=I}else{for(D=0;D<m.vertex.length;D++)b.push(m.vertex[D][0]*p,m.vertex[D][1]*d,m.vertex[D][2]*f),S.push(0,0);for(R=0;R<_;R++)for(D=0;D<m.face[R].length-2;D++)P.push(m.face[R][0],m.face[R][D+2],m.face[R][D+1])}e.ComputeNormals(b,P,T),e._ComputeSides(x,b,P,T,S);var O=new e;return O.positions=b,O.indices=P,O.normals=T,O.uvs=S,y&&v&&(O.colors=A),O},e.CreateTorusKnot=function(i){var r,n,s=[],o=[],a=[],h=[],l=i.radius||2,c=i.tube||.5,u=i.radialSegments||32,p=i.tubularSegments||32,d=i.p||2,f=i.q||3,m=0===i.sideOrientation?0:i.sideOrientation||t.Mesh.DEFAULTSIDE,_=function(e){var i=Math.cos(e),r=Math.sin(e),n=f/d*e,s=Math.cos(n),o=l*(2+s)*.5*i,a=l*(2+s)*r*.5,h=l*Math.sin(n)*.5;return new t.Vector3(o,a,h)};for(r=0;r<=u;r++){var g=r%u,y=g/u*2*d*Math.PI,v=_(y),x=_(y+.01),b=x.subtract(v),P=x.add(v),T=t.Vector3.Cross(b,P);for(P=t.Vector3.Cross(T,b),T.normalize(),P.normalize(),n=0;n<p;n++){var S=n%p,A=S/p*2*Math.PI,C=-c*Math.cos(A),E=c*Math.sin(A);o.push(v.x+C*P.x+E*T.x),o.push(v.y+C*P.y+E*T.y),o.push(v.z+C*P.z+E*T.z),h.push(r/u),h.push(n/p)}}for(r=0;r<u;r++)for(n=0;n<p;n++){var M=(n+1)%p,D=r*p+n,R=(r+1)*p+n,I=(r+1)*p+M,O=r*p+M;s.push(O),s.push(R),s.push(D),s.push(O),s.push(I),s.push(R)}e.ComputeNormals(o,s,a),e._ComputeSides(m,o,s,a,h);var w=new e;return w.indices=s,w.positions=o,w.normals=a,w.uvs=h,w},e.ComputeNormals=function(t,e,i){var r=0,n=0,s=0,o=0,a=0,h=0,l=0,c=0,u=0,p=0,d=0,f=0,m=0,_=0;for(r=0;r<t.length;r++)i[r]=0;var g=e.length/3;for(r=0;r<g;r++)f=e[3*r],m=e[3*r+1],_=e[3*r+2],n=t[3*f]-t[3*m],s=t[3*f+1]-t[3*m+1],o=t[3*f+2]-t[3*m+2],a=t[3*_]-t[3*m],h=t[3*_+1]-t[3*m+1],l=t[3*_+2]-t[3*m+2],c=s*l-o*h,u=o*a-n*l,p=n*h-s*a,d=Math.sqrt(c*c+u*u+p*p),d=0===d?1:d,c/=d,u/=d,p/=d,i[3*f]+=c,i[3*f+1]+=u,i[3*f+2]+=p,i[3*m]+=c,i[3*m+1]+=u,i[3*m+2]+=p,i[3*_]+=c,i[3*_+1]+=u,i[3*_+2]+=p;for(r=0;r<i.length/3;r++)c=i[3*r],u=i[3*r+1],p=i[3*r+2],d=Math.sqrt(c*c+u*u+p*p),d=0===d?1:d,c/=d,u/=d,p/=d,i[3*r]=c,i[3*r+1]=u,i[3*r+2]=p},e._ComputeSides=function(e,i,r,n,s){var o,a,h=r.length,l=n.length;switch(e=e||t.Mesh.DEFAULTSIDE){case t.Mesh.FRONTSIDE:break;case t.Mesh.BACKSIDE:var c;for(o=0;o<h;o+=3)c=r[o],r[o]=r[o+2],r[o+2]=c;for(a=0;a<l;a++)n[a]=-n[a];break;case t.Mesh.DOUBLESIDE:for(var u=i.length,p=u/3,d=0;d<u;d++)i[u+d]=i[d];for(o=0;o<h;o+=3)r[o+h]=r[o+2]+p,r[o+1+h]=r[o+1]+p,r[o+2+h]=r[o]+p;for(a=0;a<l;a++)n[l+a]=-n[a];for(var f=s.length,m=0;m<f;m++)s[m+f]=s[m]}},e.ImportVertexData=function(i,r){var n=new e,s=i.positions;s&&n.set(s,t.VertexBuffer.PositionKind);var o=i.normals;o&&n.set(o,t.VertexBuffer.NormalKind);var a=i.uvs;a&&n.set(a,t.VertexBuffer.UVKind);var h=i.uv2s;h&&n.set(h,t.VertexBuffer.UV2Kind);var l=i.uv3s;l&&n.set(l,t.VertexBuffer.UV3Kind);var c=i.uv4s;c&&n.set(c,t.VertexBuffer.UV4Kind);var u=i.uv5s;u&&n.set(u,t.VertexBuffer.UV5Kind);var p=i.uv6s;p&&n.set(p,t.VertexBuffer.UV6Kind);var d=i.colors;d&&n.set(t.Color4.CheckColors4(d,s.length/3),t.VertexBuffer.ColorKind);var f=i.matricesIndices;f&&n.set(f,t.VertexBuffer.MatricesIndicesKind);var m=i.matricesWeights;m&&n.set(m,t.VertexBuffer.MatricesWeightsKind);var _=i.indices;_&&(n.indices=_),r.setAllVerticesData(n,i.updatable)},e}();t.VertexData=e}(r||(r={}));var r;!function(t){var e=function(){function e(){}return e.EnableFor=function(t){t._tags=t._tags||{},t.hasTags=function(){return e.HasTags(t)},t.addTags=function(i){return e.AddTagsTo(t,i)},t.removeTags=function(i){return e.RemoveTagsFrom(t,i)},t.matchesTagsQuery=function(i){return e.MatchesQuery(t,i)}},e.DisableFor=function(t){delete t._tags,delete t.hasTags,delete t.addTags,delete t.removeTags,delete t.matchesTagsQuery},e.HasTags=function(e){return!!e._tags&&!t.Tools.IsEmpty(e._tags)},e.GetTags=function(t,e){if(void 0===e&&(e=!0),!t._tags)return null;if(e){var i=[];for(var r in t._tags)t._tags.hasOwnProperty(r)&&t._tags[r]===!0&&i.push(r);return i.join(" ")}return t._tags},e.AddTagsTo=function(t,i){if(i&&"string"==typeof i){i.split(" ").forEach(function(i,r,n){e._AddTagTo(t,i)})}},e._AddTagTo=function(t,i){""!==(i=i.trim())&&"true"!==i&&"false"!==i&&(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(e.EnableFor(t),t._tags[i]=!0))},e.RemoveTagsFrom=function(t,i){if(e.HasTags(t)){var r=i.split(" ");for(var n in r)e._RemoveTagFrom(t,r[n])}},e._RemoveTagFrom=function(t,e){delete t._tags[e]},e.MatchesQuery=function(i,r){return void 0===r||(""===r?e.HasTags(i):t.Internals.AndOrNotEvaluator.Eval(r,function(t){return e.HasTags(i)&&i._tags[t]}))},e}();t.Tags=e}(r||(r={}));var r;!function(t){!function(t){var e=function(){function t(){}return t.Eval=function(e,i){return"true"===(e=e.match(/\([^\(\)]*\)/g)?e.replace(/\([^\(\)]*\)/g,function(e){return e=e.slice(1,e.length-1),t._HandleParenthesisContent(e,i)}):t._HandleParenthesisContent(e,i))||"false"!==e&&t.Eval(e,i)},t._HandleParenthesisContent=function(e,i){i=i||function(t){return"true"===t};var r,n=e.split("||");for(var s in n)if(n.hasOwnProperty(s)){var o=t._SimplifyNegation(n[s].trim()),a=o.split("&&");if(a.length>1)for(var h=0;h<a.length;++h){var l=t._SimplifyNegation(a[h].trim());if(!(r="true"!==l&&"false"!==l?"!"===l[0]?!i(l.substring(1)):i(l):"true"===l)){o="false";break}}if(r||"true"===o){r=!0;break}r="true"!==o&&"false"!==o?"!"===o[0]?!i(o.substring(1)):i(o):"true"===o}return r?"true":"false"},t._SimplifyNegation=function(t){return t=t.replace(/^[\s!]+/,function(t){return t=t.replace(/[\s]/g,function(){return""}),t.length%2?"!":""}),t=t.trim(),"!true"===t?t="false":"!false"===t&&(t="true"),t},t}();t.AndOrNotEvaluator=e}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s,o){this._enabled=!0,this._refCount=0,this._name=i,this._renderTexture=new t.RenderTargetTexture(i,r,e),this.setRenderList(n),this._renderTexture.onBeforeRenderObservable.add(s),this._renderTexture.onAfterRenderObservable.add(o),this._scene=e,this._renderList=n}return e.prototype._incRefCount=function(){return 0===this._refCount&&this._scene.customRenderTargets.push(this._renderTexture),++this._refCount},e.prototype._decRefCount=function(){return this._refCount--,this._refCount<=0&&this._scene.customRenderTargets.splice(this._scene.customRenderTargets.indexOf(this._renderTexture),1),this._refCount},e.prototype._update=function(){this.setRenderList(this._renderList)},e.prototype.setRenderList=function(t){this._renderTexture.renderList=t},e.prototype.getRenderTexture=function(){return this._renderTexture},e}();t.PostProcessRenderPass=e}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i,r){this._engine=t,this._name=e,this._singleInstance=r||!0,this._getPostProcess=i,this._cameras=[],this._indicesForCamera=[],this._postProcesses={},this._renderPasses={},this._renderEffectAsPasses={}}return Object.defineProperty(e.prototype,"isSupported",{get:function(){for(var t in this._postProcesses)if(!this._postProcesses[t].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype._update=function(){for(var t in this._renderPasses)this._renderPasses[t]._update()},e.prototype.addPass=function(t){this._renderPasses[t._name]=t,this._linkParameters()},e.prototype.removePass=function(t){delete this._renderPasses[t._name],this._linkParameters()},e.prototype.addRenderEffectAsPass=function(t){this._renderEffectAsPasses[t._name]=t,this._linkParameters()},e.prototype.getPass=function(t){for(var e in this._renderPasses)if(e===t)return this._renderPasses[t]},e.prototype.emptyPasses=function(){this._renderPasses={},this._linkParameters()},e.prototype._attachCameras=function(e){for(var i,r=t.Tools.MakeArray(e||this._cameras),n=0;n<r.length;n++){var s=r[n],o=s.name;i=this._singleInstance?0:o,this._postProcesses[i]=this._postProcesses[i]||this._getPostProcess();var a=s.attachPostProcess(this._postProcesses[i]);this._indicesForCamera[o]||(this._indicesForCamera[o]=[]),this._indicesForCamera[o].push(a),this._cameras.indexOf(s)===-1&&(this._cameras[o]=s);for(var h in this._renderPasses)this._renderPasses[h]._incRefCount()}this._linkParameters()},e.prototype._detachCameras=function(e){for(var i=t.Tools.MakeArray(e||this._cameras),r=0;r<i.length;r++){var n=i[r],s=n.name;n.detachPostProcess(this._postProcesses[this._singleInstance?0:s],this._indicesForCamera[s]);var o=this._cameras.indexOf(s);this._indicesForCamera.splice(o,1),this._cameras.splice(o,1);for(var a in this._renderPasses)this._renderPasses[a]._decRefCount()}},e.prototype._enable=function(e){for(var i=t.Tools.MakeArray(e||this._cameras),r=0;r<i.length;r++){for(var n=i[r],s=n.name,o=0;o<this._indicesForCamera[s].length;o++)void 0===n._postProcesses[this._indicesForCamera[s][o]]&&e[r].attachPostProcess(this._postProcesses[this._singleInstance?0:s],this._indicesForCamera[s][o]);for(var a in this._renderPasses)this._renderPasses[a]._incRefCount()}},e.prototype._disable=function(e){for(var i=t.Tools.MakeArray(e||this._cameras),r=0;r<i.length;r++){var n=i[r],s=n.Name;n.detachPostProcess(this._postProcesses[this._singleInstance?0:s],this._indicesForCamera[s]);for(var o in this._renderPasses)this._renderPasses[o]._decRefCount()}},e.prototype.getPostProcess=function(t){return this._singleInstance?this._postProcesses[0]:this._postProcesses[t.name]},e.prototype._linkParameters=function(){var t=this;for(var e in this._postProcesses)this.applyParameters&&this.applyParameters(this._postProcesses[e]),this._postProcesses[e].onBeforeRenderObservable.add(function(e){t._linkTextures(e)})},e.prototype._linkTextures=function(t){for(var e in this._renderPasses)t.setTexture(e,this._renderPasses[e].getRenderTexture());for(var i in this._renderEffectAsPasses)t.setTextureFromPostProcess(i+"Sampler",this._renderEffectAsPasses[i].getPostProcess())},e}();t.PostProcessRenderEffect=e}(r||(r={}));var r;!function(t){var e=function(){function e(t,e){this._engine=t,this._name=e,this._renderEffects={},this._renderEffectsForIsolatedPass={},this._cameras=[]}return Object.defineProperty(e.prototype,"isSupported",{get:function(){for(var t in this._renderEffects)if(!this._renderEffects[t].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype.addEffect=function(t){this._renderEffects[t._name]=t},e.prototype._enableEffect=function(e,i){var r=this._renderEffects[e];r&&r._enable(t.Tools.MakeArray(i||this._cameras))},e.prototype._disableEffect=function(e,i){var r=this._renderEffects[e];r&&r._disable(t.Tools.MakeArray(i||this._cameras))},e.prototype._attachCameras=function(e,i){var r,n=t.Tools.MakeArray(e||this._cameras),s=[];for(r=0;r<n.length;r++){var o=n[r],a=o.name;this._cameras.indexOf(o)===-1?this._cameras[a]=o:i&&s.push(r)}for(r=0;r<s.length;r++)e.splice(s[r],1);for(var h in this._renderEffects)this._renderEffects[h]._attachCameras(n)},e.prototype._detachCameras=function(e){var i=t.Tools.MakeArray(e||this._cameras);for(var r in this._renderEffects)this._renderEffects[r]._detachCameras(i);for(var n=0;n<i.length;n++)this._cameras.splice(this._cameras.indexOf(i[n]),1)},e.prototype._enableDisplayOnlyPass=function(i,r){var n,s=this,o=t.Tools.MakeArray(r||this._cameras),a=null;for(n in this._renderEffects)if(null!=(a=this._renderEffects[n].getPass(i)))break;if(null!==a){for(n in this._renderEffects)this._renderEffects[n]._disable(o);a._name=e.PASS_SAMPLER_NAME;for(var h=0;h<o.length;h++){var l=o[h],c=l.name;this._renderEffectsForIsolatedPass[c]=this._renderEffectsForIsolatedPass[c]||new t.PostProcessRenderEffect(this._engine,e.PASS_EFFECT_NAME,function(){return new t.DisplayPassPostProcess(e.PASS_EFFECT_NAME,1,null,null,s._engine,!0)}),this._renderEffectsForIsolatedPass[c].emptyPasses(),this._renderEffectsForIsolatedPass[c].addPass(a),this._renderEffectsForIsolatedPass[c]._attachCameras(l)}}},e.prototype._disableDisplayOnlyPass=function(i){for(var r=this,n=t.Tools.MakeArray(i||this._cameras),s=0;s<n.length;s++){var o=n[s],a=o.name;this._renderEffectsForIsolatedPass[a]=this._renderEffectsForIsolatedPass[a]||new t.PostProcessRenderEffect(this._engine,e.PASS_EFFECT_NAME,function(){return new t.DisplayPassPostProcess(e.PASS_EFFECT_NAME,1,null,null,r._engine,!0)}),this._renderEffectsForIsolatedPass[a]._disable(o)}for(var h in this._renderEffects)this._renderEffects[h]._enable(n)},e.prototype._update=function(){for(var t in this._renderEffects)this._renderEffects[t]._update();for(var e=0;e<this._cameras.length;e++){var i=this._cameras[e].name;this._renderEffectsForIsolatedPass[i]&&this._renderEffectsForIsolatedPass[i]._update()}},e.prototype.dispose=function(){},e.PASS_EFFECT_NAME="passEffect",e.PASS_SAMPLER_NAME="passSampler",e}();t.PostProcessRenderPipeline=e}(r||(r={}));var r;!function(t){var e=function(){function t(){this._renderPipelines={}}return t.prototype.addPipeline=function(t){this._renderPipelines[t._name]=t},t.prototype.attachCamerasToRenderPipeline=function(t,e,i){var r=this._renderPipelines[t];r&&r._attachCameras(e,i)},t.prototype.detachCamerasFromRenderPipeline=function(t,e){var i=this._renderPipelines[t];i&&i._detachCameras(e)},t.prototype.enableEffectInPipeline=function(t,e,i){var r=this._renderPipelines[t];r&&r._enableEffect(e,i)},t.prototype.disableEffectInPipeline=function(t,e,i){var r=this._renderPipelines[t];r&&r._disableEffect(e,i)},t.prototype.enableDisplayOnlyPassInPipeline=function(t,e,i){var r=this._renderPipelines[t];r&&r._enableDisplayOnlyPass(e,i)},t.prototype.disableDisplayOnlyPassInPipeline=function(t,e){var i=this._renderPipelines[t];i&&i._disableDisplayOnlyPass(e)},t.prototype.update=function(){for(var t in this._renderPipelines){var e=this._renderPipelines[t];e.isSupported?e._update():(e.dispose(),delete this._renderPipelines[t])}},t}();t.PostProcessRenderPipelineManager=e}(r||(r={}));var r;!function(t){var e=function(){function e(e){this.frontColor=new t.Color3(1,1,1),this.backColor=new t.Color3(.1,.1,.1),this.showBackLines=!0,this.renderList=new t.SmartArray(32),this._vertexBuffers={},this._scene=e}return e.prototype._prepareRessources=function(){if(!this._colorShader){this._colorShader=new t.ShaderMaterial("colorShader",this._scene,"color",{attributes:[t.VertexBuffer.PositionKind],uniforms:["worldViewProjection","color"]});var e=this._scene.getEngine(),i=t.VertexData.CreateBox(1);this._vertexBuffers[t.VertexBuffer.PositionKind]=new t.VertexBuffer(e,i.positions,t.VertexBuffer.PositionKind,!1),this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}},e.prototype.reset=function(){this.renderList.reset()},e.prototype.render=function(){if(0!==this.renderList.length&&(this._prepareRessources(),this._colorShader.isReady())){var e=this._scene.getEngine();e.setDepthWrite(!1),this._colorShader._preBind();for(var i=0;i<this.renderList.length;i++){var r=this.renderList.data[i],n=r.minimum,s=r.maximum,o=s.subtract(n),a=n.add(o.scale(.5)),h=t.Matrix.Scaling(o.x,o.y,o.z).multiply(t.Matrix.Translation(a.x,a.y,a.z)).multiply(r.getWorldMatrix());e.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),this.showBackLines&&(e.setDepthFunctionToGreaterOrEqual(),this._scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.backColor.toColor4()),this._colorShader.bind(h),e.draw(!1,0,24)),e.setDepthFunctionToLess(),this._scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.frontColor.toColor4()),this._colorShader.bind(h),e.draw(!1,0,24)}this._colorShader.unbind(),e.setDepthFunctionToLessOrEqual(),e.setDepthWrite(!0)}},e.prototype.dispose=function(){if(this._colorShader){this._colorShader.dispose();var e=this._vertexBuffers[t.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[t.VertexBuffer.PositionKind]=null),this._scene.getEngine()._releaseBuffer(this._indexBuffer)}},e}();t.BoundingBoxRenderer=e}(r||(r={}));var r;!function(t){var e=function(){function t(t){this._actionManager=t}return t.prototype.isValid=function(){return!0},t.prototype._getProperty=function(t){return this._actionManager._getProperty(t)},t.prototype._getEffectiveTarget=function(t,e){return this._actionManager._getEffectiveTarget(t,e)},t.prototype.serialize=function(){},t.prototype._serialize=function(t){return{type:2,children:[],name:t.name,properties:t.properties}},t}();t.Condition=e;var i=function(e){function i(t,r,n,s,o){void 0===o&&(o=i.IsEqual),e.call(this,t),this.propertyPath=n,this.value=s,this.operator=o,this._target=r,this._effectiveTarget=this._getEffectiveTarget(r,this.propertyPath),this._property=this._getProperty(this.propertyPath)}return o(i,e),Object.defineProperty(i,"IsEqual",{get:function(){return i._IsEqual},enumerable:!0,configurable:!0}),Object.defineProperty(i,"IsDifferent",{get:function(){return i._IsDifferent},enumerable:!0,configurable:!0}),Object.defineProperty(i,"IsGreater",{get:function(){return i._IsGreater},enumerable:!0,configurable:!0}),Object.defineProperty(i,"IsLesser",{get:function(){return i._IsLesser},enumerable:!0,configurable:!0}),i.prototype.isValid=function(){switch(this.operator){case i.IsGreater:return this._effectiveTarget[this._property]>this.value;case i.IsLesser:return this._effectiveTarget[this._property]<this.value;case i.IsEqual:case i.IsDifferent:var t;return t=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===i.IsEqual?t:!t}return!1},i.prototype.serialize=function(){return this._serialize({name:"ValueCondition",properties:[t.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:t.Action._SerializeValueAsString(this.value)},{name:"operator",value:i.GetOperatorName(this.operator)}]})},i.GetOperatorName=function(t){switch(t){case i._IsEqual:return"IsEqual";case i._IsDifferent:return"IsDifferent";case i._IsGreater:return"IsGreater";case i._IsLesser:return"IsLesser";default:return""}},i._IsEqual=0,i._IsDifferent=1,i._IsGreater=2,i._IsLesser=3,i}(e);t.ValueCondition=i;var r=function(t){function e(e,i){t.call(this,e),this.predicate=i}return o(e,t),e.prototype.isValid=function(){return this.predicate()},e}(e);t.PredicateCondition=r;var n=function(e){function i(t,i,r){e.call(this,t),this.value=r,this._target=i}return o(i,e),i.prototype.isValid=function(){return this._target.state===this.value},i.prototype.serialize=function(){return this._serialize({name:"StateCondition",properties:[t.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]})},i}(e);t.StateCondition=n}(r||(r={}));var r;!function(t){var e=function(){function e(t,e){this.triggerOptions=t,t.parameter?(this.trigger=t.trigger,this._triggerParameter=t.parameter):this.trigger=t,this._nextActiveAction=this,this._condition=e}return e.prototype._prepare=function(){},e.prototype.getTriggerParameter=function(){return this._triggerParameter},e.prototype._executeCurrent=function(t){if(this._nextActiveAction._condition){var e=this._nextActiveAction._condition,i=this._actionManager.getScene().getRenderId();if(e._evaluationId===i){if(!e._currentResult)return}else{if(e._evaluationId=i,!e.isValid())return void(e._currentResult=!1);e._currentResult=!0}}this._nextActiveAction.execute(t),this.skipToNextActiveAction()},e.prototype.execute=function(t){},e.prototype.skipToNextActiveAction=function(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this},e.prototype.then=function(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t},e.prototype._getProperty=function(t){return this._actionManager._getProperty(t)},e.prototype._getEffectiveTarget=function(t,e){return this._actionManager._getEffectiveTarget(t,e)},e.prototype.serialize=function(t){},e.prototype._serialize=function(t,e){var i={type:1,children:[],name:t.name,properties:t.properties||[]};if(this._child&&this._child.serialize(i),this._condition){var r=this._condition.serialize();return r.children.push(i),e&&e.children.push(r),r}return e&&e.children.push(i),i},e._SerializeValueAsString=function(e){return"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof t.Vector2?e.x+", "+e.y:e instanceof t.Vector3?e.x+", "+e.y+", "+e.z:e instanceof t.Color3?e.r+", "+e.g+", "+e.b:e instanceof t.Color4?e.r+", "+e.g+", "+e.b+", "+e.a:e},e._GetTargetProperty=function(e){return{name:"target",targetType:e instanceof t.Mesh?"MeshProperties":e instanceof t.Light?"LightProperties":e instanceof t.Camera?"CameraProperties":"SceneProperties",value:e instanceof t.Scene?"Scene":e.name}},e}();t.Action=e}(r||(r={}));var r;!function(t){var e=function(){function t(t,e,i,r,n,s){this.source=t,this.pointerX=e,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=n,this.additionalData=s}return t.CreateNew=function(e,i,r){var n=e.getScene();return new t(e,n.pointerX,n.pointerY,n.meshUnderPointer,i,r)},t.CreateNewFromSprite=function(e,i,r,n){return new t(e,i.pointerX,i.pointerY,i.meshUnderPointer,r,n)},t.CreateNewFromScene=function(e,i){return new t(null,e.pointerX,e.pointerY,e.meshUnderPointer,i)},t.CreateNewFromPrimitive=function(e,i,r,n){return new t(e,i.x,i.y,null,r,n)},t}();t.ActionEvent=e;var i=function(){function e(t){this.actions=new Array,this.hoverCursor="",this._scene=t,t._actionManagers.push(this)}return Object.defineProperty(e,"NothingTrigger",{get:function(){return e._NothingTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnPickTrigger",{get:function(){return e._OnPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnLeftPickTrigger",{get:function(){return e._OnLeftPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnRightPickTrigger",{get:function(){return e._OnRightPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnCenterPickTrigger",{get:function(){return e._OnCenterPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnPickDownTrigger",{get:function(){return e._OnPickDownTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnPickUpTrigger",{get:function(){return e._OnPickUpTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnPickOutTrigger",{get:function(){return e._OnPickOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnLongPressTrigger",{get:function(){return e._OnLongPressTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnPointerOverTrigger",{get:function(){return e._OnPointerOverTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnPointerOutTrigger",{get:function(){return e._OnPointerOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnEveryFrameTrigger",{get:function(){return e._OnEveryFrameTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnIntersectionEnterTrigger",{get:function(){return e._OnIntersectionEnterTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnIntersectionExitTrigger",{get:function(){return e._OnIntersectionExitTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnKeyDownTrigger",{get:function(){return e._OnKeyDownTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(e,"OnKeyUpTrigger",{get:function(){return e._OnKeyUpTrigger},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){var t=this._scene._actionManagers.indexOf(this);t>-1&&this._scene._actionManagers.splice(t,1)},e.prototype.getScene=function(){return this._scene},e.prototype.hasSpecificTriggers=function(t){for(var e=0;e<this.actions.length;e++){var i=this.actions[e];if(t.indexOf(i.trigger)>-1)return!0}return!1},e.prototype.hasSpecificTrigger=function(t){for(var e=0;e<this.actions.length;e++){if(this.actions[e].trigger===t)return!0}return!1},Object.defineProperty(e.prototype,"hasPointerTriggers",{get:function(){for(var t=0;t<this.actions.length;t++){var i=this.actions[t];if(i.trigger>=e._OnPickTrigger&&i.trigger<=e._OnPointerOutTrigger)return!0}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasPickTriggers",{get:function(){for(var t=0;t<this.actions.length;t++){var i=this.actions[t];if(i.trigger>=e._OnPickTrigger&&i.trigger<=e._OnPickUpTrigger)return!0}return!1},enumerable:!0,configurable:!0}),e.prototype.registerAction=function(i){return i.trigger===e.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(t.Tools.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(i),i._actionManager=this,i._prepare(),i)},e.prototype.processTrigger=function(t,i){for(var r=0;r<this.actions.length;r++){var n=this.actions[r];if(n.trigger===t){if(t===e.OnKeyUpTrigger||t===e.OnKeyDownTrigger){var s=n.getTriggerParameter();if(s){var o=i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode;if(String.fromCharCode(o).toLowerCase()!==s.toLowerCase())continue}}n._executeCurrent(i)}}},e.prototype._getEffectiveTarget=function(t,e){for(var i=e.split("."),r=0;r<i.length-1;r++)t=t[i[r]];return t},e.prototype._getProperty=function(t){var e=t.split(".");return e[e.length-1]},e.prototype.serialize=function(i){for(var r={children:[],name:i,type:3,properties:[]},n=0;n<this.actions.length;n++){var s={type:0,children:[],name:e.GetTriggerName(this.actions[n].trigger),properties:[]},o=this.actions[n].triggerOptions;if(o&&"number"!=typeof o)if(o.parameter instanceof t.Node)s.properties.push(t.Action._GetTargetProperty(o.parameter));else{var a={};t.Tools.DeepCopy(o.parameter,a,["mesh"]),o.parameter.mesh&&(a._meshId=o.parameter.mesh.id),s.properties.push({name:"parameter",targetType:null,value:a})}this.actions[n].serialize(s),r.children.push(s)}return r},e.Parse=function(i,r,n){var s=new t.ActionManager(n);null===r?n.actionManager=s:r.actionManager=s;for(var o=function(e,i){var r=Object.create(t[e].prototype);return r.constructor.apply(r,i),r},a=function(e,i,r,n){if(null===n){var s=parseFloat(i);return"true"===i||"false"===i?"true"===i:isNaN(s)?i:s}for(var o=n.split("."),a=i.split(","),h=0;h<o.length;h++)r=r[o[h]];if("boolean"==typeof r)return"true"===a[0];if("string"==typeof r)return a[0];for(var l=new Array,h=0;h<a.length;h++)l.push(parseFloat(a[h]));return r instanceof t.Vector3?t.Vector3.FromArray(l):r instanceof t.Vector4?t.Vector4.FromArray(l):r instanceof t.Color3?t.Color3.FromArray(l):r instanceof t.Color4?t.Color4.FromArray(l):parseFloat(a[0])},h=function i(r,h,l,c,u){if(void 0===u&&(u=null),!r.detached){var p=new Array,d=null,f=null,m=r.combine&&r.combine.length>0;if(2===r.type?p.push(s):p.push(h),m){for(var _=new Array,g=0;g<r.combine.length;g++)i(r.combine[g],e.NothingTrigger,l,c,_);p.push(_)}else for(var y=0;y<r.properties.length;y++){var v=r.properties[y].value,x=r.properties[y].name,b=r.properties[y].targetType;"target"===x?v=d=null!==b&&"SceneProperties"===b?n:n.getNodeByName(v):"parent"===x?v=n.getNodeByName(v):"sound"===x?v=n.getSoundByName(v):"propertyPath"!==x?v=2===r.type&&"operator"===x?t.ValueCondition[v]:a(x,v,d,"value"===x?f:null):f=v,p.push(v)}if(null===u?p.push(l):p.push(null),"InterpolateValueAction"===r.name){var P=p[p.length-2];p[p.length-1]=P,p[p.length-2]=l}var T=o(r.name,p);if(T instanceof t.Condition&&null!==l){var S=new t.DoNothingAction(h,l);c?c.then(S):s.registerAction(S),c=S}null===u?T instanceof t.Condition?(l=T,T=c):(l=null,c?c.then(T):s.registerAction(T)):u.push(T);for(var y=0;y<r.children.length;y++)i(r.children[y],h,l,T,null)}},l=0;l<i.children.length;l++){var c,u=i.children[l];if(u.properties.length>0){var p=u.properties[0].value,d=null===u.properties[0].targetType?p:n.getMeshByName(p);d._meshId&&(d.mesh=n.getMeshByID(d._meshId)),c={trigger:t.ActionManager[u.name],parameter:d}}else c=t.ActionManager[u.name];for(var f=0;f<u.children.length;f++)u.detached||h(u.children[f],c,null,null)}},e.GetTriggerName=function(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}},e._NothingTrigger=0,e._OnPickTrigger=1,e._OnLeftPickTrigger=2,e._OnRightPickTrigger=3,e._OnCenterPickTrigger=4,e._OnPickDownTrigger=5,e._OnPickUpTrigger=6,e._OnLongPressTrigger=7,e._OnPointerOverTrigger=8,e._OnPointerOutTrigger=9,e._OnEveryFrameTrigger=10,e._OnIntersectionEnterTrigger=11,e._OnIntersectionExitTrigger=12,e._OnKeyDownTrigger=13,e._OnKeyUpTrigger=14,e._OnPickOutTrigger=15,e.DragMovementThreshold=10,e.LongPressDelay=500,e}();t.ActionManager=i}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r,n,s,o,a,h){void 0===s&&(s=1e3),e.call(this,t,o),this.propertyPath=r,this.value=n,this.duration=s,this.stopOtherAnimations=a,this.onInterpolationDone=h,this._target=this._effectiveTarget=i}return o(i,e),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){var e,i=this._actionManager.getScene(),r=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];if("number"==typeof this.value)e=t.Animation.ANIMATIONTYPE_FLOAT;else if(this.value instanceof t.Color3)e=t.Animation.ANIMATIONTYPE_COLOR3;else if(this.value instanceof t.Vector3)e=t.Animation.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof t.Matrix)e=t.Animation.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof t.Quaternion))return void t.Tools.Warn("InterpolateValueAction: Unsupported type ("+n(this.value)+")");e=t.Animation.ANIMATIONTYPE_QUATERNION}var s=new t.Animation("InterpolateValueAction",this._property,1e3/this.duration*100,e,t.Animation.ANIMATIONLOOPMODE_CONSTANT);s.setKeys(r),this.stopOtherAnimations&&i.stopAnimation(this._effectiveTarget),i.beginDirectAnimation(this._effectiveTarget,[s],0,100,!1,1,this.onInterpolationDone)},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"InterpolateValueAction",properties:[t.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:t.Action._SerializeValueAsString(this.value)},{name:"duration",value:t.Action._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:t.Action._SerializeValueAsString(this.stopOtherAnimations)||!1}]},i)},i}(t.Action);t.InterpolateValueAction=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i,r,n){e.call(this,t,n),this.propertyPath=r,this._target=this._effectiveTarget=i}return o(i,e),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"SwitchBooleanAction",properties:[t.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},i)},i}(t.Action);t.SwitchBooleanAction=e;var i=function(e){function i(t,i,r,n){e.call(this,t,n),this.value=r,this._target=i}return o(i,e),i.prototype.execute=function(){this._target.state=this.value},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"SetStateAction",properties:[t.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]},i)},i}(t.Action);t.SetStateAction=i;var r=function(e){function i(t,i,r,n,s){e.call(this,t,s),this.propertyPath=r,this.value=n,this._target=this._effectiveTarget=i}return o(i,e),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"SetValueAction",properties:[t.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:t.Action._SerializeValueAsString(this.value)}]},i)},i}(t.Action);t.SetValueAction=r;var n=function(e){function i(t,i,r,n,s){e.call(this,t,s),this.propertyPath=r,this.value=n,this._target=this._effectiveTarget=i}return o(i,e),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&t.Tools.Warn("Warning: IncrementValueAction can only be used with number values")},i.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"IncrementValueAction",properties:[t.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:t.Action._SerializeValueAsString(this.value)}]},i)},i}(t.Action);t.IncrementValueAction=n;var s=function(e){function i(t,i,r,n,s,o){e.call(this,t,o),this.from=r,this.to=n,this.loop=s,this._target=i}return o(i,e),i.prototype._prepare=function(){},i.prototype.execute=function(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"PlayAnimationAction",properties:[t.Action._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:t.Action._SerializeValueAsString(this.loop)||!1}]},i)},i}(t.Action);t.PlayAnimationAction=s;var a=function(e){function i(t,i,r){e.call(this,t,r),this._target=i}return o(i,e),i.prototype._prepare=function(){},i.prototype.execute=function(){this._actionManager.getScene().stopAnimation(this._target)},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"StopAnimationAction",properties:[t.Action._GetTargetProperty(this._target)]},i)},i}(t.Action);t.StopAnimationAction=a;var h=function(e){function i(i,r){void 0===i&&(i=t.ActionManager.NothingTrigger),e.call(this,i,r)}return o(i,e),i.prototype.execute=function(){},i.prototype.serialize=function(t){return e.prototype._serialize.call(this,{name:"DoNothingAction",properties:[]},t)},i}(t.Action);t.DoNothingAction=h;var l=function(t){function e(e,i,r){t.call(this,e,r),this.children=i}return o(e,t),e.prototype._prepare=function(){for(var t=0;t<this.children.length;t++)this.children[t]._actionManager=this._actionManager,this.children[t]._prepare()},e.prototype.execute=function(t){for(var e=0;e<this.children.length;e++)this.children[e].execute(t)},e.prototype.serialize=function(e){for(var i=t.prototype._serialize.call(this,{name:"CombineAction",properties:[],combine:[]},e),r=0;r<this.children.length;r++)i.combine.push(this.children[r].serialize(null));return i},e}(t.Action);t.CombineAction=l;var c=function(t){function e(e,i,r){t.call(this,e,r),this.func=i}return o(e,t),e.prototype.execute=function(t){this.func(t)},e}(t.Action);t.ExecuteCodeAction=c;var u=function(e){function i(t,i,r,n){e.call(this,t,n),this._target=i,this._parent=r}return o(i,e),i.prototype._prepare=function(){},i.prototype.execute=function(){if(this._target.parent!==this._parent){var e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=t.Vector3.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}},i.prototype.serialize=function(i){return e.prototype._serialize.call(this,{name:"SetParentAction",properties:[t.Action._GetTargetProperty(this._target),t.Action._GetTargetProperty(this._parent)]},i)},i}(t.Action);t.SetParentAction=u;var p=function(t){function e(e,i,r){t.call(this,e,r),this._sound=i}return o(e,t),e.prototype._prepare=function(){},e.prototype.execute=function(){void 0!==this._sound&&this._sound.play()},e.prototype.serialize=function(e){return t.prototype._serialize.call(this,{name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)},e}(t.Action);t.PlaySoundAction=p;var d=function(t){function e(e,i,r){t.call(this,e,r),this._sound=i}return o(e,t),e.prototype._prepare=function(){},e.prototype.execute=function(){void 0!==this._sound&&this._sound.stop()},e.prototype.serialize=function(e){return t.prototype._serialize.call(this,{name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)},e}(t.Action);t.StopSoundAction=d}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s){this.delayLoadState=t.Engine.DELAYLOADSTATE_NONE,this._totalVertices=0,this._isDisposed=!1,this.id=e,this._engine=i.getEngine(),this._meshes=[],this._scene=i,this._vertexBuffers={},this._indices=[],r?this.setAllVerticesData(r,n):(this._totalVertices=0,this._indices=[]),s&&(s instanceof t.LinesMesh&&(this.boundingBias=new t.Vector2(0,s.intersectionThreshold),this.updateExtend()),this.applyToMesh(s),s.computeWorldMatrix(!0))}return Object.defineProperty(e.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(t){this._boundingBias&&this._boundingBias.equals(t)||(this._boundingBias=t.clone(),this.updateBoundingInfo(!0,null))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"extend",{get:function(){return this._extend},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getEngine=function(){return this._engine},e.prototype.isReady=function(){return this.delayLoadState===t.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===t.Engine.DELAYLOADSTATE_NONE},Object.defineProperty(e.prototype,"doNotSerialize",{get:function(){for(var t=0;t<this._meshes.length;t++)if(!this._meshes[t].doNotSerialize)return!1;return!0},enumerable:!0,configurable:!0}),e.prototype.setAllVerticesData=function(t,e){t.applyToGeometry(this,e),this.notifyUpdate()},e.prototype.setVerticesData=function(e,i,r,n){var s=new t.VertexBuffer(this._engine,i,e,r,0===this._meshes.length,n);this.setVerticesBuffer(s)},e.prototype.setVerticesBuffer=function(e){var i=e.getKind();if(this._vertexBuffers[i]&&this._vertexBuffers[i].dispose(),this._vertexBuffers[i]=e,i===t.VertexBuffer.PositionKind){var r=e.getData(),n=e.getStrideSize();this._totalVertices=r.length/n,this.updateExtend(r,n);for(var s=this._meshes,o=s.length,a=0;a<o;a++){var h=s[a];h._resetPointsArrayCache(),h._boundingInfo=new t.BoundingInfo(this._extend.minimum,this._extend.maximum),h._createGlobalSubMesh(),h.computeWorldMatrix(!0)}}this.notifyUpdate(i)},e.prototype.updateVerticesDataDirectly=function(t,e,i){var r=this.getVertexBuffer(t);r&&(r.updateDirectly(e,i),this.notifyUpdate(t))},e.prototype.updateVerticesData=function(e,i,r){var n=this.getVertexBuffer(e);if(n){if(n.update(i),e===t.VertexBuffer.PositionKind){var s=n.getStrideSize();this._totalVertices=i.length/s,this.updateBoundingInfo(r,i)}this.notifyUpdate(e)}},e.prototype.updateBoundingInfo=function(e,i){e&&this.updateExtend(i);for(var r=this._meshes,n=r.length,s=0;s<n;s++){var o=r[s];if(o._resetPointsArrayCache(),e){o._boundingInfo=new t.BoundingInfo(this._extend.minimum,this._extend.maximum);for(var a=0;a<o.subMeshes.length;a++){o.subMeshes[a].refreshBoundingInfo()}}}},e.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},e.prototype.getVerticesData=function(t,e){var i=this.getVertexBuffer(t);if(!i)return null;var r=i.getData();if(e&&1!==this._meshes.length){for(var n=r.length,s=[],o=0;o<n;o++)s.push(r[o]);return s}return r},e.prototype.getVertexBuffer=function(t){return this.isReady()?this._vertexBuffers[t]:null},e.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},e.prototype.isVerticesDataPresent=function(t){return this._vertexBuffers?void 0!==this._vertexBuffers[t]:!!this._delayInfo&&this._delayInfo.indexOf(t)!==-1},e.prototype.getVerticesDataKinds=function(){var t,e=[];if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e},e.prototype.setIndices=function(t,e){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=t,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),void 0!==e&&(this._totalVertices=e);for(var i=this._meshes,r=i.length,n=0;n<r;n++)i[n]._createGlobalSubMesh();this.notifyUpdate()},e.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},e.prototype.getIndices=function(t){if(!this.isReady())return null;var e=this._indices;if(t&&1!==this._meshes.length){for(var i=e.length,r=[],n=0;n<i;n++)r.push(e[n]);return r}return e},e.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},e.prototype.releaseForMesh=function(t,e){var i=this._meshes,r=i.indexOf(t);if(r!==-1){for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),i.splice(r,1),t._geometry=null,0===i.length&&e&&this.dispose()}},e.prototype.applyToMesh=function(t){if(t._geometry!==this){var e=t._geometry;e&&e.releaseForMesh(t);var i=this._meshes;t._geometry=this,this._scene.pushGeometry(this),i.push(t),this.isReady()?this._applyToMesh(t):t._boundingInfo=this._boundingInfo}},e.prototype.updateExtend=function(e,i){void 0===e&&(e=null),e||(e=this._vertexBuffers[t.VertexBuffer.PositionKind].getData()),this._extend=t.Tools.ExtractMinAndMax(e,0,this._totalVertices,this.boundingBias,i)},e.prototype._applyToMesh=function(e){var i=this._meshes.length;for(var r in this._vertexBuffers)1===i&&this._vertexBuffers[r].create(),this._vertexBuffers[r].getBuffer().references=i,r===t.VertexBuffer.PositionKind&&(e._resetPointsArrayCache(),this._extend||this.updateExtend(this._vertexBuffers[r].getData()),e._boundingInfo=new t.BoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(),e._updateBoundingInfo());1===i&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),this._indexBuffer&&(this._indexBuffer.references=i)},e.prototype.notifyUpdate=function(t){this.onGeometryUpdated&&this.onGeometryUpdated(this,t)},e.prototype.load=function(e,i){if(this.delayLoadState!==t.Engine.DELAYLOADSTATE_LOADING){if(this.isReady())return void(i&&i());this.delayLoadState=t.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(e,i)}},e.prototype._queueLoad=function(e,i){var r=this;e._addPendingData(this),t.Tools.LoadFile(this.delayLoadingFile,function(n){r._delayLoadingFunction(JSON.parse(n),r),r.delayLoadState=t.Engine.DELAYLOADSTATE_LOADED,r._delayInfo=[],e._removePendingData(r);for(var s=r._meshes,o=s.length,a=0;a<o;a++)r._applyToMesh(s[a]);i&&i()},function(){},e.database)},e.prototype.toLeftHanded=function(){var e=this.getIndices(!1);if(null!=e&&e.length>0){for(var i=0;i<e.length;i+=3){var r=e[i+0];e[i+0]=e[i+2],e[i+2]=r}this.setIndices(e)}var n=this.getVerticesData(t.VertexBuffer.PositionKind,!1);if(null!=n&&n.length>0){for(var i=0;i<n.length;i+=3)n[i+2]=-n[i+2];this.setVerticesData(t.VertexBuffer.PositionKind,n,!1)}var s=this.getVerticesData(t.VertexBuffer.NormalKind,!1);if(null!=s&&s.length>0){for(var i=0;i<s.length;i+=3)s[i+2]=-s[i+2];this.setVerticesData(t.VertexBuffer.NormalKind,s,!1)}},e.prototype.isDisposed=function(){return this._isDisposed},e.prototype.dispose=function(){var e,i=this._meshes,r=i.length;for(e=0;e<r;e++)this.releaseForMesh(i[e]);this._meshes=[];for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=t.Engine.DELAYLOADSTATE_NONE,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._isDisposed=!0},e.prototype.copy=function(i){var r=new t.VertexData;r.indices=[];for(var n=this.getIndices(),s=0;s<n.length;s++)r.indices.push(n[s]);var o,a=!1,h=!1;for(o in this._vertexBuffers){var l=this.getVerticesData(o);l instanceof Float32Array?r.set(new Float32Array(l),o):r.set(l.slice(0),o),h||(a=this.getVertexBuffer(o).isUpdatable(),h=!a)}var c=new e(i,this._scene,r,a,null);c.delayLoadState=this.delayLoadState,c.delayLoadingFile=this.delayLoadingFile,c._delayLoadingFunction=this._delayLoadingFunction;for(o in this._delayInfo)c._delayInfo=c._delayInfo||[],c._delayInfo.push(o);return c._boundingInfo=new t.BoundingInfo(this._extend.minimum,this._extend.maximum),c},e.prototype.serialize=function(){var e={};return e.id=this.id,t.Tags.HasTags(this)&&(e.tags=t.Tags.GetTags(this)),e},e.prototype.serializeVerticeData=function(){var e=this.serialize();return this.isVerticesDataPresent(t.VertexBuffer.PositionKind)&&(e.positions=this.getVerticesData(t.VertexBuffer.PositionKind)),this.isVerticesDataPresent(t.VertexBuffer.NormalKind)&&(e.normals=this.getVerticesData(t.VertexBuffer.NormalKind)),this.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(e.uvs=this.getVerticesData(t.VertexBuffer.UVKind)),this.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(e.uv2s=this.getVerticesData(t.VertexBuffer.UV2Kind)),this.isVerticesDataPresent(t.VertexBuffer.UV3Kind)&&(e.uv3s=this.getVerticesData(t.VertexBuffer.UV3Kind)),this.isVerticesDataPresent(t.VertexBuffer.UV4Kind)&&(e.uv4s=this.getVerticesData(t.VertexBuffer.UV4Kind)),this.isVerticesDataPresent(t.VertexBuffer.UV5Kind)&&(e.uv5s=this.getVerticesData(t.VertexBuffer.UV5Kind)),this.isVerticesDataPresent(t.VertexBuffer.UV6Kind)&&(e.uv6s=this.getVerticesData(t.VertexBuffer.UV6Kind)),this.isVerticesDataPresent(t.VertexBuffer.ColorKind)&&(e.colors=this.getVerticesData(t.VertexBuffer.ColorKind)),this.isVerticesDataPresent(t.VertexBuffer.MatricesIndicesKind)&&(e.matricesIndices=this.getVerticesData(t.VertexBuffer.MatricesIndicesKind),e.matricesIndices._isExpanded=!0),this.isVerticesDataPresent(t.VertexBuffer.MatricesWeightsKind)&&(e.matricesWeights=this.getVerticesData(t.VertexBuffer.MatricesWeightsKind)),e.indices=this.getIndices(),e},e.ExtractFromMesh=function(t,e){var i=t._geometry;return i?i.copy(e):null},e.RandomId=function(){return t.Tools.RandomId()},e.ImportGeometry=function(e,i){var r=i.getScene(),n=e.geometryId;if(n){var s=r.getGeometryByID(n);s&&s.applyToMesh(i)}else if(e instanceof ArrayBuffer){var o=i._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){var a=new Float32Array(e,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);i.setVerticesData(t.VertexBuffer.PositionKind,a,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){var h=new Float32Array(e,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);i.setVerticesData(t.VertexBuffer.NormalKind,h,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){var l=new Float32Array(e,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);i.setVerticesData(t.VertexBuffer.UVKind,l,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){var c=new Float32Array(e,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);i.setVerticesData(t.VertexBuffer.UV2Kind,c,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){var u=new Float32Array(e,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);i.setVerticesData(t.VertexBuffer.UV3Kind,u,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){var p=new Float32Array(e,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);i.setVerticesData(t.VertexBuffer.UV4Kind,p,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){var d=new Float32Array(e,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);i.setVerticesData(t.VertexBuffer.UV5Kind,d,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){var f=new Float32Array(e,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);i.setVerticesData(t.VertexBuffer.UV6Kind,f,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){var m=new Float32Array(e,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);i.setVerticesData(t.VertexBuffer.ColorKind,m,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){var _=new Int32Array(e,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count);i.setVerticesData(t.VertexBuffer.MatricesIndicesKind,_,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){var g=new Float32Array(e,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);i.setVerticesData(t.VertexBuffer.MatricesWeightsKind,g,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){var y=new Int32Array(e,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);i.setIndices(y)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){var v=new Int32Array(e,o.subMeshesAttrDesc.offset,5*o.subMeshesAttrDesc.count);i.subMeshes=[];for(var x=0;x<o.subMeshesAttrDesc.count;x++){var b=v[5*x+0],P=v[5*x+1],T=v[5*x+2],S=v[5*x+3],A=v[5*x+4];new t.SubMesh(b,P,T,S,A,i)}}}else if(e.positions&&e.normals&&e.indices){if(i.setVerticesData(t.VertexBuffer.PositionKind,e.positions,!1),i.setVerticesData(t.VertexBuffer.NormalKind,e.normals,!1),e.uvs&&i.setVerticesData(t.VertexBuffer.UVKind,e.uvs,!1),e.uvs2&&i.setVerticesData(t.VertexBuffer.UV2Kind,e.uvs2,!1),e.uvs3&&i.setVerticesData(t.VertexBuffer.UV3Kind,e.uvs3,!1),e.uvs4&&i.setVerticesData(t.VertexBuffer.UV4Kind,e.uvs4,!1),e.uvs5&&i.setVerticesData(t.VertexBuffer.UV5Kind,e.uvs5,!1),e.uvs6&&i.setVerticesData(t.VertexBuffer.UV6Kind,e.uvs6,!1),e.colors&&i.setVerticesData(t.VertexBuffer.ColorKind,t.Color4.CheckColors4(e.colors,e.positions.length/3),!1),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,i.setVerticesData(t.VertexBuffer.MatricesIndicesKind,e.matricesIndices,!1);else{for(var C=[],x=0;x<e.matricesIndices.length;x++){var E=e.matricesIndices[x];C.push(255&E),C.push((65280&E)>>8),C.push((16711680&E)>>16),C.push(E>>24)}i.setVerticesData(t.VertexBuffer.MatricesIndicesKind,C,!1)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,i.setVerticesData(t.VertexBuffer.MatricesIndicesExtraKind,e.matricesIndicesExtra,!1);else{for(var C=[],x=0;x<e.matricesIndicesExtra.length;x++){var E=e.matricesIndicesExtra[x];C.push(255&E),C.push((65280&E)>>8),C.push((16711680&E)>>16),C.push(E>>24)}i.setVerticesData(t.VertexBuffer.MatricesIndicesExtraKind,C,!1)}e.matricesWeights&&i.setVerticesData(t.VertexBuffer.MatricesWeightsKind,e.matricesWeights,!1),e.matricesWeightsExtra&&i.setVerticesData(t.VertexBuffer.MatricesWeightsExtraKind,e.matricesWeightsExtra,!1),i.setIndices(e.indices)}if(e.subMeshes){i.subMeshes=[];for(var M=0;M<e.subMeshes.length;M++){var D=e.subMeshes[M];new t.SubMesh(D.materialIndex,D.verticesStart,D.verticesCount,D.indexStart,D.indexCount,i)}}i._shouldGenerateFlatShading&&(i.convertToFlatShadedMesh(),delete i._shouldGenerateFlatShading),i.computeWorldMatrix(!0),r._selectionOctree&&r._selectionOctree.addMesh(i)},e.Parse=function(i,r,n){if(r.getGeometryByID(i.id))return null;var s=new e(i.id,r);return t.Tags.AddTagsTo(s,i.tags),i.delayLoadingFile?(s.delayLoadState=t.Engine.DELAYLOADSTATE_NOTLOADED,s.delayLoadingFile=n+i.delayLoadingFile,s._boundingInfo=new t.BoundingInfo(t.Vector3.FromArray(i.boundingBoxMinimum),t.Vector3.FromArray(i.boundingBoxMaximum)),s._delayInfo=[],i.hasUVs&&s._delayInfo.push(t.VertexBuffer.UVKind),i.hasUVs2&&s._delayInfo.push(t.VertexBuffer.UV2Kind),i.hasUVs3&&s._delayInfo.push(t.VertexBuffer.UV3Kind),i.hasUVs4&&s._delayInfo.push(t.VertexBuffer.UV4Kind),i.hasUVs5&&s._delayInfo.push(t.VertexBuffer.UV5Kind),i.hasUVs6&&s._delayInfo.push(t.VertexBuffer.UV6Kind),i.hasColors&&s._delayInfo.push(t.VertexBuffer.ColorKind),i.hasMatricesIndices&&s._delayInfo.push(t.VertexBuffer.MatricesIndicesKind),i.hasMatricesWeights&&s._delayInfo.push(t.VertexBuffer.MatricesWeightsKind),s._delayLoadingFunction=t.VertexData.ImportVertexData):t.VertexData.ImportVertexData(i,s),r.pushGeometry(s,!0),s},e}();t.Geometry=e;var e;!function(e){!function(i){var r=function(t){function e(e,i,r,n){t.call(this,e,i,null,!1,n),this._canBeRegenerated=r,this._beingRegenerated=!0,this.regenerate(),this._beingRegenerated=!1}return o(e,t),e.prototype.canBeRegenerated=function(){return this._canBeRegenerated},e.prototype.regenerate=function(){this._canBeRegenerated&&(this._beingRegenerated=!0,this.setAllVerticesData(this._regenerateVertexData(),!1),this._beingRegenerated=!1)},e.prototype.asNewGeometry=function(e){return t.prototype.copy.call(this,e)},e.prototype.setAllVerticesData=function(e,i){this._beingRegenerated&&t.prototype.setAllVerticesData.call(this,e,!1)},e.prototype.setVerticesData=function(e,i,r){this._beingRegenerated&&t.prototype.setVerticesData.call(this,e,i,!1)},e.prototype._regenerateVertexData=function(){throw new Error("Abstract method")},e.prototype.copy=function(t){throw new Error("Must be overriden in sub-classes.")},e.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.canBeRegenerated=this.canBeRegenerated(),e},e}(e);i._Primitive=r;var n=function(e){function i(i,r,n,s,o,a,h,l,c){void 0===c&&(c=t.Mesh.DEFAULTSIDE),e.call(this,i,r,h,l),this.pathArray=n,this.closeArray=s,this.closePath=o,this.offset=a,this.side=c}return o(i,e),i.prototype._regenerateVertexData=function(){return t.VertexData.CreateRibbon({pathArray:this.pathArray,closeArray:this.closeArray,closePath:this.closePath,offset:this.offset,sideOrientation:this.side})},i.prototype.copy=function(t){return new i(t,this.getScene(),this.pathArray,this.closeArray,this.closePath,this.offset,this.canBeRegenerated(),null,this.side)},i}(r);i.Ribbon=n;var s=function(i){function r(e,r,n,s,o,a){void 0===a&&(a=t.Mesh.DEFAULTSIDE),i.call(this,e,r,s,o),this.size=n,this.side=a}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreateBox({size:this.size,sideOrientation:this.side})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.size=this.size,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.Box(i.id,r,i.size,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.Box=s;var a=function(i){function r(e,r,n,s,o,a,h){void 0===h&&(h=t.Mesh.DEFAULTSIDE),i.call(this,e,r,o,a),this.segments=n,this.diameter=s,this.side=h}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreateSphere({segments:this.segments,diameter:this.diameter,sideOrientation:this.side})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.segments=this.segments,t.diameter=this.diameter,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.Sphere(i.id,r,i.segments,i.diameter,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.Sphere=a;var h=function(e){function i(i,r,n,s,o,a,h){void 0===h&&(h=t.Mesh.DEFAULTSIDE),e.call(this,i,r,o,a),this.radius=n,this.tessellation=s,this.side=h}return o(i,e),i.prototype._regenerateVertexData=function(){return t.VertexData.CreateDisc({radius:this.radius,tessellation:this.tessellation,sideOrientation:this.side})},i.prototype.copy=function(t){return new i(t,this.getScene(),this.radius,this.tessellation,this.canBeRegenerated(),null,this.side)},i}(r);i.Disc=h;var l=function(i){function r(e,r,n,s,o,a,h,l,c,u){void 0===h&&(h=1),void 0===u&&(u=t.Mesh.DEFAULTSIDE),i.call(this,e,r,l,c),this.height=n,this.diameterTop=s,this.diameterBottom=o,this.tessellation=a,this.subdivisions=h,this.side=u}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreateCylinder({height:this.height,diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,tessellation:this.tessellation,subdivisions:this.subdivisions,sideOrientation:this.side})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.height=this.height,t.diameterTop=this.diameterTop,t.diameterBottom=this.diameterBottom,t.tessellation=this.tessellation,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.Cylinder(i.id,r,i.height,i.diameterTop,i.diameterBottom,i.tessellation,i.subdivisions,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.Cylinder=l;var c=function(i){function r(e,r,n,s,o,a,h,l){void 0===l&&(l=t.Mesh.DEFAULTSIDE),i.call(this,e,r,a,h),this.diameter=n,this.thickness=s,this.tessellation=o,this.side=l}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreateTorus({diameter:this.diameter,thickness:this.thickness,tessellation:this.tessellation,sideOrientation:this.side})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.diameter=this.diameter,t.thickness=this.thickness,t.tessellation=this.tessellation,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.Torus(i.id,r,i.diameter,i.thickness,i.tessellation,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.Torus=c;var u=function(i){function r(t,e,r,n,s,o,a){i.call(this,t,e,o,a),this.width=r,this.height=n,this.subdivisions=s}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreateGround({width:this.width,height:this.height,subdivisions:this.subdivisions})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.width=this.width,t.height=this.height,t.subdivisions=this.subdivisions,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.Ground(i.id,r,i.width,i.height,i.subdivisions,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.Ground=u;var p=function(e){function i(t,i,r,n,s,o,a,h,l,c){e.call(this,t,i,l,c),this.xmin=r,this.zmin=n,this.xmax=s,this.zmax=o,this.subdivisions=a,this.precision=h}return o(i,e),i.prototype._regenerateVertexData=function(){return t.VertexData.CreateTiledGround({xmin:this.xmin,zmin:this.zmin,xmax:this.xmax,zmax:this.zmax,subdivisions:this.subdivisions,precision:this.precision})},i.prototype.copy=function(t){return new i(t,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)},i}(r);i.TiledGround=p;var d=function(i){function r(e,r,n,s,o,a){void 0===a&&(a=t.Mesh.DEFAULTSIDE),i.call(this,e,r,s,o),this.size=n,this.side=a}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreatePlane({size:this.size,sideOrientation:this.side})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.size=this.size,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.Plane(i.id,r,i.size,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.Plane=d;var f=function(i){function r(e,r,n,s,o,a,h,l,c,u,p){void 0===p&&(p=t.Mesh.DEFAULTSIDE),i.call(this,e,r,c,u),this.radius=n,this.tube=s,this.radialSegments=o,this.tubularSegments=a,this.p=h,this.q=l,this.side=p}return o(r,i),r.prototype._regenerateVertexData=function(){return t.VertexData.CreateTorusKnot({radius:this.radius,tube:this.tube,radialSegments:this.radialSegments,tubularSegments:this.tubularSegments,p:this.p,q:this.q,sideOrientation:this.side})},r.prototype.copy=function(t){return new r(t,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var t=i.prototype.serialize.call(this);return t.radius=this.radius,t.tube=this.tube,t.radialSegments=this.radialSegments,t.tubularSegments=this.tubularSegments,t.p=this.p,t.q=this.q,t},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var n=new e.Primitives.TorusKnot(i.id,r,i.radius,i.tube,i.radialSegments,i.tubularSegments,i.p,i.q,i.canBeRegenerated,null);return t.Tags.AddTagsTo(n,i.tags),r.pushGeometry(n,!0),n},r}(r);i.TorusKnot=f}(e.Primitives||(e.Primitives={}))}(e=t.Geometry||(t.Geometry={}))}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r){e.call(this,i,r),this.generateOctree=!1,this._worldInverse=new t.Matrix}return o(i,e),Object.defineProperty(i.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:!0,configurable:!0}),i.prototype.optimize=function(t,e){void 0===e&&(e=32),this._subdivisionsX=t,this._subdivisionsY=t,this.subdivide(t),this.createOrUpdateSubmeshesOctree(e)},i.prototype.getHeightAtCoordinates=function(t,e){if(t-=this.position.x,e-=this.position.z,t/=this.scaling.x,e/=this.scaling.z,t<this._minX||t>this._maxX||e<this._minZ||e>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var i=this._getFacetAt(t,e);return-(i.x*t+i.z*e+i.w)/i.y*this.scaling.y+this.position.y},i.prototype.getNormalAtCoordinates=function(e,i){var r=new t.Vector3(0,1,0);return this.getNormalAtCoordinatesToRef(e,i,r),r},i.prototype.getNormalAtCoordinatesToRef=function(t,e,i){if(t-=this.position.x,e-=this.position.z,t/=this.scaling.x,e/=this.scaling.z,!(t<this._minX||t>this._maxX||e<this._minZ||e>this._maxZ)){this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var r=this._getFacetAt(t,e);i.x=r.x,i.y=r.y,i.z=r.z}},i.prototype.updateCoordinateHeights=function(){this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads()},i.prototype._getFacetAt=function(t,e){var i=(this._subdivisionsX,this._subdivisionsY,Math.floor((t+this._maxX)*this._subdivisionsX/this._width)),r=Math.floor(-(e+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),n=this._heightQuads[r*this._subdivisionsX+i];return e<n.slope.x*t+n.slope.y?n.facet1:n.facet2},i.prototype._initHeightQuads=function(){var e=this._subdivisionsX,i=this._subdivisionsY;this._heightQuads=new Array;for(var r=0;r<i;r++)for(var n=0;n<e;n++){var s={slope:t.Vector2.Zero(),facet1:new t.Vector4(0,0,0,0),facet2:new t.Vector4(0,0,0,0)};this._heightQuads[r*e+n]=s}},i.prototype._computeHeightQuads=function(){for(var e=this.getVerticesData(t.VertexBuffer.PositionKind),i=t.Tmp.Vector3[3],r=t.Tmp.Vector3[2],n=t.Tmp.Vector3[1],s=t.Tmp.Vector3[0],o=t.Tmp.Vector3[4],a=t.Tmp.Vector3[5],h=t.Tmp.Vector3[6],l=t.Tmp.Vector3[7],c=t.Tmp.Vector3[8],u=0,p=0,d=0,f=0,m=0,_=0,g=0,y=this._subdivisionsX,v=this._subdivisionsY,x=0;x<v;x++)for(var b=0;b<y;b++){u=3*b,p=x*(y+1)*3,d=(x+1)*(y+1)*3,i.x=e[p+u],i.y=e[p+u+1],i.z=e[p+u+2],r.x=e[p+u+3],r.y=e[p+u+4],r.z=e[p+u+5],n.x=e[d+u],n.y=e[d+u+1],n.z=e[d+u+2],s.x=e[d+u+3],s.y=e[d+u+4],s.z=e[d+u+5],f=(s.z-i.z)/(s.x-i.x),m=i.z-f*i.x,r.subtractToRef(i,o),n.subtractToRef(i,a),s.subtractToRef(i,h),t.Vector3.CrossToRef(h,a,l),t.Vector3.CrossToRef(o,h,c),l.normalize(),c.normalize(),_=-(l.x*i.x+l.y*i.y+l.z*i.z),g=-(c.x*r.x+c.y*r.y+c.z*r.z);var P=this._heightQuads[x*y+b];P.slope.copyFromFloats(f,m),P.facet1.copyFromFloats(l.x,l.y,l.z,_),P.facet2.copyFromFloats(c.x,c.y,c.z,g)}},i}(t.Mesh);t.GroundMesh=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){void 0===n&&(n=null),e.call(this,i,r,n,s,o),this.color=new t.Color3(1,1,1),this.alpha=1,this._positionBuffer={},s&&(this.color=s.color.clone(),this.alpha=s.alpha),this._intersectionThreshold=.1,this._colorShader=new t.ShaderMaterial("colorShader",r,"color",{attributes:[t.VertexBuffer.PositionKind],uniforms:["worldViewProjection","color"],needAlphaBlending:!0}),this._positionBuffer[t.VertexBuffer.PositionKind]=null}return o(i,e),Object.defineProperty(i.prototype,"intersectionThreshold",{get:function(){return this._intersectionThreshold},set:function(e){this._intersectionThreshold!==e&&(this._intersectionThreshold=e,this.geometry&&(this.geometry.boundingBias=new t.Vector2(0,e)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"material",{get:function(){return this._colorShader},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"checkCollisions",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.createInstance=function(e){return t.Tools.Log("LinesMeshes do not support createInstance."),null},i.prototype._bind=function(e,i,r){var n=this.getScene().getEngine();this._positionBuffer[t.VertexBuffer.PositionKind]=this._geometry.getVertexBuffer(t.VertexBuffer.PositionKind),n.bindBuffers(this._positionBuffer,this._geometry.getIndexBuffer(),this._colorShader.getEffect()),this._colorShader.setColor4("color",this.color.toColor4(this.alpha))},i.prototype._draw=function(t,e,i){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){this.getScene().getEngine().draw(!1,t.indexStart,t.indexCount)}},i.prototype.dispose=function(t){this._colorShader.dispose(),e.prototype.dispose.call(this,t)},i.prototype.clone=function(t,e,r){return new i(t,this.getScene(),e,this,r)},i}(t.Mesh);t.LinesMesh=e}(r||(r={}));var r;!function(t){var e=function(){function t(t,e,i){var r=this;void 0===e&&(e=""),void 0===i&&(i="black"),this._renderingCanvas=t,this._loadingText=e,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=function(){var t=r._renderingCanvas.getBoundingClientRect();r._loadingDiv.style.position="absolute",r._loadingDiv.style.left=t.left+"px",r._loadingDiv.style.top=t.top+"px",r._loadingDiv.style.width=t.width+"px",r._loadingDiv.style.height=t.height+"px"}}return t.prototype.displayLoadingUI=function(){var t=this;if(!this._loadingDiv){this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText;var e=new Image;e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuM4zml1AAAARbSURBVHhe7Z09aFNRFMc716kuLrq4FdyLq4Wi4CAoRQcR0UJBUBdRiuLSIYMo6CA4FF2sgw6CFAdFUOpSQYcWO4hD26UQCfXrIQrx/JJzw1OSWq3NPeL/B4Fy+0jg/HO+7j3vpUcI8b/Q39+/49ihfWdPHT94Yf/e3Se3bd263f8lus218TPn6vV6Ya8Wi/MzNRNmj18iusX9W1evmP1/EKNEIVG6CMbG6E3bt+fT++pHha8NoHdT72bLE8NDg7tGU64gLLndV4Wc4m8j/pS+vr4tGB/DT16v3Fyr8dvBe/jbit8BL0AES9LX1iPAz+BR/hFiLVCynj95dPzNy6fv3IZ/k4L3948Sq7FzYGBg4vLFGxitabuOFCbWNKGrMnbiUuo18KaV6tIHv6YtvL9/nOgE31jCktmrY7k6+/zhE4yP4Vf7hiNqh/BWWEl8mzDol4p22Lf7cIdvdUMEvv0Y2S9fE5S1hLzpqTsPkiep//gFGPnR3Yl7GL5p/xYFBrTwM+iXio3GqpwDGL5p/xYNIX7XG8Q6IJRgdIzf1KBBgafII7oMidhyQtVFaMA2Bt7il4huQRhaXphbcR2g4RXqBzKAGHiCCwGFVUAj/m/RTRDj29cvn10I0PZ3LghH5f4CL1EFlQmqqXK3jDDKFxmhQ3Yt6oQseUZGKmMnTpsOqc8o1F9kBOMjQlOLeqEeIyOc6JV6jYLJD/+XyIFvnzdgl9aXRQ5I2qZDK1SpospMqaoqON/wZZGDciLnMMiXRS7IF4hhqMTNTdk7CFu+LHLhR7BQqBvPDJUUQqCGvCMATHUgBmhWNgApmdOda9YpM+VwRYfuyyIXDK8hBlilNerLIheMZCKGwlUAyru6GlwOgPUbRxADdJ9FAChxXY864viyyEXqPxhc0M2TAfAbatSdRyHtXymhByEdRnE3ky+JnHAIhSA0h74kckETmHoQbSgGwJrCIRMEPSRIBCRIMAhZaYhaggQhJXUJEoRU9mofKwh+F22dLRRfEjlJM7w6KQwCoQpBOKTyJZETjmwRxKqtGV8SOSkNOGjKPQppBEgDDkFgpxdBVGkFgaYQQXRIFQSObk0P5ZFIpAZRHXsQ0r0hCluBWKkuvVbYCkQaCdL5ehBScudJP4yY+rLISdps1NBDEJKXMMmoSfggWC4ZQRR17oFYXph7hSiquIKQ+hJGTX1J5MYSPD/GVdNzsgLBwZVCVyAQAkF0ohiI/c1fS6tNXq9UfEnkhudmIQolsS+J3Hh/UtNDzQLhj42VKJFInqLwFYiUU5ToA+HdfI0JevUpQUAIn+vSz2lHIuUV/dJOIHhOY/IWVWGBIHQtzs88s9zyWBuTgcBLzGOmeNnfF/QslSDgMeQW85i3DOQxuipxAkCyZ8SIm4Omp+7MMlCB59j6sKZcMoM4iIEoeI2J9AKxrFobZx0v4vYInuHFS4J1GQRCAGaLEYQXfyMML5XSQgghhBBCCCH+cXp6vgNhKpSKX/XdOAAAAABJRU5ErkJggg==",e.style.position="absolute",e.style.left="50%",e.style.top="50%",e.style.marginLeft="-50px",e.style.marginTop="-50px",e.style.transition="transform 1.0s ease",e.style.webkitTransition="-webkit-transform 1.0s ease";var i=360,r=function(){i+=360,e.style.transform="rotateZ("+i+"deg)",e.style.webkitTransform="rotateZ("+i+"deg)"};e.addEventListener("transitionend",r),e.addEventListener("webkitTransitionEnd",r),this._loadingDiv.appendChild(e);var n=new Image;n.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuM4zml1AAAAYJSURBVHhe7Zy/qx1FFMff/2Av2Nvbi4WFiiAEY/OQ2IgQsbCJQoqkCAgpFLXyoZURLfwBIiIpgqZJoYQYlWelNsIrNOxDJcrzfHe+G97dnTl75u7euzv7zgcWHrlnZmfOmXPmzI/NjuM4juM4juM4juM4juM4juM4juM4juM45fPic08/uHf5/CvffH7lnT8PfrtxdHS0n3p+/fHGl5+89/prr5599iEWd8bg0rkXHoFyqehKnlxQpjYSDHTm9JMPsGrHylOPPXofvICKXMcIGtXdf/76AYbm6xyNW9e/eAtKC7rbKLXnvHHx5Sf4auc4Ek7OQkFU1Dap/vv37k/wSjblZANFiFIGzw98hhizwqBgs04mCBdQRNCHidoAEtY+lLIvtSdoGFeyql2ZH57HBH4sE7O+o/r9l+8/ZXUni68+2jsHBQQ9qNRGeP/tSxdSYQX/roUcpL4/f3vtM9TD+jTq92n1LQ7jxF1hhGPtwWL3gGccy8JuS1r8sVWBGXNVdSKMYjBGPUJjCzooiGuSpnwlnnOGP2dhHRSLNgpHp2oMKIriK8TmG4Qh/rwW8D6pps9b9im+LDDipXOqMVJrAngBfg9i98gevWKA+/nnCod3Dr5GfaHaDgidVym6HKRjGIkpqthcAVKGxNqBImbEo66kjCih8AOpNmkUmbMuUrR8kEqiU6FvHZLGAPJ71JCYSyhiBqmwFE2GoD6jLGIfDHtG6EzoU4dK21PCqIRMEF0FGRjFzGDtIkXVAdATvsqfT9CJ0JcOFdYiFIsiMlqYy1YOFpQo2OddqBtyEaq9y+efoVh5oPHoROjLKn0j3JIE5Ka8UqZRtGrMnneX6yVofOhDh94MSbznTcpqmDOt1vyQzOgaJAF4F3JBfIXesrNEGWWmjIX7UBZ6jRJbBMLg/DmJiKUGVHleIpnVNTa+jakzkAviJqLhi4MC9XQGBrZeKJZESSrKy7ik0VGFWhQBRDTHIACKQ5l9nAjy75gya4a2w+Jhs0FJdc0xX/GwUbAqFBkZi7QpJ2w16WUbjFyK9MJF3KaoEM74KhVtLrQOrsmRxkbdHEqmSC/c+EuGnIFkjW7Ih2Kr4CCMIvNG2hrrgLpCjiFloooYCjyYrzCRyvhyBthkIPuQtsZGdnbMTezyDiU71KTC5zr7aVsHbsz2tllrEkS5UHwU1tq1HbtPW4UbeB0O7xx8R5EsMJql+BheUmHjkNVmIRP7LutoM3+D4O4tG7vCkNO9ESZ4lL3J6rKRMPx4qKbD/A0icf8CG7tC7kTahnMTwleuYSrsS7GatRAvfZh1tTm5BmmQCdZ8a0Sefe28xUrRBkmFLKy8KTIKUDRX0Y1xagPgwbaIdeFnQULmKak3xvwNMkVGgok/N5XNoehJvejRlCDl9escI28dJU0tZ++nBTJE9mEF647x5Ehbo4s5hDOKFIU0PdofeA5F5k1q63zIWmQqNI/P3ZubjFTqKxQ3jyjHAOX0RdlgVO9hzRFpczRcjZ3Gbxxpc7Qj6+5pTYF2OFXawNI+yDGf1k2NcvOlzBQeDQ/t7zD7DsEDpJ2xATXaNtDWUS4IzP4DS2ljajAVu57SUkYw245ptxZxA5JiZaJ0DswudGn3kYUy54426EjoT4dZfYbccxC2nI92cDkZHQr96jD4AGkMDKeSy/COBsRe6VTSKFN6irLeaCh3IteQjt1E5+oudsG/b/2DfZ5AqsYo8vMDK9LB1HzSsLWvlGThdxXvC6+NsqyPPWP0pMINtbdsajfVeC6f/GZ+cdAofQoB1d+Hf9waY98I7+RXWab3Lt4zYkjHtTnlOLXHYMsCh1zWeQYehu1zfNPOOiys/d91LAKEBSgh6MJMbSA82AaHofDgAIwbgvVvlLNS11nModMm4UZergLHZBZrodmBuA3lBB1thdorSjkOmATMDwg/UBQVtglqQyx6fbEJ+H3IWIapjYAjAfeIgeCMHldueJvFaqDaAHhwf8qNsEEQ1iQbOoUUGIbCLRc8+Bvfp4jyd2FEijuO4ziO4ziO4ziO4ziO4ziO4ziO4ziOUzw7O/8D0P7rcZ/GEboAAAAASUVORK5CYII=",n.style.position="absolute",n.style.left="50%",n.style.top="50%",n.style.marginLeft="-50px",n.style.marginTop="-50px",this._loadingDiv.appendChild(n),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),setTimeout(function(){t._loadingDiv.style.opacity="1",e.style.transform="rotateZ(360deg)",e.style.webkitTransform="rotateZ(360deg)"},0)}},t.prototype.hideLoadingUI=function(){var t=this;if(this._loadingDiv){var e=function(){t._loadingDiv&&(document.body.removeChild(t._loadingDiv),window.removeEventListener("resize",t._resizeLoadingUI),t._loadingDiv=null)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",e)}},Object.defineProperty(t.prototype,"loadingUIText",{set:function(t){this._loadingText=t,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"loadingUIBackgroundColor",{get:function(){return this._loadingDivBackgroundColor},set:function(t){this._loadingDivBackgroundColor=t,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)},enumerable:!0,configurable:!0}),t}();t.DefaultLoadingScreen=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this._audioContext=null,this._audioContextInitialized=!1,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.unlocked=!1,this.isMP3supported=!1,this.isOGGsupported=!1,void 0===window.AudioContext&&void 0===window.webkitAudioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var t=document.createElement("audio");t&&t.canPlayType&&t.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")&&(this.isMP3supported=!0),t&&t.canPlayType&&t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0),/iPad|iPhone|iPod/.test(navigator.platform)?this._unlockiOSaudio():this.unlocked=!0}return Object.defineProperty(e.prototype,"audioContext",{get:function(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext},enumerable:!0,configurable:!0}),e.prototype._unlockiOSaudio=function(){var t=this,e=function e(){var i=t.audioContext.createBuffer(1,1,22050),r=t.audioContext.createBufferSource();r.buffer=i,r.connect(t.audioContext.destination),r.start(0),setTimeout(function(){r.playbackState!==r.PLAYING_STATE&&r.playbackState!==r.FINISHED_STATE||(t.unlocked=!0,window.removeEventListener("touchend",e,!1),t.onAudioUnlocked&&t.onAudioUnlocked())},0)};window.addEventListener("touchend",e,!1)},e.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext=new AudioContext,this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this._audioContext.destination),this._audioContextInitialized=!0)}catch(e){this.canUseWebAudio=!1,t.Tools.Error("Web Audio: "+e.message)}},e.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1},e.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},e.prototype.setGlobalVolume=function(t){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=t)},e.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser=t,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},e}();t.AudioEngine=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s){var o=this;if(this.autoplay=!1,this.loop=!1,this.useCustomAttenuation=!1,this.spatialSound=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=t.Vector3.Zero(),this._localDirection=new t.Vector3(1,0,0),this._volume=1,this._isLoaded=!1,this._isReadyToPlay=!1,this.isPlaying=!1,this.isPaused=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,this._scene=r,this._readyToPlayCallback=n,this._customAttenuationFunction=function(t,e,i,r,n){return e<i?t*(1-e/i):0},s&&(this.autoplay=s.autoplay||!1,this.loop=s.loop||!1,void 0!==s.volume&&(this._volume=s.volume),this.spatialSound=s.spatialSound||!1,this.maxDistance=s.maxDistance||100,this.useCustomAttenuation=s.useCustomAttenuation||!1,this.rolloffFactor=s.rolloffFactor||1,this.refDistance=s.refDistance||1,this.distanceModel=s.distanceModel||"linear",this._playbackRate=s.playbackRate||1,this._streaming=s.streaming||!1),t.Engine.audioEngine.canUseWebAudio){this._soundGain=t.Engine.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._ouputAudioNode=this._soundGain,this.spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.AddSound(this);var a=!0;if(i){"string"==typeof i&&(this._urlType="String"),Array.isArray(i)&&(this._urlType="Array"),i instanceof ArrayBuffer&&(this._urlType="ArrayBuffer");var h=[],l=!1;switch(this._urlType){case"ArrayBuffer":i.byteLength>0&&(l=!0,this._soundLoaded(i));break;case"String":h.push(i);case"Array":0===h.length&&(h=i);for(var c=0;c<h.length;c++){var u=h[c];if(u.indexOf(".mp3",u.length-4)!==-1&&t.Engine.audioEngine.isMP3supported&&(l=!0),u.indexOf(".ogg",u.length-4)!==-1&&t.Engine.audioEngine.isOGGsupported&&(l=!0),u.indexOf(".wav",u.length-4)!==-1&&(l=!0),l){this._streaming?(this._htmlAudioElement=new Audio(u),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,this._htmlAudioElement.crossOrigin="anonymous",this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",function(){o._isReadyToPlay=!0,o.autoplay&&o.play(),o._readyToPlayCallback&&o._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement)):t.Tools.LoadFile(u,function(t){o._soundLoaded(t)},null,this._scene.database,!0);break}}break;default:a=!1}a?l||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){o._readyToPlayCallback()},1e3)):t.Tools.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}}else this._scene.mainSoundTrack.AddSound(this),t.Engine.audioEngine.WarnedWebAudioUnsupported||(t.Tools.Error("Web Audio is not supported by your browser."),t.Engine.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){o._readyToPlayCallback()},1e3)}return e.prototype.dispose=function(){t.Engine.audioEngine.canUseWebAudio&&this._isReadyToPlay&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.RemoveSound(this):this._scene.soundTracks[this.soundTrackId].RemoveSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._connectedMesh&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedMesh=null))},e.prototype._soundLoaded=function(e){var i=this;this._isLoaded=!0,t.Engine.audioEngine.audioContext.decodeAudioData(e,function(t){i._audioBuffer=t,i._isReadyToPlay=!0,i.autoplay&&i.play(),i._readyToPlayCallback&&i._readyToPlayCallback()},function(e){t.Tools.Error("Error while decoding audio data for: "+i.name+" / Error: "+e)})},e.prototype.setAudioBuffer=function(e){t.Engine.audioEngine.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)},e.prototype.updateOptions=function(t){t&&(this.loop=t.loop||this.loop,this.maxDistance=t.maxDistance||this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation||this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor||this.rolloffFactor,this.refDistance=t.refDistance||this.refDistance,this.distanceModel=t.distanceModel||this.distanceModel,this._playbackRate=t.playbackRate||this._playbackRate,this._updateSpatialParameters(),this.isPlaying&&(this._streaming?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource.playbackRate.value=this._playbackRate))},e.prototype._createSpatialParameters=function(){t.Engine.audioEngine.canUseWebAudio&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=t.Engine.audioEngine.audioContext.createPanner(),this._updateSpatialParameters(),this._soundPanner.connect(this._ouputAudioNode),this._inputAudioNode=this._soundPanner)},e.prototype._updateSpatialParameters=function(){this.spatialSound&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},e.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF",this._switchPanningModel()},e.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower",this._switchPanningModel()},e.prototype._switchPanningModel=function(){t.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&(this._soundPanner.panningModel=this._panningModel)},e.prototype.connectToSoundTrackAudioNode=function(e){t.Engine.audioEngine.canUseWebAudio&&(this._isOutputConnected&&this._ouputAudioNode.disconnect(),this._ouputAudioNode.connect(e),this._isOutputConnected=!0)},e.prototype.setDirectionalCone=function(e,i,r){if(i<e)return void t.Tools.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e,this._coneOuterAngle=i,this._coneOuterGain=r,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play())},e.prototype.setPosition=function(e){this._position=e,t.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)},e.prototype.setLocalDirectionToMesh=function(e){this._localDirection=e,t.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.isPlaying&&this._updateDirection()},e.prototype._updateDirection=function(){var e=this._connectedMesh.getWorldMatrix(),i=t.Vector3.TransformNormal(this._localDirection,e);i.normalize(),this._soundPanner.setOrientation(i.x,i.y,i.z)},e.prototype.updateDistanceFromListener=function(){if(t.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.useCustomAttenuation){var e=this._connectedMesh.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}},e.prototype.setAttenuationFunction=function(t){this._customAttenuationFunction=t},e.prototype.play=function(e,i){var r=this;if(this._isReadyToPlay&&this._scene.audioEnabled)try{this._startOffset<0&&(e=-this._startOffset,this._startOffset=0);var n=e?t.Engine.audioEngine.audioContext.currentTime+e:t.Engine.audioEngine.audioContext.currentTime;this._soundSource&&this._streamingSource||this.spatialSound&&(this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedMesh?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming?(this._streamingSource||(this._streamingSource=t.Engine.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){r._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement.play()):(this._soundSource=t.Engine.audioEngine.audioContext.createBufferSource(),this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=function(){r._onended()},this._soundSource.start(n,this.isPaused?this._startOffset%this._soundSource.buffer.duration:i?i:0)),this._startTime=n,this.isPlaying=!0,this.isPaused=!1}catch(e){t.Tools.Error("Error while trying to play audio: "+this.name+", "+e.message)}},e.prototype._onended=function(){this.isPlaying=!1,this.onended&&this.onended()},e.prototype.stop=function(e){if(this.isPlaying){if(this._streaming)this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0);else{var i=e?t.Engine.audioEngine.audioContext.currentTime+e:t.Engine.audioEngine.audioContext.currentTime;this._soundSource.stop(i),this._soundSource.onended=null,this.isPaused||(this._startOffset=0)}this.isPlaying=!1}},e.prototype.pause=function(){this.isPlaying&&(this.isPaused=!0,this._streaming?this._htmlAudioElement.pause():(this.stop(0),this._startOffset+=t.Engine.audioEngine.audioContext.currentTime-this._startTime))},e.prototype.setVolume=function(e,i){t.Engine.audioEngine.canUseWebAudio&&(i?(this._soundGain.gain.cancelScheduledValues(t.Engine.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,t.Engine.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,t.Engine.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=e),this._volume=e},e.prototype.setPlaybackRate=function(t){this._playbackRate=t,this.isPlaying&&(this._streaming?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource.playbackRate.value=this._playbackRate)},e.prototype.getVolume=function(){return this._volume},e.prototype.attachToMesh=function(t){var e=this;this._connectedMesh&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedMesh=t,this.spatialSound||(this.spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play())),this._onRegisterAfterWorldMatrixUpdate(this._connectedMesh),this._registerFunc=function(t){return e._onRegisterAfterWorldMatrixUpdate(t)},t.registerAfterWorldMatrixUpdate(this._registerFunc)},e.prototype.detachFromMesh=function(){this._connectedMesh&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedMesh=null)},e.prototype._onRegisterAfterWorldMatrixUpdate=function(e){this.setPosition(e.getBoundingInfo().boundingSphere.centerWorld),t.Engine.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()},e.prototype.clone=function(){var t=this;if(this._streaming)return null;var i=function e(){t._isReadyToPlay?(n._audioBuffer=t.getAudioBuffer(),n._isReadyToPlay=!0,n.autoplay&&n.play()):window.setTimeout(e,300)},r={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},n=new e(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,r);return this.useCustomAttenuation&&n.setAttenuationFunction(this._customAttenuationFunction),n.setPosition(this._position),n.setPlaybackRate(this._playbackRate),i(),n},e.prototype.getAudioBuffer=function(){return this._audioBuffer},e.prototype.serialize=function(){var t={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId};return this.spatialSound&&(this._connectedMesh&&(t.connectedMeshId=this._connectedMesh.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t},e.Parse=function(i,r,n,s){var o,a=i.name;o=i.url?n+i.url:n+a;var h,l={autoplay:i.autoplay,loop:i.loop,volume:i.volume,spatialSound:i.spatialSound,maxDistance:i.maxDistance,rolloffFactor:i.rolloffFactor,refDistance:i.refDistance,distanceModel:i.distanceModel,playbackRate:i.playbackRate};if(s){var c=function t(){s._isReadyToPlay?(h._audioBuffer=s.getAudioBuffer(),h._isReadyToPlay=!0,h.autoplay&&h.play()):window.setTimeout(t,300)};h=new e(a,new ArrayBuffer(0),r,null,l),c()}else h=new e(a,o,r,function(){r._removePendingData(h)},l),r._addPendingData(h);if(i.position){var u=t.Vector3.FromArray(i.position);h.setPosition(u)}if(i.isDirectional&&(h.setDirectionalCone(i.coneInnerAngle||360,i.coneOuterAngle||360,i.coneOuterGain||0),i.localDirectionToMesh)){var p=t.Vector3.FromArray(i.localDirectionToMesh);h.setLocalDirectionToMesh(p)}if(i.connectedMeshId){var d=r.getMeshByID(i.connectedMeshId);d&&h.attachToMesh(d)}return h},e}();t.Sound=e}(r||(r={}));var r;!function(t){var e=function(){function e(t,e){this.id=-1,this._isMainTrack=!1,this._isInitialized=!1,this._scene=t,this.soundCollection=new Array,this._options=e,this._isMainTrack||(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1)}return e.prototype._initializeSoundTrackAudioGraph=function(){t.Engine.audioEngine.canUseWebAudio&&(this._outputAudioNode=t.Engine.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(t.Engine.audioEngine.masterGain),this._options&&(this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._options.mainTrack&&(this._isMainTrack=this._options.mainTrack)),this._isInitialized=!0)},e.prototype.dispose=function(){if(t.Engine.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}},e.prototype.AddSound=function(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),t.Engine.audioEngine.canUseWebAudio&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(e.soundTrackId===-1?this._scene.mainSoundTrack.RemoveSound(e):this._scene.soundTracks[e.soundTrackId].RemoveSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id},e.prototype.RemoveSound=function(t){var e=this.soundCollection.indexOf(t);e!==-1&&this.soundCollection.splice(e,1)},e.prototype.setVolume=function(e){t.Engine.audioEngine.canUseWebAudio&&(this._outputAudioNode.gain.value=e)},e.prototype.switchPanningModelToHRTF=function(){if(t.Engine.audioEngine.canUseWebAudio)for(var e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()},e.prototype.switchPanningModelToEqualPower=function(){if(t.Engine.audioEngine.canUseWebAudio)for(var e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()},e.prototype.connectToAnalyser=function(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,t.Engine.audioEngine.canUseWebAudio&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,t.Engine.audioEngine.masterGain))},e}();t.SoundTrack=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h,l){var c=this;void 0===a&&(a=t.Texture.BILINEAR_SAMPLINGMODE),e.call(this,i,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,o,a,h,l),this.direction=r,this.blurWidth=n,this.onApplyObservable.add(function(t){t.setFloat2("screenSize",c.width,c.height),t.setVector2("direction",c.direction),t.setFloat("blurWidth",c.blurWidth)})}return o(i,e),i}(t.PostProcess),i=function(){function i(e,r,n){this._vertexBuffers={},this._mainTextureDesiredSize={width:0,height:0},this._meshes={},this._maxSize=0,this._shouldRender=!1,this._instanceGlowingMeshStencilReference=i.glowingMeshStencilReference++,this._excludedMeshes={},this.innerGlow=!0,this.outerGlow=!0,this.isEnabled=!0,this.onDisposeObservable=new t.Observable,this.onBeforeRenderMainTextureObservable=new t.Observable,this.onBeforeBlurObservable=new t.Observable,this.onAfterBlurObservable=new t.Observable,this.onBeforeComposeObservable=new t.Observable,this.onAfterComposeObservable=new t.Observable,this.onSizeChangedObservable=new t.Observable,this._scene=r;var s=r.getEngine();this._engine=s,this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.highlightLayers.push(this),this._engine.isStencilEnable||t.Tools.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new BABYLON.Engine(canvas, antialias, { stencil: true }"),this._options=n||{mainTextureRatio:.25,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:t.Engine.ALPHA_COMBINE},this._options.mainTextureRatio=this._options.mainTextureRatio||.25,this._options.blurTextureSizeRatio=this._options.blurTextureSizeRatio||.5,this._options.blurHorizontalSize=this._options.blurHorizontalSize||1,this._options.blurVerticalSize=this._options.blurVerticalSize||1,this._options.alphaBlendingMode=this._options.alphaBlendingMode||t.Engine.ALPHA_COMBINE;var o=[];o.push(1,1),o.push(-1,1),o.push(-1,-1),o.push(1,-1);var a=new t.VertexBuffer(s,o,t.VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[t.VertexBuffer.PositionKind]=a;var h=[];h.push(0),h.push(1),h.push(2),h.push(0),h.push(2),h.push(3),this._indexBuffer=s.createIndexBuffer(h),this._glowMapMergeEffect=s.createEffect("glowMapMerge",[t.VertexBuffer.PositionKind],["offset"],["textureSampler"],""),this.setMainTextureSize(),this.createTextureAndPostProcesses()}return Object.defineProperty(i.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.blurWidth},set:function(t){this._horizontalBlurPostprocess.blurWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.blurWidth},set:function(t){this._verticalBlurPostprocess.blurWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"camera",{get:function(){return this._options.camera},enumerable:!0,configurable:!0}),i.prototype.createTextureAndPostProcesses=function(){var r=this,n=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,s=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;n=t.Tools.GetExponentOfTwo(n,this._maxSize),s=t.Tools.GetExponentOfTwo(s,this._maxSize),this._mainTexture=new t.RenderTargetTexture("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,t.Engine.TEXTURETYPE_UNSIGNED_INT),this._mainTexture.activeCamera=this._options.camera,this._mainTexture.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(t.Texture.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._blurTexture=new t.RenderTargetTexture("HighlightLayerBlurRTT",{width:n,height:s},this._scene,!1,!0,t.Engine.TEXTURETYPE_UNSIGNED_INT),this._blurTexture.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(t.Texture.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._downSamplePostprocess=new t.PassPostProcess("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.onApplyObservable.add(function(t){t.setTexture("textureSampler",r._mainTexture)}),this._options.alphaBlendingMode===t.Engine.ALPHA_COMBINE?(this._horizontalBlurPostprocess=new e("HighlightLayerHBP",new t.Vector2(1,0),this._options.blurHorizontalSize,1,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2("screenSize",n,s)}),this._verticalBlurPostprocess=new e("HighlightLayerVBP",new t.Vector2(0,1),this._options.blurVerticalSize,1,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2("screenSize",n,s)})):(this._horizontalBlurPostprocess=new t.BlurPostProcess("HighlightLayerHBP",new t.Vector2(1,0),this._options.blurHorizontalSize,1,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2("screenSize",n,s)}),this._verticalBlurPostprocess=new t.BlurPostProcess("HighlightLayerVBP",new t.Vector2(0,1),this._options.blurVerticalSize,1,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(t){t.setFloat2("screenSize",n,s)})),this._mainTexture.onAfterUnbindObservable.add(function(){r.onBeforeBlurObservable.notifyObservers(r),r._scene.postProcessManager.directRender([r._downSamplePostprocess,r._horizontalBlurPostprocess,r._verticalBlurPostprocess],r._blurTexture.getInternalTexture()),r.onAfterBlurObservable.notifyObservers(r)});var o=function(e){var n=e.getRenderingMesh(),s=r._scene,o=s.getEngine();o.setState(e.getMaterial().backFaceCulling);var a=n._getInstancesRenderList(e._id);if(!a.mustReturn&&!r._excludedMeshes[n.id]){var h=null!==o.getCaps().instancedArrays&&null!==a.visibleInstances[e._id]&&void 0!==a.visibleInstances[e._id],l=r._meshes[n.id],c=e.getMaterial(),u=null;if(l&&l.glowEmissiveOnly&&c&&(u=c.emissiveTexture),r.isReady(e,h,u)){if(o.enableEffect(r._glowMapGenerationEffect),n._bind(e,r._glowMapGenerationEffect,t.Material.TriangleFillMode),r._glowMapGenerationEffect.setMatrix("viewProjection",s.getTransformMatrix()),l?r._glowMapGenerationEffect.setFloat4("color",l.color.r,l.color.g,l.color.b,1):r._glowMapGenerationEffect.setFloat4("color",i.neutralColor.r,i.neutralColor.g,i.neutralColor.b,i.neutralColor.a),c&&c.needAlphaTesting()){var p=c.getAlphaTestTexture();r._glowMapGenerationEffect.setTexture("diffuseSampler",p),r._glowMapGenerationEffect.setMatrix("diffuseMatrix",p.getTextureMatrix())}u&&(r._glowMapGenerationEffect.setTexture("emissiveSampler",u),r._glowMapGenerationEffect.setMatrix("emissiveMatrix",u.getTextureMatrix())),n.useBones&&n.computeBonesUsingShaders&&r._glowMapGenerationEffect.setMatrices("mBones",n.skeleton.getTransformMatrices(n)),n._processRendering(e,r._glowMapGenerationEffect,t.Material.TriangleFillMode,a,h,function(t,e){return r._glowMapGenerationEffect.setMatrix("world",e)})}else r._mainTexture.resetRefreshCounter()}};this._mainTexture.customRenderFunction=function(t,e,i){r.onBeforeRenderMainTextureObservable.notifyObservers(r);var n;for(n=0;n<t.length;n++)o(t.data[n]);for(n=0;n<e.length;n++)o(e.data[n]);for(n=0;n<i.length;n++)o(i.data[n])},this._mainTexture.onClearObservable.add(function(t){t.clear(i.neutralColor,!0,!0,!0)})},i.prototype.isReady=function(e,i,r){if(!e.getMaterial().isReady(e.getMesh(),i))return!1;var n=[],s=[t.VertexBuffer.PositionKind],o=e.getMesh(),a=e.getMaterial(),h=!1,l=!1;if(a&&a.needAlphaTesting()){var c=a.getAlphaTestTexture();c&&(n.push("#define ALPHATEST"),o.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&1===c.coordinatesIndex?(n.push("#define DIFFUSEUV2"),l=!0):o.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(n.push("#define DIFFUSEUV1"),h=!0))}r&&(n.push("#define EMISSIVE"),o.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&1===r.coordinatesIndex?(n.push("#define EMISSIVEUV2"),l=!0):o.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(n.push("#define EMISSIVEUV1"),h=!0)),h&&(s.push(t.VertexBuffer.UVKind),n.push("#define UV1")),l&&(s.push(t.VertexBuffer.UV2Kind),n.push("#define UV2")),o.useBones&&o.computeBonesUsingShaders?(s.push(t.VertexBuffer.MatricesIndicesKind),s.push(t.VertexBuffer.MatricesWeightsKind),o.numBoneInfluencers>4&&(s.push(t.VertexBuffer.MatricesIndicesExtraKind),s.push(t.VertexBuffer.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),n.push("#define BonesPerMesh "+(o.skeleton.bones.length+1))):n.push("#define NUM_BONE_INFLUENCERS 0"),i&&(n.push("#define INSTANCES"),s.push("world0"),s.push("world1"),s.push("world2"),s.push("world3"));var u=n.join("\n");return this._cachedDefines!==u&&(this._cachedDefines=u,this._glowMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",s,["world","mBones","viewProjection","diffuseMatrix","color","emissiveMatrix"],["diffuseSampler","emissiveSampler"],u)),this._glowMapGenerationEffect.isReady()},i.prototype.render=function(){var e=this._glowMapMergeEffect;if(e.isReady()&&this._blurTexture.isReady()){var i=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this),i.enableEffect(e),i.setState(!1);var r=i.getStencilBuffer(),n=i.getStencilFunction(),s=i.getStencilMask(),o=i.getAlphaMode();e.setTexture("textureSampler",this._blurTexture),i.bindBuffers(this._vertexBuffers,this._indexBuffer,e),i.setAlphaMode(this._options.alphaBlendingMode),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&(e.setFloat("offset",0),i.setStencilFunction(t.Engine.NOTEQUAL),i.draw(!0,0,6)),this.innerGlow&&(e.setFloat("offset",1),i.setStencilFunction(t.Engine.EQUAL),i.draw(!0,0,6)),i.setStencilFunction(n),i.setStencilMask(s),i.setAlphaMode(o),i.setStencilBuffer(r),this.onAfterComposeObservable.notifyObservers(this);var a=this._mainTexture.getSize();this.setMainTextureSize(),a.width===this._mainTextureDesiredSize.width&&a.height===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this.disposeTextureAndPostProcesses(),this.createTextureAndPostProcesses())}},i.prototype.addExcludedMesh=function(t){this._excludedMeshes[t.id]||(this._excludedMeshes[t.id]={mesh:t,beforeRender:t.onBeforeRenderObservable.add(function(t){t.getEngine().setStencilBuffer(!1)}),afterRender:t.onAfterRenderObservable.add(function(t){t.getEngine().setStencilBuffer(!0)})})},i.prototype.removeExcludedMesh=function(t){var e=this._excludedMeshes[t.id];e&&(t.onBeforeRenderObservable.remove(e.beforeRender),t.onAfterRenderObservable.remove(e.afterRender)),this._excludedMeshes[t.id]=void 0},i.prototype.addMesh=function(t,e,i){var r=this;void 0===i&&(i=!1);var n=this._meshes[t.id];n?n.color=e:this._meshes[t.id]={mesh:t,color:e,observerHighlight:t.onBeforeRenderObservable.add(function(t){r._excludedMeshes[t.id]?r.defaultStencilReference(t):t.getScene().getEngine().setStencilFunctionReference(r._instanceGlowingMeshStencilReference)}),observerDefault:t.onAfterRenderObservable.add(this.defaultStencilReference),glowEmissiveOnly:i},this._shouldRender=!0},i.prototype.removeMesh=function(t){var e=this._meshes[t.id];e&&(t.onBeforeRenderObservable.remove(e.observerHighlight),t.onAfterRenderObservable.remove(e.observerDefault)),this._meshes[t.id]=void 0,this._shouldRender=!1;for(var i in this._meshes)if(i){this._shouldRender=!0;break}},i.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender},i.prototype.setMainTextureSize=function(){this._options.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._options.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._options.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderingCanvas().width*this._options.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderingCanvas().height*this._options.mainTextureRatio,this._mainTextureDesiredSize.width=t.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize),this._mainTextureDesiredSize.height=t.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize))},i.prototype.defaultStencilReference=function(t){t.getScene().getEngine().setStencilFunctionReference(i.normalMeshStencilReference)},i.prototype.disposeTextureAndPostProcesses=function(){this._blurTexture.dispose(),this._mainTexture.dispose(),this._downSamplePostprocess.dispose(),this._horizontalBlurPostprocess.dispose(),this._verticalBlurPostprocess.dispose()},i.prototype.dispose=function(){var e=this._vertexBuffers[t.VertexBuffer.PositionKind];e&&(e.dispose(),this._vertexBuffers[t.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.disposeTextureAndPostProcesses();for(var i in this._meshes){var r=this._meshes[i];r&&r.mesh&&(r.mesh.onBeforeRenderObservable.remove(r.observerHighlight),r.mesh.onAfterRenderObservable.remove(r.observerDefault))}this._meshes=null;for(var i in this._excludedMeshes){var r=this._excludedMeshes[i];r&&(r.mesh.onBeforeRenderObservable.remove(r.beforeRender),r.mesh.onAfterRenderObservable.remove(r.afterRender))}this._excludedMeshes=null;var n=this._scene.highlightLayers.indexOf(this,0);n>-1&&this._scene.highlightLayers.splice(n,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeBlurObservable.clear(),this.onBeforeComposeObservable.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()},i.neutralColor=new t.Color4(0,0,0,0),i.glowingMeshStencilReference=2,i.normalMeshStencilReference=1,i}();t.HighlightLayer=i}(r||(r={}));var r;!function(t){var e=function(){function t(){}return t.TransformCoordinatesToRefSIMD=function(e,i,r){t.TransformCoordinatesFromFloatsToRefSIMD(e.x,e.y,e.z,i,r)},t.TransformCoordinatesFromFloatsToRefSIMD=function(t,e,i,r,n){var s=r.m,o=SIMD.Float32x4.load(s,0),a=SIMD.Float32x4.load(s,4),h=SIMD.Float32x4.load(s,8),l=SIMD.Float32x4.load(s,12),c=SIMD.Float32x4.add(SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(t),o),SIMD.Float32x4.mul(SIMD.Float32x4.splat(e),a)),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(i),h),l));c=SIMD.Float32x4.div(c,SIMD.Float32x4.swizzle(c,3,3,3,3)),n.x=SIMD.Float32x4.extractLane(c,0),n.y=SIMD.Float32x4.extractLane(c,1),n.z=SIMD.Float32x4.extractLane(c,2)},t}(),i=function(){function t(){}return t.prototype.multiplyToArraySIMD=function(t,e,i){for(var r=this.m,n=t.m,s=SIMD.Float32x4.load(n,0),o=SIMD.Float32x4.load(n,4),a=SIMD.Float32x4.load(n,8),h=SIMD.Float32x4.load(n,12),l=0;l<16;l+=4)SIMD.Float32x4.store(e,l+i,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(r[l]),s),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(r[l+1]),o),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(r[l+2]),a),SIMD.Float32x4.mul(SIMD.Float32x4.splat(r[l+3]),h)))));return this},t.prototype.invertToRefSIMD=function(t){var e=this.m,i=t.m,r=SIMD.Float32x4.load(e,0),n=SIMD.Float32x4.load(e,4),s=SIMD.Float32x4.load(e,8),o=SIMD.Float32x4.load(e,12),a=SIMD.Float32x4.shuffle(r,n,0,1,4,5),h=SIMD.Float32x4.shuffle(s,o,0,1,4,5),l=SIMD.Float32x4.shuffle(a,h,0,2,4,6);h=SIMD.Float32x4.shuffle(h,a,1,3,5,7),a=SIMD.Float32x4.shuffle(r,n,2,3,6,7);var c=SIMD.Float32x4.shuffle(s,o,2,3,6,7),u=SIMD.Float32x4.shuffle(a,c,0,2,4,6);c=SIMD.Float32x4.shuffle(c,a,1,3,5,7),a=SIMD.Float32x4.mul(u,c),a=SIMD.Float32x4.swizzle(a,1,0,3,2);var p=SIMD.Float32x4.mul(h,a),d=SIMD.Float32x4.mul(l,a);a=SIMD.Float32x4.swizzle(a,2,3,0,1),p=SIMD.Float32x4.sub(SIMD.Float32x4.mul(h,a),p),d=SIMD.Float32x4.sub(SIMD.Float32x4.mul(l,a),d),d=SIMD.Float32x4.swizzle(d,2,3,0,1),a=SIMD.Float32x4.mul(h,u),a=SIMD.Float32x4.swizzle(a,1,0,3,2),p=SIMD.Float32x4.add(SIMD.Float32x4.mul(c,a),p);var f=SIMD.Float32x4.mul(l,a);a=SIMD.Float32x4.swizzle(a,2,3,0,1),p=SIMD.Float32x4.sub(p,SIMD.Float32x4.mul(c,a)),f=SIMD.Float32x4.sub(SIMD.Float32x4.mul(l,a),f),f=SIMD.Float32x4.swizzle(f,2,3,0,1),a=SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(h,2,3,0,1),c),a=SIMD.Float32x4.swizzle(a,1,0,3,2),u=SIMD.Float32x4.swizzle(u,2,3,0,1),p=SIMD.Float32x4.add(SIMD.Float32x4.mul(u,a),p);var m=SIMD.Float32x4.mul(l,a);a=SIMD.Float32x4.swizzle(a,2,3,0,1),p=SIMD.Float32x4.sub(p,SIMD.Float32x4.mul(u,a)),m=SIMD.Float32x4.sub(SIMD.Float32x4.mul(l,a),m),m=SIMD.Float32x4.swizzle(m,2,3,0,1),a=SIMD.Float32x4.mul(l,h),a=SIMD.Float32x4.swizzle(a,1,0,3,2),m=SIMD.Float32x4.add(SIMD.Float32x4.mul(c,a),m),f=SIMD.Float32x4.sub(SIMD.Float32x4.mul(u,a),f),a=SIMD.Float32x4.swizzle(a,2,3,0,1),m=SIMD.Float32x4.sub(SIMD.Float32x4.mul(c,a),m),f=SIMD.Float32x4.sub(f,SIMD.Float32x4.mul(u,a)),a=SIMD.Float32x4.mul(l,c),a=SIMD.Float32x4.swizzle(a,1,0,3,2),d=SIMD.Float32x4.sub(d,SIMD.Float32x4.mul(u,a)),m=SIMD.Float32x4.add(SIMD.Float32x4.mul(h,a),m),a=SIMD.Float32x4.swizzle(a,2,3,0,1),d=SIMD.Float32x4.add(SIMD.Float32x4.mul(u,a),d),m=SIMD.Float32x4.sub(m,SIMD.Float32x4.mul(h,a)),a=SIMD.Float32x4.mul(l,u),a=SIMD.Float32x4.swizzle(a,1,0,3,2),d=SIMD.Float32x4.add(SIMD.Float32x4.mul(c,a),d),f=SIMD.Float32x4.sub(f,SIMD.Float32x4.mul(h,a)),a=SIMD.Float32x4.swizzle(a,2,3,0,1),d=SIMD.Float32x4.sub(d,SIMD.Float32x4.mul(c,a)),f=SIMD.Float32x4.add(SIMD.Float32x4.mul(h,a),f);var _=SIMD.Float32x4.mul(l,p);return _=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(_,2,3,0,1),_),_=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(_,1,0,3,2),_),a=SIMD.Float32x4.reciprocalApproximation(_),_=SIMD.Float32x4.sub(SIMD.Float32x4.add(a,a),SIMD.Float32x4.mul(_,SIMD.Float32x4.mul(a,a))),_=SIMD.Float32x4.swizzle(_,0,0,0,0),SIMD.Float32x4.store(i,0,SIMD.Float32x4.mul(_,p)),SIMD.Float32x4.store(i,4,SIMD.Float32x4.mul(_,d)),SIMD.Float32x4.store(i,8,m=SIMD.Float32x4.mul(_,m)),SIMD.Float32x4.store(i,12,SIMD.Float32x4.mul(_,f)),this},t.LookAtLHToRefSIMD=function(t,e,i,r){var n=r.m,s=SIMD.Float32x4(e.x,e.y,e.z,0),o=SIMD.Float32x4(t.x,t.y,t.z,0),a=SIMD.Float32x4(i.x,i.y,i.z,0),h=SIMD.Float32x4.sub(s,o),l=SIMD.Float32x4.mul(h,h);l=SIMD.Float32x4.add(l,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(l,1,2,0,3),SIMD.Float32x4.swizzle(l,2,0,1,3))),h=SIMD.Float32x4.mul(h,SIMD.Float32x4.reciprocalSqrtApproximation(l)),l=SIMD.Float32x4.mul(a,a),l=SIMD.Float32x4.add(l,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(l,1,2,0,3),SIMD.Float32x4.swizzle(l,2,0,1,3))),a=SIMD.Float32x4.mul(a,SIMD.Float32x4.reciprocalSqrtApproximation(l));var c=SIMD.Float32x4.sub(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(h,1,2,0,3),SIMD.Float32x4.swizzle(a,2,0,1,3)),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(h,2,0,1,3),SIMD.Float32x4.swizzle(a,1,2,0,3)));l=SIMD.Float32x4.mul(c,c),l=SIMD.Float32x4.add(l,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(l,1,2,0,3),SIMD.Float32x4.swizzle(l,2,0,1,3))),c=SIMD.Float32x4.mul(c,SIMD.Float32x4.reciprocalSqrtApproximation(l));var u=SIMD.Float32x4.sub(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(c,1,2,0,3),SIMD.Float32x4.swizzle(h,2,0,1,3)),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(c,2,0,1,3),SIMD.Float32x4.swizzle(h,1,2,0,3)));l=SIMD.Float32x4.mul(c,c),l=SIMD.Float32x4.add(l,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(l,1,2,0,3),SIMD.Float32x4.swizzle(l,2,0,1,3))),c=SIMD.Float32x4.mul(c,SIMD.Float32x4.reciprocalSqrtApproximation(l));var p=SIMD.Float32x4.splat(0);c=SIMD.Float32x4.neg(c);var d=SIMD.Float32x4.shuffle(c,u,0,1,4,5),f=SIMD.Float32x4.shuffle(h,p,0,1,4,5),m=SIMD.Float32x4.shuffle(d,f,0,2,4,6),_=SIMD.Float32x4.shuffle(d,f,1,3,5,7),g=SIMD.Float32x4.shuffle(SIMD.Float32x4.shuffle(c,u,2,3,6,7),SIMD.Float32x4.shuffle(h,p,2,3,6,7),0,2,4,6),y=SIMD.Float32x4(0,0,0,1),v=SIMD.Float32x4(1,0,0,0);SIMD.Float32x4.store(n,0,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,0,0,0,0),m),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,1,1,1,1),_),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,2,2,2,2),g),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,3,3,3,3),y))))),v=SIMD.Float32x4(0,1,0,0),SIMD.Float32x4.store(n,4,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,0,0,0,0),m),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,1,1,1,1),_),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,2,2,2,2),g),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,3,3,3,3),y))))),v=SIMD.Float32x4(0,0,1,0),SIMD.Float32x4.store(n,8,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,0,0,0,0),m),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,1,1,1,1),_),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,2,2,2,2),g),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,3,3,3,3),y))))),v=SIMD.Float32x4.replaceLane(SIMD.Float32x4.neg(o),3,1),SIMD.Float32x4.store(n,12,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,0,0,0,0),m),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,1,1,1,1),_),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,2,2,2,2),g),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(v,3,3,3,3),y)))))},t}(),r=t.Matrix.prototype.multiplyToArray,n=t.Matrix.prototype.invertToRef,s=t.Matrix.LookAtLHToRef,o=t.Vector3.TransformCoordinatesToRef,a=t.Vector3.TransformCoordinatesFromFloatsToRef,h=function(){function h(){}return Object.defineProperty(h,"IsEnabled",{get:function(){return h._isEnabled},enumerable:!0,configurable:!0}),h.DisableSIMD=function(){t.Matrix.prototype.multiplyToArray=r,t.Matrix.prototype.invertToRef=n,t.Matrix.LookAtLHToRef=s,t.Vector3.TransformCoordinatesToRef=o,t.Vector3.TransformCoordinatesFromFloatsToRef=a,h._isEnabled=!1},h.EnableSIMD=function(){void 0!==self.SIMD&&(self.Math.fround||(self.Math.fround=function(t){return function(e){return t[0]=e,t[0]}}(new Float32Array(1))),self.Math.imul||(self.Math.imul=function(t,e){var i=t>>>16&65535,r=65535&t,n=e>>>16&65535,s=65535&e;return r*s+(i*s+r*n<<16>>>0)|0}),t.Matrix.prototype.multiplyToArray=i.prototype.multiplyToArraySIMD,t.Matrix.prototype.invertToRef=i.prototype.invertToRefSIMD,t.Matrix.LookAtLHToRef=i.LookAtLHToRefSIMD,t.Vector3.TransformCoordinatesToRef=e.TransformCoordinatesToRefSIMD,t.Vector3.TransformCoordinatesFromFloatsToRef=e.TransformCoordinatesFromFloatsToRefSIMD,h._isEnabled=!0)},h._isEnabled=!1,h}();t.SIMDHelper=h}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i,r){this._pos=i,this._size=r,this._root=t,this._parent=e,this._contentSize=null,this._bottomNode=null,this._leftNode=null,this._initialSize=null,this._rightNode=null}return Object.defineProperty(e.prototype,"pos",{get:function(){return this._pos},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentSize",{get:function(){return this._contentSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"UVs",{get:function(){return this.getUVsForCustomSize(this._root._size)},enumerable:!0,configurable:!0}),e.prototype.getUVsForCustomSize=function(e){var i=this._root._size.width,r=this._root._size.height,n=new t.Vector2(this._pos.x/i,this._pos.y/r),s=new t.Vector2((this._pos.x+e.width-1)/i,(this._pos.y+e.height-1)/r),o=new Array;return o.push(n),o.push(new t.Vector2(s.x,n.y)),o.push(s),o.push(new t.Vector2(n.x,s.y)),o},e.prototype.freeContent=function(){this.contentSize&&(this._contentSize=null,this.attemptDefrag())},Object.defineProperty(e.prototype,"isUsed",{get:function(){return null!=this._contentSize||null!=this._leftNode},enumerable:!0,configurable:!0}),e.prototype.findAndSplitNode=function(t){var e=this.findNode(t);return e?(e.splitNode(t),e):null},e.prototype.findNode=function(t){var e=null;if(this.isUsed)this._leftNode&&(e=this._leftNode.findNode(t)),!e&&this._rightNode&&(e=this._rightNode.findNode(t)),!e&&this._bottomNode&&(e=this._bottomNode.findNode(t));else if(this._initialSize){if(!(t.width<=this._initialSize.width&&t.height<=this._initialSize.height))return null;e=this}else t.width<=this._size.width&&t.height<=this._size.height&&(e=this);return e},e.prototype.splitNode=function(i){return!this._contentSize&&this._initialSize?(this._contentSize=i.clone(),this._leftNode=new e(this._root,this,new t.Vector2(this._pos.x,this._pos.y),new t.Size(this._initialSize.width,this._initialSize.height)),this._leftNode.splitNode(i)):(this._contentSize=i.clone(),this._initialSize=i.clone(),i.width!==this._size.width&&(this._rightNode=new e(this._root,this,new t.Vector2(this._pos.x+i.width,this._pos.y),new t.Size(this._size.width-i.width,i.height))),i.height!==this._size.height&&(this._bottomNode=new e(this._root,this,new t.Vector2(this._pos.x,this._pos.y+i.height),new t.Size(this._size.width,this._size.height-i.height))),this)},e.prototype.attemptDefrag=function(){!this.isUsed&&this.isRecursiveFree&&(this.clearNode(),this._parent&&this._parent.attemptDefrag())},e.prototype.clearNode=function(){this._initialSize=null,this._rightNode=null,this._bottomNode=null},Object.defineProperty(e.prototype,"isRecursiveFree",{get:function(){return!this.contentSize&&(!this._leftNode||this._leftNode.isRecursiveFree)&&(!this._rightNode||this._rightNode.isRecursiveFree)&&(!this._bottomNode||this._bottomNode.isRecursiveFree)},enumerable:!0,configurable:!0}),e.prototype.evalFreeSize=function(t){var e=0;return this.isUsed||(e=this._initialSize?this._initialSize.surface:this._size.surface),this._rightNode&&(e+=this._rightNode.evalFreeSize(0)),this._bottomNode&&(e+=this._bottomNode.evalFreeSize(0)),e+t},e}();t.PackedRect=e;var i=function(e){function i(i){e.call(this,null,null,t.Vector2.Zero(),i),this._root=this}return o(i,e),i.prototype.addRect=function(t){return this.findAndSplitNode(t)},Object.defineProperty(i.prototype,"freeSpace",{get:function(){var t=0;return(t=this.evalFreeSize(t))/(this._size.width*this._size.height)},enumerable:!0,configurable:!0}),i}(e);t.RectPackingMap=i}(r||(r={}));var r;!function(t){var e=function(){function t(){}return t}();t.DynamicFloatArrayElementInfo=e;var i=function(){function t(t,i){this.compareValueOffset=null,this.sortingAscending=!0,this._stride=t,this.buffer=new Float32Array(t*i),this._lastUsed=0,this._firstFree=0,this._allEntries=new Array(i),this._freeEntries=new Array(i);for(var r=0;r<i;r++){var n=new e;n.offset=r*t,this._allEntries[r]=n,this._freeEntries[i-r-1]=n}}return t.prototype.allocElement=function(){0===this._freeEntries.length&&this._growBuffer();var t=this._freeEntries.pop();return this._lastUsed=Math.max(t.offset,this._lastUsed),t.offset===this._firstFree&&(this._freeEntries.length>0?this._firstFree=this._freeEntries[this._freeEntries.length-1].offset:this._firstFree+=this._stride),t},t.prototype.freeElement=function(t){this._firstFree=Math.min(t.offset,this._firstFree),this._freeEntries.push(t)},t.prototype.pack=function(){if(0===this._freeEntries.length)return this.buffer;if(this._lastUsed<this._firstFree){return this.buffer.subarray(0,this._lastUsed+this._stride)}var t=this._stride,i=new e;i.offset=this.totalElementCount*t,this._freeEntries.push(i);for(var r=this._freeEntries.sort(function(t,e){return t.offset-e.offset}),n=this._allEntries.sort(function(t,e){return t.offset-e.offset}),s=r[0].offset,o=1,a=(this.usedElementCount+1)*t,h=r[0].offset,l=1;l<r.length&&!(s>=a);l++){var c=r[l],u=c.offset,p=u-h;if(p!==t){for(var d=p/t-1,f=u-t,m=Math.min(o,d),_=0;_<m;_++){var g=s/t,y=f/t,v=n[y];this._moveElement(v,s);var x=n[g];x.offset=f,n[g]=v,n[y]=x,f-=t,s+=t}o<=d?(s=f+t,o=1+m):o=(u-s)/t+1,h=u}else++o,h=u}var b=this.buffer.subarray(0,s);return this._lastUsed=s-t,this._firstFree=s,r.pop(),this._freeEntries=r.sort(function(t,e){return e.offset-t.offset}),this._allEntries=n,b},t.prototype._moveElement=function(t,e){for(var i=0;i<this._stride;i++)this.buffer[e+i]=this.buffer[t.offset+i];t.offset=e},t.prototype._growBuffer=function(){var t=Math.floor(1.5*this.totalElementCount),i=new Float32Array(t*this._stride);i.set(this.buffer);for(var r=this.totalElementCount,n=t-this.totalElementCount,s=0;s<n;s++){var o=new e;o.offset=(r+s)*this.stride,this._allEntries.push(o),this._freeEntries[n-s-1]=o}this._firstFree=r*this.stride,this.buffer=i},Object.defineProperty(t.prototype,"totalElementCount",{get:function(){return this._allEntries.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"freeElementCount",{get:function(){return this._freeEntries.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usedElementCount",{get:function(){return this._allEntries.length-this._freeEntries.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stride",{get:function(){return this._stride},enumerable:!0,configurable:!0}),t.prototype.sort=function(){var t=this;if(!this.compareValueOffset)throw new Error("The DynamicFloatArray.sort() method needs a valid 'compareValueOffset' property");var e=this.usedElementCount;if(!this._sortTable||this._sortTable.length<e){var i=Math.min(this.totalElementCount,2*e);this._sortTable=new Array(i)}this._sortedTable&&this._sortedTable.length===e||(this._sortedTable=new Array(e)),this.pack();for(var n=0,s=this.stride,o=0;o<e;o++,n+=s){var a=this._sortTable[o];a||(a=new r,this._sortTable[o]=a),a.compareData=this.buffer[n+this.compareValueOffset],a.offset=n,a.swapedOffset=null,this._sortedTable[o]=a}this.sortingAscending?this._sortedTable.sort(function(t,e){return t.compareData-e.compareData}):this._sortedTable.sort(function(t,e){return e.compareData-t.compareData});for(var h=function(e,i){for(var r=0;r<s;r++){var n=t.buffer[i+r];t.buffer[i+r]=t.buffer[e+r],t.buffer[e+r]=n}},o=0;o<e;o++){var l=this._sortedTable[o],c=this._sortTable[o],u=l.offset;if(l.swapedOffset){for(var p=l;p.swapedOffset;)p=this._sortTable[p.swapedOffset/s];u=p.offset}c.swapedOffset=u,u!==c.offset&&h(u,c.offset),this._allEntries[l.offset/s].offset=c.offset}return this._allEntries.sort(function(t,e){return t.offset-e.offset}),!0},t}();t.DynamicFloatArray=i;var r=function(){function t(){this.compareData=this.offset=this.swapedOffset=null}return t}()}(r||(r={}));var r;!function(t){var e=function(){function t(){}return t}();t.CharInfo=e;var i=function(i){function r(e,r,n,s,o,a,h){if(void 0===s&&(s=200),void 0===o&&(o=t.Texture.TRILINEAR_SAMPLINGMODE),void 0===a&&(a=!1),void 0===h&&(h=!1),i.call(this,null,n,!0,!1,o),this._charInfos={},this._curCharCount=0,this._lastUpdateCharCount=-1,this._usedCounter=1,this.name=e,this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._sdfScale=8,this._signedDistanceField=h,this._superSample=!1,a||h){var l=this.getSuperSampleFont(r);l&&(this._superSample=!0,r=l)}this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this._context.font=r,this._context.fillStyle="white",this._context.textBaseline="top",this._cachedFontId=null;var c=this.getFontHeight(r);this._lineHeightSuper=c.height+4,this._lineHeight=this._superSample?Math.ceil(this._lineHeightSuper/2):this._lineHeightSuper,this._offset=c.offset-1,this._xMargin=1+Math.ceil(this._lineHeightSuper/15),this._yMargin=this._xMargin;var u=this._context.measureText("W").width;this._spaceWidthSuper=this._context.measureText(" ").width,this._spaceWidth=this._superSample?this._spaceWidthSuper/2:this._spaceWidthSuper;var p=(this._lineHeightSuper+this._yMargin)*(u+this._xMargin)*s,d=Math.sqrt(p),f=Math.pow(2,Math.ceil(Math.log(d)/Math.log(2)));this._texture=n.getEngine().createDynamicTexture(f,f,!1,o);var m=this.getSize();if(this.hasAlpha=this._signedDistanceField===!1,this._canvas=document.createElement("canvas"),this._canvas.width=m.width,this._canvas.height=m.height,this._context=this._canvas.getContext("2d"),this._context.textBaseline="top",this._context.font=r,this._context.fillStyle="white",this._context.imageSmoothingEnabled=!1,this._context.clearRect(0,0,m.width,m.height),this._signedDistanceField){var _=document.createElement("canvas"),g=this._sdfScale;_.width=u*g,_.height=this._lineHeightSuper*g;var y=_.getContext("2d");y.scale(g,g),y.textBaseline="top",y.font=r,y.fillStyle="white",y.imageSmoothingEnabled=!1,this._sdfCanvas=_,this._sdfContext=y}this._currentFreePosition=t.Vector2.Zero();for(var v=32;v<127;v++){var x=String.fromCharCode(v);this.getChar(x)}this.update()}return o(r,i),Object.defineProperty(r.prototype,"isSuperSampled",{get:function(){return this._superSample},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isSignedDistanceField",{get:function(){return this._signedDistanceField},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"spaceWidth",{get:function(){return this._spaceWidth},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"lineHeight",{get:function(){return this._lineHeight},enumerable:!0,configurable:!0}),r.GetCachedFontTexture=function(e,i,n,s){void 0===n&&(n=!1),void 0===s&&(s=!1);var o=e;o.__fontTextureCache__||(o.__fontTextureCache__=new t.StringDictionary);var a=o.__fontTextureCache__,h=i.toLocaleLowerCase()+(n?"_+SS":"_-SS")+(s?"_+SDF":"_-SDF"),l=a.get(h);return l?(++l._usedCounter,l):(l=new r(null,i,e,n?100:200,t.Texture.BILINEAR_SAMPLINGMODE,n,s),l._cachedFontId=h,a.add(h,l),l)},r.ReleaseCachedFontTexture=function(t,e,i,r){void 0===i&&(i=!1),void 0===r&&(r=!1);var n=t,s=n.__fontTextureCache__;if(s){var o=e.toLocaleLowerCase()+(i?"_+SS":"_-SS")+(r?"_+SDF":"_-SDF"),a=s.get(o);0==--a._usedCounter&&(s.remove(o),a.dispose())}},r.prototype.getChar=function(i){if(1!==i.length)return null;var r=this._charInfos[i];if(r)return r;r=new e;var n=this._context.measureText(i),s=this.getSize(),o=Math.round(n.width);if(this._currentFreePosition.x+o+this._xMargin>s.width&&(this._currentFreePosition.x=0,this._currentFreePosition.y+=this._lineHeightSuper+this._yMargin,this._currentFreePosition.y>s.height))return this.getChar("!");if(this._signedDistanceField){this._sdfContext.clearRect(0,0,this._sdfCanvas.width,this._sdfCanvas.height),this._sdfContext.fillText(i,0,-this._offset);var a=this._sdfContext.getImageData(0,0,o*this._sdfScale,this._sdfCanvas.height),h=this._computeSDFChar(a);this._context.putImageData(h,this._currentFreePosition.x,this._currentFreePosition.y)}else this._context.fillText(i,this._currentFreePosition.x,this._currentFreePosition.y-this._offset);if(r.topLeftUV=new t.Vector2(this._currentFreePosition.x/s.width,this._currentFreePosition.y/s.height),r.bottomRightUV=new t.Vector2((this._currentFreePosition.x+o)/s.width,r.topLeftUV.y+(this._lineHeightSuper+2)/s.height),this._signedDistanceField){var l=1/s.width;r.topLeftUV.addInPlace(new t.Vector2(l,l)),r.bottomRightUV.addInPlace(new t.Vector2(l,l))}return r.charWidth=this._superSample?o/2:o,this._charInfos[i]=r,this._curCharCount++,this._currentFreePosition.x+=o+this._xMargin,r},r.prototype._computeSDFChar=function(t){for(var e=this._sdfScale,i=t.width,r=t.height,n=i/e,s=r/e,o=0,a=0,h=e,l=h-1,c=function(n,s,h,l,c){var u=n*e,p=s*e;if(u+h<0||u+h>=i||p+l<0||p+l>=r)return!0;var d=t.data[4*((p+l)*i+(u+h))],f=d>0===c;return f||(o=h,a=l),f},u=function(t,e,i){if(c(t,e,0,l,i)&&c(t,e,0,-l,i)&&c(t,e,-l,0,i)&&c(t,e,l,0,i))return 0;for(var r=1;r<=h;r++){if(!(c(t,e,0,r,i)&&c(t,e,0,-r,i)&&c(t,e,-r,0,i)&&c(t,e,r,0,i)))return r*r;for(var n=1;n<=r;n++)if(!(c(t,e,-n,r,i)&&c(t,e,n,r,i)&&c(t,e,r,-n,i)&&c(t,e,r,n,i)&&c(t,e,-n,-r,i)&&c(t,e,n,-r,i)&&c(t,e,-r,-n,i)&&c(t,e,-r,n,i))){var s=r*r+n*n,u=1;return c(t,e,o-1,a,i)||(s+=(o-1)*(o-1)+a*a,++u),c(t,e,o+1,a,i)||(s+=(o+1)*(o+1)+a*a,++u),c(t,e,o,a-1,i)||(s+=o*o+(a-1)*(a-1),++u),c(t,e,o,a+1,i)||(s+=o*o+(a+1)*(a+1),++u),c(t,e,o-1,a-1,i)||(s+=(o-1)*(o-1)+(a-1)*(a-1),++u),c(t,e,o+1,a+1,i)||(s+=(o+1)*(o+1)+(a+1)*(a+1),++u),c(t,e,o+1,a-1,i)||(s+=(o+1)*(o+1)+(a-1)*(a-1),++u),c(t,e,o-1,a+1,i)||(s+=(o-1)*(o-1)+(a+1)*(a+1),++u),s/u}}return 0},p=new Array(n*s),d=0;d<s;d++)for(var f=0;f<n;f++){var m=c(f,d,0,0,!0),_=u(f,d,m);0===_&&(_=h*h*2),p[d*n+f]=m?_:-_}for(var g=this._context.createImageData(n,s),y=n*s,v=0;v<y;v++){var _=p[v],x=_<0?-1:1;_=Math.sqrt(Math.abs(_))*x,_*=127.5/h,_+=127.5,_<0?_=0:_>255&&(_=255),_+=.5,g.data[4*v+0]=_,g.data[4*v+1]=_,g.data[4*v+2]=_,g.data[4*v+3]=255}return g},r.prototype.measureText=function(e,i){void 0===i&&(i=4);for(var r=0,n=0,s=1,o=0,a=0,h=e;a<h.length;a++){var l=h[a];if("\n"!==l)if("\t"!==l)l<" "||(n+=this.getChar(l).charWidth,++o);else{var c=o+i;c-=c%i,n+=(c-o)*this.spaceWidth,o=c}else r=Math.max(r,n),o=0,n=0,++s}return r=Math.max(r,n),new t.Size(r,s*this.lineHeight)},r.prototype.getSuperSampleFont=function(t){var e=/^\s*(?=(?:(?:[-a-z]+\s*){0,2}(italic|oblique))?)(?=(?:(?:[-a-z]+\s*){0,2}(small-caps))?)(?=(?:(?:[-a-z]+\s*){0,2}(bold(?:er)?|lighter|[1-9]00))?)(?:(?:normal|\1|\2|\3)\s*){0,3}((?:xx?-)?(?:small|large)|medium|smaller|larger|[.\d]+(?:\%|in|[cem]m|ex|p[ctx]))(?:\s*\/\s*(normal|[.\d]+(?:\%|in|[cem]m|ex|p[ctx])))?\s*([-,\"\sa-z]+?)\s*$/,i=t.toLocaleLowerCase().match(e);if(null==i)return null;var r=parseInt(i[4]);i[4]=(2*r).toString()+(i[4].match(/\D+/)||[]).pop();for(var n="",s=1;s<i.length;s++)null!=i[s]&&(n+=i[s]+" ");return n},r.prototype.getFontHeight=function(t){var e=document.createElement("canvas"),i=e.getContext("2d");i.fillRect(0,0,e.width,e.height),i.textBaseline="top",i.fillStyle="white",i.font=t,i.fillText("jH|",0,0);for(var r=i.getImageData(0,0,e.width,e.height).data,n=-1,s=-1,o=0;o<e.height;o++)for(var a=0;a<e.width;a++){var h=4*(o*e.width+a);{if(0!==r[h]){n===-1&&(n=o);break}if(a===e.width-1&&n!==-1){s=o,o=e.height;break}}}return{height:s-n+1,offset:n-1}},Object.defineProperty(r.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),r.prototype.getContext=function(){return this._context},r.prototype.update=function(){this._lastUpdateCharCount<this._curCharCount&&(this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,!1,!0),this._lastUpdateCharCount=this._curCharCount)},r.prototype.clone=function(){return null},r.prototype.incCachedFontTextureCounter=function(){++this._usedCounter},r.prototype.decCachedFontTextureCounter=function(){var t=this.getScene(),e=t.__fontTextureCache__;e&&0==--this._usedCounter&&(e.remove(this._cachedFontId),this.dispose())},r}(t.Texture);t.FontTexture=i}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){void 0===s&&(s=t.Texture.TRILINEAR_SAMPLINGMODE),void 0===o&&(o=!1),e.call(this,null,r,!o,!1,s),this.name=i,this._size=n,this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._rectPackingMap=new t.RectPackingMap(new t.Size(n.width,n.height)),this._texture=r.getEngine().createRenderTargetTexture(n,{generateMipMaps:!this.noMipmap,type:t.Engine.TEXTURETYPE_UNSIGNED_INT})}return o(i,e),i.prototype.allocateRect=function(t){return this._rectPackingMap.addRect(t)},i.prototype.freeRect=function(t){t&&t.freeContent()},Object.defineProperty(i.prototype,"freeSpace",{get:function(){return this._rectPackingMap.freeSpace},enumerable:!0,configurable:!0}),i.prototype.bindTextureForRect=function(t,e){return this.bindTextureForPosSize(t.pos,t.contentSize,e)},i.prototype.bindTextureForPosSize=function(e,i,r){var n=this.getScene().getEngine();n.bindFramebuffer(this._texture),this._replacedViewport=n.setDirectViewport(e.x,e.y,i.width,i.height),r&&n.scissorClear(e.x,e.y,i.width,i.height,new t.Color4(0,0,0,0))},i.prototype.unbindTexture=function(e){e&&t.Tools.DumpFramebuffer(this._size.width,this._size.height,this.getScene().getEngine());var i=this.getScene().getEngine();this._replacedViewport&&(i.setViewport(this._replacedViewport),this._replacedViewport=null),i.unBindFramebuffer(this._texture)},Object.defineProperty(i.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.clone=function(){return null},i}(t.Texture);t.MapTexture=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s){e.call(this,i,r),this._textures={},this._textureArrays={},this._floats={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._matrices3x3={},this._matrices2x2={},this._vectors3Arrays={},this._cachedWorldViewMatrix=new t.Matrix,this._shaderPath=n,s.needAlphaBlending=s.needAlphaBlending||!1,s.needAlphaTesting=s.needAlphaTesting||!1,s.attributes=s.attributes||["position","normal","uv"],s.uniforms=s.uniforms||["worldViewProjection"],s.samplers=s.samplers||[],s.defines=s.defines||[],this._options=s}return o(i,e),i.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},i.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},i.prototype._checkUniform=function(t){this._options.uniforms.indexOf(t)===-1&&this._options.uniforms.push(t)},i.prototype.setTexture=function(t,e){return this._options.samplers.indexOf(t)===-1&&this._options.samplers.push(t),this._textures[t]=e,this},i.prototype.setTextureArray=function(t,e){return this._options.samplers.indexOf(t)===-1&&this._options.samplers.push(t),this._checkUniform(t),this._textureArrays[t]=e,this},i.prototype.setFloat=function(t,e){return this._checkUniform(t),this._floats[t]=e,this},i.prototype.setFloats=function(t,e){return this._checkUniform(t),this._floatsArrays[t]=e,this},i.prototype.setColor3=function(t,e){return this._checkUniform(t),this._colors3[t]=e,this},i.prototype.setColor4=function(t,e){return this._checkUniform(t),this._colors4[t]=e,this},i.prototype.setVector2=function(t,e){return this._checkUniform(t),this._vectors2[t]=e,this},i.prototype.setVector3=function(t,e){return this._checkUniform(t),this._vectors3[t]=e,this},i.prototype.setVector4=function(t,e){return this._checkUniform(t),this._vectors4[t]=e,this},i.prototype.setMatrix=function(t,e){return this._checkUniform(t),this._matrices[t]=e,this},i.prototype.setMatrix3x3=function(t,e){return this._checkUniform(t),this._matrices3x3[t]=e,this},i.prototype.setMatrix2x2=function(t,e){return this._checkUniform(t),this._matrices2x2[t]=e,this},i.prototype.setArray3=function(t,e){return this._checkUniform(t),this._vectors3Arrays[t]=e,this},i.prototype._checkCache=function(t,e,i){return!e||(this._effect&&this._effect.defines.indexOf("#define INSTANCES"),!1)},i.prototype.isReady=function(e,i){var r=this.getScene(),n=r.getEngine();if(!this.checkReadyOnEveryCall&&this._renderId===r.getRenderId()&&this._checkCache(r,e,i))return!0;var s=[],o=new t.EffectFallbacks;i&&s.push("#define INSTANCES");for(var a=0;a<this._options.defines.length;a++)s.push(this._options.defines[a]);e&&e.useBones&&e.computeBonesUsingShaders&&(s.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),s.push("#define BonesPerMesh "+(e.skeleton.bones.length+1)),o.addCPUSkinningFallback(0,e)),n.getAlphaTesting()&&s.push("#define ALPHATEST");var h=this._effect,l=s.join("\n");return this._effect=n.createEffect(this._shaderPath,this._options.attributes,this._options.uniforms,this._options.samplers,l,o,this.onCompiled,this.onError),!!this._effect.isReady()&&(h!==this._effect&&r.resetCachedMaterial(),this._renderId=r.getRenderId(),!0)},i.prototype.bindOnlyWorldMatrix=function(t){var e=this.getScene();this._options.uniforms.indexOf("world")!==-1&&this._effect.setMatrix("world",t),this._options.uniforms.indexOf("worldView")!==-1&&(t.multiplyToRef(e.getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&this._effect.setMatrix("worldViewProjection",t.multiply(e.getTransformMatrix()))},i.prototype.bind=function(i,r){if(this.bindOnlyWorldMatrix(i),this.getScene().getCachedMaterial()!==this){this._options.uniforms.indexOf("view")!==-1&&this._effect.setMatrix("view",this.getScene().getViewMatrix()),this._options.uniforms.indexOf("projection")!==-1&&this._effect.setMatrix("projection",this.getScene().getProjectionMatrix()),this._options.uniforms.indexOf("viewProjection")!==-1&&this._effect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),t.MaterialHelper.BindBonesParameters(r,this._effect);var n;for(n in this._textures)this._effect.setTexture(n,this._textures[n]);for(n in this._textureArrays)this._effect.setTextureArray(n,this._textureArrays[n]);for(n in this._floats)this._effect.setFloat(n,this._floats[n]);for(n in this._floatsArrays)this._effect.setArray(n,this._floatsArrays[n]);for(n in this._colors3)this._effect.setColor3(n,this._colors3[n]);for(n in this._colors4){var s=this._colors4[n];this._effect.setFloat4(n,s.r,s.g,s.b,s.a)}for(n in this._vectors2)this._effect.setVector2(n,this._vectors2[n]);for(n in this._vectors3)this._effect.setVector3(n,this._vectors3[n]);for(n in this._vectors4)this._effect.setVector4(n,this._vectors4[n]);for(n in this._matrices)this._effect.setMatrix(n,this._matrices[n]);for(n in this._matrices3x3)this._effect.setMatrix3x3(n,this._matrices3x3[n]);for(n in this._matrices2x2)this._effect.setMatrix2x2(n,this._matrices2x2[n]);for(n in this._vectors3Arrays)this._effect.setArray3(n,this._vectors3Arrays[n])}e.prototype.bind.call(this,i,r)},i.prototype.clone=function(t){return new i(t,this.getScene(),this._shaderPath,this._options)},i.prototype.dispose=function(t,i){if(i){var r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays)for(var n=this._textureArrays[r],s=0;s<n.length;s++)n[s].dispose()}this._textures={},e.prototype.dispose.call(this,t,i)},i.prototype.serialize=function(){var e=t.SerializationHelper.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.options=this._options,e.shaderPath=this._shaderPath;var i;e.textures={};for(i in this._textures)e.textures[i]=this._textures[i].serialize();e.textureArrays={};for(i in this._textureArrays){e.textureArrays[i]=[];for(var r=this._textureArrays[i],n=0;n<r.length;n++)e.textureArrays[i].push(r[n].serialize())}e.floats={};for(i in this._floats)e.floats[i]=this._floats[i];e.floatArrays={};for(i in this._floatsArrays)e.floatArrays[i]=this._floatsArrays[i];e.colors3={};for(i in this._colors3)e.colors3[i]=this._colors3[i].asArray();e.colors4={};for(i in this._colors4)e.colors4[i]=this._colors4[i].asArray();e.vectors2={};for(i in this._vectors2)e.vectors2[i]=this._vectors2[i].asArray();e.vectors3={};for(i in this._vectors3)e.vectors3[i]=this._vectors3[i].asArray();e.vectors4={};for(i in this._vectors4)e.vectors4[i]=this._vectors4[i].asArray();e.matrices={};for(i in this._matrices)e.matrices[i]=this._matrices[i].asArray();e.matrices3x3={};for(i in this._matrices3x3)e.matrices3x3[i]=this._matrices3x3[i];e.matrices2x2={};for(i in this._matrices2x2)e.matrices2x2[i]=this._matrices2x2[i];e.vectors3Arrays={};for(i in this._vectors3Arrays)e.vectors3Arrays[i]=this._vectors3Arrays[i];return e},i.Parse=function(e,r,n){var s,o=t.SerializationHelper.Parse(function(){return new i(e.name,r,e.shaderPath,e.options)},e,r,n);for(s in e.textures)o.setTexture(s,t.Texture.Parse(e.textures[s],r,n));for(s in e.textureArrays){for(var a=e.textureArrays[s],h=new Array,l=0;l<a.length;l++)h.push(t.Texture.Parse(a[l],r,n));o.setTextureArray(s,h)}for(s in e.floats)o.setFloat(s,e.floats[s]);for(s in e.floatsArrays)o.setFloats(s,e.floatsArrays[s]);for(s in e.colors3)o.setColor3(s,t.Color3.FromArray(e.colors3[s]));for(s in e.colors4)o.setColor4(s,t.Color4.FromArray(e.colors4[s]));for(s in e.vectors2)o.setVector2(s,t.Vector2.FromArray(e.vectors2[s]));for(s in e.vectors3)o.setVector3(s,t.Vector3.FromArray(e.vectors3[s]));for(s in e.vectors4)o.setVector4(s,t.Vector4.FromArray(e.vectors4[s]));for(s in e.matrices)o.setMatrix(s,t.Matrix.FromArray(e.matrices[s]));for(s in e.matrices3x3)o.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)o.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors3Arrays)o.setArray3(s,e.vectors3Arrays[s]);return o},i}(t.Material);t.ShaderMaterial=e}(r||(r={}));var r;!function(t){!function(e){function i(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function r(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}var n=542327876,s=131072,o=512,a=4,h=64,l=131072,c=i("DXT1"),u=i("DXT3"),p=i("DXT5"),d=31,f=0,m=1,_=2,g=3,y=4,v=7,x=20,b=21,P=22,T=28,S=function(){function e(){}return e.GetDDSInfo=function(t){var e=new Int32Array(t,0,d),i=1;return e[_]&s&&(i=Math.max(1,e[v])),{width:e[y],height:e[g],mipmapCount:i,isFourCC:(e[x]&a)===a,isRGB:(e[x]&h)===h,isLuminance:(e[x]&l)===l,isCube:(e[T]&o)===o}},e.GetRGBAArrayBuffer=function(t,e,i,r,n){for(var s=new Uint8Array(r),o=new Uint8Array(n),a=0,h=e-1;h>=0;h--)for(var l=0;l<t;l++){var c=i+4*(l+h*t);s[a+2]=o[c],s[a+1]=o[c+1],s[a]=o[c+2],s[a+3]=o[c+3],a+=4}return s},e.GetRGBArrayBuffer=function(t,e,i,r,n){for(var s=new Uint8Array(r),o=new Uint8Array(n),a=0,h=e-1;h>=0;h--)for(var l=0;l<t;l++){var c=i+3*(l+h*t);s[a+2]=o[c],s[a+1]=o[c+1],s[a]=o[c+2],a+=3}return s},e.GetLuminanceArrayBuffer=function(t,e,i,r,n){for(var s=new Uint8Array(r),o=new Uint8Array(n),a=0,h=e-1;h>=0;h--)for(var l=0;l<t;l++){var c=i+(l+h*t);s[a]=o[c],a++}return s},e.UploadDDSLevels=function(i,o,a,h,l,x){var T,S,A,C,E,M,D,R,I,O,w=new Int32Array(a,0,d);if(w[f]!=n)return void t.Tools.Error("Invalid magic number in DDS header");if(!h.isFourCC&&!h.isRGB&&!h.isLuminance)return void t.Tools.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(h.isFourCC)switch(T=w[b]){case c:S=8,A=o.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case u:S=16,A=o.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case p:S=16,A=o.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return void console.error("Unsupported FourCC code:",r(T))}I=1,w[_]&s&&l!==!1&&(I=Math.max(1,w[v]));for(var L=w[P],F=0;F<x;F++){var V=1===x?i.TEXTURE_2D:i.TEXTURE_CUBE_MAP_POSITIVE_X+F;for(C=w[y],E=w[g],D=w[m]+4,O=0;O<I;++O){if(h.isRGB)24===L?(M=C*E*3,R=e.GetRGBArrayBuffer(C,E,D,M,a),i.texImage2D(V,O,i.RGB,C,E,0,i.RGB,i.UNSIGNED_BYTE,R)):(M=C*E*4,R=e.GetRGBAArrayBuffer(C,E,D,M,a),i.texImage2D(V,O,i.RGBA,C,E,0,i.RGBA,i.UNSIGNED_BYTE,R));else if(h.isLuminance){var N=i.getParameter(i.UNPACK_ALIGNMENT),z=C,B=Math.floor((C+N-1)/N)*N;M=B*(E-1)+z,R=e.GetLuminanceArrayBuffer(C,E,D,M,a),i.texImage2D(V,O,i.LUMINANCE,C,E,0,i.LUMINANCE,i.UNSIGNED_BYTE,R)}else M=Math.max(4,C)/4*Math.max(4,E)/4*S,R=new Uint8Array(a,D,M),i.compressedTexImage2D(V,O,A,C,E,0,R);D+=M,C*=.5,E*=.5,C=Math.max(1,C),E=Math.max(1,E)}}},e}();e.DDSTools=S}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){if(void 0===e&&(e=!0),void 0===i&&(i=10),this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=[],this._fixedTimeStep=1/60,this._currentCollisionGroup=2,this._minus90X=new t.Quaternion(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new t.Quaternion(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=t.Vector3.Zero(),this._tmpQuaternion=new t.Quaternion,this._tmpDeltaPosition=t.Vector3.Zero(),this._tmpDeltaRotation=new t.Quaternion,this._tmpUnityRotation=new t.Quaternion,!this.isSupported())return void t.Tools.Error("CannonJS is not available. Please make sure you included the js file.");this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.solver.iterations=i}return e.prototype.setGravity=function(t){this.world.gravity.copy(t)},e.prototype.setTimeStep=function(t){this._fixedTimeStep=t},e.prototype.executeStep=function(t,e){this.world.step(this._fixedTimeStep,this._useDeltaForWorldStep?1e3*t:0,3)},e.prototype.applyImpulse=function(t,e,i){var r=new CANNON.Vec3(i.x,i.y,i.z),n=new CANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyImpulse(n,r)},e.prototype.applyForce=function(t,e,i){var r=new CANNON.Vec3(i.x,i.y,i.z),n=new CANNON.Vec3(e.x,e.y,e.z);t.physicsBody.applyImpulse(n,r)},e.prototype.generatePhysicsBody=function(t){if(t.parent)return void(t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate()));if(t.isBodyInitRequired()){var e=this._createShape(t),i=t.physicsBody;i&&this.removePhysicsBody(t);var r=this._addMaterial("mat-"+t.uniqueId,t.getParam("friction"),t.getParam("restitution")),n={mass:t.getParam("mass"),material:r},s=t.getParam("nativeOptions");for(var o in s)s.hasOwnProperty(o)&&(n[o]=s[o]);t.physicsBody=new CANNON.Body(n),t.physicsBody.addEventListener("collide",t.onCollide),this.world.addEventListener("preStep",t.beforeStep),this.world.addEventListener("postStep",t.afterStep),t.physicsBody.addShape(e),this.world.add(t.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(e){t.physicsBody[e].copy(i[e])}),this._processChildMeshes(t)}this._updatePhysicsBodyTransformation(t)},e.prototype._processChildMeshes=function(e){var i=this,r=e.object.getChildMeshes?e.object.getChildMeshes():[];if(r.length){var n=function t(r,n){var s=n.getPhysicsImpostor();if(s){if(s.parent!==e){var r=n.position;s.physicsBody&&(i.removePhysicsBody(s),s.physicsBody=null),s.parent=e,s.resetUpdateFlags(),e.physicsBody.addShape(i._createShape(s),new CANNON.Vec3(r.x,r.y,r.z)),e.physicsBody.mass+=s.getParam("mass")}}n.getChildMeshes().forEach(t.bind(i,n.position))};r.forEach(n.bind(this,t.Vector3.Zero()))}},e.prototype.removePhysicsBody=function(t){t.physicsBody.removeEventListener("collide",t.onCollide),this.world.removeEventListener("preStep",t.beforeStep),this.world.removeEventListener("postStep",t.afterStep),this.world.remove(t.physicsBody)},e.prototype.generateJoint=function(e){var i=e.mainImpostor.physicsBody,r=e.connectedImpostor.physicsBody;if(i&&r){var n,s=e.joint.jointData,o={pivotA:s.mainPivot?(new CANNON.Vec3).copy(s.mainPivot):null,pivotB:s.connectedPivot?(new CANNON.Vec3).copy(s.connectedPivot):null,axisA:s.mainAxis?(new CANNON.Vec3).copy(s.mainAxis):null,axisB:s.connectedAxis?(new CANNON.Vec3).copy(s.connectedAxis):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case t.PhysicsJoint.HingeJoint:case t.PhysicsJoint.Hinge2Joint:n=new CANNON.HingeConstraint(i,r,o);break;case t.PhysicsJoint.DistanceJoint:n=new CANNON.DistanceConstraint(i,r,s.maxDistance||2);break;case t.PhysicsJoint.SpringJoint:var a=s;n=new CANNON.Spring(i,r,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break;case t.PhysicsJoint.LockJoint:n=new CANNON.LockConstraint(i,r,o);break;case t.PhysicsJoint.PointToPointJoint:case t.PhysicsJoint.BallAndSocketJoint:default:n=new CANNON.PointToPointConstraint(i,o.pivotA,r,o.pivotA,o.maxForce)}n.collideConnected=!!s.collision,e.joint.physicsJoint=n,e.joint.type!==t.PhysicsJoint.SpringJoint?this.world.addConstraint(n):e.mainImpostor.registerAfterPhysicsStep(function(){n.applyForce()})}},e.prototype.removeJoint=function(t){this.world.removeConstraint(t.joint.physicsJoint)},e.prototype._addMaterial=function(t,e,i){var r,n;for(r=0;r<this._physicsMaterials.length;r++)if(n=this._physicsMaterials[r],n.friction===e&&n.restitution===i)return n;var s=new CANNON.Material(t);return s.friction=e,s.restitution=i,this._physicsMaterials.push(s),s},e.prototype._checkWithEpsilon=function(e){return e<t.PhysicsEngine.Epsilon?t.PhysicsEngine.Epsilon:e},e.prototype._createShape=function(e){var i,r=e.object,n=e.getObjectExtendSize();switch(e.type){case t.PhysicsEngine.SphereImpostor:var s=n.x,o=n.y,a=n.z;i=new CANNON.Sphere(Math.max(this._checkWithEpsilon(s),this._checkWithEpsilon(o),this._checkWithEpsilon(a))/2);break;case t.PhysicsImpostor.CylinderImpostor:i=new CANNON.Cylinder(this._checkWithEpsilon(n.x)/2,this._checkWithEpsilon(n.x)/2,this._checkWithEpsilon(n.y),16);break;case t.PhysicsImpostor.BoxImpostor:var h=n.scale(.5);i=new CANNON.Box(new CANNON.Vec3(this._checkWithEpsilon(h.x),this._checkWithEpsilon(h.y),this._checkWithEpsilon(h.z)));break;case t.PhysicsImpostor.PlaneImpostor:t.Tools.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new CANNON.Plane;break;case t.PhysicsImpostor.MeshImpostor:var l=r.getVerticesData?r.getVerticesData(t.VertexBuffer.PositionKind):[],c=r.getIndices?r.getIndices():[];t.Tools.Warn("MeshImpostor only collides against spheres."),i=new CANNON.Trimesh(l,c);break;case t.PhysicsImpostor.HeightmapImpostor:i=this._createHeightmap(r);break;case t.PhysicsImpostor.ParticleImpostor:i=new CANNON.Particle}return i},e.prototype._createHeightmap=function(e,i){for(var r=e.getVerticesData(t.VertexBuffer.PositionKind),n=[],s=i||~~(Math.sqrt(r.length/3)-1),o=Math.min(e.getBoundingInfo().boundingBox.extendSize.x,e.getBoundingInfo().boundingBox.extendSize.z),a=2*o/s,h=e.getBoundingInfo().boundingBox.extendSize.y,l=0;l<r.length;l+=3){var c=Math.round(r[l+0]/a+s/2),u=Math.round((r[l+2]/a-s/2)*-1),p=r[l+1]+h;n[c]||(n[c]=[]),n[c][u]||(n[c][u]=p),n[c][u]=Math.max(p,n[c][u])}for(var c=0;c<=s;++c){if(!n[c]){for(var d=1;!n[(c+d)%s];)d++;n[c]=n[(c+d)%s].slice()}for(var u=0;u<=s;++u)if(!n[c][u]){for(var f,d=1;void 0===f;)f=n[c][(u+d++)%s];n[c][u]=f}}var m=new CANNON.Heightfield(n,{elementSize:a});return m.minY=h,m},e.prototype._updatePhysicsBodyTransformation=function(e){var i=e.object;i.computeWorldMatrix&&i.computeWorldMatrix(!0);var r=e.getObjectCenter();e.getObjectExtendSize();this._tmpDeltaPosition.copyFrom(i.position.subtract(r)),this._tmpPosition.copyFrom(r);var n=i.rotationQuaternion;if(e.type!==t.PhysicsImpostor.PlaneImpostor&&e.type!==t.PhysicsImpostor.HeightmapImpostor&&e.type!==t.PhysicsImpostor.CylinderImpostor||(n=n.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===t.PhysicsEngine.HeightmapImpostor){var s=i,o=s.rotationQuaternion;s.rotationQuaternion=this._tmpUnityRotation,s.computeWorldMatrix(!0);var a=r.clone(),h=s.getPivotMatrix()||t.Matrix.Translation(0,0,0);s.rotationQuaternion=o;var l=t.Matrix.Translation(s.getBoundingInfo().boundingBox.extendSize.x,0,-s.getBoundingInfo().boundingBox.extendSize.z);s.setPivotMatrix(l),s.computeWorldMatrix(!0);var c=s.getBoundingInfo().boundingBox.center.subtract(r).subtract(s.position).negate();this._tmpPosition.copyFromFloats(c.x,c.y-s.getBoundingInfo().boundingBox.extendSize.y,c.z),this._tmpDeltaPosition.copyFrom(s.getBoundingInfo().boundingBox.center.subtract(a)),this._tmpDeltaPosition.y+=s.getBoundingInfo().boundingBox.extendSize.y,s.setPivotMatrix(h),s.computeWorldMatrix(!0)}else e.type===t.PhysicsEngine.MeshImpostor&&(this._tmpDeltaPosition.copyFromFloats(0,0,0),this._tmpPosition.copyFrom(i.position));e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.copy(this._tmpPosition),e.physicsBody.quaternion.copy(n)},e.prototype.setTransformationFromPhysicsBody=function(t){t.object.position.copyFrom(t.physicsBody.position),t.object.rotationQuaternion.copyFrom(t.physicsBody.quaternion)},e.prototype.setPhysicsBodyTransformation=function(t,e,i){t.physicsBody.position.copy(e),t.physicsBody.quaternion.copy(i)},e.prototype.isSupported=function(){return void 0!==window.CANNON},e.prototype.setLinearVelocity=function(t,e){t.physicsBody.velocity.copy(e)},e.prototype.setAngularVelocity=function(t,e){t.physicsBody.angularVelocity.copy(e)},e.prototype.getLinearVelocity=function(e){var i=e.physicsBody.velocity;return i?new t.Vector3(i.x,i.y,i.z):null},e.prototype.getAngularVelocity=function(e){var i=e.physicsBody.angularVelocity;return i?new t.Vector3(i.x,i.y,i.z):null},e.prototype.setBodyMass=function(t,e){t.physicsBody.mass=e,t.physicsBody.updateMassProperties()},e.prototype.sleepBody=function(t){t.physicsBody.sleep()},e.prototype.wakeUpBody=function(t){t.physicsBody.wakeUp()},e.prototype.updateDistanceJoint=function(t,e,i){t.physicsJoint.distance=e},e.prototype.enableMotor=function(t,e){e||t.physicsJoint.enableMotor()},e.prototype.disableMotor=function(t,e){e||t.physicsJoint.disableMotor()},e.prototype.setMotor=function(t,e,i,r){r||(t.physicsJoint.enableMotor(),t.physicsJoint.setMotorSpeed(e),i&&this.setLimit(t,i))},e.prototype.setLimit=function(t,e,i){t.physicsJoint.motorEquation.maxForce=e,t.physicsJoint.motorEquation.minForce=void 0===i?-e:i},e.prototype.dispose=function(){},e}();t.CannonJSPlugin=e}(r||(r={}));var r;!function(t){var e=function(){function e(e){this.name="OimoJSPlugin",this._tmpImpostorsArray=[],this._tmpPositionVector=t.Vector3.Zero(),this.world=new OIMO.World(1/60,2,e,!0),this.world.worldscale(1),this.world.clear(),this.world.isNoStat=!0}return e.prototype.setGravity=function(t){this.world.gravity.copy(t)},e.prototype.setTimeStep=function(t){this.world.timeStep=t},e.prototype.executeStep=function(t,e){var i=this;e.forEach(function(t){t.beforeStep()}),this.world.step(),e.forEach(function(t){t.afterStep(),i._tmpImpostorsArray[t.uniqueId]=t});for(var r=this.world.contacts;null!==r;)if(!r.touching||r.body1.sleeping||r.body2.sleeping){var n=this._tmpImpostorsArray[+r.body1.name],s=this._tmpImpostorsArray[+r.body2.name];n&&s?(n.onCollide({body:s.physicsBody}),s.onCollide({body:n.physicsBody}),r=r.next):r=r.next}else r=r.next},e.prototype.applyImpulse=function(t,e,i){var r=t.physicsBody.massInfo.mass;t.physicsBody.applyImpulse(i.scale(OIMO.INV_SCALE),e.scale(OIMO.INV_SCALE*r))},e.prototype.applyForce=function(e,i,r){t.Tools.Warn("Oimo doesn't support applying force. Using impule instead."),this.applyImpulse(e,i,r)},e.prototype.generatePhysicsBody=function(e){var i=this;if(e.parent)return void(e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate()));if(e.isBodyInitRequired()){var r={name:e.uniqueId,config:[e.getParam("mass")||1,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],rot:[],move:0!==e.getParam("mass"),world:this.world},n=[e];(function(t){t.getChildMeshes&&t.getChildMeshes().forEach(function(t){t.physicsImpostor&&(n.push(t.physicsImpostor),t.physicsImpostor._init())})})(e.object);var s=function(e){return Math.max(e,t.PhysicsEngine.Epsilon)};n.forEach(function(n){var o=n.object.rotationQuaternion,a=(new OIMO.Euler).setFromQuaternion({x:e.object.rotationQuaternion.x,y:e.object.rotationQuaternion.y,z:e.object.rotationQuaternion.z,s:e.object.rotationQuaternion.w}),h=n.getObjectExtendSize();if(n===e){var l=e.getObjectCenter();e.object.position.subtractToRef(l,i._tmpPositionVector),r.pos.push(l.x),r.pos.push(l.y),r.pos.push(l.z),r.rot.push(a.x/(OIMO.degtorad||OIMO.TO_RAD)),r.rot.push(a.y/(OIMO.degtorad||OIMO.TO_RAD)),r.rot.push(a.z/(OIMO.degtorad||OIMO.TO_RAD))}else r.pos.push(n.object.position.x),r.pos.push(n.object.position.y),r.pos.push(n.object.position.z),r.rot.push(0),r.rot.push(0),r.rot.push(0);switch(n.type){case t.PhysicsImpostor.ParticleImpostor:t.Tools.Warn("No Particle support in Oimo.js. using SphereImpostor instead");case t.PhysicsImpostor.SphereImpostor:var c=h.x,u=h.y,p=h.z,d=Math.max(s(c),s(u),s(p))/2;r.type.push("sphere"),r.size.push(d),r.size.push(d),r.size.push(d);break;case t.PhysicsImpostor.CylinderImpostor:var f=s(h.x)/2,m=s(h.y);r.type.push("cylinder"),r.size.push(f),r.size.push(m),r.size.push(m);break;case t.PhysicsImpostor.PlaneImpostor:case t.PhysicsImpostor.BoxImpostor:default:var f=s(h.x),m=s(h.y),_=s(h.z);r.type.push("box"),r.size.push(f),r.size.push(m),r.size.push(_)}n.object.rotationQuaternion=o}),e.physicsBody=new OIMO.Body(r).body}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)},e.prototype.removePhysicsBody=function(t){this.world.removeRigidBody(t.physicsBody)},e.prototype.generateJoint=function(e){var i=e.mainImpostor.physicsBody,r=e.connectedImpostor.physicsBody;if(i&&r){var n,s=e.joint.jointData,o=s.nativeParams||{},a={body1:i,body2:r,axe1:o.axe1||(s.mainAxis?s.mainAxis.asArray():null),axe2:o.axe2||(s.connectedAxis?s.connectedAxis.asArray():null),pos1:o.pos1||(s.mainPivot?s.mainPivot.asArray():null),pos2:o.pos2||(s.connectedPivot?s.connectedPivot.asArray():null),min:o.min,max:o.max,collision:o.collision||s.collision,spring:o.spring,world:this.world};switch(e.joint.type){case t.PhysicsJoint.BallAndSocketJoint:n="jointBall";break;case t.PhysicsJoint.SpringJoint:t.Tools.Warn("Oimo.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");var h=s;a.min=h.length||a.min,a.max=Math.max(a.min,a.max);case t.PhysicsJoint.DistanceJoint:n="jointDistance",a.max=s.maxDistance;break;case t.PhysicsJoint.PrismaticJoint:n="jointPrisme";break;case t.PhysicsJoint.SliderJoint:n="jointSlide";break;case t.PhysicsJoint.WheelJoint:n="jointWheel";break;case t.PhysicsJoint.HingeJoint:default:n="jointHinge"}a.type=n,e.joint.physicsJoint=new OIMO.Link(a).joint}},e.prototype.removeJoint=function(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){t.Tools.Warn(e)}},e.prototype.isSupported=function(){return void 0!==OIMO},e.prototype.setTransformationFromPhysicsBody=function(t){if(!t.physicsBody.sleeping){if(t.physicsBody.shapes.next){var e=this._getLastShape(t.physicsBody);t.object.position.x=e.position.x*OIMO.WORLD_SCALE,t.object.position.y=e.position.y*OIMO.WORLD_SCALE,t.object.position.z=e.position.z*OIMO.WORLD_SCALE}else t.object.position.copyFrom(t.physicsBody.getPosition());t.object.rotationQuaternion.copyFrom(t.physicsBody.getQuaternion()),t.object.rotationQuaternion.normalize()}},e.prototype.setPhysicsBodyTransformation=function(t,e,i){var r=t.physicsBody;r.position.init(e.x*OIMO.INV_SCALE,e.y*OIMO.INV_SCALE,e.z*OIMO.INV_SCALE),r.orientation.init(i.w,i.x,i.y,i.z),r.syncShapes(),r.awake()},e.prototype._getLastShape=function(t){for(var e=t.shapes;e.next;)e=e.next;return e},e.prototype.setLinearVelocity=function(t,e){t.physicsBody.linearVelocity.init(e.x,e.y,e.z)},e.prototype.setAngularVelocity=function(t,e){t.physicsBody.angularVelocity.init(e.x,e.y,e.z)},e.prototype.getLinearVelocity=function(e){var i=e.physicsBody.linearVelocity;return i?new t.Vector3(i.x,i.y,i.z):null},e.prototype.getAngularVelocity=function(e){var i=e.physicsBody.angularVelocity;return i?new t.Vector3(i.x,i.y,i.z):null},e.prototype.setBodyMass=function(t,e){var i=0===e;t.physicsBody.shapes.density=i?1:e,t.physicsBody.setupMass(i?2:1)},e.prototype.sleepBody=function(t){t.physicsBody.sleep()},e.prototype.wakeUpBody=function(t){t.physicsBody.awake()},e.prototype.updateDistanceJoint=function(t,e,i){t.physicsJoint.limitMotor.upperLimit=e,void 0!==i&&(t.physicsJoint.limitMotor.lowerLimit=i)},e.prototype.setMotor=function(t,e,i,r){var n=r?t.physicsJoint.rotationalLimitMotor2:t.physicsJoint.rotationalLimitMotor1||t.physicsJoint.rotationalLimitMotor||t.physicsJoint.limitMotor;n&&n.setMotor(e,i)},e.prototype.setLimit=function(t,e,i,r){var n=r?t.physicsJoint.rotationalLimitMotor2:t.physicsJoint.rotationalLimitMotor1||t.physicsJoint.rotationalLimitMotor||t.physicsJoint.limitMotor;n&&n.setLimit(e,void 0===i?-e:i)},e.prototype.dispose=function(){this.world.clear()},e}();t.OimoJSPlugin=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o){t.call(this,e,"displayPass",["passSampler"],["passSampler"],i,r,n,s,o)}return o(e,t),e}(t.PostProcess);t.DisplayPassPostProcess=e}(r||(r={}));var r;!function(t){var e=function(){function t(t,e,i){this.quality=t,this.distance=e,this.optimizeMesh=i}return t}();t.SimplificationSettings=e;var i=function(){function e(){this.running=!1,this._simplificationArray=[]}return e.prototype.addTask=function(t){this._simplificationArray.push(t)},e.prototype.executeNext=function(){var t=this._simplificationArray.pop();t?(this.running=!0,this.runSimplification(t)):this.running=!1},e.prototype.runSimplification=function(e){var i=this;if(e.parallelProcessing)e.settings.forEach(function(t){i.getSimplifier(e).simplify(t,function(r){e.mesh.addLODLevel(t.distance,r),r.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),i.executeNext()})});else{var r=this.getSimplifier(e),n=function(t,i){r.simplify(t,function(r){e.mesh.addLODLevel(t.distance,r),r.isVisible=!0,i()})};t.AsyncLoop.Run(e.settings.length,function(t){n(e.settings[t.index],function(){t.executeNext()})},function(){e.successCallback&&e.successCallback(),i.executeNext()})}},e.prototype.getSimplifier=function(t){switch(t.simplificationType){case r.QUADRATIC:default:return new h(t.mesh)}},e}();t.SimplificationQueue=i,function(t){t[t.QUADRATIC=0]="QUADRATIC"}(t.SimplificationType||(t.SimplificationType={}));var r=t.SimplificationType,n=function(){function t(t){this.vertices=t,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}return t}();t.DecimationTriangle=n;var s=function(){function t(t,e){this.position=t,this.id=e,this.isBorder=!0,this.q=new o,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}return t.prototype.updatePosition=function(t){this.position.copyFrom(t)},t}();t.DecimationVertex=s;var o=function(){function t(t){this.data=new Array(10);for(var e=0;e<10;++e)t&&t[e]?this.data[e]=t[e]:this.data[e]=0}return t.prototype.det=function(t,e,i,r,n,s,o,a,h){return this.data[t]*this.data[n]*this.data[h]+this.data[i]*this.data[r]*this.data[a]+this.data[e]*this.data[s]*this.data[o]-this.data[i]*this.data[n]*this.data[o]-this.data[t]*this.data[s]*this.data[a]-this.data[e]*this.data[r]*this.data[h]},t.prototype.addInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t.data[e]},t.prototype.addArrayInPlace=function(t){for(var e=0;e<10;++e)this.data[e]+=t[e]},t.prototype.add=function(e){for(var i=new t,r=0;r<10;++r)i.data[r]=this.data[r]+e.data[r];return i},t.FromData=function(e,i,r,n){return new t(t.DataFromNumbers(e,i,r,n))},t.DataFromNumbers=function(t,e,i,r){return[t*t,t*e,t*i,t*r,e*e,e*i,e*r,i*i,i*r,r*r]},t}();t.QuadraticMatrix=o;var a=function(){function t(t,e){this.vertexId=t,this.triangleId=e}return t}();t.Reference=a;var h=function(){function e(e){this._mesh=e,this.initialized=!1,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=t.Epsilon}return e.prototype.simplify=function(e,i){var r=this;this.initDecimatedMesh(),t.AsyncLoop.Run(this._mesh.subMeshes.length,function(t){r.initWithMesh(t.index,function(){r.runDecimation(e,t.index,function(){t.executeNext()})},e.optimizeMesh)},function(){setTimeout(function(){i(r._reconstructedMesh)},0)})},e.prototype.isTriangleOnBoundingBox=function(t){var e=this,i=0;return t.vertices.forEach(function(t){var r=0,n=t.position,s=e._mesh.getBoundingInfo().boundingBox;(s.maximum.x-n.x<e.boundingBoxEpsilon||n.x-s.minimum.x>e.boundingBoxEpsilon)&&++r,s.maximum.y!==n.y&&n.y!==s.minimum.y||++r,s.maximum.z!==n.z&&n.z!==s.minimum.z||++r,r>1&&++i}),i>1&&console.log(t,i),i>1},e.prototype.runDecimation=function(e,i,r){var n=this,s=~~(this.triangles.length*e.quality),o=0,a=this.triangles.length,h=function(e,i){setTimeout(function(){e%5==0&&n.updateMesh(0===e);for(var r=0;r<n.triangles.length;++r)n.triangles[r].isDirty=!1;var h=1e-9*Math.pow(e+3,n.aggressiveness),l=function(e){var i=~~((n.triangles.length/2+e)%n.triangles.length),r=n.triangles[i];if(r&&!(r.error[3]>h||r.deleted||r.isDirty))for(var s=0;s<3;++s)if(r.error[s]<h){var a=[],l=[],c=r.vertices[s],u=r.vertices[(s+1)%3];if(c.isBorder||u.isBorder)continue;var p=t.Vector3.Zero(),d=t.Vector3.Zero(),f=t.Vector2.Zero(),m=new t.Color4(0,0,0,1);n.calculateError(c,u,p,d,f,m);var _=[];if(n.isFlipped(c,u,p,a,r.borderFactor,_))continue;if(n.isFlipped(u,c,p,l,r.borderFactor,_))continue;if(a.indexOf(!0)<0||l.indexOf(!0)<0)continue;var g=[];if(_.forEach(function(t){g.indexOf(t)===-1&&(t.deletePending=!0,g.push(t))}),g.length%2!=0)continue;c.q=u.q.add(c.q),c.updatePosition(p);var y=n.references.length;o=n.updateTriangles(c,c,a,o),o=n.updateTriangles(c,u,l,o);var v=n.references.length-y;if(v<=c.triangleCount){if(v)for(var x=0;x<v;x++)n.references[c.triangleStart+x]=n.references[y+x]}else c.triangleStart=y;c.triangleCount=v;break}};t.AsyncLoop.SyncAsyncForLoop(n.triangles.length,n.syncIterations,l,i,function(){return a-o<=s})},0)};t.AsyncLoop.Run(this.decimationIterations,function(t){a-o<=s?t.breakLoop():h(t.index,function(){t.executeNext()})},function(){setTimeout(function(){n.reconstructMesh(i),r()},0)})},e.prototype.initWithMesh=function(e,i,r){var o=this;this.vertices=[],this.triangles=[];var a=this._mesh.getVerticesData(t.VertexBuffer.PositionKind),h=this._mesh.getIndices(),l=this._mesh.subMeshes[e],c=function(t){if(r)for(var e=0;e<o.vertices.length;++e)if(o.vertices[e].position.equals(t))return o.vertices[e];return null},u=[],p=function(e){var i=e+l.verticesStart,r=t.Vector3.FromArray(a,3*i),n=c(r)||new s(r,o.vertices.length);n.originalOffsets.push(i),n.id===o.vertices.length&&o.vertices.push(n),u.push(n.id)},d=l.verticesCount;t.AsyncLoop.SyncAsyncForLoop(d,this.syncIterations/4>>0,p,function(){var e=function(t){var e=l.indexStart/3+t,i=3*e,r=h[i+0],s=h[i+1],a=h[i+2],c=o.vertices[u[r-l.verticesStart]],p=o.vertices[u[s-l.verticesStart]],d=o.vertices[u[a-l.verticesStart]],f=new n([c,p,d]);f.originalOffset=i,o.triangles.push(f)};t.AsyncLoop.SyncAsyncForLoop(l.indexCount/3,o.syncIterations,e,function(){o.init(i)})})},e.prototype.init=function(e){var i=this,r=function(e){var r=i.triangles[e];r.normal=t.Vector3.Cross(r.vertices[1].position.subtract(r.vertices[0].position),r.vertices[2].position.subtract(r.vertices[0].position)).normalize();for(var n=0;n<3;n++)r.vertices[n].q.addArrayInPlace(o.DataFromNumbers(r.normal.x,r.normal.y,r.normal.z,-t.Vector3.Dot(r.normal,r.vertices[0].position)))};t.AsyncLoop.SyncAsyncForLoop(this.triangles.length,this.syncIterations,r,function(){var r=function(t){for(var e=i.triangles[t],r=0;r<3;++r)e.error[r]=i.calculateError(e.vertices[r],e.vertices[(r+1)%3]);e.error[3]=Math.min(e.error[0],e.error[1],e.error[2])};t.AsyncLoop.SyncAsyncForLoop(i.triangles.length,i.syncIterations,r,function(){i.initialized=!0,e()})})},e.prototype.reconstructMesh=function(e){var i,r=[];for(i=0;i<this.vertices.length;++i)this.vertices[i].triangleCount=0;var n,s;for(i=0;i<this.triangles.length;++i)if(!this.triangles[i].deleted){for(n=this.triangles[i],s=0;s<3;++s)n.vertices[s].triangleCount=1;r.push(n)}var o=this._reconstructedMesh.getVerticesData(t.VertexBuffer.PositionKind)||[],a=this._reconstructedMesh.getVerticesData(t.VertexBuffer.NormalKind)||[],h=this._reconstructedMesh.getVerticesData(t.VertexBuffer.UVKind)||[],l=this._reconstructedMesh.getVerticesData(t.VertexBuffer.ColorKind)||[],c=this._mesh.getVerticesData(t.VertexBuffer.NormalKind),u=this._mesh.getVerticesData(t.VertexBuffer.UVKind),p=this._mesh.getVerticesData(t.VertexBuffer.ColorKind),d=0;for(i=0;i<this.vertices.length;++i){var f=this.vertices[i];f.id=d,f.triangleCount&&f.originalOffsets.forEach(function(t){o.push(f.position.x),o.push(f.position.y),o.push(f.position.z),a.push(c[3*t]),a.push(c[3*t+1]),a.push(c[3*t+2]),u&&u.length?(h.push(u[2*t]),h.push(u[2*t+1])):p&&p.length&&(l.push(p[4*t]),l.push(p[4*t+1]),l.push(p[4*t+2]),l.push(p[4*t+3])),++d})}var m=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),g=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];var y=this._reconstructedMesh.getIndices(),v=this._mesh.getIndices();for(i=0;i<r.length;++i)n=r[i],[0,1,2].forEach(function(t){var e=v[n.originalOffset+t],i=n.vertices[t].originalOffsets.indexOf(e);i<0&&(i=0),y.push(n.vertices[t].id+i+_)});this._reconstructedMesh.setIndices(y),this._reconstructedMesh.setVerticesData(t.VertexBuffer.PositionKind,o),this._reconstructedMesh.setVerticesData(t.VertexBuffer.NormalKind,a),h.length>0&&this._reconstructedMesh.setVerticesData(t.VertexBuffer.UVKind,h),l.length>0&&this._reconstructedMesh.setVerticesData(t.VertexBuffer.ColorKind,l);var x=this._mesh.subMeshes[e];if(e>0){this._reconstructedMesh.subMeshes=[],g.forEach(function(e){new t.SubMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())});new t.SubMesh(x.materialIndex,_,d,m,3*r.length,this._reconstructedMesh)}},e.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new t.Mesh(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId},e.prototype.isFlipped=function(e,i,r,n,s,o){for(var a=0;a<e.triangleCount;++a){var h=this.triangles[this.references[e.triangleStart+a].triangleId];if(!h.deleted){var l=this.references[e.triangleStart+a].vertexId,c=h.vertices[(l+1)%3],u=h.vertices[(l+2)%3];if(c!==i&&u!==i){var p=c.position.subtract(r);p=p.normalize();var d=u.position.subtract(r);if(d=d.normalize(),Math.abs(t.Vector3.Dot(p,d))>.999)return!0;var f=t.Vector3.Cross(p,d).normalize();if(n[a]=!1,t.Vector3.Dot(f,h.normal)<.2)return!0}else n[a]=!0,o.push(h)}}return!1},e.prototype.updateTriangles=function(t,e,i,r){for(var n=r,s=0;s<e.triangleCount;++s){var o=this.references[e.triangleStart+s],a=this.triangles[o.triangleId];a.deleted||(i[s]&&a.deletePending?(a.deleted=!0,n++):(a.vertices[o.vertexId]=t,a.isDirty=!0,a.error[0]=this.calculateError(a.vertices[0],a.vertices[1])+a.borderFactor/2,a.error[1]=this.calculateError(a.vertices[1],a.vertices[2])+a.borderFactor/2,a.error[2]=this.calculateError(a.vertices[2],a.vertices[0])+a.borderFactor/2,a.error[3]=Math.min(a.error[0],a.error[1],a.error[2]),this.references.push(o)))}return n},e.prototype.identifyBorder=function(){for(var t=0;t<this.vertices.length;++t){var e,i=[],r=[],n=this.vertices[t];for(e=0;e<n.triangleCount;++e)for(var s=this.triangles[this.references[n.triangleStart+e].triangleId],o=0;o<3;o++){for(var a=0,h=s.vertices[o];a<i.length&&r[a]!==h.id;)++a;a===i.length?(i.push(1),r.push(h.id)):i[a]++}for(e=0;e<i.length;++e)1===i[e]?this.vertices[r[e]].isBorder=!0:this.vertices[r[e]].isBorder=!1}},e.prototype.updateMesh=function(t){void 0===t&&(t=!1);var e;if(!t){var i=[];for(e=0;e<this.triangles.length;++e)this.triangles[e].deleted||i.push(this.triangles[e]);this.triangles=i}for(e=0;e<this.vertices.length;++e)this.vertices[e].triangleCount=0,this.vertices[e].triangleStart=0;var r,n,s;for(e=0;e<this.triangles.length;++e)for(r=this.triangles[e],n=0;n<3;++n)s=r.vertices[n],s.triangleCount++;var o=0;for(e=0;e<this.vertices.length;++e)this.vertices[e].triangleStart=o,o+=this.vertices[e].triangleCount,this.vertices[e].triangleCount=0;var h=new Array(3*this.triangles.length);for(e=0;e<this.triangles.length;++e)for(r=this.triangles[e],n=0;n<3;++n)s=r.vertices[n],h[s.triangleStart+s.triangleCount]=new a(n,e),s.triangleCount++;this.references=h,t&&this.identifyBorder()},e.prototype.vertexError=function(t,e){var i=e.x,r=e.y,n=e.z;return t.data[0]*i*i+2*t.data[1]*i*r+2*t.data[2]*i*n+2*t.data[3]*i+t.data[4]*r*r+2*t.data[5]*r*n+2*t.data[6]*r+t.data[7]*n*n+2*t.data[8]*n+t.data[9]},e.prototype.calculateError=function(e,i,r,n,s,o){var a=e.q.add(i.q),h=e.isBorder&&i.isBorder,l=0,c=a.det(0,1,2,1,4,5,2,5,7);if(0===c||h){var u=e.position.add(i.position).divide(new t.Vector3(2,2,2)),p=this.vertexError(a,e.position),d=this.vertexError(a,i.position),f=this.vertexError(a,u);l=Math.min(p,d,f),l===p?r&&r.copyFrom(e.position):l===d?r&&r.copyFrom(i.position):r&&r.copyFrom(u)}else r||(r=t.Vector3.Zero()),r.x=-1/c*a.det(1,2,3,4,5,6,5,7,8),r.y=1/c*a.det(0,2,3,1,5,6,2,7,8),r.z=-1/c*a.det(0,1,3,1,4,6,2,5,8),l=this.vertexError(a,r);return l},e}();t.QuadraticErrorSimplification=h}(r||(r={}));var r;!function(t){var e=[],i=function(i,r){if(!e[i.id]&&!i.doNotSerialize){if(i instanceof t.Geometry.Primitives.Box)r.boxes.push(i.serialize());else if(i instanceof t.Geometry.Primitives.Sphere)r.spheres.push(i.serialize());else if(i instanceof t.Geometry.Primitives.Cylinder)r.cylinders.push(i.serialize());else if(i instanceof t.Geometry.Primitives.Torus)r.toruses.push(i.serialize());else if(i instanceof t.Geometry.Primitives.Ground)r.grounds.push(i.serialize());else if(i instanceof t.Geometry.Primitives.Plane)r.planes.push(i.serialize());else if(i instanceof t.Geometry.Primitives.TorusKnot)r.torusKnots.push(i.serialize());else{if(i instanceof t.Geometry.Primitives._Primitive)throw new Error("Unknown primitive type");r.vertexData.push(i.serializeVerticeData())}e[i.id]=!0}},r=function(e,r){var n={};n.name=e.name,n.id=e.id,t.Tags.HasTags(e)&&(n.tags=t.Tags.GetTags(e)),n.position=e.position.asArray(),e.rotationQuaternion?n.rotationQuaternion=e.rotationQuaternion.asArray():e.rotation&&(n.rotation=e.rotation.asArray()),n.scaling=e.scaling.asArray(),n.localMatrix=e.getPivotMatrix().asArray(),n.isEnabled=e.isEnabled(),n.isVisible=e.isVisible,n.infiniteDistance=e.infiniteDistance,n.pickable=e.isPickable,n.receiveShadows=e.receiveShadows,n.billboardMode=e.billboardMode,n.visibility=e.visibility,n.checkCollisions=e.checkCollisions,n.isBlocker=e.isBlocker,e.parent&&(n.parentId=e.parent.id);var s=e._geometry;if(s){var o=s.id;n.geometryId=o,e.getScene().getGeometryByID(o)||i(s,r.geometries),n.subMeshes=[];for(var a=0;a<e.subMeshes.length;a++){var h=e.subMeshes[a];n.subMeshes.push({materialIndex:h.materialIndex,verticesStart:h.verticesStart,verticesCount:h.verticesCount,indexStart:h.indexStart,indexCount:h.indexCount})}}e.material?n.materialId=e.material.id:e.material=null,e.skeleton&&(n.skeletonId=e.skeleton.id),e.getPhysicsImpostor()&&(n.physicsMass=e.getPhysicsMass(),n.physicsFriction=e.getPhysicsFriction(),n.physicsRestitution=e.getPhysicsRestitution(),n.physicsImpostor=e.getPhysicsImpostor().type),e.metadata&&(n.metadata=e.metadata),n.instances=[];for(var l=0;l<e.instances.length;l++){var c=e.instances[l],u={name:c.name,position:c.position.asArray(),scaling:c.scaling.asArray()};c.rotationQuaternion?u.rotationQuaternion=c.rotationQuaternion.asArray():c.rotation&&(u.rotation=c.rotation.asArray()),n.instances.push(u),t.Animation.AppendSerializedAnimations(c,u),u.ranges=c.serializeAnimationRanges()}return t.Animation.AppendSerializedAnimations(e,n),n.ranges=e.serializeAnimationRanges(),n.layerMask=e.layerMask,n.alphaIndex=e.alphaIndex,n.hasVertexAlpha=e.hasVertexAlpha,n.overlayAlpha=e.overlayAlpha,n.overlayColor=e.overlayColor.asArray(),n.renderOverlay=e.renderOverlay,n.applyFog=e.applyFog,e.actionManager&&(n.actions=e.actionManager.serialize(e.name)),n},n=function(e,n){if(e.delayLoadState===t.Engine.DELAYLOADSTATE_LOADED||e.delayLoadState===t.Engine.DELAYLOADSTATE_NONE){e.material&&(e.material instanceof t.StandardMaterial?(n.materials=n.materials||[],n.materials.some(function(t){return t.id===e.material.id})||n.materials.push(e.material.serialize())):e.material instanceof t.MultiMaterial&&(n.multiMaterials=n.multiMaterials||[],n.multiMaterials.some(function(t){return t.id===e.material.id})||n.multiMaterials.push(e.material.serialize())));var s=e._geometry;s&&(n.geometries||(n.geometries={},n.geometries.boxes=[],n.geometries.spheres=[],n.geometries.cylinders=[],n.geometries.toruses=[],n.geometries.grounds=[],n.geometries.planes=[],n.geometries.torusKnots=[],n.geometries.vertexData=[]),i(s,n.geometries)),e.skeleton&&(n.skeletons=n.skeletons||[],n.skeletons.push(e.skeleton.serialize())),n.meshes=n.meshes||[],n.meshes.push(r(e,n))}},s=function(){function s(){}return s.ClearCache=function(){e=[]},s.Serialize=function(n){var s={};s.useDelayedTextureLoading=n.useDelayedTextureLoading,s.autoClear=n.autoClear,s.clearColor=n.clearColor.asArray(),s.ambientColor=n.ambientColor.asArray(),s.gravity=n.gravity.asArray(),s.collisionsEnabled=n.collisionsEnabled,s.workerCollisions=n.workerCollisions,n.fogMode&&0!==n.fogMode&&(s.fogMode=n.fogMode,s.fogColor=n.fogColor.asArray(),s.fogStart=n.fogStart,s.fogEnd=n.fogEnd,s.fogDensity=n.fogDensity),n.isPhysicsEnabled()&&(s.physicsEnabled=!0,s.physicsGravity=n.getPhysicsEngine().gravity.asArray(),s.physicsEngine=n.getPhysicsEngine().getPhysicsPluginName()),n.metadata&&(s.metadata=n.metadata),s.lights=[];var o,a;for(o=0;o<n.lights.length;o++)a=n.lights[o],a.doNotSerialize||s.lights.push(a.serialize());for(s.cameras=[],o=0;o<n.cameras.length;o++){var h=n.cameras[o];h.doNotSerialize||s.cameras.push(h.serialize())}n.activeCamera&&(s.activeCameraID=n.activeCamera.id),t.Animation.AppendSerializedAnimations(n,s),s.materials=[],s.multiMaterials=[];var l;for(o=0;o<n.materials.length;o++)l=n.materials[o],l.doNotSerialize||s.materials.push(l.serialize());for(s.multiMaterials=[],o=0;o<n.multiMaterials.length;o++){var c=n.multiMaterials[o];s.multiMaterials.push(c.serialize())}for(s.skeletons=[],o=0;o<n.skeletons.length;o++)s.skeletons.push(n.skeletons[o].serialize());s.geometries={},s.geometries.boxes=[],s.geometries.spheres=[],s.geometries.cylinders=[],s.geometries.toruses=[],s.geometries.grounds=[],s.geometries.planes=[],s.geometries.torusKnots=[],s.geometries.vertexData=[],e=[];var u=n.getGeometries();for(o=0;o<u.length;o++){var p=u[o];p.isReady()&&i(p,s.geometries)}for(s.meshes=[],o=0;o<n.meshes.length;o++){var d=n.meshes[o];if(d instanceof t.Mesh){var f=d;f.doNotSerialize||f.delayLoadState!==t.Engine.DELAYLOADSTATE_LOADED&&f.delayLoadState!==t.Engine.DELAYLOADSTATE_NONE||s.meshes.push(r(f,s))}}for(s.particleSystems=[],o=0;o<n.particleSystems.length;o++)s.particleSystems.push(n.particleSystems[o].serialize());for(s.lensFlareSystems=[],o=0;o<n.lensFlareSystems.length;o++)s.lensFlareSystems.push(n.lensFlareSystems[o].serialize());for(s.shadowGenerators=[],o=0;o<n.lights.length;o++){a=n.lights[o];var m=a.getShadowGenerator();m&&m instanceof t.ShadowGenerator&&s.shadowGenerators.push(m.serialize())}for(n.actionManager&&(s.actions=n.actionManager.serialize("scene")),s.sounds=[],o=0;o<n.soundTracks.length;o++)for(var _=n.soundTracks[o],g=0;g<_.soundCollection.length;g++)s.sounds.push(_.soundCollection[g].serialize());return s},s.SerializeMesh=function(e,i,r){void 0===i&&(i=!1),void 0===r&&(r=!1);var s={};if(e=e instanceof Array?e:[e],i||r)for(var o=0;o<e.length;++o)r&&e[o].getDescendants().forEach(function(i){i instanceof t.Mesh&&e.indexOf(i)<0&&e.push(i)}),i&&e[o].parent&&e.indexOf(e[o].parent)<0&&e.push(e[o].parent);return e.forEach(function(t){n(t,s)}),s},s}();t.SceneSerializer=s}(r||(r={}));var a;!function(t){function e(t,e,r){r=r||2;var s=e&&e.length,o=s?e[0]*r:t.length,a=i(t,0,o,r,!0),h=[];if(!a)return h;var c,u,p,d,f,m,_;if(s&&(a=l(t,e,a,r)),t.length>80*r){c=p=t[0],u=d=t[1];for(var g=r;g<o;g+=r)f=t[g],m=t[g+1],f<c&&(c=f),m<u&&(u=m),f>p&&(p=f),m>d&&(d=m);_=Math.max(p-c,d-u)}return n(a,h,r,c,u,_,void 0),h}function i(t,e,i,r,n){var s,o;if(n===R(t,e,i,r)>0)for(s=e;s<i;s+=r)o=C(s,t[s],t[s+1],o);else for(s=i-r;s>=e;s-=r)o=C(s,t[s],t[s+1],o);return o&&x(o,o.next)&&(E(o),o=o.next),o}function r(t,e){if(!t)return t;e||(e=t);var i,r=t;do{if(i=!1,r.steiner||!x(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(E(r),(r=e=r.prev)===r.next)return null;i=!0}}while(i||r!==e);return e}function n(t,e,i,l,c,u,p){if(t){!p&&u&&d(t,l,c,u);for(var f,m,_=t;t.prev!==t.next;)if(f=t.prev,m=t.next,u?o(t,l,c,u):s(t))e.push(f.i/i),e.push(t.i/i),e.push(m.i/i),E(t),t=m.next,_=m.next;else if((t=m)===_){p?1===p?(t=a(t,e,i),n(t,e,i,l,c,u,2)):2===p&&h(t,e,i,l,c,u):n(r(t,void 0),e,i,l,c,u,1);break}}}function s(t){var e=t.prev,i=t,r=t.next;if(v(e,i,r)>=0)return!1;for(var n=t.next.next;n!==t.prev;){if(g(e.x,e.y,i.x,i.y,r.x,r.y,n.x,n.y)&&v(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function o(t,e,i,r){var n=t.prev,s=t,o=t.next;if(v(n,s,o)>=0)return!1;for(var a=n.x<s.x?n.x<o.x?n.x:o.x:s.x<o.x?s.x:o.x,h=n.y<s.y?n.y<o.y?n.y:o.y:s.y<o.y?s.y:o.y,l=n.x>s.x?n.x>o.x?n.x:o.x:s.x>o.x?s.x:o.x,c=n.y>s.y?n.y>o.y?n.y:o.y:s.y>o.y?s.y:o.y,u=m(a,h,e,i,r),p=m(l,c,e,i,r),d=t.nextZ;d&&d.z<=p;){if(d!==t.prev&&d!==t.next&&g(n.x,n.y,s.x,s.y,o.x,o.y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=u;){if(d!==t.prev&&d!==t.next&&g(n.x,n.y,s.x,s.y,o.x,o.y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function a(t,e,i){var r=t;do{var n=r.prev,s=r.next.next;!x(n,s)&&b(n,r,r.next,s)&&T(n,s)&&T(s,n)&&(e.push(n.i/i),e.push(r.i/i),e.push(s.i/i),E(r),E(r.next),r=t=s),r=r.next}while(r!==t);return r}function h(t,e,i,s,o,a){var h=t;do{for(var l=h.next.next;l!==h.prev;){if(h.i!==l.i&&y(h,l)){var c=A(h,l);return h=r(h,h.next),c=r(c,c.next),n(h,e,i,s,o,a,void 0),void n(c,e,i,s,o,a,void 0)}l=l.next}h=h.next}while(h!==t)}function l(t,e,n,s){var o,a,h,l,p,d=[];for(o=0,a=e.length;o<a;o++)h=e[o]*s,l=o<a-1?e[o+1]*s:t.length,p=i(t,h,l,s,!1),p===p.next&&(p.steiner=!0),d.push(_(p));for(d.sort(c),o=0;o<d.length;o++)u(d[o],n),n=r(n,n.next);return n}function c(t,e){return t.x-e.x}function u(t,e){if(e=p(t,e)){var i=A(e,t);r(i,i.next)}}function p(t,e){var i,r=e,n=t.x,s=t.y,o=-(1/0);do{if(s<=r.y&&s>=r.next.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=n&&a>o){if(o=a,a===n){if(s===r.y)return r;if(s===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!i)return null;if(n===o)return i.prev;var h,l=i,c=i.x,u=i.y,p=1/0;for(r=i.next;r!==l;)n>=r.x&&r.x>=c&&g(s<u?n:o,s,c,u,s<u?o:n,s,r.x,r.y)&&((h=Math.abs(s-r.y)/(n-r.x))<p||h===p&&r.x>i.x)&&T(r,t)&&(i=r,p=h),r=r.next;return i}function d(t,e,i,r){var n=t;do{null===n.z&&(n.z=m(n.x,n.y,e,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,f(n)}function f(t){var e,i,r,n,s,o,a,h,l=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,r=i,a=0,e=0;e<l&&(a++,r=r.nextZ);e++);for(h=l;a>0||h>0&&r;)0===a?(n=r,r=r.nextZ,h--):0!==h&&r?i.z<=r.z?(n=i,i=i.nextZ,a--):(n=r,r=r.nextZ,h--):(n=i,i=i.nextZ,a--),s?s.nextZ=n:t=n,n.prevZ=s,s=n;i=r}s.nextZ=null,l*=2}while(o>1);return t}function m(t,e,i,r,n){return t=32767*(t-i)/n,e=32767*(e-r)/n,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function _(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function g(t,e,i,r,n,s,o,a){return(n-o)*(e-a)-(t-o)*(s-a)>=0&&(t-o)*(r-a)-(i-o)*(e-a)>=0&&(i-o)*(s-a)-(n-o)*(r-a)>=0}function y(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!P(t,e)&&T(t,e)&&T(e,t)&&S(t,e)}function v(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function x(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,i,r){return!!(x(t,e)&&x(i,r)||x(t,r)&&x(i,e))||v(t,e,i)>0!=v(t,e,r)>0&&v(i,r,t)>0!=v(i,r,e)>0}function P(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&b(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}function T(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function S(t,e){var i=t,r=!1,n=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&n<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==t);return r}function A(t,e){var i=new M(t.i,t.x,t.y),r=new M(e.i,e.x,e.y),n=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=n,n.prev=i,r.next=i,i.prev=r,s.next=r,r.prev=s,r}function C(t,e,i,r){var n=new M(t,e,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function E(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function M(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function D(t,e,i,r){var n=e&&e.length,s=n?e[0]*i:t.length,o=Math.abs(R(t,0,s,i));if(n)for(var a=0,h=e.length;a<h;a++){var l=e[a]*i,c=a<h-1?e[a+1]*i:t.length;o-=Math.abs(R(t,l,c,i))}var u=0;for(a=0;a<r.length;a+=3){var p=r[a]*i,d=r[a+1]*i,f=r[a+2]*i;u+=Math.abs((t[p]-t[f])*(t[d+1]-t[p+1])-(t[p]-t[d])*(t[f+1]-t[p+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)}function R(t,e,i,r){for(var n=0,s=e,o=i-r;s<i;s+=r)n+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return n}function I(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},r=0,n=0;n<t.length;n++){for(var s=0;s<t[n].length;s++)for(var o=0;o<e;o++)i.vertices.push(t[n][s][o]);n>0&&(r+=t[n-1].length,i.holes.push(r))}return i}t.earcut=e,t.deviation=D,t.flatten=I}(a||(a={}));var r;!function(t){var e=0,i=function(){function e(t,e,i){this.pos=t,this.normal=e,this.uv=i}return e.prototype.clone=function(){return new e(this.pos.clone(),this.normal.clone(),this.uv.clone())},e.prototype.flip=function(){this.normal=this.normal.scale(-1)},e.prototype.interpolate=function(i,r){return new e(t.Vector3.Lerp(this.pos,i.pos,r),t.Vector3.Lerp(this.normal,i.normal,r),t.Vector2.Lerp(this.uv,i.uv,r))},e}(),r=function(){function e(t,e){this.normal=t,this.w=e}return e.FromPoints=function(i,r,n){var s=n.subtract(i),o=r.subtract(i);if(0===s.lengthSquared()||0===o.lengthSquared())return null;var a=t.Vector3.Normalize(t.Vector3.Cross(s,o));return new e(a,t.Vector3.Dot(a,i))},e.prototype.clone=function(){return new e(this.normal.clone(),this.w)},e.prototype.flip=function(){this.normal.scaleInPlace(-1),this.w=-this.w},e.prototype.splitPolygon=function(i,r,s,o,a){var h,l,c=0,u=1,p=2,d=3,f=0,m=[];for(h=0;h<i.vertices.length;h++){l=t.Vector3.Dot(this.normal,i.vertices[h].pos)-this.w;var _=l<-e.EPSILON?p:l>e.EPSILON?u:c;f|=_,m.push(_)}switch(f){case c:(t.Vector3.Dot(this.normal,i.plane.normal)>0?r:s).push(i);break;case u:o.push(i);break;case p:a.push(i);break;case d:var g=[],y=[];for(h=0;h<i.vertices.length;h++){var v=(h+1)%i.vertices.length,x=m[h],b=m[v],P=i.vertices[h],T=i.vertices[v];if(x!==p&&g.push(P),x!==u&&y.push(x!==p?P.clone():P),(x|b)===d){l=(this.w-t.Vector3.Dot(this.normal,P.pos))/t.Vector3.Dot(this.normal,T.pos.subtract(P.pos));var S=P.interpolate(T,l);g.push(S),y.push(S.clone())}}var A;g.length>=3&&(A=new n(g,i.shared),A.plane&&o.push(A)),y.length>=3&&(A=new n(y,i.shared),A.plane&&a.push(A))}},e.EPSILON=1e-5,e}(),n=function(){function t(t,e){this.vertices=t,this.shared=e,this.plane=r.FromPoints(t[0].pos,t[1].pos,t[2].pos)}return t.prototype.clone=function(){return new t(this.vertices.map(function(t){return t.clone()}),this.shared)},t.prototype.flip=function(){this.vertices.reverse().map(function(t){t.flip()}),this.plane.flip()},t}(),s=function(){function t(t){this.plane=null,this.front=null,this.back=null,this.polygons=[],t&&this.build(t)}return t.prototype.clone=function(){var e=new t;return e.plane=this.plane&&this.plane.clone(),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.polygons=this.polygons.map(function(t){return t.clone()}),e},t.prototype.invert=function(){for(var t=0;t<this.polygons.length;t++)this.polygons[t].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var e=this.front;this.front=this.back,this.back=e},t.prototype.clipPolygons=function(t){if(!this.plane)return t.slice();for(var e=[],i=[],r=0;r<t.length;r++)this.plane.splitPolygon(t[r],e,i,e,i);return this.front&&(e=this.front.clipPolygons(e)),i=this.back?this.back.clipPolygons(i):[],e.concat(i)},t.prototype.clipTo=function(t){this.polygons=t.clipPolygons(this.polygons),this.front&&this.front.clipTo(t),this.back&&this.back.clipTo(t)},t.prototype.allPolygons=function(){var t=this.polygons.slice();return this.front&&(t=t.concat(this.front.allPolygons())),this.back&&(t=t.concat(this.back.allPolygons())),t},t.prototype.build=function(e){if(e.length){this.plane||(this.plane=e[0].plane.clone());for(var i=[],r=[],n=0;n<e.length;n++)this.plane.splitPolygon(e[n],this.polygons,this.polygons,i,r);i.length&&(this.front||(this.front=new t),this.front.build(i)),r.length&&(this.back||(this.back=new t),this.back.build(r))}},t}(),o=function(){function r(){this.polygons=new Array}return r.FromMesh=function(s){var o,a,h,l,c,u,p,d,f,m,_,g=new Array;if(!(s instanceof t.Mesh))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";s.computeWorldMatrix(!0),p=s.getWorldMatrix(),d=s.position.clone(),f=s.rotation.clone(),s.rotationQuaternion&&(m=s.rotationQuaternion.clone()),_=s.scaling.clone();for(var y=s.getIndices(),v=s.getVerticesData(t.VertexBuffer.PositionKind),x=s.getVerticesData(t.VertexBuffer.NormalKind),b=s.getVerticesData(t.VertexBuffer.UVKind),P=s.subMeshes,T=0,S=P.length;T<S;T++)for(var A=P[T].indexStart,C=P[T].indexCount+P[T].indexStart;A<C;A+=3){u=[];for(var E=0;E<3;E++){var M=new t.Vector3(x[3*y[A+E]],x[3*y[A+E]+1],x[3*y[A+E]+2]);h=new t.Vector2(b[2*y[A+E]],b[2*y[A+E]+1]);var D=new t.Vector3(v[3*y[A+E]],v[3*y[A+E]+1],v[3*y[A+E]+2]);l=t.Vector3.TransformCoordinates(D,p),a=t.Vector3.TransformNormal(M,p),o=new i(l,a,h),u.push(o)}c=new n(u,{subMeshId:T,meshId:e,materialIndex:P[T].materialIndex}),c.plane&&g.push(c)}var R=r.FromPolygons(g);return R.matrix=p,R.position=d,R.rotation=f,R.scaling=_,R.rotationQuaternion=m,e++,R},r.FromPolygons=function(t){var e=new r;return e.polygons=t,e},r.prototype.clone=function(){var t=new r;return t.polygons=this.polygons.map(function(t){return t.clone()}),t.copyTransformAttributes(this),t},r.prototype.toPolygons=function(){return this.polygons},r.prototype.union=function(t){var e=new s(this.clone().polygons),i=new s(t.clone().polygons);return e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),r.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},r.prototype.unionInPlace=function(t){var e=new s(this.polygons),i=new s(t.polygons);e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),this.polygons=e.allPolygons()},r.prototype.subtract=function(t){var e=new s(this.clone().polygons),i=new s(t.clone().polygons);return e.invert(),e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),e.invert(),r.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},r.prototype.subtractInPlace=function(t){var e=new s(this.polygons),i=new s(t.polygons);e.invert(),e.clipTo(i),i.clipTo(e),i.invert(),i.clipTo(e),i.invert(),e.build(i.allPolygons()),e.invert(),this.polygons=e.allPolygons()},r.prototype.intersect=function(t){var e=new s(this.clone().polygons),i=new s(t.clone().polygons);return e.invert(),i.clipTo(e),i.invert(),e.clipTo(i),i.clipTo(e),e.build(i.allPolygons()),e.invert(),r.FromPolygons(e.allPolygons()).copyTransformAttributes(this)},r.prototype.intersectInPlace=function(t){var e=new s(this.polygons),i=new s(t.polygons);e.invert(),i.clipTo(e),i.invert(),e.clipTo(i),i.clipTo(e),e.build(i.allPolygons()),e.invert(),this.polygons=e.allPolygons()},r.prototype.inverse=function(){var t=this.clone();return t.inverseInPlace(),t},r.prototype.inverseInPlace=function(){this.polygons.map(function(t){t.flip()})},r.prototype.copyTransformAttributes=function(t){return this.matrix=t.matrix,this.position=t.position,this.rotation=t.rotation,this.scaling=t.scaling,this.rotationQuaternion=t.rotationQuaternion,this},r.prototype.buildMeshGeometry=function(e,i,r){var n=this.matrix.clone();n.invert();var s,o,a,h=new t.Mesh(e,i),l=[],c=[],u=[],p=[],d=t.Vector3.Zero(),f=t.Vector3.Zero(),m=t.Vector2.Zero(),_=this.polygons,g=[0,0,0],y={},v=0,x={};r&&_.sort(function(t,e){return t.shared.meshId===e.shared.meshId?t.shared.subMeshId-e.shared.subMeshId:t.shared.meshId-e.shared.meshId});for(var b=0,P=_.length;b<P;b++){s=_[b],x[s.shared.meshId]||(x[s.shared.meshId]={}),x[s.shared.meshId][s.shared.subMeshId]||(x[s.shared.meshId][s.shared.subMeshId]={indexStart:+(1/0),indexEnd:-(1/0),materialIndex:s.shared.materialIndex}),a=x[s.shared.meshId][s.shared.subMeshId];for(var T=2,S=s.vertices.length;T<S;T++){g[0]=0,g[1]=T-1,g[2]=T;for(var A=0;A<3;A++){d.copyFrom(s.vertices[g[A]].pos),f.copyFrom(s.vertices[g[A]].normal),m.copyFrom(s.vertices[g[A]].uv);var C=t.Vector3.TransformCoordinates(d,n),E=t.Vector3.TransformNormal(f,n);o=y[C.x+","+C.y+","+C.z],void 0!==o&&u[3*o]===E.x&&u[3*o+1]===E.y&&u[3*o+2]===E.z&&p[2*o]===m.x&&p[2*o+1]===m.y||(l.push(C.x,C.y,C.z),p.push(m.x,m.y),u.push(f.x,f.y,f.z),o=y[C.x+","+C.y+","+C.z]=l.length/3-1),c.push(o),a.indexStart=Math.min(v,a.indexStart),a.indexEnd=Math.max(v,a.indexEnd),v++}}}if(h.setVerticesData(t.VertexBuffer.PositionKind,l),h.setVerticesData(t.VertexBuffer.NormalKind,u),h.setVerticesData(t.VertexBuffer.UVKind,p),h.setIndices(c),r){var M,D=0;h.subMeshes=new Array;for(var R in x){M=-1;for(var I in x[R])a=x[R][I],t.SubMesh.CreateFromIndices(a.materialIndex+D,a.indexStart,a.indexEnd-a.indexStart+1,h),M=Math.max(a.materialIndex,M);D+=++M}}return h},r.prototype.toMesh=function(t,e,i,r){var n=this.buildMeshGeometry(t,i,r);return n.material=e,n.position.copyFrom(this.position),n.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(n.rotationQuaternion=this.rotationQuaternion.clone()),n.scaling.copyFrom(this.scaling),n.computeWorldMatrix(!0),n},r}();t.CSG=o}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s){var o=this;e.call(this,i,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,r,t.Texture.BILINEAR_SAMPLINGMODE,null,null),this._isRightEye=n,this._distortionFactors=s.distortionK,this._postProcessScaleFactor=s.postProcessScaleFactor,this._lensCenterOffset=s.lensCenterOffset,this.onSizeChangedObservable.add(function(){o.aspectRatio=.5*o.width/o.height,o._scaleIn=new t.Vector2(2,2/o.aspectRatio),o._scaleFactor=new t.Vector2(1/o._postProcessScaleFactor*.5,1/o._postProcessScaleFactor*.5*o.aspectRatio),o._lensCenter=new t.Vector2(o._isRightEye?.5-.5*o._lensCenterOffset:.5+.5*o._lensCenterOffset,.5)}),this.onApplyObservable.add(function(t){t.setFloat2("LensCenter",o._lensCenter.x,o._lensCenter.y),t.setFloat2("Scale",o._scaleFactor.x,o._scaleFactor.y),t.setFloat2("ScaleIn",o._scaleIn.x,o._scaleIn.y),t.setFloat4("HmdWarpParam",o._distortionFactors[0],o._distortionFactors[1],o._distortionFactors[2],o._distortionFactors[3])})}return o(i,e),i}(t.PostProcess);t.VRDistortionCorrectionPostProcess=e}(r||(r={}));var r;!function(t){!function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"}(t.JoystickAxis||(t.JoystickAxis={}));var e=t.JoystickAxis,i=function(){function i(r){var n=this;this._leftJoystick=!!r,this._joystickIndex=i._globalJoystickIndex,i._globalJoystickIndex++,this._axisTargetedByLeftAndRight=e.X,this._axisTargetedByUpAndDown=e.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new t.StringDictionary,this.deltaPosition=t.Vector3.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._rotationSpeed=25,this._inverseRotationSpeed=1/(this._rotationSpeed/1e3),this._rotateOnAxisRelativeToMesh=!1,this._onResize=function(t){i.vjCanvasWidth=window.innerWidth,i.vjCanvasHeight=window.innerHeight,i.vjCanvas.width=i.vjCanvasWidth,i.vjCanvas.height=i.vjCanvasHeight,i.halfWidth=i.vjCanvasWidth/2,i.halfHeight=i.vjCanvasHeight/2},i.vjCanvas||(window.addEventListener("resize",this._onResize,!1),i.vjCanvas=document.createElement("canvas"),i.vjCanvasWidth=window.innerWidth,i.vjCanvasHeight=window.innerHeight,i.vjCanvas.width=window.innerWidth,i.vjCanvas.height=window.innerHeight,i.vjCanvas.style.width="100%",i.vjCanvas.style.height="100%",i.vjCanvas.style.position="absolute",i.vjCanvas.style.backgroundColor="transparent",i.vjCanvas.style.top="0px",i.vjCanvas.style.left="0px",i.vjCanvas.style.zIndex="5",i.vjCanvas.style.msTouchAction="none",i.vjCanvas.setAttribute("touch-action","none"),i.vjCanvasContext=i.vjCanvas.getContext("2d"),i.vjCanvasContext.strokeStyle="#ffffff",i.vjCanvasContext.lineWidth=2,document.body.appendChild(i.vjCanvas)),i.halfWidth=i.vjCanvas.width/2,i.halfHeight=i.vjCanvas.height/2,this.pressed=!1,this._joystickColor="cyan",this._joystickPointerID=-1,this._joystickPointerPos=new t.Vector2(0,0),this._joystickPreviousPointerPos=new t.Vector2(0,0),this._joystickPointerStartPos=new t.Vector2(0,0),this._deltaJoystickVector=new t.Vector2(0,0),this._onPointerDownHandlerRef=function(t){n._onPointerDown(t)},this._onPointerMoveHandlerRef=function(t){n._onPointerMove(t)},this._onPointerOutHandlerRef=function(t){n._onPointerUp(t)},this._onPointerUpHandlerRef=function(t){n._onPointerUp(t)},i.vjCanvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),i.vjCanvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),i.vjCanvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),i.vjCanvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),i.vjCanvas.addEventListener("contextmenu",function(t){t.preventDefault()},!1),requestAnimationFrame(function(){n._drawVirtualJoystick()})}return i.prototype.setJoystickSensibility=function(t){this._joystickSensibility=t,this._inversedSensibility=1/(this._joystickSensibility/1e3)},i.prototype._onPointerDown=function(t){var e;t.preventDefault(),e=this._leftJoystick===!0?t.clientX<i.halfWidth:t.clientX>i.halfWidth,e&&this._joystickPointerID<0?(this._joystickPointerID=t.pointerId,this._joystickPointerStartPos.x=t.clientX,this._joystickPointerStartPos.y=t.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone(),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(t.pointerId.toString(),t)):i._globalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(t.pointerId.toString(),{x:t.clientX,y:t.clientY,prevX:t.clientX,prevY:t.clientY}))},i.prototype._onPointerMove=function(t){if(this._joystickPointerID==t.pointerId){this._joystickPointerPos.x=t.clientX,this._joystickPointerPos.y=t.clientY,this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);var i=this.reverseLeftRight?-1:1,r=i*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case e.X:this.deltaPosition.x=Math.min(1,Math.max(-1,r));break;case e.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,r));break;case e.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,r))}var n=this.reverseUpDown?1:-1,s=n*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case e.X:this.deltaPosition.x=Math.min(1,Math.max(-1,s));break;case e.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,s));break;case e.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,s))}}else{var o=this._touches.get(t.pointerId.toString());o&&(o.x=t.clientX,o.y=t.clientY)}},i.prototype._onPointerUp=function(t){if(this._joystickPointerID==t.pointerId)i.vjCanvasContext.clearRect(this._joystickPointerStartPos.x-63,this._joystickPointerStartPos.y-63,126,126),i.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-41,this._joystickPreviousPointerPos.y-41,82,82),this._joystickPointerID=-1,this.pressed=!1;else{var e=this._touches.get(t.pointerId.toString());e&&i.vjCanvasContext.clearRect(e.prevX-43,e.prevY-43,86,86)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(t.pointerId.toString())},i.prototype.setJoystickColor=function(t){this._joystickColor=t},i.prototype.setActionOnTouch=function(t){this._action=t},i.prototype.setAxisForLeftRight=function(t){switch(t){case e.X:case e.Y:case e.Z:this._axisTargetedByLeftAndRight=t;break;default:this._axisTargetedByLeftAndRight=e.X}},i.prototype.setAxisForUpDown=function(t){switch(t){case e.X:case e.Y:case e.Z:this._axisTargetedByUpAndDown=t;break;default:this._axisTargetedByUpAndDown=e.Y}},i.prototype._clearCanvas=function(){this._leftJoystick?i.vjCanvasContext.clearRect(0,0,i.vjCanvasWidth/2,i.vjCanvasHeight):i.vjCanvasContext.clearRect(i.vjCanvasWidth/2,0,i.vjCanvasWidth,i.vjCanvasHeight)},i.prototype._drawVirtualJoystick=function(){var t=this;this.pressed&&this._touches.forEach(function(e){e.pointerId===t._joystickPointerID?(i.vjCanvasContext.clearRect(t._joystickPointerStartPos.x-63,t._joystickPointerStartPos.y-63,126,126),i.vjCanvasContext.clearRect(t._joystickPreviousPointerPos.x-41,t._joystickPreviousPointerPos.y-41,82,82),i.vjCanvasContext.beginPath(),i.vjCanvasContext.lineWidth=6,i.vjCanvasContext.strokeStyle=t._joystickColor,i.vjCanvasContext.arc(t._joystickPointerStartPos.x,t._joystickPointerStartPos.y,40,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),i.vjCanvasContext.beginPath(),i.vjCanvasContext.strokeStyle=t._joystickColor,i.vjCanvasContext.lineWidth=2,i.vjCanvasContext.arc(t._joystickPointerStartPos.x,t._joystickPointerStartPos.y,60,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),i.vjCanvasContext.beginPath(),i.vjCanvasContext.strokeStyle=t._joystickColor,i.vjCanvasContext.arc(t._joystickPointerPos.x,t._joystickPointerPos.y,40,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),t._joystickPreviousPointerPos=t._joystickPointerPos.clone()):(i.vjCanvasContext.clearRect(e.prevX-43,e.prevY-43,86,86),i.vjCanvasContext.beginPath(),i.vjCanvasContext.fillStyle="white",i.vjCanvasContext.beginPath(),i.vjCanvasContext.strokeStyle="red",i.vjCanvasContext.lineWidth=6,i.vjCanvasContext.arc(e.x,e.y,40,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),e.prevX=e.x,e.prevY=e.y)}),requestAnimationFrame(function(){t._drawVirtualJoystick()})},i.prototype.releaseCanvas=function(){i.vjCanvas&&(i.vjCanvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),i.vjCanvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),i.vjCanvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),i.vjCanvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(i.vjCanvas),i.vjCanvas=null)},i._globalJoystickIndex=0,i}();t.VirtualJoystick=i}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r){t.call(this,e,i,r),this.inputs.addVirtualJoystick()}return o(e,t),e}(t.FreeCamera);t.VirtualJoysticksCamera=e}(r||(r={}));var r;!function(t){var e=function(){function e(){}return e.prototype.getLeftJoystick=function(){return this._leftjoystick},e.prototype.getRightJoystick=function(){return this._rightjoystick},e.prototype.checkInputs=function(){if(this._leftjoystick){var e=this.camera,i=50*e._computeLocalCameraSpeed(),r=t.Matrix.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),n=t.Vector3.TransformCoordinates(new t.Vector3(this._leftjoystick.deltaPosition.x*i,this._leftjoystick.deltaPosition.y*i,this._leftjoystick.deltaPosition.z*i),r);e.cameraDirection=e.cameraDirection.add(n),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}},e.prototype.attachControl=function(e,i){this._leftjoystick=new t.VirtualJoystick(!0),this._leftjoystick.setAxisForUpDown(t.JoystickAxis.Z),this._leftjoystick.setAxisForLeftRight(t.JoystickAxis.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new t.VirtualJoystick(!1),this._rightjoystick.setAxisForUpDown(t.JoystickAxis.X),this._rightjoystick.setAxisForLeftRight(t.JoystickAxis.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")},e.prototype.detachControl=function(t){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()},e.prototype.getTypeName=function(){return"FreeCameraVirtualJoystickInput"},e.prototype.getSimpleName=function(){return"virtualJoystick"},e}();t.FreeCameraVirtualJoystickInput=e,t.CameraInputTypes.FreeCameraVirtualJoystickInput=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o){var a=this;t.call(this,e,"anaglyph",null,["leftSampler"],i,r[1],n,s,o),this._passedProcess=r[0]._rigPostProcess,this.onApplyObservable.add(function(t){t.setTextureFromPostProcess("leftSampler",a._passedProcess)})}return o(e,t),e}(t.PostProcess);t.AnaglyphPostProcess=e}(r||(r={}));var r;!function(t){var e=function(){function e(t){this._scene=t}return e.prototype.render=function(e,i,r){var n=this;void 0===r&&(r=!1);var s=this._scene,o=this._scene.getEngine(),a=null!==o.getCaps().instancedArrays&&null!==i.visibleInstances[e._id]&&void 0!==i.visibleInstances[e._id];if(this.isReady(e,a)){var h=e.getRenderingMesh(),l=e.getMaterial();if(o.enableEffect(this._effect),this._effect.setFloat("offset",r?0:h.outlineWidth),this._effect.setColor4("color",r?h.overlayColor:h.outlineColor,r?h.overlayAlpha:1),this._effect.setMatrix("viewProjection",s.getTransformMatrix()),h.useBones&&h.computeBonesUsingShaders&&this._effect.setMatrices("mBones",h.skeleton.getTransformMatrices(h)),h._bind(e,this._effect,t.Material.TriangleFillMode),l&&l.needAlphaTesting()){var c=l.getAlphaTestTexture();this._effect.setTexture("diffuseSampler",c),this._effect.setMatrix("diffuseMatrix",c.getTextureMatrix())}h._processRendering(e,this._effect,t.Material.TriangleFillMode,i,a,function(t,e){n._effect.setMatrix("world",e)})}},e.prototype.isReady=function(e,i){var r=[],n=[t.VertexBuffer.PositionKind,t.VertexBuffer.NormalKind],s=e.getMesh(),o=e.getMaterial();o&&o.needAlphaTesting()&&(r.push("#define ALPHATEST"),s.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(n.push(t.VertexBuffer.UVKind),r.push("#define UV1")),s.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(n.push(t.VertexBuffer.UV2Kind),r.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(n.push(t.VertexBuffer.MatricesIndicesKind),n.push(t.VertexBuffer.MatricesWeightsKind),s.numBoneInfluencers>4&&(n.push(t.VertexBuffer.MatricesIndicesExtraKind),n.push(t.VertexBuffer.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),r.push("#define BonesPerMesh "+(s.skeleton.bones.length+1))):r.push("#define NUM_BONE_INFLUENCERS 0"),i&&(r.push("#define INSTANCES"),n.push("world0"),n.push("world1"),n.push("world2"),n.push("world3"));var a=r.join("\n");return this._cachedDefines!==a&&(this._cachedDefines=a,this._effect=this._scene.getEngine().createEffect("outline",n,["world","mBones","viewProjection","diffuseMatrix","offset","color"],["diffuseSampler"],a)),this._effect.isReady()},e}();t.OutlineRenderer=e}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i,r){this.name=t,this.meshesNames=e,this.rootUrl=i,this.sceneFilename=r,this.isCompleted=!1}return e.prototype.run=function(e,i,r){var n=this;t.SceneLoader.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,function(t,e,r){n.loadedMeshes=t,n.loadedParticleSystems=e,n.loadedSkeletons=r,n.isCompleted=!0,n.onSuccess&&n.onSuccess(n),i()},null,function(){n.onError&&n.onError(n),r()})},e}();t.MeshAssetTask=e;var i=function(){function e(t,e){this.name=t,this.url=e,this.isCompleted=!1}return e.prototype.run=function(e,i,r){var n=this;t.Tools.LoadFile(this.url,function(t){n.text=t,n.isCompleted=!0,n.onSuccess&&n.onSuccess(n),i()},null,e.database,!1,function(){n.onError&&n.onError(n),r()})},e}();t.TextFileAssetTask=i;var r=function(){function e(t,e){this.name=t,this.url=e,this.isCompleted=!1}return e.prototype.run=function(e,i,r){var n=this;t.Tools.LoadFile(this.url,function(t){n.data=t,n.isCompleted=!0,n.onSuccess&&n.onSuccess(n),i()},null,e.database,!0,function(){n.onError&&n.onError(n),r()})},e}();t.BinaryFileAssetTask=r;var n=function(){function e(t,e){this.name=t,this.url=e,this.isCompleted=!1}return e.prototype.run=function(e,i,r){var n=this,s=new Image;t.Tools.SetCorsBehavior(this.url,s),s.onload=function(){n.image=s,n.isCompleted=!0,n.onSuccess&&n.onSuccess(n),i()},s.onerror=function(){n.onError&&n.onError(n),r()},s.src=this.url},e}();t.ImageAssetTask=n;var s=function(){function e(e,i,r,n,s){void 0===s&&(s=t.Texture.TRILINEAR_SAMPLINGMODE),this.name=e,this.url=i,this.noMipmap=r,this.invertY=n,this.samplingMode=s,this.isCompleted=!1}return e.prototype.run=function(e,i,r){var n=this,s=function(){n.isCompleted=!0,n.onSuccess&&n.onSuccess(n),i()},o=function(){n.onError&&n.onError(n),r()};this.texture=new t.Texture(this.url,e,this.noMipmap,this.invertY,this.samplingMode,s,o)},e}();t.TextureAssetTask=s;var o=function(){function e(t,e,i,r,n){this.name=t,this.url=e,this.extensions=i,this.noMipmap=r,this.files=n,this.isCompleted=!1}return e.prototype.run=function(e,i,r){var n=this,s=function(){n.isCompleted=!0,n.onSuccess&&n.onSuccess(n),i()},o=function(){n.onError&&n.onError(n),r()};this.texture=new t.CubeTexture(this.url,e,this.extensions,this.noMipmap,this.files,s,o)},e}();t.CubeTextureAssetTask=o;var a=function(){function o(t){this.tasks=new Array,this.waitingTasksCount=0,this.useDefaultLoadingScreen=!0,this._scene=t}return o.prototype.addMeshTask=function(t,i,r,n){var s=new e(t,i,r,n);return this.tasks.push(s),s},o.prototype.addTextFileTask=function(t,e){var r=new i(t,e);return this.tasks.push(r),r},o.prototype.addBinaryFileTask=function(t,e){var i=new r(t,e);return this.tasks.push(i),i},o.prototype.addImageTask=function(t,e){var i=new n(t,e);return this.tasks.push(i),i},o.prototype.addTextureTask=function(e,i,r,n,o){void 0===o&&(o=t.Texture.TRILINEAR_SAMPLINGMODE);var a=new s(e,i,r,n,o);return this.tasks.push(a),a},o.prototype._decreaseWaitingTasksCount=function(){0===--this.waitingTasksCount&&(this.onFinish&&this.onFinish(this.tasks),this._scene.getEngine().hideLoadingUI())},o.prototype._runTask=function(t){var e=this;t.run(this._scene,function(){e.onTaskSuccess&&e.onTaskSuccess(t),e._decreaseWaitingTasksCount()},function(){e.onTaskError&&e.onTaskError(t),e._decreaseWaitingTasksCount()})},o.prototype.reset=function(){return this.tasks=new Array,this},o.prototype.load=function(){if(this.waitingTasksCount=this.tasks.length,0===this.waitingTasksCount)return this.onFinish&&this.onFinish(this.tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(var t=0;t<this.tasks.length;t++){var e=this.tasks[t];this._runTask(e)}return this},o}();t.AssetsManager=a}(r||(r={}));var r;!function(t){var e=function(){function e(){this.compensateDistortion=!0}return Object.defineProperty(e.prototype,"aspectRatio",{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aspectRatioFov",{get:function(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftHMatrix",{get:function(){var e=this.hScreenSize/4-this.lensSeparationDistance/2,i=4*e/this.hScreenSize;return t.Matrix.Translation(i,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightHMatrix",{get:function(){var e=this.hScreenSize/4-this.lensSeparationDistance/2,i=4*e/this.hScreenSize;return t.Matrix.Translation(-i,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftPreViewMatrix",{get:function(){return t.Matrix.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightPreViewMatrix",{get:function(){return t.Matrix.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:!0,configurable:!0}),e.GetDefault=function(){var t=new e;return t.hResolution=1280,t.vResolution=800,t.hScreenSize=.149759993,t.vScreenSize=.0935999975,t.vScreenCenter=.0467999987,t.eyeToScreenDistance=.0410000011,t.lensSeparationDistance=.063500002,t.interpupillaryDistance=.064000003,t.distortionK=[1,.219999999,.239999995,0],t.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],t.postProcessScaleFactor=1.714605507808412,t.lensCenterOffset=.151976421,t},e}();t.VRCameraMetrics=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){var a=this;void 0===s&&(s=!1),void 0===o&&(o={}),e.call(this,i,r,n),this.webVROptions=o,this._vrDevice=null,this._cacheState=null,this._vrEnabled=!1,this._attached=!1,this._positionOffset=r,this.getEngine().initWebVR(),this.getEngine().vrDisplaysPromise?(this._frameData=new VRFrameData,this.getEngine().vrDisplaysPromise.then(function(e){if(e.length>0){if(a._vrEnabled=!0,a.webVROptions.displayName){e.some(function(t){return t.displayName===a.webVROptions.displayName&&(a._vrDevice=t,!0)})||(a._vrDevice=e[0],t.Tools.Warn("Display "+a.webVROptions.displayName+" was not found. Using "+a._vrDevice.displayName))}else a._vrDevice=e[0];a.setCameraRigMode(t.Camera.RIG_MODE_WEBVR,{vrDisplay:a._vrDevice,frameData:a._frameData}),a._attached&&a.getEngine().enableVR(a._vrDevice)}else t.Tools.Error("No WebVR devices found!")})):t.Tools.Error("WebVR is not enabled on your browser"),this.rotationQuaternion=new t.Quaternion,this._quaternionCache=new t.Quaternion}return o(i,e),i.prototype._checkInputs=function(){if(this._vrEnabled&&this._vrDevice.getFrameData(this._frameData)){var t=this._frameData.pose;t&&t.orientation&&(this._cacheState=t,this.rotationQuaternion.copyFromFloats(this._cacheState.orientation[0],this._cacheState.orientation[1],-this._cacheState.orientation[2],-this._cacheState.orientation[3]),this.webVROptions.trackPosition&&this._cacheState.position&&(this.position.copyFromFloats(this._cacheState.position[0],this._cacheState.position[1],-this._cacheState.position[2]),this.webVROptions.positionScale&&this.position.scaleInPlace(this.webVROptions.positionScale),this.position.addInPlace(this._positionOffset)))}e.prototype._checkInputs.call(this)},i.prototype.attachControl=function(i,r){e.prototype.attachControl.call(this,i,r),this._attached=!0,r=!t.Camera.ForceAttachControlToAlwaysPreventDefault&&r,this._vrEnabled&&this.getEngine().enableVR(this._vrDevice)},i.prototype.detachControl=function(t){e.prototype.detachControl.call(this,t),this._vrEnabled=!1,this._attached=!1,this.getEngine().disableVR()},i.prototype.requestVRFullscreen=function(e){t.Tools.Warn("requestVRFullscreen is deprecated. call attachControl() to start sending frames to the VR display.")},i.prototype.getTypeName=function(){return"WebVRFreeCamera"},i.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()},i.prototype.setPositionOffset=function(t){t?this._positionOffset=t:this._positionOffset.copyFrom(this.position)},i}(t.FreeCamera);t.WebVRFreeCamera=e}(r||(r={}));var r;!function(t){var e=function(){function t(t){void 0===t&&(t=0),this.priority=t,this.apply=function(t){return!0}}return t}();t.SceneOptimization=e;var i=function(t){function e(e,i){var r=this;void 0===e&&(e=0),void 0===i&&(i=1024),t.call(this,e),this.priority=e,this.maximumSize=i,this.apply=function(t){for(var e=!0,i=0;i<t.textures.length;i++){var n=t.textures[i];if(n.canRescale){var s=n.getSize();Math.max(s.width,s.height)>r.maximumSize&&(n.scale(.5),e=!1)}}return e}}return o(e,t),e}(e);t.TextureOptimization=i;var r=function(t){function e(e,i){var r=this;void 0===e&&(e=0),void 0===i&&(i=2),t.call(this,e),this.priority=e,this.maximumScale=i,this._currentScale=1,this.apply=function(t){return r._currentScale++,t.getEngine().setHardwareScalingLevel(r._currentScale),r._currentScale>=r.maximumScale}}return o(e,t),e}(e);t.HardwareScalingOptimization=r;var n=function(t){function e(){t.apply(this,arguments),this.apply=function(t){return t.shadowsEnabled=!1,!0}}return o(e,t),e}(e);t.ShadowsOptimization=n;var s=function(t){function e(){t.apply(this,arguments),this.apply=function(t){return t.postProcessesEnabled=!1,!0}}return o(e,t),e}(e);t.PostProcessesOptimization=s;var a=function(t){function e(){t.apply(this,arguments),this.apply=function(t){return t.lensFlaresEnabled=!1,!0}}return o(e,t),e}(e);t.LensFlaresOptimization=a;var h=function(t){function e(){t.apply(this,arguments),this.apply=function(t){return t.particlesEnabled=!1,!0}}return o(e,t),e}(e);t.ParticlesOptimization=h;var l=function(t){function e(){t.apply(this,arguments),this.apply=function(t){return t.renderTargetsEnabled=!1,!0}}return o(e,t),e}(e);t.RenderTargetsOptimization=l;var c=function(e){function i(){var r=this;e.apply(this,arguments),this._canBeMerged=function(e){if(!(e instanceof t.Mesh))return!1;var i=e;return!(!i.isVisible||!i.isEnabled())&&(!(i.instances.length>0)&&(!i.skeleton&&!i.hasLODLevels&&!i.parent))},this.apply=function(e,n){for(var s=e.meshes.slice(0),o=s.length,a=0;a<o;a++){var h=new Array,l=s[a];if(r._canBeMerged(l)){h.push(l);for(var c=a+1;c<o;c++){var u=s[c];r._canBeMerged(u)&&u.material===l.material&&u.checkCollisions===l.checkCollisions&&(h.push(u),o--,s.splice(c,1),c--)}h.length<2||t.Mesh.MergeMeshes(h)}}return void 0!=n?n&&e.createOrUpdateSelectionOctree():i.UpdateSelectionTree&&e.createOrUpdateSelectionOctree(),!0}}return o(i,e),Object.defineProperty(i,"UpdateSelectionTree",{get:function(){return i._UpdateSelectionTree},set:function(t){i._UpdateSelectionTree=t},enumerable:!0,configurable:!0}),i._UpdateSelectionTree=!1,i}(e);t.MergeMeshesOptimization=c;var u=function(){function t(t,e){void 0===t&&(t=60),void 0===e&&(e=2e3),this.targetFrameRate=t,this.trackerDuration=e,this.optimizations=new Array}return t.LowDegradationAllowed=function(e){var r=new t(e),o=0;return r.optimizations.push(new c(o)),r.optimizations.push(new n(o)),r.optimizations.push(new a(o)),o++,r.optimizations.push(new s(o)),r.optimizations.push(new h(o)),o++,r.optimizations.push(new i(o,1024)),r},t.ModerateDegradationAllowed=function(e){var o=new t(e),u=0;return o.optimizations.push(new c(u)),o.optimizations.push(new n(u)),o.optimizations.push(new a(u)),u++,o.optimizations.push(new s(u)),o.optimizations.push(new h(u)),u++,o.optimizations.push(new i(u,512)),u++,o.optimizations.push(new l(u)),u++,o.optimizations.push(new r(u,2)),o},t.HighDegradationAllowed=function(e){var o=new t(e),u=0;return o.optimizations.push(new c(u)),o.optimizations.push(new n(u)),o.optimizations.push(new a(u)),u++,o.optimizations.push(new s(u)),o.optimizations.push(new h(u)),u++,o.optimizations.push(new i(u,256)),u++,o.optimizations.push(new l(u)),u++,o.optimizations.push(new r(u,4)),o},t}();t.SceneOptimizerOptions=u;var p=function(){function t(){}return t._CheckCurrentState=function(e,i,r,n,s){if(e.getEngine().getFps()>=i.targetFrameRate)return void(n&&n());for(var o=!0,a=!0,h=0;h<i.optimizations.length;h++){var l=i.optimizations[h];l.priority===r&&(a=!1,o=o&&l.apply(e))}if(a)return void(s&&s());o&&r++,e.executeWhenReady(function(){setTimeout(function(){t._CheckCurrentState(e,i,r,n,s)},i.trackerDuration)})},t.OptimizeAsync=function(e,i,r,n){i||(i=u.ModerateDegradationAllowed()),e.executeWhenReady(function(){setTimeout(function(){t._CheckCurrentState(e,i,0,r,n)},i.trackerDuration)})},t}();t.SceneOptimizer=p}(r||(r={}));var r;!function(t){!function(t){var e=function(){function t(t,e){this.distance=t,this.mesh=e}return t}();t.MeshLODLevel=e}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h,l){void 0===a&&(a=!0),void 0===h&&(h=!1),void 0===l&&(l=t.Texture.TRILINEAR_SAMPLINGMODE),e.call(this,null,o,!a,h),this.format=s,this._texture=o.getEngine().createRawTexture(i,r,n,s,a,h,l),this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE}return o(i,e),i.prototype.update=function(t){this.getScene().getEngine().updateRawTexture(this._texture,t,this.format,this._invertY)},i.CreateLuminanceTexture=function(e,r,n,s,o,a,h){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=t.Texture.TRILINEAR_SAMPLINGMODE),new i(e,r,n,t.Engine.TEXTUREFORMAT_LUMINANCE,s,o,a,h)},i.CreateLuminanceAlphaTexture=function(e,r,n,s,o,a,h){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=t.Texture.TRILINEAR_SAMPLINGMODE),new i(e,r,n,t.Engine.TEXTUREFORMAT_LUMINANCE_ALPHA,s,o,a,h)},i.CreateAlphaTexture=function(e,r,n,s,o,a,h){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=t.Texture.TRILINEAR_SAMPLINGMODE),new i(e,r,n,t.Engine.TEXTUREFORMAT_ALPHA,s,o,a,h)},i.CreateRGBTexture=function(e,r,n,s,o,a,h){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=t.Texture.TRILINEAR_SAMPLINGMODE),new i(e,r,n,t.Engine.TEXTUREFORMAT_RGB,s,o,a,h)},i.CreateRGBATexture=function(e,r,n,s,o,a,h){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=t.Texture.TRILINEAR_SAMPLINGMODE),new i(e,r,n,t.Engine.TEXTUREFORMAT_RGBA,s,o,a,h)},i}(t.Texture);t.RawTexture=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i){t.call(this,e.x,e.y),this.index=i}return o(e,t),e}(t.Vector2),i=function(){function i(){this.elements=new Array}return i.prototype.add=function(t){var i=this,r=new Array;return t.forEach(function(t){if(0===r.length||!t.equalsWithEpsilon(r[0])){var n=new e(t,i.elements.length);r.push(n),i.elements.push(n)}}),r},i.prototype.computeBounds=function(){var e=new t.Vector2(this.elements[0].x,this.elements[0].y),i=new t.Vector2(this.elements[0].x,this.elements[0].y);return this.elements.forEach(function(t){t.x<e.x?e.x=t.x:t.x>i.x&&(i.x=t.x),t.y<e.y?e.y=t.y:t.y>i.y&&(i.y=t.y)}),{min:e,max:i,width:i.x-e.x,height:i.y-e.y}},i}(),r=function(){function e(){}return e.Rectangle=function(e,i,r,n){return[new t.Vector2(e,i),new t.Vector2(r,i),new t.Vector2(r,n),new t.Vector2(e,n)]},e.Circle=function(e,i,r,n){void 0===i&&(i=0),void 0===r&&(r=0),void 0===n&&(n=32);for(var s=new Array,o=0,a=2*Math.PI/n,h=0;h<n;h++)s.push(new t.Vector2(i+Math.cos(o)*e,r+Math.sin(o)*e)),o-=a;return s},e.Parse=function(e){var i,r=e.split(/[^-+eE\.\d]+/).map(parseFloat).filter(function(t){return!isNaN(t)}),n=[];for(i=0;i<(2147483646&r.length);i+=2)n.push(new t.Vector2(r[i],r[i+1]));return n},e.StartingAt=function(e,i){return t.Path2.StartingAt(e,i)},e}();t.Polygon=r;var n=function(){function e(e,r,n){this._points=new i,this._outlinepoints=new i,this._holes=[],this._epoints=new Array,this._eholes=new Array,this._name=e,this._scene=n;var s;s=r instanceof t.Path2?r.getPoints():r,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s)}return e.prototype._addToepoint=function(t){for(var e=0,i=t;e<i.length;e++){var r=i[e];this._epoints.push(r.x,r.y)}},e.prototype.addHole=function(t){this._points.add(t);var e=new i;return e.add(t),this._holes.push(e),this._eholes.push(this._epoints.length/2),this._addToepoint(t),this},e.prototype.build=function(e,i){var r=this;void 0===e&&(e=!1);var n=new t.Mesh(this._name,this._scene),s=[],o=[],h=[],l=this._points.computeBounds();this._points.elements.forEach(function(t){s.push(0,1,0),o.push(t.x,0,t.y),h.push((t.x-l.min.x)/l.width,(t.y-l.min.y)/l.height)});for(var c=[],u=a.earcut(this._epoints,this._eholes,2),p=0;p<u.length;p++)c.push(u[p]);if(i>0){var d=o.length/3;this._points.elements.forEach(function(t){s.push(0,-1,0),o.push(t.x,-i,t.y),h.push(1-(t.x-l.min.x)/l.width,1-(t.y-l.min.y)/l.height)});for(var f=c.length,p=0;p<f;p+=3){var m=c[p+0],_=c[p+1],g=c[p+2];c.push(g+d),c.push(_+d),c.push(m+d)}this.addSide(o,s,h,c,l,this._outlinepoints,i,!1),this._holes.forEach(function(t){r.addSide(o,s,h,c,l,t,i,!0)})}return n.setVerticesData(t.VertexBuffer.PositionKind,o,e),n.setVerticesData(t.VertexBuffer.NormalKind,s,e),n.setVerticesData(t.VertexBuffer.UVKind,h,e),n.setIndices(c),n},e.prototype.addSide=function(e,i,r,n,s,o,a,h){for(var l=e.length/3,c=0,u=0;u<o.elements.length;u++){var p,d=o.elements[u];p=u+1>o.elements.length-1?o.elements[0]:o.elements[u+1],e.push(d.x,0,d.y),e.push(d.x,-a,d.y),e.push(p.x,0,p.y),e.push(p.x,-a,p.y);var f=new t.Vector3(d.x,0,d.y),m=new t.Vector3(p.x,0,p.y),_=m.subtract(f),g=new t.Vector3(0,1,0),y=t.Vector3.Cross(_,g);y=y.normalize(),r.push(c/s.width,0),r.push(c/s.width,1),c+=_.length(),r.push(c/s.width,0),r.push(c/s.width,1),h?(i.push(y.x,y.y,y.z),i.push(y.x,y.y,y.z),i.push(y.x,y.y,y.z),i.push(y.x,y.y,y.z),n.push(l),n.push(l+2),n.push(l+1),n.push(l+1),n.push(l+2),n.push(l+3)):(i.push(-y.x,-y.y,-y.z),i.push(-y.x,-y.y,-y.z),i.push(-y.x,-y.y,-y.z),i.push(-y.x,-y.y,-y.z),n.push(l),n.push(l+1),n.push(l+2),n.push(l+1),n.push(l+3),n.push(l+2)),l+=4}},e}();t.PolygonMeshBuilder=n}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r){void 0===r&&(r=2),this.maxDepth=r,this.dynamicContent=new Array,this._maxBlockCapacity=i||64,this._selectionContent=new t.SmartArray(1024),this._creationFunc=e}return e.prototype.update=function(t,i,r){e._CreateBlocks(t,i,r,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},e.prototype.addMesh=function(t){for(var e=0;e<this.blocks.length;e++){this.blocks[e].addEntry(t)}},e.prototype.select=function(t,e){this._selectionContent.reset();for(var i=0;i<this.blocks.length;i++){this.blocks[i].select(t,this._selectionContent,e)}return e?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},e.prototype.intersects=function(t,e,i){this._selectionContent.reset();for(var r=0;r<this.blocks.length;r++){this.blocks[r].intersects(t,e,this._selectionContent,i)}return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},e.prototype.intersectsRay=function(t){this._selectionContent.reset();for(var e=0;e<this.blocks.length;e++){this.blocks[e].intersectsRay(t,this._selectionContent)}return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},e._CreateBlocks=function(e,i,r,n,s,o,a,h){a.blocks=new Array;for(var l=new t.Vector3((i.x-e.x)/2,(i.y-e.y)/2,(i.z-e.z)/2),c=0;c<2;c++)for(var u=0;u<2;u++)for(var p=0;p<2;p++){var d=e.add(l.multiplyByFloats(c,u,p)),f=e.add(l.multiplyByFloats(c+1,u+1,p+1)),m=new t.OctreeBlock(d,f,n,s+1,o,h);m.addEntries(r),a.blocks.push(m)}},e.CreationFuncForMeshes=function(t,e){!t.isBlocked&&t.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(t)},e.CreationFuncForSubMeshes=function(t,e){t.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(t)},e}();t.Octree=e}(r||(r={}));var r;!function(t){var e=function(){function e(t,e,i,r,n,s){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=n,this._creationFunc=s,this._minPoint=t,this._maxPoint=e,this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors[2].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[3].y=e.y,this._boundingVectors.push(t.clone()),this._boundingVectors[4].z=e.z,this._boundingVectors.push(e.clone()),this._boundingVectors[5].z=t.z,this._boundingVectors.push(e.clone()),this._boundingVectors[6].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[7].y=t.y}return Object.defineProperty(e.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!0,configurable:!0}),e.prototype.addEntry=function(t){if(this.blocks)for(var e=0;e<this.blocks.length;e++){var i=this.blocks[e];i.addEntry(t)}else this._creationFunc(t,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},e.prototype.addEntries=function(t){for(var e=0;e<t.length;e++){var i=t[e];this.addEntry(i)}},e.prototype.select=function(e,i,r){if(t.BoundingBox.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(var n=0;n<this.blocks.length;n++){this.blocks[n].select(e,i,r)}return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},e.prototype.intersects=function(e,i,r,n){if(t.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,e,i)){if(this.blocks){for(var s=0;s<this.blocks.length;s++){this.blocks[s].intersects(e,i,r,n)}return}n?r.concat(this.entries):r.concatWithNoDuplicate(this.entries)}},e.prototype.intersectsRay=function(t,e){if(t.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(var i=0;i<this.blocks.length;i++){this.blocks[i].intersectsRay(t,e)}return}e.concatWithNoDuplicate(this.entries)}},e.prototype.createInnerBlocks=function(){t.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},e}();t.OctreeBlock=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h,l){var c=this;void 0===a&&(a=t.Texture.BILINEAR_SAMPLINGMODE),e.call(this,i,"blur",["screenSize","direction","blurWidth"],null,s,o,a,h,l),this.direction=r,this.blurWidth=n,this.onApplyObservable.add(function(t){t.setFloat2("screenSize",c.width,c.height),t.setVector2("direction",c.direction),t.setFloat("blurWidth",c.blurWidth)})}return o(i,e),i}(t.PostProcess);t.BlurPostProcess=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h,l,c,u){var p=this;e.call(this,i,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],a,h,l,c,u),this.color=n,this.depth=s,this.colorLevel=o,this.onActivateObservable.add(function(e){p._refRexture=p._refRexture||new t.Texture(r,e.getScene())}),this.onApplyObservable.add(function(t){t.setColor3("baseColor",p.color),t.setFloat("depth",p.depth),t.setFloat("colorLevel",p.colorLevel),t.setTexture("refractionSampler",p._refRexture)})}return o(i,e),i.prototype.dispose=function(t){this._refRexture&&this._refRexture.dispose(),e.prototype.dispose.call(this,t)},i}(t.PostProcess);t.RefractionPostProcess=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o){t.call(this,e,"blackAndWhite",null,null,i,r,n,s,o)}return o(e,t),e}(t.PostProcess);t.BlackAndWhitePostProcess=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o,a){var h=this;t.call(this,e,"convolution",["kernel","screenSize"],null,r,n,s,o,a),this.kernel=i,this.onApply=function(t){t.setFloat2("screenSize",h.width,h.height),t.setArray("kernel",h.kernel)}}return o(e,t),e.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],e.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],e.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],e.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],e.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],e.GaussianKernel=[0,1,0,1,1,1,0,1,0],e}(t.PostProcess);t.ConvolutionPostProcess=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o,a){var h=this;t.call(this,e,"filter",["kernelMatrix"],null,r,n,s,o,a),this.kernelMatrix=i,this.onApply=function(t){t.setMatrix("kernelMatrix",h.kernelMatrix)}}return o(e,t),e}(t.PostProcess);t.FilterPostProcess=e}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r,n,s,o){var a=this;t.call(this,e,"fxaa",["texelSize"],null,i,r,n,s,o),this.onSizeChangedObservable.add(function(){a.texelWidth=1/a.width,a.texelHeight=1/a.height}),this.onApplyObservable.add(function(t){t.setFloat2("texelSize",a.texelWidth,a.texelHeight)})}return o(e,t),e}(t.PostProcess);t.FxaaPostProcess=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a){var h=this;e.call(this,i,"stereoscopicInterlace",["stepSize"],["camASampler"],1,r[1],s,o,a,n?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=r[0]._rigPostProcess,this._stepSize=new t.Vector2(1/this.width,1/this.height),this.onSizeChangedObservable.add(function(){h._stepSize=new t.Vector2(1/h.width,1/h.height)}),this.onApplyObservable.add(function(t){t.setTextureFromPostProcess("camASampler",h._passedProcess),t.setFloat2("stepSize",h._stepSize.x,h._stepSize.y)})}return o(i,e),i}(t.PostProcess);t.StereoscopicInterlacePostProcess=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s){this.size=e,this.position=i,this.alphaMode=t.Engine.ALPHA_ONEONE,this.dispose=function(){this.texture&&this.texture.dispose();var t=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(t,1)},this.color=r||new t.Color3(1,1,1),this.texture=n?new t.Texture(n,s.getScene(),!0):null,this._system=s,s.lensFlares.push(this)}return e}();t.LensFlare=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r){this.name=e,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=r,this._emitter=i,this.id=e,r.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(t){return t.material&&t.isVisible&&t.isEnabled()&&t.isBlocker&&0!=(t.layerMask&r.activeCamera.layerMask)};var n=r.getEngine(),s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[t.VertexBuffer.PositionKind]=new t.VertexBuffer(n,s,t.VertexBuffer.PositionKind,!1,!1,2);var o=[];o.push(0),o.push(1),o.push(2),o.push(0),o.push(2),o.push(3),this._indexBuffer=n.createIndexBuffer(o),this._effect=n.createEffect("lensFlare",[t.VertexBuffer.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}return Object.defineProperty(e.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled=t},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},e.prototype.getEmitter=function(){return this._emitter},e.prototype.setEmitter=function(t){this._emitter=t},e.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},e.prototype.computeEffectivePosition=function(e){var i=this.getEmitterPosition();return i=t.Vector3.Project(i,t.Matrix.Identity(),this._scene.getTransformMatrix(),e),this._positionX=i.x,this._positionY=i.y,i=t.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=2*this.viewportBorder,e.height+=2*this.viewportBorder,i.x+=this.viewportBorder,i.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder),i.z>0&&(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&(this._positionY,e.y,e.height),!0)},e.prototype._isVisible=function(){if(!this._isEnabled)return!1;var e=this.getEmitterPosition(),i=e.subtract(this._scene.activeCamera.globalPosition),r=i.length();i.normalize();var n=new t.Ray(this._scene.activeCamera.globalPosition,i),s=this._scene.pickWithRay(n,this.meshesSelectionPredicate,!0);return!s.hit||s.distance>r},e.prototype.render=function(){if(!this._effect.isReady())return!1;var e=this._scene.getEngine(),i=this._scene.activeCamera.viewport,r=i.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(r))return!1;if(!this._isVisible())return!1;var n,s;n=this._positionX<this.borderLimit+r.x?this.borderLimit+r.x-this._positionX:this._positionX>r.x+r.width-this.borderLimit?this._positionX-r.x-r.width+this.borderLimit:0,s=this._positionY<this.borderLimit+r.y?this.borderLimit+r.y-this._positionY:this._positionY>r.y+r.height-this.borderLimit?this._positionY-r.y-r.height+this.borderLimit:0;var o=n>s?n:s;(o-=this.viewportBorder)>this.borderLimit&&(o=this.borderLimit);var a=1-o/this.borderLimit;if(a<0)return!1;a>1&&(a=1),this.viewportBorder>0&&(r.x+=this.viewportBorder,r.y+=this.viewportBorder,r.width-=2*this.viewportBorder,r.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);var h=r.x+r.width/2,l=r.y+r.height/2,c=h-this._positionX,u=l-this._positionY;e.enableEffect(this._effect),e.setState(!1),e.setDepthBuffer(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect);for(var p=0;p<this.lensFlares.length;p++){var d=this.lensFlares[p];e.setAlphaMode(d.alphaMode);var f=h-c*d.position,m=l-u*d.position,_=d.size,g=d.size*e.getAspectRatio(this._scene.activeCamera,!0),y=f/(r.width+2*r.x)*2-1,v=1-m/(r.height+2*r.y)*2,x=t.Matrix.FromValues(_/2,0,0,0,0,g/2,0,0,0,0,1,0,y,v,0,1);this._effect.setMatrix("viewportMatrix",x),this._effect.setTexture("textureSampler",d.texture),this._effect.setFloat4("color",d.color.r*a,d.color.g*a,d.color.b*a,1),e.draw(!0,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(t.Engine.ALPHA_DISABLE),!0},e.prototype.dispose=function(){var e=this._vertexBuffers[t.VertexBuffer.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[t.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var i=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(i,1)},e.Parse=function(i,r,n){var s=r.getLastEntryByID(i.emitterId),o=i.name||"lensFlareSystem#"+i.emitterId,a=new e(o,s,r);a.id=i.id||o,a.borderLimit=i.borderLimit;for(var h=0;h<i.flares.length;h++){var l=i.flares[h];new t.LensFlare(l.size,l.position,t.Color3.FromArray(l.color),n+l.textureName,a)}return a},e.prototype.serialize=function(){var e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(var i=0;i<this.lensFlares.length;i++){var r=this.lensFlares[i];e.flares.push({size:r.size,position:r.position,color:r.color.asArray(),textureName:t.Tools.GetFilename(r.texture.name)})}return e},e}();t.LensFlareSystem=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n){e.call(this,i,r,n),this._quaternionCache=new t.Quaternion,this.inputs.addDeviceOrientation()}return o(i,e),i.prototype.getTypeName=function(){return"DeviceOrientationCamera"},i.prototype._checkInputs=function(){e.prototype._checkInputs.call(this),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)},i.prototype.resetToCurrentRotation=function(e){var i=this;void 0===e&&(e=t.Axis.Y),this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new t.Quaternion),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(function(t){e[t]?i._initialQuaternion[t]*=-1:i._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))},i}(t.FreeCamera);t.DeviceOrientationCamera=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){void 0===s&&(s=!0),void 0===o&&(o=t.VRCameraMetrics.GetDefault()),e.call(this,i,r,n),o.compensateDistortion=s,this.setCameraRigMode(t.Camera.RIG_MODE_VR,{vrCameraMetrics:o})}return o(i,e),i.prototype.getTypeName=function(){return"VRDeviceOrientationFreeCamera"},i}(t.DeviceOrientationCamera);t.VRDeviceOrientationFreeCamera=e;var i=function(e){function i(i,r,n,s,o,a,h,l){void 0===h&&(h=!0),void 0===l&&(l=t.VRCameraMetrics.GetDefault()),e.call(this,i,r,n,s,o,a),l.compensateDistortion=h,this.setCameraRigMode(t.Camera.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}return o(i,e),i.prototype.getTypeName=function(){return"VRDeviceOrientationArcRotateCamera"},i}(t.ArcRotateCamera);t.VRDeviceOrientationArcRotateCamera=i}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r){t.call(this,e,i,r),this.inputs.addGamepad()}return o(e,t),Object.defineProperty(e.prototype,"gamepadAngularSensibility",{get:function(){var t=this.inputs.attached.gamepad;if(t)return t.gamepadAngularSensibility},set:function(t){var e=this.inputs.attached.gamepad;e&&(e.gamepadAngularSensibility=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gamepadMoveSensibility",{get:function(){var t=this.inputs.attached.gamepad;if(t)return t.gamepadMoveSensibility},set:function(t){var e=this.inputs.attached.gamepad;e&&(e.gamepadMoveSensibility=t)},enumerable:!0,configurable:!0}),e.prototype.getTypeName=function(){return"UniversalCamera"},e}(t.TouchCamera);t.UniversalCamera=e}(r||(r={}));var r;!function(t){var e=function(){function t(t){var e=this;this.babylonGamepads=[],this.oneGamepadConnected=!1,this.isMonitoring=!1,this.gamepadEventSupported="GamepadEvent"in window,this.gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.msGetGamepads||!!navigator.webkitGamepads,this._callbackGamepadConnected=t,this.gamepadSupportAvailable&&(this.gamepadEventSupported?(this._onGamepadConnectedEvent=function(t){e._onGamepadConnected(t)},this._onGamepadDisonnectedEvent=function(t){e._onGamepadDisconnected(t)},window.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),window.addEventListener("gamepaddisconnected",this._onGamepadDisonnectedEvent,!1)):this._startMonitoringGamepads())}return t.prototype.dispose=function(){t.gamepadDOMInfo&&document.body.removeChild(t.gamepadDOMInfo),this._onGamepadConnectedEvent&&(window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),window.removeEventListener("gamepaddisconnected",this._onGamepadDisonnectedEvent,!1),this._onGamepadConnectedEvent=null,this._onGamepadDisonnectedEvent=null)},t.prototype._onGamepadConnected=function(t){var e=this._addNewGamepad(t.gamepad);this._callbackGamepadConnected&&this._callbackGamepadConnected(e),this._startMonitoringGamepads()},t.prototype._addNewGamepad=function(e){this.oneGamepadConnected||(this.oneGamepadConnected=!0,t.gamepadDOMInfo&&(document.body.removeChild(t.gamepadDOMInfo),t.gamepadDOMInfo=null));var i,r=e.id.search("Xbox One")!==-1;return i=r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1?new h(e.id,e.index,e,r):new n(e.id,e.index,e),this.babylonGamepads.push(i),i},t.prototype._onGamepadDisconnected=function(t){for(var e in this.babylonGamepads)if(this.babylonGamepads[e].index==t.gamepad.index){this.babylonGamepads.splice(+e,1);break}0==this.babylonGamepads.length&&this._stopMonitoringGamepads()},t.prototype._startMonitoringGamepads=function(){this.isMonitoring||(this.isMonitoring=!0,this._checkGamepadsStatus())},t.prototype._stopMonitoringGamepads=function(){this.isMonitoring=!1},t.prototype._checkGamepadsStatus=function(){var t=this;this._updateGamepadObjects();for(var e in this.babylonGamepads)this.babylonGamepads[e].update();this.isMonitoring&&(window.requestAnimationFrame?window.requestAnimationFrame(function(){t._checkGamepadsStatus()}):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(function(){t._checkGamepadsStatus()}):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(function(){t._checkGamepadsStatus()}))},t.prototype._updateGamepadObjects=function(){for(var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],e=0;e<t.length;e++)if(t[e])if(t[e].index in this.babylonGamepads)this.babylonGamepads[e].browserGamepad=t[e];else{var i=this._addNewGamepad(t[e]);this._callbackGamepadConnected&&this._callbackGamepadConnected(i)}},t}();t.Gamepads=e;var i=function(){function t(t,e){this.x=t,this.y=e}return t}();t.StickValues=i;var r=function(){function t(t,e,i,r,n,s,o){void 0===r&&(r=0),void 0===n&&(n=1),void 0===s&&(s=2),void 0===o&&(o=3),this.id=t,this.index=e,this.browserGamepad=i,this._leftStickAxisX=r,this._leftStickAxisY=n,this._rightStickAxisX=s,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}return t.prototype.onleftstickchanged=function(t){this._onleftstickchanged=t},t.prototype.onrightstickchanged=function(t){this._onrightstickchanged=t},Object.defineProperty(t.prototype,"leftStick",{get:function(){return this._leftStick},set:function(t){!this._onleftstickchanged||this._leftStick.x===t.x&&this._leftStick.y===t.y||this._onleftstickchanged(t),this._leftStick=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rightStick",{get:function(){return this._rightStick},set:function(t){!this._onrightstickchanged||this._rightStick.x===t.x&&this._rightStick.y===t.y||this._onrightstickchanged(t),this._rightStick=t},enumerable:!0,configurable:!0}),t.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})},t}();t.Gamepad=r;var n=function(t){function e(e,i,r){t.call(this,e,i,r),this.id=e,this.index=i,this.gamepad=r,this._buttons=new Array(r.buttons.length)}return o(e,t),e.prototype.onbuttondown=function(t){this._onbuttondown=t},e.prototype.onbuttonup=function(t){this._onbuttonup=t},e.prototype._setButtonValue=function(t,e,i){return t!==e&&(this._onbuttondown&&1===t&&this._onbuttondown(i),this._onbuttonup&&0===t&&this._onbuttonup(i)),t},e.prototype.update=function(){t.prototype.update.call(this);for(var e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.gamepad.buttons[e].value,this._buttons[e],e)},e}(r);t.GenericPad=n,function(t){t[t.A=0]="A",t[t.B=1]="B",t[t.X=2]="X",t[t.Y=3]="Y",t[t.Start=4]="Start",t[t.Back=5]="Back",t[t.LB=6]="LB",t[t.RB=7]="RB",t[t.LeftStick=8]="LeftStick",t[t.RightStick=9]="RightStick"}(t.Xbox360Button||(t.Xbox360Button={}));var s=t.Xbox360Button;!function(t){t[t.Up=0]="Up",t[t.Down=1]="Down",t[t.Left=2]="Left",t[t.Right=3]="Right"}(t.Xbox360Dpad||(t.Xbox360Dpad={}));var a=t.Xbox360Dpad,h=function(t){function e(e,i,r,n){void 0===n&&(n=!1),t.call(this,e,i,r,0,1,n?3:2,n?4:3),this._leftTrigger=0,this._rightTrigger=0,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this._isXboxOnePad=n}return o(e,t),e.prototype.onlefttriggerchanged=function(t){this._onlefttriggerchanged=t},e.prototype.onrighttriggerchanged=function(t){this._onrighttriggerchanged=t},Object.defineProperty(e.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(t){this._onlefttriggerchanged&&this._leftTrigger!==t&&this._onlefttriggerchanged(t),this._leftTrigger=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(t){this._onrighttriggerchanged&&this._rightTrigger!==t&&this._onrighttriggerchanged(t),this._rightTrigger=t},enumerable:!0,configurable:!0}),e.prototype.onbuttondown=function(t){this._onbuttondown=t},e.prototype.onbuttonup=function(t){this._onbuttonup=t},e.prototype.ondpaddown=function(t){this._ondpaddown=t},e.prototype.ondpadup=function(t){this._ondpadup=t},e.prototype._setButtonValue=function(t,e,i){return t!==e&&(this._onbuttondown&&1===t&&this._onbuttondown(i),this._onbuttonup&&0===t&&this._onbuttonup(i)),t},e.prototype._setDPadValue=function(t,e,i){return t!==e&&(this._ondpaddown&&1===t&&this._ondpaddown(i),this._ondpadup&&0===t&&this._ondpadup(i)),t},Object.defineProperty(e.prototype,"buttonA",{get:function(){return this._buttonA},set:function(t){this._buttonA=this._setButtonValue(t,this._buttonA,s.A)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonB",{get:function(){return this._buttonB},set:function(t){this._buttonB=this._setButtonValue(t,this._buttonB,s.B)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonX",{get:function(){return this._buttonX},set:function(t){this._buttonX=this._setButtonValue(t,this._buttonX,s.X)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonY",{get:function(){return this._buttonY},set:function(t){this._buttonY=this._setButtonValue(t,this._buttonY,s.Y)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(t){this._buttonStart=this._setButtonValue(t,this._buttonStart,s.Start)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(t){this._buttonBack=this._setButtonValue(t,this._buttonBack,s.Back)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(t){this._buttonLB=this._setButtonValue(t,this._buttonLB,s.LB)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(t){this._buttonRB=this._setButtonValue(t,this._buttonRB,s.RB)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(t){this._buttonLeftStick=this._setButtonValue(t,this._buttonLeftStick,s.LeftStick)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(t){this._buttonRightStick=this._setButtonValue(t,this._buttonRightStick,s.RightStick)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(t){this._dPadUp=this._setDPadValue(t,this._dPadUp,a.Up)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(t){this._dPadDown=this._setDPadValue(t,this._dPadDown,a.Down)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(t){this._dPadLeft=this._setDPadValue(t,this._dPadLeft,a.Left)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(t){this._dPadRight=this._setDPadValue(t,this._dPadRight,a.Right)},enumerable:!0,configurable:!0}),e.prototype.update=function(){t.prototype.update.call(this),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.axes[2],this.rightTrigger=this.browserGamepad.axes[5],this.buttonBack=this.browserGamepad.buttons[9].value,this.buttonStart=this.browserGamepad.buttons[8].value,this.buttonLeftStick=this.browserGamepad.buttons[6].value,this.buttonRightStick=this.browserGamepad.buttons[7].value,this.dPadUp=this.browserGamepad.buttons[11].value,this.dPadDown=this.browserGamepad.buttons[12].value,this.dPadLeft=this.browserGamepad.buttons[13].value,this.dPadRight=this.browserGamepad.buttons[14].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)},e}(r);t.Xbox360Pad=h}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n){t.Tools.Warn("Deprecated. Please use Universal Camera instead."),e.call(this,i,r,n)}return o(i,e),Object.defineProperty(i.prototype,"gamepadAngularSensibility",{get:function(){var t=this.inputs.attached.gamepad;if(t)return t.gamepadAngularSensibility},set:function(t){var e=this.inputs.attached.gamepad;e&&(e.gamepadAngularSensibility=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"gamepadMoveSensibility",{get:function(){var t=this.inputs.attached.gamepad;if(t)return t.gamepadMoveSensibility},set:function(t){var e=this.inputs.attached.gamepad;e&&(e.gamepadMoveSensibility=t)},enumerable:!0,configurable:!0}),i.prototype.getTypeName=function(){return"GamepadCamera"},i}(t.UniversalCamera);t.GamepadCamera=e}(r||(r={}));var r;!function(t){var e=function(){function e(e){this.SMOOTHING=.75,this.FFT_SIZE=512,this.BARGRAPHAMPLITUDE=256,this.DEBUGCANVASPOS={x:20,y:20},this.DEBUGCANVASSIZE={width:320,height:200},this._scene=e,this._audioEngine=t.Engine.audioEngine,this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))}return e.prototype.getFrequencyBinCount=function(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0},e.prototype.getByteFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs},e.prototype.getByteTimeDomainData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime},e.prototype.getFloatFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs},e.prototype.drawDebugCanvas=function(){var t=this;if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=function(){t.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc)){var e=this.getByteFrequencyData();this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height);for(var i=0;i<this.getFrequencyBinCount();i++){var r=e[i],n=r/this.BARGRAPHAMPLITUDE,s=this.DEBUGCANVASSIZE.height*n,o=this.DEBUGCANVASSIZE.height-s-1,a=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),h=i/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+h+", 100%, 50%)",this._debugCanvasContext.fillRect(i*a,o,a,s)}}},e.prototype.stopDebugCanvas=function(){this._debugCanvas&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null,document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)},e.prototype.connectAudioNodes=function(t,e){this._audioEngine.canUseWebAudio&&(t.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(e))},e.prototype.dispose=function(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()},e}();t.Analyser=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i){var r=this;void 0===i&&(i=t.Engine.TEXTURETYPE_FLOAT),this._viewMatrix=t.Matrix.Zero(),this._projectionMatrix=t.Matrix.Zero(),this._transformMatrix=t.Matrix.Zero(),this._worldViewProjection=t.Matrix.Zero(),this._scene=e;var n=e.getEngine();this._depthMap=new t.RenderTargetTexture("depthMap",{width:n.getRenderWidth(),height:n.getRenderHeight()},this._scene,!1,!0,i),this._depthMap.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._depthMap.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.onClearObservable.add(function(e){e.clear(new t.Color4(1,1,1,1),!0,!0,!0)});var s=function(e){var i=e.getRenderingMesh(),n=r._scene,s=n.getEngine();s.setState(e.getMaterial().backFaceCulling);var o=i._getInstancesRenderList(e._id);if(!o.mustReturn){var a=null!==s.getCaps().instancedArrays&&null!==o.visibleInstances[e._id];if(r.isReady(e,a)){s.enableEffect(r._effect),i._bind(e,r._effect,t.Material.TriangleFillMode);var h=e.getMaterial();if(r._effect.setMatrix("viewProjection",n.getTransformMatrix()),r._effect.setFloat("far",n.activeCamera.maxZ),h&&h.needAlphaTesting()){var l=h.getAlphaTestTexture();r._effect.setTexture("diffuseSampler",l),r._effect.setMatrix("diffuseMatrix",l.getTextureMatrix())}i.useBones&&i.computeBonesUsingShaders&&r._effect.setMatrices("mBones",i.skeleton.getTransformMatrices(i)),i._processRendering(e,r._effect,t.Material.TriangleFillMode,o,a,function(t,e){return r._effect.setMatrix("world",e)})}}};this._depthMap.customRenderFunction=function(t,e){var i;for(i=0;i<t.length;i++)s(t.data[i]);for(i=0;i<e.length;i++)s(e.data[i])}}return e.prototype.isReady=function(e,i){var r=e.getMaterial();if(r.disableDepthWrite)return!1;var n=[],s=[t.VertexBuffer.PositionKind],o=e.getMesh();o.getScene();r&&r.needAlphaTesting()&&(n.push("#define ALPHATEST"),o.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(s.push(t.VertexBuffer.UVKind),n.push("#define UV1")),o.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(s.push(t.VertexBuffer.UV2Kind),n.push("#define UV2"))),o.useBones&&o.computeBonesUsingShaders?(s.push(t.VertexBuffer.MatricesIndicesKind),s.push(t.VertexBuffer.MatricesWeightsKind),o.numBoneInfluencers>4&&(s.push(t.VertexBuffer.MatricesIndicesExtraKind),s.push(t.VertexBuffer.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),n.push("#define BonesPerMesh "+(o.skeleton.bones.length+1))):n.push("#define NUM_BONE_INFLUENCERS 0"),i&&(n.push("#define INSTANCES"),s.push("world0"),s.push("world1"),s.push("world2"),s.push("world3"));var a=n.join("\n");return this._cachedDefines!==a&&(this._cachedDefines=a,this._effect=this._scene.getEngine().createEffect("depth",s,["world","mBones","viewProjection","diffuseMatrix","far"],["diffuseSampler"],a)),this._effect.isReady()},e.prototype.getDepthMap=function(){return this._depthMap},e.prototype.dispose=function(){this._depthMap.dispose()},e}();t.DepthRenderer=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s){var o=this;e.call(this,r.getEngine(),i),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=r,this._createRandomTexture(),this._depthTexture=r.enableDepthRenderer().getDepthMap();var a=n.ssaoRatio||n,h=n.combineRatio||n;this._ratio={ssaoRatio:a,combineRatio:h},this._originalColorPostProcess=new t.PassPostProcess("SSAOOriginalSceneColor",h,null,t.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),!1),this._createSSAOPostProcess(a),this._createBlurPostProcess(a),this._createSSAOCombinePostProcess(h),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),this.SSAOOriginalSceneColorEffect,function(){return o._originalColorPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),this.SSAORenderEffect,function(){return o._ssaoPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),this.SSAOBlurHRenderEffect,function(){return o._blurHPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),this.SSAOBlurVRenderEffect,function(){return o._blurVPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),this.SSAOCombineRenderEffect,function(){return o._ssaoCombinePostProcess},!0)),r.postProcessRenderPipelineManager.addPipeline(this),s&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,s)}return o(i,e),i.prototype.getBlurHPostProcess=function(){return t.Tools.Error("SSAORenderinPipeline.getBlurHPostProcess() is deprecated, no more blur post-process exists"),null},i.prototype.getBlurVPostProcess=function(){return t.Tools.Error("SSAORenderinPipeline.getBlurVPostProcess() is deprecated, no more blur post-process exists"),null},i.prototype.dispose=function(t){void 0===t&&(t=!1);for(var e=0;e<this._scene.cameras.length;e++){var i=this._scene.cameras[e];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),t&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras)},i.prototype._createBlurPostProcess=function(e){for(var i=this,r=[],n=-8;n<8;n++)r.push(2*n);this._blurHPostProcess=new t.PostProcess("BlurH","ssao",["outSize","samplerOffsets"],["depthSampler"],e,null,t.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16"),this._blurHPostProcess.onApply=function(t){t.setFloat("outSize",i._ssaoCombinePostProcess.width),t.setTexture("depthSampler",i._depthTexture),i._firstUpdate&&t.setArray("samplerOffsets",r)},this._blurVPostProcess=new t.PostProcess("BlurV","ssao",["outSize","samplerOffsets"],["depthSampler"],e,null,t.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define SAMPLES 16"),this._blurVPostProcess.onApply=function(t){t.setFloat("outSize",i._ssaoCombinePostProcess.height),t.setTexture("depthSampler",i._depthTexture),i._firstUpdate&&(t.setArray("samplerOffsets",r),i._firstUpdate=!1)}},i.prototype._createSSAOPostProcess=function(e){var i=this,r=16,n=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],s=1/r;this._ssaoPostProcess=new t.PostProcess("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+r+"\n#define SSAO");new t.Vector2(0,0);this._ssaoPostProcess.onApply=function(t){i._firstUpdate&&(t.setArray3("sampleSphere",n),t.setFloat("samplesFactor",s),t.setFloat("randTextureTiles",4)),t.setFloat("totalStrength",i.totalStrength),t.setFloat("radius",i.radius),t.setFloat("area",i.area),t.setFloat("fallOff",i.fallOff),t.setFloat("base",i.base),t.setTexture("textureSampler",i._depthTexture),t.setTexture("randomSampler",i._randomTexture)}},i.prototype._createSSAOCombinePostProcess=function(e){var i=this;this._ssaoCombinePostProcess=new t.PostProcess("ssaoCombine","ssaoCombine",[],["originalColor"],e,null,t.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=function(t){t.setTextureFromPostProcess("originalColor",i._originalColorPostProcess)}},i.prototype._createRandomTexture=function(){var e=512;this._randomTexture=new t.DynamicTexture("SSAORandomTexture",e,this._scene,!1,t.Texture.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=t.Texture.WRAP_ADDRESSMODE,this._randomTexture.wrapV=t.Texture.WRAP_ADDRESSMODE;for(var i=this._randomTexture.getContext(),r=function(t,e){return Math.random()*(e-t)+t},n=t.Vector3.Zero(),s=0;s<e;s++)for(var o=0;o<e;o++)n.x=Math.floor(255*r(-1,1)),n.y=Math.floor(255*r(-1,1)),n.z=Math.floor(255*r(-1,1)),i.fillStyle="rgb("+n.x+", "+n.y+", "+n.z+")",i.fillRect(s,o,1,1);this._randomTexture.update(!1)},s([t.serialize()],i.prototype,"totalStrength",void 0),s([t.serialize()],i.prototype,"radius",void 0),s([t.serialize()],i.prototype,"area",void 0),s([t.serialize()],i.prototype,"fallOff",void 0),s([t.serialize()],i.prototype,"base",void 0),s([t.serialize()],i.prototype,"_ratio",void 0),i}(t.PostProcessRenderPipeline);t.SSAORenderingPipeline=e}(r||(r={}));var r;!function(t){var e=function(e){function i(r,n,s,o,a,h,l,c,u){var p=this;void 0===a&&(a=100),void 0===h&&(h=t.Texture.BILINEAR_SAMPLINGMODE),e.call(this,r,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],n.postProcessRatio||n,s,h,l,c,"#define NUM_SAMPLES "+a),this._screenCoordinates=t.Vector2.Zero(),this.customMeshPosition=t.Vector3.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,u=null===s?u:s.getScene();var l=u.getEngine();this._viewPort=new t.Viewport(0,0,1,1).toGlobal(l.getRenderWidth(),l.getRenderHeight()),this.mesh=null!==o?o:i.CreateDefaultMesh("VolumetricLightScatteringMesh",u),this._createPass(u,n.passRatio||n),this.onActivate=function(t){p.isSupported||p.dispose(t),p.onActivate=null},this.onApplyObservable.add(function(t){p._updateMeshScreenCoordinates(u),t.setTexture("lightScatteringSampler",p._volumetricLightScatteringRTT),t.setFloat("exposure",p.exposure),t.setFloat("decay",p.decay),t.setFloat("weight",p.weight),t.setFloat("density",p.density),t.setVector2("meshPositionOnScreen",p._screenCoordinates)})}return o(i,e),Object.defineProperty(i.prototype,"useDiffuseColor",{get:function(){return t.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1},set:function(e){t.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:!0,configurable:!0}),i.prototype.isReady=function(e,i){var r=e.getMesh();if(r===this.mesh)return r.material.isReady(r);var n=[],s=[t.VertexBuffer.PositionKind],o=e.getMaterial();o&&(o.needAlphaTesting()&&n.push("#define ALPHATEST"),r.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(s.push(t.VertexBuffer.UVKind),n.push("#define UV1")),r.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(s.push(t.VertexBuffer.UV2Kind),n.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders?(s.push(t.VertexBuffer.MatricesIndicesKind),s.push(t.VertexBuffer.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),n.push("#define BonesPerMesh "+(r.skeleton.bones.length+1))):n.push("#define NUM_BONE_INFLUENCERS 0"),i&&(n.push("#define INSTANCES"),s.push("world0"),s.push("world1"),s.push("world2"),s.push("world3"));var a=n.join("\n");return this._cachedDefines!==a&&(this._cachedDefines=a,this._volumetricLightScatteringPass=r.getScene().getEngine().createEffect({vertexElement:"depth",fragmentElement:"volumetricLightScatteringPass"},s,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],a)),this._volumetricLightScatteringPass.isReady()},i.prototype.setCustomMeshPosition=function(t){this.customMeshPosition=t},i.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},i.prototype.dispose=function(t){var i=t.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);i!==-1&&t.getScene().customRenderTargets.splice(i,1),this._volumetricLightScatteringRTT.dispose(),e.prototype.dispose.call(this,t)},i.prototype.getPass=function(){return this._volumetricLightScatteringRTT},i.prototype._meshExcluded=function(t){return this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(t)!==-1},i.prototype._createPass=function(e,i){var r=this,n=e.getEngine();this._volumetricLightScatteringRTT=new t.RenderTargetTexture("volumetricLightScatteringMap",{width:n.getRenderWidth()*i,height:n.getRenderHeight()*i},e,!1,!0,t.Engine.TEXTURETYPE_UNSIGNED_INT),this._volumetricLightScatteringRTT.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=t.Texture.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,e.customRenderTargets.push(this._volumetricLightScatteringRTT);var s,o=function(e){var i=e.getRenderingMesh();if(!r._meshExcluded(i)){var n=i.getScene(),s=n.getEngine();s.setState(e.getMaterial().backFaceCulling);var o=i._getInstancesRenderList(e._id);if(!o.mustReturn){var a=null!==s.getCaps().instancedArrays&&null!==o.visibleInstances[e._id];if(r.isReady(e,a)){var h=r._volumetricLightScatteringPass;if(i===r.mesh&&(h=e.getMaterial().getEffect()),s.enableEffect(h),i._bind(e,h,t.Material.TriangleFillMode),i===r.mesh)e.getMaterial().bind(i.getWorldMatrix(),i);else{var l=e.getMaterial();if(r._volumetricLightScatteringPass.setMatrix("viewProjection",n.getTransformMatrix()),l&&l.needAlphaTesting()){var c=l.getAlphaTestTexture();r._volumetricLightScatteringPass.setTexture("diffuseSampler",c),c&&r._volumetricLightScatteringPass.setMatrix("diffuseMatrix",c.getTextureMatrix())}i.useBones&&i.computeBonesUsingShaders&&r._volumetricLightScatteringPass.setMatrices("mBones",i.skeleton.getTransformMatrices(i))}i._processRendering(e,r._volumetricLightScatteringPass,t.Material.TriangleFillMode,o,a,function(t,e){return h.setMatrix("world",e)})}}}},a=new t.Color4(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){s=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){e.clearColor=s}),this._volumetricLightScatteringRTT.customRenderFunction=function(i,r,n){var s,a=e.getEngine();for(s=0;s<i.length;s++)o(i.data[s]);for(a.setAlphaTesting(!0),s=0;s<r.length;s++)o(r.data[s]);if(a.setAlphaTesting(!1),n.length){for(s=0;s<n.length;s++){var h=n.data[s];h._alphaIndex=h.getMesh().alphaIndex,h._distanceToCamera=h.getBoundingInfo().boundingSphere.centerWorld.subtract(e.activeCamera.position).length()}var l=n.data.slice(0,n.length);for(l.sort(function(t,e){return t._alphaIndex>e._alphaIndex?1:t._alphaIndex<e._alphaIndex?-1:t._distanceToCamera<e._distanceToCamera?1:t._distanceToCamera>e._distanceToCamera?-1:0}),a.setAlphaMode(t.Engine.ALPHA_COMBINE),s=0;s<l.length;s++)o(l[s]);a.setAlphaMode(t.Engine.ALPHA_DISABLE)}}},i.prototype._updateMeshScreenCoordinates=function(e){var i,r=e.getTransformMatrix();i=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;var n=t.Vector3.Project(i,t.Matrix.Identity(),r,this._viewPort);this._screenCoordinates.x=n.x/this._viewPort.width,this._screenCoordinates.y=n.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},i.CreateDefaultMesh=function(e,i){var r=t.Mesh.CreatePlane(e,1,i);r.billboardMode=t.AbstractMesh.BILLBOARDMODE_ALL;var n=new t.StandardMaterial(e+"Material",i);return n.emissiveColor=new t.Color3(1,1,1),r.material=n,r},s([t.serializeAsVector3()],i.prototype,"customMeshPosition",void 0),s([t.serialize()],i.prototype,"useCustomMeshPosition",void 0),s([t.serialize()],i.prototype,"invert",void 0),s([t.serializeAsMeshReference()],i.prototype,"mesh",void 0),s([t.serialize()],i.prototype,"excludedMeshes",void 0),s([t.serialize()],i.prototype,"exposure",void 0),s([t.serialize()],i.prototype,"decay",void 0),s([t.serialize()],i.prototype,"weight",void 0),s([t.serialize()],i.prototype,"density",void 0),i}(t.PostProcess);t.VolumetricLightScatteringPostProcess=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){var a=this;void 0===s&&(s=1),e.call(this,n.getEngine(),i),this.LensChromaticAberrationEffect="LensChromaticAberrationEffect",this.HighlightsEnhancingEffect="HighlightsEnhancingEffect",this.LensDepthOfFieldEffect="LensDepthOfFieldEffect",this._scene=n,this._depthTexture=n.enableDepthRenderer().getDepthMap(),r.grain_texture?this._grainTexture=r.grain_texture:this._createGrainTexture(),this._edgeBlur=r.edge_blur?r.edge_blur:0,this._grainAmount=r.grain_amount?r.grain_amount:0,this._chromaticAberration=r.chromatic_aberration?r.chromatic_aberration:0,this._distortion=r.distortion?r.distortion:0,this._highlightsGain=void 0!==r.dof_gain?r.dof_gain:-1,this._highlightsThreshold=r.dof_threshold?r.dof_threshold:1,this._dofDistance=void 0!==r.dof_focus_distance?r.dof_focus_distance:-1,this._dofAperture=r.dof_aperture?r.dof_aperture:1,this._dofDarken=r.dof_darken?r.dof_darken:0,this._dofPentagon=void 0===r.dof_pentagon||r.dof_pentagon,this._blurNoise=void 0===r.blur_noise||r.blur_noise,this._createChromaticAberrationPostProcess(s),this._createHighlightsPostProcess(s),this._createDepthOfFieldPostProcess(s/4),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),this.LensChromaticAberrationEffect,function(){return a._chromaticAberrationPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),this.HighlightsEnhancingEffect,function(){return a._highlightsPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),this.LensDepthOfFieldEffect,function(){return a._depthOfFieldPostProcess},!0)),this._highlightsGain===-1&&this._disableEffect(this.HighlightsEnhancingEffect,null),n.postProcessRenderPipelineManager.addPipeline(this),o&&n.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,o)}return o(i,e),i.prototype.setEdgeBlur=function(t){this._edgeBlur=t},i.prototype.disableEdgeBlur=function(){this._edgeBlur=0},i.prototype.setGrainAmount=function(t){this._grainAmount=t},i.prototype.disableGrain=function(){this._grainAmount=0},i.prototype.setChromaticAberration=function(t){this._chromaticAberration=t},i.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},i.prototype.setEdgeDistortion=function(t){this._distortion=t},i.prototype.disableEdgeDistortion=function(){this._distortion=0},i.prototype.setFocusDistance=function(t){this._dofDistance=t},i.prototype.disableDepthOfField=function(){this._dofDistance=-1},i.prototype.setAperture=function(t){this._dofAperture=t},i.prototype.setDarkenOutOfFocus=function(t){this._dofDarken=t},i.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n")},i.prototype.disablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect()},i.prototype.enableNoiseBlur=function(){this._blurNoise=!0},i.prototype.disableNoiseBlur=function(){this._blurNoise=!1},i.prototype.setHighlightsGain=function(t){this._highlightsGain=t},i.prototype.setHighlightsThreshold=function(t){this._highlightsGain===-1&&(this._highlightsGain=1),this._highlightsThreshold=t},i.prototype.disableHighlights=function(){this._highlightsGain=-1},i.prototype.dispose=function(t){void 0===t&&(t=!1),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),this._chromaticAberrationPostProcess=void 0,this._highlightsPostProcess=void 0,this._depthOfFieldPostProcess=void 0,this._grainTexture.dispose(),t&&this._scene.disableDepthRenderer()},i.prototype._createChromaticAberrationPostProcess=function(e){var i=this;this._chromaticAberrationPostProcess=new t.PostProcess("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height"],[],e,null,t.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._chromaticAberrationPostProcess.onApply=function(t){t.setFloat("chromatic_aberration",i._chromaticAberration),t.setFloat("screen_width",i._scene.getEngine().getRenderingCanvas().width),t.setFloat("screen_height",i._scene.getEngine().getRenderingCanvas().height)}},i.prototype._createHighlightsPostProcess=function(e){var i=this;this._highlightsPostProcess=new t.PostProcess("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],e,null,t.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?"#define PENTAGON\n":""),this._highlightsPostProcess.onApply=function(t){t.setFloat("gain",i._highlightsGain),t.setFloat("threshold",i._highlightsThreshold),t.setTextureFromPostProcess("textureSampler",i._chromaticAberrationPostProcess),t.setFloat("screen_width",i._scene.getEngine().getRenderingCanvas().width),t.setFloat("screen_height",i._scene.getEngine().getRenderingCanvas().height)}},i.prototype._createDepthOfFieldPostProcess=function(e){var i=this;this._depthOfFieldPostProcess=new t.PostProcess("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],e,null,t.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._depthOfFieldPostProcess.onApply=function(t){t.setTexture("depthSampler",i._depthTexture),t.setTexture("grainSampler",i._grainTexture),t.setTextureFromPostProcess("textureSampler",i._highlightsPostProcess),t.setTextureFromPostProcess("highlightsSampler",i._depthOfFieldPostProcess),t.setFloat("grain_amount",i._grainAmount),t.setBool("blur_noise",i._blurNoise),t.setFloat("screen_width",i._scene.getEngine().getRenderingCanvas().width),t.setFloat("screen_height",i._scene.getEngine().getRenderingCanvas().height),t.setFloat("distortion",i._distortion),t.setBool("dof_enabled",i._dofDistance!==-1),t.setFloat("screen_distance",1/(.1-1/i._dofDistance)),t.setFloat("aperture",i._dofAperture),t.setFloat("darken",i._dofDarken),t.setFloat("edge_blur",i._edgeBlur),t.setBool("highlights",i._highlightsGain!==-1),t.setFloat("near",i._scene.activeCamera.minZ),t.setFloat("far",i._scene.activeCamera.maxZ)}},i.prototype._createGrainTexture=function(){var e=512;this._grainTexture=new t.DynamicTexture("LensNoiseTexture",e,this._scene,!1,t.Texture.BILINEAR_SAMPLINGMODE),this._grainTexture.wrapU=t.Texture.WRAP_ADDRESSMODE,this._grainTexture.wrapV=t.Texture.WRAP_ADDRESSMODE;for(var i,r=this._grainTexture.getContext(),n=function(t,e){return Math.random()*(e-t)+t},s=0;s<e;s++)for(var o=0;o<e;o++)i=Math.floor(255*n(.42,.58)),r.fillStyle="rgb("+i+", "+i+", "+i+")",r.fillRect(s,o,1,1);this._grainTexture.update(!1)},i}(t.PostProcessRenderPipeline);t.LensRenderingPipeline=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h){var l=this;e.call(this,i,"colorCorrection",null,["colorTable"],n,s,o,a,h),this._colorTableTexture=new t.Texture(r,s.getScene(),!0,!1,t.Texture.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=t.Texture.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=t.Texture.CLAMP_ADDRESSMODE,this.onApply=function(t){t.setTexture("colorTable",l._colorTableTexture)}}return o(i,e),i}(t.PostProcess);t.ColorCorrectionPostProcess=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s){e.call(this,i,r,s),this.interaxialDistance=n,this.setCameraRigMode(t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}return o(i,e),i.prototype.getTypeName=function(){return"AnaglyphFreeCamera"},i}(t.FreeCamera);t.AnaglyphFreeCamera=e;var i=function(e){function i(i,r,n,s,o,a,h){e.call(this,i,r,n,s,o,h),this.interaxialDistance=a,this.setCameraRigMode(t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:a})}return o(i,e),i.prototype.getTypeName=function(){return"AnaglyphArcRotateCamera"},i}(t.ArcRotateCamera);t.AnaglyphArcRotateCamera=i;var r=function(e){function i(i,r,n,s){e.call(this,i,r,s),this.interaxialDistance=n,this.setCameraRigMode(t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}return o(i,e),i.prototype.getTypeName=function(){return"AnaglyphGamepadCamera"},i}(t.GamepadCamera);t.AnaglyphGamepadCamera=r;var n=function(e){function i(i,r,n,s){e.call(this,i,r,s),this.interaxialDistance=n,this.setCameraRigMode(t.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}return o(i,e),i.prototype.getTypeName=function(){return"AnaglyphUniversalCamera"},i}(t.UniversalCamera);t.AnaglyphUniversalCamera=n;var s=function(e){function i(i,r,n,s,o){e.call(this,i,r,o),this.interaxialDistance=n,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}return o(i,e),i.prototype.getTypeName=function(){return"StereoscopicFreeCamera"},i}(t.FreeCamera);t.StereoscopicFreeCamera=s;var a=function(e){function i(i,r,n,s,o,a,h,l){e.call(this,i,r,n,s,o,l),this.interaxialDistance=a,this.isStereoscopicSideBySide=h,this.setCameraRigMode(h?t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:a})}return o(i,e),i.prototype.getTypeName=function(){return"StereoscopicArcRotateCamera"},i}(t.ArcRotateCamera);t.StereoscopicArcRotateCamera=a;var h=function(e){function i(i,r,n,s,o){e.call(this,i,r,o),this.interaxialDistance=n,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}return o(i,e),i.prototype.getTypeName=function(){return"StereoscopicGamepadCamera"},i}(t.GamepadCamera);t.StereoscopicGamepadCamera=h;var l=function(e){function i(i,r,n,s,o){e.call(this,i,r,o),this.interaxialDistance=n,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?t.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:t.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}return o(i,e),i.prototype.getTypeName=function(){return"StereoscopicUniversalCamera"},i}(t.UniversalCamera);t.StereoscopicUniversalCamera=l}(r||(r={}));var r;!function(t){var e=function(e){function i(r,n,s,o,a){var h=this;void 0===o&&(o=null),e.call(this,n.getEngine(),r),this.gaussCoeff=.3,this.gaussMean=1,this.gaussStandDev=.8,this.gaussMultiplier=4,this.exposure=1,this.minimumLuminance=1,this.maximumLuminance=1e20,this.luminanceIncreaserate=.5,this.luminanceDecreaseRate=.5,this.brightThreshold=.8,this._needUpdate=!0,this._scene=n,this._createBrightPassPostProcess(n,s),this._createDownSampleX4PostProcess(n,s),this._createGaussianBlurPostProcess(n,s),this._createTextureAdderPostProcess(n,s),this._createLuminanceGeneratorPostProcess(n),this._createHDRPostProcess(n,s),this._originalPostProcess=null===o?new t.PassPostProcess("hdr",s,null,t.Texture.BILINEAR_SAMPLINGMODE,n.getEngine(),!1):o,this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRPassPostProcess",function(){return h._originalPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRBrightPass",function(){return h._brightPassPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRDownSampleX4",function(){return h._downSampleX4PostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRGaussianBlurH",function(){return h._guassianBlurHPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRGaussianBlurV",function(){return h._guassianBlurVPostProcess},!0)),this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRTextureAdder",function(){return h._textureAdderPostProcess},!0));for(var l=function(e){h.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDRDownSampler"+e,function(){return h._downSamplePostProcesses[e]},!0))},c=i.LUM_STEPS-1;c>=0;c--)l(c);this.addEffect(new t.PostProcessRenderEffect(n.getEngine(),"HDR",function(){return h._hdrPostProcess},!0)),n.postProcessRenderPipelineManager.addPipeline(this),null!==a&&n.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(r,a),this.update()}return o(i,e),i.prototype.update=function(){this._needUpdate=!0},i.prototype.getCurrentLuminance=function(){return this._hdrCurrentLuminance},i.prototype.getOutputLuminance=function(){return this._hdrOutputLuminance},i.prototype.dispose=function(){this._originalPostProcess=void 0,this._brightPassPostProcess=void 0,this._downSampleX4PostProcess=void 0,this._guassianBlurHPostProcess=void 0,this._guassianBlurVPostProcess=void 0,this._textureAdderPostProcess=void 0;for(var t=i.LUM_STEPS-1;t>=0;t--)this._downSamplePostProcesses[t]=void 0;this._hdrPostProcess=void 0,this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras)},i.prototype._createHDRPostProcess=function(e,i){var r=this,n=0;this._hdrOutputLuminance=-1,this._hdrCurrentLuminance=1,this._hdrPostProcess=new t.PostProcess("hdr","hdr",["exposure","avgLuminance"],["otherSampler"],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define HDR"),this._hdrPostProcess.onApply=function(i){if(r._hdrOutputLuminance<0)r._hdrOutputLuminance=r._hdrCurrentLuminance;else{var s=(n-(n+e.getEngine().getDeltaTime()))/1e3;r._hdrCurrentLuminance<r._hdrOutputLuminance+r.luminanceDecreaseRate*s?r._hdrOutputLuminance+=r.luminanceDecreaseRate*s:r._hdrCurrentLuminance>r._hdrOutputLuminance-r.luminanceIncreaserate*s?r._hdrOutputLuminance-=r.luminanceIncreaserate*s:r._hdrOutputLuminance=r._hdrCurrentLuminance}r._hdrOutputLuminance=t.MathTools.Clamp(r._hdrOutputLuminance,r.minimumLuminance,r.maximumLuminance),n+=e.getEngine().getDeltaTime(),i.setTextureFromPostProcess("textureSampler",r._textureAdderPostProcess),i.setTextureFromPostProcess("otherSampler",r._originalPostProcess),i.setFloat("exposure",r.exposure),i.setFloat("avgLuminance",r._hdrOutputLuminance),r._needUpdate=!1}},i.prototype._createTextureAdderPostProcess=function(e,i){var r=this;this._textureAdderPostProcess=new t.PostProcess("hdr","hdr",[],["otherSampler"],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER"),this._textureAdderPostProcess.onApply=function(t){t.setTextureFromPostProcess("otherSampler",r._originalPostProcess)}},i.prototype._createDownSampleX4PostProcess=function(e,i){var r=this,n=new Array(32);this._downSampleX4PostProcess=new t.PostProcess("hdr","hdr",["dsOffsets"],[],i/4,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4"),this._downSampleX4PostProcess.onApply=function(t){if(r._needUpdate)for(var e=0,i=-2;i<2;i++)for(var s=-2;s<2;s++)n[e]=(i+.5)*(1/r._downSampleX4PostProcess.width),n[e+1]=(s+.5)*(1/r._downSampleX4PostProcess.height),e+=2;t.setArray2("dsOffsets",n)}},i.prototype._createBrightPassPostProcess=function(e,i){var r=this,n=new Array(8),s=function(t){if(r._needUpdate){var e=1/r._brightPassPostProcess.width,i=1/r._brightPassPostProcess.height;n[0]=-.5*e,n[1]=.5*i,n[2]=.5*e,n[3]=.5*i,n[4]=-.5*e,n[5]=-.5*i,n[6]=.5*e,n[7]=-.5*i}t.setArray2("dsOffsets",n),t.setFloat("brightThreshold",r.brightThreshold)};this._brightPassPostProcess=new t.PostProcess("hdr","hdr",["dsOffsets","brightThreshold"],[],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS"),this._brightPassPostProcess.onApply=s},i.prototype._createLuminanceGeneratorPostProcess=function(e){var r,n=this,s=i.LUM_STEPS,o=new Array(8),a=new Array(18);this._downSamplePostProcesses=new Array(s);var h=function(t,e){var i=1/t,r=1/e;o[0]=-.5*i,o[1]=.5*r,o[2]=.5*i,o[3]=.5*r,o[4]=-.5*i,o[5]=-.5*r,o[6]=.5*i,o[7]=-.5*r},l=function(t,e){for(var i=0,r=-1;r<2;r++)for(var n=-1;n<2;n++)a[i]=r/t,a[i+1]=n/e,i+=2},c=function(t){n._needUpdate&&h(n._textureAdderPostProcess.width,n._textureAdderPostProcess.height),t.setTextureFromPostProcess("textureSampler",n._textureAdderPostProcess),t.setArray2("lumOffsets",o)},u=function(t){var e=t;return function(t){h(n._downSamplePostProcesses[e].width,n._downSamplePostProcesses[e].height),l(n._downSamplePostProcesses[e].width,n._downSamplePostProcesses[e].height),r=.5/n._downSamplePostProcesses[e].width,t.setTextureFromPostProcess("textureSampler",n._downSamplePostProcesses[e+1]),t.setFloat("halfDestPixelSize",r),t.setArray2("dsOffsets",a)}},p=function(i){var r=e.getEngine().readPixels(0,0,1,1),s=new t.Vector4(1/16581375,1/65025,1/255,1);n._hdrCurrentLuminance=(r[0]*s.x+r[1]*s.y+r[2]*s.z+r[3]*s.w)/100},d={width:Math.pow(3,s-1),height:Math.pow(3,s-1)};this._downSamplePostProcesses[s-1]=new t.PostProcess("hdr","hdr",["lumOffsets"],[],d,null,t.Texture.NEAREST_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE_GENERATOR",t.Engine.TEXTURETYPE_FLOAT),this._downSamplePostProcesses[s-1].onApply=c;for(var f=s-2;f>=0;f--){var m=Math.pow(3,f);d={width:m,height:m};var _="#define DOWN_SAMPLE\n";0===f&&(_+="#define FINAL_DOWN_SAMPLE\n"),this._downSamplePostProcesses[f]=new t.PostProcess("hdr","hdr",["dsOffsets","halfDestPixelSize"],[],d,null,t.Texture.NEAREST_SAMPLINGMODE,e.getEngine(),!1,_,t.Engine.TEXTURETYPE_FLOAT),this._downSamplePostProcesses[f].onApply=u(f),0===f&&(this._downSamplePostProcesses[f].onAfterRender=p)}},i.prototype._createGaussianBlurPostProcess=function(e,i){var r=this,n=new Array(9),s=new Array(9),o=new Array(9),a=["blurOffsets","blurWeights","multiplier"],h=function(t){for(var i={width:e.getEngine().getRenderWidth(),height:e.getEngine().getRenderHeight()},r=0;r<9;r++){var o=(r-4)*(1/(t===!0?i.height:i.width));t?s[r]=o:n[r]=o}},l=function(){for(var t=0,e=0;e<9;e++)t=(e-4)/4,o[e]=r.gaussCoeff*(1/Math.sqrt(2*Math.PI*r.gaussStandDev))*Math.exp(-((t-r.gaussMean)*(t-r.gaussMean))/(2*r.gaussStandDev*r.gaussStandDev))},c=function(t){return function(e){r._needUpdate&&(l(),h(t)),e.setArray("blurOffsets",t?s:n),e.setArray("blurWeights",o),e.setFloat("multiplier",r.gaussMultiplier)}};this._guassianBlurHPostProcess=new t.PostProcess("hdr","hdr",a,[],i/4,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define GAUSSIAN_BLUR_H"),this._guassianBlurHPostProcess.onApply=c(!1),this._guassianBlurVPostProcess=new t.PostProcess("hdr","hdr",a,[],i/4,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define GAUSSIAN_BLUR_V"),this._guassianBlurVPostProcess.onApply=c(!0)},i.LUM_STEPS=6,i}(t.PostProcessRenderPipeline);t.HDRRenderingPipeline=e}(r||(r={}));var r;!function(t){var e=function(){function t(){this.edges=new Array,this.edgesConnectedCount=0}return t}(),i=function(){function i(t,e,i){void 0===e&&(e=.95),void 0===i&&(i=!1),this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._checkVerticesInsteadOfIndices=!1,this._source=t,this._checkVerticesInsteadOfIndices=i,this._epsilon=e,this._prepareRessources(),this._generateEdgesLines()}return i.prototype._prepareRessources=function(){this._lineShader||(this._lineShader=new t.ShaderMaterial("lineShader",this._source.getScene(),"line",{attributes:["position","normal"],uniforms:["worldViewProjection","color","width","aspectRatio"]}),this._lineShader.disableDepthWrite=!0,this._lineShader.backFaceCulling=!1)},i.prototype.dispose=function(){var e=this._buffers[t.VertexBuffer.PositionKind];e&&(e.dispose(),this._buffers[t.VertexBuffer.PositionKind]=null),e=this._buffers[t.VertexBuffer.NormalKind],e&&(e.dispose(),this._buffers[t.VertexBuffer.NormalKind]=null),this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose()},i.prototype._processEdgeForAdjacencies=function(t,e,i,r,n){return t===i&&e===r||t===r&&e===i?0:t===r&&e===n||t===n&&e===r?1:t===n&&e===i||t===i&&e===n?2:-1},i.prototype._processEdgeForAdjacenciesWithVertices=function(t,e,i,r,n){return t.equalsWithEpsilon(i)&&e.equalsWithEpsilon(r)||t.equalsWithEpsilon(r)&&e.equalsWithEpsilon(i)?0:t.equalsWithEpsilon(r)&&e.equalsWithEpsilon(n)||t.equalsWithEpsilon(n)&&e.equalsWithEpsilon(r)?1:t.equalsWithEpsilon(n)&&e.equalsWithEpsilon(i)||t.equalsWithEpsilon(i)&&e.equalsWithEpsilon(n)?2:-1},i.prototype._checkEdge=function(e,i,r,n,s){var o;if(void 0===i)o=!0;else{o=t.Vector3.Dot(r[e],r[i])<this._epsilon}if(o){var a=this._linesPositions.length/3;n.subtract(s).normalize(),this._linesPositions.push(n.x),this._linesPositions.push(n.y),this._linesPositions.push(n.z),this._linesPositions.push(n.x),this._linesPositions.push(n.y),this._linesPositions.push(n.z),this._linesPositions.push(s.x),this._linesPositions.push(s.y),this._linesPositions.push(s.z),this._linesPositions.push(s.x),this._linesPositions.push(s.y),this._linesPositions.push(s.z),this._linesNormals.push(s.x),this._linesNormals.push(s.y),this._linesNormals.push(s.z),this._linesNormals.push(-1),this._linesNormals.push(s.x),this._linesNormals.push(s.y),this._linesNormals.push(s.z),this._linesNormals.push(1),this._linesNormals.push(n.x),this._linesNormals.push(n.y),this._linesNormals.push(n.z),this._linesNormals.push(-1),this._linesNormals.push(n.x),this._linesNormals.push(n.y),this._linesNormals.push(n.z),this._linesNormals.push(1),this._linesIndices.push(a),this._linesIndices.push(a+1),this._linesIndices.push(a+2),this._linesIndices.push(a),this._linesIndices.push(a+2),this._linesIndices.push(a+3)}},i.prototype._generateEdgesLines=function(){var i,r,n=this._source.getVerticesData(t.VertexBuffer.PositionKind),s=this._source.getIndices(),o=new Array,a=new Array;for(i=0;i<s.length;i+=3){r=new e;var h=s[i],l=s[i+1],c=s[i+2];r.p0=new t.Vector3(n[3*h],n[3*h+1],n[3*h+2]),r.p1=new t.Vector3(n[3*l],n[3*l+1],n[3*l+2]),r.p2=new t.Vector3(n[3*c],n[3*c+1],n[3*c+2]);var u=t.Vector3.Cross(r.p1.subtract(r.p0),r.p2.subtract(r.p1));u.normalize(),a.push(u),o.push(r)}for(i=0;i<o.length;i++){r=o[i];for(var p=i+1;p<o.length;p++){var d=o[p];if(3===r.edgesConnectedCount)break;if(3!==d.edgesConnectedCount)for(var f=s[3*p],m=s[3*p+1],_=s[3*p+2],g=0;g<3;g++){var y;if(void 0===r.edges[g]){switch(g){case 0:y=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(r.p0,r.p1,d.p0,d.p1,d.p2):this._processEdgeForAdjacencies(s[3*i],s[3*i+1],f,m,_);break;case 1:y=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(r.p1,r.p2,d.p0,d.p1,d.p2):this._processEdgeForAdjacencies(s[3*i+1],s[3*i+2],f,m,_);break;case 2:y=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(r.p2,r.p0,d.p0,d.p1,d.p2):this._processEdgeForAdjacencies(s[3*i+2],s[3*i],f,m,_)}if(y!==-1&&(r.edges[g]=p,d.edges[y]=i,r.edgesConnectedCount++,d.edgesConnectedCount++,3===r.edgesConnectedCount))break}}}}for(i=0;i<o.length;i++){var v=o[i];this._checkEdge(i,v.edges[0],a,v.p0,v.p1),this._checkEdge(i,v.edges[1],a,v.p1,v.p2),this._checkEdge(i,v.edges[2],a,v.p2,v.p0)}var x=this._source.getScene().getEngine();this._buffers[t.VertexBuffer.PositionKind]=new t.VertexBuffer(x,this._linesPositions,t.VertexBuffer.PositionKind,!1),this._buffers[t.VertexBuffer.NormalKind]=new t.VertexBuffer(x,this._linesNormals,t.VertexBuffer.NormalKind,!1,!1,4),this._ib=x.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length},i.prototype.render=function(){if(this._lineShader.isReady()){var e=this._source.getScene(),i=e.getEngine();this._lineShader._preBind(),i.bindBuffers(this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===t.Camera.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",i.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),i.draw(!0,0,this._indicesCount),this._lineShader.unbind(),i.setDepthWrite(!0)}},i}();t.EdgesRenderer=i}(r||(r={}));var r;!function(t){!function(t){t[t.Hable=0]="Hable",t[t.Reinhard=1]="Reinhard",t[t.HejiDawson=2]="HejiDawson",t[t.Photographic=3]="Photographic"}(t.TonemappingOperator||(t.TonemappingOperator={}));var e=t.TonemappingOperator,i=function(i){function r(r,n,s,o,a,h,l){var c=this;void 0===a&&(a=t.Texture.BILINEAR_SAMPLINGMODE),void 0===l&&(l=t.Engine.TEXTURETYPE_UNSIGNED_INT),i.call(this,r,"tonemap",["_ExposureAdjustment"],null,1,o,a,h,!0,u,l),this._operator=n,this.exposureAdjustment=s;var u="#define ";this._operator===e.Hable?u+="HABLE_TONEMAPPING":this._operator===e.Reinhard?u+="REINHARD_TONEMAPPING":this._operator===e.HejiDawson?u+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":this._operator===e.Photographic&&(u+="PHOTOGRAPHIC_TONEMAPPING"),this.updateEffect(u),this.onApply=function(t){t.setFloat("_ExposureAdjustment",c.exposureAdjustment)}}return o(r,i),r}(t.PostProcess);t.TonemapPostProcess=i}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n){var s=this;void 0===n&&(n=!0),this.name=e,this._viewMatrix=t.Matrix.Identity(),this._target=t.Vector3.Zero(),this._add=t.Vector3.Zero(),this.invertYAxis=!1,this.position=t.Vector3.Zero(),this._scene=r,this._scene.reflectionProbes.push(this),this._renderTargetTexture=new t.RenderTargetTexture(e,i,r,n,!0,t.Engine.TEXTURETYPE_UNSIGNED_INT,!0),this._renderTargetTexture.onBeforeRenderObservable.add(function(e){switch(e){case 0:s._add.copyFromFloats(1,0,0);break;case 1:s._add.copyFromFloats(-1,0,0);break;case 2:s._add.copyFromFloats(0,s.invertYAxis?1:-1,0);break;case 3:s._add.copyFromFloats(0,s.invertYAxis?-1:1,0);break;case 4:s._add.copyFromFloats(0,0,1);break;case 5:s._add.copyFromFloats(0,0,-1)}s._attachedMesh&&s.position.copyFrom(s._attachedMesh.getAbsolutePosition()),s.position.addToRef(s._add,s._target),t.Matrix.LookAtLHToRef(s.position,s._target,t.Vector3.Up(),s._viewMatrix),r.setTransformMatrix(s._viewMatrix,s._projectionMatrix)}),this._renderTargetTexture.onAfterUnbindObservable.add(function(){r.updateTransformMatrix(!0)}),this._projectionMatrix=t.Matrix.PerspectiveFovLH(Math.PI/2,1,r.activeCamera.minZ,r.activeCamera.maxZ)}return Object.defineProperty(e.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(t){this._renderTargetTexture.refreshRate=t},enumerable:!0,configurable:!0}),e.prototype.getScene=function(){return this._scene},Object.defineProperty(e.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:!0,configurable:!0}),e.prototype.attachToMesh=function(t){this._attachedMesh=t},e.prototype.dispose=function(){var t=this._scene.reflectionProbes.indexOf(this);t!==-1&&this._scene.reflectionProbes.splice(t,1),this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null)},e}();t.ReflectionProbe=e}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r,n,s,o,a){this.idx=0,this.color=new t.Color4(1,1,1,1),this.position=t.Vector3.Zero(),this.rotation=t.Vector3.Zero(),this.scaling=new t.Vector3(1,1,1),this.uvs=new t.Vector4(0,0,1,1),this.velocity=t.Vector3.Zero(),this.alive=!0,this.isVisible=!0,this._pos=0,this.shapeId=0,this.idxInShape=0,this.idx=e,this._pos=i,this._model=r,this.shapeId=n,this.idxInShape=s,this._sps=o,a&&(this._modelBoundingInfo=a,this._boundingInfo=new t.BoundingInfo(a.minimum,a.maximum))}return Object.defineProperty(e.prototype,"scale",{get:function(){return this.scaling},set:function(t){this.scaling=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(t){this.rotationQuaternion=t},enumerable:!0,configurable:!0}),e.prototype.intersectsMesh=function(e){return!(!this._boundingInfo||!e._boundingInfo)&&(this._sps._bSphereOnly?t.BoundingSphere.Intersects(this._boundingInfo.boundingSphere,e._boundingInfo.boundingSphere):this._boundingInfo.intersects(e._boundingInfo,!1))},e}();t.SolidParticle=e;var i=function(){function t(t,e,i,r,n){this.shapeID=t,this._shape=e,this._shapeUV=i,this._positionFunction=r,this._vertexFunction=n}return t}();t.ModelShape=i}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r){this.particles=new Array,this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!0,this.counter=0,this.vars={},this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._shapeCounter=0,this._copy=new t.SolidParticle(null,null,null,null,null,null),this._color=new t.Color4(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._cam_axisZ=t.Vector3.Zero(),this._cam_axisY=t.Vector3.Zero(),this._cam_axisX=t.Vector3.Zero(),this._axisX=t.Axis.X,this._axisY=t.Axis.Y,this._axisZ=t.Axis.Z,this._camDir=t.Vector3.Zero(),this._rotMatrix=new t.Matrix,this._invertMatrix=new t.Matrix,this._rotated=t.Vector3.Zero(),this._quaternion=new t.Quaternion,this._vertex=t.Vector3.Zero(),this._normal=t.Vector3.Zero(),this._yaw=0,this._pitch=0,this._roll=0,this._halfroll=0,this._halfpitch=0,this._halfyaw=0,this._sinRoll=0,this._cosRoll=0,this._sinPitch=0,this._cosPitch=0,this._sinYaw=0,this._cosYaw=0,this._w=0,this._minimum=t.Tmp.Vector3[0],this._maximum=t.Tmp.Vector3[1],this._scale=t.Tmp.Vector3[2],this._translation=t.Tmp.Vector3[3],this._minBbox=t.Tmp.Vector3[4],this._maxBbox=t.Tmp.Vector3[5],this._particlesIntersect=!1,this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this.name=e,this._scene=i,this._camera=i.activeCamera,this._pickable=!!r&&r.isPickable,this._particlesIntersect=!!r&&r.particleIntersection,this._bSphereOnly=!!r&&r.boundingSphereOnly,this._bSphereRadiusFactor=r&&r.bSphereRadiusFactor?r.bSphereRadiusFactor:1,r&&r.updatable?this._updatable=r.updatable:this._updatable=!0,this._pickable&&(this.pickedParticles=[])}return e.prototype.buildMesh=function(){if(0===this.nbParticles){var e=t.MeshBuilder.CreateDisc("",{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),this.recomputeNormals&&t.VertexData.ComputeNormals(this._positions32,this._indices,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals);var i=new t.VertexData;i.set(this._positions32,t.VertexBuffer.PositionKind),i.indices=this._indices,i.set(this._normals32,t.VertexBuffer.NormalKind),this._uvs32&&i.set(this._uvs32,t.VertexBuffer.UVKind),this._colors32&&i.set(this._colors32,t.VertexBuffer.ColorKind);var r=new t.Mesh(this.name,this._scene);return i.applyToMesh(r,this._updatable),this.mesh=r,this.mesh.isPickable=this._pickable,this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0),r},e.prototype.digest=function(e,i){var r=i&&i.facetNb||1,n=i&&i.number,s=i&&i.delta||0,o=e.getVerticesData(t.VertexBuffer.PositionKind),a=e.getIndices(),h=e.getVerticesData(t.VertexBuffer.UVKind),l=e.getVerticesData(t.VertexBuffer.ColorKind),c=e.getVerticesData(t.VertexBuffer.NormalKind),u=0,p=a.length/3;n?(n=n>p?p:n,r=Math.round(p/n),s=0):r=r>p?p:r;for(var d=[],f=[],m=[],_=[],g=t.Tmp.Vector3[0],y=r;u<p;){r=y+Math.floor((1+s)*Math.random()),u>p-r&&(r=p-u),d.length=0,f.length=0,m.length=0,_.length=0;for(var v=0,x=3*u;x<3*(u+r);x++){f.push(v);var b=a[x];d.push(o[3*b],o[3*b+1],o[3*b+2]),h&&m.push(h[2*b],h[2*b+1]),l&&_.push(l[4*b],l[4*b+1],l[4*b+2],l[4*b+3]),v++}var P,T=this.nbParticles,S=this._posToShape(d),A=this._uvsToShapeUV(m);for(P=0;P<S.length;P++)g.addInPlace(S[P]);for(g.scaleInPlace(1/S.length),P=0;P<S.length;P++)S[P].subtractInPlace(g);var C;this._particlesIntersect&&(C=new t.BoundingInfo(g,g));var E=new t.ModelShape(this._shapeCounter,S,A,null,null);this._meshBuilder(this._index,S,this._positions,f,this._indices,m,this._uvs,_,this._colors,c,this._normals,T,0,null),this._addParticle(T,this._positions.length,E,this._shapeCounter,0,C),this.particles[this.nbParticles].position.addInPlace(g),this._index+=S.length,T++,this.nbParticles++,this._shapeCounter++,u+=r}return this},e.prototype._resetCopy=function(){this._copy.position.x=0,this._copy.position.y=0,this._copy.position.z=0,this._copy.rotation.x=0,this._copy.rotation.y=0,this._copy.rotation.z=0,this._copy.rotationQuaternion=null,this._copy.scaling.x=1,this._copy.scaling.y=1,this._copy.scaling.z=1,this._copy.uvs.x=0,this._copy.uvs.y=0,this._copy.uvs.z=1,this._copy.uvs.w=1,this._copy.color=null},e.prototype._meshBuilder=function(e,i,r,n,s,o,a,h,l,c,u,p,d,f){var m,_=0,g=0,y=0;for(this._resetCopy(),f&&f.positionFunction&&f.positionFunction(this._copy,p,d),this._copy.rotationQuaternion?this._quaternion.copyFrom(this._copy.rotationQuaternion):(this._yaw=this._copy.rotation.y,this._pitch=this._copy.rotation.x,this._roll=this._copy.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix(),m=0;m<i.length;m++)this._vertex.x=i[m].x,this._vertex.y=i[m].y,this._vertex.z=i[m].z,f&&f.vertexFunction&&f.vertexFunction(this._copy,this._vertex,m),this._vertex.x*=this._copy.scaling.x,this._vertex.y*=this._copy.scaling.y,this._vertex.z*=this._copy.scaling.z,t.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated),r.push(this._copy.position.x+this._rotated.x,this._copy.position.y+this._rotated.y,this._copy.position.z+this._rotated.z),o&&(a.push((this._copy.uvs.z-this._copy.uvs.x)*o[_]+this._copy.uvs.x,(this._copy.uvs.w-this._copy.uvs.y)*o[_+1]+this._copy.uvs.y),_+=2),this._copy.color?this._color=this._copy.color:h&&void 0!==h[g]?(this._color.r=h[g],this._color.g=h[g+1],this._color.b=h[g+2],this._color.a=h[g+3]):(this._color.r=1,this._color.g=1,this._color.b=1,this._color.a=1),l.push(this._color.r,this._color.g,this._color.b,this._color.a),g+=4,!this.recomputeNormals&&c&&(this._normal.x=c[y],this._normal.y=c[y+1],this._normal.z=c[y+2],t.Vector3.TransformCoordinatesToRef(this._normal,this._rotMatrix,this._normal),u.push(this._normal.x,this._normal.y,this._normal.z),y+=3);for(m=0;m<n.length;m++)s.push(e+n[m]);if(this._pickable){var v=n.length/3;for(m=0;m<v;m++)this.pickedParticles.push({idx:p,faceId:m})}},e.prototype._posToShape=function(e){for(var i=[],r=0;r<e.length;r+=3)i.push(new t.Vector3(e[r],e[r+1],e[r+2]));return i},e.prototype._uvsToShapeUV=function(t){var e=[];if(t)for(var i=0;i<t.length;i++)e.push(t[i]);return e},e.prototype._addParticle=function(e,i,r,n,s,o){this.particles.push(new t.SolidParticle(e,i,r,n,s,this,o))},e.prototype.addShape=function(e,i,r){var n,s=e.getVerticesData(t.VertexBuffer.PositionKind),o=e.getIndices(),a=e.getVerticesData(t.VertexBuffer.UVKind),h=e.getVerticesData(t.VertexBuffer.ColorKind),l=e.getVerticesData(t.VertexBuffer.NormalKind);this._particlesIntersect&&(n=e.getBoundingInfo());for(var c=this._posToShape(s),u=this._uvsToShapeUV(a),p=r?r.positionFunction:null,d=r?r.vertexFunction:null,f=new t.ModelShape(this._shapeCounter,c,u,p,d),m=this.nbParticles,_=0;_<i;_++)this._meshBuilder(this._index,c,this._positions,o,this._indices,a,this._uvs,h,this._colors,l,this._normals,m,_,r),this._updatable&&this._addParticle(m,this._positions.length,f,this._shapeCounter,_,n),this._index+=c.length,m++;return this.nbParticles+=i,++this._shapeCounter-1},e.prototype._rebuildParticle=function(e){this._resetCopy(),e._model._positionFunction&&e._model._positionFunction(this._copy,e.idx,e.idxInShape),this._copy.rotationQuaternion?this._quaternion.copyFrom(this._copy.rotationQuaternion):(this._yaw=this._copy.rotation.y,this._pitch=this._copy.rotation.x,this._roll=this._copy.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix(),this._shape=e._model._shape;for(var i=0;i<this._shape.length;i++)this._vertex.x=this._shape[i].x,this._vertex.y=this._shape[i].y,this._vertex.z=this._shape[i].z,e._model._vertexFunction&&e._model._vertexFunction(this._copy,this._vertex,i),this._vertex.x*=this._copy.scaling.x,this._vertex.y*=this._copy.scaling.y,this._vertex.z*=this._copy.scaling.z,t.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated),this._positions32[e._pos+3*i]=this._copy.position.x+this._rotated.x,this._positions32[e._pos+3*i+1]=this._copy.position.y+this._rotated.y,this._positions32[e._pos+3*i+2]=this._copy.position.z+this._rotated.z;e.position.x=0,e.position.y=0,e.position.z=0,e.rotation.x=0,e.rotation.y=0,e.rotation.z=0,e.rotationQuaternion=null,e.scaling.x=1,e.scaling.y=1,e.scaling.z=1},e.prototype.rebuildMesh=function(){for(var e=0;e<this.particles.length;e++)this._rebuildParticle(this.particles[e]);this.mesh.updateVerticesData(t.VertexBuffer.PositionKind,this._positions32,!1,!1)},e.prototype.setParticles=function(e,i,r){if(void 0===e&&(e=0),void 0===i&&(i=this.nbParticles-1),void 0===r&&(r=!0),this._updatable){this.beforeUpdateParticles(e,i,r),this._cam_axisX.x=1,this._cam_axisX.y=0,this._cam_axisX.z=0,this._cam_axisY.x=0,this._cam_axisY.y=1,this._cam_axisY.z=0,this._cam_axisZ.x=0,this._cam_axisZ.y=0,this._cam_axisZ.z=1,this.billboard&&this.mesh._worldMatrix.decompose(this._scale,this._quaternion,this._translation)&&(this._quaternionToRotationMatrix(),this._rotMatrix.invertToRef(this._invertMatrix),this._camera._currentTarget.subtractToRef(this._camera.globalPosition,this._camDir),t.Vector3.TransformCoordinatesToRef(this._camDir,this._invertMatrix,this._cam_axisZ),this._cam_axisZ.normalize(),t.Vector3.CrossToRef(this._cam_axisZ,this._axisX,this._cam_axisY),t.Vector3.CrossToRef(this._cam_axisY,this._cam_axisZ,this._cam_axisX),this._cam_axisY.normalize(),this._cam_axisX.normalize()),t.Matrix.IdentityToRef(this._rotMatrix);var n=0,s=0,o=0,a=0,h=0,l=0,c=0;this._computeBoundingBox&&(t.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this._minimum),t.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this._maximum)),i=i>this.nbParticles-1?this.nbParticles-1:i;for(var u=e;u<=i;u++){if(this._particle=this.particles[u],this._shape=this._particle._model._shape,this._shapeUV=this._particle._model._shapeUV,this.updateParticle(this._particle),this._particle.isVisible)for(this.billboard&&(this._particle.rotation.x=0,this._particle.rotation.y=0),(this._computeParticleRotation||this.billboard)&&(this._particle.rotationQuaternion?this._quaternion.copyFrom(this._particle.rotationQuaternion):(this._yaw=this._particle.rotation.y,this._pitch=this._particle.rotation.x,this._roll=this._particle.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix()),c=0;c<this._shape.length;c++)n=s+3*c,o=a+4*c,h=l+2*c,this._vertex.x=this._shape[c].x,this._vertex.y=this._shape[c].y,this._vertex.z=this._shape[c].z,this._computeParticleVertex&&this.updateParticleVertex(this._particle,this._vertex,c),this._vertex.x*=this._particle.scaling.x,this._vertex.y*=this._particle.scaling.y,this._vertex.z*=this._particle.scaling.z,this._w=this._vertex.x*this._rotMatrix.m[3]+this._vertex.y*this._rotMatrix.m[7]+this._vertex.z*this._rotMatrix.m[11]+this._rotMatrix.m[15],this._rotated.x=(this._vertex.x*this._rotMatrix.m[0]+this._vertex.y*this._rotMatrix.m[4]+this._vertex.z*this._rotMatrix.m[8]+this._rotMatrix.m[12])/this._w,this._rotated.y=(this._vertex.x*this._rotMatrix.m[1]+this._vertex.y*this._rotMatrix.m[5]+this._vertex.z*this._rotMatrix.m[9]+this._rotMatrix.m[13])/this._w,this._rotated.z=(this._vertex.x*this._rotMatrix.m[2]+this._vertex.y*this._rotMatrix.m[6]+this._vertex.z*this._rotMatrix.m[10]+this._rotMatrix.m[14])/this._w,this._positions32[n]=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,this._positions32[n+1]=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,this._positions32[n+2]=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z,this._computeBoundingBox&&(this._positions32[n]<this._minimum.x&&(this._minimum.x=this._positions32[n]),this._positions32[n]>this._maximum.x&&(this._maximum.x=this._positions32[n]),this._positions32[n+1]<this._minimum.y&&(this._minimum.y=this._positions32[n+1]),this._positions32[n+1]>this._maximum.y&&(this._maximum.y=this._positions32[n+1]),this._positions32[n+2]<this._minimum.z&&(this._minimum.z=this._positions32[n+2]),this._positions32[n+2]>this._maximum.z&&(this._maximum.z=this._positions32[n+2])),this._computeParticleVertex||(this._normal.x=this._fixedNormal32[n],this._normal.y=this._fixedNormal32[n+1],this._normal.z=this._fixedNormal32[n+2],this._w=this._normal.x*this._rotMatrix.m[3]+this._normal.y*this._rotMatrix.m[7]+this._normal.z*this._rotMatrix.m[11]+this._rotMatrix.m[15],this._rotated.x=(this._normal.x*this._rotMatrix.m[0]+this._normal.y*this._rotMatrix.m[4]+this._normal.z*this._rotMatrix.m[8]+this._rotMatrix.m[12])/this._w,this._rotated.y=(this._normal.x*this._rotMatrix.m[1]+this._normal.y*this._rotMatrix.m[5]+this._normal.z*this._rotMatrix.m[9]+this._rotMatrix.m[13])/this._w,this._rotated.z=(this._normal.x*this._rotMatrix.m[2]+this._normal.y*this._rotMatrix.m[6]+this._normal.z*this._rotMatrix.m[10]+this._rotMatrix.m[14])/this._w,this._normals32[n]=this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,this._normals32[n+1]=this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,this._normals32[n+2]=this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z),this._computeParticleColor&&(this._colors32[o]=this._particle.color.r,this._colors32[o+1]=this._particle.color.g,this._colors32[o+2]=this._particle.color.b,this._colors32[o+3]=this._particle.color.a),this._computeParticleTexture&&(this._uvs32[h]=this._shapeUV[2*c]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x,this._uvs32[h+1]=this._shapeUV[2*c+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y);else for(c=0;c<this._shape.length;c++)n=s+3*c,o=a+4*c,h=l+2*c,this._positions32[n]=this._camera.position.x,this._positions32[n+1]=this._camera.position.y,this._positions32[n+2]=this._camera.position.z,this._normals32[n]=0,this._normals32[n+1]=0,this._normals32[n+2]=0,this._computeParticleColor&&(this._colors32[o]=this._particle.color.r,this._colors32[o+1]=this._particle.color.g,this._colors32[o+2]=this._particle.color.b,this._colors32[o+3]=this._particle.color.a),this._computeParticleTexture&&(this._uvs32[h]=this._shapeUV[2*c]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x,this._uvs32[h+1]=this._shapeUV[2*c+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y);if(this._particlesIntersect){var p=this._particle._boundingInfo,d=p.boundingBox,f=p.boundingSphere;if(!this._bSphereOnly){for(var m=0;m<d.vectors.length;m++)this._vertex.x=this._particle._modelBoundingInfo.boundingBox.vectors[m].x*this._particle.scaling.x,this._vertex.y=this._particle._modelBoundingInfo.boundingBox.vectors[m].y*this._particle.scaling.y,this._vertex.z=this._particle._modelBoundingInfo.boundingBox.vectors[m].z*this._particle.scaling.z,this._w=this._vertex.x*this._rotMatrix.m[3]+this._vertex.y*this._rotMatrix.m[7]+this._vertex.z*this._rotMatrix.m[11]+this._rotMatrix.m[15],this._rotated.x=(this._vertex.x*this._rotMatrix.m[0]+this._vertex.y*this._rotMatrix.m[4]+this._vertex.z*this._rotMatrix.m[8]+this._rotMatrix.m[12])/this._w,this._rotated.y=(this._vertex.x*this._rotMatrix.m[1]+this._vertex.y*this._rotMatrix.m[5]+this._vertex.z*this._rotMatrix.m[9]+this._rotMatrix.m[13])/this._w,this._rotated.z=(this._vertex.x*this._rotMatrix.m[2]+this._vertex.y*this._rotMatrix.m[6]+this._vertex.z*this._rotMatrix.m[10]+this._rotMatrix.m[14])/this._w,d.vectors[m].x=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,d.vectors[m].y=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,d.vectors[m].z=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z;d._update(this.mesh._worldMatrix)}this._minBbox.x=this._particle._modelBoundingInfo.minimum.x*this._particle.scaling.x,this._minBbox.y=this._particle._modelBoundingInfo.minimum.y*this._particle.scaling.y,this._minBbox.z=this._particle._modelBoundingInfo.minimum.z*this._particle.scaling.z,this._maxBbox.x=this._particle._modelBoundingInfo.maximum.x*this._particle.scaling.x,this._maxBbox.y=this._particle._modelBoundingInfo.maximum.y*this._particle.scaling.y,this._maxBbox.z=this._particle._modelBoundingInfo.maximum.z*this._particle.scaling.z,f.center.x=this._particle.position.x+.5*(this._minBbox.x+this._maxBbox.x),f.center.y=this._particle.position.y+.5*(this._minBbox.y+this._maxBbox.y),f.center.z=this._particle.position.z+.5*(this._minBbox.z+this._maxBbox.z),f.radius=.5*this._bSphereRadiusFactor*Math.sqrt((this._maxBbox.x-this._minBbox.x)*(this._maxBbox.x-this._minBbox.x)+(this._maxBbox.y-this._minBbox.y)*(this._maxBbox.y-this._minBbox.y)+(this._maxBbox.z-this._minBbox.z)*(this._maxBbox.z-this._minBbox.z)),f._update(this.mesh._worldMatrix)}s=n+3,a=o+4,l=h+2}if(r&&(this._computeParticleColor&&this.mesh.updateVerticesData(t.VertexBuffer.ColorKind,this._colors32,!1,!1),this._computeParticleTexture&&this.mesh.updateVerticesData(t.VertexBuffer.UVKind,this._uvs32,!1,!1),this.mesh.updateVerticesData(t.VertexBuffer.PositionKind,this._positions32,!1,!1),!this.mesh.areNormalsFrozen)){if(this._computeParticleVertex){t.VertexData.ComputeNormals(this._positions32,this._indices,this._normals32);for(var _=0;_<this._normals32.length;_++)this._fixedNormal32[_]=this._normals32[_]}this.mesh.updateVerticesData(t.VertexBuffer.NormalKind,this._normals32,!1,!1)}this._computeBoundingBox&&(this.mesh._boundingInfo=new t.BoundingInfo(this._minimum,this._maximum),this.mesh._boundingInfo.update(this.mesh._worldMatrix)),this.afterUpdateParticles(e,i,r)}},e.prototype._quaternionRotationYPR=function(){this._halfroll=.5*this._roll,this._halfpitch=.5*this._pitch,this._halfyaw=.5*this._yaw,this._sinRoll=Math.sin(this._halfroll),this._cosRoll=Math.cos(this._halfroll),this._sinPitch=Math.sin(this._halfpitch),this._cosPitch=Math.cos(this._halfpitch),this._sinYaw=Math.sin(this._halfyaw),this._cosYaw=Math.cos(this._halfyaw),this._quaternion.x=this._cosYaw*this._sinPitch*this._cosRoll+this._sinYaw*this._cosPitch*this._sinRoll,this._quaternion.y=this._sinYaw*this._cosPitch*this._cosRoll-this._cosYaw*this._sinPitch*this._sinRoll,this._quaternion.z=this._cosYaw*this._cosPitch*this._sinRoll-this._sinYaw*this._sinPitch*this._cosRoll,this._quaternion.w=this._cosYaw*this._cosPitch*this._cosRoll+this._sinYaw*this._sinPitch*this._sinRoll},e.prototype._quaternionToRotationMatrix=function(){this._rotMatrix.m[0]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.z*this._quaternion.z),this._rotMatrix.m[1]=2*(this._quaternion.x*this._quaternion.y+this._quaternion.z*this._quaternion.w),this._rotMatrix.m[2]=2*(this._quaternion.z*this._quaternion.x-this._quaternion.y*this._quaternion.w),this._rotMatrix.m[3]=0,this._rotMatrix.m[4]=2*(this._quaternion.x*this._quaternion.y-this._quaternion.z*this._quaternion.w),this._rotMatrix.m[5]=1-2*(this._quaternion.z*this._quaternion.z+this._quaternion.x*this._quaternion.x),this._rotMatrix.m[6]=2*(this._quaternion.y*this._quaternion.z+this._quaternion.x*this._quaternion.w),this._rotMatrix.m[7]=0,this._rotMatrix.m[8]=2*(this._quaternion.z*this._quaternion.x+this._quaternion.y*this._quaternion.w),this._rotMatrix.m[9]=2*(this._quaternion.y*this._quaternion.z-this._quaternion.x*this._quaternion.w),this._rotMatrix.m[10]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.x*this._quaternion.x),this._rotMatrix.m[11]=0,this._rotMatrix.m[12]=0,this._rotMatrix.m[13]=0,this._rotMatrix.m[14]=0,this._rotMatrix.m[15]=1},e.prototype.dispose=function(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null},e.prototype.refreshVisibleSize=function(){this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo()},e.prototype.setVisibilityBox=function(e){var i=e/2;this.mesh._boundingInfo=new t.BoundingInfo(new t.Vector3(-i,-i,-i),new t.Vector3(i,i,i))},Object.defineProperty(e.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(t){this._alwaysVisible=t,this.mesh.alwaysSelectAsActiveMesh=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(t){this._isVisibilityBoxLocked=t,this.mesh.getBoundingInfo().isLocked=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(t){this._computeParticleRotation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(t){this._computeParticleColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(t){this._computeParticleTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(t){this._computeParticleVertex=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(t){this._computeBoundingBox=t},enumerable:!0,configurable:!0}),e.prototype.initParticles=function(){},e.prototype.recycleParticle=function(t){return t},e.prototype.updateParticle=function(t){return t},e.prototype.updateParticleVertex=function(t,e,i){return e},e.prototype.beforeUpdateParticles=function(t,e,i){},e.prototype.afterUpdateParticles=function(t,e,i){},e}();t.SolidParticleSystem=e}(r||(r={}));var r;!function(t){!function(e){var i=function(){function t(t,e,i,r){this.name=t,this.worldAxisForNormal=e,this.worldAxisForFileX=i,this.worldAxisForFileY=r}return t}(),r=function(){function e(){}return e.ConvertCubeMapToSphericalPolynomial=function(e){for(var i=new t.SphericalHarmonics,r=0,n=2/e.size,s=n,o=.5*n-1,a=0;a<6;a++)for(var h=this.FileFaces[a],l=e[h.name],c=o,u=0;u<e.size;u++){for(var p=o,d=0;d<e.size;d++){var f=h.worldAxisForFileX.scale(p).add(h.worldAxisForFileY.scale(c)).add(h.worldAxisForNormal);f.normalize();var m,_=Math.pow(1+p*p+c*c,-1.5),g=l[u*e.size*3+3*d+0],y=l[u*e.size*3+3*d+1],v=l[u*e.size*3+3*d+2],m=new t.Color3(g,y,v);i.addLight(f,m,_),r+=_,p+=n}c+=s}var x=4*Math.PI,b=x/r;return i.scale(b),i.scale(1/Math.PI),t.SphericalPolynomial.getSphericalPolynomialFromHarmonics(i)},e.FileFaces=[new i("right",new t.Vector3(1,0,0),new t.Vector3(0,0,-1),new t.Vector3(0,-1,0)),new i("left",new t.Vector3(-1,0,0),new t.Vector3(0,0,1),new t.Vector3(0,-1,0)),new i("up",new t.Vector3(0,1,0),new t.Vector3(1,0,0),new t.Vector3(0,0,1)),new i("down",new t.Vector3(0,-1,0),new t.Vector3(1,0,0),new t.Vector3(0,0,-1)),new i("front",new t.Vector3(0,0,1),new t.Vector3(1,0,0),new t.Vector3(0,-1,0)),new i("back",new t.Vector3(0,0,-1),new t.Vector3(-1,0,0),new t.Vector3(0,-1,0))],e}();e.CubeMapToSphericalPolynomialTools=r}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){!function(e){var i=function(){function e(){}return e.ConvertPanoramaToCubemap=function(t,e,i,r){if(!t)throw"ConvertPanoramaToCubemap: input cannot be null";if(t.length!=e*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";return{front:this.CreateCubemapTexture(r,this.FACE_FRONT,t,e,i),back:this.CreateCubemapTexture(r,this.FACE_BACK,t,e,i),left:this.CreateCubemapTexture(r,this.FACE_LEFT,t,e,i),right:this.CreateCubemapTexture(r,this.FACE_RIGHT,t,e,i),up:this.CreateCubemapTexture(r,this.FACE_UP,t,e,i),down:this.CreateCubemapTexture(r,this.FACE_DOWN,t,e,i),size:r}},e.CreateCubemapTexture=function(t,e,i,r,n){for(var s=new ArrayBuffer(t*t*4*3),o=new Float32Array(s),a=e[1].subtract(e[0]).scale(1/t),h=e[3].subtract(e[2]).scale(1/t),l=1/t,c=0,u=0;u<t;u++){for(var p=e[0],d=e[2],f=0;f<t;f++){var m=d.subtract(p).scale(c).add(p);m.normalize();var _=this.CalcProjectionSpherical(m,i,r,n);o[u*t*3+3*f+0]=_.r,o[u*t*3+3*f+1]=_.g,o[u*t*3+3*f+2]=_.b,p=p.add(a),d=d.add(h)}c+=l}return o},e.CalcProjectionSpherical=function(t,e,i,r){for(var n=Math.atan2(t.z,t.x),s=Math.acos(t.y);n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;var o=n/Math.PI,a=s/Math.PI;o=.5*o+.5;var h=Math.round(o*i);h<0?h=0:h>=i&&(h=i-1);var l=Math.round(a*r);l<0?l=0:l>=r&&(l=r-1);var c=r-l-1;return{r:e[c*i*3+3*h+0],g:e[c*i*3+3*h+1],b:e[c*i*3+3*h+2]}},e.FACE_FRONT=[new t.Vector3(-1,-1,-1),new t.Vector3(1,-1,-1),new t.Vector3(-1,1,-1),new t.Vector3(1,1,-1)],e.FACE_BACK=[new t.Vector3(1,-1,1),new t.Vector3(-1,-1,1),new t.Vector3(1,1,1),new t.Vector3(-1,1,1)],e.FACE_RIGHT=[new t.Vector3(1,-1,-1),new t.Vector3(1,-1,1),new t.Vector3(1,1,-1),new t.Vector3(1,1,1)],e.FACE_LEFT=[new t.Vector3(-1,-1,1),new t.Vector3(-1,-1,-1),new t.Vector3(-1,1,1),new t.Vector3(-1,1,-1)],e.FACE_DOWN=[new t.Vector3(-1,1,-1),new t.Vector3(1,1,-1),new t.Vector3(-1,1,1),new t.Vector3(1,1,1)],e.FACE_UP=[new t.Vector3(-1,-1,1),new t.Vector3(1,-1,1),new t.Vector3(-1,-1,-1),new t.Vector3(1,-1,-1)],e}();e.PanoramaToCubeMapTools=i}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){!function(t){var e=function(){function e(){}return e.Ldexp=function(t,e){return e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e)},e.Rgbe2float=function(t,e,i,r,n,s){n>0?(n=this.Ldexp(1,n-136),t[s+0]=e*n,t[s+1]=i*n,t[s+2]=r*n):(t[s+0]=0,t[s+1]=0,t[s+2]=0)},e.readStringLine=function(t,e){for(var i="",r="",n=e;n<t.length-e&&"\n"!=(r=String.fromCharCode(t[n]));n++)i+=r;return i},e.RGBE_ReadHeader=function(t){var e=0,i=0,r=this.readStringLine(t,0);if("#"!=r[0]||"?"!=r[1])throw"Bad HDR Format.";var n=!1,s=!1,o=0;do{o+=r.length+1,r=this.readStringLine(t,o),"FORMAT=32-bit_rle_rgbe"==r?s=!0:0==r.length&&(n=!0)}while(!n);if(!s)throw"HDR Bad header format, unsupported FORMAT";o+=r.length+1,r=this.readStringLine(t,o);var a=/^\-Y (.*) \+X (.*)$/g,h=a.exec(r);if(h.length<3)throw"HDR Bad header format, no size";if(i=parseInt(h[2]),e=parseInt(h[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return o+=r.length+1,{height:e,width:i,dataPosition:o}},e.GetCubeMapTextureData=function(e,i){var r=new Uint8Array(e),n=this.RGBE_ReadHeader(r),s=this.RGBE_ReadPixels_RLE(r,n);return t.PanoramaToCubeMapTools.ConvertPanoramaToCubemap(s,n.width,n.height,i)},e.RGBE_ReadPixels=function(t,e){return this.RGBE_ReadPixels_RLE(t,e)},e.RGBE_ReadPixels_RLE=function(t,e){for(var i,r,n,s,o,a=e.height,h=e.width,l=e.dataPosition,c=0,u=0,p=0,d=new ArrayBuffer(4*h),f=new Uint8Array(d),m=new ArrayBuffer(e.width*e.height*4*3),_=new Float32Array(m);a>0;){if(i=t[l++],r=t[l++],n=t[l++],s=t[l++],2!=i||2!=r||128&n)throw"HDR Bad header format, not RLE";if((n<<8|s)!=h)throw"HDR Bad header format, wrong scan line width";for(c=0,p=0;p<4;p++)for(u=(p+1)*h;c<u;)if(i=t[l++],r=t[l++],i>128){if(0==(o=i-128)||o>u-c)throw"HDR Bad Format, bad scanline data (run)";for(;o-- >0;)f[c++]=r}else{if(0==(o=i)||o>u-c)throw"HDR Bad Format, bad scanline data (non-run)";if(f[c++]=r,--o>0)for(var g=0;g<o;g++)f[c++]=t[l++]}for(p=0;p<h;p++)i=f[p],r=f[p+h],n=f[p+2*h],s=f[p+3*h],this.Rgbe2float(_,i,r,n,s,(e.height-a)*h*3+3*p);a--}return _},e}();t.HDRTools=e}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){!function(e){var i=function(){function e(){this.min=new t.Vector3(0,0,0),this.max=new t.Vector3(0,0,0),this.clear()}return e.prototype.clear=function(){this.min.x=e.MAX,this.min.y=e.MAX,this.min.z=e.MAX,this.max.x=e.MIN,this.max.y=e.MIN,this.max.z=e.MIN},e.prototype.augment=function(t,e,i){this.min.x=Math.min(this.min.x,t),this.min.y=Math.min(this.min.y,e),this.min.z=Math.min(this.min.z,i),this.max.x=Math.max(this.max.x,t),this.max.y=Math.max(this.max.y,e),this.max.z=Math.max(this.max.z,i)},e.prototype.clampMin=function(t,e,i){this.min.x=Math.max(this.min.x,t),this.min.y=Math.max(this.min.y,e),this.min.z=Math.max(this.min.z,i)},e.prototype.clampMax=function(t,e,i){this.max.x=Math.min(this.max.x,t),this.max.y=Math.min(this.max.y,e),this.max.z=Math.min(this.max.z,i)},e.prototype.empty=function(){return this.min.x>this.max.y||this.min.y>this.max.y||this.min.z>this.max.y},e.MAX=Number.MAX_VALUE,e.MIN=Number.MIN_VALUE,e}(),r=function(){function e(t,e,i,r,n,s,o,a,h,l){this.input=t,this.inputSize=e,this.outputSize=i,this.maxNumMipLevels=r,this.numChannels=n,this.isFloat=s,this.specularPower=o,this.cosinePowerDropPerMip=a,this.excludeBase=h,this.fixup=l,this._outputSurface=[],this._numMipLevels=0}return e.prototype.filterCubeMap=function(){return this.init(),this.filterCubeMapMipChain(),this._outputSurface},e.prototype.init=function(){var t,i,r;for(0==this.maxNumMipLevels&&(this.maxNumMipLevels=e.CP_MAX_MIPLEVELS),r=this.outputSize,i=0;i<this.maxNumMipLevels;i++){for(this._outputSurface.length++,this._outputSurface[i]=[],t=0;t<6;t++)this._outputSurface[i].length++,this.isFloat?this._outputSurface[i][t]=new Float32Array(r*r*this.numChannels):this._outputSurface[i][t]=new Uint32Array(r*r*this.numChannels);if(r>>=1,this._numMipLevels++,0==r)return void(this.maxNumMipLevels=i)}},e.prototype.filterCubeMapMipChain=function(){var t=this.specularPower;this.precomputeFilterLookupTables(this.inputSize);for(var e=0;e<this._numMipLevels;e++){this.excludeBase&&0==e&&(t=1e5);var i=this.input,r=this._outputSurface[e],n=this.outputSize>>e,s=this.getBaseFilterAngle(t);this.filterCubeSurfaces(i,this.inputSize,r,n,s,t),this.fixup&&this.fixupCubeEdges(r,n),this.excludeBase&&0==e&&(t=this.specularPower),t*=this.cosinePowerDropPerMip}},e.prototype.getBaseFilterAngle=function(t){var e=180;return e=Math.acos(Math.pow(1e-6,1/t)),e*=180/Math.PI,e*=2},e.prototype.precomputeFilterLookupTables=function(t){this._normCubeMap=[],this.buildNormalizerSolidAngleCubemap(t)},e.prototype.buildNormalizerSolidAngleCubemap=function(t){var e,i,r;for(e=0;e<6;e++){this._normCubeMap.push(new Float32Array(t*t*4));this.input[e];for(r=0;r<t;r++)for(i=0;i<t;i++){var n=this.texelCoordToVect(e,i,r,t,this.fixup);this._normCubeMap[e][4*(r*t+i)+0]=n.x,this._normCubeMap[e][4*(r*t+i)+1]=n.y,this._normCubeMap[e][4*(r*t+i)+2]=n.z;var s=this.texelCoordSolidAngle(e,i,r,t);this._normCubeMap[e][4*(r*t+i)+4]=s}}},e.prototype.texelCoordToVect=function(t,i,r,n,s){var o,a;if(o=2*(i+.5)/n-1,a=2*(r+.5)/n-1,s&&n>1){var h=Math.pow(n,2)/Math.pow(n-1,3);o=h*Math.pow(o,3)+o,a=h*Math.pow(a,3)+a}var l=e._sgFace2DMapping[t][e.CP_UDIR];e._vectorTemp.x=l[0]*o,e._vectorTemp.y=l[1]*o,e._vectorTemp.z=l[2]*o;var c=e._sgFace2DMapping[t][e.CP_VDIR];e._vectorTemp.x+=c[0]*a,e._vectorTemp.y+=c[1]*a,e._vectorTemp.z+=c[2]*a;var u=e._sgFace2DMapping[t][e.CP_FACEAXIS];return e._vectorTemp.x+=u[0],e._vectorTemp.y+=u[1],e._vectorTemp.z+=u[2],e._vectorTemp.normalize(),e._vectorTemp},e.prototype.vectToTexelCoord=function(t,i,r,n){var s,o,a=Math.abs(t),h=Math.abs(i),l=Math.abs(r);a>=h&&a>=l?(s=a,o=t>=0?e.CP_FACE_X_POS:e.CP_FACE_X_NEG):h>=a&&h>=l?(s=h,o=i>=0?e.CP_FACE_Y_POS:e.CP_FACE_Y_NEG):(s=l,o=r>=0?e.CP_FACE_Z_POS:e.CP_FACE_Z_NEG);var c=1/s;t*=c,i*=c,r*=c;var u=e._sgFace2DMapping[o][e.CP_UDIR],p=u[0]*t+u[1]*i+u[2]*r;u=e._sgFace2DMapping[o][e.CP_VDIR];var d=u[0]*t+u[1]*i+u[2]*r,f=Math.floor(.5*(n-1)*(p+1)),m=Math.floor(.5*(n-1)*(d+1));return e._vectorTemp.x=o,e._vectorTemp.y=f,e._vectorTemp.z=m,e._vectorTemp},e.prototype.areaElement=function(t,e){return Math.atan2(t*e,Math.sqrt(t*t+e*e+1))},e.prototype.texelCoordSolidAngle=function(t,e,i,r){e=2*(e+.5)/r-1,i=2*(i+.5)/r-1;var n=1/r,s=e-n,o=i-n,a=e+n,h=i+n;return this.areaElement(s,o)-this.areaElement(s,h)-this.areaElement(a,o)+this.areaElement(a,h)},e.prototype.filterCubeSurfaces=function(t,e,r,n,s,o){var a,h,l,c=[];for(a=0;a<6;a++)c.push(new i);var u=180/Math.PI*Math.atan2(1,e),p=s/2;p<u&&(p=u),p>90&&(p=90);var d=Math.ceil(p/u);d<1&&(d=1);var f=Math.cos(Math.PI/180*p);for(a=0;a<6;a++)for(l=0;l<n;l++)for(h=0;h<n;h++){var m=this.texelCoordToVect(a,h,l,n,this.fixup).clone();this.clearFilterExtents(c),this.determineFilterExtents(m,e,d,c);var _=this.processFilterExtents(m,f,c,t,e,o);r[a][(l*n+h)*this.numChannels+0]=_.x,r[a][(l*n+h)*this.numChannels+1]=_.y,r[a][(l*n+h)*this.numChannels+2]=_.z}},e.prototype.clearFilterExtents=function(t){for(var e=0;e<6;e++)t[e].clear()},e.prototype.determineFilterExtents=function(t,i,r,n){var s,o,a,h=[0,0,0,0],l=[0,0,0,0],c=[0,0,0,0],u=this.vectToTexelCoord(t.x,t.y,t.z,i),p=u.x,d=u.y,f=u.z;n[p].augment(d-r,f-r,0),n[p].augment(d+r,f+r,0),n[p].clampMin(0,0,0),n[p].clampMax(i-1,i-1,0);var m=n[p].min.x,_=n[p].min.y,g=n[p].max.x,y=n[p].max.y;h[0]=r-d,l[0]=_,c[0]=y,h[1]=d+r-(i-1),l[1]=_,c[1]=y,h[2]=r-f,l[2]=m,c[2]=g,h[3]=f+r-(i-1),l[3]=m,c[3]=g;for(var v=0;v<4;v++){if(h[v]>0){switch(s=e._sgCubeNgh[p][v][0],o=e._sgCubeNgh[p][v][1],v!=o&&v+o!=3||(l[v]=i-1-l[v],c[v]=i-1-c[v]),e._sgCubeNgh[p][v][1]){case e.CP_EDGE_LEFT:n[s].augment(0,l[v],0),n[s].augment(h[v],c[v],0);break;case e.CP_EDGE_RIGHT:n[s].augment(i-1,l[v],0),n[s].augment(i-1-h[v],c[v],0);break;case e.CP_EDGE_TOP:n[s].augment(l[v],0,0),n[s].augment(c[v],h[v],0);break;case e.CP_EDGE_BOTTOM:n[s].augment(l[v],i-1,0),n[s].augment(c[v],i-1-h[v],0)}n[s].clampMin(0,0,0),n[s].clampMax(i-1,i-1,0)}if(h[v]>i){switch(p){case e.CP_FACE_X_POS:a=e.CP_FACE_X_NEG;break;case e.CP_FACE_X_NEG:a=e.CP_FACE_X_POS;break;case e.CP_FACE_Y_POS:a=e.CP_FACE_Y_NEG;break;case e.CP_FACE_Y_NEG:a=e.CP_FACE_Y_POS;break;case e.CP_FACE_Z_POS:a=e.CP_FACE_Z_NEG;break;case e.CP_FACE_Z_NEG:a=e.CP_FACE_Z_POS}n[a].augment(0,0,0),n[a].augment(i-1,i-1,0)}}},e.prototype.processFilterExtents=function(t,i,r,n,s,o){for(var a=[0,0,0,0],h=0,l=0,c=this.numChannels,u=s,p=4*u,d=u*this.numChannels,f=1,m=0;m<6;m++)if(!r[m].empty())for(var _=r[m].min.x,g=r[m].min.y,y=r[m].max.x,v=r[m].max.y,x=4*(g*u+_),b=this.numChannels*(g*u+_),P=g;P<=v;P++){for(var T=0,S=0,A=_;A<=y;A++){var C=this._normCubeMap[m][x+T+0],E=this._normCubeMap[m][x+T+1],M=this._normCubeMap[m][x+T+2],D=C*t.x+E*t.y+M*t.z;if(D>=i&&D>0){var R=this._normCubeMap[m][x+T+3];for(R*=Math.pow(D,o+f),l=0;l<c;l++)a[l]+=R*n[m][b+S],S++;h+=R}else S+=c;T+=4}x+=p,b+=d}if(0!=h)e._vectorTemp.x=a[0]/h,e._vectorTemp.y=a[1]/h,e._vectorTemp.z=a[2]/h,this.numChannels>3&&(e._vectorTemp.w=a[3]/h);else{var I=this.vectToTexelCoord(t.x,t.y,t.z,s).clone();e._vectorTemp.x=n[I.x][this.numChannels*(I.z*s+I.y)+0],e._vectorTemp.y=n[I.x][this.numChannels*(I.z*s+I.y)+1],e._vectorTemp.z=n[I.x][this.numChannels*(I.z*s+I.y)+2],this.numChannels>3&&(e._vectorTemp.z=n[I.x][this.numChannels*(I.z*s+I.y)+3])}return e._vectorTemp},e.prototype.fixupCubeEdges=function(t,i){var r,n,s,o,a=0,h=[0,0,0,0,0,0,0,0],l=[[],[],[],[]],c=[[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]]];if(!(i<1))if(1!=i){for(o=0;o<6;o++)for(l[0]=[o,0],l[1]=[o,(i-1)*this.numChannels],l[2]=[o,i*(i-1)*this.numChannels],l[3]=[o,(i*(i-1)+(i-1))*this.numChannels],a=0;a<4;a++){var u=e._sgCubeCornerList[o][a];c[u][h[u]]=l[a],h[u]++}for(a=0;a<8;a++)for(r=0;r<this.numChannels;r++){var p=0;for(s=0;s<3;s++)p+=t[c[a][s][0]][c[a][s][1]+r];for(p*=1/3,s=0;s<3;s++)t[c[a][s][0]][c[a][s][1]+r]=p}for(s=0;s<12;s++){var d=e._sgCubeEdgeList[s][0],f=e._sgCubeEdgeList[s][1],m=e._sgCubeNgh[d][f][0],_=e._sgCubeNgh[d][f][1],g=0,y=0,v=0,x=0;switch(f){case e.CP_EDGE_LEFT:v=this.numChannels*i;break;case e.CP_EDGE_RIGHT:g+=(i-1)*this.numChannels,v=this.numChannels*i;break;case e.CP_EDGE_TOP:v=this.numChannels;break;case e.CP_EDGE_BOTTOM:g+=i*(i-1)*this.numChannels,v=this.numChannels}if(f==_||f+_==3)switch(_){case e.CP_EDGE_LEFT:y+=(i-1)*i*this.numChannels,x=-(this.numChannels*i);break;case e.CP_EDGE_RIGHT:y+=((i-1)*i+(i-1))*this.numChannels,x=-(this.numChannels*i);break;case e.CP_EDGE_TOP:y+=(i-1)*this.numChannels,x=-this.numChannels;break;case e.CP_EDGE_BOTTOM:y+=((i-1)*i+(i-1))*this.numChannels,x=-this.numChannels}else switch(_){case e.CP_EDGE_LEFT:x=this.numChannels*i;break;case e.CP_EDGE_RIGHT:y+=(i-1)*this.numChannels,x=this.numChannels*i;break;case e.CP_EDGE_TOP:x=this.numChannels;break;case e.CP_EDGE_BOTTOM:y+=i*(i-1)*this.numChannels,x=this.numChannels}for(g+=v,y+=x,n=1;n<i-1;n++){for(r=0;r<this.numChannels;r++){var b=t[d][g+r],P=t[m][y+r],T=.5*(b+P);t[d][g+r]=T,t[m][y+r]=T}g+=v,y+=x}}}else for(r=0;r<this.numChannels;r++){var S=0;for(o=0;o<6;o++)S+=t[o][r];for(S/=6,o=0;o<6;o++)t[o][r]=S}},e.CP_MAX_MIPLEVELS=16,e.CP_UDIR=0,e.CP_VDIR=1,e.CP_FACEAXIS=2,e.CP_FACE_X_POS=0,e.CP_FACE_X_NEG=1,e.CP_FACE_Y_POS=2,e.CP_FACE_Y_NEG=3,e.CP_FACE_Z_POS=4,e.CP_FACE_Z_NEG=5,e.CP_EDGE_LEFT=0,e.CP_EDGE_RIGHT=1,e.CP_EDGE_TOP=2,e.CP_EDGE_BOTTOM=3,e.CP_CORNER_NNN=0,e.CP_CORNER_NNP=1,e.CP_CORNER_NPN=2,e.CP_CORNER_NPP=3,e.CP_CORNER_PNN=4,e.CP_CORNER_PNP=5,e.CP_CORNER_PPN=6,e.CP_CORNER_PPP=7,e._vectorTemp=new t.Vector4(0,0,0,0),e._sgFace2DMapping=[[[0,0,-1],[0,-1,0],[1,0,0]],[[0,0,1],[0,-1,0],[-1,0,0]],[[1,0,0],[0,0,1],[0,1,0]],[[1,0,0],[0,0,-1],[0,-1,0]],[[1,0,0],[0,-1,0],[0,0,1]],[[-1,0,0],[0,-1,0],[0,0,-1]]],e._sgCubeNgh=[[[e.CP_FACE_Z_POS,e.CP_EDGE_RIGHT],[e.CP_FACE_Z_NEG,e.CP_EDGE_LEFT],[e.CP_FACE_Y_POS,e.CP_EDGE_RIGHT],[e.CP_FACE_Y_NEG,e.CP_EDGE_RIGHT]],[[e.CP_FACE_Z_NEG,e.CP_EDGE_RIGHT],[e.CP_FACE_Z_POS,e.CP_EDGE_LEFT],[e.CP_FACE_Y_POS,e.CP_EDGE_LEFT],[e.CP_FACE_Y_NEG,e.CP_EDGE_LEFT]],[[e.CP_FACE_X_NEG,e.CP_EDGE_TOP],[e.CP_FACE_X_POS,e.CP_EDGE_TOP],[e.CP_FACE_Z_NEG,e.CP_EDGE_TOP],[e.CP_FACE_Z_POS,e.CP_EDGE_TOP]],[[e.CP_FACE_X_NEG,e.CP_EDGE_BOTTOM],[e.CP_FACE_X_POS,e.CP_EDGE_BOTTOM],[e.CP_FACE_Z_POS,e.CP_EDGE_BOTTOM],[e.CP_FACE_Z_NEG,e.CP_EDGE_BOTTOM]],[[e.CP_FACE_X_NEG,e.CP_EDGE_RIGHT],[e.CP_FACE_X_POS,e.CP_EDGE_LEFT],[e.CP_FACE_Y_POS,e.CP_EDGE_BOTTOM],[e.CP_FACE_Y_NEG,e.CP_EDGE_TOP]],[[e.CP_FACE_X_POS,e.CP_EDGE_RIGHT],[e.CP_FACE_X_NEG,e.CP_EDGE_LEFT],[e.CP_FACE_Y_POS,e.CP_EDGE_TOP],[e.CP_FACE_Y_NEG,e.CP_EDGE_BOTTOM]]],e._sgCubeEdgeList=[[e.CP_FACE_X_POS,e.CP_EDGE_LEFT],[e.CP_FACE_X_POS,e.CP_EDGE_RIGHT],[e.CP_FACE_X_POS,e.CP_EDGE_TOP],[e.CP_FACE_X_POS,e.CP_EDGE_BOTTOM],[e.CP_FACE_X_NEG,e.CP_EDGE_LEFT],[e.CP_FACE_X_NEG,e.CP_EDGE_RIGHT],[e.CP_FACE_X_NEG,e.CP_EDGE_TOP],[e.CP_FACE_X_NEG,e.CP_EDGE_BOTTOM],[e.CP_FACE_Z_POS,e.CP_EDGE_TOP],[e.CP_FACE_Z_POS,e.CP_EDGE_BOTTOM],[e.CP_FACE_Z_NEG,e.CP_EDGE_TOP],[e.CP_FACE_Z_NEG,e.CP_EDGE_BOTTOM]],e._sgCubeCornerList=[[e.CP_CORNER_PPP,e.CP_CORNER_PPN,e.CP_CORNER_PNP,e.CP_CORNER_PNN],[e.CP_CORNER_NPN,e.CP_CORNER_NPP,e.CP_CORNER_NNN,e.CP_CORNER_NNP],[e.CP_CORNER_NPN,e.CP_CORNER_PPN,e.CP_CORNER_NPP,e.CP_CORNER_PPP],[e.CP_CORNER_NNP,e.CP_CORNER_PNP,e.CP_CORNER_NNN,e.CP_CORNER_PNN],[e.CP_CORNER_NPP,e.CP_CORNER_PPP,e.CP_CORNER_NNP,e.CP_CORNER_PNP],[e.CP_CORNER_PPN,e.CP_CORNER_NPN,e.CP_CORNER_PNN,e.CP_CORNER_NNN]],e}();e.PMREMGenerator=r}(t.Internals||(t.Internals={}))}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o,a,h){void 0===s&&(s=!1),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===h&&(h=!1),e.call(this,r),this._useInGammaSpace=!1,this._generateHarmonics=!0,this._isBABYLONPreprocessed=!1,this.coordinatesMode=t.Texture.CUBIC_MODE,this.sphericalPolynomial=null,this.isPMREM=!1,i&&(this.name=i,this.url=i,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=t.Matrix.Identity(),n?(this._isBABYLONPreprocessed=!1,this._noMipmap=s,this._size=n,this._useInGammaSpace=a,this._usePMREMGenerator=h&&r.getEngine().getCaps().textureLOD&&this.getScene().getEngine().getCaps().textureFloat&&!this._useInGammaSpace):(this._isBABYLONPreprocessed=!0,this._noMipmap=!1,this._useInGammaSpace=!1,this._usePMREMGenerator=r.getEngine().getCaps().textureLOD&&this.getScene().getEngine().getCaps().textureFloat&&!this._useInGammaSpace),this.isPMREM=this._usePMREMGenerator,this._texture=this._getFromCache(i,this._noMipmap),this._texture||(r.useDelayedTextureLoading?this.delayLoadState=t.Engine.DELAYLOADSTATE_NOTLOADED:this.loadTexture()))}return o(i,e),i.prototype.loadBabylonTexture=function(){var e=this,i=0,r=null,n=!this._useInGammaSpace&&this.getScene().getEngine().getCaps().textureFloat?function(t){for(var n=[],s=30,o=0;o<i;o++){n.push([]);for(var a=3*Math.pow(e._size>>o,2),h=0;h<6;h++){var l=r.subarray(s,s+a);n[o].push(l),s+=a}}return n}:null,s=function(s){var o=new Int32Array(s);r=new Float32Array(s);o[0];e._size=o[1],e.getScene().getEngine().updateTextureSize(e._texture,e._size,e._size),e.sphericalPolynomial=new t.SphericalPolynomial,e.sphericalPolynomial.x.copyFromFloats(r[2],r[3],r[4]),e.sphericalPolynomial.y.copyFromFloats(r[5],r[6],r[7]),e.sphericalPolynomial.z.copyFromFloats(r[8],r[9],r[10]),e.sphericalPolynomial.xx.copyFromFloats(r[11],r[12],r[13]),e.sphericalPolynomial.yy.copyFromFloats(r[14],r[15],r[16]),e.sphericalPolynomial.zz.copyFromFloats(r[17],r[18],r[19]),e.sphericalPolynomial.xy.copyFromFloats(r[20],r[21],r[22]),e.sphericalPolynomial.yz.copyFromFloats(r[23],r[24],r[25]),e.sphericalPolynomial.zx.copyFromFloats(r[26],r[27],r[28]),i=o[29];for(var a=30,h=[],l=3*Math.pow(e._size,2),c=0;c<6;c++)h.push(r.subarray(a,a+l)),a+=l;for(var u=[],p=null,d=0;d<6;d++){var f=null;if(n)f=h[d];else{if(f=h[[0,2,4,1,3,5][d]],!e.getScene().getEngine().getCaps().textureFloat){var m=new ArrayBuffer(l);p=new Uint8Array(m)}for(var _=0;_<e._size*e._size;_++)if(e._useInGammaSpace&&(f[3*_+0]=Math.pow(f[3*_+0],t.ToGammaSpace),f[3*_+1]=Math.pow(f[3*_+1],t.ToGammaSpace),f[3*_+2]=Math.pow(f[3*_+2],t.ToGammaSpace)),p){var g=Math.max(255*f[3*_+0],0),y=Math.max(255*f[3*_+1],0),v=Math.max(255*f[3*_+2],0),x=Math.max(Math.max(g,y),v);if(x>255){var b=255/x;g*=b,y*=b,v*=b}p[3*_+0]=g,p[3*_+1]=y,p[3*_+2]=v}}p?u.push(p):u.push(f)}return u};this._texture=this.getScene().getEngine().createRawCubeTexture(this.url,this.getScene(),this._size,t.Engine.TEXTUREFORMAT_RGB,this.getScene().getEngine().getCaps().textureFloat?t.Engine.TEXTURETYPE_FLOAT:t.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,s,n)},i.prototype.loadHDRTexture=function(){var e=this,r=function(r){var n=t.Internals.HDRTools.GetCubeMapTextureData(r,e._size);e._generateHarmonics&&(e.sphericalPolynomial=t.Internals.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(n));for(var s=[],o=null,a=0;a<6;a++){if(!e.getScene().getEngine().getCaps().textureFloat){var h=new ArrayBuffer(e._size*e._size*3);o=new Uint8Array(h)}var l=n[i._facesMapping[a]];if(e._useInGammaSpace||o)for(var c=0;c<e._size*e._size;c++)if(e._useInGammaSpace&&(l[3*c+0]=Math.pow(l[3*c+0],t.ToGammaSpace),l[3*c+1]=Math.pow(l[3*c+1],t.ToGammaSpace),l[3*c+2]=Math.pow(l[3*c+2],t.ToGammaSpace)),o){var u=Math.max(255*l[3*c+0],0),p=Math.max(255*l[3*c+1],0),d=Math.max(255*l[3*c+2],0),f=Math.max(Math.max(u,p),d);if(f>255){var m=255/f;u*=m,p*=m,d*=m}o[3*c+0]=u,o[3*c+1]=p,o[3*c+2]=d}o?s.push(o):s.push(l)}return s},n=null;!this._noMipmap&&this._usePMREMGenerator&&(n=function(i){return new t.Internals.PMREMGenerator(i,e._size,e._size,0,3,e.getScene().getEngine().getCaps().textureFloat,2048,.25,!1,!0).filterCubeMap()}),this._texture=this.getScene().getEngine().createRawCubeTexture(this.url,this.getScene(),this._size,t.Engine.TEXTUREFORMAT_RGB,this.getScene().getEngine().getCaps().textureFloat?t.Engine.TEXTURETYPE_FLOAT:t.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,r,n)},i.prototype.loadTexture=function(){this._isBABYLONPreprocessed?this.loadBabylonTexture():this.loadHDRTexture()},i.prototype.clone=function(){var t=this._isBABYLONPreprocessed?null:this._size,e=new i(this.url,this.getScene(),t,this._noMipmap,this._generateHarmonics,this._useInGammaSpace,this._usePMREMGenerator);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e},i.prototype.delayLoad=function(){this.delayLoadState===t.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=t.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this.loadTexture())},i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},i.Parse=function(e,i,r){var n=null;if(e.name&&!e.isRenderTarget){var s=e.isBABYLONPreprocessed?null:e.size;n=new t.HDRCubeTexture(r+e.name,i,s,e.generateHarmonics,e.useInGammaSpace,e.usePMREMGenerator),n.name=e.name,n.hasAlpha=e.hasAlpha,n.level=e.level,n.coordinatesMode=e.coordinatesMode}return n},i.prototype.serialize=function(){if(!this.name)return null;var t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this._useInGammaSpace,t.generateHarmonics=this._generateHarmonics,t.usePMREMGenerator=this._usePMREMGenerator,t.isBABYLONPreprocessed=this._isBABYLONPreprocessed,t.customType="BABYLON.HDRCubeTexture",t},i.generateBabylonHDROnDisk=function(t,e,r){void 0===r&&(r=null);var n=function(t){var e=new Blob([t],{type:"application/octet-stream"}),i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download="envmap.babylon.hdr",r.click()};i.generateBabylonHDR(t,e,n,r)},i.generateBabylonHDR=function(e,i,r,n){if(void 0===n&&(n=null),!e)return null;if(!t.Tools.IsExponentOfTwo(i))return null;var s=function(e){var n=t.Internals.HDRTools.GetCubeMapTextureData(e,i),s=t.Internals.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(n),o=[];o.push(n.right),o.push(n.left),o.push(n.up),o.push(n.down),o.push(n.front),o.push(n.back);var a=new t.Internals.PMREMGenerator(o,i,i,0,3,!0,2048,.25,!1,!0),h=a.filterCubeMap(),l=4;l+=4,l+=108,l+=4;for(var c=0;c<h.length;c++){var u=i>>c;l+=6*u*u*3*4}var p=new ArrayBuffer(l),d=new Int32Array(p),f=new Float32Array(p);d[0]=1,d[1]=i,s.x.toArray(f,2),s.y.toArray(f,5),s.z.toArray(f,8),s.xx.toArray(f,11),s.yy.toArray(f,14),s.zz.toArray(f,17),s.xy.toArray(f,20),s.yz.toArray(f,23),s.zx.toArray(f,26),d[29]=h.length;for(var m=30,c=0;c<h.length;c++)for(var _=3*Math.pow(i>>c,2),g=0;g<6;g++)f.set(h[c][g],m),m+=_;r(p)};t.Tools.LoadFile(e,function(t){s(t)},null,null,!0,n)},i._facesMapping=["right","up","front","left","down","back"],i}(t.BaseTexture);t.HDRCubeTexture=e}(r||(r={}));var r;!function(t){!function(e){var i=function(){function e(e,i,r,n,s){void 0===n&&(n=!0),void 0===s&&(s=1),this.skeleton=e,this.mesh=i,this.autoUpdateBonesMatrices=n,this.renderingGroupId=s,this.color=t.Color3.White(),this._debugLines=[],this._isEnabled=!1,this._scene=r,this.update(),this._renderFunction=this.update.bind(this)}return Object.defineProperty(e.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(t){this._isEnabled!==t&&(this._isEnabled=t,t?this._scene.registerBeforeRender(this._renderFunction):this._scene.unregisterBeforeRender(this._renderFunction))},enumerable:!0,configurable:!0}),e.prototype._getBonePosition=function(e,i,r,n,s,o){void 0===n&&(n=0),void 0===s&&(s=0),void 0===o&&(o=0);var a=t.Tmp.Matrix[0],h=i.getParent();if(a.copyFrom(i.getLocalMatrix()),0!==n||0!==s||0!==o){var l=t.Tmp.Matrix[1];t.Matrix.IdentityToRef(l),l.m[12]=n,l.m[13]=s,l.m[14]=o,l.multiplyToRef(a,a)}h&&a.multiplyToRef(h.getAbsoluteTransform(),a),a.multiplyToRef(r,a),e.x=a.m[12],e.y=a.m[13],e.z=a.m[14]},e.prototype._getLinesForBonesWithLength=function(e,i){for(var r=e.length,n=0;n<r;n++){var s=e[n],o=this._debugLines[n];o||(o=[t.Vector3.Zero(),t.Vector3.Zero()],this._debugLines[n]=o),this._getBonePosition(o[0],s,i),this._getBonePosition(o[1],s,i,0,s.length,0)}},e.prototype._getLinesForBonesNoLength=function(e,i){for(var r=e.length,n=0,s=r-1;s>=0;s--){var o=e[s],a=o.getParent();if(a){var h=this._debugLines[n];h||(h=[t.Vector3.Zero(),t.Vector3.Zero()],this._debugLines[n]=h),o.getAbsolutePositionToRef(this.mesh,h[0]),a.getAbsolutePositionToRef(this.mesh,h[1]),n++}}},e.prototype.update=function(){this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones,this.mesh.getWorldMatrix()):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix()),this._debugMesh?t.MeshBuilder.CreateLineSystem(null,{lines:this._debugLines,updatable:!0,instance:this._debugMesh},this._scene):(this._debugMesh=t.MeshBuilder.CreateLineSystem(null,{lines:this._debugLines,updatable:!0},this._scene),this._debugMesh.renderingGroupId=this.renderingGroupId),this._debugMesh.color=this.color},e.prototype.dispose=function(){this._debugMesh&&(this.isEnabled=!1,this._debugMesh.dispose(),this._debugMesh=null)},e}();e.SkeletonViewer=i}(t.Debug||(t.Debug={}))}(r||(r={}));var r;!function(t){!function(e){var i=function(){function e(e,i){void 0===i&&(i=1),this._xline=[t.Vector3.Zero(),t.Vector3.Zero()],this._yline=[t.Vector3.Zero(),t.Vector3.Zero()],this._zline=[t.Vector3.Zero(),t.Vector3.Zero()],this.scaleLines=1,this.scaleLines=i,this._xmesh=t.Mesh.CreateLines("xline",this._xline,e,!0),this._ymesh=t.Mesh.CreateLines("yline",this._yline,e,!0),this._zmesh=t.Mesh.CreateLines("zline",this._zline,e,!0),this._xmesh.renderingGroupId=2,this._ymesh.renderingGroupId=2,this._zmesh.renderingGroupId=2,this._xmesh.material.checkReadyOnlyOnce=!0,this._xmesh.color=new t.Color3(1,0,0),this._ymesh.material.checkReadyOnlyOnce=!0,this._ymesh.color=new t.Color3(0,1,0),this._zmesh.material.checkReadyOnlyOnce=!0,this._zmesh.color=new t.Color3(0,0,1),this.scene=e}return e.prototype.update=function(e,i,r,n){var s=this.scaleLines,o=this._xline[0],a=this._xline[1];o.x=e.x,o.y=e.y,o.z=e.z,a.x=o.x+i.x*s,a.y=o.y+i.y*s,a.z=o.z+i.z*s,t.Mesh.CreateLines(null,this._xline,null,null,this._xmesh),o=this._yline[0],a=this._yline[1],o.x=e.x,o.y=e.y,o.z=e.z,a.x=o.x+r.x*s,a.y=o.y+r.y*s,a.z=o.z+r.z*s,t.Mesh.CreateLines(null,this._yline,null,null,this._ymesh),o=this._zline[0],a=this._zline[1],o.x=e.x,o.y=e.y,o.z=e.z,a.x=o.x+n.x*s,a.y=o.y+n.y*s,a.z=o.z+n.z*s,t.Mesh.CreateLines(null,this._zline,null,null,this._zmesh)},e.prototype.dispose=function(){this._xmesh&&(this._xmesh.dispose(),this._ymesh.dispose(),this._zmesh.dispose(),this._xmesh=null,this._ymesh=null,this._zmesh=null,this._xline=null,this._yline=null,this._zline=null,this.scene=null)},e}();e.AxesViewer=i}(t.Debug||(t.Debug={}))}(r||(r={}));var r;!function(t){!function(e){var i=function(e){function i(i,r,n,s){void 0===s&&(s=1),e.call(this,i,s),this.pos=t.Vector3.Zero(),this.xaxis=t.Vector3.Zero(),this.yaxis=t.Vector3.Zero(),this.zaxis=t.Vector3.Zero(),this.mesh=n,this.bone=r}return o(i,e),i.prototype.update=function(){var i=this.bone;i.getAbsolutePositionToRef(this.mesh,this.pos),i.getDirectionToRef(t.Axis.X,this.mesh,this.xaxis),i.getDirectionToRef(t.Axis.Y,this.mesh,this.yaxis),i.getDirectionToRef(t.Axis.Z,this.mesh,this.zaxis),e.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)},i.prototype.dispose=function(){this.pos&&(this.pos=null,this.xaxis=null,this.yaxis=null,this.zaxis=null,this.mesh=null,this.bone=null,e.prototype.dispose.call(this))},i}(e.AxesViewer);e.BoneAxesViewer=i}(t.Debug||(t.Debug={}))}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r){e.call(this,r),i&&(this._textureMatrix=t.Matrix.Identity(),this.name=i,this.url=i,this.hasAlpha=!1,this.isCube=!1,this.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.wrapV=t.Texture.CLAMP_ADDRESSMODE,this.anisotropicFilteringLevel=1,this._texture=this._getFromCache(i,!0),this._texture||(r.useDelayedTextureLoading?this.delayLoadState=t.Engine.DELAYLOADSTATE_NOTLOADED:this.loadTexture()))}return o(i,e),i.prototype.getTextureMatrix=function(){return this._textureMatrix},i.prototype.load3dlTexture=function(){var e=this,r=this.getScene().getEngine().createRawTexture(null,1,1,t.Engine.TEXTUREFORMAT_RGBA,!1,!1,t.Texture.BILINEAR_SAMPLINGMODE);this._texture=r;var n=function(n){for(var s,o,a,h=n.split("\n"),l=0,c=0,u=0,p=0,d=0,f=0;f<h.length;f++)if(a=h[f],i._noneEmptyLineRegex.test(a)&&0!==a.indexOf("#")){var m=a.split(" ");if(0!==l){if(0!=l){var _=Math.max(parseInt(m[0]),0),g=Math.max(parseInt(m[1]),0),y=Math.max(parseInt(m[2]),0);d=Math.max(_,d),d=Math.max(g,d),d=Math.max(y,d);var v=4*(c+p*l+u*l*l);o[v+0]=_,o[v+1]=g,o[v+2]=y,o[v+3]=0,p++,p%l==0&&(u++,p=0,u%l==0&&(c++,u=0))}}else l=m.length,s=new Uint8Array(l*l*l*4),o=new Float32Array(l*l*l*4)}for(var f=0;f<o.length;f++){var x=o[f];s[f]=x/d*255}e.getScene().getEngine().updateTextureSize(r,l*l,l),e.getScene().getEngine().updateRawTexture(r,s,t.Engine.TEXTUREFORMAT_RGBA,!1)};return t.Tools.LoadFile(this.url,n),this._texture},i.prototype.loadTexture=function(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this.load3dlTexture()},i.prototype.clone=function(){var t=new i(this.url,this.getScene());return t.level=this.level,t},i.prototype.delayLoad=function(){this.delayLoadState===t.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=t.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,!0),this._texture||this.loadTexture())},i.Bind=function(t,e){e.setTexture("cameraColorGrading2DSampler",t);var i=t.level,r=t.getSize().height,n=r-1,s=1/r;e.setFloat4("vCameraColorGradingInfos",i,r,n,s);var o=s/r,a=s,h=n*o,l=n/r,c=.5*o,u=.5*a;e.setFloat4("vCameraColorGradingScaleOffset",h,l,c,u)},i.PrepareUniformsAndSamplers=function(t,e){t.push("vCameraColorGradingInfos","vCameraColorGradingScaleOffset"),e.push("cameraColorGrading2DSampler")},i.Parse=function(e,i,r){var n=null;return e.name&&!e.isRenderTarget&&(n=new t.ColorGradingTexture(e.name,i),n.name=e.name,n.level=e.level),n},i.prototype.serialize=function(){if(!this.name)return null;var t={};return t.name=this.name,t.level=this.level,t.customType="BABYLON.ColorGradingTexture",t},i._noneEmptyLineRegex=/\S+/,i}(t.BaseTexture);t.ColorGradingTexture=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this._dirty=!0,this._tempColor=new t.Color4(0,0,0,0),this._globalCurve=new t.Color4(0,0,0,0),this._highlightsCurve=new t.Color4(0,0,0,0),this._midtonesCurve=new t.Color4(0,0,0,0),this._shadowsCurve=new t.Color4(0,0,0,0),this._positiveCurve=new t.Color4(0,0,0,0),this._negativeCurve=new t.Color4(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}return Object.defineProperty(e.prototype,"GlobalHue",{get:function(){return this._globalHue},set:function(t){this._globalHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"GlobalDensity",{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"GlobalSaturation",{get:function(){return this._globalSaturation},set:function(t){this._globalSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"HighlightsHue",{get:function(){return this._highlightsHue},set:function(t){this._highlightsHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"HighlightsDensity",{get:function(){return this._highlightsDensity},set:function(t){this._highlightsDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"HighlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(t){this._highlightsSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"HighlightsExposure",{get:function(){return this._highlightsExposure},set:function(t){this._highlightsExposure=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MidtonesHue",{get:function(){return this._midtonesHue},set:function(t){this._midtonesHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MidtonesDensity",{get:function(){return this._midtonesDensity},set:function(t){this._midtonesDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MidtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(t){this._midtonesSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"MidtonesExposure",{get:function(){return this._midtonesExposure},set:function(t){this._midtonesExposure=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShadowsHue",{get:function(){return this._shadowsHue},set:function(t){this._shadowsHue=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShadowsDensity",{get:function(){return this._shadowsDensity},set:function(t){this._shadowsDensity=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(t){this._shadowsSaturation=t,this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ShadowsExposure",{get:function(){return this._shadowsExposure},set:function(t){this._shadowsExposure=t,this._dirty=!0},enumerable:!0,configurable:!0}),e.Bind=function(t,e){t._dirty&&(t._dirty=!1,t.getColorGradingDataToRef(t._globalHue,t._globalDensity,t._globalSaturation,t._globalExposure,t._globalCurve),t.getColorGradingDataToRef(t._highlightsHue,t._highlightsDensity,t._highlightsSaturation,t._highlightsExposure,t._tempColor),t._tempColor.multiplyToRef(t._globalCurve,t._highlightsCurve),t.getColorGradingDataToRef(t._midtonesHue,t._midtonesDensity,t._midtonesSaturation,t._midtonesExposure,t._tempColor),t._tempColor.multiplyToRef(t._globalCurve,t._midtonesCurve),t.getColorGradingDataToRef(t._shadowsHue,t._shadowsDensity,t._shadowsSaturation,t._shadowsExposure,t._tempColor),t._tempColor.multiplyToRef(t._globalCurve,t._shadowsCurve),t._highlightsCurve.subtractToRef(t._midtonesCurve,t._positiveCurve),t._midtonesCurve.subtractToRef(t._shadowsCurve,t._negativeCurve)),e.setFloat4("vCameraColorCurvePositive",t._positiveCurve.r,t._positiveCurve.g,t._positiveCurve.b,t._positiveCurve.a),e.setFloat4("vCameraColorCurveNeutral",t._midtonesCurve.r,t._midtonesCurve.g,t._midtonesCurve.b,t._midtonesCurve.a),e.setFloat4("vCameraColorCurveNegative",t._negativeCurve.r,t._negativeCurve.g,t._negativeCurve.b,t._negativeCurve.a)},e.PrepareUniforms=function(t){t.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")},e.prototype.getColorGradingDataToRef=function(t,i,r,n,s){null!=t&&(t=e.clamp(t,0,360),i=e.clamp(i,-100,100),r=e.clamp(r,-100,100),n=e.clamp(n,-100,100),i=e.applyColorGradingSliderNonlinear(i),i*=.5,n=e.applyColorGradingSliderNonlinear(n),i<0&&(i*=-1,t=(t+180)%360),e.fromHSBToRef(t,i,50+.25*n,s),s.scaleToRef(2,s),s.a=1+.01*r)},e.applyColorGradingSliderNonlinear=function(t){t/=100;var e=Math.abs(t);return e=Math.pow(e,2),t<0&&(e*=-1),e*=100},e.fromHSBToRef=function(t,i,r,n){var s=e.clamp(t,0,360),o=e.clamp(i/100,0,1),a=e.clamp(r/100,0,1);if(0===o)n.r=a,n.g=a,n.b=a;else{s/=60;var h=Math.floor(s),l=s-h,c=a*(1-o),u=a*(1-o*l),p=a*(1-o*(1-l));switch(h){case 0:n.r=a,n.g=p,n.b=c;break;case 1:n.r=u,n.g=a,n.b=c;break;case 2:n.r=c,n.g=a,n.b=p;break;case 3:n.r=c,n.g=u,n.b=a;break;case 4:n.r=p,n.g=c,n.b=a;break;default:n.r=a,n.g=c,n.b=u}}n.a=1},e.clamp=function(t,e,i){return Math.min(Math.max(t,e),i)},e.prototype.clone=function(){return t.SerializationHelper.Clone(function(){return new e},this)},e.prototype.serialize=function(){return t.SerializationHelper.Serialize(this)},e.Parse=function(i){return t.SerializationHelper.Parse(function(){return new e},i,null,null)},s([t.serialize()],e.prototype,"_globalHue",void 0),s([t.serialize()],e.prototype,"_globalDensity",void 0),s([t.serialize()],e.prototype,"_globalSaturation",void 0),s([t.serialize()],e.prototype,"_globalExposure",void 0),s([t.serialize()],e.prototype,"_highlightsHue",void 0),s([t.serialize()],e.prototype,"_highlightsDensity",void 0),s([t.serialize()],e.prototype,"_highlightsSaturation",void 0),s([t.serialize()],e.prototype,"_highlightsExposure",void 0),s([t.serialize()],e.prototype,"_midtonesHue",void 0),s([t.serialize()],e.prototype,"_midtonesDensity",void 0),s([t.serialize()],e.prototype,"_midtonesSaturation",void 0),s([t.serialize()],e.prototype,"_midtonesExposure",void 0),e}();t.ColorCurves=e}(r||(r={}));var r;!function(t){var e=function(t){function e(){t.call(this),this.ALBEDO=!1,this.AMBIENT=!1,this.OPACITY=!1,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.REFLECTIVITY=!1,this.BUMP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.ALPHATEST=!1,this.ALPHAFROMALBEDO=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.OPACITYFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.UV1=!1,this.UV2=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHALBEDO=!1,this.LIGHTMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.CAMERATONEMAP=!1,this.CAMERACONTRAST=!1,this.CAMERACOLORGRADING=!1,this.CAMERACOLORCURVES=!1,this.OVERLOADEDVALUES=!1,this.OVERLOADEDSHADOWVALUES=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.LINKREFRACTIONTOTRANSPARENCY=!1,this.REFRACTIONMAPINLINEARSPACE=!1,this.LODBASEDMICROSFURACE=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.RADIANCEOVERALPHA=!1,this.USEPMREMREFLECTION=!1,this.USEPMREMREFRACTION=!1,this.OPENGLNORMALMAP=!1,this.INVERTNORMALMAPX=!1,this.INVERTNORMALMAPY=!1,this.SHADOWFULLFLOAT=!1,this.METALLICWORKFLOW=!1,this.METALLICROUGHNESSGSTOREINALPHA=!1,this.METALLICROUGHNESSGSTOREINGREEN=!1,this.rebuild()}return o(e,t),e}(t.MaterialDefines),i=function(i){function r(r,n){var s=this;i.call(this,r,n),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this._lightingInfos=new t.Vector4(this.directIntensity,this.emissiveIntensity,this.environmentIntensity,this.specularIntensity),this.disableBumpMap=!1,this.overloadedShadowIntensity=1,this.overloadedShadeIntensity=1,this._overloadedShadowInfos=new t.Vector4(this.overloadedShadowIntensity,this.overloadedShadeIntensity,0,0),this.cameraExposure=1,this.cameraContrast=1,this.cameraColorGradingTexture=null,this.cameraColorCurves=null,this._cameraInfos=new t.Vector4(1,1,0,0),this._microsurfaceTextureLods=new t.Vector2(0,0),this.overloadedAmbient=t.Color3.White(),this.overloadedAmbientIntensity=0,this.overloadedAlbedo=t.Color3.White(),this.overloadedAlbedoIntensity=0,this.overloadedReflectivity=new t.Color3(.3,.3,.3),this.overloadedReflectivityIntensity=0,this.overloadedEmissive=t.Color3.White(),this.overloadedEmissiveIntensity=0,this._overloadedIntensity=new t.Vector4(this.overloadedAmbientIntensity,this.overloadedAlbedoIntensity,this.overloadedReflectivityIntensity,this.overloadedEmissiveIntensity),this.overloadedReflection=t.Color3.White(),this.overloadedReflectionIntensity=0,this.overloadedMicroSurface=0,this.overloadedMicroSurfaceIntensity=0,this._overloadedMicroSurface=new t.Vector3(this.overloadedMicroSurface,this.overloadedMicroSurfaceIntensity,this.overloadedReflectionIntensity),this.ambientTextureStrength=1,this.ambientColor=new t.Color3(0,0,0),this.albedoColor=new t.Color3(1,1,1),this.reflectivityColor=new t.Color3(1,1,1),this.reflectionColor=new t.Color3(.5,.5,.5),this.emissiveColor=new t.Color3(0,0,0),this.microSurface=.9,this.indexOfRefraction=.66,this.invertRefractionY=!1,this.linkRefractionWithTransparency=!1,this.linkEmissiveWithAlbedo=!1,this.useLightmapAsShadowmap=!1,this.useEmissiveAsIllumination=!1,this.useAlphaFromAlbedoTexture=!1,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useScalarInLinearSpace=!1,this.usePhysicalLightFalloff=!0,this.useRadianceOverAlpha=!0,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this._renderTargets=new t.SmartArray(16),this._worldViewProjectionMatrix=t.Matrix.Zero(),this._globalAmbientColor=new t.Color3(0,0,0),this._tempColor=new t.Color3,this._defines=new e,this._cachedDefines=new e,this._myScene=null,this._myShadowGenerator=null,this._cachedDefines.BonesPerMesh=-1,this.getRenderTargetTextures=function(){return s._renderTargets.reset(),s.reflectionTexture&&s.reflectionTexture.isRenderTarget&&s._renderTargets.push(s.reflectionTexture),s.refractionTexture&&s.refractionTexture.isRenderTarget&&s._renderTargets.push(s.refractionTexture),s._renderTargets}}return o(r,i),Object.defineProperty(r.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!0,configurable:!0}),r.prototype.needAlphaBlending=function(){return!this.linkRefractionWithTransparency&&(this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromAlbedoTexture()||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled)},r.prototype.needAlphaTesting=function(){return!this.linkRefractionWithTransparency&&(null!=this.albedoTexture&&this.albedoTexture.hasAlpha)},r.prototype._shouldUseAlphaFromAlbedoTexture=function(){return null!=this.albedoTexture&&this.albedoTexture.hasAlpha&&this.useAlphaFromAlbedoTexture},r.prototype.getAlphaTestTexture=function(){return this.albedoTexture},r.prototype._checkCache=function(t,e,i){return!e||this._defines.INSTANCES===i&&!(!e._materialDefines||!e._materialDefines.isEqual(this._defines))},r.prototype.convertColorToLinearSpaceToRef=function(t,e){r.convertColorToLinearSpaceToRef(t,e,this.useScalarInLinearSpace)},r.convertColorToLinearSpaceToRef=function(t,e,i){i?(e.r=t.r,e.g=t.g,e.b=t.b):t.toLinearSpaceToRef(e)},r.BindLights=function(e,i,n,s,o,a,h){for(var l=0,c=!1,u=0;u<e.lights.length;u++){var p=e.lights[u];if(p.isEnabled()&&p.canAffectMesh(i)&&(t.MaterialHelper.BindLightProperties(p,n,l),this.convertColorToLinearSpaceToRef(p.diffuse,r._scaledAlbedo,o),r._scaledAlbedo.scaleToRef(p.intensity,r._scaledAlbedo),n.setColor4("vLightDiffuse"+l,r._scaledAlbedo,h?p.radius:p.range),s.SPECULARTERM&&(this.convertColorToLinearSpaceToRef(p.specular,r._scaledReflectivity,o),r._scaledReflectivity.scaleToRef(p.intensity,r._scaledReflectivity),n.setColor3("vLightSpecular"+l,r._scaledReflectivity)),e.shadowsEnabled&&(c=t.MaterialHelper.BindLightShadow(p,e,i,l,n,c)),++l===a))break}},r.prototype.isReady=function(i,r){if(this.checkReadyOnlyOnce&&this._wasPreviouslyReady)return!0;var n=this.getScene(),s=n.getEngine(),o=!1,a=!1;if(this._defines.reset(),n.lightsEnabled&&!this.disableLighting&&(o=t.MaterialHelper.PrepareDefinesForLights(n,i,this._defines,this.maxSimultaneousLights)||o),!this.checkReadyOnEveryCall&&this._renderId===n.getRenderId()&&this._checkCache(n,i,r))return!0;if(n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(this._defines.LODBASEDMICROSFURACE=!0),this.albedoTexture&&t.StandardMaterial.DiffuseTextureEnabled){if(!this.albedoTexture.isReady())return!1;a=!0,this._defines.ALBEDO=!0}if(this.ambientTexture&&t.StandardMaterial.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;a=!0,this._defines.AMBIENT=!0}if(this.opacityTexture&&t.StandardMaterial.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;a=!0,this._defines.OPACITY=!0,this.opacityTexture.getAlphaFromRGB&&(this._defines.OPACITYRGB=!0)}if(this.reflectionTexture&&t.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;switch(o=!0,this._defines.REFLECTION=!0,this.reflectionTexture.coordinatesMode===t.Texture.INVCUBIC_MODE&&(this._defines.INVERTCUBICMAP=!0),this._defines.REFLECTIONMAP_3D=this.reflectionTexture.isCube,this.reflectionTexture.coordinatesMode){case t.Texture.CUBIC_MODE:case t.Texture.INVCUBIC_MODE:this._defines.REFLECTIONMAP_CUBIC=!0;break;case t.Texture.EXPLICIT_MODE:this._defines.REFLECTIONMAP_EXPLICIT=!0;break;case t.Texture.PLANAR_MODE:this._defines.REFLECTIONMAP_PLANAR=!0;break;case t.Texture.PROJECTION_MODE:this._defines.REFLECTIONMAP_PROJECTION=!0;break;case t.Texture.SKYBOX_MODE:this._defines.REFLECTIONMAP_SKYBOX=!0;break;case t.Texture.SPHERICAL_MODE:this._defines.REFLECTIONMAP_SPHERICAL=!0;break;case t.Texture.EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR=!0}this.reflectionTexture instanceof t.HDRCubeTexture&&this.reflectionTexture&&(this._defines.USESPHERICALFROMREFLECTIONMAP=!0,o=!0,this.reflectionTexture.isPMREM&&(this._defines.USEPMREMREFLECTION=!0))}if(this.lightmapTexture&&t.StandardMaterial.LightmapTextureEnabled){if(!this.lightmapTexture.isReady())return!1;a=!0,this._defines.LIGHTMAP=!0,this._defines.USELIGHTMAPASSHADOWMAP=this.useLightmapAsShadowmap}if(this.emissiveTexture&&t.StandardMaterial.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;a=!0,this._defines.EMISSIVE=!0}if(t.StandardMaterial.SpecularTextureEnabled)if(this.metallicTexture){if(!this.metallicTexture.isReady())return!1;a=!0,this._defines.METALLICWORKFLOW=!0,this._defines.METALLICROUGHNESSGSTOREINALPHA=this.useRoughnessFromMetallicTextureAlpha,this._defines.METALLICROUGHNESSGSTOREINGREEN=!this.useRoughnessFromMetallicTextureAlpha&&this.useRoughnessFromMetallicTextureGreen}else if(this.reflectivityTexture){if(!this.reflectivityTexture.isReady())return!1;a=!0,this._defines.REFLECTIVITY=!0,this._defines.MICROSURFACEFROMREFLECTIVITYMAP=this.useMicroSurfaceFromReflectivityMapAlpha,this._defines.MICROSURFACEAUTOMATIC=this.useAutoMicroSurfaceFromReflectivityMap}if(n.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&t.StandardMaterial.BumpTextureEnabled&&!this.disableBumpMap){if(!this.bumpTexture.isReady())return!1;a=!0,this._defines.BUMP=!0,this.useParallax&&this.albedoTexture&&t.StandardMaterial.DiffuseTextureEnabled&&(this._defines.PARALLAX=!0,this.useParallaxOcclusion&&(this._defines.PARALLAXOCCLUSION=!0)),this.invertNormalMapX&&(this._defines.INVERTNORMALMAPX=!0),this.invertNormalMapY&&(this._defines.INVERTNORMALMAPY=!0)}if(this.refractionTexture&&t.StandardMaterial.RefractionTextureEnabled){if(!this.refractionTexture.isReady())return!1;a=!0,this._defines.REFRACTION=!0,this._defines.REFRACTIONMAP_3D=this.refractionTexture.isCube,this.linkRefractionWithTransparency&&(this._defines.LINKREFRACTIONTOTRANSPARENCY=!0),this.refractionTexture instanceof t.HDRCubeTexture&&(this._defines.REFRACTIONMAPINLINEARSPACE=!0,this.refractionTexture.isPMREM&&(this._defines.USEPMREMREFRACTION=!0))}if(this.cameraColorGradingTexture&&t.StandardMaterial.ColorGradingTextureEnabled){if(!this.cameraColorGradingTexture.isReady())return!1;this._defines.CAMERACOLORGRADING=!0}}if(n.clipPlane&&(this._defines.CLIPPLANE=!0),s.getAlphaTesting()&&(this._defines.ALPHATEST=!0),this._shouldUseAlphaFromAlbedoTexture()&&(this._defines.ALPHAFROMALBEDO=!0),this.useEmissiveAsIllumination&&(this._defines.EMISSIVEASILLUMINATION=!0),this.linkEmissiveWithAlbedo&&(this._defines.LINKEMISSIVEWITHALBEDO=!0),this.useLogarithmicDepth&&(this._defines.LOGARITHMICDEPTH=!0),1!=this.cameraContrast&&(this._defines.CAMERACONTRAST=!0),1!=this.cameraExposure&&(this._defines.CAMERATONEMAP=!0),this.cameraColorCurves&&(this._defines.CAMERACOLORCURVES=!0),1==this.overloadedShadeIntensity&&1==this.overloadedShadowIntensity||(this._defines.OVERLOADEDSHADOWVALUES=!0),(this.overloadedMicroSurfaceIntensity>0||this.overloadedEmissiveIntensity>0||this.overloadedReflectivityIntensity>0||this.overloadedAlbedoIntensity>0||this.overloadedAmbientIntensity>0||this.overloadedReflectionIntensity>0)&&(this._defines.OVERLOADEDVALUES=!0),(this.pointsCloud||n.forcePointsCloud)&&(this._defines.POINTSIZE=!0),n.fogEnabled&&i&&i.applyFog&&n.fogMode!==t.Scene.FOGMODE_NONE&&this.fogEnabled&&(this._defines.FOG=!0),t.StandardMaterial.FresnelEnabled&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled||this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled)&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&(this._defines.OPACITYFRESNEL=!0),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._defines.EMISSIVEFRESNEL=!0),o=!0,this._defines.FRESNEL=!0),this._defines.SPECULARTERM&&this.useSpecularOverAlpha&&(this._defines.SPECULAROVERALPHA=!0),this.usePhysicalLightFalloff&&(this._defines.USEPHYSICALLIGHTFALLOFF=!0),this.useRadianceOverAlpha&&(this._defines.RADIANCEOVERALPHA=!0),i&&(o&&i.isVerticesDataPresent(t.VertexBuffer.NormalKind)&&(this._defines.NORMAL=!0),a&&(i.isVerticesDataPresent(t.VertexBuffer.UVKind)&&(this._defines.UV1=!0),i.isVerticesDataPresent(t.VertexBuffer.UV2Kind)&&(this._defines.UV2=!0)),i.useVertexColors&&i.isVerticesDataPresent(t.VertexBuffer.ColorKind)&&(this._defines.VERTEXCOLOR=!0,i.hasVertexAlpha&&(this._defines.VERTEXALPHA=!0)),i.useBones&&i.computeBonesUsingShaders&&(this._defines.NUM_BONE_INFLUENCERS=i.numBoneInfluencers,this._defines.BonesPerMesh=i.skeleton.bones.length+1),r&&(this._defines.INSTANCES=!0)),!this._defines.isEqual(this._cachedDefines)){this._defines.cloneTo(this._cachedDefines),n.resetCachedMaterial();var h=new t.EffectFallbacks;this._defines.REFLECTION&&h.addFallback(0,"REFLECTION"),this._defines.REFRACTION&&h.addFallback(0,"REFRACTION"),this._defines.REFLECTIVITY&&h.addFallback(0,"REFLECTIVITY"),this._defines.BUMP&&h.addFallback(0,"BUMP"),this._defines.PARALLAX&&h.addFallback(1,"PARALLAX"),this._defines.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),this._defines.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),this._defines.FOG&&h.addFallback(1,"FOG"),this._defines.POINTSIZE&&h.addFallback(0,"POINTSIZE"),this._defines.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),t.MaterialHelper.HandleFallbacksForShadows(this._defines,h,this.maxSimultaneousLights),this._defines.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),this._defines.OPACITYFRESNEL&&h.addFallback(1,"OPACITYFRESNEL"),this._defines.EMISSIVEFRESNEL&&h.addFallback(2,"EMISSIVEFRESNEL"),this._defines.FRESNEL&&h.addFallback(3,"FRESNEL"),this._defines.NUM_BONE_INFLUENCERS>0&&h.addCPUSkinningFallback(0,i);var l=[t.VertexBuffer.PositionKind];this._defines.NORMAL&&l.push(t.VertexBuffer.NormalKind),this._defines.UV1&&l.push(t.VertexBuffer.UVKind),this._defines.UV2&&l.push(t.VertexBuffer.UV2Kind),this._defines.VERTEXCOLOR&&l.push(t.VertexBuffer.ColorKind),t.MaterialHelper.PrepareAttributesForBones(l,i,this._defines,h),t.MaterialHelper.PrepareAttributesForInstances(l,this._defines);var c=this._defines.toString(),u=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vEmissiveColor","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vReflectivityInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","depthValues","opacityParts","emissiveLeftColor","emissiveRightColor","vLightingIntensity","vOverloadedShadowIntensity","vOverloadedIntensity","vOverloadedAlbedo","vOverloadedReflection","vOverloadedReflectivity","vOverloadedEmissive","vOverloadedMicroSurface","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX","vSphericalYY","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vMicrosurfaceTextureLods","vCameraInfos"],p=["albedoSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","reflectivitySampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"];t.ColorCurves.PrepareUniforms(u),t.ColorGradingTexture.PrepareUniformsAndSamplers(u,p),t.MaterialHelper.PrepareUniformsAndSamplersList(u,p,this._defines,this.maxSimultaneousLights),this._effect=n.getEngine().createEffect("pbr",l,u,p,c,h,this.onCompiled,this.onError,{maxSimultaneousLights:this.maxSimultaneousLights})}return!!this._effect.isReady()&&(this._renderId=n.getRenderId(),this._wasPreviouslyReady=!0,i&&(i._materialDefines||(i._materialDefines=new e),this._defines.cloneTo(i._materialDefines)),!0)},r.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null),this.refractionTexture&&this.refractionTexture.isRenderTarget&&this._effect.setTexture("refraction2DSampler",null),i.prototype.unbind.call(this)},r.prototype.bindOnlyWorldMatrix=function(t){this._effect.setMatrix("world",t)},r.prototype.bind=function(e,n){if(this._myScene=this.getScene(),this.bindOnlyWorldMatrix(e),t.MaterialHelper.BindBonesParameters(n,this._effect),this._myScene.getCachedMaterial()!==this){if(this._effect.setMatrix("viewProjection",this._myScene.getTransformMatrix()),t.StandardMaterial.FresnelEnabled&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._effect.setColor4("opacityParts",new t.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._effect.setColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._effect.setColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),this._myScene.texturesEnabled){if(this.albedoTexture&&t.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("albedoSampler",this.albedoTexture),this._effect.setFloat2("vAlbedoInfos",this.albedoTexture.coordinatesIndex,this.albedoTexture.level),this._effect.setMatrix("albedoMatrix",this.albedoTexture.getTextureMatrix())),this.ambientTexture&&t.StandardMaterial.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat3("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level,this.ambientTextureStrength),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&t.StandardMaterial.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&t.StandardMaterial.ReflectionTextureEnabled&&(this._microsurfaceTextureLods.x=Math.round(Math.log(this.reflectionTexture.getSize().width)*Math.LOG2E),this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat2("vReflectionInfos",this.reflectionTexture.level,0),this._defines.USESPHERICALFROMREFLECTIONMAP&&(this._effect.setFloat3("vSphericalX",this.reflectionTexture.sphericalPolynomial.x.x,this.reflectionTexture.sphericalPolynomial.x.y,this.reflectionTexture.sphericalPolynomial.x.z),this._effect.setFloat3("vSphericalY",this.reflectionTexture.sphericalPolynomial.y.x,this.reflectionTexture.sphericalPolynomial.y.y,this.reflectionTexture.sphericalPolynomial.y.z),this._effect.setFloat3("vSphericalZ",this.reflectionTexture.sphericalPolynomial.z.x,this.reflectionTexture.sphericalPolynomial.z.y,this.reflectionTexture.sphericalPolynomial.z.z),this._effect.setFloat3("vSphericalXX",this.reflectionTexture.sphericalPolynomial.xx.x,this.reflectionTexture.sphericalPolynomial.xx.y,this.reflectionTexture.sphericalPolynomial.xx.z),this._effect.setFloat3("vSphericalYY",this.reflectionTexture.sphericalPolynomial.yy.x,this.reflectionTexture.sphericalPolynomial.yy.y,this.reflectionTexture.sphericalPolynomial.yy.z),this._effect.setFloat3("vSphericalZZ",this.reflectionTexture.sphericalPolynomial.zz.x,this.reflectionTexture.sphericalPolynomial.zz.y,this.reflectionTexture.sphericalPolynomial.zz.z),this._effect.setFloat3("vSphericalXY",this.reflectionTexture.sphericalPolynomial.xy.x,this.reflectionTexture.sphericalPolynomial.xy.y,this.reflectionTexture.sphericalPolynomial.xy.z),this._effect.setFloat3("vSphericalYZ",this.reflectionTexture.sphericalPolynomial.yz.x,this.reflectionTexture.sphericalPolynomial.yz.y,this.reflectionTexture.sphericalPolynomial.yz.z),this._effect.setFloat3("vSphericalZX",this.reflectionTexture.sphericalPolynomial.zx.x,this.reflectionTexture.sphericalPolynomial.zx.y,this.reflectionTexture.sphericalPolynomial.zx.z))),this.emissiveTexture&&t.StandardMaterial.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.lightmapTexture&&t.StandardMaterial.LightmapTextureEnabled&&(this._effect.setTexture("lightmapSampler",this.lightmapTexture),this._effect.setFloat2("vLightmapInfos",this.lightmapTexture.coordinatesIndex,this.lightmapTexture.level),this._effect.setMatrix("lightmapMatrix",this.lightmapTexture.getTextureMatrix())),t.StandardMaterial.SpecularTextureEnabled&&(this.metallicTexture?(this._effect.setTexture("reflectivitySampler",this.metallicTexture),this._effect.setFloat2("vReflectivityInfos",this.metallicTexture.coordinatesIndex,this.metallicTexture.level),this._effect.setMatrix("reflectivityMatrix",this.metallicTexture.getTextureMatrix())):this.reflectivityTexture&&(this._effect.setTexture("reflectivitySampler",this.reflectivityTexture),this._effect.setFloat2("vReflectivityInfos",this.reflectivityTexture.coordinatesIndex,this.reflectivityTexture.level),this._effect.setMatrix("reflectivityMatrix",this.reflectivityTexture.getTextureMatrix()))),this.bumpTexture&&this._myScene.getEngine().getCaps().standardDerivatives&&t.StandardMaterial.BumpTextureEnabled&&!this.disableBumpMap&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat3("vBumpInfos",this.bumpTexture.coordinatesIndex,1/this.bumpTexture.level,this.parallaxScaleBias),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),this.refractionTexture&&t.StandardMaterial.RefractionTextureEnabled){this._microsurfaceTextureLods.y=Math.round(Math.log(this.refractionTexture.getSize().width)*Math.LOG2E);var s=1;this.refractionTexture.isCube?this._effect.setTexture("refractionCubeSampler",this.refractionTexture):(this._effect.setTexture("refraction2DSampler",this.refractionTexture),this._effect.setMatrix("refractionMatrix",this.refractionTexture.getReflectionTextureMatrix()),this.refractionTexture.depth&&(s=this.refractionTexture.depth)),this._effect.setFloat4("vRefractionInfos",this.refractionTexture.level,this.indexOfRefraction,s,this.invertRefractionY?-1:1)}(this.reflectionTexture||this.refractionTexture)&&this._effect.setFloat2("vMicrosurfaceTextureLods",this._microsurfaceTextureLods.x,this._microsurfaceTextureLods.y),this.cameraColorGradingTexture&&t.StandardMaterial.ColorGradingTextureEnabled&&t.ColorGradingTexture.Bind(this.cameraColorGradingTexture,this._effect)}t.MaterialHelper.BindClipPlane(this._effect,this._myScene),this.pointsCloud&&this._effect.setFloat("pointSize",this.pointSize),this._myScene.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this.convertColorToLinearSpaceToRef(this.reflectivityColor,r._scaledReflectivity),this._effect.setVector3("vEyePosition",this._myScene._mirroredCameraPosition?this._myScene._mirroredCameraPosition:this._myScene.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this._effect.setColor4("vReflectivityColor",r._scaledReflectivity,this.microSurface),this.convertColorToLinearSpaceToRef(this.emissiveColor,r._scaledEmissive),this._effect.setColor3("vEmissiveColor",r._scaledEmissive),this.convertColorToLinearSpaceToRef(this.reflectionColor,r._scaledReflection),this._effect.setColor3("vReflectionColor",r._scaledReflection)}this._myScene.getCachedMaterial()===this&&this.isFrozen||(this.convertColorToLinearSpaceToRef(this.albedoColor,r._scaledAlbedo),this._effect.setColor4("vAlbedoColor",r._scaledAlbedo,this.alpha*n.visibility),this._myScene.lightsEnabled&&!this.disableLighting&&r.BindLights(this._myScene,n,this._effect,this._defines,this.useScalarInLinearSpace,this.maxSimultaneousLights,this.usePhysicalLightFalloff),(this._myScene.fogEnabled&&n.applyFog&&this._myScene.fogMode!==t.Scene.FOGMODE_NONE||this.reflectionTexture)&&this._effect.setMatrix("view",this._myScene.getViewMatrix()),t.MaterialHelper.BindFogParameters(this._myScene,n,this._effect),this._lightingInfos.x=this.directIntensity,this._lightingInfos.y=this.emissiveIntensity,this._lightingInfos.z=this.environmentIntensity,this._lightingInfos.w=this.specularIntensity,this._effect.setVector4("vLightingIntensity",this._lightingInfos),this._overloadedShadowInfos.x=this.overloadedShadowIntensity,this._overloadedShadowInfos.y=this.overloadedShadeIntensity,this._effect.setVector4("vOverloadedShadowIntensity",this._overloadedShadowInfos),this._cameraInfos.x=this.cameraExposure,this._cameraInfos.y=this.cameraContrast,this._effect.setVector4("vCameraInfos",this._cameraInfos),this.cameraColorCurves&&t.ColorCurves.Bind(this.cameraColorCurves,this._effect),this._overloadedIntensity.x=this.overloadedAmbientIntensity,this._overloadedIntensity.y=this.overloadedAlbedoIntensity,this._overloadedIntensity.z=this.overloadedReflectivityIntensity,this._overloadedIntensity.w=this.overloadedEmissiveIntensity,this._effect.setVector4("vOverloadedIntensity",this._overloadedIntensity),this.convertColorToLinearSpaceToRef(this.overloadedAmbient,this._tempColor),this._effect.setColor3("vOverloadedAmbient",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedAlbedo,this._tempColor),this._effect.setColor3("vOverloadedAlbedo",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedReflectivity,this._tempColor),this._effect.setColor3("vOverloadedReflectivity",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedEmissive,this._tempColor),this._effect.setColor3("vOverloadedEmissive",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedReflection,this._tempColor),this._effect.setColor3("vOverloadedReflection",this._tempColor),this._overloadedMicroSurface.x=this.overloadedMicroSurface,this._overloadedMicroSurface.y=this.overloadedMicroSurfaceIntensity,this._overloadedMicroSurface.z=this.overloadedReflectionIntensity,this._effect.setVector3("vOverloadedMicroSurface",this._overloadedMicroSurface),t.MaterialHelper.BindLogDepth(this._defines,this._effect,this._myScene)),i.prototype.bind.call(this,e,n),this._myScene=null},r.prototype.getAnimatables=function(){var t=[];return this.albedoTexture&&this.albedoTexture.animations&&this.albedoTexture.animations.length>0&&t.push(this.albedoTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&t.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&t.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&t.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&t.push(this.emissiveTexture),this.metallicTexture&&this.metallicTexture.animations&&this.metallicTexture.animations.length>0?t.push(this.metallicTexture):this.reflectivityTexture&&this.reflectivityTexture.animations&&this.reflectivityTexture.animations.length>0&&t.push(this.reflectivityTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&t.push(this.bumpTexture),this.lightmapTexture&&this.lightmapTexture.animations&&this.lightmapTexture.animations.length>0&&t.push(this.lightmapTexture),this.refractionTexture&&this.refractionTexture.animations&&this.refractionTexture.animations.length>0&&t.push(this.refractionTexture),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.animations&&this.cameraColorGradingTexture.animations.length>0&&t.push(this.cameraColorGradingTexture),t},r.prototype.dispose=function(t,e){e&&(this.albedoTexture&&this.albedoTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.metallicTexture&&this.metallicTexture.dispose(),this.reflectivityTexture&&this.reflectivityTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),this.lightmapTexture&&this.lightmapTexture.dispose(),this.refractionTexture&&this.refractionTexture.dispose(),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.dispose()),i.prototype.dispose.call(this,t,e)},r.prototype.clone=function(e){var i=this;return t.SerializationHelper.Clone(function(){return new r(e,i.getScene())},this)},r.prototype.serialize=function(){var e=t.SerializationHelper.Serialize(this);return e.customType="BABYLON.PBRMaterial",e},r.Parse=function(e,i,n){return t.SerializationHelper.Parse(function(){return new r(e.name,i)},e,i,n)},r._scaledAlbedo=new t.Color3,r._scaledReflectivity=new t.Color3,r._scaledEmissive=new t.Color3,r._scaledReflection=new t.Color3,s([t.serialize()],r.prototype,"directIntensity",void 0),s([t.serialize()],r.prototype,"emissiveIntensity",void 0),s([t.serialize()],r.prototype,"environmentIntensity",void 0),s([t.serialize()],r.prototype,"specularIntensity",void 0),s([t.serialize()],r.prototype,"disableBumpMap",void 0),s([t.serialize()],r.prototype,"overloadedShadowIntensity",void 0),s([t.serialize()],r.prototype,"overloadedShadeIntensity",void 0),s([t.serialize()],r.prototype,"cameraExposure",void 0),s([t.serialize()],r.prototype,"cameraContrast",void 0),s([t.serializeAsTexture()],r.prototype,"cameraColorGradingTexture",void 0),s([t.serializeAsColorCurves()],r.prototype,"cameraColorCurves",void 0),s([t.serializeAsColor3()],r.prototype,"overloadedAmbient",void 0),s([t.serialize()],r.prototype,"overloadedAmbientIntensity",void 0),s([t.serializeAsColor3()],r.prototype,"overloadedAlbedo",void 0),s([t.serialize()],r.prototype,"overloadedAlbedoIntensity",void 0),s([t.serializeAsColor3()],r.prototype,"overloadedReflectivity",void 0),s([t.serialize()],r.prototype,"overloadedReflectivityIntensity",void 0),s([t.serializeAsColor3()],r.prototype,"overloadedEmissive",void 0),s([t.serialize()],r.prototype,"overloadedEmissiveIntensity",void 0),s([t.serializeAsColor3()],r.prototype,"overloadedReflection",void 0),s([t.serialize()],r.prototype,"overloadedReflectionIntensity",void 0),s([t.serialize()],r.prototype,"overloadedMicroSurface",void 0),s([t.serialize()],r.prototype,"overloadedMicroSurfaceIntensity",void 0),s([t.serializeAsTexture()],r.prototype,"albedoTexture",void 0),s([t.serializeAsTexture()],r.prototype,"ambientTexture",void 0),s([t.serialize()],r.prototype,"ambientTextureStrength",void 0),s([t.serializeAsTexture()],r.prototype,"opacityTexture",void 0),s([t.serializeAsTexture()],r.prototype,"reflectionTexture",void 0),s([t.serializeAsTexture()],r.prototype,"emissiveTexture",void 0),s([t.serializeAsTexture()],r.prototype,"reflectivityTexture",void 0),s([t.serializeAsTexture()],r.prototype,"metallicTexture",void 0),s([t.serializeAsTexture()],r.prototype,"bumpTexture",void 0),s([t.serializeAsTexture()],r.prototype,"lightmapTexture",void 0),s([t.serializeAsTexture()],r.prototype,"refractionTexture",void 0),s([t.serializeAsColor3("ambient")],r.prototype,"ambientColor",void 0),s([t.serializeAsColor3("albedo")],r.prototype,"albedoColor",void 0),s([t.serializeAsColor3("reflectivity")],r.prototype,"reflectivityColor",void 0),s([t.serializeAsColor3("reflection")],r.prototype,"reflectionColor",void 0),s([t.serializeAsColor3("emissive")],r.prototype,"emissiveColor",void 0),s([t.serialize()],r.prototype,"microSurface",void 0),s([t.serialize()],r.prototype,"indexOfRefraction",void 0),s([t.serialize()],r.prototype,"invertRefractionY",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"opacityFresnelParameters",void 0),s([t.serializeAsFresnelParameters()],r.prototype,"emissiveFresnelParameters",void 0),s([t.serialize()],r.prototype,"linkRefractionWithTransparency",void 0),s([t.serialize()],r.prototype,"linkEmissiveWithAlbedo",void 0),s([t.serialize()],r.prototype,"useLightmapAsShadowmap",void 0),s([t.serialize()],r.prototype,"useEmissiveAsIllumination",void 0),s([t.serialize()],r.prototype,"useAlphaFromAlbedoTexture",void 0),s([t.serialize()],r.prototype,"useSpecularOverAlpha",void 0),s([t.serialize()],r.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),s([t.serialize()],r.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),s([t.serialize()],r.prototype,"useRoughnessFromMetallicTextureGreen",void 0),s([t.serialize()],r.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),s([t.serialize()],r.prototype,"useScalarInLinearSpace",void 0),s([t.serialize()],r.prototype,"usePhysicalLightFalloff",void 0),s([t.serialize()],r.prototype,"useRadianceOverAlpha",void 0),s([t.serialize()],r.prototype,"useParallax",void 0),s([t.serialize()],r.prototype,"useParallaxOcclusion",void 0),s([t.serialize()],r.prototype,"parallaxScaleBias",void 0),s([t.serialize()],r.prototype,"disableLighting",void 0),s([t.serialize()],r.prototype,"maxSimultaneousLights",void 0),s([t.serialize()],r.prototype,"invertNormalMapX",void 0),s([t.serialize()],r.prototype,"invertNormalMapY",void 0),s([t.serialize()],r.prototype,"useLogarithmicDepth",null),r}(t.Material);t.PBRMaterial=i}(r||(r={}));var r;!function(t){var e=function(){function e(e){var i=this;this._transformationMatrix=t.Matrix.Identity(),this._enabled=!1,this._labelsEnabled=!1,this._displayStatistics=!0,this._displayTree=!1,this._displayLogs=!1,this._skeletonViewers=new Array,this._identityMatrix=t.Matrix.Identity(),this.axisRatio=.02,this.accentColor="orange",this._scene=e,this._syncPositions=function(){var t=i._scene.getEngine(),e=t.getRenderingCanvasClientRect();i._showUI&&(i._statsDiv.style.left=e.width-410+"px",i._statsDiv.style.top=e.height-290+"px",i._statsDiv.style.width="400px",i._statsDiv.style.height="auto",i._statsSubsetDiv.style.maxHeight="240px",i._optionsDiv.style.left="0px",i._optionsDiv.style.top="10px",i._optionsDiv.style.width="200px",i._optionsDiv.style.height="auto",i._optionsSubsetDiv.style.maxHeight=e.height-225+"px",i._logDiv.style.left="0px",i._logDiv.style.top=e.height-170+"px",i._logDiv.style.width="600px",i._logDiv.style.height="160px",i._treeDiv.style.left=e.width-310+"px",i._treeDiv.style.top="10px",i._treeDiv.style.width="300px",i._treeDiv.style.height="auto",i._treeSubsetDiv.style.maxHeight=e.height-340+"px"),i._globalDiv.style.left=e.left+"px",i._globalDiv.style.top=e.top+"px",i._drawingCanvas.style.left="0px",i._drawingCanvas.style.top="0px",i._drawingCanvas.style.width=t.getRenderWidth()+"px",i._drawingCanvas.style.height=t.getRenderHeight()+"px";var r=window.devicePixelRatio||1,n=i._drawingContext,s=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;i._ratio=r/s,i._drawingCanvas.width=t.getRenderWidth()*i._ratio,i._drawingCanvas.height=t.getRenderHeight()*i._ratio},this._onCanvasClick=function(t){i._clickPosition={x:t.clientX*i._ratio,y:t.clientY*i._ratio}},this._syncUI=function(){i._showUI&&(i._displayStatistics?(i._displayStats(),i._statsDiv.style.display=""):i._statsDiv.style.display="none",i._displayLogs?i._logDiv.style.display="":i._logDiv.style.display="none",i._displayTree?(i._treeDiv.style.display="",i._needToRefreshMeshesTree&&(i._needToRefreshMeshesTree=!1,i._refreshMeshesTreeContent())):i._treeDiv.style.display="none")},this._syncData=function(){if(i._labelsEnabled||!i._showUI){i._camera.getViewMatrix().multiplyToRef(i._camera.getProjectionMatrix(),i._transformationMatrix),i._drawingContext.clearRect(0,0,i._drawingCanvas.width,i._drawingCanvas.height);var e,r,n=i._scene.getEngine(),s=i._camera.viewport,o=s.toGlobal(n.getRenderWidth(),n.getRenderHeight()),a=i._camera.getActiveMeshes();for(e=0;e<a.length;e++){var h=a.data[e],l=h.getBoundingInfo().boundingSphere.center;r=t.Vector3.Project(l,h.getWorldMatrix(),i._transformationMatrix,o),(h.renderOverlay||i.shouldDisplayAxis&&i.shouldDisplayAxis(h))&&i._renderAxis(r,h,o),i.shouldDisplayLabel&&!i.shouldDisplayLabel(h)||i._renderLabel(h.name,r,12,function(){h.renderOverlay=!h.renderOverlay},function(){return h.renderOverlay?"red":"black"})}var c=i._scene.cameras;for(e=0;e<c.length;e++){var u=c[e];u!==i._camera&&(r=t.Vector3.Project(t.Vector3.Zero(),u.getWorldMatrix(),i._transformationMatrix,o),i.shouldDisplayLabel&&!i.shouldDisplayLabel(u)||i._renderLabel(u.name,r,12,function(){i._camera.detachControl(n.getRenderingCanvas()),i._camera=u,i._camera.attachControl(n.getRenderingCanvas())},function(){return"purple"}))}var p=i._scene.lights;for(e=0;e<p.length;e++){var d=p[e];d.position&&(r=t.Vector3.Project(d.getAbsolutePosition(),i._identityMatrix,i._transformationMatrix,o),i.shouldDisplayLabel&&!i.shouldDisplayLabel(d)||i._renderLabel(d.name,r,-20,function(){d.setEnabled(!d.isEnabled())},function(){return d.isEnabled()?"orange":"gray"}))}}i._clickPosition=void 0}}return e.prototype._refreshMeshesTreeContent=function(){for(;this._treeSubsetDiv.hasChildNodes();)this._treeSubsetDiv.removeChild(this._treeSubsetDiv.lastChild);var t=this._scene.meshes.slice(0,this._scene.meshes.length);t.sort(function(t,e){return t.name===e.name?0:t.name>e.name?1:-1});for(var e=0;e<t.length;e++){var i=t[e];i.isEnabled()&&this._generateAdvancedCheckBox(this._treeSubsetDiv,i.name,i.getTotalVertices()+" verts",i.isVisible,function(t,e){e.isVisible=t.checked},i)}},e.prototype._renderSingleAxis=function(t,e,i,r,n){this._drawingContext.beginPath(),this._drawingContext.moveTo(t.x,t.y),this._drawingContext.lineTo(e.x,e.y),this._drawingContext.strokeStyle=n,this._drawingContext.lineWidth=4,this._drawingContext.stroke(),this._drawingContext.font="normal 14px Segoe UI",this._drawingContext.fillStyle=n,this._drawingContext.fillText(r,i.x,i.y)},e.prototype._renderAxis=function(e,i,r){var n=i.getBoundingInfo().boundingSphere.center,s=i.getWorldMatrix(),o=t.Vector3.UnprojectFromTransform(e.add(new t.Vector3(this._drawingCanvas.width*this.axisRatio,0,0)),r.width,r.height,s,this._transformationMatrix),a=o.subtract(n).length(),h=t.Vector3.Project(n.add(new t.Vector3(a,0,0)),s,this._transformationMatrix,r),l=t.Vector3.Project(n.add(new t.Vector3(1.5*a,0,0)),s,this._transformationMatrix,r);this._renderSingleAxis(e,h,l,"x","#FF0000");var c=t.Vector3.Project(n.add(new t.Vector3(0,a,0)),s,this._transformationMatrix,r),u=t.Vector3.Project(n.add(new t.Vector3(0,1.5*a,0)),s,this._transformationMatrix,r);this._renderSingleAxis(e,c,u,"y","#00FF00");var p=t.Vector3.Project(n.add(new t.Vector3(0,0,a)),s,this._transformationMatrix,r),d=t.Vector3.Project(n.add(new t.Vector3(0,0,1.5*a)),s,this._transformationMatrix,r);this._renderSingleAxis(e,p,d,"z","#0000FF")},e.prototype._renderLabel=function(t,e,i,r,n){if(e.z>0&&e.z<1){this._drawingContext.font="normal 12px Segoe UI";var s=this._drawingContext.measureText(t),o=e.x-s.width/2,a=e.y,h=this._drawingCanvas.getBoundingClientRect();this._showUI&&this._isClickInsideRect(h.left*this._ratio+o-5,h.top*this._ratio+a-i-12,s.width+10,17)&&r(),this._drawingContext.beginPath(),this._drawingContext.rect(o-5,a-i-12,s.width+10,17),this._drawingContext.fillStyle=n(),this._drawingContext.globalAlpha=.5,this._drawingContext.fill(),this._drawingContext.globalAlpha=1,this._drawingContext.strokeStyle="#FFFFFF",this._drawingContext.lineWidth=1,this._drawingContext.stroke(),this._drawingContext.fillStyle="#FFFFFF",this._drawingContext.fillText(t,o,a-i),this._drawingContext.beginPath(),this._drawingContext.arc(e.x,a,5,0,2*Math.PI,!1),this._drawingContext.fill()}},e.prototype._isClickInsideRect=function(t,e,i,r){return!!this._clickPosition&&(!(this._clickPosition.x<t||this._clickPosition.x>t+i)&&!(this._clickPosition.y<e||this._clickPosition.y>e+r))},e.prototype.isVisible=function(){return this._enabled},e.prototype.hide=function(){if(this._enabled){this._enabled=!1;var e=this._scene.getEngine();this._scene.unregisterBeforeRender(this._syncData),this._scene.unregisterAfterRender(this._syncUI),this._rootElement.removeChild(this._globalDiv),this._scene.forceShowBoundingBoxes=!1,this._scene.forceWireframe=!1,t.StandardMaterial.DiffuseTextureEnabled=!0,t.StandardMaterial.AmbientTextureEnabled=!0,t.StandardMaterial.SpecularTextureEnabled=!0,t.StandardMaterial.EmissiveTextureEnabled=!0,t.StandardMaterial.BumpTextureEnabled=!0,t.StandardMaterial.OpacityTextureEnabled=!0,t.StandardMaterial.ReflectionTextureEnabled=!0,t.StandardMaterial.LightmapTextureEnabled=!0,t.StandardMaterial.RefractionTextureEnabled=!0,t.StandardMaterial.ColorGradingTextureEnabled=!0,this._scene.shadowsEnabled=!0,this._scene.particlesEnabled=!0,this._scene.postProcessesEnabled=!0,this._scene.collisionsEnabled=!0,this._scene.lightsEnabled=!0,this._scene.texturesEnabled=!0,this._scene.lensFlaresEnabled=!0,this._scene.proceduralTexturesEnabled=!0,this._scene.renderTargetsEnabled=!0,this._scene.probesEnabled=!0,e.getRenderingCanvas().removeEventListener("click",this._onCanvasClick),this._clearSkeletonViewers()}},e.prototype._clearSkeletonViewers=function(){for(var t=0;t<this._skeletonViewers.length;t++)this._skeletonViewers[t].dispose();this._skeletonViewers=[]},e.prototype.show=function(t,e,i){if(void 0===t&&(t=!0),void 0===e&&(e=null),void 0===i&&(i=null),!this._enabled){this._enabled=!0,this._camera=e?e:this._scene.activeCamera,this._showUI=t;var r=this._scene.getEngine();this._globalDiv=document.createElement("div"),this._rootElement=i||document.body,this._rootElement.appendChild(this._globalDiv),this._generateDOMelements(),r.getRenderingCanvas().addEventListener("click",this._onCanvasClick),this._syncPositions(),this._scene.registerBeforeRender(this._syncData),this._scene.registerAfterRender(this._syncUI)}},e.prototype._clearLabels=function(){this._drawingContext.clearRect(0,0,this._drawingCanvas.width,this._drawingCanvas.height);for(var t=0;t<this._scene.meshes.length;t++){this._scene.meshes[t].renderOverlay=!1}},e.prototype._generateheader=function(t,e){var i=document.createElement("div");i.innerHTML=e+"&nbsp;",i.style.textAlign="right",i.style.width="100%",i.style.color="white",i.style.backgroundColor="Black",i.style.padding="5px 5px 4px 0px",i.style.marginLeft="-5px",i.style.fontWeight="bold",t.appendChild(i)},e.prototype._generateTexBox=function(t,e,i){var r=document.createElement("label");r.style.display="inline",r.innerHTML=e,r.style.color=i,t.appendChild(r),t.appendChild(document.createElement("br"))},e.prototype._generateAdvancedCheckBox=function(t,e,i,r,n,s){void 0===s&&(s=null);var o=document.createElement("label");o.style.display="inline";var a=document.createElement("input");a.type="checkbox",a.checked=r,a.style.display="inline",a.style.margin="0px 5px 0px 0px",a.style.verticalAlign="sub",a.addEventListener("change",function(t){n(t.target,s)}),o.appendChild(a);var h=document.createElement("span"),l=document.createElement("span"),c=document.createElement("span");c.style.cssFloat="right",l.innerHTML=e,c.innerHTML=i,c.style.fontSize="12px",c.style.maxWidth="200px",h.appendChild(l),h.appendChild(c),o.appendChild(h),t.appendChild(o),t.appendChild(document.createElement("br"))},e.prototype._generateCheckBox=function(t,e,i,r,n){void 0===n&&(n=null);var s=document.createElement("label");s.style.display="inline";var o=document.createElement("input");o.type="checkbox",o.checked=i,o.style.display="inline",o.style.margin="0px 5px 0px 0px",o.style.verticalAlign="sub",o.addEventListener("change",function(t){r(t.target,n)}),s.appendChild(o),s.appendChild(document.createTextNode(e)),t.appendChild(s),t.appendChild(document.createElement("br"))},e.prototype._generateButton=function(t,e,i,r){void 0===r&&(r=null);var n=document.createElement("button");n.innerHTML=e,n.style.height="24px",n.style.width="150px",n.style.marginBottom="5px",n.style.color="#444444",n.style.border="1px solid white",n.className="debugLayerButton",n.addEventListener("click",function(t){i(t.target,r)}),t.appendChild(n),t.appendChild(document.createElement("br"))},e.prototype._generateRadio=function(t,e,i,r,n,s){void 0===s&&(s=null);var o=document.createElement("label");o.style.display="inline";var a=document.createElement("input");a.type="radio",a.name=i,a.checked=r,a.style.display="inline",a.style.margin="0px 5px 0px 0px",a.style.verticalAlign="sub",a.addEventListener("change",function(t){n(t.target,s)}),o.appendChild(a),o.appendChild(document.createTextNode(e)),t.appendChild(o),t.appendChild(document.createElement("br"))},e.prototype._generateDOMelements=function(){var e=this;if(this._globalDiv.id="DebugLayer",this._globalDiv.style.position="absolute",this._globalDiv.style.fontFamily="Segoe UI, Arial",this._globalDiv.style.fontSize="14px",this._globalDiv.style.color="white",this._drawingCanvas=document.createElement("canvas"),this._drawingCanvas.id="DebugLayerDrawingCanvas",this._drawingCanvas.style.position="absolute",this._drawingCanvas.style.pointerEvents="none",this._drawingCanvas.style.backgroundColor="transparent",this._drawingContext=this._drawingCanvas.getContext("2d"),this._globalDiv.appendChild(this._drawingCanvas),this._showUI){var i="rgba(128, 128, 128, 0.4)",r="rgb(180, 180, 180) solid 1px";this._statsDiv=document.createElement("div"),this._statsDiv.id="DebugLayerStats",this._statsDiv.style.border=r,this._statsDiv.style.position="absolute",this._statsDiv.style.background=i,this._statsDiv.style.padding="0px 0px 0px 5px",this._generateheader(this._statsDiv,"STATISTICS"),this._statsSubsetDiv=document.createElement("div"),this._statsSubsetDiv.style.paddingTop="5px",this._statsSubsetDiv.style.paddingBottom="5px",this._statsSubsetDiv.style.overflowY="auto",this._statsDiv.appendChild(this._statsSubsetDiv),this._treeDiv=document.createElement("div"),this._treeDiv.id="DebugLayerTree",this._treeDiv.style.border=r,this._treeDiv.style.position="absolute",this._treeDiv.style.background=i,this._treeDiv.style.padding="0px 0px 0px 5px",this._treeDiv.style.display="none",this._generateheader(this._treeDiv,"MESHES TREE"),this._treeSubsetDiv=document.createElement("div"),this._treeSubsetDiv.style.paddingTop="5px",this._treeSubsetDiv.style.paddingRight="5px",this._treeSubsetDiv.style.overflowY="auto",this._treeSubsetDiv.style.maxHeight="300px",this._treeDiv.appendChild(this._treeSubsetDiv),this._needToRefreshMeshesTree=!0,this._logDiv=document.createElement("div"),this._logDiv.style.border=r,this._logDiv.id="DebugLayerLogs",this._logDiv.style.position="absolute",this._logDiv.style.background=i,this._logDiv.style.padding="0px 0px 0px 5px",this._logDiv.style.display="none",this._generateheader(this._logDiv,"LOGS"),this._logSubsetDiv=document.createElement("div"),this._logSubsetDiv.style.height="127px",this._logSubsetDiv.style.paddingTop="5px",this._logSubsetDiv.style.overflowY="auto",this._logSubsetDiv.style.fontSize="12px",this._logSubsetDiv.style.fontFamily="consolas",this._logSubsetDiv.innerHTML=t.Tools.LogCache,this._logDiv.appendChild(this._logSubsetDiv),t.Tools.OnNewCacheEntry=function(t){e._logSubsetDiv.innerHTML=t+e._logSubsetDiv.innerHTML},this._optionsDiv=document.createElement("div"),this._optionsDiv.id="DebugLayerOptions",this._optionsDiv.style.border=r,this._optionsDiv.style.position="absolute",this._optionsDiv.style.background=i,this._optionsDiv.style.padding="0px 0px 0px 5px",this._optionsDiv.style.overflowY="auto",this._generateheader(this._optionsDiv,"OPTIONS"),this._optionsSubsetDiv=document.createElement("div"),this._optionsSubsetDiv.style.paddingTop="5px",this._optionsSubsetDiv.style.paddingBottom="5px",this._optionsSubsetDiv.style.overflowY="auto",this._optionsSubsetDiv.style.maxHeight="200px",this._optionsDiv.appendChild(this._optionsSubsetDiv),this._generateTexBox(this._optionsSubsetDiv,"<b>Windows:</b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Statistics",this._displayStatistics,function(t){e._displayStatistics=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Logs",this._displayLogs,function(t){e._displayLogs=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Meshes tree",this._displayTree,function(t){e._displayTree=t.checked,e._needToRefreshMeshesTree=!0}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>General:</b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Bounding boxes",this._scene.forceShowBoundingBoxes,function(t){e._scene.forceShowBoundingBoxes=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Clickable labels",this._labelsEnabled,function(t){e._labelsEnabled=t.checked,e._labelsEnabled||e._clearLabels()}),this._generateCheckBox(this._optionsSubsetDiv,"Generate user marks (F12)",t.Tools.PerformanceLogLevel===t.Tools.PerformanceUserMarkLogLevel,function(e){e.checked?t.Tools.PerformanceLogLevel=t.Tools.PerformanceUserMarkLogLevel:t.Tools.PerformanceLogLevel=t.Tools.PerformanceNoneLogLevel}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Rendering mode:</b>",this.accentColor),this._generateRadio(this._optionsSubsetDiv,"Solid","renderMode",!this._scene.forceWireframe&&!this._scene.forcePointsCloud,function(t){t.checked&&(e._scene.forceWireframe=!1,e._scene.forcePointsCloud=!1)}),this._generateRadio(this._optionsSubsetDiv,"Wireframe","renderMode",this._scene.forceWireframe,function(t){t.checked&&(e._scene.forceWireframe=!0,e._scene.forcePointsCloud=!1)}),this._generateRadio(this._optionsSubsetDiv,"Point","renderMode",this._scene.forcePointsCloud,function(t){t.checked&&(e._scene.forceWireframe=!1,e._scene.forcePointsCloud=!0)}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Texture channels:</b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Diffuse",t.StandardMaterial.DiffuseTextureEnabled,function(e){t.StandardMaterial.DiffuseTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Ambient",t.StandardMaterial.AmbientTextureEnabled,function(e){t.StandardMaterial.AmbientTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Specular",t.StandardMaterial.SpecularTextureEnabled,function(e){t.StandardMaterial.SpecularTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Emissive",t.StandardMaterial.EmissiveTextureEnabled,function(e){t.StandardMaterial.EmissiveTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Bump",t.StandardMaterial.BumpTextureEnabled,function(e){t.StandardMaterial.BumpTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Opacity",t.StandardMaterial.OpacityTextureEnabled,function(e){t.StandardMaterial.OpacityTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Reflection",t.StandardMaterial.ReflectionTextureEnabled,function(e){t.StandardMaterial.ReflectionTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Refraction",t.StandardMaterial.RefractionTextureEnabled,function(e){t.StandardMaterial.RefractionTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"ColorGrading",t.StandardMaterial.ColorGradingTextureEnabled,function(e){t.StandardMaterial.ColorGradingTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Lightmap",t.StandardMaterial.LightmapTextureEnabled,function(e){t.StandardMaterial.LightmapTextureEnabled=e.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Fresnel",t.StandardMaterial.FresnelEnabled,function(e){t.StandardMaterial.FresnelEnabled=e.checked}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Options:</b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Animations",this._scene.animationsEnabled,function(t){e._scene.animationsEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Collisions",this._scene.collisionsEnabled,function(t){e._scene.collisionsEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Fog",this._scene.fogEnabled,function(t){e._scene.fogEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Lens flares",this._scene.lensFlaresEnabled,function(t){e._scene.lensFlaresEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Lights",this._scene.lightsEnabled,function(t){e._scene.lightsEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Particles",this._scene.particlesEnabled,function(t){e._scene.particlesEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Post-processes",this._scene.postProcessesEnabled,function(t){e._scene.postProcessesEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Probes",this._scene.probesEnabled,function(t){e._scene.probesEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Procedural textures",this._scene.proceduralTexturesEnabled,function(t){e._scene.proceduralTexturesEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Render targets",this._scene.renderTargetsEnabled,function(t){e._scene.renderTargetsEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Shadows",this._scene.shadowsEnabled,function(t){e._scene.shadowsEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Skeletons",this._scene.skeletonsEnabled,function(t){e._scene.skeletonsEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Sprites",this._scene.spritesEnabled,function(t){e._scene.spritesEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Textures",this._scene.texturesEnabled,function(t){e._scene.texturesEnabled=t.checked}),t.AudioEngine&&t.Engine.audioEngine.canUseWebAudio&&(this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Audio:</b>",this.accentColor),this._generateRadio(this._optionsSubsetDiv,"Headphones","panningModel",this._scene.headphone,function(t){t.checked&&(e._scene.headphone=!0)}),this._generateRadio(this._optionsSubsetDiv,"Normal Speakers","panningModel",!this._scene.headphone,function(t){t.checked&&(e._scene.headphone=!1)}),this._generateCheckBox(this._optionsSubsetDiv,"Disable audio",!this._scene.audioEnabled,function(t){e._scene.audioEnabled=!t.checked})),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Viewers:</b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Skeletons",!1,function(i){if(!i.checked)return void e._clearSkeletonViewers();for(var r=0;r<e._scene.meshes.length;r++){var n=e._scene.meshes[r];if(n.skeleton){for(var s=!1,o=0;o<e._skeletonViewers.length;o++)if(e._skeletonViewers[o].skeleton===n.skeleton){s=!0;break}if(s)continue;var a=new t.Debug.SkeletonViewer(n.skeleton,n,e._scene);a.isEnabled=!0,e._skeletonViewers.push(a)}}}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Tools:</b>",this.accentColor),this._generateButton(this._optionsSubsetDiv,"Dump rendertargets",function(t){e._scene.dumpNextRenderTargets=!0}),this._generateButton(this._optionsSubsetDiv,"Run SceneOptimizer",function(i){t.SceneOptimizer.OptimizeAsync(e._scene)}),this._generateButton(this._optionsSubsetDiv,"Log camera object",function(t){e._camera?console.log(e._camera):console.warn("No camera defined, or debug layer created before camera creation!")}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._globalDiv.appendChild(this._statsDiv),this._globalDiv.appendChild(this._logDiv),this._globalDiv.appendChild(this._optionsDiv),this._globalDiv.appendChild(this._treeDiv)}},e.prototype._displayStats=function(){var e=this._scene,i=e.getEngine(),r=i.getGlInfo();this._statsSubsetDiv.innerHTML="Babylon.js v"+t.Engine.Version+" - <b>"+t.Tools.Format(i.getFps(),0)+" fps</b><br><br><div style='column-count: 2;-moz-column-count:2;-webkit-column-count:2'><b>Count</b><br>Total meshes: "+e.meshes.length+"<br>Total lights: "+e.lights.length+"<br>Total vertices: "+e.getTotalVertices()+"<br>Total materials: "+e.materials.length+"<br>Total textures: "+e.textures.length+"<br>Active meshes: "+e.getActiveMeshes().length+"<br>Active indices: "+e.getActiveIndices()+"<br>Active bones: "+e.getActiveBones()+"<br>Active particles: "+e.getActiveParticles()+"<br><b>Draw calls: "+i.drawCalls+"</b><br><br><b>Duration</b><br>Meshes selection:</i> "+t.Tools.Format(e.getEvaluateActiveMeshesDuration())+" ms<br>Render Targets: "+t.Tools.Format(e.getRenderTargetsDuration())+" ms<br>Particles: "+t.Tools.Format(e.getParticlesDuration())+" ms<br>Sprites: "+t.Tools.Format(e.getSpritesDuration())+" ms<br><br>Render: <b>"+t.Tools.Format(e.getRenderDuration())+" ms</b><br>Frame: "+t.Tools.Format(e.getLastFrameDuration())+" ms<br>Potential FPS: "+t.Tools.Format(1e3/e.getLastFrameDuration(),0)+"<br>Resolution: "+i.getRenderWidth()+"x"+i.getRenderHeight()+"<br><br></div><div style='column-count: 2;-moz-column-count:2;-webkit-column-count:2'><b>Extensions</b><br>Std derivatives: "+(i.getCaps().standardDerivatives?"Yes":"No")+"<br>Compressed textures: "+(i.getCaps().s3tc?"Yes":"No")+"<br>Hardware instances: "+(i.getCaps().instancedArrays?"Yes":"No")+"<br>Texture float: "+(i.getCaps().textureFloat?"Yes":"No")+"<br><br>32bits indices: "+(i.getCaps().uintIndices?"Yes":"No")+"<br>Fragment depth: "+(i.getCaps().fragmentDepthSupported?"Yes":"No")+"<br>High precision shaders: "+(i.getCaps().highPrecisionShaderSupported?"Yes":"No")+"<br>Draw buffers: "+(i.getCaps().drawBuffersExtension?"Yes":"No")+"<br></div><br><div style='column-count: 2;-moz-column-count:2;-webkit-column-count:2'><b>Caps.</b><br>Stencil: "+(i.isStencilEnable?"Enabled":"Disabled")+"<br>Max textures units: "+i.getCaps().maxTexturesImageUnits+"<br>Max textures size: "+i.getCaps().maxTextureSize+"<br>Max anisotropy: "+i.getCaps().maxAnisotropy+"<br><b>Info</b><br>WebGL feature level: "+i.webGLVersion+"<br>"+r.version+"<br></div><br>"+r.renderer+"<br>",this.customStatsFunction&&(this._statsSubsetDiv.innerHTML+=this.customStatsFunction())},e}();t.DebugLayer=e}(r||(r={}));var r;!function(t){var e=function(e){function i(i,r,n,s,o){var a=this;void 0===s&&(s=null),e.call(this,r.getEngine(),i),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.gaussianBlurHPostProcesses=[],this.gaussianBlurVPostProcesses=[],this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.depthOfFieldPostProcess=null,this.brightThreshold=1,this.blurWidth=2,this.gaussianCoefficient=.25,this.gaussianMean=1,this.gaussianStandardDeviation=1,this.exposure=1,this.lensTexture=null,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.animations=[],this._depthRenderer=null,this._depthOfFieldEnabled=!0,this._lensFlareEnabled=!0,this._scene=r,this.originalPostProcess=s?s:new t.PostProcess("HDRPass","standard",[],[],n,null,t.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),!0,"#define PASS_POST_PROCESS",t.Engine.TEXTURETYPE_FLOAT),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),"HDRPassPostProcess",function(){return a.originalPostProcess},!0)),this._createDownSampleX4PostProcess(r,n/2),this._createBrightPassPostProcess(r,n/2),this._createGaussianBlurPostProcesses(r,n/2,0),this._createGaussianBlurPostProcesses(r,n/4,1),this._createGaussianBlurPostProcesses(r,n/8,2),this._createGaussianBlurPostProcesses(r,n/16,3),this._createTextureAdderPostProcess(r,n),this.textureAdderFinalPostProcess=new t.PostProcess("HDRDepthOfFieldSource","standard",[],[],n,null,t.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),!0,"#define PASS_POST_PROCESS",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new t.PostProcessRenderEffect(r.getEngine(),"HDRDepthOfFieldSource",function(){return a.textureAdderFinalPostProcess},!0)),this._createLensFlarePostProcess(r,n),this._createGaussianBlurPostProcesses(r,n/2,5),this._createDepthOfFieldPostProcess(r,n),r.postProcessRenderPipelineManager.addPipeline(this),null!==o&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,o),this.LensFlareEnabled=!1,this.DepthOfFieldEnabled=!1}return o(i,e),Object.defineProperty(i.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(t){var e=this.gaussianBlurHPostProcesses.length-1;t&&!this._depthOfFieldEnabled?(this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurH"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurV"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRDepthOfField",this._scene.cameras),this._depthRenderer=this._scene.enableDepthRenderer()):!t&&this._depthOfFieldEnabled&&(this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurH"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurV"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRDepthOfField",this._scene.cameras)),this._depthOfFieldEnabled=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(t){var e=this.gaussianBlurHPostProcesses.length-2;t&&!this._lensFlareEnabled?(this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRLensFlare",this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRLensFlareShift",this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurH"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurV"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRLensFlareCompose",this._scene.cameras)):!t&&this._lensFlareEnabled&&(this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRLensFlare",this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRLensFlareShift",this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurH"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurV"+e,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRLensFlareCompose",this._scene.cameras)),this._lensFlareEnabled=t},enumerable:!0,configurable:!0}),i.prototype._createDownSampleX4PostProcess=function(e,i){var r=this,n=new Array(32);this.downSampleX4PostProcess=new t.PostProcess("HDRDownSampleX4","standard",["dsOffsets"],[],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.downSampleX4PostProcess.onApply=function(t){for(var e=0,i=-2;i<2;i++)for(var s=-2;s<2;s++)n[e]=(i+.5)*(1/r.downSampleX4PostProcess.width),n[e+1]=(s+.5)*(1/r.downSampleX4PostProcess.height),e+=2;t.setArray2("dsOffsets",n)},this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRDownSampleX4",function(){return r.downSampleX4PostProcess},!0))},i.prototype._createBrightPassPostProcess=function(e,i){var r=this,n=new Array(8);this.brightPassPostProcess=new t.PostProcess("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.brightPassPostProcess.onApply=function(t){var e=1/r.brightPassPostProcess.width,i=1/r.brightPassPostProcess.height;n[0]=-.5*e,n[1]=.5*i,n[2]=.5*e,n[3]=.5*i,n[4]=-.5*e,n[5]=-.5*i,n[6]=.5*e,n[7]=-.5*i,t.setArray2("dsOffsets",n),t.setFloat("brightThreshold",r.brightThreshold)},this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRBrightPass",function(){return r.brightPassPostProcess},!0))},i.prototype._createGaussianBlurPostProcesses=function(e,i,r){var n=this,s=new Array(9),o=new Array(9),a=["blurOffsets","blurWeights","blurWidth"],h=function(t){return function(i){for(var r=0,a=0;a<9;a++)r=(a-4)/4,o[a]=n.gaussianCoefficient*(1/Math.sqrt(2*Math.PI*n.gaussianStandardDeviation))*Math.exp(-((r-n.gaussianMean)*(r-n.gaussianMean))/(2*n.gaussianStandardDeviation*n.gaussianStandardDeviation));for(var h={width:e.getEngine().getRenderWidth(),height:e.getEngine().getRenderHeight()},a=0;a<9;a++){var l=(a-4)*(1/(t===!0?h.height:h.width));s[a]=l}i.setArray("blurOffsets",s),i.setArray("blurWeights",o),i.setFloat("blurWidth",n.blurWidth)}},l=new t.PostProcess("HDRGaussianBlurH"+i,"standard",a,[],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define GAUSSIAN_BLUR_H",t.Engine.TEXTURETYPE_UNSIGNED_INT);l.onApply=h(!1);var c=new t.PostProcess("HDRGaussianBlurV"+i,"standard",a,[],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define GAUSSIAN_BLUR_V",t.Engine.TEXTURETYPE_UNSIGNED_INT);c.onApply=h(!0),this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRGaussianBlurH"+r,function(){return l},!0)),this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRGaussianBlurV"+r,function(){return c},!0)),this.gaussianBlurHPostProcesses.push(l),this.gaussianBlurVPostProcesses.push(c)},i.prototype._createTextureAdderPostProcess=function(e,i){var r=this;this.gaussianBlurVPostProcesses[3];this.textureAdderPostProcess=new t.PostProcess("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.textureAdderPostProcess.onApply=function(t){t.setTextureFromPostProcess("otherSampler",r.originalPostProcess),t.setTexture("lensSampler",r.lensTexture),t.setFloat("exposure",r.exposure)},this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRTextureAdder",function(){return r.textureAdderPostProcess},!0))},i.prototype._createLensFlarePostProcess=function(e,i){var r=this;this.lensFlarePostProcess=new t.PostProcess("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],i/2,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!0,"#define LENS_FLARE",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRLensFlare",function(){return r.lensFlarePostProcess},!1)),this._createGaussianBlurPostProcesses(e,i/4,4),this.lensFlareComposePostProcess=new t.PostProcess("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRLensFlareCompose",function(){return r.lensFlareComposePostProcess},!1));var n=new t.Vector2(0,0);this.lensFlarePostProcess.onApply=function(t){t.setTextureFromPostProcess("textureSampler",r.gaussianBlurHPostProcesses[0]),t.setTexture("lensColorSampler",r.lensColorTexture),t.setFloat("strength",r.lensFlareStrength),t.setFloat("ghostDispersal",r.lensFlareGhostDispersal),t.setFloat("haloWidth",r.lensFlareHaloWidth),n.x=r.lensFlarePostProcess.width,n.y=r.lensFlarePostProcess.height,t.setVector2("resolution",n),t.setFloat("distortionStrength",r.lensFlareDistortionStrength)};var s=t.Matrix.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),o=t.Matrix.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(e){e.setTextureFromPostProcess("otherSampler",r.textureAdderFinalPostProcess),e.setTexture("lensDirtSampler",r.lensFlareDirtTexture),e.setTexture("lensStarSampler",r.lensStarTexture);var i=r._scene.activeCamera.getViewMatrix().getRow(0),n=r._scene.activeCamera.getViewMatrix().getRow(2),a=t.Vector3.Dot(i.toVector3(),new t.Vector3(1,0,0))+t.Vector3.Dot(n.toVector3(),new t.Vector3(0,0,1));a*=4;var h=t.Matrix.FromValues(.5*Math.cos(a),-Math.sin(a),0,0,Math.sin(a),.5*Math.cos(a),0,0,0,0,1,0,0,0,0,1),l=o.multiply(h).multiply(s);e.setMatrix("lensStarMatrix",l)}},i.prototype._createDepthOfFieldPostProcess=function(e,i){var r=this;this.depthOfFieldPostProcess=new t.PostProcess("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],i,null,t.Texture.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",t.Engine.TEXTURETYPE_UNSIGNED_INT),this.depthOfFieldPostProcess.onApply=function(t){t.setTextureFromPostProcess("otherSampler",r.textureAdderFinalPostProcess),t.setTexture("depthSampler",r._depthRenderer.getDepthMap()),t.setFloat("distance",r.depthOfFieldDistance)},this.addEffect(new t.PostProcessRenderEffect(e.getEngine(),"HDRDepthOfField",function(){return r.depthOfFieldPostProcess},!0))},i.prototype.dispose=function(){for(var t=0;t<this._scene.cameras.length;t++){var i=this._scene.cameras[t];this.originalPostProcess.dispose(i),this.downSampleX4PostProcess.dispose(i),this.brightPassPostProcess.dispose(i),this.textureAdderPostProcess.dispose(i);for(var r=0;r<this.gaussianBlurHPostProcesses.length;r++)this.gaussianBlurHPostProcesses[r].dispose(i);for(var r=0;r<this.gaussianBlurVPostProcesses.length;r++)this.gaussianBlurVPostProcesses[r].dispose(i);this.textureAdderFinalPostProcess.dispose(i),this.lensFlarePostProcess.dispose(i),this.lensFlareComposePostProcess.dispose(i),this.depthOfFieldPostProcess.dispose(i)}this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),e.prototype.dispose.call(this)},i}(t.PostProcessRenderPipeline);t.StandardRenderingPipeline=e}(r||(r={})),r.Effect.ShadersStore={anaglyphPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}",blackAndWhitePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\nfloat luminance=dot(texture2D(textureSampler,vUV).rgb,vec3(0.3,0.59,0.11));\ngl_FragColor=vec4(luminance,luminance,luminance,1.0);\n}",blurPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\nbaseColor+=texture2D(textureSampler,start+texelOffset)*weights[i];\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",chromaticAberrationPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float chromatic_aberration;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\nif (chromatic_aberration>0.0) {\n\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*radius*17.0/screen_width;\nfloat ref_shiftY=chromatic_aberration*radius*17.0/screen_height;\n\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\n}\ngl_FragColor=original;\n}",colorPixelShader:"uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}",colorVertexShader:"\nattribute vec3 position;\n\nuniform mat4 worldViewProjection;\nvoid main(void) {\ngl_Position=worldViewProjection*vec4(position,1.0);\n}",colorCorrectionPixelShader:"\nuniform sampler2D textureSampler; \nuniform sampler2D colorTable; \n\nvarying vec2 vUV;\n\nconst float SLICE_COUNT=16.0; \n\nvec4 sampleAs3DTexture(sampler2D texture,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(texture,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(texture,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}",convolutionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}",defaultPixelShader:"#ifdef BUMP\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define RECIPROCAL_PI2 0.15915494\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<helperFunctions>\n\n#include<lightFragmentDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform sampler2D diffuseSampler;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform sampler2D ambientSampler;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nvarying vec2 vOpacityUV;\nuniform sampler2D opacitySampler;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform sampler2D lightmapSampler;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform sampler2D specularSampler;\n#endif\n\n#include<fresnelFunction>\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#endif\n#include<reflectionFunction>\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef CAMERACOLORGRADING\n#include<colorGradingDefinition> \n#include<colorGrading>\n#endif\n#ifdef CAMERACOLORCURVES\n#include<colorCurvesDefinition>\n#include<colorCurves>\n#endif\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\n\nfloat alpha=vDiffuseColor.a;\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\n#include<bumpFragment>\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#ifdef VERTEXCOLOR\nbaseColor.rgb*=vColor.rgb;\n#endif\n\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\n\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\n\nvec3 refractionColor=vec3(0.,0.,0.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0)\n{\nrefractionColor=textureCube(refractionCubeSampler,refractionVector).rgb*vRefractionInfos.x;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords).rgb*vRefractionInfos.x;\n#endif\n#endif\n\nvec3 reflectionColor=vec3(0.,0.,0.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias).rgb*vReflectionInfos.x;\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW).rgb*vReflectionInfos.x;\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords).rgb*vReflectionInfos.x;\n#endif\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+emissiveColor+refractionColor,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+refractionColor,alpha);\n#endif\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor;\n#else\ncolor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef CAMERACOLORGRADING\ncolor=colorGrades(color);\n#endif\n#ifdef CAMERACOLORCURVES\ncolor.rgb=applyColorCurves(color.rgb);\n#endif\ngl_FragColor=color;\n}",defaultVertexShader:"\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nvarying vec2 vOpacityUV;\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#include<pointCloudVertexDeclaration>\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<shadowsVertexDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef DIFFUSE\nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef AMBIENT\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef OPACITY\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef EMISSIVE\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef LIGHTMAP\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nif (vSpecularInfos.x == 0.)\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef BUMP\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#include<pointCloudVertex>\n#include<logDepthVertex>\n}",depthPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nuniform float far;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nfloat depth=(gl_FragCoord.z/gl_FragCoord.w)/far;\ngl_FragColor=vec4(depth,depth*depth,0.0,1.0);\n}",depthVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",depthBoxBlurPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}",depthOfFieldPixelShader:"\n\n\n\n\nuniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\n\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\n\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\n\nuniform float near;\nuniform float far;\n\nvarying vec2 vUV;\n\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \n\nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\n\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\n\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion == 0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\n\nfloat sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {\n\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\n\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\n\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nif (size == 0.0) { return col; }\n\n\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \n\nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\n\n\n\n\nreturn col;\n}\nvoid main(void)\n{\n\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \n\n\nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\n\nif (dof_enabled == false || coc<0.07) { coc=0.0; }\n\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\n\nfloat blur_amount=max(edge_blur_amount,coc);\n\nif (blur_amount == 0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\n\ngl_FragColor=getBlurColor(blur_amount*1.7);\n\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\n\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\n\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n",displayPassPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}",filterPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}",fxaaPixelShader:"#define FXAA_REDUCE_MIN (1.0/128.0)\n#define FXAA_REDUCE_MUL (1.0/8.0)\n#define FXAA_SPAN_MAX 8.0\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvoid main(){\nvec2 localTexelSize=texelSize;\nvec4 rgbNW=texture2D(textureSampler,(vUV+vec2(-1.0,-1.0)*localTexelSize));\nvec4 rgbNE=texture2D(textureSampler,(vUV+vec2(1.0,-1.0)*localTexelSize));\nvec4 rgbSW=texture2D(textureSampler,(vUV+vec2(-1.0,1.0)*localTexelSize));\nvec4 rgbSE=texture2D(textureSampler,(vUV+vec2(1.0,1.0)*localTexelSize));\nvec4 rgbM=texture2D(textureSampler,vUV);\nvec4 luma=vec4(0.299,0.587,0.114,1.0);\nfloat lumaNW=dot(rgbNW,luma);\nfloat lumaNE=dot(rgbNE,luma);\nfloat lumaSW=dot(rgbSW,luma);\nfloat lumaSE=dot(rgbSE,luma);\nfloat lumaM=dot(rgbM,luma);\nfloat lumaMin=min(lumaM,min(min(lumaNW,lumaNE),min(lumaSW,lumaSE)));\nfloat lumaMax=max(lumaM,max(max(lumaNW,lumaNE),max(lumaSW,lumaSE)));\nvec2 dir=vec2(-((lumaNW+lumaNE)-(lumaSW+lumaSE)),((lumaNW+lumaSW)-(lumaNE+lumaSE)));\nfloat dirReduce=max(\n(lumaNW+lumaNE+lumaSW+lumaSE)*(0.25*FXAA_REDUCE_MUL),\nFXAA_REDUCE_MIN);\nfloat rcpDirMin=1.0/(min(abs(dir.x),abs(dir.y))+dirReduce);\ndir=min(vec2(FXAA_SPAN_MAX,FXAA_SPAN_MAX),\nmax(vec2(-FXAA_SPAN_MAX,-FXAA_SPAN_MAX),\ndir*rcpDirMin))*localTexelSize;\nvec4 rgbA=0.5*(\ntexture2D(textureSampler,vUV+dir*(1.0/3.0-0.5)) +\ntexture2D(textureSampler,vUV+dir*(2.0/3.0-0.5)));\nvec4 rgbB=rgbA*0.5+0.25*(\ntexture2D(textureSampler,vUV+dir*-0.5) +\ntexture2D(textureSampler,vUV+dir*0.5));\nfloat lumaB=dot(rgbB,luma);\nif ((lumaB<lumaMin) || (lumaB>lumaMax)) {\ngl_FragColor=rgbA;\n}\nelse {\ngl_FragColor=rgbB;\n}\n}",glowBlurPostProcessPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\n\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\n\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",glowMapGenerationPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\nuniform vec4 color;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUVDiffuse).a<0.4)\ndiscard;\n#endif\n#ifdef EMISSIVE\ngl_FragColor=texture2D(emissiveSampler,vUVEmissive);\n#else\ngl_FragColor=color;\n#endif\n}",glowMapGenerationVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(position,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",glowMapMergePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float offset;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\nbaseColor.a=abs(offset-baseColor.a);\ngl_FragColor=baseColor;\n}",glowMapMergeVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) {\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",hdrPixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(GAUSSIAN_BLUR_H) || defined(GAUSSIAN_BLUR_V)\nuniform float blurOffsets[9];\nuniform float blurWeights[9];\nuniform float multiplier;\nvoid main(void) {\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfor (int i=0; i<9; i++) {\n#ifdef GAUSSIAN_BLUR_H\ncolor+=(texture2D(textureSampler,vUV+vec2(blurOffsets[i]*multiplier,0.0))*blurWeights[i]);\n#else\ncolor+=(texture2D(textureSampler,vUV+vec2(0.0,blurOffsets[i]*multiplier))*blurWeights[i]);\n#endif\n}\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nvoid main() {\nvec4 sum=texture2D(textureSampler,vUV)+texture2D(otherSampler,vUV);\nsum.a=clamp(sum.a,0.0,1.0);\ngl_FragColor=sum;\n}\n#endif\n#if defined(LUMINANCE_GENERATOR)\nuniform vec2 lumOffsets[4];\nvoid main() {\nfloat average=0.0;\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfloat maximum=-1e20;\nfor (int i=0; i<4; i++) {\ncolor=texture2D(textureSampler,vUV+lumOffsets[i]);\nfloat GreyValue=length(color.rgb);\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLE\nvec4 pack(float value) {\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(value*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvoid main() {\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++) {\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifndef FINAL_DOWN_SAMPLE\ngl_FragColor=vec4(average,average,0.0,1.0);\n#else\ngl_FragColor=pack(average);\n#endif\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main() {\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main() {\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(HDR)\nuniform sampler2D otherSampler;\nuniform float exposure;\nuniform float avgLuminance;\nvoid main() {\nvec4 color=texture2D(textureSampler,vUV)+texture2D(otherSampler,vUV);\nvec4 adjustedColor=color/avgLuminance*exposure;\ncolor=adjustedColor;\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n",layerPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n}",layerVertexShader:"\nattribute vec2 position;\n\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n}",lensFlarePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n}",lensFlareVertexShader:"\nattribute vec2 position;\n\nuniform mat4 viewportMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n}",lensHighlightsPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\n\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\n\nif (gain == -1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\n\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n\n}",linePixelShader:"uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}",lineVertexShader:"\nattribute vec3 position;\nattribute vec4 normal;\n\nuniform mat4 worldViewProjection;\nuniform float width;\nuniform float aspectRatio;\nvoid main(void) {\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n}",outlinePixelShader:"uniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void) {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragColor=color;\n}",outlineVertexShader:"\nattribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\nvec3 offsetPosition=position+normal*offset;\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n",particlesPixelShader:"\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\nvoid main(void) {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif\nvec4 baseColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=(baseColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n}",particlesVertexShader:"\nattribute vec3 position;\nattribute vec4 color;\nattribute vec4 options;\n\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nvarying float fClipDistance;\n#endif\nvoid main(void) { \nvec3 viewPos=(view*vec4(position,1.0)).xyz; \nvec3 cornerPos;\nfloat size=options.y;\nfloat angle=options.x;\nvec2 offset=options.zw;\ncornerPos=vec3(offset.x-0.5,offset.y-0.5,0.)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\nvUV=offset;\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*vec4(viewPos,1.0);\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n}",passPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}",pbrPixelShader:"#ifdef BUMP\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision highp float;\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\n\nuniform vec4 vLightingIntensity;\nuniform vec4 vCameraInfos;\n#ifdef OVERLOADEDVALUES\nuniform vec4 vOverloadedIntensity;\nuniform vec3 vOverloadedAmbient;\nuniform vec3 vOverloadedAlbedo;\nuniform vec3 vOverloadedReflectivity;\nuniform vec3 vOverloadedEmissive;\nuniform vec3 vOverloadedReflection;\nuniform vec3 vOverloadedMicroSurface;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nuniform vec4 vOverloadedShadowIntensity;\n#endif\n#if defined(REFLECTION) || defined(REFRACTION)\nuniform vec2 vMicrosurfaceTextureLods;\n#endif\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<lightFragmentDeclaration>[0..maxSimultaneousLights]\n\n#ifdef ALBEDO\nvarying vec2 vAlbedoUV;\nuniform sampler2D albedoSampler;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform sampler2D ambientSampler;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY \nvarying vec2 vOpacityUV;\nuniform sampler2D opacitySampler;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform sampler2D lightmapSampler;\n#endif\n#if defined(REFLECTIVITY) || defined(METALLICWORKFLOW) \nvarying vec2 vReflectivityUV;\nuniform vec2 vReflectivityInfos;\nuniform sampler2D reflectivitySampler;\n#endif\n\n#include<fresnelFunction>\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\nuniform mat4 refractionMatrix;\n#endif\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifdef CAMERACOLORGRADING\n#include<colorGradingDefinition>\n#endif\n#ifdef CAMERACOLORCURVES\n#include<colorCurvesDefinition>\n#endif\n\n#include<pbrShadowFunctions>\n#include<pbrFunctions>\n#ifdef CAMERACOLORGRADING\n#include<colorGrading>\n#endif\n#ifdef CAMERACOLORCURVES\n#include<colorCurves>\n#endif\n#include<harmonicsFunctions>\n#include<pbrLightFunctions>\n#include<helperFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\n#include<bumpFragment>\n\nvec4 surfaceAlbedo=vec4(1.,1.,1.,1.);\nvec3 surfaceAlbedoContribution=vAlbedoColor.rgb;\n\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\nsurfaceAlbedo=texture2D(albedoSampler,vAlbedoUV+uvOffset);\nsurfaceAlbedo=vec4(toLinearSpace(surfaceAlbedo.rgb),surfaceAlbedo.a);\n#ifndef LINKREFRACTIONTOTRANSPARENCY\n#ifdef ALPHATEST\nif (surfaceAlbedo.a<0.4)\ndiscard;\n#endif\n#endif\n#ifdef ALPHAFROMALBEDO\nalpha*=surfaceAlbedo.a;\n#endif\nsurfaceAlbedo.rgb*=vAlbedoInfos.y;\n#else\n\nsurfaceAlbedo.rgb=surfaceAlbedoContribution;\nsurfaceAlbedoContribution=vec3(1.,1.,1.);\n#endif\n#ifdef VERTEXCOLOR\nsurfaceAlbedo.rgb*=vColor.rgb;\n#endif\n#ifdef OVERLOADEDVALUES\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,vOverloadedAlbedo,vOverloadedIntensity.y);\n#endif\n\nvec3 ambientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nambientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\nambientColor=vec3(1.,1.,1.)-((vec3(1.,1.,1.)-ambientColor)*vAmbientInfos.z);\n#ifdef OVERLOADEDVALUES\nambientColor.rgb=mix(ambientColor.rgb,vOverloadedAmbient,vOverloadedIntensity.x);\n#endif\n#endif\n\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef OVERLOADEDVALUES\nsurfaceReflectivityColor.rgb=mix(surfaceReflectivityColor.rgb,vOverloadedReflectivity,vOverloadedIntensity.z);\n#endif\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nsurfaceReflectivityColor=surfaceReflectivityColorMap.rgb;\nsurfaceReflectivityColor=toLinearSpace(surfaceReflectivityColor);\n#ifdef OVERLOADEDVALUES\nsurfaceReflectivityColor=mix(surfaceReflectivityColor,vOverloadedReflectivity,vOverloadedIntensity.z);\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface=surfaceReflectivityColorMap.a;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#endif\n#endif\n#ifdef METALLICWORKFLOW\nvec4 surfaceMetallicColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\n\nfloat metallic=surfaceMetallicColorMap.r; \n\nvec3 baseColor=surfaceAlbedo.rgb;\n\nsurfaceAlbedo.rgb*=(1.0-metallic);\n\n\nconst vec3 DefaultSpecularReflectanceDielectric=vec3(0.04,0.04,0.04);\n\nsurfaceReflectivityColor=mix(DefaultSpecularReflectanceDielectric,baseColor,metallic);\n#ifdef OVERLOADEDVALUES\nsurfaceReflectivityColor=mix(surfaceReflectivityColor,vOverloadedReflectivity,vOverloadedIntensity.z);\n#endif\n#ifdef METALLICROUGHNESSGSTOREINALPHA\nmicroSurface=1.0-surfaceMetallicColorMap.a;\n#else\n#ifdef METALLICROUGHNESSGSTOREINGREEN\nmicroSurface=1.0-surfaceMetallicColorMap.g;\n#endif\n#endif\n#endif\n#ifdef OVERLOADEDVALUES\nmicroSurface=mix(microSurface,vOverloadedMicroSurface.x,vOverloadedMicroSurface.y);\n#endif\n\nfloat NdotV=max(0.00000000001,dot(normalW,viewDirectionW));\n\nmicroSurface=clamp(microSurface,0.,1.)*0.98;\n\nfloat roughness=clamp(1.-microSurface,0.000001,1.0);\n\nvec3 lightDiffuseContribution=vec3(0.,0.,0.);\n#ifdef OVERLOADEDSHADOWVALUES\nvec3 shadowedOnlyLightDiffuseContribution=vec3(1.,1.,1.);\n#endif\n#ifdef SPECULARTERM\nvec3 lightSpecularContribution=vec3(0.,0.,0.);\n#endif\nfloat notShadowLevel=1.; \n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\nfloat NdotL=-1.;\nlightingInfo info;\n\nfloat reflectance=max(max(surfaceReflectivityColor.r,surfaceReflectivityColor.g),surfaceReflectivityColor.b);\n\n\nfloat reflectance90=clamp(reflectance*25.0,0.0,1.0);\nvec3 specularEnvironmentR0=surfaceReflectivityColor.rgb;\nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0)*reflectance90;\n#include<pbrLightFunctionsCall>[0..maxSimultaneousLights]\n#ifdef SPECULARTERM\nlightSpecularContribution*=vLightingIntensity.w;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 surfaceRefractionColor=vec3(0.,0.,0.);\n\n#ifdef LODBASEDMICROSFURACE\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\n#endif\n#ifdef REFRACTION\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFRACTION\nfloat lodRefraction=getMipMapIndexFromAverageSlopeWithPMREM(vMicrosurfaceTextureLods.y,alphaG);\n#else\nfloat lodRefraction=getMipMapIndexFromAverageSlope(vMicrosurfaceTextureLods.y,alphaG);\n#endif\n#else\nfloat biasRefraction=(vMicrosurfaceTextureLods.y+2.)*(1.0-microSurface);\n#endif\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0)\n{\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFRACTION\n\nif ((vMicrosurfaceTextureLods.y-lodRefraction)>4.0)\n{\n\nfloat scaleRefraction=1.-exp2(lodRefraction)/exp2(vMicrosurfaceTextureLods.y); \nfloat maxRefraction=max(max(abs(refractionVector.x),abs(refractionVector.y)),abs(refractionVector.z));\nif (abs(refractionVector.x) != maxRefraction) refractionVector.x*=scaleRefraction;\nif (abs(refractionVector.y) != maxRefraction) refractionVector.y*=scaleRefraction;\nif (abs(refractionVector.z) != maxRefraction) refractionVector.z*=scaleRefraction;\n}\n#endif\nsurfaceRefractionColor=textureCubeLodEXT(refractionCubeSampler,refractionVector,lodRefraction).rgb*vRefractionInfos.x;\n#else\nsurfaceRefractionColor=textureCube(refractionCubeSampler,refractionVector,biasRefraction).rgb*vRefractionInfos.x;\n#endif\n}\n#ifndef REFRACTIONMAPINLINEARSPACE\nsurfaceRefractionColor=toLinearSpace(surfaceRefractionColor.rgb);\n#endif\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#ifdef LODBASEDMICROSFURACE\nsurfaceRefractionColor=texture2DLodEXT(refraction2DSampler,refractionCoords,lodRefraction).rgb*vRefractionInfos.x;\n#else\nsurfaceRefractionColor=texture2D(refraction2DSampler,refractionCoords,biasRefraction).rgb*vRefractionInfos.x;\n#endif \nsurfaceRefractionColor=toLinearSpace(surfaceRefractionColor.rgb);\n#endif\n#endif\n\nvec3 environmentRadiance=vReflectionColor.rgb;\nvec3 environmentIrradiance=vReflectionColor.rgb;\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFLECTION\nfloat lodReflection=getMipMapIndexFromAverageSlopeWithPMREM(vMicrosurfaceTextureLods.x,alphaG);\n#else\nfloat lodReflection=getMipMapIndexFromAverageSlope(vMicrosurfaceTextureLods.x,alphaG);\n#endif\n#else\nfloat biasReflection=(vMicrosurfaceTextureLods.x+2.)*(1.0-microSurface);\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFLECTION\n\nif ((vMicrosurfaceTextureLods.y-lodReflection)>4.0)\n{\n\nfloat scaleReflection=1.-exp2(lodReflection)/exp2(vMicrosurfaceTextureLods.x); \nfloat maxReflection=max(max(abs(vReflectionUVW.x),abs(vReflectionUVW.y)),abs(vReflectionUVW.z));\nif (abs(vReflectionUVW.x) != maxReflection) vReflectionUVW.x*=scaleReflection;\nif (abs(vReflectionUVW.y) != maxReflection) vReflectionUVW.y*=scaleReflection;\nif (abs(vReflectionUVW.z) != maxReflection) vReflectionUVW.z*=scaleReflection;\n}\n#endif\nenvironmentRadiance=textureCubeLodEXT(reflectionCubeSampler,vReflectionUVW,lodReflection).rgb*vReflectionInfos.x;\n#else\nenvironmentRadiance=textureCube(reflectionCubeSampler,vReflectionUVW,biasReflection).rgb*vReflectionInfos.x;\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifndef REFLECTIONMAP_SKYBOX\nvec3 normalEnvironmentSpace=(reflectionMatrix*vec4(normalW,1)).xyz;\nenvironmentIrradiance=EnvironmentIrradiance(normalEnvironmentSpace);\n#endif\n#else\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\nenvironmentIrradiance=textureCube(reflectionCubeSampler,normalW,20.).rgb*vReflectionInfos.x;\nenvironmentIrradiance=toLinearSpace(environmentIrradiance.rgb);\nenvironmentIrradiance*=0.2; \n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\n#ifdef LODBASEDMICROSFURACE\nenvironmentRadiance=texture2DLodEXT(reflection2DSampler,coords,lodReflection).rgb*vReflectionInfos.x;\n#else\nenvironmentRadiance=texture2D(reflection2DSampler,coords,biasReflection).rgb*vReflectionInfos.x;\n#endif\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\nenvironmentIrradiance=texture2D(reflection2DSampler,coords,20.).rgb*vReflectionInfos.x;\nenvironmentIrradiance=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\n#ifdef OVERLOADEDVALUES\nenvironmentIrradiance=mix(environmentIrradiance,vOverloadedReflection,vOverloadedMicroSurface.z);\nenvironmentRadiance=mix(environmentRadiance,vOverloadedReflection,vOverloadedMicroSurface.z);\n#endif\nenvironmentRadiance*=vLightingIntensity.z;\nenvironmentIrradiance*=vLightingIntensity.z;\n\nvec3 specularEnvironmentReflectance=FresnelSchlickEnvironmentGGX(clamp(NdotV,0.,1.),specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n\nvec3 refractance=vec3(0.0,0.0,0.0);\n#ifdef REFRACTION\nvec3 transmission=vec3(1.0,1.0,1.0);\n#ifdef LINKREFRACTIONTOTRANSPARENCY\n\ntransmission*=(1.0-alpha);\n\n\nvec3 mixedAlbedo=surfaceAlbedoContribution.rgb*surfaceAlbedo.rgb;\nfloat maxChannel=max(max(mixedAlbedo.r,mixedAlbedo.g),mixedAlbedo.b);\nvec3 tint=clamp(maxChannel*mixedAlbedo,0.0,1.0);\n\nsurfaceAlbedoContribution*=alpha;\n\nenvironmentIrradiance*=alpha;\n\nsurfaceRefractionColor*=tint;\n\nalpha=1.0;\n#endif\n\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\nspecularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,alpha);\n\ntransmission*=1.0-specularEnvironmentReflectance;\n\nrefractance=surfaceRefractionColor*transmission;\n#endif\n\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\nrefractance*=vLightingIntensity.z;\nenvironmentRadiance*=specularEnvironmentReflectance;\n\nvec3 surfaceEmissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\nsurfaceEmissiveColor=toLinearSpace(emissiveColorTex.rgb)*surfaceEmissiveColor*vEmissiveInfos.y;\n#endif\n#ifdef OVERLOADEDVALUES\nsurfaceEmissiveColor=mix(surfaceEmissiveColor,vOverloadedEmissive,vOverloadedIntensity.w);\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nsurfaceEmissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=max(lightDiffuseContribution*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#ifdef OVERLOADEDSHADOWVALUES\nshadowedOnlyLightDiffuseContribution=max(shadowedOnlyLightDiffuseContribution*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#endif\n#else\n#ifdef LINKEMISSIVEWITHALBEDO\nvec3 finalDiffuse=max((lightDiffuseContribution+surfaceEmissiveColor)*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#ifdef OVERLOADEDSHADOWVALUES\nshadowedOnlyLightDiffuseContribution=max((shadowedOnlyLightDiffuseContribution+surfaceEmissiveColor)*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#endif\n#else\nvec3 finalDiffuse=max(lightDiffuseContribution*surfaceAlbedoContribution+surfaceEmissiveColor+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#ifdef OVERLOADEDSHADOWVALUES\nshadowedOnlyLightDiffuseContribution=max(shadowedOnlyLightDiffuseContribution*surfaceAlbedoContribution+surfaceEmissiveColor+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#endif\n#endif\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nfinalDiffuse=mix(finalDiffuse,shadowedOnlyLightDiffuseContribution,(1.0-vOverloadedShadowIntensity.y));\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=lightSpecularContribution*surfaceReflectivityColor;\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+getLuminance(finalSpecular),0.,1.);\n#endif\n#ifdef RADIANCEOVERALPHA\nalpha=clamp(alpha+getLuminance(environmentRadiance),0.,1.);\n#endif\n\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 finalColor=vec4(finalDiffuse*ambientColor*vLightingIntensity.x+surfaceAlbedo.rgb*environmentIrradiance+finalSpecular*vLightingIntensity.x+environmentRadiance+surfaceEmissiveColor*vLightingIntensity.y+refractance,alpha);\n#else\nvec4 finalColor=vec4(finalDiffuse*ambientColor*vLightingIntensity.x+surfaceAlbedo.rgb*environmentIrradiance+finalSpecular*vLightingIntensity.x+environmentRadiance+refractance,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor;\n#else\nfinalColor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\nfinalColor=max(finalColor,0.0);\n#ifdef CAMERATONEMAP\nfinalColor.rgb=toneMaps(finalColor.rgb);\n#endif\nfinalColor.rgb=toGammaSpace(finalColor.rgb);\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#ifdef CAMERACONTRAST\nfinalColor=contrasts(finalColor);\n#endif\nfinalColor.rgb=clamp(finalColor.rgb,0.,1.);\n#ifdef CAMERACOLORGRADING\nfinalColor=colorGrades(finalColor);\n#endif\n#ifdef CAMERACOLORCURVES\nfinalColor.rgb=applyColorCurves(finalColor.rgb);\n#endif\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ngl_FragColor=finalColor;\n}",pbrVertexShader:"precision highp float;\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nvarying vec2 vAlbedoUV;\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform mat4 ambientMatrix;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY\nvarying vec2 vOpacityUV;\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(REFLECTIVITY) || defined(METALLICWORKFLOW) \nvarying vec2 vReflectivityUV;\nuniform vec2 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<shadowsVertexDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef ALBEDO\nif (vAlbedoInfos.x == 0.)\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef AMBIENT\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef OPACITY\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef EMISSIVE\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef LIGHTMAP\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(REFLECTIVITY) || defined(METALLICWORKFLOW) \nif (vReflectivityInfos.x == 0.)\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef BUMP\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n\n#include<logDepthVertex>\n}",postprocessVertexShader:"\nattribute vec2 position;\nuniform vec2 scale;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n}",proceduralVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",refractionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}",shadowMapPixelShader:"#ifndef FULLFLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n\nvec2 packHalf(float depth) \n{ \nconst vec2 bitOffset=vec2(1.0/255.,0.);\nvec2 color=vec2(depth,fract(depth*255.));\nreturn color-(color.yy*bitOffset);\n}\n#endif\nvarying vec4 vPosition;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef CUBEMAP\nuniform vec3 lightPosition;\nuniform vec2 depthValues;\n#endif\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef CUBEMAP\nvec3 directionToLight=vPosition.xyz-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\n#else\nfloat depth=vPosition.z/vPosition.w;\ndepth=depth*0.5+0.5;\n#endif\n#ifdef VSM\nfloat moment1=depth;\nfloat moment2=moment1*moment1;\n#ifndef FULLFLOAT\ngl_FragColor=vec4(packHalf(moment1),packHalf(moment2));\n#else\ngl_FragColor=vec4(moment1,moment2,1.0,1.0);\n#endif\n#else\n#ifndef FULLFLOAT\ngl_FragColor=pack(depth);\n#else\ngl_FragColor=vec4(depth,1.0,1.0,1.0);\n#endif\n#endif\n}",shadowMapVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(position,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",spritesPixelShader:"uniform bool alphaTest;\nvarying vec4 vColor;\n\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\nvec4 color=texture2D(diffuseSampler,vUV);\nif (alphaTest) \n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n}",spritesVertexShader:"\nattribute vec4 position;\nattribute vec4 options;\nattribute vec4 cellInfo;\nattribute vec4 color;\n\nuniform vec2 textureInfos;\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\nvoid main(void) { \nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=options.zw;\nvec2 uvScale=textureInfos.xy;\ncornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \n\nvColor=color;\n\nvec2 uvOffset=vec2(abs(offset.x-cellInfo.x),1.0-abs(offset.y-cellInfo.y));\nvUV=(uvOffset+cellInfo.zw)*uvScale;\n\n#ifdef FOG\nfFogDistance=viewPos.z;\n#endif\n}",ssaoPixelShader:"\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvoid main()\n{\nfloat texelsize=1.0/outSize;\nfloat compareDepth=texture2D(depthSampler,vUV).r;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=texture2D(depthSampler,samplePos).r;\nfloat weight=(1.0/(0.0001+abs(compareDepth-sampleDepth)));\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n}\n#endif\n",ssaoCombinePixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 ssaoColor=texture2D(textureSampler,vUV);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n}\n",standardPixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(GAUSSIAN_BLUR_H) || defined(GAUSSIAN_BLUR_V)\nuniform float blurOffsets[9];\nuniform float blurWeights[9];\nuniform float blurWidth;\nvoid main(void)\n{\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfor (int i=0; i<9; i++) {\n#ifdef GAUSSIAN_BLUR_H\ncolor+=(texture2D(textureSampler,vUV+vec2(blurOffsets[i]*blurWidth,0.0))*blurWeights[i]);\ncolor+=(texture2D(textureSampler,vUV-vec2(blurOffsets[i]*blurWidth,0.0))*blurWeights[i]);\n#else\ncolor+=(texture2D(textureSampler,vUV+vec2(0.0,blurOffsets[i]*blurWidth))*blurWeights[i]);\ncolor+=(texture2D(textureSampler,vUV-vec2(0.0,blurOffsets[i]*blurWidth))*blurWeights[i]);\n#endif\n}\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n",stereoscopicInterlacePixelShader:"const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\nvoid main(void)\n{\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else{\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}",tonemapPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}",volumetricLightScatteringPixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\nvoid main(void) {\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 sample=texture2D(lightScatteringSampler,tc)*0.4;\nsample*=illuminationDecay*weight;\ncolor+=sample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n}\n",volumetricLightScatteringPassPixelShader:"#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n",vrDistortionCorrectionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nelse{\ngl_FragColor=vec4(texture2D(textureSampler,tc).rgb,1.0);\n}\n}"},r.Effect.IncludesShadersStore={bonesDeclaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#endif",bonesVertex:"#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \nfinalWorld=finalWorld*influence;\n#endif",bumpFragment:"vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX)\nmat3 TBN=cotangent_frame(normalW*vBumpInfos.y,-viewDirectionW,vBumpUV);\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef BUMP\nnormalW=perturbNormal(viewDirectionW,TBN,vBumpUV+uvOffset);\n#endif",bumpFragmentFunctions:"#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec3 vBumpInfos;\nuniform sampler2D bumpSampler;\n\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv)\n{\n\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\n\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;\n\nfloat invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));\nreturn mat3(tangent*invmax,binormal*invmax,normal);\n}\nvec3 perturbNormal(vec3 viewDir,mat3 cotangentFrame,vec2 uv)\n{\nvec3 map=texture2D(bumpSampler,uv).xyz;\n#ifdef INVERTNORMALMAPX\nmap.x=1.0-map.x;\n#endif\n#ifdef INVERTNORMALMAPY\nmap.y=1.0-map.y;\n#endif\nmap=map*255./127.-128./127.;\nreturn normalize(cotangentFrame*map);\n}\n#ifdef PARALLAX\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\n\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\n\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,vBumpUV+vCurrOffset).w;\n\nif (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\n\nbreak;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\n\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n#endif",clipPlaneFragment:"#ifdef CLIPPLANE\nif (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif",clipPlaneFragmentDeclaration:"#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif",clipPlaneVertex:"#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif",clipPlaneVertexDeclaration:"#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif",colorCurves:"const vec3 HDTVRec709_RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\nvec3 applyColorCurves(vec3 original) {\nvec3 result=original;\n\n\n\nfloat luma=dot(result.rgb,HDTVRec709_RGBLuminanceCoefficients);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0,0.0),vec2(1.0,1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma,luma,luma),result.rgb,colorCurve.a);\nreturn result;\n}",colorCurvesDefinition:"uniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\nuniform vec4 vCameraColorCurveNegative;",colorGrading:"vec4 colorGrades(vec4 color) \n{ \n\nfloat sliceContinuous=color.z*vCameraColorGradingInfos.z;\nfloat sliceInteger=floor(sliceContinuous);\n\n\nfloat sliceFraction=sliceContinuous-sliceInteger; \n\nvec2 sliceUV=color.xy*vCameraColorGradingScaleOffset.xy+vCameraColorGradingScaleOffset.zw;\n\n\nsliceUV.x+=sliceInteger*vCameraColorGradingInfos.w;\nvec4 slice0Color=texture2D(cameraColorGrading2DSampler,sliceUV);\nsliceUV.x+=vCameraColorGradingInfos.w;\nvec4 slice1Color=texture2D(cameraColorGrading2DSampler,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\ncolor.rgb=mix(color.rgb,result,vCameraColorGradingInfos.x);\nreturn color;\n}",colorGradingDefinition:"uniform sampler2D cameraColorGrading2DSampler;\nuniform vec4 vCameraColorGradingInfos;\nuniform vec4 vCameraColorGradingScaleOffset;",fogFragment:"#ifdef FOG\nfloat fog=CalcFogFactor();\ncolor.rgb=fog*color.rgb+(1.0-fog)*vFogColor;\n#endif",fogFragmentDeclaration:"#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying float fFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nif (FOGMODE_LINEAR == vFogInfos.x)\n{\nfogCoeff=(fogEnd-fFogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fFogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2 == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fFogDistance*fFogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif",fogVertex:"#ifdef FOG\nfFogDistance=(view*worldPos).z;\n#endif",fogVertexDeclaration:"#ifdef FOG\nvarying float fFogDistance;\n#endif",fresnelFunction:"#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif",harmonicsFunctions:"#ifdef USESPHERICALFROMREFLECTIONMAP\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX;\nuniform vec3 vSphericalYY;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\nvec3 EnvironmentIrradiance(vec3 normal)\n{\n\n\n\nvec3 result =\nvSphericalX*normal.x +\nvSphericalY*normal.y +\nvSphericalZ*normal.z +\nvSphericalXX*normal.x*normal.x +\nvSphericalYY*normal.y*normal.y +\nvSphericalZZ*normal.z*normal.z +\nvSphericalYZ*normal.y*normal.z +\nvSphericalZX*normal.z*normal.x +\nvSphericalXY*normal.x*normal.y;\nreturn result.rgb;\n}\n#endif",helperFunctions:"mat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}",instancesDeclaration:"#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif",instancesVertex:"#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#else\nmat4 finalWorld=world;\n#endif",lightFragment:"#ifdef LIGHT{X}\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n\n#else\n#ifndef SPECULARTERM\nvec3 vLightSpecular{X}=vec3(0.);\n#endif\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,vLightData{X},vLightDirection{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,glossiness);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightGround{X},glossiness);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,glossiness);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWVSM{X}\nshadow=computeShadowWithVSM(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\n#ifdef SHADOWPCF{X}\n#if defined(POINTLIGHT{X})\nshadow=computeShadowWithPCFCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\nshadow=computeShadowWithPCF(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#endif\n#else\n#if defined(POINTLIGHT{X})\nshadow=computeShadowCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#else\nshadow=computeShadow(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#endif\n#endif\n#endif\n#else\nshadow=1.;\n#endif\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor;\n#endif\n#endif\n#else\ndiffuseBase+=info.diffuse*shadow;\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#endif\n#endif",lightFragmentDeclaration:"#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec3 vLightSpecular{X};\n#endif\n#ifdef SHADOW{X}\n#if defined(SPOTLIGHT{X}) || defined(DIRLIGHT{X})\nvarying vec4 vPositionFromLight{X};\nuniform sampler2D shadowSampler{X};\n#else\nuniform samplerCube shadowSampler{X};\n#endif\nuniform vec3 shadowsInfo{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\n#endif\n#ifdef HEMILIGHT{X}\nuniform vec3 vLightGround{X};\n#endif\n#endif",lightsFragmentFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w == 0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\n\nfloat cosAngle=max(0.,dot(-lightDirection.xyz,lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\n\nfloat ndl=max(0.,dot(vNormal,-lightDirection.xyz));\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW-lightDirection.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\n\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n",logDepthDeclaration:"#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif",logDepthFragment:"#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif",logDepthVertex:"#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif",pbrFunctions:"\n#define RECIPROCAL_PI2 0.15915494\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n\nconst float kPi=3.1415926535897932384626433832795;\nconst float kRougnhessToAlphaScale=0.1;\nconst float kRougnhessToAlphaOffset=0.29248125;\nfloat Square(float value)\n{\nreturn value*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,vec3(0.2126,0.7152,0.0722)),0.,1.);\n}\nfloat convertRoughnessToAverageSlope(float roughness)\n{\n\nconst float kMinimumVariance=0.0005;\nfloat alphaG=Square(roughness)+kMinimumVariance;\nreturn alphaG;\n}\n\nfloat getMipMapIndexFromAverageSlope(float maxMipLevel,float alpha)\n{\n\n\n\n\n\n\n\nfloat mip=kRougnhessToAlphaOffset+maxMipLevel+(maxMipLevel*kRougnhessToAlphaScale*log2(alpha));\nreturn clamp(mip,0.,maxMipLevel);\n}\nfloat getMipMapIndexFromAverageSlopeWithPMREM(float maxMipLevel,float alphaG)\n{\nfloat specularPower=clamp(2./alphaG-2.,0.000001,2048.);\n\nreturn clamp(- 0.5*log2(specularPower)+5.5,0.,maxMipLevel);\n}\n\nfloat smithVisibilityG1_TrowbridgeReitzGGX(float dot,float alphaG)\n{\nfloat tanSquared=(1.0-dot*dot)/(dot*dot);\nreturn 2.0/(1.0+sqrt(1.0+alphaG*alphaG*tanSquared));\n}\nfloat smithVisibilityG_TrowbridgeReitzGGX_Walter(float NdotL,float NdotV,float alphaG)\n{\nreturn smithVisibilityG1_TrowbridgeReitzGGX(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGX(NdotV,alphaG);\n}\n\n\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\n\n\n\nfloat a2=Square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(kPi*d*d);\n}\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow(clamp(1.0-VdotH,0.,1.),5.0);\n}\nvec3 FresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n\nvec3 computeSpecularTerm(float NdotH,float NdotL,float NdotV,float VdotH,float roughness,vec3 specularColor,vec3 reflectance90)\n{\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\nfloat visibility=smithVisibilityG_TrowbridgeReitzGGX_Walter(NdotL,NdotV,alphaG);\nvisibility/=(4.0*NdotL*NdotV); \nvec3 fresnel=fresnelSchlickGGX(VdotH,specularColor,reflectance90);\nfloat specTerm=max(0.,visibility*distribution)*NdotL;\nreturn fresnel*specTerm*kPi; \n}\nfloat computeDiffuseTerm(float NdotL,float NdotV,float VdotH,float roughness)\n{\n\n\nfloat diffuseFresnelNV=pow(clamp(1.0-NdotL,0.000001,1.),5.0);\nfloat diffuseFresnelNL=pow(clamp(1.0-NdotV,0.000001,1.),5.0);\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat diffuseFresnelTerm =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn diffuseFresnelTerm*NdotL;\n\n\n}\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\n\nfloat lightRoughness=lightRadius/lightDistance;\n\nfloat totalRoughness=clamp(lightRoughness+roughness,0.,1.);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nfloat kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\nvec3 toLinearSpace(vec3 color)\n{\nreturn vec3(pow(color.r,2.2),pow(color.g,2.2),pow(color.b,2.2));\n}\nvec3 toGammaSpace(vec3 color)\n{\nreturn vec3(pow(color.r,1.0/2.2),pow(color.g,1.0/2.2),pow(color.b,1.0/2.2));\n}\n#ifdef CAMERATONEMAP\nvec3 toneMaps(vec3 color)\n{\ncolor=max(color,0.0);\n\ncolor.rgb=color.rgb*vCameraInfos.x;\nfloat tuning=1.5; \n\n\nvec3 tonemapped=1.0-exp2(-color.rgb*tuning); \ncolor.rgb=mix(color.rgb,tonemapped,1.0);\nreturn color;\n}\n#endif\n#ifdef CAMERACONTRAST\nvec4 contrasts(vec4 color)\n{\ncolor=clamp(color,0.0,1.0);\nvec3 resultHighContrast=color.rgb*color.rgb*(3.0-2.0*color.rgb);\nfloat contrast=vCameraInfos.y;\nif (contrast<1.0)\n{\n\ncolor.rgb=mix(vec3(0.5,0.5,0.5),color.rgb,contrast);\n}\nelse\n{\n\ncolor.rgb=mix(color.rgb,resultHighContrast,contrast-1.0);\n}\nreturn color;\n}\n#endif",pbrLightFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range)\n{ \n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat lightDistanceFalloff=1.0/((lightDistanceSquared+0.0001));\n#else\nfloat lightDistanceFalloff=max(0.,1.0-length(lightOffset)/range);\n#endif\nreturn lightDistanceFalloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngle,float exponent)\n{\nfloat falloff=0.0;\n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat cosHalfAngle=cos(lightAngle*0.5);\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \n\n\n\n\n\nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\n\n\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfalloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\n#else\nfloat cosAngle=max(0.000000000000001,dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=lightAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\n#endif\nreturn falloff;\n}\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\nvec3 lightDirection;\nfloat attenuation=1.0;\nfloat lightDistance;\n\nif (lightData.w == 0.)\n{\nvec3 lightOffset=lightData.xyz-vPositionW;\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nattenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\nlightDistance=sqrt(lightDistanceSquared);\nlightDirection=normalize(lightOffset);\n}\n\nelse\n{\nlightDistance=length(-lightData.xyz);\nlightDirection=normalize(-lightData.xyz);\n}\n\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+lightDirection);\nNdotL=max(0.00000000001,dot(vNormal,lightDirection));\nfloat VdotH=clamp(0.00000000001,1.0,dot(viewDirectionW,H));\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=max(0.00000000001,dot(vNormal,H));\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,specularColor,reflectance90);\nresult.specular=specTerm*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\nvec3 lightOffset=lightData.xyz-vPositionW;\nvec3 directionToLightCenterW=normalize(lightOffset);\n\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nfloat attenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\n\nfloat directionalAttenuation=computeDirectionalLightFalloff(lightDirection.xyz,directionToLightCenterW,lightDirection.w,lightData.w);\nattenuation*=directionalAttenuation;\n\nfloat lightDistance=sqrt(lightDistanceSquared);\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW-lightDirection.xyz);\nNdotL=max(0.00000000001,dot(vNormal,-lightDirection.xyz));\nfloat VdotH=clamp(dot(viewDirectionW,H),0.00000000001,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=max(0.00000000001,dot(vNormal,H));\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,specularColor,reflectance90);\nresult.specular=specTerm*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float roughness,float NdotV,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\n\n\n\nNdotL=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,NdotL);\n#ifdef SPECULARTERM\n\nvec3 lightVectorW=normalize(lightData.xyz);\nvec3 H=normalize(viewDirectionW+lightVectorW);\nfloat NdotH=max(0.00000000001,dot(vNormal,H));\nNdotL=max(0.00000000001,NdotL);\nfloat VdotH=clamp(0.00000000001,1.0,dot(viewDirectionW,H));\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,specularColor,reflectance90);\nresult.specular=specTerm;\n#endif\nreturn result;\n}",pbrLightFunctionsCall:"#ifdef LIGHT{X}\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n\n#else\n#ifndef SPECULARTERM\nvec3 vLightSpecular{X}=vec3(0.0);\n#endif\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,vLightData{X},vLightDirection{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,roughness,NdotV,specularEnvironmentR90,NdotL);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightGround{X},roughness,NdotV,specularEnvironmentR90,NdotL);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,roughness,NdotV,specularEnvironmentR90,NdotL);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWVSM{X}\nnotShadowLevel=computeShadowWithVSM(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\n#ifdef SHADOWPCF{X}\n#if defined(POINTLIGHT{X})\nnotShadowLevel=computeShadowWithPCFCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\nnotShadowLevel=computeShadowWithPCF(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#endif\n#else\n#if defined(POINTLIGHT{X})\nnotShadowLevel=computeShadowCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#else\nnotShadowLevel=computeShadow(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#endif\n#endif\n#endif\n#else\nnotShadowLevel=1.;\n#endif\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\nlightDiffuseContribution+=lightmapColor*notShadowLevel;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nlightSpecularContribution+=info.specular*notShadowLevel*lightmapColor;\n#endif\n#endif\n#else\nlightDiffuseContribution+=info.diffuse*notShadowLevel;\n#ifdef OVERLOADEDSHADOWVALUES\nif (NdotL<0.000000000011)\n{\nnotShadowLevel=1.;\n}\nshadowedOnlyLightDiffuseContribution*=notShadowLevel;\n#endif\n#ifdef SPECULARTERM\nlightSpecularContribution+=info.specular*notShadowLevel;\n#endif\n#endif\n#endif",pbrShadowFunctions:"\n#ifdef SHADOWS\n#ifndef SHADOWFULLFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nuniform vec2 depthValues;\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float bias)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y =-directionToLight.y;\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight))+bias;\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x+bias;\n#endif\nif (depth>shadow)\n{\n#ifdef OVERLOADEDSHADOWVALUES\nreturn mix(1.0,darkness,vOverloadedShadowIntensity.x);\n#else\nreturn darkness;\n#endif\n}\nreturn 1.0;\n}\nfloat computeShadowWithPCFCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\nfloat biasedDepth=depth-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nreturn min(1.0,mix(1.0,visibility+darkness,vOverloadedShadowIntensity.x));\n#else\nreturn min(1.0,visibility+darkness);\n#endif\n}\nfloat computeShadow(vec4 vPositionFromLight,sampler2D shadowSampler,float darkness,float bias)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv))+bias;\n#else\nfloat shadow=texture2D(shadowSampler,uv).x+bias;\n#endif\nif (depth.z>shadow)\n{\n#ifdef OVERLOADEDSHADOWVALUES\nreturn mix(1.0,darkness,vOverloadedShadowIntensity.x);\n#else\nreturn darkness;\n#endif\n}\nreturn 1.;\n}\nfloat computeShadowWithPCF(vec4 vPositionFromLight,sampler2D shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\nfloat biasedDepth=depth.z-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nreturn min(1.0,mix(1.0,visibility+darkness,vOverloadedShadowIntensity.x));\n#else\nreturn min(1.0,visibility+darkness);\n#endif\n}\n#ifndef SHADOWFULLFLOAT\n\nfloat unpackHalf(vec2 color)\n{\nreturn color.x+(color.y/255.0);\n}\n#endif\nfloat linstep(float low,float high,float v) {\nreturn clamp((v-low)/(high-low),0.0,1.0);\n}\nfloat ChebychevInequality(vec2 moments,float compare,float bias)\n{\nfloat p=smoothstep(compare-bias,compare,moments.x);\nfloat variance=max(moments.y-moments.x*moments.x,0.02);\nfloat d=compare-moments.x;\nfloat p_max=linstep(0.2,1.0,variance/(variance+d*d));\nreturn clamp(max(p,p_max),0.0,1.0);\n}\nfloat computeShadowWithVSM(vec4 vPositionFromLight,sampler2D shadowSampler,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0 || depth.z>=1.0)\n{\nreturn 1.0;\n}\nvec4 texel=texture2D(shadowSampler,uv);\n#ifndef SHADOWFULLFLOAT\nvec2 moments=vec2(unpackHalf(texel.xy),unpackHalf(texel.zw));\n#else\nvec2 moments=texel.xy;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nreturn min(1.0,mix(1.0,1.0-ChebychevInequality(moments,depth.z,bias)+darkness,vOverloadedShadowIntensity.x));\n#else\nreturn min(1.0,1.0-ChebychevInequality(moments,depth.z,bias)+darkness);\n#endif\n}\n#endif",pointCloudVertex:"#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif",pointCloudVertexDeclaration:"#ifdef POINTSIZE\nuniform float pointSize;\n#endif",reflectionFunction:"vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nfloat t=clamp(direction.y*-0.5+0.5,0.,1.0);\nfloat s=atan(direction.z,direction.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nvec3 cameraToVertex=normalize(worldPos.xyz-vEyePosition);\nvec3 r=reflect(cameraToVertex,worldNormal);\nfloat t=clamp(r.y*-0.5+0.5,0.,1.0);\nfloat s=atan(r.z,r.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nvec3 viewDir=worldPos.xyz-vEyePosition;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n#endif\n#ifdef REFLECTIONMAP_CUBIC\nvec3 viewDir=worldPos.xyz-vEyePosition;\nvec3 coords=reflect(viewDir,worldNormal);\n#ifdef INVERTCUBICMAP\ncoords.y=1.0-coords.y;\n#endif\nreturn vec3(reflectionMatrix*vec4(coords,0));\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn vec3(reflectionMatrix*(view*worldPos));\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}",shadowsFragmentFunctions:"#ifdef SHADOWS\n#ifndef SHADOWFULLFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nuniform vec2 depthValues;\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float bias)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight))+bias;\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x+bias;\n#endif\nif (depth>shadow)\n{\nreturn darkness;\n}\nreturn 1.0;\n}\nfloat computeShadowWithPCFCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\nfloat biasedDepth=depth-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\nfloat computeShadow(vec4 vPositionFromLight,sampler2D shadowSampler,float darkness,float bias)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv))+bias;\n#else\nfloat shadow=texture2D(shadowSampler,uv).x+bias;\n#endif\nif (depth.z>shadow)\n{\nreturn darkness;\n}\nreturn 1.;\n}\nfloat computeShadowWithPCF(vec4 vPositionFromLight,sampler2D shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\nfloat biasedDepth=depth.z-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\n#ifndef SHADOWFULLFLOAT\n\nfloat unpackHalf(vec2 color)\n{\nreturn color.x+(color.y/255.0);\n}\n#endif\nfloat linstep(float low,float high,float v) {\nreturn clamp((v-low)/(high-low),0.0,1.0);\n}\nfloat ChebychevInequality(vec2 moments,float compare,float bias)\n{\nfloat p=smoothstep(compare-bias,compare,moments.x);\nfloat variance=max(moments.y-moments.x*moments.x,0.02);\nfloat d=compare-moments.x;\nfloat p_max=linstep(0.2,1.0,variance/(variance+d*d));\nreturn clamp(max(p,p_max),0.0,1.0);\n}\nfloat computeShadowWithVSM(vec4 vPositionFromLight,sampler2D shadowSampler,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0 || depth.z>=1.0)\n{\nreturn 1.0;\n}\nvec4 texel=texture2D(shadowSampler,uv);\n#ifndef SHADOWFULLFLOAT\nvec2 moments=vec2(unpackHalf(texel.xy),unpackHalf(texel.zw));\n#else\nvec2 moments=texel.xy;\n#endif\nreturn min(1.0,1.0-ChebychevInequality(moments,depth.z,bias)+darkness);\n}\n#endif",shadowsVertex:"#ifdef SHADOWS\n#if defined(SPOTLIGHT{X}) || defined(DIRLIGHT{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#endif\n#endif",shadowsVertexDeclaration:"#ifdef SHADOWS\n#if defined(SPOTLIGHT{X}) || defined(DIRLIGHT{X})\nuniform mat4 lightMatrix{X};\nvarying vec4 vPositionFromLight{X};\n#endif\n#endif\n"},r.CollisionWorker='var BABYLON;!function(t){var e=function(t,e,o,i){return!(t.x>o.x+i)&&(!(o.x-i>e.x)&&(!(t.y>o.y+i)&&(!(o.y-i>e.y)&&(!(t.z>o.z+i)&&!(o.z-i>e.z)))))},o=function(){var t={root:0,found:!1};return function(e,o,i,s){t.root=0,t.found=!1;var r=o*o-4*e*i;if(r<0)return t;var n=Math.sqrt(r),c=(-o-n)/(2*e),h=(-o+n)/(2*e);if(c>h){var a=h;h=c,c=a}return c>0&&c<s?(t.root=c,t.found=!0,t):h>0&&h<s?(t.root=h,t.found=!0,t):t}}(),i=function(){function i(){this.radius=new t.Vector3(1,1,1),this.retry=0,this.basePointWorld=t.Vector3.Zero(),this.velocityWorld=t.Vector3.Zero(),this.normalizedVelocity=t.Vector3.Zero(),this._collisionPoint=t.Vector3.Zero(),this._planeIntersectionPoint=t.Vector3.Zero(),this._tempVector=t.Vector3.Zero(),this._tempVector2=t.Vector3.Zero(),this._tempVector3=t.Vector3.Zero(),this._tempVector4=t.Vector3.Zero(),this._edge=t.Vector3.Zero(),this._baseToVertex=t.Vector3.Zero(),this._destinationPoint=t.Vector3.Zero(),this._slidePlaneNormal=t.Vector3.Zero(),this._displacementVector=t.Vector3.Zero()}return i.prototype._initialize=function(e,o,i){this.velocity=o,t.Vector3.NormalizeToRef(o,this.normalizedVelocity),this.basePoint=e,e.multiplyToRef(this.radius,this.basePointWorld),o.multiplyToRef(this.radius,this.velocityWorld),this.velocityWorldLength=this.velocityWorld.length(),this.epsilon=i,this.collisionFound=!1},i.prototype._checkPointInTriangle=function(e,o,i,s,r){o.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),t.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var n=t.Vector3.Dot(this._tempVector4,r);return!(n<0)&&(s.subtractToRef(e,this._tempVector3),t.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),n=t.Vector3.Dot(this._tempVector4,r),!(n<0)&&(t.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),n=t.Vector3.Dot(this._tempVector4,r),n>=0))},i.prototype._canDoCollision=function(o,i,s,r){var n=t.Vector3.Distance(this.basePointWorld,o),c=Math.max(this.radius.x,this.radius.y,this.radius.z);return!(n>this.velocityWorldLength+c+i)&&!!e(s,r,this.basePointWorld,this.velocityWorldLength+c)},i.prototype._testTriangle=function(e,i,s,r,n,c){var h,a=!1;i||(i=[]),i[e]||(i[e]=new t.Plane(0,0,0,0),i[e].copyFromPoints(s,r,n));var l=i[e];if(c||l.isFrontFacingTo(this.normalizedVelocity,0)){var _=l.signedDistanceTo(this.basePoint),d=t.Vector3.Dot(l.normal,this.velocity);if(0==d){if(Math.abs(_)>=1)return;a=!0,h=0}else{h=(-1-_)/d;var V=(1-_)/d;if(h>V){var u=V;V=h,h=u}if(h>1||V<0)return;h<0&&(h=0),h>1&&(h=1)}this._collisionPoint.copyFromFloats(0,0,0);var P=!1,p=1;if(a||(this.basePoint.subtractToRef(l.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(h,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,s,r,n,l.normal)&&(P=!0,p=h,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!P){var f=this.velocity.lengthSquared(),m=f;this.basePoint.subtractToRef(s,this._tempVector);var T=2*t.Vector3.Dot(this.velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=o(m,T,b,p);y.found&&(p=y.root,P=!0,this._collisionPoint.copyFrom(s)),this.basePoint.subtractToRef(r,this._tempVector),T=2*t.Vector3.Dot(this.velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=o(m,T,b,p),y.found&&(p=y.root,P=!0,this._collisionPoint.copyFrom(r)),this.basePoint.subtractToRef(n,this._tempVector),T=2*t.Vector3.Dot(this.velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=o(m,T,b,p),y.found&&(p=y.root,P=!0,this._collisionPoint.copyFrom(n)),r.subtractToRef(s,this._edge),s.subtractToRef(this.basePoint,this._baseToVertex);var g=this._edge.lengthSquared(),v=t.Vector3.Dot(this._edge,this.velocity),R=t.Vector3.Dot(this._edge,this._baseToVertex);if(m=g*-f+v*v,T=g*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*v*R,b=g*(1-this._baseToVertex.lengthSquared())+R*R,y=o(m,T,b,p),y.found){var D=(v*y.root-R)/g;D>=0&&D<=1&&(p=y.root,P=!0,this._edge.scaleInPlace(D),s.addToRef(this._edge,this._collisionPoint))}n.subtractToRef(r,this._edge),r.subtractToRef(this.basePoint,this._baseToVertex),g=this._edge.lengthSquared(),v=t.Vector3.Dot(this._edge,this.velocity),R=t.Vector3.Dot(this._edge,this._baseToVertex),m=g*-f+v*v,T=g*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*v*R,b=g*(1-this._baseToVertex.lengthSquared())+R*R,y=o(m,T,b,p),y.found&&(D=(v*y.root-R)/g,D>=0&&D<=1&&(p=y.root,P=!0,this._edge.scaleInPlace(D),r.addToRef(this._edge,this._collisionPoint))),s.subtractToRef(n,this._edge),n.subtractToRef(this.basePoint,this._baseToVertex),g=this._edge.lengthSquared(),v=t.Vector3.Dot(this._edge,this.velocity),R=t.Vector3.Dot(this._edge,this._baseToVertex),m=g*-f+v*v,T=g*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*v*R,b=g*(1-this._baseToVertex.lengthSquared())+R*R,y=o(m,T,b,p),y.found&&(D=(v*y.root-R)/g,D>=0&&D<=1&&(p=y.root,P=!0,this._edge.scaleInPlace(D),n.addToRef(this._edge,this._collisionPoint)))}if(P){var x=p*this.velocity.length();(!this.collisionFound||x<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=x,this.collisionFound=!0)}}},i.prototype._collide=function(t,e,o,i,s,r,n){for(var c=i;c<s;c+=3){var h=e[o[c]-r],a=e[o[c+1]-r],l=e[o[c+2]-r];this._testTriangle(c,t,l,a,h,n)}},i.prototype._getResponse=function(e,o){e.addToRef(o,this._destinationPoint),o.scaleInPlace(this.nearestDistance/o.length()),this.basePoint.addToRef(o,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(t.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,o)},i}();t.Collider=i}(BABYLON||(BABYLON={}));var BABYLON;!function(o){o.WorkerIncluded=!0;var e=function(){function o(){this._meshes={},this._geometries={}}return o.prototype.getMeshes=function(){return this._meshes},o.prototype.getGeometries=function(){return this._geometries},o.prototype.getMesh=function(o){return this._meshes[o]},o.prototype.addMesh=function(o){this._meshes[o.uniqueId]=o},o.prototype.removeMesh=function(o){delete this._meshes[o]},o.prototype.getGeometry=function(o){return this._geometries[o]},o.prototype.addGeometry=function(o){this._geometries[o.id]=o},o.prototype.removeGeometry=function(o){delete this._geometries[o]},o}();o.CollisionCache=e;var i=function(){function e(e,i,r){this.collider=e,this._collisionCache=i,this.finalPosition=r,this.collisionsScalingMatrix=o.Matrix.Zero(),this.collisionTranformationMatrix=o.Matrix.Zero()}return e.prototype.collideWithWorld=function(o,e,i,r){var t=.01;if(this.collider.retry>=i)return void this.finalPosition.copyFrom(o);this.collider._initialize(o,e,t);for(var s,l=this._collisionCache.getMeshes(),n=Object.keys(l),a=n.length,c=0;c<a;++c)if(s=n[c],parseInt(s)!=r){var d=l[s];d.checkCollisions&&this.checkCollision(d)}return this.collider.collisionFound?(0===e.x&&0===e.y&&0===e.z||this.collider._getResponse(o,e),e.length()<=t?void this.finalPosition.copyFrom(o):(this.collider.retry++,void this.collideWithWorld(o,e,i,r))):void o.addToRef(e,this.finalPosition)},e.prototype.checkCollision=function(e){if(this.collider._canDoCollision(o.Vector3.FromArray(e.sphereCenter),e.sphereRadius,o.Vector3.FromArray(e.boxMinimum),o.Vector3.FromArray(e.boxMaximum))){o.Matrix.ScalingToRef(1/this.collider.radius.x,1/this.collider.radius.y,1/this.collider.radius.z,this.collisionsScalingMatrix);var i=o.Matrix.FromArray(e.worldMatrixFromCache);i.multiplyToRef(this.collisionsScalingMatrix,this.collisionTranformationMatrix),this.processCollisionsForSubMeshes(this.collisionTranformationMatrix,e)}},e.prototype.processCollisionsForSubMeshes=function(o,e){var i=e.subMeshes,r=i.length;if(!e.geometryId)return void console.log("no mesh geometry id");var t=this._collisionCache.getGeometry(e.geometryId);if(!t)return void console.log("couldn\'t find geometry",e.geometryId);for(var s=0;s<r;s++){var l=i[s];r>1&&!this.checkSubmeshCollision(l)||(this.collideForSubMesh(l,o,t),this.collider.collisionFound&&(this.collider.collidedMesh=e.uniqueId))}},e.prototype.collideForSubMesh=function(e,i,r){if(!r.positionsArray){r.positionsArray=[];for(var t=0,s=r.positions.length;t<s;t+=3){var l=o.Vector3.FromArray([r.positions[t],r.positions[t+1],r.positions[t+2]]);r.positionsArray.push(l)}}if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(i)){e._lastColliderTransformMatrix=i.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];for(var n=e.verticesStart,a=e.verticesStart+e.verticesCount,t=n;t<a;t++)e._lastColliderWorldVertices.push(o.Vector3.TransformCoordinates(r.positionsArray[t],i))}this.collider._collide(e._trianglePlanes,e._lastColliderWorldVertices,r.indices,e.indexStart,e.indexStart+e.indexCount,e.verticesStart,e.hasMaterial)},e.prototype.checkSubmeshCollision=function(e){return this.collider._canDoCollision(o.Vector3.FromArray(e.sphereCenter),e.sphereRadius,o.Vector3.FromArray(e.boxMinimum),o.Vector3.FromArray(e.boxMaximum))},e}();o.CollideWorker=i;var r=function(){function r(){}return r.prototype.onInit=function(i){this._collisionCache=new e;var r={error:o.WorkerReplyType.SUCCESS,taskType:o.WorkerTaskType.INIT};postMessage(r,void 0)},r.prototype.onUpdate=function(e){var i=this,r={error:o.WorkerReplyType.SUCCESS,taskType:o.WorkerTaskType.UPDATE};try{for(var t in e.updatedGeometries)e.updatedGeometries.hasOwnProperty(t)&&this._collisionCache.addGeometry(e.updatedGeometries[t]);for(var s in e.updatedMeshes)e.updatedMeshes.hasOwnProperty(s)&&this._collisionCache.addMesh(e.updatedMeshes[s]);e.removedGeometries.forEach(function(o){i._collisionCache.removeGeometry(o)}),e.removedMeshes.forEach(function(o){i._collisionCache.removeMesh(o)})}catch(l){r.error=o.WorkerReplyType.UNKNOWN_ERROR}postMessage(r,void 0)},r.prototype.onCollision=function(e){var r=o.Vector3.Zero(),t=new o.Collider;t.radius=o.Vector3.FromArray(e.collider.radius);var s=new i(t,this._collisionCache,r);s.collideWithWorld(o.Vector3.FromArray(e.collider.position),o.Vector3.FromArray(e.collider.velocity),e.maximumRetry,e.excludedMeshUniqueId);var l={collidedMeshUniqueId:t.collidedMesh,collisionId:e.collisionId,newPosition:r.asArray()},n={error:o.WorkerReplyType.SUCCESS,taskType:o.WorkerTaskType.COLLIDE,payload:l};postMessage(n,void 0)},r}();o.CollisionDetectorTransferable=r;try{if(self&&self instanceof WorkerGlobalScope){window={},o.Collider||(importScripts("./babylon.collisionCoordinator.js"),importScripts("./babylon.collider.js"),importScripts("../Math/babylon.math.js"));var t=new r,s=function(e){var i=e.data;switch(i.taskType){case o.WorkerTaskType.INIT:t.onInit(i.payload);break;case o.WorkerTaskType.COLLIDE:t.onCollision(i.payload);break;case o.WorkerTaskType.UPDATE:t.onUpdate(i.payload)}};self.onmessage=s}}catch(l){console.log("single worker init")}}(BABYLON||(BABYLON={}));var BABYLON;!function(e){e.CollisionWorker="",function(e){e[e.INIT=0]="INIT",e[e.UPDATE=1]="UPDATE",e[e.COLLIDE=2]="COLLIDE"}(e.WorkerTaskType||(e.WorkerTaskType={}));var o=e.WorkerTaskType;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.UNKNOWN_ERROR=1]="UNKNOWN_ERROR"}(e.WorkerReplyType||(e.WorkerReplyType={}));var i=e.WorkerReplyType,t=function(){function t(){var r=this;this._scaledPosition=e.Vector3.Zero(),this._scaledVelocity=e.Vector3.Zero(),this.onMeshUpdated=function(e){r._addUpdateMeshesList[e.uniqueId]=t.SerializeMesh(e)},this.onGeometryUpdated=function(e){r._addUpdateGeometriesList[e.id]=t.SerializeGeometry(e)},this._afterRender=function(){if(r._init&&!(0==r._toRemoveGeometryArray.length&&0==r._toRemoveMeshesArray.length&&0==Object.keys(r._addUpdateGeometriesList).length&&0==Object.keys(r._addUpdateMeshesList).length||r._runningUpdated>4)){++r._runningUpdated;var e={updatedMeshes:r._addUpdateMeshesList,updatedGeometries:r._addUpdateGeometriesList,removedGeometries:r._toRemoveGeometryArray,removedMeshes:r._toRemoveMeshesArray},i={payload:e,taskType:o.UPDATE},t=[];for(var s in e.updatedGeometries)e.updatedGeometries.hasOwnProperty(s)&&(t.push(i.payload.updatedGeometries[s].indices.buffer),t.push(i.payload.updatedGeometries[s].normals.buffer),t.push(i.payload.updatedGeometries[s].positions.buffer));r._worker.postMessage(i,t),r._addUpdateMeshesList={},r._addUpdateGeometriesList={},r._toRemoveGeometryArray=[],r._toRemoveMeshesArray=[]}},this._onMessageFromWorker=function(t){var s=t.data;if(s.error!=i.SUCCESS)return void e.Tools.Warn("error returned from worker!");switch(s.taskType){case o.INIT:r._init=!0,r._scene.meshes.forEach(function(e){r.onMeshAdded(e)}),r._scene.getGeometries().forEach(function(e){r.onGeometryAdded(e)});break;case o.UPDATE:r._runningUpdated--;break;case o.COLLIDE:r._runningCollisionTask=!1;var n=s.payload;if(!r._collisionsCallbackArray[n.collisionId])return;r._collisionsCallbackArray[n.collisionId](n.collisionId,e.Vector3.FromArray(n.newPosition),r._scene.getMeshByUniqueID(n.collidedMeshUniqueId)),r._collisionsCallbackArray[n.collisionId]=void 0}},this._collisionsCallbackArray=[],this._init=!1,this._runningUpdated=0,this._runningCollisionTask=!1,this._addUpdateMeshesList={},this._addUpdateGeometriesList={},this._toRemoveGeometryArray=[],this._toRemoveMeshesArray=[]}return t.prototype.getNewPosition=function(e,i,t,r,s,n,a){if(this._init&&!this._collisionsCallbackArray[a]&&!this._collisionsCallbackArray[a+1e5]){e.divideToRef(t.radius,this._scaledPosition),i.divideToRef(t.radius,this._scaledVelocity),this._collisionsCallbackArray[a]=n;var d={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:t.radius.asArray()},collisionId:a,excludedMeshUniqueId:s?s.uniqueId:null,maximumRetry:r},l={payload:d,taskType:o.COLLIDE};this._worker.postMessage(l)}},t.prototype.init=function(i){this._scene=i,this._scene.registerAfterRender(this._afterRender);var t=e.WorkerIncluded?e.Engine.CodeRepository+"Collisions/babylon.collisionWorker.js":URL.createObjectURL(new Blob([e.CollisionWorker],{type:"application/javascript"}));this._worker=new Worker(t),this._worker.onmessage=this._onMessageFromWorker;var r={payload:{},taskType:o.INIT};this._worker.postMessage(r)},t.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender),this._worker.terminate()},t.prototype.onMeshAdded=function(e){e.registerAfterWorldMatrixUpdate(this.onMeshUpdated),this.onMeshUpdated(e)},t.prototype.onMeshRemoved=function(e){this._toRemoveMeshesArray.push(e.uniqueId)},t.prototype.onGeometryAdded=function(e){e.onGeometryUpdated=this.onGeometryUpdated,this.onGeometryUpdated(e)},t.prototype.onGeometryDeleted=function(e){this._toRemoveGeometryArray.push(e.id)},t.SerializeMesh=function(o){var i=[];o.subMeshes&&(i=o.subMeshes.map(function(e,o){return{position:o,verticesStart:e.verticesStart,verticesCount:e.verticesCount,indexStart:e.indexStart,indexCount:e.indexCount,hasMaterial:!!e.getMaterial(),sphereCenter:e.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:e.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:e.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:e.getBoundingInfo().boundingBox.maximumWorld.asArray()}}));var t=null;return o instanceof e.Mesh?t=o.geometry?o.geometry.id:null:o instanceof e.InstancedMesh&&(t=o.sourceMesh&&o.sourceMesh.geometry?o.sourceMesh.geometry.id:null),{uniqueId:o.uniqueId,id:o.id,name:o.name,geometryId:t,sphereCenter:o.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:o.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:o.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:o.getBoundingInfo().boundingBox.maximumWorld.asArray(),worldMatrixFromCache:o.worldMatrixFromCache.asArray(),subMeshes:i,checkCollisions:o.checkCollisions}},t.SerializeGeometry=function(o){return{id:o.id,positions:new Float32Array(o.getVerticesData(e.VertexBuffer.PositionKind)||[]),normals:new Float32Array(o.getVerticesData(e.VertexBuffer.NormalKind)||[]),indices:new Int32Array(o.getIndices()||[])}},t}();e.CollisionCoordinatorWorker=t;var r=function(){function o(){this._scaledPosition=e.Vector3.Zero(),this._scaledVelocity=e.Vector3.Zero(),this._finalPosition=e.Vector3.Zero()}return o.prototype.getNewPosition=function(e,o,i,t,r,s,n){e.divideToRef(i.radius,this._scaledPosition),o.divideToRef(i.radius,this._scaledVelocity),i.collidedMesh=null,i.retry=0,i.initialVelocity=this._scaledVelocity,i.initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,t,this._finalPosition,r),this._finalPosition.multiplyInPlace(i.radius),s(n,this._finalPosition,i.collidedMesh)},o.prototype.init=function(e){this._scene=e},o.prototype.destroy=function(){},o.prototype.onMeshAdded=function(e){},o.prototype.onMeshUpdated=function(e){},o.prototype.onMeshRemoved=function(e){},o.prototype.onGeometryAdded=function(e){},o.prototype.onGeometryUpdated=function(e){},o.prototype.onGeometryDeleted=function(e){},o.prototype._collideWithWorld=function(o,i,t,r,s,n){void 0===n&&(n=null);var a=10*e.Engine.CollisionsEpsilon;if(t.retry>=r)return void s.copyFrom(o);t._initialize(o,i,a);for(var d=0;d<this._scene.meshes.length;d++){var l=this._scene.meshes[d];l.isEnabled()&&l.checkCollisions&&l.subMeshes&&l!==n&&l._checkCollision(t)}return t.collisionFound?(0===i.x&&0===i.y&&0===i.z||t._getResponse(o,i),i.length()<=a?void s.copyFrom(o):(t.retry++,void this._collideWithWorld(o,i,t,r,s,n))):void o.addToRef(i,s)},o}();e.CollisionCoordinatorLegacy=r}(BABYLON||(BABYLON={}));var BABYLON;!function(t){t.ToGammaSpace=1/2.2,t.ToLinearSpace=2.2,t.Epsilon=.001;var i=function(){function t(){}return t.WithinEpsilon=function(t,i,n){void 0===n&&(n=1.401298e-45);var r=t-i;return-n<=r&&r<=n},t.ToHex=function(t){var i=t.toString(16);return t<=15?("0"+i).toUpperCase():i.toUpperCase()},t.Sign=function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},t.Clamp=function(t,i,n){return void 0===i&&(i=0),void 0===n&&(n=1),Math.min(n,Math.max(i,t))},t}();t.MathTools=i;var n=function(){function n(t,i,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.r=t,this.g=i,this.b=n}return n.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},n.prototype.getClassName=function(){return"Color3"},n.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0)},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.r,t[i+1]=this.g,t[i+2]=this.b,this},n.prototype.toColor4=function(t){return void 0===t&&(t=1),new r(this.r,this.g,this.b,t)},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.toLuminance=function(){return.3*this.r+.59*this.g+.11*this.b},n.prototype.multiply=function(t){return new n(this.r*t.r,this.g*t.g,this.b*t.b)},n.prototype.multiplyToRef=function(t,i){return i.r=this.r*t.r,i.g=this.g*t.g,i.b=this.b*t.b,this},n.prototype.equals=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},n.prototype.equalsFloats=function(t,i,n){return this.r===t&&this.g===i&&this.b===n},n.prototype.scale=function(t){return new n(this.r*t,this.g*t,this.b*t)},n.prototype.scaleToRef=function(t,i){return i.r=this.r*t,i.g=this.g*t,i.b=this.b*t,this},n.prototype.add=function(t){return new n(this.r+t.r,this.g+t.g,this.b+t.b)},n.prototype.addToRef=function(t,i){return i.r=this.r+t.r,i.g=this.g+t.g,i.b=this.b+t.b,this},n.prototype.subtract=function(t){return new n(this.r-t.r,this.g-t.g,this.b-t.b)},n.prototype.subtractToRef=function(t,i){return i.r=this.r-t.r,i.g=this.g-t.g,i.b=this.b-t.b,this},n.prototype.clone=function(){return new n(this.r,this.g,this.b)},n.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},n.prototype.copyFromFloats=function(t,i,n){return this.r=t,this.g=i,this.b=n,this},n.prototype.toHexString=function(){var t=255*this.r|0,n=255*this.g|0,r=255*this.b|0;return"#"+i.ToHex(t)+i.ToHex(n)+i.ToHex(r)},n.prototype.toLinearSpace=function(){var t=new n;return this.toLinearSpaceToRef(t),t},n.prototype.toLinearSpaceToRef=function(i){return i.r=Math.pow(this.r,t.ToLinearSpace),i.g=Math.pow(this.g,t.ToLinearSpace),i.b=Math.pow(this.b,t.ToLinearSpace),this},n.prototype.toGammaSpace=function(){var t=new n;return this.toGammaSpaceToRef(t),t},n.prototype.toGammaSpaceToRef=function(i){return i.r=Math.pow(this.r,t.ToGammaSpace),i.g=Math.pow(this.g,t.ToGammaSpace),i.b=Math.pow(this.b,t.ToGammaSpace),this},n.FromHexString=function(t){if("#"!==t.substring(0,1)||7!==t.length)return new n(0,0,0);var i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),o=parseInt(t.substring(5,7),16);return n.FromInts(i,r,o)},n.FromArray=function(t,i){return void 0===i&&(i=0),new n(t[i],t[i+1],t[i+2])},n.FromInts=function(t,i,r){return new n(t/255,i/255,r/255)},n.Lerp=function(t,i,r){var o=t.r+(i.r-t.r)*r,e=t.g+(i.g-t.g)*r,s=t.b+(i.b-t.b)*r;return new n(o,e,s)},n.Red=function(){return new n(1,0,0)},n.Green=function(){return new n(0,1,0)},n.Blue=function(){return new n(0,0,1)},n.Black=function(){return new n(0,0,0)},n.White=function(){return new n(1,1,1)},n.Purple=function(){return new n(.5,0,.5)},n.Magenta=function(){return new n(1,0,1)},n.Yellow=function(){return new n(1,1,0)},n.Gray=function(){return new n(.5,.5,.5)},n}();t.Color3=n;var r=function(){function t(t,i,n,r){this.r=t,this.g=i,this.b=n,this.a=r}return t.prototype.addInPlace=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},t.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},t.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.r,t[i+1]=this.g,t[i+2]=this.b,t[i+3]=this.a,this},t.prototype.add=function(i){return new t(this.r+i.r,this.g+i.g,this.b+i.b,this.a+i.a)},t.prototype.subtract=function(i){return new t(this.r-i.r,this.g-i.g,this.b-i.b,this.a-i.a)},t.prototype.subtractToRef=function(t,i){return i.r=this.r-t.r,i.g=this.g-t.g,i.b=this.b-t.b,i.a=this.a-t.a,this},t.prototype.scale=function(i){return new t(this.r*i,this.g*i,this.b*i,this.a*i)},t.prototype.scaleToRef=function(t,i){return i.r=this.r*t,i.g=this.g*t,i.b=this.b*t,i.a=this.a*t,this},t.prototype.multiply=function(i){return new t(this.r*i.r,this.g*i.g,this.b*i.b,this.a*i.a)},t.prototype.multiplyToRef=function(t,i){return i.r=this.r*t.r,i.g=this.g*t.g,i.b=this.b*t.b,i.a=this.a*t.a,i},t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},t.prototype.getClassName=function(){return"Color4"},t.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0),t=397*t^(this.a||0)},t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)},t.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.toHexString=function(){var t=255*this.r|0,n=255*this.g|0,r=255*this.b|0,o=255*this.a|0;return"#"+i.ToHex(t)+i.ToHex(n)+i.ToHex(r)+i.ToHex(o)},t.FromHexString=function(i){if("#"!==i.substring(0,1)||9!==i.length)return new t(0,0,0,0);var n=parseInt(i.substring(1,3),16),r=parseInt(i.substring(3,5),16),o=parseInt(i.substring(5,7),16),e=parseInt(i.substring(7,9),16);return t.FromInts(n,r,o,e)},t.Lerp=function(i,n,r){var o=new t(0,0,0,0);return t.LerpToRef(i,n,r,o),o},t.LerpToRef=function(t,i,n,r){r.r=t.r+(i.r-t.r)*n,r.g=t.g+(i.g-t.g)*n,r.b=t.b+(i.b-t.b)*n,r.a=t.a+(i.a-t.a)*n},t.FromArray=function(i,n){return void 0===n&&(n=0),new t(i[n],i[n+1],i[n+2],i[n+3])},t.FromInts=function(i,n,r,o){return new t(i/255,n/255,r/255,o/255)},t.CheckColors4=function(t,i){if(t.length===3*i){for(var n=[],r=0;r<t.length;r+=3){var o=r/3*4;n[o]=t[r],n[o+1]=t[r+1],n[o+2]=t[r+2],n[o+3]=1}return n}return t},t}();t.Color4=r;var o=function(){function n(t,i){this.x=t,this.y=i}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},n.prototype.getClassName=function(){return"Vector2"},n.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0)},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,this},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this},n.prototype.copyFromFloats=function(t,i){return this.x=t,this.y=i,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y)},n.prototype.addToRef=function(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,this},n.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this},n.prototype.addVector3=function(t){return new n(this.x+t.x,this.y+t.y)},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y)},n.prototype.subtractToRef=function(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,this},n.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this},n.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this},n.prototype.multiply=function(t){return new n(this.x*t.x,this.y*t.y)},n.prototype.multiplyToRef=function(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,this},n.prototype.multiplyByFloats=function(t,i){return new n(this.x*t,this.y*i)},n.prototype.divide=function(t){return new n(this.x/t.x,this.y/t.y)},n.prototype.divideToRef=function(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,this},n.prototype.negate=function(){return new n((-this.x),(-this.y))},n.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this},n.prototype.scale=function(t){return new n(this.x*t,this.y*t)},n.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y},n.prototype.equalsWithEpsilon=function(n,r){return void 0===r&&(r=t.Epsilon),n&&i.WithinEpsilon(this.x,n.x,r)&&i.WithinEpsilon(this.y,n.y,r)},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},n.prototype.normalize=function(){var t=this.length();if(0===t)return this;var i=1/t;return this.x*=i,this.y*=i,this},n.prototype.clone=function(){return new n(this.x,this.y)},n.Zero=function(){return new n(0,0)},n.FromArray=function(t,i){return void 0===i&&(i=0),new n(t[i],t[i+1])},n.FromArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1]},n.CatmullRom=function(t,i,r,o,e){var s=e*e,h=e*s,a=.5*(2*i.x+(-t.x+r.x)*e+(2*t.x-5*i.x+4*r.x-o.x)*s+(-t.x+3*i.x-3*r.x+o.x)*h),u=.5*(2*i.y+(-t.y+r.y)*e+(2*t.y-5*i.y+4*r.y-o.y)*s+(-t.y+3*i.y-3*r.y+o.y)*h);return new n(a,u)},n.Clamp=function(t,i,r){var o=t.x;o=o>r.x?r.x:o,o=o<i.x?i.x:o;var e=t.y;return e=e>r.y?r.y:e,e=e<i.y?i.y:e,new n(o,e)},n.Hermite=function(t,i,r,o,e){var s=e*e,h=e*s,a=2*h-3*s+1,u=-2*h+3*s,m=h-2*s+e,y=h-s,c=t.x*a+r.x*u+i.x*m+o.x*y,p=t.y*a+r.y*u+i.y*m+o.y*y;return new n(c,p)},n.Lerp=function(t,i,r){var o=t.x+(i.x-t.x)*r,e=t.y+(i.y-t.y)*r;return new n(o,e)},n.Dot=function(t,i){return t.x*i.x+t.y*i.y},n.Normalize=function(t){var i=t.clone();return i.normalize(),i},n.Minimize=function(t,i){var r=t.x<i.x?t.x:i.x,o=t.y<i.y?t.y:i.y;return new n(r,o)},n.Maximize=function(t,i){var r=t.x>i.x?t.x:i.x,o=t.y>i.y?t.y:i.y;return new n(r,o)},n.Transform=function(t,i){var r=n.Zero();return n.TransformToRef(t,i,r),r},n.TransformToRef=function(t,i,n){var r=t.x*i.m[0]+t.y*i.m[4]+i.m[12],o=t.x*i.m[1]+t.y*i.m[5]+i.m[13];n.x=r,n.y=o},n.PointInTriangle=function(t,i,n,r){var o=.5*(-n.y*r.x+i.y*(-n.x+r.x)+i.x*(n.y-r.y)+n.x*r.y),e=o<0?-1:1,s=(i.y*r.x-i.x*r.y+(r.y-i.y)*t.x+(i.x-r.x)*t.y)*e,h=(i.x*n.y-i.y*n.x+(i.y-n.y)*t.x+(n.x-i.x)*t.y)*e;return s>0&&h>0&&s+h<2*o*e},n.Distance=function(t,i){return Math.sqrt(n.DistanceSquared(t,i))},n.DistanceSquared=function(t,i){var n=t.x-i.x,r=t.y-i.y;return n*n+r*r},n.Center=function(t,i){var n=t.add(i);return n.scaleInPlace(.5),n},n.DistanceOfPointFromSegment=function(t,i,r){var o=n.DistanceSquared(i,r);if(0===o)return n.Distance(t,i);var e=r.subtract(i),s=Math.max(0,Math.min(1,n.Dot(t.subtract(i),e)/o)),h=i.add(e.multiplyByFloats(s,s));return n.Distance(t,h)},n}();t.Vector2=o;var e=function(){function n(t,i,n){this.x=t,this.y=i,this.z=n}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},n.prototype.getClassName=function(){return"Vector3"},n.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0)},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,this},n.prototype.toQuaternion=function(){var t=new a(0,0,0,1),i=Math.cos(.5*(this.x+this.z)),n=Math.sin(.5*(this.x+this.z)),r=Math.cos(.5*(this.z-this.x)),o=Math.sin(.5*(this.z-this.x)),e=Math.cos(.5*this.y),s=Math.sin(.5*this.y);return t.x=r*s,t.y=-o*s,t.z=n*e,t.w=i*e,t},n.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z)},n.prototype.addToRef=function(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,this},n.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z)},n.prototype.subtractToRef=function(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,this},n.prototype.subtractFromFloats=function(t,i,r){return new n(this.x-t,this.y-i,this.z-r)},n.prototype.subtractFromFloatsToRef=function(t,i,n,r){return r.x=this.x-t,r.y=this.y-i,r.z=this.z-n,this},n.prototype.negate=function(){return new n((-this.x),(-this.y),(-this.z))},n.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this},n.prototype.scale=function(t){return new n(this.x*t,this.y*t,this.z*t)},n.prototype.scaleToRef=function(t,i){i.x=this.x*t,i.y=this.y*t,i.z=this.z*t},n.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},n.prototype.equalsWithEpsilon=function(n,r){return void 0===r&&(r=t.Epsilon),n&&i.WithinEpsilon(this.x,n.x,r)&&i.WithinEpsilon(this.y,n.y,r)&&i.WithinEpsilon(this.z,n.z,r)},n.prototype.equalsToFloats=function(t,i,n){return this.x===t&&this.y===i&&this.z===n},n.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.prototype.multiply=function(t){return new n(this.x*t.x,this.y*t.y,this.z*t.z)},n.prototype.multiplyToRef=function(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,this},n.prototype.multiplyByFloats=function(t,i,r){return new n(this.x*t,this.y*i,this.z*r)},n.prototype.divide=function(t){return new n(this.x/t.x,this.y/t.y,this.z/t.z)},n.prototype.divideToRef=function(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,this},n.prototype.MinimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this},n.prototype.MaximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.prototype.normalize=function(){var t=this.length();if(0===t||1===t)return this;var i=1/t;return this.x*=i,this.y*=i,this.z*=i,this},n.prototype.clone=function(){return new n(this.x,this.y,this.z)},n.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},n.prototype.copyFromFloats=function(t,i,n){return this.x=t,this.y=i,this.z=n,this},n.GetClipFactor=function(t,i,r,o){var e=n.Dot(t,r)-o,s=n.Dot(i,r)-o,h=e/(e-s);return h},n.FromArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2])},n.FromFloatArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2])},n.FromArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2]},n.FromFloatArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2]},n.FromFloatsToRef=function(t,i,n,r){r.x=t,r.y=i,r.z=n},n.Zero=function(){return new n(0,0,0)},n.Up=function(){return new n(0,1,0)},n.Forward=function(){return new n(0,0,1)},n.Right=function(){return new n(1,0,0)},n.Left=function(){return new n((-1),0,0)},n.TransformCoordinates=function(t,i){var r=n.Zero();return n.TransformCoordinatesToRef(t,i,r),r},n.TransformCoordinatesToRef=function(t,i,n){var r=t.x*i.m[0]+t.y*i.m[4]+t.z*i.m[8]+i.m[12],o=t.x*i.m[1]+t.y*i.m[5]+t.z*i.m[9]+i.m[13],e=t.x*i.m[2]+t.y*i.m[6]+t.z*i.m[10]+i.m[14],s=t.x*i.m[3]+t.y*i.m[7]+t.z*i.m[11]+i.m[15];n.x=r/s,n.y=o/s,n.z=e/s},n.TransformCoordinatesFromFloatsToRef=function(t,i,n,r,o){var e=t*r.m[0]+i*r.m[4]+n*r.m[8]+r.m[12],s=t*r.m[1]+i*r.m[5]+n*r.m[9]+r.m[13],h=t*r.m[2]+i*r.m[6]+n*r.m[10]+r.m[14],a=t*r.m[3]+i*r.m[7]+n*r.m[11]+r.m[15];o.x=e/a,o.y=s/a,o.z=h/a},n.TransformNormal=function(t,i){var r=n.Zero();return n.TransformNormalToRef(t,i,r),r},n.TransformNormalToRef=function(t,i,n){var r=t.x*i.m[0]+t.y*i.m[4]+t.z*i.m[8],o=t.x*i.m[1]+t.y*i.m[5]+t.z*i.m[9],e=t.x*i.m[2]+t.y*i.m[6]+t.z*i.m[10];n.x=r,n.y=o,n.z=e},n.TransformNormalFromFloatsToRef=function(t,i,n,r,o){o.x=t*r.m[0]+i*r.m[4]+n*r.m[8],o.y=t*r.m[1]+i*r.m[5]+n*r.m[9],o.z=t*r.m[2]+i*r.m[6]+n*r.m[10]},n.CatmullRom=function(t,i,r,o,e){var s=e*e,h=e*s,a=.5*(2*i.x+(-t.x+r.x)*e+(2*t.x-5*i.x+4*r.x-o.x)*s+(-t.x+3*i.x-3*r.x+o.x)*h),u=.5*(2*i.y+(-t.y+r.y)*e+(2*t.y-5*i.y+4*r.y-o.y)*s+(-t.y+3*i.y-3*r.y+o.y)*h),m=.5*(2*i.z+(-t.z+r.z)*e+(2*t.z-5*i.z+4*r.z-o.z)*s+(-t.z+3*i.z-3*r.z+o.z)*h);return new n(a,u,m)},n.Clamp=function(t,i,r){var o=t.x;o=o>r.x?r.x:o,o=o<i.x?i.x:o;var e=t.y;e=e>r.y?r.y:e,e=e<i.y?i.y:e;var s=t.z;return s=s>r.z?r.z:s,s=s<i.z?i.z:s,new n(o,e,s)},n.Hermite=function(t,i,r,o,e){var s=e*e,h=e*s,a=2*h-3*s+1,u=-2*h+3*s,m=h-2*s+e,y=h-s,c=t.x*a+r.x*u+i.x*m+o.x*y,p=t.y*a+r.y*u+i.y*m+o.y*y,f=t.z*a+r.z*u+i.z*m+o.z*y;return new n(c,p,f)},n.Lerp=function(t,i,r){var o=t.x+(i.x-t.x)*r,e=t.y+(i.y-t.y)*r,s=t.z+(i.z-t.z)*r;return new n(o,e,s)},n.Dot=function(t,i){return t.x*i.x+t.y*i.y+t.z*i.z},n.Cross=function(t,i){var r=n.Zero();return n.CrossToRef(t,i,r),r},n.CrossToRef=function(t,i,n){M.Vector3[0].x=t.y*i.z-t.z*i.y,M.Vector3[0].y=t.z*i.x-t.x*i.z,M.Vector3[0].z=t.x*i.y-t.y*i.x,n.copyFrom(M.Vector3[0])},n.Normalize=function(t){var i=n.Zero();return n.NormalizeToRef(t,i),i},n.NormalizeToRef=function(t,i){i.copyFrom(t),i.normalize()},n.Project=function(t,i,r,o){var e=o.width,s=o.height,h=o.x,a=o.y,m=n._viewportMatrixCache?n._viewportMatrixCache:n._viewportMatrixCache=new u;u.FromValuesToRef(e/2,0,0,0,0,-s/2,0,0,0,0,1,0,h+e/2,s/2+a,0,1,m);var y=n._matrixCache?n._matrixCache:n._matrixCache=new u;return i.multiplyToRef(r,y),y.multiplyToRef(m,y),n.TransformCoordinates(t,y)},n.UnprojectFromTransform=function(t,r,o,e,s){var h=n._matrixCache?n._matrixCache:n._matrixCache=new u;e.multiplyToRef(s,h),h.invert(),t.x=t.x/r*2-1,t.y=-(t.y/o*2-1);var a=n.TransformCoordinates(t,h),m=t.x*h.m[3]+t.y*h.m[7]+t.z*h.m[11]+h.m[15];return i.WithinEpsilon(m,1)&&(a=a.scale(1/m)),a},n.Unproject=function(t,r,o,e,s,h){var a=n._matrixCache?n._matrixCache:n._matrixCache=new u;e.multiplyToRef(s,a),a.multiplyToRef(h,a),a.invert();var m=new n(t.x/r*2-1,(-(t.y/o*2-1)),t.z),y=n.TransformCoordinates(m,a),c=m.x*a.m[3]+m.y*a.m[7]+m.z*a.m[11]+a.m[15];return i.WithinEpsilon(c,1)&&(y=y.scale(1/c)),y},n.Minimize=function(t,i){var n=t.clone();return n.MinimizeInPlace(i),n},n.Maximize=function(t,i){var n=t.clone();return n.MaximizeInPlace(i),n},n.Distance=function(t,i){return Math.sqrt(n.DistanceSquared(t,i))},n.DistanceSquared=function(t,i){var n=t.x-i.x,r=t.y-i.y,o=t.z-i.z;return n*n+r*r+o*o},n.Center=function(t,i){var n=t.add(i);return n.scaleInPlace(.5),n},n.RotationFromAxis=function(t,i,r){var o=n.Zero();return n.RotationFromAxisToRef(t,i,r,o),o},n.RotationFromAxisToRef=function(r,o,e,s){var h=r.normalize(),a=e.normalize(),u=p.X,m=p.Y,y=0,c=0,f=0,x=0,l=0,z=0,w=0,v=-1,d=0,g=M.Vector3[0],R=0,T=M.Vector3[1];i.WithinEpsilon(a.z,0,t.Epsilon)?z=1:i.WithinEpsilon(a.x,0,t.Epsilon)?x=1:(w=a.z/a.x,x=-w*Math.sqrt(1/(1+w*w)),z=Math.sqrt(1/(1+w*w))),T.x=x,T.y=l,T.z=z,T.normalize(),n.CrossToRef(h,T,g),g.normalize(),n.Dot(a,g)<0&&(v=1),R=n.Dot(h,T),R=Math.min(1,Math.max(-1,R)),f=Math.acos(R)*v,n.Dot(T,u)<0&&(f=Math.PI+f,T=T.scaleInPlace(-1),d++);var _=M.Vector3[2],A=M.Vector3[3];x=0,l=0,z=0,v=-1,i.WithinEpsilon(a.z,0,t.Epsilon)?x=1:(w=T.z/T.x,x=-w*Math.sqrt(1/(1+w*w)),z=Math.sqrt(1/(1+w*w))),_.x=x,_.y=l,_.z=z,_.normalize(),n.CrossToRef(_,T,A),A.normalize(),n.CrossToRef(a,_,g),g.normalize(),n.Dot(T,g)<0&&(v=1),R=n.Dot(a,_),R=Math.min(1,Math.max(-1,R)),c=Math.acos(R)*v,n.Dot(A,m)<0&&(c=Math.PI+c,d++),v=-1,n.CrossToRef(u,T,g),g.normalize(),n.Dot(g,m)<0&&(v=1),R=n.Dot(T,u),R=Math.min(1,Math.max(-1,R)),y=-Math.acos(R)*v,R<0&&d<2&&(y=Math.PI+y),s.x=c,s.y=y,s.z=f},n}();t.Vector3=e;var s=function(){function n(t,i,n,r){this.x=t,this.y=i,this.z=n,this.w=r}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},n.prototype.getClassName=function(){return"Vector4"},n.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w,this},n.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},n.prototype.addToRef=function(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,i.w=this.w+t.w,this},n.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},n.prototype.subtractToRef=function(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,i.w=this.w-t.w,this},n.prototype.subtractFromFloats=function(t,i,r,o){return new n(this.x-t,this.y-i,this.z-r,this.w-o)},n.prototype.subtractFromFloatsToRef=function(t,i,n,r,o){return o.x=this.x-t,o.y=this.y-i,o.z=this.z-n,o.w=this.w-r,this},n.prototype.negate=function(){return new n((-this.x),(-this.y),(-this.z),(-this.w))},n.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.prototype.scale=function(t){return new n(this.x*t,this.y*t,this.z*t,this.w*t)},n.prototype.scaleToRef=function(t,i){i.x=this.x*t,i.y=this.y*t,i.z=this.z*t,i.w=this.w*t},n.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.prototype.equalsWithEpsilon=function(n,r){return void 0===r&&(r=t.Epsilon),n&&i.WithinEpsilon(this.x,n.x,r)&&i.WithinEpsilon(this.y,n.y,r)&&i.WithinEpsilon(this.z,n.z,r)&&i.WithinEpsilon(this.w,n.w,r)},n.prototype.equalsToFloats=function(t,i,n,r){return this.x===t&&this.y===i&&this.z===n&&this.w===r},n.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.prototype.multiply=function(t){return new n(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)},n.prototype.multiplyToRef=function(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,i.w=this.w*t.w,this},n.prototype.multiplyByFloats=function(t,i,r,o){return new n(this.x*t,this.y*i,this.z*r,this.w*o)},n.prototype.divide=function(t){return new n(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)},n.prototype.divideToRef=function(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,i.w=this.w/t.w,this},n.prototype.MinimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this},n.prototype.MaximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},n.prototype.normalize=function(){var t=this.length();if(0===t)return this;var i=1/t;return this.x*=i,this.y*=i,this.z*=i,this.w*=i,this},n.prototype.toVector3=function(){return new e(this.x,this.y,this.z)},n.prototype.clone=function(){return new n(this.x,this.y,this.z,this.w)},n.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},n.prototype.copyFromFloats=function(t,i,n,r){return this.x=t,this.y=i,this.z=n,this.w=r,this},n.FromArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2],t[i+3])},n.FromArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2],n.w=t[i+3]},n.FromFloatArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2],n.w=t[i+3]},n.FromFloatsToRef=function(t,i,n,r,o){o.x=t,o.y=i,o.z=n,o.w=r},n.Zero=function(){return new n(0,0,0,0)},n.Normalize=function(t){var i=n.Zero();return n.NormalizeToRef(t,i),i},n.NormalizeToRef=function(t,i){i.copyFrom(t),i.normalize()},n.Minimize=function(t,i){var n=t.clone();return n.MinimizeInPlace(i),n},n.Maximize=function(t,i){var n=t.clone();return n.MaximizeInPlace(i),n},n.Distance=function(t,i){return Math.sqrt(n.DistanceSquared(t,i))},n.DistanceSquared=function(t,i){var n=t.x-i.x,r=t.y-i.y,o=t.z-i.z,e=t.w-i.w;return n*n+r*r+o*o+e*e},n.Center=function(t,i){var n=t.add(i);return n.scaleInPlace(.5),n},n}();t.Vector4=s;var h=function(){function t(t,i){this.width=t,this.height=i}return t.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"},t.prototype.getClassName=function(){return"Size"},t.prototype.getHashCode=function(){var t=this.width||0;return t=397*t^(this.height||0)},t.prototype.copyFrom=function(t){this.width=t.width,this.height=t.height},t.prototype.copyFromFloats=function(t,i){this.width=t,this.height=i},t.prototype.multiplyByFloats=function(i,n){return new t(this.width*i,this.height*n)},t.prototype.clone=function(){return new t(this.width,this.height)},t.prototype.equals=function(t){return!!t&&(this.width===t.width&&this.height===t.height)},Object.defineProperty(t.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),t.Zero=function(){return new t(0,0)},t.prototype.add=function(i){var n=new t(this.width+i.width,this.height+i.height);return n},t.prototype.substract=function(i){var n=new t(this.width-i.width,this.height-i.height);return n},t.Lerp=function(i,n,r){var o=i.width+(n.width-i.width)*r,e=i.height+(n.height-i.height)*r;return new t(o,e)},t}();t.Size=h;var a=function(){function t(t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=1),this.x=t,this.y=i,this.z=n,this.w=r}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},t.prototype.getClassName=function(){return"Quaternion"},t.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},t.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},t.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.copyFromFloats=function(t,i,n,r){return this.x=t,this.y=i,this.z=n,this.w=r,this},t.prototype.add=function(i){return new t(this.x+i.x,this.y+i.y,this.z+i.z,this.w+i.w)},t.prototype.subtract=function(i){return new t(this.x-i.x,this.y-i.y,this.z-i.z,this.w-i.w)},t.prototype.scale=function(i){return new t(this.x*i,this.y*i,this.z*i,this.w*i)},t.prototype.multiply=function(i){var n=new t(0,0,0,1);return this.multiplyToRef(i,n),n},t.prototype.multiplyToRef=function(t,i){var n=this.x*t.w+this.y*t.z-this.z*t.y+this.w*t.x,r=-this.x*t.z+this.y*t.w+this.z*t.x+this.w*t.y,o=this.x*t.y-this.y*t.x+this.z*t.w+this.w*t.z,e=-this.x*t.x-this.y*t.y-this.z*t.z+this.w*t.w;return i.copyFromFloats(n,r,o,e),this},t.prototype.multiplyInPlace=function(t){return this.multiplyToRef(t,this),this},t.prototype.conjugateToRef=function(t){return t.copyFromFloats(-this.x,-this.y,-this.z,this.w),this},t.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.prototype.conjugate=function(){var i=new t((-this.x),(-this.y),(-this.z),this.w);return i},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},t.prototype.toEulerAngles=function(t){void 0===t&&(t="YZX");var i=e.Zero();return this.toEulerAnglesToRef(i,t),i},t.prototype.toEulerAnglesToRef=function(t,i){void 0===i&&(i="YZX");var n=this.z,r=this.x,o=this.y,e=this.w,s=e*e,h=n*n,a=r*r,u=o*o,m=o*n-r*e,y=.4999999;return m<-y?(t.y=2*Math.atan2(o,e),t.x=Math.PI/2,t.z=0):m>y?(t.y=2*Math.atan2(o,e),t.x=-Math.PI/2,t.z=0):(t.z=Math.atan2(2*(r*o+n*e),-h-a+u+s),t.x=Math.asin(-2*(n*o-r*e)),t.y=Math.atan2(2*(n*r+o*e),h-a-u+s)),this},t.prototype.toRotationMatrix=function(t){var i=this.x*this.x,n=this.y*this.y,r=this.z*this.z,o=this.x*this.y,e=this.z*this.w,s=this.z*this.x,h=this.y*this.w,a=this.y*this.z,u=this.x*this.w;return t.m[0]=1-2*(n+r),t.m[1]=2*(o+e),t.m[2]=2*(s-h),t.m[3]=0,t.m[4]=2*(o-e),t.m[5]=1-2*(r+i),t.m[6]=2*(a+u),t.m[7]=0,t.m[8]=2*(s+h),t.m[9]=2*(a-u),t.m[10]=1-2*(n+i),t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t.m[15]=1,this},t.prototype.fromRotationMatrix=function(i){return t.FromRotationMatrixToRef(i,this),this},t.FromRotationMatrix=function(i){var n=new t;return t.FromRotationMatrixToRef(i,n),n},t.FromRotationMatrixToRef=function(t,i){var n,r=t.m,o=r[0],e=r[4],s=r[8],h=r[1],a=r[5],u=r[9],m=r[2],y=r[6],c=r[10],p=o+a+c;p>0?(n=.5/Math.sqrt(p+1),i.w=.25/n,i.x=(y-u)*n,i.y=(s-m)*n,i.z=(h-e)*n):o>a&&o>c?(n=2*Math.sqrt(1+o-a-c),i.w=(y-u)/n,i.x=.25*n,i.y=(e+h)/n,i.z=(s+m)/n):a>c?(n=2*Math.sqrt(1+a-o-c),i.w=(s-m)/n,i.x=(e+h)/n,i.y=.25*n,i.z=(u+y)/n):(n=2*Math.sqrt(1+c-o-a),i.w=(h-e)/n,i.x=(s+m)/n,i.y=(u+y)/n,i.z=.25*n)},t.Inverse=function(i){return new t((-i.x),(-i.y),(-i.z),i.w)},t.Identity=function(){return new t(0,0,0,1)},t.RotationAxis=function(i,n){return t.RotationAxisToRef(i,n,new t)},t.RotationAxisToRef=function(t,i,n){var r=Math.sin(i/2);return t.normalize(),n.w=Math.cos(i/2),n.x=t.x*r,n.y=t.y*r,n.z=t.z*r,n},t.FromArray=function(i,n){return n||(n=0),new t(i[n],i[n+1],i[n+2],i[n+3])},t.RotationYawPitchRoll=function(i,n,r){var o=new t;return t.RotationYawPitchRollToRef(i,n,r,o),o},t.RotationYawPitchRollToRef=function(t,i,n,r){var o=.5*n,e=.5*i,s=.5*t,h=Math.sin(o),a=Math.cos(o),u=Math.sin(e),m=Math.cos(e),y=Math.sin(s),c=Math.cos(s);r.x=c*u*a+y*m*h,r.y=y*m*a-c*u*h,r.z=c*m*h-y*u*a,r.w=c*m*a+y*u*h},t.RotationAlphaBetaGamma=function(i,n,r){var o=new t;return t.RotationAlphaBetaGammaToRef(i,n,r,o),o},t.RotationAlphaBetaGammaToRef=function(t,i,n,r){var o=.5*(n+t),e=.5*(n-t),s=.5*i;r.x=Math.cos(e)*Math.sin(s),r.y=Math.sin(e)*Math.sin(s),r.z=Math.sin(o)*Math.cos(s),r.w=Math.cos(o)*Math.cos(s)},t.Slerp=function(i,n,r){var o=t.Identity();return t.SlerpToRef(i,n,r,o),o},t.SlerpToRef=function(t,i,n,r){var o,e,s=n,h=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w,a=!1;if(h<0&&(a=!0,h=-h),h>.999999)e=1-s,o=a?-s:s;else{var u=Math.acos(h),m=1/Math.sin(u);e=Math.sin((1-s)*u)*m,o=a?-Math.sin(s*u)*m:Math.sin(s*u)*m}r.x=e*t.x+o*i.x,r.y=e*t.y+o*i.y,r.z=e*t.z+o*i.z,r.w=e*t.w+o*i.w},t}();t.Quaternion=a;var u=function(){function t(){this.m=new Float32Array(16)}return t.prototype.isIdentity=function(){return 1===this.m[0]&&1===this.m[5]&&1===this.m[10]&&1===this.m[15]&&(0===this.m[1]&&0===this.m[2]&&0===this.m[3]&&0===this.m[4]&&0===this.m[6]&&0===this.m[7]&&0===this.m[8]&&0===this.m[9]&&0===this.m[11]&&0===this.m[12]&&0===this.m[13]&&0===this.m[14])},t.prototype.determinant=function(){var t=this.m[10]*this.m[15]-this.m[11]*this.m[14],i=this.m[9]*this.m[15]-this.m[11]*this.m[13],n=this.m[9]*this.m[14]-this.m[10]*this.m[13],r=this.m[8]*this.m[15]-this.m[11]*this.m[12],o=this.m[8]*this.m[14]-this.m[10]*this.m[12],e=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*t-this.m[6]*i+this.m[7]*n)-this.m[1]*(this.m[4]*t-this.m[6]*r+this.m[7]*o)+this.m[2]*(this.m[4]*i-this.m[5]*r+this.m[7]*e)-this.m[3]*(this.m[4]*n-this.m[5]*o+this.m[6]*e)},t.prototype.toArray=function(){return this.m},t.prototype.asArray=function(){return this.toArray()},t.prototype.invert=function(){return this.invertToRef(this),this},t.prototype.reset=function(){for(var t=0;t<16;t++)this.m[t]=0;return this},t.prototype.add=function(i){var n=new t;return this.addToRef(i,n),n},t.prototype.addToRef=function(t,i){for(var n=0;n<16;n++)i.m[n]=this.m[n]+t.m[n];return this},t.prototype.addToSelf=function(t){for(var i=0;i<16;i++)this.m[i]+=t.m[i];return this},t.prototype.invertToRef=function(t){var i=this.m[0],n=this.m[1],r=this.m[2],o=this.m[3],e=this.m[4],s=this.m[5],h=this.m[6],a=this.m[7],u=this.m[8],m=this.m[9],y=this.m[10],c=this.m[11],p=this.m[12],f=this.m[13],x=this.m[14],l=this.m[15],z=y*l-c*x,w=m*l-c*f,v=m*x-y*f,d=u*l-c*p,g=u*x-y*p,R=u*f-m*p,T=s*z-h*w+a*v,_=-(e*z-h*d+a*g),M=e*w-s*d+a*R,A=-(e*v-s*g+h*R),b=1/(i*T+n*_+r*M+o*A),F=h*l-a*x,L=s*l-a*f,C=s*x-h*f,P=e*l-a*p,Z=e*x-h*p,S=e*f-s*p,I=h*c-a*y,H=s*c-a*m,q=s*y-h*m,D=e*c-a*u,V=e*y-h*u,N=e*m-s*u;return t.m[0]=T*b,t.m[4]=_*b,t.m[8]=M*b,t.m[12]=A*b,t.m[1]=-(n*z-r*w+o*v)*b,t.m[5]=(i*z-r*d+o*g)*b,t.m[9]=-(i*w-n*d+o*R)*b,t.m[13]=(i*v-n*g+r*R)*b,t.m[2]=(n*F-r*L+o*C)*b,t.m[6]=-(i*F-r*P+o*Z)*b,t.m[10]=(i*L-n*P+o*S)*b,t.m[14]=-(i*C-n*Z+r*S)*b,t.m[3]=-(n*I-r*H+o*q)*b,t.m[7]=(i*I-r*D+o*V)*b,t.m[11]=-(i*H-n*D+o*N)*b,t.m[15]=(i*q-n*V+r*N)*b,this},t.prototype.setTranslation=function(t){return this.m[12]=t.x,this.m[13]=t.y,this.m[14]=t.z,this},t.prototype.getTranslation=function(){return new e(this.m[12],this.m[13],this.m[14])},t.prototype.multiply=function(i){var n=new t;return this.multiplyToRef(i,n),n},t.prototype.copyFrom=function(t){for(var i=0;i<16;i++)this.m[i]=t.m[i];return this;\n},t.prototype.copyToArray=function(t,i){void 0===i&&(i=0);for(var n=0;n<16;n++)t[i+n]=this.m[n];return this},t.prototype.multiplyToRef=function(t,i){return this.multiplyToArray(t,i.m,0),this},t.prototype.multiplyToArray=function(t,i,n){var r=this.m[0],o=this.m[1],e=this.m[2],s=this.m[3],h=this.m[4],a=this.m[5],u=this.m[6],m=this.m[7],y=this.m[8],c=this.m[9],p=this.m[10],f=this.m[11],x=this.m[12],l=this.m[13],z=this.m[14],w=this.m[15],v=t.m[0],d=t.m[1],g=t.m[2],R=t.m[3],T=t.m[4],_=t.m[5],M=t.m[6],A=t.m[7],b=t.m[8],F=t.m[9],L=t.m[10],C=t.m[11],P=t.m[12],Z=t.m[13],S=t.m[14],I=t.m[15];return i[n]=r*v+o*T+e*b+s*P,i[n+1]=r*d+o*_+e*F+s*Z,i[n+2]=r*g+o*M+e*L+s*S,i[n+3]=r*R+o*A+e*C+s*I,i[n+4]=h*v+a*T+u*b+m*P,i[n+5]=h*d+a*_+u*F+m*Z,i[n+6]=h*g+a*M+u*L+m*S,i[n+7]=h*R+a*A+u*C+m*I,i[n+8]=y*v+c*T+p*b+f*P,i[n+9]=y*d+c*_+p*F+f*Z,i[n+10]=y*g+c*M+p*L+f*S,i[n+11]=y*R+c*A+p*C+f*I,i[n+12]=x*v+l*T+z*b+w*P,i[n+13]=x*d+l*_+z*F+w*Z,i[n+14]=x*g+l*M+z*L+w*S,i[n+15]=x*R+l*A+z*C+w*I,this},t.prototype.equals=function(t){return t&&this.m[0]===t.m[0]&&this.m[1]===t.m[1]&&this.m[2]===t.m[2]&&this.m[3]===t.m[3]&&this.m[4]===t.m[4]&&this.m[5]===t.m[5]&&this.m[6]===t.m[6]&&this.m[7]===t.m[7]&&this.m[8]===t.m[8]&&this.m[9]===t.m[9]&&this.m[10]===t.m[10]&&this.m[11]===t.m[11]&&this.m[12]===t.m[12]&&this.m[13]===t.m[13]&&this.m[14]===t.m[14]&&this.m[15]===t.m[15]},t.prototype.clone=function(){return t.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},t.prototype.getClassName=function(){return"Matrix"},t.prototype.getHashCode=function(){for(var t=this.m[0]||0,i=1;i<16;i++)t=397*t^(this.m[i]||0);return t},t.prototype.decompose=function(n,r,o){o.x=this.m[12],o.y=this.m[13],o.z=this.m[14];var e=i.Sign(this.m[0]*this.m[1]*this.m[2]*this.m[3])<0?-1:1,s=i.Sign(this.m[4]*this.m[5]*this.m[6]*this.m[7])<0?-1:1,h=i.Sign(this.m[8]*this.m[9]*this.m[10]*this.m[11])<0?-1:1;return n.x=e*Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]),n.y=s*Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]),n.z=h*Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]),0===n.x||0===n.y||0===n.z?(r.x=0,r.y=0,r.z=0,r.w=1,!1):(t.FromValuesToRef(this.m[0]/n.x,this.m[1]/n.x,this.m[2]/n.x,0,this.m[4]/n.y,this.m[5]/n.y,this.m[6]/n.y,0,this.m[8]/n.z,this.m[9]/n.z,this.m[10]/n.z,0,0,0,0,1,M.Matrix[0]),a.FromRotationMatrixToRef(M.Matrix[0],r),!0)},t.prototype.getRotationMatrix=function(){var i=t.Identity();return this.getRotationMatrixToRef(i),i},t.prototype.getRotationMatrixToRef=function(i){var n=this.m,r=n[0]*n[1]*n[2]*n[3]<0?-1:1,o=n[4]*n[5]*n[6]*n[7]<0?-1:1,e=n[8]*n[9]*n[10]*n[11]<0?-1:1,s=r*Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),h=o*Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),a=e*Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]);t.FromValuesToRef(n[0]/s,n[1]/s,n[2]/s,0,n[4]/h,n[5]/h,n[6]/h,0,n[8]/a,n[9]/a,n[10]/a,0,0,0,0,1,i)},t.FromArray=function(i,n){var r=new t;return n||(n=0),t.FromArrayToRef(i,n,r),r},t.FromArrayToRef=function(t,i,n){for(var r=0;r<16;r++)n.m[r]=t[r+i]},t.FromFloat32ArrayToRefScaled=function(t,i,n,r){for(var o=0;o<16;o++)r.m[o]=t[o+i]*n},t.FromValuesToRef=function(t,i,n,r,o,e,s,h,a,u,m,y,c,p,f,x,l){l.m[0]=t,l.m[1]=i,l.m[2]=n,l.m[3]=r,l.m[4]=o,l.m[5]=e,l.m[6]=s,l.m[7]=h,l.m[8]=a,l.m[9]=u,l.m[10]=m,l.m[11]=y,l.m[12]=c,l.m[13]=p,l.m[14]=f,l.m[15]=x},t.prototype.getRow=function(t){if(t<0||t>3)return null;var i=4*t;return new s(this.m[i+0],this.m[i+1],this.m[i+2],this.m[i+3])},t.prototype.setRow=function(t,i){if(t<0||t>3)return this;var n=4*t;return this.m[n+0]=i.x,this.m[n+1]=i.y,this.m[n+2]=i.z,this.m[n+3]=i.w,this},t.FromValues=function(i,n,r,o,e,s,h,a,u,m,y,c,p,f,x,l){var z=new t;return z.m[0]=i,z.m[1]=n,z.m[2]=r,z.m[3]=o,z.m[4]=e,z.m[5]=s,z.m[6]=h,z.m[7]=a,z.m[8]=u,z.m[9]=m,z.m[10]=y,z.m[11]=c,z.m[12]=p,z.m[13]=f,z.m[14]=x,z.m[15]=l,z},t.Compose=function(i,n,r){var o=t.FromValues(i.x,0,0,0,0,i.y,0,0,0,0,i.z,0,0,0,0,1),e=t.Identity();return n.toRotationMatrix(e),o=o.multiply(e),o.setTranslation(r),o},t.Identity=function(){return t.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},t.IdentityToRef=function(i){t.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,i)},t.Zero=function(){return t.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},t.RotationX=function(i){var n=new t;return t.RotationXToRef(i,n),n},t.Invert=function(i){var n=new t;return i.invertToRef(n),n},t.RotationXToRef=function(t,i){var n=Math.sin(t),r=Math.cos(t);i.m[0]=1,i.m[15]=1,i.m[5]=r,i.m[10]=r,i.m[9]=-n,i.m[6]=n,i.m[1]=0,i.m[2]=0,i.m[3]=0,i.m[4]=0,i.m[7]=0,i.m[8]=0,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0},t.RotationY=function(i){var n=new t;return t.RotationYToRef(i,n),n},t.RotationYToRef=function(t,i){var n=Math.sin(t),r=Math.cos(t);i.m[5]=1,i.m[15]=1,i.m[0]=r,i.m[2]=-n,i.m[8]=n,i.m[10]=r,i.m[1]=0,i.m[3]=0,i.m[4]=0,i.m[6]=0,i.m[7]=0,i.m[9]=0,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0},t.RotationZ=function(i){var n=new t;return t.RotationZToRef(i,n),n},t.RotationZToRef=function(t,i){var n=Math.sin(t),r=Math.cos(t);i.m[10]=1,i.m[15]=1,i.m[0]=r,i.m[1]=n,i.m[4]=-n,i.m[5]=r,i.m[2]=0,i.m[3]=0,i.m[6]=0,i.m[7]=0,i.m[8]=0,i.m[9]=0,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0},t.RotationAxis=function(i,n){var r=t.Zero();return t.RotationAxisToRef(i,n,r),r},t.RotationAxisToRef=function(t,i,n){var r=Math.sin(-i),o=Math.cos(-i),e=1-o;t.normalize(),n.m[0]=t.x*t.x*e+o,n.m[1]=t.x*t.y*e-t.z*r,n.m[2]=t.x*t.z*e+t.y*r,n.m[3]=0,n.m[4]=t.y*t.x*e+t.z*r,n.m[5]=t.y*t.y*e+o,n.m[6]=t.y*t.z*e-t.x*r,n.m[7]=0,n.m[8]=t.z*t.x*e-t.y*r,n.m[9]=t.z*t.y*e+t.x*r,n.m[10]=t.z*t.z*e+o,n.m[11]=0,n.m[15]=1},t.RotationYawPitchRoll=function(i,n,r){var o=new t;return t.RotationYawPitchRollToRef(i,n,r,o),o},t.RotationYawPitchRollToRef=function(t,i,n,r){a.RotationYawPitchRollToRef(t,i,n,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(r)},t.Scaling=function(i,n,r){var o=t.Zero();return t.ScalingToRef(i,n,r,o),o},t.ScalingToRef=function(t,i,n,r){r.m[0]=t,r.m[1]=0,r.m[2]=0,r.m[3]=0,r.m[4]=0,r.m[5]=i,r.m[6]=0,r.m[7]=0,r.m[8]=0,r.m[9]=0,r.m[10]=n,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},t.Translation=function(i,n,r){var o=t.Identity();return t.TranslationToRef(i,n,r,o),o},t.TranslationToRef=function(i,n,r,o){t.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,i,n,r,1,o)},t.Lerp=function(i,n,r){for(var o=t.Zero(),e=0;e<16;e++)o.m[e]=i.m[e]*(1-r)+n.m[e]*r;return o},t.DecomposeLerp=function(i,n,r){var o=new e(0,0,0),s=new a,h=new e(0,0,0);i.decompose(o,s,h);var u=new e(0,0,0),m=new a,y=new e(0,0,0);n.decompose(u,m,y);var c=e.Lerp(o,u,r),p=a.Slerp(s,m,r),f=e.Lerp(h,y,r);return t.Compose(c,p,f)},t.LookAtLH=function(i,n,r){var o=t.Zero();return t.LookAtLHToRef(i,n,r,o),o},t.LookAtLHToRef=function(i,n,r,o){n.subtractToRef(i,this._zAxis),this._zAxis.normalize(),e.CrossToRef(r,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),e.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var s=-e.Dot(this._xAxis,i),h=-e.Dot(this._yAxis,i),a=-e.Dot(this._zAxis,i);return t.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,h,a,1,o)},t.LookAtRH=function(i,n,r){var o=t.Zero();return t.LookAtRHToRef(i,n,r,o),o},t.LookAtRHToRef=function(i,n,r,o){i.subtractToRef(n,this._zAxis),this._zAxis.normalize(),e.CrossToRef(r,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),e.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var s=-e.Dot(this._xAxis,i),h=-e.Dot(this._yAxis,i),a=-e.Dot(this._zAxis,i);return t.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,h,a,1,o)},t.OrthoLH=function(i,n,r,o){var e=t.Zero();return t.OrthoLHToRef(i,n,r,o,e),e},t.OrthoLHToRef=function(i,n,r,o,e){var s=2/i,h=2/n,a=1/(o-r),u=r/(r-o);t.FromValuesToRef(s,0,0,0,0,h,0,0,0,0,a,0,0,0,u,1,e)},t.OrthoOffCenterLH=function(i,n,r,o,e,s){var h=t.Zero();return t.OrthoOffCenterLHToRef(i,n,r,o,e,s,h),h},t.OrthoOffCenterLHToRef=function(t,i,n,r,o,e,s){s.m[0]=2/(i-t),s.m[1]=s.m[2]=s.m[3]=0,s.m[5]=2/(r-n),s.m[4]=s.m[6]=s.m[7]=0,s.m[10]=1/(e-o),s.m[8]=s.m[9]=s.m[11]=0,s.m[12]=(t+i)/(t-i),s.m[13]=(r+n)/(n-r),s.m[14]=-o/(e-o),s.m[15]=1},t.OrthoOffCenterRH=function(i,n,r,o,e,s){var h=t.Zero();return t.OrthoOffCenterRHToRef(i,n,r,o,e,s,h),h},t.OrthoOffCenterRHToRef=function(i,n,r,o,e,s,h){t.OrthoOffCenterLHToRef(i,n,r,o,e,s,h),h.m[10]*=-1},t.PerspectiveLH=function(i,n,r,o){var e=t.Zero();return e.m[0]=2*r/i,e.m[1]=e.m[2]=e.m[3]=0,e.m[5]=2*r/n,e.m[4]=e.m[6]=e.m[7]=0,e.m[10]=-o/(r-o),e.m[8]=e.m[9]=0,e.m[11]=1,e.m[12]=e.m[13]=e.m[15]=0,e.m[14]=r*o/(r-o),e},t.PerspectiveFovLH=function(i,n,r,o){var e=t.Zero();return t.PerspectiveFovLHToRef(i,n,r,o,e),e},t.PerspectiveFovLHToRef=function(t,i,n,r,o,e){void 0===e&&(e=!0);var s=1/Math.tan(.5*t);e?o.m[0]=s/i:o.m[0]=s,o.m[1]=o.m[2]=o.m[3]=0,e?o.m[5]=s:o.m[5]=s*i,o.m[4]=o.m[6]=o.m[7]=0,o.m[8]=o.m[9]=0,o.m[10]=r/(r-n),o.m[11]=1,o.m[12]=o.m[13]=o.m[15]=0,o.m[14]=-(n*r)/(r-n)},t.PerspectiveFovRH=function(i,n,r,o){var e=t.Zero();return t.PerspectiveFovRHToRef(i,n,r,o,e),e},t.PerspectiveFovRHToRef=function(t,i,n,r,o,e){void 0===e&&(e=!0);var s=1/Math.tan(.5*t);e?o.m[0]=s/i:o.m[0]=s,o.m[1]=o.m[2]=o.m[3]=0,e?o.m[5]=s:o.m[5]=s*i,o.m[4]=o.m[6]=o.m[7]=0,o.m[8]=o.m[9]=0,o.m[10]=r/(n-r),o.m[11]=-1,o.m[12]=o.m[13]=o.m[15]=0,o.m[14]=n*r/(n-r)},t.PerspectiveFovWebVRToRef=function(t,i,n,r,o){void 0===o&&(o=!0);var e=Math.tan(t.upDegrees*Math.PI/180),s=Math.tan(t.downDegrees*Math.PI/180),h=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),u=2/(h+a),m=2/(e+s);r.m[0]=u,r.m[1]=r.m[2]=r.m[3]=r.m[4]=0,r.m[5]=m,r.m[6]=r.m[7]=0,r.m[8]=(h-a)*u*.5,r.m[9]=-((e-s)*m*.5),r.m[10]=-n/(i-n),r.m[11]=1,r.m[12]=r.m[13]=r.m[15]=0,r.m[14]=i*n/(i-n)},t.GetFinalMatrix=function(i,n,r,o,e,s){var h=i.width,a=i.height,u=i.x,m=i.y,y=t.FromValues(h/2,0,0,0,0,-a/2,0,0,0,0,s-e,0,u+h/2,a/2+m,e,1);return n.multiply(r).multiply(o).multiply(y)},t.GetAsMatrix2x2=function(t){return new Float32Array([t.m[0],t.m[1],t.m[4],t.m[5]])},t.GetAsMatrix3x3=function(t){return new Float32Array([t.m[0],t.m[1],t.m[2],t.m[4],t.m[5],t.m[6],t.m[8],t.m[9],t.m[10]])},t.Transpose=function(i){var n=new t;return n.m[0]=i.m[0],n.m[1]=i.m[4],n.m[2]=i.m[8],n.m[3]=i.m[12],n.m[4]=i.m[1],n.m[5]=i.m[5],n.m[6]=i.m[9],n.m[7]=i.m[13],n.m[8]=i.m[2],n.m[9]=i.m[6],n.m[10]=i.m[10],n.m[11]=i.m[14],n.m[12]=i.m[3],n.m[13]=i.m[7],n.m[14]=i.m[11],n.m[15]=i.m[15],n},t.Reflection=function(i){var n=new t;return t.ReflectionToRef(i,n),n},t.ReflectionToRef=function(t,i){t.normalize();var n=t.normal.x,r=t.normal.y,o=t.normal.z,e=-2*n,s=-2*r,h=-2*o;i.m[0]=e*n+1,i.m[1]=s*n,i.m[2]=h*n,i.m[3]=0,i.m[4]=e*r,i.m[5]=s*r+1,i.m[6]=h*r,i.m[7]=0,i.m[8]=e*o,i.m[9]=s*o,i.m[10]=h*o+1,i.m[11]=0,i.m[12]=e*t.d,i.m[13]=s*t.d,i.m[14]=h*t.d,i.m[15]=1},t.FromXYZAxesToRef=function(t,i,n,r){r.m[0]=t.x,r.m[1]=t.y,r.m[2]=t.z,r.m[3]=0,r.m[4]=i.x,r.m[5]=i.y,r.m[6]=i.z,r.m[7]=0,r.m[8]=n.x,r.m[9]=n.y,r.m[10]=n.z,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},t.FromQuaternionToRef=function(t,i){var n=t.x*t.x,r=t.y*t.y,o=t.z*t.z,e=t.x*t.y,s=t.z*t.w,h=t.z*t.x,a=t.y*t.w,u=t.y*t.z,m=t.x*t.w;i.m[0]=1-2*(r+o),i.m[1]=2*(e+s),i.m[2]=2*(h-a),i.m[3]=0,i.m[4]=2*(e-s),i.m[5]=1-2*(o+n),i.m[6]=2*(u+m),i.m[7]=0,i.m[8]=2*(h+a),i.m[9]=2*(u-m),i.m[10]=1-2*(r+n),i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0,i.m[15]=1},t._tempQuaternion=new a,t._xAxis=e.Zero(),t._yAxis=e.Zero(),t._zAxis=e.Zero(),t}();t.Matrix=u;var m=function(){function t(t,i,n,r){this.normal=new e(t,i,n),this.d=r}return t.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},t.prototype.clone=function(){return new t(this.normal.x,this.normal.y,this.normal.z,this.d)},t.prototype.getClassName=function(){return"Plane"},t.prototype.getHashCode=function(){var t=this.normal.getHashCode();return t=397*t^(this.d||0)},t.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),i=0;return 0!==t&&(i=1/t),this.normal.x*=i,this.normal.y*=i,this.normal.z*=i,this.d*=i,this},t.prototype.transform=function(i){var n=u.Transpose(i),r=this.normal.x,o=this.normal.y,e=this.normal.z,s=this.d,h=r*n.m[0]+o*n.m[1]+e*n.m[2]+s*n.m[3],a=r*n.m[4]+o*n.m[5]+e*n.m[6]+s*n.m[7],m=r*n.m[8]+o*n.m[9]+e*n.m[10]+s*n.m[11],y=r*n.m[12]+o*n.m[13]+e*n.m[14]+s*n.m[15];return new t(h,a,m,y)},t.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},t.prototype.copyFromPoints=function(t,i,n){var r,o=i.x-t.x,e=i.y-t.y,s=i.z-t.z,h=n.x-t.x,a=n.y-t.y,u=n.z-t.z,m=e*u-s*a,y=s*h-o*u,c=o*a-e*h,p=Math.sqrt(m*m+y*y+c*c);return r=0!==p?1/p:0,this.normal.x=m*r,this.normal.y=y*r,this.normal.z=c*r,this.d=-(this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z),this},t.prototype.isFrontFacingTo=function(t,i){var n=e.Dot(this.normal,t);return n<=i},t.prototype.signedDistanceTo=function(t){return e.Dot(t,this.normal)+this.d},t.FromArray=function(i){return new t(i[0],i[1],i[2],i[3])},t.FromPoints=function(i,n,r){var o=new t(0,0,0,0);return o.copyFromPoints(i,n,r),o},t.FromPositionAndNormal=function(i,n){var r=new t(0,0,0,0);return n.normalize(),r.normal=n,r.d=-(n.x*i.x+n.y*i.y+n.z*i.z),r},t.SignedDistanceToPlaneFromPositionAndNormal=function(t,i,n){var r=-(i.x*t.x+i.y*t.y+i.z*t.z);return e.Dot(n,i)+r},t}();t.Plane=m;var y=function(){function t(t,i,n,r){this.x=t,this.y=i,this.width=n,this.height=r}return t.prototype.toGlobal=function(i,n){return new t(this.x*i,this.y*n,this.width*i,this.height*n)},t}();t.Viewport=y;var c=function(){function t(){}return t.GetPlanes=function(i){for(var n=[],r=0;r<6;r++)n.push(new m(0,0,0,0));return t.GetPlanesToRef(i,n),n},t.GetPlanesToRef=function(t,i){i[0].normal.x=t.m[3]+t.m[2],i[0].normal.y=t.m[7]+t.m[6],i[0].normal.z=t.m[11]+t.m[10],i[0].d=t.m[15]+t.m[14],i[0].normalize(),i[1].normal.x=t.m[3]-t.m[2],i[1].normal.y=t.m[7]-t.m[6],i[1].normal.z=t.m[11]-t.m[10],i[1].d=t.m[15]-t.m[14],i[1].normalize(),i[2].normal.x=t.m[3]+t.m[0],i[2].normal.y=t.m[7]+t.m[4],i[2].normal.z=t.m[11]+t.m[8],i[2].d=t.m[15]+t.m[12],i[2].normalize(),i[3].normal.x=t.m[3]-t.m[0],i[3].normal.y=t.m[7]-t.m[4],i[3].normal.z=t.m[11]-t.m[8],i[3].d=t.m[15]-t.m[12],i[3].normalize(),i[4].normal.x=t.m[3]-t.m[1],i[4].normal.y=t.m[7]-t.m[5],i[4].normal.z=t.m[11]-t.m[9],i[4].d=t.m[15]-t.m[13],i[4].normalize(),i[5].normal.x=t.m[3]+t.m[1],i[5].normal.y=t.m[7]+t.m[5],i[5].normal.z=t.m[11]+t.m[9],i[5].d=t.m[15]+t.m[13],i[5].normalize()},t}();t.Frustum=c,function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(t.Space||(t.Space={}));var p=(t.Space,function(){function t(){}return t.X=new e(1,0,0),t.Y=new e(0,1,0),t.Z=new e(0,0,1),t}());t.Axis=p;var f=function(){function t(){}return t.interpolate=function(t,i,n,r,o){for(var e=1-3*r+3*i,s=3*r-6*i,h=3*i,a=t,u=0;u<5;u++){var m=a*a,y=m*a,c=e*y+s*m+h*a,p=1/(3*e*m+2*s*a+h);a-=(c-t)*p,a=Math.min(1,Math.max(0,a))}return 3*Math.pow(1-a,2)*a*n+3*(1-a)*Math.pow(a,2)*o+Math.pow(a,3)},t}();t.BezierCurve=f,function(t){t[t.CW=0]="CW",t[t.CCW=1]="CCW"}(t.Orientation||(t.Orientation={}));var x=t.Orientation,l=function(){function t(t){var i=this;this.degrees=function(){return 180*i._radians/Math.PI},this.radians=function(){return i._radians},this._radians=t,this._radians<0&&(this._radians+=2*Math.PI)}return t.BetweenTwoPoints=function(i,n){var r=n.subtract(i),o=Math.atan2(r.y,r.x);return new t(o)},t.FromRadians=function(i){return new t(i)},t.FromDegrees=function(i){return new t(i*Math.PI/180)},t}();t.Angle=l;var z=function(){function t(t,i,n){this.startPoint=t,this.midPoint=i,this.endPoint=n;var r=Math.pow(i.x,2)+Math.pow(i.y,2),e=(Math.pow(t.x,2)+Math.pow(t.y,2)-r)/2,s=(r-Math.pow(n.x,2)-Math.pow(n.y,2))/2,h=(t.x-i.x)*(i.y-n.y)-(i.x-n.x)*(t.y-i.y);this.centerPoint=new o((e*(i.y-n.y)-s*(t.y-i.y))/h,((t.x-i.x)*s-(i.x-n.x)*e)/h),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=l.BetweenTwoPoints(this.centerPoint,this.startPoint);var a=this.startAngle.degrees(),u=l.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),m=l.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();u-a>180&&(u-=360),u-a<-180&&(u+=360),m-u>180&&(m-=360),m-u<-180&&(m+=360),this.orientation=u-a<0?x.CW:x.CCW,this.angle=l.FromDegrees(this.orientation===x.CW?a-m:m-a)}return t}();t.Arc2=z;var w=function(){function t(t,i){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new o(t,i))}return t.prototype.addLineTo=function(t,i){if(closed)return this;var n=new o(t,i),r=this._points[this._points.length-1];return this._points.push(n),this._length+=n.subtract(r).length(),this},t.prototype.addArcTo=function(t,i,n,r,e){if(void 0===e&&(e=36),closed)return this;var s=this._points[this._points.length-1],h=new o(t,i),a=new o(n,r),u=new z(s,h,a),m=u.angle.radians()/e;u.orientation===x.CW&&(m*=-1);for(var y=u.startAngle.radians()+m,c=0;c<e;c++){var p=Math.cos(y)*u.radius+u.centerPoint.x,f=Math.sin(y)*u.radius+u.centerPoint.y;this.addLineTo(p,f),y+=m}return this},t.prototype.close=function(){return this.closed=!0,this},t.prototype.length=function(){var t=this._length;if(!this.closed){var i=this._points[this._points.length-1],n=this._points[0];t+=n.subtract(i).length()}return t},t.prototype.getPoints=function(){return this._points},t.prototype.getPointAtLengthPosition=function(t){if(t<0||t>1)return o.Zero();for(var i=t*this.length(),n=0,r=0;r<this._points.length;r++){var e=(r+1)%this._points.length,s=this._points[r],h=this._points[e],a=h.subtract(s),u=a.length()+n;if(i>=n&&i<=u){var m=a.normalize(),y=i-n;return new o(s.x+m.x*y,s.y+m.y*y)}n=u}return o.Zero()},t.StartingAt=function(i,n){return new t(i,n)},t}();t.Path2=w;var v=function(){function n(t,i,n){this.path=t,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array;for(var r=0;r<t.length;r++)this._curve[r]=t[r].clone();this._raw=n||!1,this._compute(i)}return n.prototype.getCurve=function(){return this._curve},n.prototype.getTangents=function(){return this._tangents},n.prototype.getNormals=function(){return this._normals},n.prototype.getBinormals=function(){return this._binormals},n.prototype.getDistances=function(){return this._distances},n.prototype.update=function(t,i){for(var n=0;n<t.length;n++)this._curve[n].x=t[n].x,this._curve[n].y=t[n].y,this._curve[n].z=t[n].z;return this._compute(i),this},n.prototype._compute=function(t){var i=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();var n=this._tangents[0],r=this._normalVector(this._curve[0],n,t);this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=e.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var o,s,h,a,u=1;u<i;u++)o=this._getLastNonNullVector(u),u<i-1&&(s=this._getFirstNonNullVector(u),this._tangents[u]=o.add(s),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+o.length(),h=this._tangents[u],a=this._binormals[u-1],this._normals[u]=e.Cross(a,h),this._raw||this._normals[u].normalize(),this._binormals[u]=e.Cross(h,this._normals[u]),this._raw||this._binormals[u].normalize()},n.prototype._getFirstNonNullVector=function(t){for(var i=1,n=this._curve[t+i].subtract(this._curve[t]);0===n.length()&&t+i+1<this._curve.length;)i++,n=this._curve[t+i].subtract(this._curve[t]);return n},n.prototype._getLastNonNullVector=function(t){for(var i=1,n=this._curve[t].subtract(this._curve[t-i]);0===n.length()&&t>i+1;)i++,n=this._curve[t].subtract(this._curve[t-i]);return n},n.prototype._normalVector=function(n,r,o){var s,h=r.length();if(0===h&&(h=1),void 0===o||null===o){var a;i.WithinEpsilon(Math.abs(r.y)/h,1,t.Epsilon)?i.WithinEpsilon(Math.abs(r.x)/h,1,t.Epsilon)?i.WithinEpsilon(Math.abs(r.z)/h,1,t.Epsilon)||(a=new e(0,0,1)):a=new e(1,0,0):a=new e(0,(-1),0),s=e.Cross(r,a)}else s=e.Cross(r,o),e.CrossToRef(s,r,s);return s.normalize(),s},n}();t.Path3D=v;var d=function(){function t(t){this._length=0,this._points=t,this._length=this._computeLength(t)}return t.CreateQuadraticBezier=function(i,n,r,o){o=o>2?o:3;for(var s=new Array,h=function(t,i,n,r){var o=(1-t)*(1-t)*i+2*t*(1-t)*n+t*t*r;return o},a=0;a<=o;a++)s.push(new e(h(a/o,i.x,n.x,r.x),h(a/o,i.y,n.y,r.y),h(a/o,i.z,n.z,r.z)));return new t(s)},t.CreateCubicBezier=function(i,n,r,o,s){s=s>3?s:4;for(var h=new Array,a=function(t,i,n,r,o){var e=(1-t)*(1-t)*(1-t)*i+3*t*(1-t)*(1-t)*n+3*t*t*(1-t)*r+t*t*t*o;return e},u=0;u<=s;u++)h.push(new e(a(u/s,i.x,n.x,r.x,o.x),a(u/s,i.y,n.y,r.y,o.y),a(u/s,i.z,n.z,r.z,o.z)));return new t(h)},t.CreateHermiteSpline=function(i,n,r,o,s){for(var h=new Array,a=1/s,u=0;u<=s;u++)h.push(e.Hermite(i,n,r,o,u*a));return new t(h)},t.prototype.getPoints=function(){return this._points},t.prototype.length=function(){return this._length},t.prototype["continue"]=function(i){for(var n=this._points[this._points.length-1],r=this._points.slice(),o=i.getPoints(),e=1;e<o.length;e++)r.push(o[e].subtract(o[0]).add(n));var s=new t(r);return s},t.prototype._computeLength=function(t){for(var i=0,n=1;n<t.length;n++)i+=t[n].subtract(t[n-1]).length();return i},t}();t.Curve3=d;var g=function(){function t(){this.L00=e.Zero(),this.L1_1=e.Zero(),this.L10=e.Zero(),this.L11=e.Zero(),this.L2_2=e.Zero(),this.L2_1=e.Zero(),this.L20=e.Zero(),this.L21=e.Zero(),this.L22=e.Zero()}return t.prototype.addLight=function(t,i,n){var r=new e(i.r,i.g,i.b),o=r.scale(n);this.L00=this.L00.add(o.scale(.282095)),this.L1_1=this.L1_1.add(o.scale(.488603*t.y)),this.L10=this.L10.add(o.scale(.488603*t.z)),this.L11=this.L11.add(o.scale(.488603*t.x)),this.L2_2=this.L2_2.add(o.scale(1.092548*t.x*t.y)),this.L2_1=this.L2_1.add(o.scale(1.092548*t.y*t.z)),this.L21=this.L21.add(o.scale(1.092548*t.x*t.z)),this.L20=this.L20.add(o.scale(.315392*(3*t.z*t.z-1))),this.L22=this.L22.add(o.scale(.546274*(t.x*t.x-t.y*t.y)))},t.prototype.scale=function(t){this.L00=this.L00.scale(t),this.L1_1=this.L1_1.scale(t),this.L10=this.L10.scale(t),this.L11=this.L11.scale(t),this.L2_2=this.L2_2.scale(t),this.L2_1=this.L2_1.scale(t),this.L20=this.L20.scale(t),this.L21=this.L21.scale(t),this.L22=this.L22.scale(t)},t}();t.SphericalHarmonics=g;var R=function(){function t(){this.x=e.Zero(),this.y=e.Zero(),this.z=e.Zero(),this.xx=e.Zero(),this.yy=e.Zero(),this.zz=e.Zero(),this.xy=e.Zero(),this.yz=e.Zero(),this.zx=e.Zero()}return t.prototype.addAmbient=function(t){var i=new e(t.r,t.g,t.b);this.xx=this.xx.add(i),this.yy=this.yy.add(i),this.zz=this.zz.add(i)},t.getSphericalPolynomialFromHarmonics=function(i){var n=new t;return n.x=i.L11.scale(1.02333),n.y=i.L1_1.scale(1.02333),n.z=i.L10.scale(1.02333),n.xx=i.L00.scale(.886277).subtract(i.L20.scale(.247708)).add(i.L22.scale(.429043)),n.yy=i.L00.scale(.886277).subtract(i.L20.scale(.247708)).subtract(i.L22.scale(.429043)),n.zz=i.L00.scale(.886277).add(i.L20.scale(.495417)),n.yz=i.L2_1.scale(.858086),n.zx=i.L21.scale(.858086),n.xy=i.L2_2.scale(.858086),n},t}();t.SphericalPolynomial=R;var T=function(){function t(t,i){void 0===t&&(t=e.Zero()),void 0===i&&(i=e.Up()),this.position=t,this.normal=i}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone())},t}();t.PositionNormalVertex=T;var _=function(){function t(t,i,n){void 0===t&&(t=e.Zero()),void 0===i&&(i=e.Up()),void 0===n&&(n=o.Zero()),this.position=t,this.normal=i,this.uv=n}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone(),this.uv.clone())},t}();t.PositionNormalTextureVertex=_;var M=function(){function t(){}return t.Color3=[n.Black(),n.Black(),n.Black()],t.Vector2=[o.Zero(),o.Zero(),o.Zero()],t.Vector3=[e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero()],t.Vector4=[s.Zero(),s.Zero(),s.Zero()],t.Quaternion=[new a(0,0,0,0)],t.Matrix=[u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero()],t}();t.Tmp=M}(BABYLON||(BABYLON={}));';var r;!function(t){var e=function(){function t(){}return t}();t.PropertyChangedInfo=e;var i=function(){function i(){this._propertyChanged=null}return i.prototype.onPropertyChanged=function(t,r,n,s){if(this.propertyChanged.hasObservers()){var o=i.calling?new e:i.pci;o.oldValue=r,o.newValue=n,o.propertyName=t;try{i.calling=!0,this.propertyChanged.notifyObservers(o,s)}finally{i.calling=!1}}},Object.defineProperty(i.prototype,"propertyChanged",{get:function(){return this._propertyChanged||(this._propertyChanged=new t.Observable),this._propertyChanged},enumerable:!0,configurable:!0}),i.pci=new e,i.calling=!1,i}();t.PropertyChangedBase=i}(r||(r={}));var r;!function(t){var e=function(){function t(){this.action=0,this.newItems=new Array,this.removedItems=new Array,this.changedItems=new Array,this.newStartingIndex=-1,this.removedStartingIndex=-1}return Object.defineProperty(t,"clearAction",{get:function(){return t._clearAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"newItemsAction",{get:function(){return t._newItemsAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"removedItemsAction",{get:function(){return t._removedItemsAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"changedItemAction",{get:function(){return t._changedItemAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"replacedArrayAction",{get:function(){return t._replacedArrayAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"lengthChangedAction",{get:function(){return t._lengthChangedAction},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this.action=0,this.newItems.splice(0),this.removedItems.splice(0),this.changedItems.splice(0),this.removedStartingIndex=this.removedStartingIndex=this.changedStartingIndex=0},t._clearAction=1,t._newItemsAction=2,t._removedItemsAction=4,t._replacedArrayAction=8,t._lengthChangedAction=16,t._changedItemAction=32,t}();t.ArrayChanged=e;var i=function(){function t(){}return t}();t.OAWatchedObjectChangedInfo=i;var r=function(r){function n(n,s){r.call(this),this.dci=new e,this._callingArrayChanged=!1,this._array=null!=s?s:new Array,this.dci=new e,this._callingArrayChanged=!1,this._arrayChanged=null,this._callingWatchedObjectChanged=!1,this._watchObjectsPropertyChange=n,this._watchedObjectList=this._watchObjectsPropertyChange?new t.StringDictionary:null,this._woci=new i}return o(n,r),Object.defineProperty(n.prototype,"length",{get:function(){return this._array.length},set:function(t){if(t!==this._array.length){var e=this._array.length;this._array.length=t,this.onPropertyChanged("length",e,this._array.length)}},enumerable:!0,configurable:!0}),n.prototype.getAt=function(t){return this._array[t]},n.prototype.setAt=function(t,i){if(t<0)return!1;var r=t>=this._array.length||void 0===this._array[t],n=0;r?n=this._array.length:this._watchObjectsPropertyChange&&this._removeWatchedElement(this._array[t]),this._array[t]=i,this._watchObjectsPropertyChange&&this._addWatchedElement(i),r&&this.onPropertyChanged("length",n,this._array.length);var s=this.getArrayChangedObject();s&&(s.action=r?e.newItemsAction:e.changedItemAction,r?(s.newItems.splice(0,s.newItems.length,{index:t,value:i}),s.newStartingIndex=t,s.changedItems.splice(0)):(s.newItems.splice(0),s.changedStartingIndex=t,s.changedItems.splice(0,s.changedItems.length,{index:t,value:i})),s.removedItems.splice(0),s.removedStartingIndex=-1,this.callArrayChanged(s))},n.prototype.toString=function(){return this._array.toString()},n.prototype.toLocaleString=function(){return this._array.toLocaleString()},n.prototype.push=function(){for(var t=[],i=0;i<arguments.length;i++)t[i-0]=arguments[i];var r=this._array.length,n=(o=this._array).push.apply(o,t);this._watchObjectsPropertyChange&&this._addWatchedElement.apply(this,t),this.onPropertyChanged("length",r,this._array.length);var s=this.getArrayChangedObject();return s&&(s.action=e.newItemsAction,s.newStartingIndex=r,this.feedNotifArray.apply(this,[s.newItems,r].concat(t)),this.callArrayChanged(s)),n;var o},n.prototype.pop=function(){var t=this._array.length-1,i=this._array.pop();if(i&&this._watchObjectsPropertyChange&&this._removeWatchedElement(i),t!==-1){this.onPropertyChanged("length",this._array.length+1,this._array.length);var r=this.getArrayChangedObject();r&&(r.action=e.removedItemsAction,r.removedStartingIndex=t,this.feedNotifArray(r.removedItems,t,i))}return i},n.prototype.concat=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return new n(this._watchObjectsPropertyChange,(i=this._array).concat.apply(i,t));var i},n.prototype.join=function(t){return this._array.join(t)},n.prototype.reverse=function(){var t=this._array.reverse();return this.getArrayChangedObject().action=e.replacedArrayAction,t},n.prototype.shift=function(){var t=this._array.length,i=this._array.shift();if(this._watchedObjectChanged&&null!=i&&this._removeWatchedElement(i),0!==t){this.onPropertyChanged("length",t,this._array.length);var r=this.getArrayChangedObject();r&&(r.action=e.replacedArrayAction,r.removedItems.splice(0,r.removedItems.length,{index:0,value:i}),r.newItems.splice(0),r.changedItems.splice(0),r.removedStartingIndex=0,this.callArrayChanged(r))}return i},n.prototype.slice=function(t,e){return new n(this._watchObjectsPropertyChange,this._array.slice(t,e))},n.prototype.sort=function(t){var i=this._array.length;if(this._array.sort(t),0!==i){var r=this.getArrayChangedObject();r&&(r.clear(),r.action=e.replacedArrayAction,this.callArrayChanged(r))}},n.prototype.splice=function(t,i){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var s=this._array.length;if(this._watchObjectsPropertyChange)for(var o=t;o<t+i;o++){var a=this._array[o];this._watchObjectsPropertyChange&&null!=a&&this._removeWatchedElement(a)}var h=(c=this._array).splice.apply(c,[t,i].concat(r));this._watchObjectsPropertyChange&&this._addWatchedElement.apply(this,r),s!==this._array.length&&this.onPropertyChanged("length",s,this._array.length);var l=this.getArrayChangedObject();return l&&(l.clear(),l.action=e.replacedArrayAction,this.callArrayChanged(l)),h;var c},n.prototype.unshift=function(){for(var t=[],i=0;i<arguments.length;i++)t[i-0]=arguments[i];var r=this._array.length,n=(o=this._array).unshift.apply(o,t);this._watchObjectsPropertyChange&&this._addWatchedElement.apply(this,t),this.onPropertyChanged("length",r,this._array.length);var s=this.getArrayChangedObject();return s&&(s.clear(),s.action=e.replacedArrayAction,s.newStartingIndex=0,this.feedNotifArray.apply(this,[s.newItems,0].concat(t)),this.callArrayChanged(s)),n;var o},n.prototype.indexOf=function(t,e){return this._array.indexOf(t,e)},n.prototype.lastIndexOf=function(t,e){return this._array.lastIndexOf(t,e)},n.prototype.every=function(t,e){return this._array.every(t,e)},n.prototype.some=function(t,e){return this._array.some(t,e)},n.prototype.forEach=function(t,e){return this._array.forEach(t,e)},n.prototype.map=function(t,e){return this._array.map(t,e)},n.prototype.filter=function(t,e){return this._array.filter(t,e)},n.prototype.reduce=function(t,e){return this._array.reduce(t)},n.prototype.reduceRight=function(t,e){return this._array.reduceRight(t)},Object.defineProperty(n.prototype,"arrayChanged",{get:function(){return this._arrayChanged||(this._arrayChanged=new t.Observable),this._arrayChanged},enumerable:!0,configurable:!0}),n.prototype.getArrayChangedObject=function(){if(this._arrayChanged&&this._arrayChanged.hasObservers()){return this._callingArrayChanged?new e:this.dci}return null},n.prototype.feedNotifArray=function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.splice(0);for(var n=0;n<i.length;n++){var s=this._array[n+e];void 0!==s&&t.push({index:n+e,value:s})}},n.prototype.callArrayChanged=function(t){try{this._callingArrayChanged=!0,this.arrayChanged.notifyObservers(t,t.action)}finally{this._callingArrayChanged=!1}},Object.defineProperty(n.prototype,"watchedObjectChanged",{get:function(){return this._watchedObjectChanged||(this._watchedObjectChanged=new t.Observable),this._watchedObjectChanged},enumerable:!0,configurable:!0}),n.prototype._addWatchedElement=function(){for(var e=this,i=[],r=0;r<arguments.length;r++)i[r-0]=arguments[r];for(var n=function(i){if(i.propertyChanged){var r=i.__ObsArrayObjID__;r||(r=t.Tools.RandomId(),i.__ObsArrayObjID__=r),s._watchedObjectList.add(r,i.propertyChanged.add(function(t,n){e.onWatchedObjectChanged(r,i,t)}))}},s=this,o=0,a=i;o<a.length;o++){n(a[o])}},n.prototype._removeWatchedElement=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];for(var i=0,r=t;i<r.length;i++){var n=r[i],s=n.__ObsArrayObjID__;if(null!=s){var o=this._watchedObjectList.getAndRemove(s);n.propertyChanged.remove(o)}}},n.prototype.onWatchedObjectChanged=function(t,e,r){if(this._watchedObjectChanged&&this._watchedObjectChanged.hasObservers()){var n=this._callingWatchedObjectChanged?new i:this._woci;n.object=e,n.propertyChanged=r;try{this._callingWatchedObjectChanged=!0,this.watchedObjectChanged.notifyObservers(n)}finally{this._callingWatchedObjectChanged=!1}}},n}(t.PropertyChangedBase);t.ObservableArray=r}(r||(r={}));var r;!function(t){var e=function(){function t(){}return Object.defineProperty(t,"clearAction",{get:function(){return t._clearAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"newItemAction",{get:function(){return t._newItemAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"removedItemAction",{get:function(){return t._removedItemAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"itemValueChangedAction",{get:function(){return t._itemValueChangedAction},enumerable:!0,configurable:!0}),Object.defineProperty(t,"replacedAction",{get:function(){return t._replacedAction},enumerable:!0,configurable:!0}),t._clearAction=1,t._newItemAction=2,t._removedItemAction=4,t._itemValueChangedAction=8,t._replacedAction=16,t}();t.DictionaryChanged=e;var i=function(){function t(){}return t}();t.OSDWatchedObjectChangedInfo=i;var r=function(r){function n(n){r.call(this),this._propertyChanged=null,this._dictionaryChanged=null,this.dci=new e,this._callingDicChanged=!1,this._watchedObjectChanged=null,this._callingWatchedObjectChanged=!1,this._woci=new i,this._watchObjectsPropertyChange=n,this._watchedObjectList=this._watchObjectsPropertyChange?new t.StringDictionary:null}return o(n,r),n.prototype.copyFrom=function(t){var i=this,n=this.count;r.prototype.clear.call(this),t.forEach(function(t,e){return i._add(t,e,!1,i._watchObjectsPropertyChange)}),this.onDictionaryChanged(e.replacedAction,null,null,null),this.onPropertyChanged("count",n,this.count)},n.prototype.getOrAddWithFactory=function(t,e){var i=this;return r.prototype.getOrAddWithFactory.call(this,t,function(r){var n=e(t);return i._add(t,n,!0,i._watchObjectsPropertyChange),n})},n.prototype.add=function(t,e){return this._add(t,e,!0,!0)},n.prototype.getAndRemove=function(t){var e=r.prototype.get.call(this,t);return this._remove(t,!0,e),e},n.prototype._add=function(t,i,n,s){return!!r.prototype.add.call(this,t,i)&&(n&&(this.onDictionaryChanged(e.newItemAction,{key:t,value:i},null,null),this.onPropertyChanged("count",this.count-1,this.count)),s&&this._addWatchedElement(t,i),!0)},n.prototype._addWatchedElement=function(t,e){var i=this;e.propertyChanged&&this._watchedObjectList.add(t,e.propertyChanged.add(function(r,n){i.onWatchedObjectChanged(t,e,r)}))},n.prototype._removeWatchedElement=function(t,e){var i=this._watchedObjectList.getAndRemove(t);e.propertyChanged&&e.propertyChanged.remove(i)},n.prototype.set=function(t,i){var n=this.get(t);return this._watchObjectsPropertyChange&&this._removeWatchedElement(t,n),!!r.prototype.set.call(this,t,i)&&(this.onDictionaryChanged(e.itemValueChangedAction,null,null,{key:t,oldValue:n,newValue:i}),this._addWatchedElement(t,i),!0)},n.prototype.remove=function(t){return this._remove(t,!0)},n.prototype._remove=function(t,i,n){return n||(n=this.get(t)),!!n&&(void 0!==r.prototype.remove.call(this,t)&&(this.onDictionaryChanged(e.removedItemAction,null,t,null),this.onPropertyChanged("count",this.count+1,this.count),this._watchObjectsPropertyChange&&this._removeWatchedElement(t,n),!0))},n.prototype.clear=function(){var t=this;this._watchedObjectList.forEach(function(e,i){var r=t.get(e);t._removeWatchedElement(e,r)}),this._watchedObjectList.clear();var i=this.count;r.prototype.clear.call(this),this.onDictionaryChanged(e.clearAction,null,null,null),this.onPropertyChanged("count",i,0)},Object.defineProperty(n.prototype,"propertyChanged",{get:function(){return this._propertyChanged||(this._propertyChanged=new t.Observable),this._propertyChanged},enumerable:!0,configurable:!0}),n.prototype.onPropertyChanged=function(e,i,r,s){if(this._propertyChanged&&this._propertyChanged.hasObservers()){var o=n.callingPropChanged?new t.PropertyChangedInfo:n.pci;o.oldValue=i,o.newValue=r,o.propertyName=e;try{n.callingPropChanged=!0,this.propertyChanged.notifyObservers(o,s)}finally{n.callingPropChanged=!1}}},Object.defineProperty(n.prototype,"dictionaryChanged",{get:function(){return this._dictionaryChanged||(this._dictionaryChanged=new t.Observable),this._dictionaryChanged},enumerable:!0,configurable:!0}),n.prototype.onDictionaryChanged=function(t,i,r,n){if(this._dictionaryChanged&&this._dictionaryChanged.hasObservers()){var s=this._callingDicChanged?new e:this.dci;s.action=t,s.newItem=i,s.removedKey=r,s.changedItem=n;try{this._callingDicChanged=!0,this.dictionaryChanged.notifyObservers(s,t)}finally{this._callingDicChanged=!1}}},Object.defineProperty(n.prototype,"watchedObjectChanged",{get:function(){return this._watchedObjectChanged||(this._watchedObjectChanged=new t.Observable),this._watchedObjectChanged},enumerable:!0,configurable:!0}),n.prototype.onWatchedObjectChanged=function(t,e,r){if(this._watchedObjectChanged&&this._watchedObjectChanged.hasObservers()){var n=this._callingWatchedObjectChanged?new i:this._woci;n.key=t,n.object=e,n.propertyChanged=r;try{this._callingWatchedObjectChanged=!0,this.watchedObjectChanged.notifyObservers(n)}finally{this._callingWatchedObjectChanged=!1}}},n.pci=new t.PropertyChangedInfo,n.callingPropChanged=!1,n}(t.StringDictionary);t.ObservableStringDictionary=r}(r||(r={}));var r;!function(t){var e=function(){function e(){this.radius=0,this.center=t.Vector2.Zero(),this.extent=t.Vector2.Zero()}return e.CreateFromSize=function(t){var i=new e;return e.CreateFromSizeToRef(t,i),i},e.CreateFromRadius=function(t){var i=new e;return e.CreateFromRadiusToRef(t,i),i},e.CreateFromPoints=function(t){var i=new e;return e.CreateFromPointsToRef(t,i),i},e.CreateFromSizeToRef=function(e,i){e||(e=t.Size.Zero()),i.center.x=+e.width/2,i.center.y=+e.height/2,i.extent.x=i.center.x,i.extent.y=i.center.y,i.radius=i.extent.length()},e.CreateFromRadiusToRef=function(t,e){e.center.x=e.center.y=0;var i=+t;e.extent.x=i,e.extent.y=i,e.radius=i},e.CreateFromPointsToRef=function(t,i){for(var r=Number.MAX_VALUE,n=Number.MAX_VALUE,s=Number.MIN_VALUE,o=Number.MIN_VALUE,a=0,h=t;a<h.length;a++){var l=h[a];r=Math.min(l.x,r),s=Math.max(l.x,s),n=Math.min(l.y,n),o=Math.max(l.y,o)}e.CreateFromMinMaxToRef(r,s,n,o,i)},e.CreateFromMinMaxToRef=function(e,i,r,n,s){var o=i-e,a=n-r;s.center=new t.Vector2(e+o/2,r+a/2),s.extent=new t.Vector2(i-s.center.x,n-s.center.y),s.radius=s.extent.length()},e.prototype.clone=function(){var t=new e;return t.center=this.center.clone(),t.radius=this.radius,t.extent=this.extent.clone(),t},e.prototype.clear=function(){this.center.copyFromFloats(0,0),this.radius=0,this.extent.copyFromFloats(0,0)},e.prototype.copyFrom=function(t){this.center.copyFrom(t.center),this.radius=t.radius,this.extent.copyFrom(t.extent)},e.prototype.max=function(){var e=t.Vector2.Zero();return this.maxToRef(e),e},e.prototype.maxToRef=function(t){t.x=this.center.x+this.extent.x,t.y=this.center.y+this.extent.y},e.prototype.transform=function(t){var i=new e;return this.transformToRef(t,i),i},e.prototype.union=function(t){var i=new e;return this.unionToRef(t,i),i},e.prototype.transformToRef=function(i,r){var n=e._transform;n[0].x=this.center.x+this.extent.x,n[0].y=this.center.y+this.extent.y,n[1].x=this.center.x+this.extent.x,n[1].y=this.center.y-this.extent.y,n[2].x=this.center.x-this.extent.x,n[2].y=this.center.y-this.extent.y,n[3].x=this.center.x-this.extent.x,n[3].y=this.center.y+this.extent.y;for(var s=0;s<4;s++)t.Vector2.TransformToRef(n[s],i,n[s]);e.CreateFromPointsToRef(n,r)},e.prototype.unionToRef=function(t,i){var r=Math.max(this.center.x+this.extent.x,t.center.x+t.extent.x),n=Math.max(this.center.y+this.extent.y,t.center.y+t.extent.y),s=Math.min(this.center.x-this.extent.x,t.center.x-t.extent.x),o=Math.min(this.center.y-this.extent.y,t.center.y-t.extent.y);e.CreateFromMinMaxToRef(s,r,o,n,i)},e.prototype.doesIntersect=function(t){var e=t.subtract(this.center);return e.lengthSquared()<=this.radius*this.radius&&(Math.abs(e.x)<=this.extent.x&&Math.abs(e.y)<=this.extent.y)},e._transform=new Array(t.Vector2.Zero(),t.Vector2.Zero(),t.Vector2.Zero(),t.Vector2.Zero()),e}();t.BoundingInfo2D=e}(r||(r={}));var r;!function(t){var e=function(){function e(){this.layoutDirtyOnPropertyChangedMask=0}return e.prototype.updateLayout=function(t){},Object.defineProperty(e.prototype,"isChildPositionAllowed",{get:function(){return!1},enumerable:!0,configurable:!0}),e.prototype.isLocked=function(){return this._isLocked},e.prototype.lock=function(){return!this._isLocked&&(this._isLocked=!0,!0)},e=s([t.className("LayoutEngineBase","BABYLON")],e)}();t.LayoutEngineBase=e;var i=function(e){function i(){e.apply(this,arguments)}return o(i,e),i.prototype.updateLayout=function(e){if(e._isFlagSet(t.SmartPropertyPrim.flagLayoutDirty)){for(var i=0,r=e.children;i<r.length;i++){var n=r[i];this._doUpdate(n)}e._clearFlags(t.SmartPropertyPrim.flagLayoutDirty)}},i.prototype._doUpdate=function(e){e instanceof t.Canvas2D?e.layoutArea=e.actualSize:e.parent instanceof t.Canvas2D?e.layoutArea=e.owner.actualSize:e.layoutArea=e.parent.contentArea},Object.defineProperty(i.prototype,"isChildPositionAllowed",{get:function(){return!0},enumerable:!0,configurable:!0}),i.Singleton=new i,i=s([t.className("CanvasLayoutEngine","BABYLON")],i)}(e);t.CanvasLayoutEngine=i;var r=function(e){function i(){e.call(this),this._isHorizontal=!0,this.layoutDirtyOnPropertyChangedMask=t.Prim2DBase.sizeProperty.flagId}return o(i,e),Object.defineProperty(i,"Horizontal",{get:function(){return i._horizontal||(i._horizontal=new i,i._horizontal.isHorizontal=!0,i._horizontal.lock()),i._horizontal},enumerable:!0,configurable:!0}),Object.defineProperty(i,"Vertical",{get:function(){return i._vertical||(i._vertical=new i,i._vertical.isHorizontal=!1,i._vertical.lock()),i._vertical},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isHorizontal",{get:function(){return this._isHorizontal},set:function(t){this.isLocked()||(this._isHorizontal=t)},enumerable:!0,configurable:!0}),i.prototype.updateLayout=function(e){if(e._isFlagSet(t.SmartPropertyPrim.flagLayoutDirty)){for(var r=0,n=0,s=this.isHorizontal,o=0,a=0,h=e.children;a<h.length;a++){var l=h[a];if(!l._isFlagSet(t.SmartPropertyPrim.flagNoPartOfLayout)){var c=void 0;l._hasMargin?(l.margin.computeWithAlignment(e.layoutArea,l.actualSize,l.marginAlignment,i.dstOffset,i.dstArea,!0),c=i.dstArea.clone(),l.layoutArea=c):(c=l.layoutArea,l.margin.computeArea(l.actualSize,c)),o=Math.max(o,s?c.height:c.width)}}for(var u=0,p=e.children;u<p.length;u++){var l=p[u];if(!l._isFlagSet(t.SmartPropertyPrim.flagNoPartOfLayout)){l.layoutAreaPos=new t.Vector2(r,n);var c=l.layoutArea;s?(r+=c.width,l.layoutArea=new t.Size(c.width,o)):(n+=c.height,l.layoutArea=new t.Size(o,c.height))}}e._clearFlags(t.SmartPropertyPrim.flagLayoutDirty)}},Object.defineProperty(i.prototype,"isChildPositionAllowed",{get:function(){return!1},enumerable:!0,configurable:!0}),i._horizontal=null,i._vertical=null,i.dstOffset=t.Vector4.Zero(),i.dstArea=t.Size.Zero(),i=s([t.className("StackPanelLayoutEngine","BABYLON")],i)}(e);t.StackPanelLayoutEngine=r}(r||(r={}));var r;!function(t){var e=function(){function t(){}return t.prototype.isLocked=function(){return this._isLocked},t.prototype.lock=function(){return!!this._isLocked||(this.onLock(),this._isLocked=!0,!1)},t.prototype.onLock=function(){},t}();t.LockableBase=e;var i=function(e){function i(t,i){void 0===i&&(i=!1),e.call(this),this._color=t,i&&this.lock()}return o(i,e),i.prototype.isTransparent=function(){return this._color&&this._color.a<1},Object.defineProperty(i.prototype,"color",{get:function(){return this._color},set:function(t){this.isLocked()||(this._color=t)},enumerable:!0,configurable:!0}),i.prototype.toString=function(){return this._color.toHexString()},i=s([t.className("SolidColorBrush2D","BABYLON")],i)}(e);t.SolidColorBrush2D=i;var r=function(e){function i(i,r,n,s,o,a){void 0===n&&(n=t.Vector2.Zero()),void 0===s&&(s=0),void 0===o&&(o=1),void 0===a&&(a=!1),e.call(this),this._color1=i,this._color2=r,this._translation=n,this._rotation=s,this._scale=o,a&&this.lock()}return o(i,e),i.prototype.isTransparent=function(){return this._color1&&this._color1.a<1||this._color2&&this._color2.a<1},Object.defineProperty(i.prototype,"color1",{get:function(){return this._color1},set:function(t){this.isLocked()||(this._color1=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"color2",{get:function(){return this._color2},set:function(t){this.isLocked()||(this._color2=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"translation",{get:function(){return this._translation},set:function(t){this.isLocked()||(this._translation=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this.isLocked()||(this._rotation=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scale",{get:function(){return this._scale},set:function(t){this.isLocked()||(this._scale=t)},enumerable:!0,configurable:!0}),i.prototype.toString=function(){return"C1:"+this._color1+";C2:"+this._color2+";T:"+this._translation.toString()+";R:"+this._rotation+";S:"+this._scale+";"},i.BuildKey=function(t,e,i,r,n){return"C1:"+t+";C2:"+e+";T:"+i.toString()+";R:"+r+";S:"+n+";"},i=s([t.className("GradientColorBrush2D","BABYLON")],i)}(e);t.GradientColorBrush2D=r}(r||(r={}));var r;!function(t){function e(t,e,i,r){return void 0===i&&(i=c.MODE_TWOWAY),void 0===r&&(r=c.UPDATESOURCETRIGGER_PROPERTYCHANGED),u._hookProperty(t,e,h.PROPKIND_DYNAMIC,{bindingMode:i,bindingUpdateSourceTrigger:r})}function i(t,e,i,r,n){return void 0===i&&(i=!1),void 0===r&&(r=!1),void 0===n&&(n=!1),u._hookProperty(t,e,h.PROPKIND_MODEL,{typeLevelCompare:i,dirtyBoundingInfo:r,dirtyParentBoundingBox:n})}function r(t,e,i,r,n){return void 0===i&&(i=!1),void 0===r&&(r=!1),void 0===n&&(n=!1),u._hookProperty(t,e,h.PROPKIND_INSTANCE,{typeLevelCompare:i,dirtyBoundingInfo:r,dirtyParentBoundingBox:n})}function n(t,e,i,r,n){return void 0===i&&(i=!1),void 0===r&&(r=!1),void 0===n&&(n=!1),u._hookProperty(t,e,h.PROPKIND_DYNAMIC,{typeLevelCompare:i,dirtyBoundingInfo:r,dirtyParentBoundingBox:n})}var a=function(){function t(){}return t}();t.Prim2DClassInfo=a;var h=function(){function t(){}return t.PROPKIND_MODEL=1,t.PROPKIND_INSTANCE=2,t.PROPKIND_DYNAMIC=3,t}();t.Prim2DPropInfo=h;var l=function(){function e(e,i,r){this._baseClass=e,this._type=i,this._subClasses=new Array,this._levelContent=new t.StringDictionary,this._classContentFactory=r}return Object.defineProperty(e.prototype,"classContent",{get:function(){return this._classContent||(this._classContent=this._classContentFactory(this._baseClass?this._baseClass.classContent:null)),this._classContent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"levelContent",{get:function(){return this._levelContent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fullContent",{get:function(){if(!this._fullContent){for(var e=new t.StringDictionary,i=this;i;)i.levelContent.forEach(function(t,i){return e.add(t,i)}),i=i._baseClass;this._fullContent=e}return this._fullContent},enumerable:!0,configurable:!0}),e.prototype.getLevelOf=function(t){if(t===this._type)return this;var e=Object.getPrototypeOf(t);return this.getOrAddType(Object.getPrototypeOf(e),e)||this.getLevelOf(e),this.getOrAddType(e,t)},e.prototype.getOrAddType=function(t,i){if(t===this._type){for(var r=0,n=this._subClasses;r<n.length;r++){var s=n[r];if(s.type===i)return s.node}var o=new e(this,i,this._classContentFactory),a={type:i,node:o};return this._subClasses.push(a),a.node}for(var h=0,l=this._subClasses;h<l.length;h++){var s=l[h],a=s.node.getOrAddType(t,i);if(a)return a}return null},e.get=function(t){var e=t.__classTreeInfo;return e?e.getLevelOf(t):null},e.getOrRegister=function(t,i){var r=t.__classTreeInfo;return r||(r=new e(null,t,i),t.__classTreeInfo=r),r},e}();t.ClassTreeInfo=l;var c=function(){function e(){this._converter=null,this._mode=e.MODE_DEFAULT,this._uiElementId=null,this._dataSource=null,this._currentDataSource=null,this._propertyPathName=null,this._stringFormat=null,this._updateSourceTrigger=e.UPDATESOURCETRIGGER_PROPERTYCHANGED,this._boundTo=null,this._owner=null,this._updateCounter=0}return Object.defineProperty(e.prototype,"converter",{get:function(){return this._converter},set:function(t){this._converter!==t&&(this._converter=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"mode",{get:function(){return this._mode===e.MODE_DEFAULT?this._boundTo.bindingMode:this._mode},set:function(t){this._mode!==t&&(this._mode=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uiElementId",{get:function(){return this._uiElementId},set:function(t){this._uiElementId!==t&&(this._uiElementId=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dataSource",{get:function(){return this._dataSource},set:function(t){this._dataSource!==t&&(this._dataSource=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"propertyPathName",{get:function(){return this._propertyPathName},set:function(t){this._propertyPathName!==t&&(this._owner,this._propertyPathName=t,this._owner)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stringFormat",{get:function(){return this._stringFormat},set:function(t){this._stringFormat!==t&&(this._stringFormat=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updateSourceTrigger",{get:function(){return this._updateSourceTrigger},set:function(t){this._updateSourceTrigger!==t&&(this._updateSourceTrigger=t)},enumerable:!0,configurable:!0}),e.prototype.canUpdateTarget=function(t){t&&(this._updateCounter=0);var i=this.mode;return i===e.MODE_ONETIME?0===this._updateCounter:i!==e.MODE_ONEWAYTOSOURCE},e.prototype.updateTarget=function(){for(var t=this._getActualDataSource(),e=this.propertyPathName.split("."),i=0,r=e;i<r.length;i++){t=t[r[i]]}this._storeBoundValue(this._owner,t)},e.prototype._storeBoundValue=function(t,i){if(!(++this._updateCounter>1&&this.mode===e.MODE_ONETIME)){var r=i;this._converter&&(r=this._converter(i)),this._stringFormat&&(r=this._stringFormat(r)),t[this._boundTo.name]=r}},e.prototype._getActualDataSource=function(){return this.dataSource?this.dataSource:this.uiElementId?null:this._owner.dataSource},e.prototype._registerDataSource=function(t){var e=this._getActualDataSource();e!==this._currentDataSource&&(this._currentDataSource&&f.unregisterDataSource(this._currentDataSource,this,0),e&&(f.registerDataSource(e,this),t&&this.canUpdateTarget(!0)&&this.updateTarget()),this._currentDataSource=e)},e.prototype._unregisterDataSource=function(){var t=this._getActualDataSource();t&&f.unregisterDataSource(t,this,0)},e.MODE_DEFAULT=1,e.MODE_ONETIME=2,e.MODE_ONEWAY=3,e.MODE_ONEWAYTOSOURCE=4,e.MODE_TWOWAY=5,e.UPDATESOURCETRIGGER_DEFAULT=1,e.UPDATESOURCETRIGGER_PROPERTYCHANGED=2,e.UPDATESOURCETRIGGER_LOSTFOCUS=3,e.UPDATESOURCETRIGGER_EXPLICIT=4,e=s([t.className("DataBinding","BABYLON")],e)}();t.DataBinding=c;var u=function(e){function i(){e.call(this),this._dataSource=null,this._dataSourceObserver=null,this._instanceDirtyFlags=0,this._isDisposed=!1,this._bindings=null,this._hasBinding=0,this._bindingSourceChanged=0,this._disposeObservable=null}return o(i,e),Object.defineProperty(i.prototype,"disposeObservable",{get:function(){return this._disposeObservable||(this._disposeObservable=new t.Observable),this._disposeObservable},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!0,configurable:!0}),i.prototype.dispose=function(){return!this.isDisposed&&(this._disposeObservable&&this._disposeObservable.hasObservers()&&this._disposeObservable.notifyObservers(this),this._isDisposed=!0,!0)},i.prototype.checkPropertiesDirty=function(t){return 0!=(this._instanceDirtyFlags&t)},i.prototype.clearPropertiesDirty=function(t){return this._instanceDirtyFlags&=~t,this._instanceDirtyFlags},i.prototype._resetPropertiesDirty=function(){this._instanceDirtyFlags=0},i.prototype.addExternalData=function(e,i){return this._externalData||(this._externalData=new t.StringDictionary),this._externalData.add(e,i)},i.prototype.getExternalData=function(t){return this._externalData?this._externalData.get(t):null},i.prototype.getOrAddExternalDataWithFactory=function(e,i){return this._externalData||(this._externalData=new t.StringDictionary),this._externalData.getOrAddWithFactory(e,i)},i.prototype.removeExternalData=function(t){return!!this._externalData&&this._externalData.remove(t)},i._hookProperty=function(e,r,n,s){return function(o,a,h){s||(s={});var l=i._createPropInfo(o,a,e,n,s);r&&r(l);var c=h.get,u=h.set,p=void 0!==s.typeLevelCompare&&s.typeLevelCompare;h.set=function(e){if(!u)throw Error("Property '"+l.name+"' of type '"+t.Tools.getFullClassName(this)+"' has no setter defined but was invoked as if it had one.");if(!this.isDisposed){var r=c.call(this);if(!i._checkUnchanged(r,e)){var n=this;u.call(this,e),n._handlePropChanged(r,e,a,l,p)}}}}},i._createPropInfo=function(t,e,i,r,n){var s=l.getOrRegister(t,function(){return new a}),o=s.getLevelOf(t),u=o.levelContent.get(i.toString());if(u)throw new Error("The ID "+i+" is already taken by another property declaration named: "+u.name);return u=new h,u.id=i,u.flagId=Math.pow(2,i),u.kind=r,u.name=e,u.bindingMode=void 0!==n.bindingMode?n.bindingMode:c.MODE_TWOWAY,u.bindingUpdateSourceTrigger=void 0!==n.bindingUpdateSourceTrigger?n.bindingUpdateSourceTrigger:c.UPDATESOURCETRIGGER_PROPERTYCHANGED,u.dirtyBoundingInfo=void 0!==n.dirtyBoundingInfo&&n.dirtyBoundingInfo,u.dirtyParentBoundingInfo=void 0!==n.dirtyParentBoundingBox&&n.dirtyParentBoundingBox,u.typeLevelCompare=void 0!==n.typeLevelCompare&&n.typeLevelCompare,o.levelContent.add(e,u),u},Object.defineProperty(i.prototype,"propDic",{get:function(){if(!this._propInfo){var t=l.get(Object.getPrototypeOf(this));if(!t)throw new Error("Can't access the propDic member in class definition, is this class SmartPropertyPrim based?");this._propInfo=t.fullContent}return this._propInfo},enumerable:!0,configurable:!0}),i._checkUnchanged=function(t,e){if(null===t&&null===e||void 0===t&&void 0===e)return!0;if(null!=t&&null!=e)if("function"==typeof t.equals){if(t.equals(e))return!0}else if(t===e)return!0;return!1},i.prototype._handlePropChanged=function(e,r,n,s,o){var a=i.propChangeGuarding?new t.PropertyChangedInfo:m.propChangedInfo;a.oldValue=e,a.newValue=r,a.propertyName=n;var h=s?s.flagId:-1;try{i.propChangeGuarding=!0,this.propertyChanged.notifyObservers(a,h)}finally{i.propChangeGuarding=!1}},i.prototype._triggerPropertyChanged=function(t,e){this.isDisposed||t&&this._handlePropChanged(void 0,e,t.name,t,t.typeLevelCompare)},Object.defineProperty(i.prototype,"dataSource",{get:function(){return this._getDataSource()},set:function(t){if(this._dataSource!==t){var e=this._dataSource;if(this._dataSource=t,this._bindings&&null!=t)for(var i=0,r=this._bindings;i<r.length;i++){var n=r[i];null!=n&&n._registerDataSource(!0)}this.onPropertyChanged("dataSource",e,t)}},enumerable:!0,configurable:!0}),i.prototype._getDataSource=function(){return this._dataSource},i.prototype.createSimpleDataBinding=function(t,e,i){void 0===i&&(i=c.MODE_DEFAULT);var r=new c;return r.propertyPathName=e,r.mode=i,this.createDataBinding(t,r)},i.prototype.createDataBinding=function(t,e){if(this._bindings||(this._bindings=new Array),!e||null!=e._owner)throw Error("A valid/unused Binding must be passed.");return this.removeDataBinding(t),e._owner=this,e._boundTo=t,this._bindings[t.id]=e,this._hasBinding|=t.flagId,e._registerDataSource(!0),e},i.prototype.removeDataBinding=function(t){return 0!=(this._hasBinding&t.flagId)&&(this._bindings[t.id]._unregisterDataSource(),this._bindings[t.id]=null,this._hasBinding&=~t.flagId,!0)},i.prototype.updateFromDataSource=function(){for(var t=0,e=this._bindings;t<e.length;t++){e[t]}},i.propChangedInfo=new t.PropertyChangedInfo,i.propChangeGuarding=!1,i=s([t.className("SmartPropertyBase","BABYLON")],i)}(t.PropertyChangedBase);t.SmartPropertyBase=u;var p=function(){function t(t,e,i){this.binding=t,this.level=e,this.isLast=i}return t}(),d=function(){function e(e){var i=this;this.monitoredObject=e,this.monitoredIntermediateProperties=new t.StringDictionary,this.observer=this.monitoredObject.propertyChanged.add(function(t,e){i.propertyChangedHandler(t.propertyName,t.oldValue,t.newValue)}),this.boundProperties=new t.StringDictionary,this.monitoredIntermediateMask=0,this.boundPropertiesMask=0}return e.prototype.propertyChangedHandler=function(t,e,i){var r=f._getPropertyID(this.monitoredObject,t),n=r.toString();if(0!=(this.boundPropertiesMask&r))for(var s=this.boundProperties.get(n),o=0,a=s;o<a.length;o++){var h=a[o];h.isLast||(f.unregisterDataSource(this.monitoredObject,h.binding,h.level),f.registerDataSource(h.binding._currentDataSource,h.binding)),h.binding.canUpdateTarget(!1)&&h.binding.updateTarget()}},e}(),f=function(){function e(){}return e.registerDataSource=function(i,r){for(var n=r.propertyPathName.split("."),s=null,o=0,a=i,h=function(i){var h=n[i],l=e._getPropertyID(a,h),c=l.toString(),u=void 0;if(s){var d=s,f=a,m=o;u=s.monitoredIntermediateProperties.getOrAddWithFactory(m.toString(),function(t){return d.monitoredIntermediateMask|=m,e._getMonitoredObjectData(f)})}else u=e._getMonitoredObjectData(a);var _=u,g=u.boundProperties.getOrAddWithFactory(c,function(t){return _.boundPropertiesMask|=l,new Array});t.Tools.first(g,function(t){return t.binding===r})||g.push(new p(r,i,i+1===n.length)),s=u,o=l,a=a[h]},l=0;l<n.length;l++)h(l)},e.unregisterDataSource=function(t,i,r){for(var n=i.propertyPathName.split("."),s=t,o=e._getMonitoredObjectData(s),a=0;a<n.length;a++){var h=n[a],l=e._getPropertyID(s,h),c=l.toString();o=a>=r?e._unregisterBinding(o,l,i):o.monitoredIntermediateProperties.get(c),s=s[h]}},e._unregisterBinding=function(i,r,n){var s=r.toString(),o=null;if(0!=(i.monitoredIntermediateMask&r)&&(o=i.monitoredIntermediateProperties.get(s),i.monitoredIntermediateProperties.remove(s),i.monitoredIntermediateMask&=~r),0!=(i.boundPropertiesMask&r)){var a=i.boundProperties.get(s),h=t.Tools.first(a,function(t){return t.binding===n});if(h){var l=a.indexOf(h);a.splice(l,1)}0===a.length&&(i.boundPropertiesMask&=~r)}if(0===i.boundPropertiesMask&&0===i.monitoredIntermediateMask){i.monitoredObject.propertyChanged.remove(i.observer);var c=e._getObjectId(i.monitoredObject);e._monitoredObjects.remove(c)}return o},e._getMonitoredObjectData=function(t){var i=e._getObjectId(t);return e._monitoredObjects.getOrAddWithFactory(i,function(e){return new d(t)})},e._getObjectId=function(e){var i=e.__bindingHelperObjectId__;return null==i?(i=t.Tools.RandomId(),e.__bindingHelperObjectId__=i,i):i},e._getObjectTypePropertyIDs=function(i){var r=t.Tools.getFullClassName(i);if(!r)throw Error("Types involved in Data Binding must be decorated with the @className decorator");return e._propertiesID.getOrAddWithFactory(r,function(){return new t.StringDictionary})},e._getPropertyID=function(t,i){var r=e._getObjectTypePropertyIDs(t);return r.getOrAddWithFactory(i,function(t){return 1<<r.count})},e._propertiesID=new t.StringDictionary,e._monitoredObjects=new t.StringDictionary,e}(),m=function(e){function i(){e.call(this),this._flags=0,this._modelKey=null,this._levelBoundingInfo=new t.BoundingInfo2D,this._boundingInfo=new t.BoundingInfo2D,this.animations=new Array}return o(i,e),i.prototype.dispose=function(){return!this.isDisposed&&(e.prototype.dispose.call(this),this.animations.splice(0),!0)},i.prototype.getAnimatables=function(){return new Array},Object.defineProperty(i.prototype,"modelKey",{get:function(){var e=this;if(!this._isFlagSet(i.flagModelDirty)&&this._modelKey)return this._modelKey;var r="Class:"+t.Tools.getClassName(this)+";";return this.propDic.forEach(function(i,n){if(n.kind===h.PROPKIND_MODEL){var s=e[n.name];s&&s.constructor===Array&&(s=s[0]?t.Tools.hashCodeFromStream(t.Tools.arrayOrStringFeeder(s)):0);var o="[null]";null!=s&&(o=n.typeLevelCompare?t.Tools.getClassName(s):s instanceof t.BaseTexture?s.uid:s.toString()),r+=n.name+":"+o+";"}}),this._clearFlags(i.flagModelDirty),this._modelKey=r,r},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isDirty",{get:function(){return 0!==this._instanceDirtyFlags||this._areSomeFlagsSet(i.flagModelDirty|i.flagPositioningDirty|i.flagLayoutDirty)},enumerable:!0,configurable:!0}),i.prototype._boundingBoxDirty=function(){if(this._setFlags(i.flagLevelBoundingInfoDirty),this instanceof t.Prim2DBase)for(var e=this;e&&(e._setFlags(i.flagBoundingInfoDirty),e.isSizeAuto&&(e.onPrimitivePropertyDirty(t.Prim2DBase.sizeProperty.flagId),e._setFlags(i.flagPositioningDirty)),!(e instanceof t.Group2D&&e.isRenderableGroup));)e=e.parent},i.prototype._handlePropChanged=function(r,n,s,o,a){if(e.prototype._handlePropChanged.call(this,r,n,s,o,a),o.dirtyBoundingInfo)this._boundingBoxDirty();else if(o.dirtyParentBoundingInfo){var l=this._parent;null!=l&&l._boundingBoxDirty()}if(this instanceof t.Group2D&&this._renderableData&&this.handleGroupChanged(o),this instanceof t.Prim2DBase){var l=this._parent;null!=l&&l.layoutEngine&&0!=(l.layoutEngine.layoutDirtyOnPropertyChangedMask&o.flagId)&&l._setLayoutDirty()}var c=!1;if(a&&null!=r&&null!=n){c=r.__proto__===n.__proto__}if(c||o.kind!==h.PROPKIND_MODEL){if(c||o.kind===h.PROPKIND_INSTANCE||o.kind===h.PROPKIND_DYNAMIC){var u=o.flagId;this.onPrimitivePropertyDirty(u)}}else this.isDirty||this._setFlags(i.flagModelDirty)},i.prototype.onPrimitivePropertyDirty=function(t){this.onPrimBecomesDirty(),this._instanceDirtyFlags|=t},i.prototype.handleGroupChanged=function(t){},i.prototype._resetPropertiesDirty=function(){e.prototype._resetPropertiesDirty.call(this),this._clearFlags(i.flagPrimInDirtyList|i.flagNeedRefresh)},Object.defineProperty(i.prototype,"levelBoundingInfo",{get:function(){return this._isFlagSet(i.flagLevelBoundingInfoDirty)&&(this.updateLevelBoundingInfo(),this._clearFlags(i.flagLevelBoundingInfoDirty)),this._levelBoundingInfo},enumerable:!0,configurable:!0}),i.prototype.updateLevelBoundingInfo=function(){},i.prototype.onPrimBecomesDirty=function(){},i.prototype._isFlagSet=function(t){return 0!=(this._flags&t)},i.prototype._areAllFlagsSet=function(t){return(this._flags&t)===t},i.prototype._areSomeFlagsSet=function(t){return 0!=(this._flags&t)},i.prototype._clearFlags=function(t){this._flags&=~t},i.prototype._setFlags=function(t){var e=this._flags;return this._flags|=t,e},i.prototype._changeFlags=function(t,e){e?this._flags|=t:this._flags&=~t},i.SMARTPROPERTYPRIM_PROPCOUNT=0,i.flagNoPartOfLayout=1,i.flagLevelBoundingInfoDirty=2,i.flagModelDirty=4,i.flagLayoutDirty=8,i.flagLevelVisible=16,i.flagBoundingInfoDirty=32,i.flagIsPickable=64,i.flagIsVisible=128,i.flagVisibilityChanged=256,i.flagPositioningDirty=512,i.flagTrackedGroup=1024,i.flagWorldCacheChanged=2048,i.flagChildrenFlatZOrder=4096,i.flagZOrderDirty=8192,i.flagActualOpacityDirty=16384,i.flagPrimInDirtyList=32768,i.flagIsContainer=65536,i.flagNeedRefresh=131072,i.flagActualScaleDirty=262144,i.flagDontInheritParentScale=524288,i.flagGlobalTransformDirty=1048576,i.flagLayoutBoundingInfoDirty=2097152,i=s([t.className("SmartPropertyPrim","BABYLON")],i)}(u);t.SmartPropertyPrim=m,t.dependencyProperty=e,t.modelLevelProperty=i,t.instanceLevelProperty=r,t.dynamicLevelProperty=n}(r||(r={}));var r;!function(t){var e=function(){function t(){this.forceRefreshPrimitive=!1}return t}();t.PrepareRender2DContext=e;var i=function(){function t(t){this._renderMode=t,this.useInstancing=!1,this.groupInfoPartData=null,this.partDataStartIndex=this.partDataEndIndex=null,this.instancedBuffers=null}return Object.defineProperty(t.prototype,"renderMode",{get:function(){return this._renderMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"RenderModeOpaque",{get:function(){return t._renderModeOpaque},enumerable:!0,configurable:!0}),Object.defineProperty(t,"RenderModeAlphaTest",{get:function(){return t._renderModeAlphaTest},enumerable:!0,configurable:!0}),Object.defineProperty(t,"RenderModeTransparent",{get:function(){return t._renderModeTransparent},enumerable:!0,configurable:!0}),t._renderModeOpaque=1,t._renderModeAlphaTest=2,t._renderModeTransparent=3,t}();t.Render2DContext=i;var r=function(){function e(){this.primitivePointerPos=t.Vector2.Zero(),this.tilt=t.Vector2.Zero(),this.cancelBubble=!1}return Object.defineProperty(e,"PointerOver",{get:function(){return e._pointerOver},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerEnter",{get:function(){return e._pointerEnter},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerDown",{get:function(){return e._pointerDown},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerMouseWheel",{get:function(){return e._pointerMouseWheel},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerMove",{get:function(){return e._pointerMove},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerUp",{get:function(){return e._pointerUp},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerOut",{get:function(){return e._pointerOut},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerLeave",{get:function(){return e._pointerLeave},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerGotCapture",{get:function(){return e._pointerGotCapture},enumerable:!0,configurable:!0}),Object.defineProperty(e,"PointerLostCapture",{get:function(){return e._pointerLostCapture},enumerable:!0,configurable:!0}),Object.defineProperty(e,"MouseWheelPrecision",{get:function(){return e._mouseWheelPrecision},enumerable:!0,configurable:!0}),e.prototype.updateRelatedTarget=function(t,e){this.relatedTarget=t,this.relatedTargetPointerPos=e},e.getEventTypeName=function(t){switch(t){case e.PointerOver:return"PointerOver";case e.PointerEnter:return"PointerEnter";case e.PointerDown:return"PointerDown";case e.PointerMouseWheel:return"PointerMouseWheel";case e.PointerMove:return"PointerMove";case e.PointerUp:return"PointerUp";case e.PointerOut:return"PointerOut";case e.PointerLeave:return"PointerLeave";case e.PointerGotCapture:return"PointerGotCapture";case e.PointerLostCapture:return"PointerLostCapture"}},e._pointerOver=1,e._pointerEnter=2,e._pointerDown=4,e._pointerMouseWheel=8,e._pointerMove=16,e._pointerUp=32,e._pointerOut=64,e._pointerLeave=128,e._pointerGotCapture=256,e._pointerLostCapture=512,e._mouseWheelPrecision=3,e}();t.PrimitivePointerInfo=r;var n=function(){function e(t){this._changedCallback=t,this._horizontal=e.AlignLeft,this._vertical=e.AlignBottom}return Object.defineProperty(e,"AlignLeft",{get:function(){return e._AlignLeft},enumerable:!0,configurable:!0}),Object.defineProperty(e,"AlignTop",{get:function(){return e._AlignTop},enumerable:!0,configurable:!0}),Object.defineProperty(e,"AlignRight",{get:function(){return e._AlignRight},enumerable:!0,configurable:!0}),Object.defineProperty(e,"AlignBottom",{get:function(){return e._AlignBottom},enumerable:!0,configurable:!0}),Object.defineProperty(e,"AlignCenter",{get:function(){return e._AlignCenter},enumerable:!0,configurable:!0}),Object.defineProperty(e,"AlignStretch",{get:function(){return e._AlignStretch},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"horizontal",{get:function(){return this._horizontal},set:function(t){this._horizontal!==t&&(this._horizontal=t,this.onChangeCallback())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vertical",{get:function(){return this._vertical},set:function(t){this._vertical!==t&&(this._vertical=t,this.onChangeCallback())},enumerable:!0,configurable:!0}),e.prototype.onChangeCallback=function(){this._changedCallback&&this._changedCallback()},e.prototype.setHorizontal=function(t){switch(t.trim().toLocaleLowerCase()){case"left":return void(this.horizontal=e.AlignLeft);case"right":return void(this.horizontal=e.AlignRight);case"center":return void(this.horizontal=e.AlignCenter);case"stretch":return void(this.horizontal=e.AlignStretch)}},e.prototype.setVertical=function(t){switch(t.trim().toLocaleLowerCase()){case"top":return void(this.vertical=e.AlignTop);case"bottom":return void(this.vertical=e.AlignBottom);case"center":return void(this.vertical=e.AlignCenter);case"stretch":return void(this.vertical=e.AlignStretch)}},e.prototype.fromString=function(t){var e=t.trim().split(",");if(1===e.length)this.setHorizontal(e[0]),this.setVertical(e[0]);else for(var i=0,r=e;i<r.length;i++){var n=r[i];n=n.toLocaleLowerCase().trim();var s=n.indexOf("h:");s===-1&&(s=n.indexOf("horizontal:")),s===-1?(s=n.indexOf("v:"),s===-1&&(s=n.indexOf("vertical:")),s===-1||(n=n.substr(n.indexOf(":")+1),this.setVertical(n))):(n=n.substr(n.indexOf(":")+1),this.setHorizontal(n))}},e.prototype.copyFrom=function(t){this._horizontal=t._horizontal,this._vertical=t._vertical,this.onChangeCallback()},Object.defineProperty(e.prototype,"isDefault",{get:function(){return this.horizontal===e.AlignLeft&&this.vertical===e.AlignBottom},enumerable:!0,configurable:!0}),e._AlignLeft=1,e._AlignTop=1,e._AlignRight=2,e._AlignBottom=2,e._AlignCenter=3,e._AlignStretch=4,e=s([t.className("PrimitiveAlignment","BABYLON")],e)}();t.PrimitiveAlignment=n;var a=function(){function t(t,e){this.prim=t,this.intersectionLocation=e}return t}();t.PrimitiveIntersectedInfo=a;var h=function(){function e(t,i){this._parentAccess=t,this._changedCallback=i,this._pixels=new Array(4),this._percentages=new Array(4),this._setType(0,e.Auto),this._setType(1,e.Auto),this._setType(2,e.Auto),this._setType(3,e.Auto),this._pixels[0]=0,this._pixels[1]=0,this._pixels[2]=0,this._pixels[3]=0}return e.prototype.fromString=function(t){this._clear();var i=t.trim().split(",");if(1===i.length&&t.indexOf(":")===-1)return this._setStringValue(i[0],0,!1),this._setStringValue(i[0],1,!1),this._setStringValue(i[0],2,!1),this._setStringValue(i[0],3,!1),void this.onChangeCallback();for(var r=!1,n=0,s=i;n<s.length;n++){var o=s[n];r=this._extractString(o,!1)||r}if(!r)throw new Error("Can't parse the string to create a PrimitiveMargin object, format must be: 'top: <value>, left:<value>, right:<value>, bottom:<value>");0==(15&this._flags)&&(this._flags|=e.Pixel<<0),0==(240&this._flags)&&(this._flags|=e.Pixel<<4),0==(3840&this._flags)&&(this._flags|=e.Pixel<<8),0==(61440&this._flags)&&(this._flags|=e.Pixel<<12),this.onChangeCallback()},e.prototype.fromStrings=function(t,e,i,r){return this._clear(),this._setStringValue(t,0,!1),this._setStringValue(e,1,!1),this._setStringValue(i,2,!1),this._setStringValue(r,3,!1),this.onChangeCallback(),this},e.prototype.fromPixels=function(t,e,i,r){return this._clear(),this._pixels[0]=t,this._pixels[1]=e,this._pixels[2]=i,this._pixels[3]=r,this.onChangeCallback(),this},e.prototype.fromUniformPixels=function(t){return this._clear(),this._pixels[0]=t,this._pixels[1]=t,this._pixels[2]=t,this._pixels[3]=t,this.onChangeCallback(),this},e.prototype.copyFrom=function(t){this._clear();for(var e=0;e<4;e++)this._pixels[e]=t._pixels[e],this._percentages[e]=t._percentages[e];this._flags=t._flags,this.onChangeCallback()},e.prototype.auto=function(){return this._clear(),this._flags=e.Auto<<0|e.Auto<<4|e.Auto<<8|e.Auto<<12,this._pixels[0]=0,this._pixels[1]=0,this._pixels[2]=0,this._pixels[3]=0,this.onChangeCallback(),this},e.prototype._clear=function(){this._flags=0,this._pixels[0]=0,this._pixels[1]=0,this._pixels[2]=0,this._pixels[3]=0,this._percentages[0]=null,this._percentages[1]=null,this._percentages[2]=null,this._percentages[3]=null},e.prototype._extractString=function(t,e){var i=t.trim().toLocaleLowerCase();return 0===i.indexOf("top:")?(i=i.substr(4).trim(),this._setStringValue(i,0,e)):0===i.indexOf("left:")?(i=i.substr(5).trim(),this._setStringValue(i,1,e)):0===i.indexOf("right:")?(i=i.substr(6).trim(),this._setStringValue(i,2,e)):0===i.indexOf("bottom:")&&(i=i.substr(7).trim(),this._setStringValue(i,3,e))},e.prototype._setStringValue=function(t,i,r){var n=t.trim().toLocaleLowerCase();if("auto"===n){if(this._isType(i,e.Auto))return!0;this._setType(i,e.Auto),this._pixels[i]=0,r&&this.onChangeCallback()}else{if("inherit"!==n){var s=n.indexOf("%");if(s!==-1){var o=n.substr(0,s),a=Math.round(Number(o))/100;return!(!this._isType(i,e.Percentage)||this._percentages[i]!==a)||(this._setType(i,e.Percentage),!isNaN(a)&&(this._percentages[i]=a,r&&this.onChangeCallback(),!0))}var h=void 0;s=n.indexOf("px"),h=s!==-1?n.substr(0,s).trim():n;var l=Number(h);return!(!this._isType(i,e.Pixel)||this._pixels[i]!==l)||!isNaN(l)&&(this._pixels[i]=l,this._setType(i,e.Pixel),r&&this.onChangeCallback(),!0)}if(this._isType(i,e.Inherit))return!0;this._setType(i,e.Inherit),this._pixels[i]=null,r&&this.onChangeCallback()}},e.prototype._setPixels=function(t,i,r){t=Math.round(t),this._isType(i,e.Pixel)&&this._pixels[i]===t||(this._setType(i,e.Pixel),this._pixels[i]=t,r&&this.onChangeCallback())},e.prototype._setPercentage=function(t,i,r){t=Math.min(1,t),t=Math.max(0,t),t=Math.round(100*t)/100,this._isType(i,e.Percentage)&&this._percentages[i]===t||(this._setType(i,e.Percentage),this._percentages[i]=t,r&&this.onChangeCallback())},e.prototype._getStringValue=function(t){switch(this._flags>>4*t&15){case e.Auto:return"auto";case e.Pixel:return this._pixels[t]+"px";case e.Percentage:return 100*this._percentages[t]+"%";case e.Inherit:return"inherit"}return""},e.prototype._isType=function(t,e){return(this._flags>>4*t&15)===e},e.prototype._getType=function(t,i){var r=this._flags>>4*t&15;if(i&&r===e.Inherit){var n=this._parentAccess();return n?n._getType(t,!0):e.Auto}return r},e.prototype._setType=function(t,e){this._flags&=~(15<<4*t),this._flags|=e<<4*t},e.prototype.setTop=function(t){"string"==typeof t?this._setStringValue(t,0,!0):this.topPixels=t},e.prototype.setLeft=function(t){"string"==typeof t?this._setStringValue(t,1,!0):this.leftPixels=t},e.prototype.setRight=function(t){"string"==typeof t?this._setStringValue(t,2,!0):this.rightPixels=t},e.prototype.setBottom=function(t){"string"==typeof t?this._setStringValue(t,3,!0):this.bottomPixels=t},Object.defineProperty(e.prototype,"top",{get:function(){return this._getStringValue(0)},set:function(t){this._setStringValue(t,0,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"left",{get:function(){return this._getStringValue(1)},set:function(t){this._setStringValue(t,1,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"right",{get:function(){return this._getStringValue(2)},set:function(t){this._setStringValue(t,2,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bottom",{get:function(){return this._getStringValue(3)},set:function(t){this._setStringValue(t,3,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"topPixels",{get:function(){return this._pixels[0]},set:function(t){this._setPixels(t,0,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftPixels",{get:function(){return this._pixels[1]},set:function(t){this._setPixels(t,1,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightPixels",{get:function(){return this._pixels[2]},set:function(t){this._setPixels(t,2,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bottomPixels",{get:function(){return this._pixels[3]},set:function(t){this._setPixels(t,3,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"topPercentage",{get:function(){return this._percentages[0]},set:function(t){this._setPercentage(t,0,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftPercentage",{get:function(){return this._percentages[1]},set:function(t){this._setPercentage(t,1,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightPercentage",{get:function(){return this._percentages[2]},set:function(t){this._setPercentage(t,2,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bottomPercentage",{get:function(){return this._percentages[3]},set:function(t){this._setPercentage(t,3,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"topMode",{get:function(){return this._getType(0,!1)},set:function(t){this._setType(0,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftMode",{get:function(){return this._getType(1,!1)},set:function(t){this._setType(1,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightMode",{get:function(){return this._getType(2,!1)},set:function(t){this._setType(2,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bottomMode",{get:function(){return this._getType(3,!1)},set:function(t){this._setType(3,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isDefault",{get:function(){return 4369===this._flags},enumerable:!0,configurable:!0}),e.prototype._computePixels=function(t,i,r){var n=this._getType(t,!1);if(n===e.Inherit)return void this._parentAccess()._computePixels(t,i,r);if(n===e.Percentage){var s=(0===t||3===t?i.height:i.width)*this._percentages[t];this._pixels[t]=s,r&&this.onChangeCallback()}},e.prototype.onChangeCallback=function(){this._changedCallback&&this._changedCallback()},e.prototype.computeWithAlignment=function(t,i,r,s,o,a){void 0===a&&(a=!1);var h=this._getType(0,!0),l=this._getType(1,!0),c=this._getType(2,!0),u=this._getType(3,!0),p=i&&null!=i.width,d=i&&null!=i.height,f=p?i.width:0,m=d?i.height:0,_=h===e.Auto,g=l===e.Auto,y=c===e.Auto,v=u===e.Auto;switch(r.horizontal){case n.AlignLeft:g?s.x=0:(this._computePixels(1,t,!0),s.x=this.leftPixels),o.width=f,a&&(o.width+=this.leftPixels),s.z=t.width-(s.x+f);break;case n.AlignRight:y?s.x=Math.round(t.width-f):(this._computePixels(2,t,!0),s.x=Math.round(t.width-(f+this.rightPixels))),o.width=f,a&&(o.width+=this.rightPixels),s.z=this.rightPixels;break;case n.AlignStretch:g?s.x=0:(this._computePixels(1,t,!0),s.x=this.leftPixels);var x=0;y||(this._computePixels(2,t,!0),x=this.rightPixels),o.width=t.width-(s.x+x),s.z=this.rightPixels;break;case n.AlignCenter:g||this._computePixels(1,t,!0),y||this._computePixels(2,t,!0);var b=(g?0:this.leftPixels)-(y?0:this.rightPixels);s.x=Math.round((t.width-f)/2+b),o.width=f,s.z=t.width-(s.x+f)}switch(r.vertical){case n.AlignTop:_?s.y=t.height-m:(this._computePixels(0,t,!0),s.y=Math.round(t.height-(m+this.topPixels))),o.height=m,a&&(o.height+=this.topPixels),s.w=this.topPixels;break;case n.AlignBottom:v?s.y=0:(this._computePixels(3,t,!0),s.y=this.bottomPixels),o.height=m,a&&(o.height+=this.bottomPixels),s.w=t.height-(s.y+m);break;case n.AlignStretch:v?s.y=0:(this._computePixels(3,t,!0),s.y=this.bottomPixels);var P=0;_||(this._computePixels(0,t,!0),P=this.topPixels),o.height=t.height-(s.y+P),s.w=this.topPixels;break;case n.AlignCenter:_||this._computePixels(0,t,!0),v||this._computePixels(3,t,!0);var b=(v?0:this.bottomPixels)-(_?0:this.topPixels);s.y=Math.round((t.height-m)/2+b),o.height=m,s.w=t.height-(s.y+m)}},e.prototype.compute=function(t,e,i){this._computePixels(0,t,!0),this._computePixels(1,t,!0),this._computePixels(2,t,!0),this._computePixels(3,t,!0),e.x=this.leftPixels,i.width=t.width-(e.x+this.rightPixels),e.y=this.bottomPixels,i.height=t.height-(e.y+this.topPixels),e.z=this.rightPixels,e.w=this.topPixels},e.prototype.computeArea=function(t,e){this._computePixels(0,t,!0),this._computePixels(1,t,!0),this._computePixels(2,t,!0),this._computePixels(3,t,!0),e.width=this.leftPixels+t.width+this.rightPixels,e.height=this.bottomPixels+t.height+this.topPixels},e.prototype.enlarge=function(t,e,i){this._computePixels(0,t,!0),this._computePixels(1,t,!0),this._computePixels(2,t,!0),this._computePixels(3,t,!0),e.x=this.leftPixels,i.width=t.width+(e.x+this.rightPixels),e.y=this.bottomPixels,i.height=t.height+(e.y+this.topPixels),e.z=this.rightPixels,e.w=this.topPixels},e.Auto=1,e.Inherit=2,e.Percentage=4,e.Pixel=8,e=s([t.className("PrimitiveThickness","BABYLON")],e)}();t.PrimitiveThickness=h;var l=function(){function e(){this.findFirstOnly=!1,this.intersectHidden=!1,this.pickPosition=t.Vector2.Zero()}return Object.defineProperty(e.prototype,"isIntersected",{get:function(){return this.intersectedPrimitives&&this.intersectedPrimitives.length>0},enumerable:!0,configurable:!0}),e.prototype.isPrimIntersected=function(t){for(var e=0,i=this.intersectedPrimitives;e<i.length;e++){var r=i[e];if(r.prim===t)return r.intersectionLocation}return null},e.prototype._exit=function(t){t&&(this._globalPickPosition=null)},e}();t.IntersectInfo2D=l;var c=function(e){function i(r){null==r&&(r={}),e.call(this);var n,s;if(i._isCanvasInit)n=this,s=null,this._canvasPreInit(r);else if(null!=r.parent){if(s=r.parent,!(n=r.parent.owner))throw new Error("Parent "+s.id+" of "+r.id+" doesn't have a valid owner!");if(!(this instanceof t.Group2D||this instanceof t.Sprite2D&&null!=r.id&&0===r.id.indexOf("__cachedSpriteOfGroup__")||n.cachingStrategy!==t.Canvas2D.CACHESTRATEGY_TOPLEVELGROUPS||s!==n))throw new Error("Can't create a primitive with the canvas as direct parent when the caching strategy is TOPLEVELGROUPS. You need to create a Group below the canvas and use it as the parent for the primitive")}this._layoutEngine=t.CanvasLayoutEngine.Singleton,this._size=null,this._scale=new t.Vector2(1,1),this._actualSize=null,this._boundingSize=t.Size.Zero(),this._layoutArea=t.Size.Zero(),this._layoutAreaPos=null,this._layoutBoundingInfo=null,this._marginOffset=t.Vector4.Zero(),this._paddingOffset=t.Vector4.Zero(),this._parentPaddingOffset=t.Vector2.Zero(),this._parentContentArea=t.Size.Zero(),this._lastAutoSizeArea=t.Size.Zero(),this._contentArea=new t.Size(null,null),this._pointerEventObservable=new t.Observable,this._boundingInfo=new t.BoundingInfo2D,this._owner=n,this._parent=null,this._margin=null,this._padding=null,this._marginAlignment=null,this._id=r.id,this._children=new Array,this._localTransform=new t.Matrix,this._globalTransform=null,this._invGlobalTransform=null,this._globalTransformProcessStep=0,this._globalTransformStep=0,this._renderGroup=null,this._primLinearPosition=0,this._manualZOrder=null,this._zOrder=0,this._zMax=0,this._firstZDirtyIndex=i._bigInt,this._actualOpacity=0,this._actualScale=t.Vector2.Zero(),this._displayDebugAreas=!1,this._debugAreaGroup=null;var o=!0,a=!0;if(void 0!==r.isPickable&&(o=r.isPickable),void 0!==r.isContainer&&(a=r.isContainer),r.dontInheritParentScale&&this._setFlags(t.SmartPropertyPrim.flagDontInheritParentScale),this._setFlags((o?t.SmartPropertyPrim.flagIsPickable:0)|t.SmartPropertyPrim.flagBoundingInfoDirty|t.SmartPropertyPrim.flagActualOpacityDirty|(a?t.SmartPropertyPrim.flagIsContainer:0)|t.SmartPropertyPrim.flagActualScaleDirty|t.SmartPropertyPrim.flagLayoutBoundingInfoDirty),null!=r.opacity?this._opacity=r.opacity:this._opacity=1,this._updateRenderMode(),r.childrenFlatZOrder&&this._setFlags(t.SmartPropertyPrim.flagChildrenFlatZOrder),null!=s&&(s.addChild(this),this._hierarchyDepth=s._hierarchyDepth+1,this._patchHierarchy(s.owner)),this.owner&&this instanceof t.Group2D){this.detectGroupStates()}if(null!=r.children)for(var h=0,l=r.children;h<l.length;h++){var c=l[h];this.addChild(c),null!=this.owner&&c._patchHierarchy(this.owner)}if(null!=r.zOrder&&(this.zOrder=r.zOrder),null!=r.position?this.position=r.position:null!=r.x||null!=r.y?this.position=new t.Vector2(r.x||0,r.y||0):this._position=null,this.rotation=null==r.rotation?0:r.rotation,null!=r.scale?this.scale=r.scale:(null!=r.scaleX&&(this.scaleX=r.scaleX),null!=r.scaleY&&(this.scaleY=r.scaleY)),this.levelVisible=null==r.isVisible||r.isVisible,this.origin=r.origin||new t.Vector2(.5,.5),null!=r.layoutEngine)if("string"==typeof r.layoutEngine){var u=r.layoutEngine.toLocaleLowerCase().trim();"canvas"===u||"canvaslayoutengine"===u?this.layoutEngine=t.CanvasLayoutEngine.Singleton:0===u.indexOf("stackpanel")||0===u.indexOf("horizontalstackpanel")?this.layoutEngine=t.StackPanelLayoutEngine.Horizontal:0===u.indexOf("verticalstackpanel")&&(this.layoutEngine=t.StackPanelLayoutEngine.Vertical)}else r.layoutEngine instanceof t.LayoutEngineBase&&(this.layoutEngine=r.layoutEngine);r.marginTop&&this.margin.setTop(r.marginTop),r.marginLeft&&this.margin.setLeft(r.marginLeft),r.marginRight&&this.margin.setRight(r.marginRight),r.marginBottom&&this.margin.setBottom(r.marginBottom),r.margin&&("string"==typeof r.margin?this.margin.fromString(r.margin):this.margin.fromUniformPixels(r.margin)),r.marginHAlignment&&(this.marginAlignment.horizontal=r.marginHAlignment),r.marginVAlignment&&(this.marginAlignment.vertical=r.marginVAlignment),r.marginAlignment&&this.marginAlignment.fromString(r.marginAlignment),r.paddingTop&&this.padding.setTop(r.paddingTop),r.paddingLeft&&this.padding.setLeft(r.paddingLeft),r.paddingRight&&this.padding.setRight(r.paddingRight),r.paddingBottom&&this.padding.setBottom(r.paddingBottom),r.padding&&this.padding.fromString(r.padding),this._parentLayoutDirty(),this._positioningDirty()}return o(i,e),Object.defineProperty(i.prototype,"actionManager",{get:function(){return this._actionManager||(this._actionManager=new t.ActionManager(this.owner.scene)),this._actionManager},enumerable:!0,configurable:!0}),i.prototype.traverseUp=function(t){for(var e=this;null!=e;){if(t(e))return e;e=e._parent}return null},Object.defineProperty(i.prototype,"owner",{get:function(){return this._owner},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"id",{get:function(){return this._id},set:function(t){if(this._id!==t){var e=this._id;this.onPropertyChanged("id",e,this._id)}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualPosition",{get:function(){return null!=this._actualPosition?this._actualPosition:null!=this._position?this._position:i._nullPosition},set:function(t){this._actualPosition=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualX",{get:function(){return this.actualPosition.x},set:function(t){this._actualPosition.x=t,this._triggerPropertyChanged(i.actualPositionProperty,this._actualPosition)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualY",{get:function(){return this.actualPosition.y},set:function(t){this._actualPosition.y=t,this._triggerPropertyChanged(i.actualPositionProperty,this._actualPosition)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"position",{get:function(){return this._position||(this._position=t.Vector2.Zero()),this._position},set:function(t){this._checkPositionChange()&&(this._position=t,this._triggerPropertyChanged(i.actualPositionProperty,t))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"x",{get:function(){return this._position?this._position.x:null},set:function(e){this._checkPositionChange()&&(this._position||(this._position=t.Vector2.Zero()),this._position.x!==e&&(this._position.x=e,this._triggerPropertyChanged(i.positionProperty,e),this._triggerPropertyChanged(i.actualPositionProperty,e)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this._position?this._position.y:null},set:function(e){this._checkPositionChange()&&(this._position||(this._position=t.Vector2.Zero()),this._position.y!==e&&(this._position.y=e,this._triggerPropertyChanged(i.positionProperty,e),this._triggerPropertyChanged(i.actualPositionProperty,e)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"size",{get:function(){if(!this._size||null==this._size.width||null==this._size.height){if(i.boundinbBoxReentrency)return i.nullSize;if(!this._isFlagSet(t.SmartPropertyPrim.flagBoundingInfoDirty))return this._boundingSize;i.boundinbBoxReentrency=!0;this.boundingInfo;return i.boundinbBoxReentrency=!1,this._boundingSize}return this._size},set:function(t){this._size=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this.size?this.size.width:null},set:function(e){this.size&&this.size.width===e||(this.size?this.size.width=e:this.size=new t.Size(e,0),this._triggerPropertyChanged(i.sizeProperty,e),this._positioningDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this.size?this.size.height:null},set:function(e){this.size&&this.size.height===e||(this.size?this.size.height=e:this.size=new t.Size(0,e),this._triggerPropertyChanged(i.sizeProperty,e),this._positioningDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotation",{get:function(){return this._rotation},set:function(t){this._rotation=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scale",{get:function(){return this._scale.x},set:function(e){this._scale.x=this._scale.y=e,this._setFlags(t.SmartPropertyPrim.flagActualScaleDirty),this._spreadActualScaleDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualSize",{get:function(){return this._actualSize?this._actualSize:this._size},set:function(t){this._actualSize.equals(t)||(this._actualSize=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualWidth",{get:function(){return this.actualSize.width},set:function(t){this._actualSize.width=t,this._triggerPropertyChanged(i.actualSizeProperty,this._actualSize)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualHeight",{get:function(){return this.actualSize.height},set:function(t){this._actualSize.height=t,this._triggerPropertyChanged(i.actualPositionProperty,this._actualSize)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualZOffset",{get:function(){return null!=this._manualZOrder?this._manualZOrder:(this._isFlagSet(t.SmartPropertyPrim.flagZOrderDirty)&&this._updateZOrder(),1-this._zOrder)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minSize",{get:function(){return this._minSize},set:function(t){this._minSize&&t&&this._minSize.equals(t)||(this._minSize=t,this._parentLayoutDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxSize",{get:function(){return this._maxSize},set:function(t){this._maxSize&&t&&this._maxSize.equals(t)||(this._maxSize=t,this._parentLayoutDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"origin",{get:function(){return this._origin},set:function(t){this._origin=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"levelVisible",{get:function(){return this._isFlagSet(t.SmartPropertyPrim.flagLevelVisible)},set:function(e){this._changeFlags(t.SmartPropertyPrim.flagLevelVisible,e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isVisible",{get:function(){return this._isFlagSet(t.SmartPropertyPrim.flagIsVisible)},set:function(e){this._changeFlags(t.SmartPropertyPrim.flagIsVisible,e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"zOrder",{get:function(){return this._manualZOrder},set:function(t){this._manualZOrder!==t&&(this._manualZOrder=t,this.onZOrderChanged(),this._actualZOrderChangedObservable&&this._actualZOrderChangedObservable.hasObservers()&&this._actualZOrderChangedObservable.notifyObservers(t))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isManualZOrder",{get:function(){return null!=this._manualZOrder},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"margin",{get:function(){var t=this;return this._margin||(this._margin=new h(function(){return t.parent?t.parent.margin:null},function(){return t._positioningDirty()})),this._margin},set:function(t){this.margin.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasMargin",{get:function(){return null!==this._margin&&!this._margin.isDefault||null!==this._marginAlignment&&!this._marginAlignment.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"padding",{get:function(){var t=this;return this._padding||(this._padding=new h(function(){return t.parent?t.parent.padding:null},function(){return t._positioningDirty()})),this._padding},set:function(t){this.padding.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasPadding",{get:function(){return null!==this._padding&&!this._padding.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"marginAlignment",{get:function(){var t=this;return this._marginAlignment||(this._marginAlignment=new n(function(){return t._positioningDirty()})),this._marginAlignment},set:function(t){this.marginAlignment.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasMarginAlignment",{get:function(){return null!==this._marginAlignment&&!this._marginAlignment.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"opacity",{get:function(){return this._opacity},set:function(e){e<0?e=0:e>1&&(e=1),this._opacity!==e&&(this._opacity=e,this._setFlags(t.SmartPropertyPrim.flagActualOpacityDirty),this._spreadActualOpacityChanged(),this._updateRenderMode())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleX",{get:function(){return this._scale.x},set:function(e){this._scale.x=e,this._setFlags(t.SmartPropertyPrim.flagActualScaleDirty),this._spreadActualScaleDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleY",{get:function(){return this._scale.y},set:function(e){this._scale.y=e,this._setFlags(t.SmartPropertyPrim.flagActualScaleDirty),this._spreadActualScaleDirty()},enumerable:!0,configurable:!0}),i.prototype._spreadActualScaleDirty=function(){for(var e=0,i=this._children;e<i.length;e++){var r=i[e];r._setFlags(t.SmartPropertyPrim.flagActualScaleDirty),r._spreadActualScaleDirty()}},Object.defineProperty(i.prototype,"actualScale",{get:function(){if(this._isFlagSet(t.SmartPropertyPrim.flagActualScaleDirty)){for(var e=this._isFlagSet(t.SmartPropertyPrim.flagDontInheritParentScale)?null:this.parent,i=this.scaleX,r=this.scaleY;e;)i*=e.scaleX,r*=e.scaleY,e=e._isFlagSet(t.SmartPropertyPrim.flagDontInheritParentScale)?null:e.parent;this._actualScale.copyFromFloats(i,r),this._clearFlags(t.SmartPropertyPrim.flagActualScaleDirty)}return this._actualScale},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualScaleX",{get:function(){return this.actualScale.x},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualScaleY",{get:function(){return this.actualScale.y},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualOpacity",{get:function(){if(this._isFlagSet(t.SmartPropertyPrim.flagActualOpacityDirty)){for(var e=this.parent,i=this.opacity;e;)i*=e.opacity,e=e.parent;this._actualOpacity=i,this._clearFlags(t.SmartPropertyPrim.flagActualOpacityDirty)}return this._actualOpacity},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"layoutEngine",{get:function(){return this._layoutEngine||(this._layoutEngine=t.CanvasLayoutEngine.Singleton),this._layoutEngine},set:function(t){this._layoutEngine!==t&&this._changeLayoutEngine(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"layoutArea",{get:function(){return this._layoutArea},set:function(e){this._layoutArea.equals(e)||(this._positioningDirty(),this.parent&&this.parent._setFlags(t.SmartPropertyPrim.flagLayoutBoundingInfoDirty|t.SmartPropertyPrim.flagGlobalTransformDirty),this._layoutArea=e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"layoutAreaPos",{get:function(){return this._layoutAreaPos||(this._layoutAreaPos=t.Vector2.Zero()),this._layoutAreaPos},set:function(e){this._layoutAreaPos&&this._layoutAreaPos.equals(e)||(this.parent&&this.parent._setFlags(t.SmartPropertyPrim.flagLayoutBoundingInfoDirty|t.SmartPropertyPrim.flagGlobalTransformDirty),this._positioningDirty(),this._layoutAreaPos=e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isPickable",{get:function(){return this._isFlagSet(t.SmartPropertyPrim.flagIsPickable)},set:function(e){this._changeFlags(t.SmartPropertyPrim.flagIsPickable,e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isContainer",{get:function(){return this._isFlagSet(t.SmartPropertyPrim.flagIsContainer)},set:function(e){this._changeFlags(t.SmartPropertyPrim.flagIsContainer,e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"hierarchyDepth",{get:function(){return this._hierarchyDepth},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"renderGroup",{get:function(){return this._renderGroup},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"globalTransform",{get:function(){return this._updateLocalTransform(),this._globalTransform},enumerable:!0,configurable:!0}),i.prototype.getGlobalPosition=function(){var e=new t.Vector2(0,0);return this.getGlobalPositionByRef(e),e},i.prototype.getGlobalPositionByRef=function(t){t.x=this.globalTransform.m[12],t.y=this.globalTransform.m[13]},Object.defineProperty(i.prototype,"invGlobalTransform",{get:function(){return this._updateLocalTransform(),this._invGlobalTransform},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"localTransform",{get:function(){return this._updateLocalTransform(),this._localTransform},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"boundingInfo",{get:function(){if(this._isFlagSet(t.SmartPropertyPrim.flagBoundingInfoDirty)){this.owner&&this.owner.boundingInfoRecomputeCounter.addCount(1,!1),this.isSizedByContent?this._boundingInfo.clear():this._boundingInfo.copyFrom(this.levelBoundingInfo);for(var e=this._boundingInfo,r=new t.BoundingInfo2D,n=0,s=this._children;n<s.length;n++){var o=s[n];o.boundingInfo.transformToRef(o.localTransform,r),e.unionToRef(r,e)}this._boundingInfo.maxToRef(i._bMax),this._boundingSize.copyFromFloats(this._size&&null!=this._size.width?this._size.width:Math.ceil(i._bMax.x),this._size&&null!=this._size.height?this._size.height:Math.ceil(i._bMax.y)),this._clearFlags(t.SmartPropertyPrim.flagBoundingInfoDirty)}return this._boundingInfo},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"layoutBoundingInfo",{get:function(){if(this._isFlagSet(t.SmartPropertyPrim.flagLayoutBoundingInfoDirty)){this._layoutBoundingInfo||(this._layoutBoundingInfo=new t.BoundingInfo2D),this.isSizedByContent?this._layoutBoundingInfo.clear():this._layoutBoundingInfo.copyFrom(this.levelBoundingInfo);for(var e=this._layoutBoundingInfo,r=new t.BoundingInfo2D,n=0,s=this._children;n<s.length;n++){var o=s[n],a=void 0;if(o._layoutAreaPos){var h=o._layoutArea;t.BoundingInfo2D.CreateFromMinMaxToRef(0,h.width,0,h.height,i._tpsBB),a=i._tpsBB}else a=o.boundingInfo;a.transformToRef(o.localTransform,r),e.unionToRef(r,e)}this._clearFlags(t.SmartPropertyPrim.flagLayoutBoundingInfoDirty)}return this._layoutBoundingInfo},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSizeAuto",{get:function(){return null==this._size},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSizedByContent",{get:function(){return null==this._size&&this._children.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isPositionAuto",{get:function(){return null==this._position},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pointerEventObservable",{get:function(){return this._pointerEventObservable},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"zActualOrderChangedObservable",{get:function(){return this._actualZOrderChangedObservable||(this._actualZOrderChangedObservable=new t.Observable),this._actualZOrderChangedObservable},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayDebugAreas",{get:function(){return this._displayDebugAreas},set:function(e){if(this._displayDebugAreas!==e){if(e===!1)this._debugAreaGroup.dispose(),this._debugAreaGroup=null;else{var i="#F0808040",r="#F0F04040",n="#F040F040",s="#40F0F040",o=new t.Size(10,10),a=t.Vector2.Zero();this._debugAreaGroup=new t.Group2D({dontInheritParentScale:!0,parent:null!=this.parent?this.parent:this,id:"###DEBUG AREA GROUP###",children:[new t.Group2D({id:"###Layout Area###",position:a,size:o,children:[new t.Rectangle2D({id:"###Layout Frame###",position:t.Vector2.Zero(),size:o,fill:null,border:"#F08080FF"}),new t.Rectangle2D({id:"###Layout Top###",position:t.Vector2.Zero(),size:o,fill:i}),new t.Rectangle2D({id:"###Layout Left###",position:t.Vector2.Zero(),size:o,fill:i}),new t.Rectangle2D({id:"###Layout Right###",position:t.Vector2.Zero(),size:o,fill:i}),new t.Rectangle2D({id:"###Layout Bottom###",position:t.Vector2.Zero(),size:o,fill:i})]}),new t.Group2D({id:"###Margin Area###",position:a,size:o,children:[new t.Rectangle2D({id:"###Margin Frame###",position:t.Vector2.Zero(),size:o,fill:null,border:"#F0F040FF"}),new t.Rectangle2D({id:"###Margin Top###",position:t.Vector2.Zero(),size:o,fill:r}),new t.Rectangle2D({id:"###Margin Left###",position:t.Vector2.Zero(),size:o,fill:r}),new t.Rectangle2D({id:"###Margin Right###",position:t.Vector2.Zero(),size:o,fill:r}),new t.Rectangle2D({id:"###Margin Bottom###",position:t.Vector2.Zero(),size:o,fill:r})]}),new t.Group2D({id:"###Padding Area###",position:a,size:o,children:[new t.Rectangle2D({id:"###Padding Frame###",position:t.Vector2.Zero(),size:o,fill:null,border:"#F040F0FF"}),new t.Rectangle2D({id:"###Padding Top###",position:t.Vector2.Zero(),size:o,fill:n}),new t.Rectangle2D({id:"###Padding Left###",position:t.Vector2.Zero(),size:o,fill:n}),new t.Rectangle2D({id:"###Padding Right###",position:t.Vector2.Zero(),size:o,fill:n}),new t.Rectangle2D({id:"###Padding Bottom###",position:t.Vector2.Zero(),size:o,fill:n})]}),new t.Group2D({id:"###Content Area###",position:a,size:o,children:[new t.Rectangle2D({id:"###Content Frame###",position:t.Vector2.Zero(),size:o,fill:null,border:"#40F0F0FF"}),new t.Rectangle2D({id:"###Content Top###",position:t.Vector2.Zero(),size:o,fill:s}),new t.Rectangle2D({id:"###Content Left###",position:t.Vector2.Zero(),size:o,fill:s}),new t.Rectangle2D({id:"###Content Right###",position:t.Vector2.Zero(),size:o,fill:s}),new t.Rectangle2D({id:"###Content Bottom###",position:t.Vector2.Zero(),size:o,fill:s})]})]}),this._debugAreaGroup._setFlags(t.SmartPropertyPrim.flagNoPartOfLayout),this._updateDebugArea()}this._displayDebugAreas=e}},enumerable:!0,configurable:!0}),i.prototype._updateDebugArea=function(){for(var e=["Layout","Margin","Padding","Content"],i=["Area","Frame","Top","Left","Right","Bottom"],r=new Array(4),n=0;n<4;n++){r[n]=new Array(6);for(var s=0;s<6;s++)r[n][s]=this._debugAreaGroup.findById("###"+e[n]+" "+i[s]+"###"),s>1&&(r[n][s].levelVisible=!1)}var o=null!=this._layoutAreaPos,a=0!==this.actualPosition.x||0!==this.actualPosition.y,h=this._hasMargin,l=this._hasPadding;r[0][0].levelVisible=o,r[1][0].levelVisible=h,r[2][0].levelVisible=l,r[3][0].levelVisible=!0;var c=t.Vector2.Zero(),u=0,p=new Array(4),d=function(t,e){var i=t.clone(),r=t.clone();e.width>0&&(r.x+=e.width),e.height>0&&(r.y+=e.height),p[u++]={off:t,size:e,min:i,max:r}},f=this instanceof t.Canvas2D,m=this._marginOffset.x+this._marginOffset.z,_=this._marginOffset.y+this._marginOffset.w,g=this.actualSize.multiplyByFloats(f?1:this.scaleX,f?1:this.scaleY),y=o?this.layoutAreaPos.x+this.layoutArea.width:m+g.width,v=o?this.layoutAreaPos.y+this.layoutArea.height:_+g.height;if(d(o||h||l||!a?t.Vector2.Zero():this.actualPosition,new t.Size(y,v)),o){var x=this.layoutAreaPos.clone();d(x,h||l?this.layoutArea.clone():g.clone()),c=x.clone()}if(h){var b=c.clone();b.x+=this._marginOffset.x,b.y+=this._marginOffset.y;d(b,g),c=b.clone()}if(l){var P=c.clone();P.x+=this._paddingOffset.x,P.y+=this._paddingOffset.y;d(P,this.contentArea),c=c.add(P)}var T=function(t,e,i,n){r[t][e].position=i,r[t][e].size=n},S=function(t,e,i){var n=r[t];n[2].levelVisible=!0,n[3].levelVisible=!1,n[4].levelVisible=!1,n[5].levelVisible=!1,T(t,1,e,i),T(t,2,e,i)},A=function(e,i){var n=r[e];n[2].levelVisible=!0,n[3].levelVisible=!0,n[4].levelVisible=!0,n[5].levelVisible=!0;var s=p[i],o=p[i+1],a=new t.Vector2(s.min.x,o.max.y),h=new t.Size(s.size.width,s.max.y-a.y),l=new t.Vector2(s.min.x,o.min.y),c=new t.Size(o.min.x-s.min.x,o.max.y-o.min.y),u=new t.Vector2(o.max.x,o.min.y),d=new t.Size(s.max.x-o.max.x,o.max.y-o.min.y),f=new t.Vector2(s.min.x,s.min.y),m=new t.Size(s.size.width,o.min.y-s.min.y);n[1].position=s.off,n[1].size=s.size,n[2].position=a,n[2].size=h,n[3].position=l,n[3].size=c,n[4].position=u,n[4].size=d,n[5].position=f,n[5].size=m};u=0;for(var C=[!1,o,h,l,!0],E=1;E<5;E++)if(C[E]){var M=p[u];T(E-1,0,t.Vector2.Zero(),M.size),4===E?S(E-1,M.off,M.size):A(E-1,u),++u}},i.prototype.findById=function(t){if(this._id===t)return this;for(var e=0,i=this._children;e<i.length;e++){var r=i[e],n=r.findById(t);if(null!=n)return n}},i.prototype.onZOrderChanged=function(){},i.prototype.levelIntersect=function(t){return!1},i.prototype.setPointerEventCapture=function(t){return this.owner._setPointerCapture(t,this)},i.prototype.releasePointerEventsCapture=function(t){return this.owner._releasePointerCapture(t,this)},i.prototype.intersect=function(e){if(!e)return!1;var r=!e._globalPickPosition;if(r&&(e._globalPickPosition=t.Vector2.Zero(),t.Vector2.TransformToRef(e.pickPosition,this.globalTransform,e._globalPickPosition),e._localPickPosition=e.pickPosition.clone(),e.intersectedPrimitives=new Array,e.topMostIntersectedPrimitive=null),!i._bypassGroup2DExclusion&&this instanceof t.Group2D&&this.isCachedGroup&&!this.isRenderableGroup)return e._exit(r),!1;if(!e.intersectHidden&&!this.isVisible)return e._exit(r),!1;var n=this.id;if(null!=n&&0===n.indexOf("__cachedSpriteOfGroup__"))try{i._bypassGroup2DExclusion=!0;return this.getExternalData("__cachedGroup__").intersect(e)}finally{i._bypassGroup2DExclusion=!1}var s=!1;if(this instanceof t.Group2D){s=this.isCachedGroup}if(s&&!this.levelBoundingInfo.doesIntersect(e._localPickPosition))return e._exit(r),!1;if(this.isPickable&&!this.boundingInfo.doesIntersect(e._localPickPosition))return e._exit(r),!1;var o=!1;if(this.isPickable&&(o=this.levelIntersect(e))){var h=new a(this,e._localPickPosition.clone());if(e.intersectedPrimitives.push(h),(!e.topMostIntersectedPrimitive||e.topMostIntersectedPrimitive.prim.actualZOffset>h.prim.actualZOffset)&&(e.topMostIntersectedPrimitive=h),e.findFirstOnly)return e._exit(r),!0}if(!o||!e.findFirstOnly)for(var l=0,c=this._children;l<c.length;l++){var u=c[l];if((u.isPickable||!u.isContainer)&&(e.intersectHidden||u.isVisible)&&(t.Vector2.TransformToRef(e._globalPickPosition,u.invGlobalTransform,e._localPickPosition),u.intersect(e)&&e.findFirstOnly))return e._exit(r),!0}return e._exit(r),e.isIntersected},i.prototype.moveChild=function(e,i){if(e.parent!==this)return!1;var r=this._children.indexOf(e),n=i?this._children.indexOf(i):-1;return this._isFlagSet(t.SmartPropertyPrim.flagChildrenFlatZOrder)||(this._setFlags(t.SmartPropertyPrim.flagZOrderDirty),this._firstZDirtyIndex=Math.min(this._firstZDirtyIndex,n+1)),this._children.splice(n+1,0,this._children.splice(r,1)[0]),!0},i.prototype.moveChildToTop=function(t){return this.moveChild(t,this._children[this._children.length-1])},i.prototype.moveChildToBottom=function(t){return this.moveChild(t,null)},i.prototype.moveToTop=function(){return null!=this.parent&&this.parent.moveChildToTop(this)},i.prototype.moveToBottom=function(){return null!=this.parent&&this.parent.moveChildToBottom(this)},i.prototype.addChild=function(e){e._parent=this,this._boundingBoxDirty(),this._isFlagSet(t.SmartPropertyPrim.flagChildrenFlatZOrder)?(e._setFlags(t.SmartPropertyPrim.flagChildrenFlatZOrder),e._setZOrder(this._zOrder,!0),e._zMax=this._zOrder):this._setFlags(t.SmartPropertyPrim.flagZOrderDirty);var i=this._children.push(e);this._firstZDirtyIndex=Math.min(this._firstZDirtyIndex,i-1)},i.prototype.dispose=function(){if(!e.prototype.dispose.call(this))return!1;if(this._pointerEventObservable&&(this._pointerEventObservable.clear(),this._pointerEventObservable=null),this._actionManager&&(this._actionManager.dispose(),this._actionManager=null),this._parent){if(this instanceof t.Group2D){var i=this;if(i.isRenderableGroup){var r=this.parent.traverseUp(function(e){return e instanceof t.Group2D&&e.isRenderableGroup});if(null!=r){var n=r._renderableData._childrenRenderableGroups,s=n.indexOf(i);s!==-1&&n.splice(s,1)}}}var o=this._parent._children.indexOf(this);void 0!==o&&this._parent._children.splice(o,1),this._parent=null}if(this._children)for(;this._children.length>0;)this._children[this._children.length-1].dispose();return!0},i.prototype.onPrimBecomesDirty=function(){this._renderGroup&&!this._isFlagSet(t.SmartPropertyPrim.flagPrimInDirtyList)&&(this._renderGroup._addPrimToDirtyList(this),this._setFlags(t.SmartPropertyPrim.flagPrimInDirtyList))},i.prototype._needPrepare=function(){return this._areSomeFlagsSet(t.SmartPropertyPrim.flagVisibilityChanged|t.SmartPropertyPrim.flagModelDirty|t.SmartPropertyPrim.flagNeedRefresh)||0!==this._instanceDirtyFlags||this._globalTransformProcessStep!==this._globalTransformStep},i.prototype._prepareRender=function(t){this._prepareRenderPre(t),this._prepareRenderPost(t)},i.prototype._prepareRenderPre=function(t){},i.prototype._prepareRenderPost=function(e){if(this instanceof t.Group2D){if(this.isRenderableGroup)return}this._children.length>0&&(this._globalTransformProcessStep!==this._globalTransformStep||this.checkPropertiesDirty(i.isVisibleProperty.flagId))&&this._children.forEach(function(i){i instanceof t.Group2D&&i.isRenderableGroup||i._prepareRender(e)}),this._clearFlags(t.SmartPropertyPrim.flagModelDirty),this._instanceDirtyFlags=0},i.prototype._canvasPreInit=function(t){},i.CheckParent=function(t){},i.prototype.updateCachedStatesOf=function(t,e){for(var i=0,r=t;i<r.length;i++){r[i].updateCachedStates(e)}},i.prototype._parentLayoutDirty=function(){this._parent&&!this._parent.isDisposed&&this._parent._setLayoutDirty()},i.prototype._setLayoutDirty=function(){this.onPrimBecomesDirty(),this._setFlags(t.SmartPropertyPrim.flagLayoutDirty)},i.prototype._checkPositionChange=function(){return!this.parent||this.parent.layoutEngine.isChildPositionAllowed!==!1||(console.log("Can't manually set the position of "+this.id+", the Layout Engine of its parent doesn't allow it"),!1)},i.prototype._positioningDirty=function(){this.onPrimBecomesDirty(),this._setFlags(t.SmartPropertyPrim.flagPositioningDirty)},i.prototype._spreadActualOpacityChanged=function(){for(var e=0,i=this._children;e<i.length;e++){var r=i[e];r._setFlags(t.SmartPropertyPrim.flagActualOpacityDirty),r._updateRenderMode(),r.onPrimBecomesDirty(),r._spreadActualOpacityChanged()}},i.prototype._changeLayoutEngine=function(t){this._layoutEngine=t},i.prototype._updateLocalTransform=function(){var e=i.actualPositionProperty.flagId|i.rotationProperty.flagId|i.scaleProperty.flagId|i.scaleXProperty.flagId|i.scaleYProperty.flagId|i.originProperty.flagId;if(this.checkPropertiesDirty(e)){this.owner&&this.owner.addupdateLocalTransformCounter(1);var r,n=t.Quaternion.RotationAxis(new t.Vector3(0,0,1),this._rotation),s=this._position?this.position:this.layoutAreaPos;if(0===this._origin.x&&0===this._origin.y)r=t.Matrix.Compose(new t.Vector3(this._scale.x,this._scale.y,1),n,new t.Vector3(s.x+this._marginOffset.x,s.y+this._marginOffset.y,0)),this._localTransform=r;else{var o=this.actualSize;t.Matrix.TranslationToRef(-o.width*this._origin.x,-o.height*this._origin.y,0,i._t0),n.toRotationMatrix(i._t1),i._t0.multiplyToRef(i._t1,i._t2),t.Matrix.ScalingToRef(this._scale.x,this._scale.y,1,i._t0),i._t2.multiplyToRef(i._t0,i._t1),t.Matrix.TranslationToRef(o.width*this._origin.x+s.x+this._marginOffset.x,o.height*this._origin.y+s.y+this._marginOffset.y,0,i._t2),i._t1.multiplyToRef(i._t2,this._localTransform)}return this.clearPropertiesDirty(e),this._setFlags(t.SmartPropertyPrim.flagGlobalTransformDirty),!0}return!1},i.prototype.updateCachedStates=function(e){if(!this.isDisposed){this.owner.addCachedGroupRenderCounter(1),this._parent&&(this._parent._globalTransformProcessStep!==this.owner._globalTransformProcessStep||this._parent._areSomeFlagsSet(t.SmartPropertyPrim.flagLayoutDirty|t.SmartPropertyPrim.flagPositioningDirty|t.SmartPropertyPrim.flagZOrderDirty))&&this._parent.updateCachedStates(!1),this._isFlagSet(t.SmartPropertyPrim.flagZOrderDirty)&&this._updateZOrder();var r=this.checkPropertiesDirty(i.sizeProperty.flagId);if(!this._isFlagSet(t.SmartPropertyPrim.flagLayoutDirty)&&!this._isFlagSet(t.SmartPropertyPrim.flagPositioningDirty)&&r){this.size&&(null!=this.size.width&&(this.actualSize.width=this.size.width),null!=this.size.height&&(this.actualSize.height=this.size.height),this.clearPropertiesDirty(i.sizeProperty.flagId))}var n=this._isFlagSet(t.SmartPropertyPrim.flagPositioningDirty),s=n&&!this._isFlagSet(t.SmartPropertyPrim.flagPositioningDirty);this._isFlagSet(t.SmartPropertyPrim.flagLayoutDirty)&&(this.owner.addUpdateLayoutCounter(1),this._layoutEngine.updateLayout(this),this._clearFlags(t.SmartPropertyPrim.flagLayoutDirty));var o=!1;if(this.isSizeAuto&&(o=this._lastAutoSizeArea?!this._lastAutoSizeArea.equals(this.actualSize):null!==this.actualSize),!s&&(o||r||this._isFlagSet(t.SmartPropertyPrim.flagPositioningDirty)||this._parent&&!this._parent.contentArea.equals(this._parentContentArea))&&(this._updatePositioning(),this._clearFlags(t.SmartPropertyPrim.flagPositioningDirty),r&&this.clearPropertiesDirty(i.sizeProperty.flagId),s=!0),s&&this._parent&&this._parentContentArea.copyFrom(this._parent.contentArea),this===this.owner||this._globalTransformProcessStep!==this.owner._globalTransformProcessStep){this.owner.addUpdateGlobalTransformCounter(1);var a=this.isVisible;this.isVisible=(!this._parent||this._parent.isVisible)&&this.levelVisible,this._changeFlags(t.SmartPropertyPrim.flagVisibilityChanged,a!==this.isVisible);var h=this._updateLocalTransform(),l=!1,c=i._v0;this._parent&&(c=new t.Vector2(this._parent._paddingOffset.x,this._parent._paddingOffset.y),l=!c.equals(this._parentPaddingOffset));var u=null!=this._parent&&this._parent._globalTransformStep!==this._parentTransformStep;if(!this._globalTransform||h||u||l||this._areSomeFlagsSet(t.SmartPropertyPrim.flagGlobalTransformDirty)){var p=this._parent?this._parent._globalTransform:null,d=void 0;i._transMtx.copyFrom(this._localTransform),i._transMtx.m[12]+=c.x,i._transMtx.m[13]+=c.y,d=i._transMtx,this._globalTransform=this._parent?d.multiply(p):d.clone(),this._invGlobalTransform=t.Matrix.Invert(this._globalTransform),this._globalTransformStep=this.owner._globalTransformProcessStep+1,this._parentTransformStep=this._parent?this._parent._globalTransformStep:0,this._clearFlags(t.SmartPropertyPrim.flagGlobalTransformDirty)}this._globalTransformProcessStep=this.owner._globalTransformProcessStep}if(e)for(var f=0,m=this._children;f<m.length;f++){var _=m[f];_.updateCachedStates(!(_ instanceof t.Group2D&&_.isRenderableGroup))}}},i.prototype._updatePositioning=function(){this.owner&&this.owner.addUpdatePositioningCounter(1);var e=this.isSizeAuto;if(this._hasMarginAlignment||!e&&null!=this.actualSize.width&&null!=this.actualSize.height||((e||null==this.actualSize.width)&&(this.marginAlignment.horizontal=n.AlignStretch),(e||null==this.actualSize.height)&&(this.marginAlignment.vertical=n.AlignStretch)),this._hasMargin&&(this.margin.computeWithAlignment(this.layoutArea,this.size||this.actualSize,this.marginAlignment,this._marginOffset,i._size),this.actualSize=i._size.clone()),this._hasPadding)if(e){var r=this.size.clone();this._getActualSizeFromContentToRef(r,i._icArea),this.padding.enlarge(i._icArea,this._paddingOffset,i._size),this._contentArea.copyFrom(r),this.actualSize=i._size.clone(),this._hasMargin&&this.margin.computeWithAlignment(this.layoutArea,i._size,this.marginAlignment,this._marginOffset,i._size)}else this._getInitialContentAreaToRef(this.actualSize,i._icZone,i._icArea),i._icArea.width=Math.max(0,i._icArea.width),i._icArea.height=Math.max(0,i._icArea.height),this.padding.compute(i._icArea,this._paddingOffset,i._size),this._paddingOffset.x+=i._icZone.x,this._paddingOffset.y+=i._icZone.y,this._paddingOffset.z-=i._icZone.z,this._paddingOffset.w-=i._icZone.w,this._contentArea.copyFrom(i._size);else this._getInitialContentAreaToRef(this.actualSize,i._icZone,i._icArea),i._icArea.width=Math.max(0,i._icArea.width),i._icArea.height=Math.max(0,i._icArea.height),this._paddingOffset.x=i._icZone.x,this._paddingOffset.y=i._icZone.y,this._paddingOffset.z=i._icZone.z,this._paddingOffset.w=i._icZone.w,this._contentArea.copyFrom(i._icArea);if(!this._position){var s=new t.Vector2(this.layoutAreaPos.x+this._marginOffset.x,this.layoutAreaPos.y+this._marginOffset.y);this.actualPosition=s}e&&(this._lastAutoSizeArea=this.actualSize),this.displayDebugAreas&&this._updateDebugArea()},Object.defineProperty(i.prototype,"contentArea",{get:function(){return this._isFlagSet(t.SmartPropertyPrim.flagPositioningDirty)&&(this._updatePositioning(),this._clearFlags(t.SmartPropertyPrim.flagPositioningDirty)),this._contentArea},enumerable:!0,configurable:!0}),i.prototype._patchHierarchy=function(e){if(this._owner=e,null==this._renderGroup){if(this instanceof t.Group2D){var i=this;i.detectGroupStates(),i._trackedNode&&!i._isFlagSet(t.SmartPropertyPrim.flagTrackedGroup)&&i.owner._registerTrackedNode(this)}if(this._renderGroup=this.traverseUp(function(e){return e instanceof t.Group2D&&e.isRenderableGroup}),this._parent&&this._parentLayoutDirty(),this._renderGroup&&this.isDirty){var r=this._renderGroup._renderableData._primDirtyList;r.indexOf(this)===-1&&r.push(this)}for(var n=0,s=this._children;n<s.length;n++){var o=s[n];o._hierarchyDepth=this._hierarchyDepth+1,o._patchHierarchy(e)}}},i.prototype._updateZOrder=function(){var e=this._primLinearPosition,r=0,n=this._zOrder,s=this._children.length;if(this._firstZDirtyIndex>0&&this._firstZDirtyIndex-1<s){var o=this._children[this._firstZDirtyIndex-1];e=o._primLinearPosition,r=this._firstZDirtyIndex-1,n=o._zOrder}var a=e;i._totalCount=0;for(var h=r;h<s;h++){var l=this._children[h];e=l._updatePrimitiveLinearPosition(e)}var c=(this._zMax-n)/(i._totalCount*(i._zRebuildReentrency?1:1.2));if(c<t.Canvas2D._zMinDelta){if(i._zRebuildReentrency){var u=this._parent;return null==u?(console.log("Can't compute Z-Order for "+this.id+"'s children, zDelta is too small, Z-Order is now in an unstable state"),void(i._zRebuildReentrency=!1)):(u._firstZDirtyIndex=0,u._updateZOrder())}i._zRebuildReentrency=!0,this._firstZDirtyIndex=0,this._updateZOrder(),i._zRebuildReentrency=!1}for(var h=r;h<s;h++){var l=this._children[h];l._updatePrimitiveZOrder(a,n,c)}for(var p=0,d=i._zOrderChangedNotifList;p<d.length;p++){var u=d[p];u._actualZOrderChangedObservable.notifyObservers(u.actualZOffset)}i._zOrderChangedNotifList.splice(0),this._firstZDirtyIndex=i._bigInt,this._clearFlags(t.SmartPropertyPrim.flagZOrderDirty)},i.prototype._updatePrimitiveLinearPosition=function(e){if(this.isManualZOrder)return e;if(this._primLinearPosition=++e,i._totalCount++,!this._isFlagSet(t.SmartPropertyPrim.flagChildrenFlatZOrder))for(var r=0,n=this._children;r<n.length;r++){var s=n[r];e=s._updatePrimitiveLinearPosition(e)}return e},i.prototype._updatePrimitiveZOrder=function(e,r,n){if(this.isManualZOrder)return null;var s=r+(this._primLinearPosition-e)*n,o=this._isFlagSet(t.SmartPropertyPrim.flagChildrenFlatZOrder);this._setZOrder(s,!1),this._isFlagSet(t.SmartPropertyPrim.flagZOrderDirty)&&(this._firstZDirtyIndex=i._bigInt,this._clearFlags(t.SmartPropertyPrim.flagZOrderDirty));var a=s;if(o){if(this._children.length>0)for(var h=0,l=this._children;h<l.length;h++){var c=l[h];c._updatePrimitiveFlatZOrder(this._zOrder)}}else for(var u=0,p=this._children;u<p.length;u++){var c=p[u],d=c._updatePrimitiveZOrder(e,r,n);null!=d&&(a=d)}return this._zMax=o?s:a+n,a},i.prototype._updatePrimitiveFlatZOrder=function(e){if(!this.isManualZOrder){this._setZOrder(e,!1),this._zMax=e,this._isFlagSet(t.SmartPropertyPrim.flagZOrderDirty)&&(this._firstZDirtyIndex=i._bigInt,this._clearFlags(t.SmartPropertyPrim.flagZOrderDirty));for(var r=0,n=this._children;r<n.length;r++){n[r]._updatePrimitiveFlatZOrder(e)}}},i.prototype._setZOrder=function(t,e){t!==this._zOrder&&(this._zOrder=t,this.onPrimBecomesDirty(),this.onZOrderChanged(),this._actualZOrderChangedObservable&&this._actualZOrderChangedObservable.hasObservers()&&(e?this._actualZOrderChangedObservable.notifyObservers(t):i._zOrderChangedNotifList.push(this)))},i.prototype._updateRenderMode=function(){},i.prototype._getInitialContentAreaToRef=function(t,e,i){i.copyFrom(t),e.x=e.y=e.z=e.w=0},i.prototype._getActualSizeFromContentToRef=function(t,e){e.copyFrom(t)},i.PRIM2DBASE_PROPCOUNT=25,i._bigInt=Math.pow(2,30),i._nullPosition=t.Vector2.Zero(),i.boundinbBoxReentrency=!1,i.nullSize=t.Size.Zero(),i._bMax=t.Vector2.Zero(),i._tpsBB=new t.BoundingInfo2D,i._bypassGroup2DExclusion=!1,i._isCanvasInit=!1,i._t0=new t.Matrix,i._t1=new t.Matrix,i._t2=new t.Matrix,i._v0=t.Vector2.Zero(),i._transMtx=t.Matrix.Zero(),i._icPos=t.Vector2.Zero(),i._icZone=t.Vector4.Zero(),i._icArea=t.Size.Zero(),i._size=t.Size.Zero(),i._zOrderChangedNotifList=new Array,i._zRebuildReentrency=!1,i._totalCount=0,s([t.instanceLevelProperty(1,function(t){return i.actualPositionProperty=t},!1,!1,!0)],i.prototype,"actualPosition",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+1,function(t){return i.actualXProperty=t},!1,!1,!0)],i.prototype,"actualX",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+2,function(t){return i.actualYProperty=t},!1,!1,!0)],i.prototype,"actualY",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+3,function(t){return i.positionProperty=t},!1,!1,!0)],i.prototype,"position",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+4,function(t){return i.xProperty=t},!1,!1,!0)],i.prototype,"x",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+5,function(t){return i.yProperty=t},!1,!1,!0)],i.prototype,"y",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+6,function(t){return i.sizeProperty=t},!1,!0)],i.prototype,"size",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+7,function(t){return i.widthProperty=t},!1,!0)],i.prototype,"width",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+8,function(t){return i.heightProperty=t},!1,!0)],i.prototype,"height",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+9,function(t){return i.rotationProperty=t},!1,!0)],i.prototype,"rotation",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+10,function(t){return i.scaleProperty=t},!1,!0)],i.prototype,"scale",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+11,function(t){return i.actualSizeProperty=t},!1,!0)],i.prototype,"actualSize",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+12,function(t){return i.actualWidthProperty=t},!1,!0)],i.prototype,"actualWidth",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+13,function(t){return i.actualHeightProperty=t},!1,!0)],i.prototype,"actualHeight",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+14,function(t){return i.originProperty=t},!1,!0)],i.prototype,"origin",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+15,function(t){return i.levelVisibleProperty=t})],i.prototype,"levelVisible",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+16,function(t){return i.isVisibleProperty=t})],i.prototype,"isVisible",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+17,function(t){return i.zOrderProperty=t})],i.prototype,"zOrder",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+18,function(t){return i.marginProperty=t})],i.prototype,"margin",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+19,function(t){return i.paddingProperty=t})],i.prototype,"padding",null),s([t.dynamicLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+20,function(t){return i.marginAlignmentProperty=t})],i.prototype,"marginAlignment",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+21,function(t){return i.opacityProperty=t})],i.prototype,"opacity",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+22,function(t){return i.scaleXProperty=t},!1,!0)],i.prototype,"scaleX",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+23,function(t){return i.scaleYProperty=t},!1,!0)],i.prototype,"scaleY",null),s([t.instanceLevelProperty(t.SmartPropertyPrim.SMARTPROPERTYPRIM_PROPCOUNT+24,function(t){return i.actualScaleProperty=t},!1,!0)],i.prototype,"actualScale",null),i=s([t.className("Prim2DBase","BABYLON")],i)}(t.SmartPropertyPrim);t.Prim2DBase=c}(r||(r={}));var r;!function(t){var e=function(){function e(e,i,r){this._partCount=r,this.owner=e,this.modelRenderCache=i,this.modelRenderCache.addRef(),this.partIndexFromId=new t.StringDictionary,this._usedShaderCategories=new Array(r),this._strides=new Array(r),this._opaqueData=null,this._alphaTestData=null,this._transparentData=null,this.opaqueDirty=this.alphaTestDirty=this.transparentDirty=this.transparentOrderDirty=!1}return e.prototype.dispose=function(){if(this._isDisposed)return!1;this.modelRenderCache&&(this.modelRenderCache.dispose(),this.modelRenderCache=null);var t=this.owner.owner.engine;return this._opaqueData&&(this._opaqueData.forEach(function(e){return e.dispose(t)}),this._opaqueData=null),this._alphaTestData&&(this._alphaTestData.forEach(function(e){return e.dispose(t)}),this._alphaTestData=null),this._transparentData&&(this._transparentData.forEach(function(e){return e.dispose(t)}),this._transparentData=null),this.partIndexFromId=null,this._isDisposed=!0,!0},Object.defineProperty(e.prototype,"hasOpaqueData",{get:function(){return null!=this._opaqueData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasAlphaTestData",{get:function(){return null!=this._alphaTestData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasTransparentData",{get:function(){return null!=this._transparentData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"opaqueData",{get:function(){if(!this._opaqueData){this._opaqueData=new Array(this._partCount);for(var t=0;t<this._partCount;t++)this._opaqueData[t]=new r(this._strides[t])}return this._opaqueData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alphaTestData",{get:function(){if(!this._alphaTestData){this._alphaTestData=new Array(this._partCount);for(var t=0;t<this._partCount;t++)this._alphaTestData[t]=new r(this._strides[t])}return this._alphaTestData},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transparentData",{get:function(){if(!this._transparentData){this._transparentData=new Array(this._partCount);for(var t=0;t<this._partCount;t++){var e=this.modelRenderCache._partData[t]._zBiasOffset;this._transparentData[t]=new n(this._strides[t],e)}}return this._transparentData},enumerable:!0,configurable:!0}),e.prototype.sortTransparentData=function(){if(this.transparentOrderDirty){for(var t=0;t<this._transparentData.length;t++){this._transparentData[t]._partData.sort()}this.transparentOrderDirty=!1}},Object.defineProperty(e.prototype,"usedShaderCategories",{get:function(){return this._usedShaderCategories},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strides",{get:function(){return this._strides},enumerable:!0,configurable:!0}),e}();t.GroupInstanceInfo=e;var i=function(){function e(){this.groupInsanceInfo=null,this.startZ=0,this.endZ=0,this.startDataIndex=t.Prim2DBase._bigInt,this.endDataIndex=0,this.partBuffers=null}return e.prototype.dispose=function(t){this.partBuffers&&(this.partBuffers.forEach(function(e){return t._releaseBuffer(e)}),this.partBuffers.splice(0),this.partBuffers=null)},e}();t.TransparentSegment=i;var r=function(){function e(e){this._partData=null,this._partBuffer=null,this._partBufferSize=0,this._partData=new t.DynamicFloatArray(e/4,50),this._isDisposed=!1}return e.prototype.dispose=function(t){if(this._isDisposed)return!1;this._partBuffer&&(t._releaseBuffer(this._partBuffer),this._partBuffer=null),this._partData=null,this._isDisposed=!0},e}();t.GroupInfoPartData=r;var n=function(t){function e(e,i){t.call(this,e),this._partData.compareValueOffset=i,this._partData.sortingAscending=!1}return o(e,t),e}(r);t.TransparentGroupInfoPartData=n;var s=function(){function e(t,e){this._engine=t,this._modelKey=e,this._nextKey=1,this._refCounter=1,this._partData=null}return e.prototype.dispose=function(){if(0!=--this._refCounter)return!1;var t=this._engine.getExternalData("__BJSCANVAS2D__");return t&&t.DisposeModelRenderCache(this),!0},Object.defineProperty(e.prototype,"isDisposed",{get:function(){return this._refCounter<=0},enumerable:!0,configurable:!0}),e.prototype.addRef=function(){return++this._refCounter},Object.defineProperty(e.prototype,"modelKey",{get:function(){return this._modelKey},enumerable:!0,configurable:!0}),e.prototype.render=function(t,e){return!0},e.prototype.getPartIndexFromId=function(t){for(var e=0;e<this._partData.length;e++)if(this._partData[e]._partId===t)return e;return null},e.prototype.loadInstancingAttributes=function(t,e){var i=this.getPartIndexFromId(t);if(null===i)return null;var r=this._partsClassInfo[i],n=this._partData[i]._partUsedCategories;return r.classContent.getInstancingAttributeInfos(e,n)},e.prototype.setupUniforms=function(t,i,r,n){var s=this._partData[i],o=s._partDataStride/4*n,a=this._partsClassInfo[i];a.fullContent.forEach(function(i,n){if(!n.category||s._partUsedCategories.indexOf(n.category)!==-1)switch(n.dataType){case 4:var a=n.instanceOffset.get(s._partJoinedUsedCategories);t.setFloat(n.attributeName,r.buffer[o+a]);break;case 0:var a=n.instanceOffset.get(s._partJoinedUsedCategories);e.v2.x=r.buffer[o+a+0],e.v2.y=r.buffer[o+a+1],t.setVector2(n.attributeName,e.v2);break;case 5:case 1:var a=n.instanceOffset.get(s._partJoinedUsedCategories);e.v3.x=r.buffer[o+a+0],e.v3.y=r.buffer[o+a+1],e.v3.z=r.buffer[o+a+2],t.setVector3(n.attributeName,e.v3);break;case 6:case 2:var a=n.instanceOffset.get(s._partJoinedUsedCategories);e.v4.x=r.buffer[o+a+0],e.v4.y=r.buffer[o+a+1],e.v4.z=r.buffer[o+a+2],e.v4.w=r.buffer[o+a+3],t.setVector4(n.attributeName,e.v4)}})},e.v2=t.Vector2.Zero(),e.v3=t.Vector3.Zero(),e.v4=t.Vector4.Zero(),e}();t.ModelRenderCache=s;var a=function(){function t(){}return t}();t.ModelRenderCachePartData=a}(r||(r={}));var r;!function(t){function e(e,n){return function(s,o,a){var h=t.ClassTreeInfo.getOrRegister(s,function(t){return new i(t)}),l=h.getLevelOf(s),c=o;n=n||c;var u=l.levelContent.get(c);if(u)throw new Error("The ID "+c+" is already taken by another instance data");u=new r,u.attributeName=n,u.category=e||null,u.category&&(u.delimitedCategory=";"+u.category+";"),l.levelContent.add(c,u),a.get=function(){return null},a.set=function(t){if(!u.category||i._CurCategories.indexOf(u.delimitedCategory)!==-1){u.size?u.instanceOffset.contains(i._CurCategories)||l.classContent.mapProperty(u,!1):(u.setSize(t),l.classContent.mapProperty(u,!0));var e=this;if(e.dataBuffer&&e.dataElements){var r=e.dataElements[e.curElement].offset+u.instanceOffset.get(i._CurCategories);u.writeData(e.dataBuffer.buffer,r,t)}}}}}var i=function(){function e(e){this._baseInfo=e,this._nextOffset=new t.StringDictionary,this._attributes=new Array}return e.prototype.mapProperty=function(t,i){var r=this._nextOffset.getOrAdd(e._CurCategories,0);t.instanceOffset.add(e._CurCategories,this._getBaseOffset(e._CurCategories)+r),this._nextOffset.set(e._CurCategories,r+t.size/4),i&&this._attributes.push(t)},e.prototype.getInstancingAttributeInfos=function(e,i){for(var r=";"+i.join(";")+";",n=new Array,s=this;s;){for(var o=0,a=s._attributes;o<a.length;o++){var h=a[o];if(!h.category||i.indexOf(h.category)!==-1){var l=e.getAttributeLocationByName(h.attributeName),c=new t.InstancingAttributeInfo;c.index=l,c.attributeSize=h.size/4,c.offset=4*h.instanceOffset.get(r),c.attributeName=h.attributeName,n.push(c)}}s=s._baseInfo}return n},e.prototype.getShaderAttributes=function(t){for(var e=new Array,i=this;i;){for(var r=0,n=i._attributes;r<n.length;r++){var s=n[r];s.category&&t.indexOf(s.category)===-1||e.push(s.attributeName)}i=i._baseInfo}return e},e.prototype._getBaseOffset=function(t){for(var e=0,i=this._baseInfo;i;)e+=i._nextOffset.getOrAdd(t,0),i=i._baseInfo;return e},e}();t.InstanceClassInfo=i;var r=function(){function e(){this.instanceOffset=new t.StringDictionary}return e.prototype.setSize=function(e){if(e instanceof t.Vector2)return this.size=8,void(this.dataType=0);if(e instanceof t.Vector3)return this.size=12,void(this.dataType=1);if(e instanceof t.Vector4)return this.size=16,void(this.dataType=2);if(e instanceof t.Matrix)throw new Error("Matrix type is not supported by WebGL Instance Buffer, you have to use four Vector4 properties instead");return"number"==typeof e?(this.size=4,void(this.dataType=4)):e instanceof t.Color3?(this.size=12,void(this.dataType=5)):e instanceof t.Color4?(this.size=16,void(this.dataType=6)):e instanceof t.Size?(this.size=8,void(this.dataType=7)):void 0},e.prototype.writeData=function(t,e,i){switch(this.dataType){case 0:var r=i;t[e+0]=r.x,t[e+1]=r.y;break;case 1:var r=i;t[e+0]=r.x,t[e+1]=r.y,t[e+2]=r.z;break;case 2:var r=i;t[e+0]=r.x,t[e+1]=r.y,t[e+2]=r.z,t[e+3]=r.w;break;case 5:var r=i;t[e+0]=r.r,t[e+1]=r.g,t[e+2]=r.b;break;case 6:var r=i;t[e+0]=r.r,t[e+1]=r.g,t[e+2]=r.b,t[e+3]=r.a;break;case 4:var r=i;t[e]=r;break;case 3:for(var r=i,n=0;n<16;n++)t[e+n]=r.m[n];break;case 7:var s=i;t[e+0]=s.width,t[e+1]=s.height}},e}();t.InstancePropInfo=r,t.instanceData=e;var n=function(){function i(t,e){this.id=t,this.curElement=0,this._dataElementCount=e,this.renderMode=0,this.arrayLengthChanged=!1}return Object.defineProperty(i.prototype,"zBias",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"transformX",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"transformY",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"opacity",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),i.prototype.getClassTreeInfo=function(){return this.typeInfo||(this.typeInfo=t.ClassTreeInfo.get(Object.getPrototypeOf(this))),this.typeInfo},i.prototype.allocElements=function(){if(this.dataBuffer&&!this.dataElements){for(var t=new Array(this.dataElementCount),e=0;e<this.dataElementCount;e++)t[e]=this.dataBuffer.allocElement();this.dataElements=t}},i.prototype.freeElements=function(){if(this.dataElements){for(var t=0,e=this.dataElements;t<e.length;t++){var i=e[t];this.dataBuffer.freeElement(i)}this.dataElements=null}},Object.defineProperty(i.prototype,"dataElementCount",{get:function(){return this._dataElementCount},set:function(t){t!==this._dataElementCount&&(this.arrayLengthChanged=!0,this.freeElements(),this._dataElementCount=t,this.allocElements())},enumerable:!0,configurable:!0}),s([e()],i.prototype,"zBias",null),s([e()],i.prototype,"transformX",null),s([e()],i.prototype,"transformY",null),s([e()],i.prototype,"opacity",null),i}();t.InstanceDataBase=n;var a=function(e){function r(t){e.call(this,t),this._transparentPrimitiveInfo=null}return o(r,e),Object.defineProperty(r.prototype,"isAlphaTest",{get:function(){return this._useTextureAlpha()||this._isPrimAlphaTest()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isTransparent",{get:function(){return this.actualOpacity<1||this._shouldUseAlphaFromTexture()||this._isPrimTransparent()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderMode",{get:function(){return this._renderMode},enumerable:!0,configurable:!0}),r.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(this.renderGroup&&this.renderGroup._setCacheGroupDirty(),this._transparentPrimitiveInfo&&(this.renderGroup._renderableData.removeTransparentPrimitiveInfo(this._transparentPrimitiveInfo),this._transparentPrimitiveInfo=null),this._instanceDataParts&&this._cleanupInstanceDataParts(),this._modelRenderCache&&(this._modelRenderCache.dispose(),this._modelRenderCache=null),this._instanceDataParts&&(this._instanceDataParts.forEach(function(t){t.freeElements()}),this._instanceDataParts=null),!0)},r.prototype._cleanupInstanceDataParts=function(){for(var t=null,e=0,i=this._instanceDataParts;e<i.length;e++){var r=i[e];r.freeElements(),t=r.groupInstanceInfo}if(t){var n=0;if(t.hasOpaqueData){n+=t.opaqueData[0]._partData.usedElementCount,t.opaqueDirty=!0}if(t.hasAlphaTestData){n+=t.alphaTestData[0]._partData.usedElementCount,t.alphaTestDirty=!0}if(t.hasTransparentData){n+=t.transparentData[0]._partData.usedElementCount,t.transparentDirty=!0}0===n&&null!=t.modelRenderCache&&(this.renderGroup._renderableData._renderGroupInstancesInfo.remove(t.modelRenderCache.modelKey),t.dispose()),this._modelRenderCache&&(this._modelRenderCache.dispose(),this._modelRenderCache=null)}this._instanceDataParts=null},r.prototype._prepareRenderPre=function(i){e.prototype._prepareRenderPre.call(this,i),this._isFlagSet(t.SmartPropertyPrim.flagModelDirty)&&this._instanceDataParts&&this._cleanupInstanceDataParts();var r=!1;this._modelRenderCache&&!this._isFlagSet(t.SmartPropertyPrim.flagModelDirty)||(r=this._createModelRenderCache());var n=null,s=!1;this._instanceDataParts||(s=!0,n=this._createModelDataParts()),r&&this.setupModelRenderCache(this._modelRenderCache),(this._areSomeFlagsSet(t.SmartPropertyPrim.flagVisibilityChanged|t.SmartPropertyPrim.flagNeedRefresh)||i.forceRefreshPrimitive||s||0!==this._instanceDirtyFlags||this._globalTransformProcessStep!==this._globalTransformStep||this._mustUpdateInstance())&&this._updateInstanceDataParts(n)},r.prototype._createModelRenderCache=function(){var e=this,i=!1;return this._modelRenderCache&&this._modelRenderCache.dispose(),this._modelRenderCache=this.owner._engineData.GetOrAddModelCache(this.modelKey,function(t){var r=e.createModelRenderCache(t);return i=!0,r}),this._clearFlags(t.SmartPropertyPrim.flagModelDirty),i||this._modelRenderCache.addRef(),i},r.prototype._createModelDataParts=function(){var e=this,i=this.createInstanceDataParts();this._instanceDataParts=i,this._modelRenderCache._partData||this._setupModelRenderCache(i);var r=this.renderGroup._renderableData._renderGroupInstancesInfo.getOrAddWithFactory(this.modelKey,function(i){for(var r=new t.GroupInstanceInfo(e.renderGroup,e._modelRenderCache,e._modelRenderCache._partData.length),n=0;n<e._modelRenderCache._partData.length;n++){var s=e._instanceDataParts[n];r.partIndexFromId.add(s.id.toString(),n),r.usedShaderCategories[n]=";"+e.getUsedShaderCategories(s).join(";")+";",r.strides[n]=e._modelRenderCache._partData[n]._partDataStride}return r}),n=0,s=null;this.isTransparent?(s=r.transparentData,n=t.Render2DContext.RenderModeTransparent):this.isAlphaTest?(s=r.alphaTestData,n=t.Render2DContext.RenderModeAlphaTest):(s=r.opaqueData,n=t.Render2DContext.RenderModeOpaque);for(var o=0;o<i.length;o++){var a=i[o];a.dataBuffer=s[o]._partData,a.allocElements(),a.renderMode=n,a.groupInstanceInfo=r}return r},r.prototype._setupModelRenderCache=function(e){var r=new Array;this._modelRenderCache._partData=new Array;for(var n=0,s=e;n<s.length;n++){var o=s[n],a=new t.ModelRenderCachePartData;this._modelRenderCache._partData.push(a);var h=this.getUsedShaderCategories(o),l=o.getClassTreeInfo(),c=this.isVisible;this.isVisible=!0;var u=";"+h.join(";")+";";a._partJoinedUsedCategories=u,i._CurCategories=u;var p=this.beforeRefreshForLayoutConstruction(o);this.refreshInstanceDataPart(o)||console.log("Layout construction for "+t.Tools.getClassName(this._instanceDataParts[0])+" failed because refresh returned false"),this.afterRefreshForLayoutConstruction(o,p),this.isVisible=c;var d=0;l.fullContent.forEach(function(e,i){i.category&&h.indexOf(i.category)===-1||("zBias"===i.attributeName&&(a._zBiasOffset=i.instanceOffset.get(u)),i.size?d+=i.size:console.log("ERROR: Couldn't detect the size of the Property "+i.attributeName+" from type "+t.Tools.getClassName(l.type)+". Property is ignored."))}),a._partDataStride=d,a._partUsedCategories=h,a._partId=o.id,r.push(l)}this._modelRenderCache._partsClassInfo=r},r.prototype.onZOrderChanged=function(){if(this.isTransparent&&this._transparentPrimitiveInfo){this.renderGroup._renderableData.transparentPrimitiveZChanged(this._transparentPrimitiveInfo);this.renderGroup._renderableData._renderGroupInstancesInfo.get(this.modelKey).transparentOrderDirty=!0}},r.prototype._mustUpdateInstance=function(){return!1},r.prototype._useTextureAlpha=function(){return!1},r.prototype._shouldUseAlphaFromTexture=function(){return!1},r.prototype._isPrimAlphaTest=function(){return!1},r.prototype._isPrimTransparent=function(){return!1},r.prototype._updateInstanceDataParts=function(e){var r=this.renderGroup._renderableData;e||(e=r._renderGroupInstancesInfo.get(this.modelKey));var n=this.isTransparent,s=this.isAlphaTest,o=!1,a=!1;if(this._instanceDataParts.length>0){var h=this._instanceDataParts[0],l=h.renderMode,c=this.renderMode;if(l!==c){o=l===t.Render2DContext.RenderModeTransparent,a=!0;var u=void 0;switch(c){case t.Render2DContext.RenderModeTransparent:u=e.transparentData;break;case t.Render2DContext.RenderModeAlphaTest:u=e.alphaTestData;break;default:u=e.opaqueData}for(var p=0;p<this._instanceDataParts.length;p++){var d=this._instanceDataParts[p];d.freeElements(),d.dataBuffer=u[p]._partData,d.renderMode=c}}}var f=this._isFlagSet(t.SmartPropertyPrim.flagVisibilityChanged);(n||o)&&(f||a)&&(this.isVisible&&!o?this._transparentPrimitiveInfo||(this._transparentPrimitiveInfo=r.addNewTransparentPrimitiveInfo(this,e)):this._transparentPrimitiveInfo&&(r.removeTransparentPrimitiveInfo(this._transparentPrimitiveInfo),this._transparentPrimitiveInfo=null),e.transparentOrderDirty=!0);for(var m=!1,_=0,g=this._instanceDataParts;_<g.length;_++){var d=g[_],y=!1;!d.dataElements&&(f||a||this.isVisible)&&(d.allocElements(),y=!0),i._CurCategories=e.usedShaderCategories[e.partIndexFromId.get(d.id.toString())],d.arrayLengthChanged=!1,this.refreshInstanceDataPart(d)||(d.dataElements&&d.freeElements(),this.isVisible&&r._primNewDirtyList.push(this)),m=m||d.arrayLengthChanged||y}this._instanceDirtyFlags=0,n?(e.transparentDirty=!0,m&&(r._transparentListChanged=!0)):s?e.alphaTestDirty=!0:e.opaqueDirty=!0,this._clearFlags(t.SmartPropertyPrim.flagVisibilityChanged)},r.prototype._updateTransparentSegmentIndices=function(e){for(var i=t.Prim2DBase._bigInt,r=0,n=0,s=this._instanceDataParts;n<s.length;n++){var o=s[n];if(o&&o.dataElements){o.dataBuffer.pack();for(var a=0,h=o.dataElements;a<h.length;a++){var l=h[a];i=Math.min(i,l.offset),r=Math.max(r,l.offset)}e.startDataIndex=Math.min(e.startDataIndex,i/o.dataBuffer.stride),e.endDataIndex=Math.max(e.endDataIndex,r/o.dataBuffer.stride+1)}}},r.prototype._getNextPrimZOrder=function(){for(var t=this._instanceDataParts.length,e=0;e<t;e++){var i=this._instanceDataParts[e];if(i){var r=i.dataBuffer.stride,n=i.dataElements[i.dataElements.length-1].offset;return i.dataBuffer.totalElementCount*r<=n?null:i.dataBuffer[n+r+this.modelRenderCache._partData[e]._zBiasOffset]}}return null},r.prototype._getPrevPrimZOrder=function(){for(var t=this._instanceDataParts.length,e=0;e<t;e++){var i=this._instanceDataParts[e];if(i){var r=i.dataBuffer.stride,n=i.dataElements[0].offset;return 0===n?null:i.dataBuffer[n-r+this.modelRenderCache._partData[e]._zBiasOffset]}}return null},r.prototype.transformPointWithOriginByRef=function(t,e,i){var r=this.actualSize;i.x=t.x-(this.origin.x+(e?e.x:0))*r.width,i.y=t.y-(this.origin.y+(e?e.y:0))*r.height},r.prototype.transformPointWithOriginToRef=function(t,e,i){return this.transformPointWithOriginByRef(t,e,i),i},r.prototype.getDataPartEffectInfo=function(e,i,r,n){void 0===r&&(r=null),void 0===n&&(n=null);var s=t.Tools.first(this._instanceDataParts,function(t){return t.id===e});if(!s)return null;var o=this.owner.supportInstancedArray;if(null!=n){if(n&&o===!1)return null;o=n}var a=s.getClassTreeInfo(),h=this.getUsedShaderCategories(s),l=a.classContent.getShaderAttributes(h),c="";return h.forEach(function(t){c+="#define "+t+"\n"}),o&&(c+="#define Instanced\n"),{attributes:o?i.concat(l):i,uniforms:o?null!=r?r:[]:null!=r?l.concat(r):null!=l?l:[],defines:c}},Object.defineProperty(r.prototype,"modelRenderCache",{get:function(){return this._modelRenderCache},enumerable:!0,configurable:!0}),r.prototype.createModelRenderCache=function(t){return null},r.prototype.setupModelRenderCache=function(t){},r.prototype.createInstanceDataParts=function(){return null},r.prototype.getUsedShaderCategories=function(t){return[]},r.prototype.beforeRefreshForLayoutConstruction=function(t){},r.prototype.afterRefreshForLayoutConstruction=function(t,e){},r.prototype.applyActualScaleOnTransform=function(){return!0},r.prototype.refreshInstanceDataPart=function(t){return!!this.isVisible&&(t.isVisible=this.isVisible,1===t.dataElementCount&&(t.curElement=0,this.updateInstanceDataPart(t)),!0)},r.prototype.updateInstanceDataPart=function(e,i){void 0===i&&(i=null);var n=this._globalTransform.multiply(this.renderGroup.invGlobalTransform),s=this._areSomeFlagsSet(t.SmartPropertyPrim.flagDontInheritParentScale)?r._uV:this.renderGroup.actualScale,o=this.renderGroup.viewportSize,a=this.actualZOffset,h=0,l=0;i&&(h=i.x*n.m[0]+i.y*n.m[4],l=i.x*n.m[1]+i.y*n.m[5]);var c=o.width,u=o.height,p=1/a,d=new t.Vector4(n.m[0]*s.x*2/c,2*n.m[4]/c,0,(n.m[12]+h)*s.x*2/c-1),f=new t.Vector4(2*n.m[1]/u,n.m[5]*s.y*2/u,0,(n.m[13]+l)*s.y*2/u-1);if(!this.applyActualScaleOnTransform()){var m=this.actualScale;d.x/=m.x,f.y/=m.y}e.transformX=d,e.transformY=f,e.opacity=this.actualOpacity,e.zBias=new t.Vector2(a,p)},r.prototype._updateRenderMode=function(){this.isTransparent?this._renderMode=t.Render2DContext.RenderModeTransparent:this.isAlphaTest?this._renderMode=t.Render2DContext.RenderModeAlphaTest:this._renderMode=t.Render2DContext.RenderModeOpaque},r.RENDERABLEPRIM2D_PROPCOUNT=t.Prim2DBase.PRIM2DBASE_PROPCOUNT+5,r._uV=new t.Vector2(1,1),s([t.dynamicLevelProperty(t.Prim2DBase.PRIM2DBASE_PROPCOUNT+0,function(t){return r.isAlphaTestProperty=t})],r.prototype,"isAlphaTest",null),s([t.dynamicLevelProperty(t.Prim2DBase.PRIM2DBASE_PROPCOUNT+1,function(t){return r.isTransparentProperty=t})],r.prototype,"isTransparent",null),r=s([t.className("RenderablePrim2D","BABYLON")],r)}(t.Prim2DBase);t.RenderablePrim2D=a}(r||(r={}));var r;!function(t){var e=function(e){function i(i){e.call(this,i),i||(i={});var r=null;i.border&&(r="string"==typeof i.border?t.Canvas2D.GetBrushFromString(i.border):i.border);var n=null;i.fill&&(n="string"==typeof i.fill?t.Canvas2D.GetBrushFromString(i.fill):i.fill),this._isTransparent=!1,this._oldTransparent=!1,this.border=r,this.fill=n,this._updateTransparencyStatus(),this.borderThickness=i.borderThickness}return o(i,e),Object.defineProperty(i.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this._updateTransparencyStatus()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fill",{get:function(){return this._fill},set:function(t){this._fill=t,this._updateTransparencyStatus()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"borderThickness",{get:function(){return this._borderThickness},set:function(t){this._borderThickness=t},enumerable:!0,configurable:!0}),i.prototype.getUsedShaderCategories=function(r){var n=e.prototype.getUsedShaderCategories.call(this,r);if(r.id===i.SHAPE2D_FILLPARTID){var s=this.fill;s instanceof t.SolidColorBrush2D&&n.push(i.SHAPE2D_CATEGORY_FILLSOLID),s instanceof t.GradientColorBrush2D&&n.push(i.SHAPE2D_CATEGORY_FILLGRADIENT)}if(r.id===i.SHAPE2D_BORDERPARTID){n.push(i.SHAPE2D_CATEGORY_BORDER);var o=this.border;o instanceof t.SolidColorBrush2D&&n.push(i.SHAPE2D_CATEGORY_BORDERSOLID),o instanceof t.GradientColorBrush2D&&n.push(i.SHAPE2D_CATEGORY_BORDERGRADIENT)}return n},i.prototype.applyActualScaleOnTransform=function(){return!1},i.prototype.refreshInstanceDataPart=function(r){if(!e.prototype.refreshInstanceDataPart.call(this,r))return!1;if(r.id===i.SHAPE2D_FILLPARTID){var n=r;if(this.fill){var s=this.fill;if(s instanceof t.SolidColorBrush2D)n.fillSolidColor=s.color;else if(s instanceof t.GradientColorBrush2D){n.fillGradientColor1=s.color1,n.fillGradientColor2=s.color2;var o=t.Matrix.Compose(new t.Vector3(s.scale,s.scale,s.scale),t.Quaternion.RotationAxis(new t.Vector3(0,0,1),s.rotation),new t.Vector3(s.translation.x,s.translation.y,0)),a=new t.Vector4(o.m[1],o.m[5],o.m[9],o.m[13]);n.fillGradientTY=a}}}else if(r.id===i.SHAPE2D_BORDERPARTID){var n=r;if(this.border){n.borderThickness=this.borderThickness;var h=this.border;if(h instanceof t.SolidColorBrush2D)n.borderSolidColor=h.color;else if(h instanceof t.GradientColorBrush2D){n.borderGradientColor1=h.color1,n.borderGradientColor2=h.color2;var o=t.Matrix.Compose(new t.Vector3(h.scale,h.scale,h.scale),t.Quaternion.RotationAxis(new t.Vector3(0,0,1),h.rotation),new t.Vector3(h.translation.x,h.translation.y,0)),a=new t.Vector4(o.m[1],o.m[5],o.m[9],o.m[13]);n.borderGradientTY=a}}}return!0},i.prototype._updateTransparencyStatus=function(){this._isTransparent=this._border&&this._border.isTransparent()||this._fill&&this._fill.isTransparent()||this.actualOpacity<1,this._isTransparent!==this._oldTransparent&&(this._oldTransparent=this._isTransparent,this._updateRenderMode())},i.prototype._mustUpdateInstance=function(){var t=this._oldTransparent!==this._isTransparent;return t&&(this._updateRenderMode(),this._oldTransparent=this._isTransparent),t},i.prototype._isPrimTransparent=function(){return this._isTransparent},i.SHAPE2D_BORDERPARTID=1,i.SHAPE2D_FILLPARTID=2,i.SHAPE2D_CATEGORY_BORDER="Border",i.SHAPE2D_CATEGORY_BORDERSOLID="BorderSolid",i.SHAPE2D_CATEGORY_BORDERGRADIENT="BorderGradient",i.SHAPE2D_CATEGORY_FILLSOLID="FillSolid",i.SHAPE2D_CATEGORY_FILLGRADIENT="FillGradient",i.SHAPE2D_PROPCOUNT=t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+5,s([t.modelLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+1,function(t){return i.borderProperty=t},!0)],i.prototype,"border",null),s([t.modelLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+2,function(t){return i.fillProperty=t},!0)],i.prototype,"fill",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+3,function(t){return i.borderThicknessProperty=t})],i.prototype,"borderThickness",null),i=s([t.className("Shape2D","BABYLON")],i)}(t.RenderablePrim2D);t.Shape2D=e;var i=function(i){function r(){i.apply(this,arguments)}return o(r,i),Object.defineProperty(r.prototype,"fillSolidColor",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fillGradientColor1",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fillGradientColor2",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fillGradientTY",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"borderThickness",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"borderSolidColor",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"borderGradientColor1",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"borderGradientColor2",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"borderGradientTY",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),s([t.instanceData(e.SHAPE2D_CATEGORY_FILLSOLID)],r.prototype,"fillSolidColor",null),s([t.instanceData(e.SHAPE2D_CATEGORY_FILLGRADIENT)],r.prototype,"fillGradientColor1",null),s([t.instanceData(e.SHAPE2D_CATEGORY_FILLGRADIENT)],r.prototype,"fillGradientColor2",null),s([t.instanceData(e.SHAPE2D_CATEGORY_FILLGRADIENT)],r.prototype,"fillGradientTY",null),s([t.instanceData(e.SHAPE2D_CATEGORY_BORDER)],r.prototype,"borderThickness",null),s([t.instanceData(e.SHAPE2D_CATEGORY_BORDERSOLID)],r.prototype,"borderSolidColor",null),s([t.instanceData(e.SHAPE2D_CATEGORY_BORDERGRADIENT)],r.prototype,"borderGradientColor1",null),s([t.instanceData(e.SHAPE2D_CATEGORY_BORDERGRADIENT)],r.prototype,"borderGradientColor2",null),s([t.instanceData(e.SHAPE2D_CATEGORY_BORDERGRADIENT)],r.prototype,"borderGradientTY",null),r}(t.InstanceDataBase);t.Shape2DInstanceData=i}(r||(r={}));var r;!function(t){var e=function(e){function r(i){null==i&&(i={}),null==i.origin&&(i.origin=new t.Vector2(0,0)),e.call(this,i);var n=i.size||i.width||i.height?i.size||new t.Size(i.width||0,i.height||0):null;this._trackedNode=null==i.trackNode?null:i.trackNode,this._trackedNode&&this.owner&&this.owner._registerTrackedNode(this),this._cacheBehavior=null==i.cacheBehavior?r.GROUPCACHEBEHAVIOR_FOLLOWCACHESTRATEGY:i.cacheBehavior;var s=this._renderableData;s&&(s._noResizeOnScale=0!=(this.cacheBehavior&r.GROUPCACHEBEHAVIOR_NORESIZEONSCALE)),this.size=n,this._viewportPosition=t.Vector2.Zero(),this._viewportSize=t.Size.Zero()}return o(r,e),r._createCachedCanvasGroup=function(e){return new r({parent:e,id:"__cachedCanvasGroup__",position:t.Vector2.Zero(),origin:t.Vector2.Zero(),size:null,isVisible:!0,isPickable:!1,dontInheritParentScale:!0})},r.prototype.applyCachedTexture=function(e,i){if(this._bindCacheTarget(),e)for(var r=e.uvs,n=this._renderableData._cacheNodeUVs,s=0;s<4;s++)r[2*s+0]=n[s].x,r[2*s+1]=n[s].y;i&&(i.diffuseTexture=this._renderableData._cacheTexture,i.emissiveColor=new t.Color3(1,1,1)),this._renderableData._cacheTexture.hasAlpha=!0,this._unbindCacheTarget()},Object.defineProperty(r.prototype,"cachedRect",{get:function(){return this._renderableData?this._renderableData._cacheNode:null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cachedUVs",{get:function(){return this._renderableData?this._renderableData._cacheNodeUVs:null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cachedUVsChanged",{get:function(){return this._renderableData?(this._renderableData._cacheNodeUVsChangedObservable||(this._renderableData._cacheNodeUVsChangedObservable=new t.Observable),this._renderableData._cacheNodeUVsChangedObservable):null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cacheTexture",{get:function(){return this._renderableData?this._renderableData._cacheTexture:null},enumerable:!0,configurable:!0}),r.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(null!=this._trackedNode&&(this.owner._unregisterTrackedNode(this),this._trackedNode=null),this._renderableData&&(this._renderableData.dispose(this.owner),this._renderableData=null),!0)},Object.defineProperty(r.prototype,"isRenderableGroup",{get:function(){return this._isRenderableGroup},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isCachedGroup",{get:function(){return this._isCachedGroup},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"viewportSize",{get:function(){return this._viewportSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"actualSize",{get:function(){var e;if(this._actualSize)return this._actualSize;if(this._size)e=new t.Size(Math.ceil(this._size.width),Math.ceil(this._size.height));else{var i=this.layoutBoundingInfo.max();e=new t.Size(Math.ceil(i.x),Math.ceil(i.y))}return e.equals(this._actualSize)||(this.onPrimitivePropertyDirty(r.actualSizeProperty.flagId),this._actualSize=e,this.handleGroupChanged(r.actualSizeProperty)),e},set:function(t){this._actualSize=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cacheBehavior",{get:function(){return this._cacheBehavior},enumerable:!0,configurable:!0}),r.prototype._addPrimToDirtyList=function(t){this._renderableData._primDirtyList.push(t)},r.prototype._renderCachedCanvas=function(){this.owner._addGroupRenderCount(1),this.updateCachedStates(!0);var e=new t.PrepareRender2DContext;this._prepareGroupRender(e),this._groupRender()},Object.defineProperty(r.prototype,"trackedNode",{get:function(){return this._trackedNode},set:function(e){null!=e?(this._isFlagSet(t.SmartPropertyPrim.flagTrackedGroup)||this.owner._registerTrackedNode(this),this._trackedNode=e):(this._isFlagSet(t.SmartPropertyPrim.flagTrackedGroup)&&this.owner._unregisterTrackedNode(this),this._trackedNode=null)},enumerable:!0,configurable:!0}),r.prototype.levelIntersect=function(t){return!0},r.prototype.updateLevelBoundingInfo=function(){var e;e=this.size?this.size:new t.Size(0,0),t.BoundingInfo2D.CreateFromSizeToRef(e,this._levelBoundingInfo)},r.prototype._prepareGroupRender=function(e){var i=null,r=this._renderableData;(r._primDirtyList.length>0||e.forceRefreshPrimitive)&&(i=r._primDirtyList.sort(function(t,e){return t.hierarchyDepth-e.hierarchyDepth}),this.updateCachedStatesOf(i,!0));var n=this.actualSize,s=this.actualScale,o=Math.ceil(n.width*s.x),a=Math.ceil(n.height*s.y);if((this instanceof t.Canvas2D||"__cachedCanvasGroup__"===this.id)&&null!=this.owner.designSize&&(o=this.owner.engine.getRenderWidth(),a=this.owner.engine.getRenderHeight()),!this._isCachedGroup){var h=this._globalTransform.getTranslation(),l=this.owner._renderingSize;a=Math.min(a,l.height-h.y),o=Math.min(o,l.width-h.x);var c=h.x,u=h.y;this._viewportPosition.x=c,this._viewportPosition.y=u}if(this._viewportSize.width===o&&this._viewportSize.height===a||(e.forceRefreshPrimitive=!0,this._viewportSize.width=o,this._viewportSize.height=a),r._primDirtyList.length>0||e.forceRefreshPrimitive){if(this._cacheGroupDirty=this._isCachedGroup,r._primNewDirtyList.splice(0),e.forceRefreshPrimitive)for(var p=0,d=this._children;p<d.length;p++){var f=d[p];f._prepareRender(e)}else i||(i=r._primDirtyList.sort(function(t,e){return t.hierarchyDepth-e.hierarchyDepth})),i.forEach(function(t){!t.isDisposed&&t._needPrepare()&&t._prepareRender(e)});r._primDirtyList.forEach(function(e){r._primNewDirtyList.indexOf(e)===-1?e._resetPropertiesDirty():e._setFlags(t.SmartPropertyPrim.flagNeedRefresh)}),r._primDirtyList.splice(0),r._primDirtyList=r._primDirtyList.concat(r._primNewDirtyList)}r._childrenRenderableGroups.forEach(function(t){t._prepareGroupRender(e)})},r.prototype._groupRender=function(){for(var e=this,i=this.owner.engine,r=0,n=0,s=this._renderableData._childrenRenderableGroups;n<s.length;n++){s[n]._groupRender()}if(!this.isCachedGroup||this._cacheGroupDirty){if(this.owner._addGroupRenderCount(1),this.isCachedGroup)this._bindCacheTarget();else var o=i.setDirectViewport(this._viewportPosition.x,this._viewportPosition.y,this._viewportSize.width,this._viewportSize.height);var a=i.getAlphaTesting()===!0,h=i.getDepthWrite()===!0;i.setAlphaTesting(!1),i.setDepthWrite(!0);var l=new t.Render2DContext(t.Render2DContext.RenderModeOpaque);this._renderableData._renderGroupInstancesInfo.forEach(function(t,n){var s=e._prepareContext(i,l,n);if(null!==s&&(!e.owner.supportInstancedArray||s>0)){var o=!n.modelRenderCache.render(n,l);n.opaqueDirty=o,r+=o?1:0}}),i.setAlphaTesting(!0),i.setDepthWrite(!0),l=new t.Render2DContext(t.Render2DContext.RenderModeAlphaTest),this._renderableData._renderGroupInstancesInfo.forEach(function(t,n){var s=e._prepareContext(i,l,n);if(null!==s&&(!e.owner.supportInstancedArray||s>0)){var o=!n.modelRenderCache.render(n,l);n.opaqueDirty=o,r+=o?1:0}}),i.setAlphaTesting(!0),i.setDepthWrite(!1),this._renderableData._transparentListChanged&&this._updateTransparentData(),r+=this._renderTransparentData(),this._cacheGroupDirty=0!==r,this.isCachedGroup?this._unbindCacheTarget():o&&i.setViewport(o),i.setAlphaTesting(a),i.setDepthWrite(h)}},r.prototype._setCacheGroupDirty=function(){this._cacheGroupDirty=!0},r.prototype._updateTransparentData=function(){this.owner._addUpdateTransparentDataCount(1);var e=this._renderableData;e._transparentPrimitives.sort(function(t,e){return e._primitive.actualZOffset-t._primitive.actualZOffset});for(var i=function(t,i){var r=e._transparentPrimitives[i];return t.groupInsanceInfo===r._groupInstanceInfo&&(r._transparentSegment=t,r._primitive._updateTransparentSegmentIndices(t),!0)},r=0,n=e._transparentSegments;r<n.length;r++){var s=n[r];s.dispose(this.owner.engine)}e._transparentSegments.splice(0);for(var o=null,a=0;a<e._transparentPrimitives.length;a++){var h=e._transparentPrimitives[a];if(h._groupInstanceInfo.transparentOrderDirty&&h._groupInstanceInfo.sortTransparentData(),h._transparentSegment=null,o&&i(o,a),!h._transparentSegment){var s=new t.TransparentSegment;s.groupInsanceInfo=h._groupInstanceInfo;var l=h._primitive;s.startZ=l.actualZOffset,l._updateTransparentSegmentIndices(s),s.endZ=s.startZ,h._transparentSegment=s,e._transparentSegments.push(s)}o=h._transparentSegment}e._transparentListChanged=!1},r.prototype._renderTransparentData=function(){for(var e=0,i=new t.Render2DContext(t.Render2DContext.RenderModeTransparent),r=this._renderableData,n=this.owner.supportInstancedArray,s=r._transparentSegments.length,o=0;o<s;o++){i.instancedBuffers=null;var a=r._transparentSegments[o],h=a.groupInsanceInfo,l=h.modelRenderCache,c=this.owner.engine,u=a.endDataIndex-a.startDataIndex;if(n&&u>=this.owner.minPartCountToUseInstancedArray){if(a.partBuffers){if(h.transparentDirty)for(var p=0;p<h.transparentData.length;p++){var d=h.transparentData[p],f=d._partData,m=f.pack(),_=f.stride,g=a.partBuffers[p],y=m.subarray(a.startDataIndex*_,a.endDataIndex*_);c.bindArrayBuffer(g),c.updateArrayBuffer(y)}}else{for(var v=new Array,p=0;p<h.transparentData.length;p++){var d=h.transparentData[p],f=d._partData,m=f.pack(),_=f.stride,x=u*_*4,g=c.createInstancesBuffer(x),y=m.subarray(a.startDataIndex*_,a.endDataIndex*_);c.updateArrayBuffer(y),v.push(g)}a.partBuffers=v}i.useInstancing=!0,i.instancesCount=u,i.instancedBuffers=a.partBuffers,i.groupInfoPartData=h.transparentData;var b=!l.render(h,i);e+=b?1:0}else{i.useInstancing=!1,i.partDataStartIndex=a.startDataIndex,i.partDataEndIndex=a.endDataIndex,i.groupInfoPartData=h.transparentData;var b=!l.render(h,i);e+=b?1:0}}return e},r.prototype._prepareContext=function(e,i,r){var n,s,o=null;switch(i.renderMode){case t.Render2DContext.RenderModeOpaque:if(!r.hasOpaqueData)return null;n=function(t){r.opaqueDirty=t},s=function(){return r.opaqueDirty},i.groupInfoPartData=r.opaqueData,o=r.opaqueData;break;case t.Render2DContext.RenderModeAlphaTest:if(!r.hasAlphaTestData)return null;n=function(t){r.alphaTestDirty=t},s=function(){return r.alphaTestDirty},i.groupInfoPartData=r.alphaTestData,o=r.alphaTestData;break;default:throw new Error("_prepareContext is only for opaque or alphaTest")}var a=0;if(this.owner.supportInstancedArray){i.useInstancing=!0;for(var h=0;h<o.length;h++){var l=o[h],c=l._partData,u=c.pack();a+=c.usedElementCount;var p=c.usedElementCount*c.stride*4;!l._partBuffer||l._partBufferSize<p?(l._partBuffer&&e.deleteInstancesBuffer(l._partBuffer),l._partBuffer=e.createInstancesBuffer(p),l._partBufferSize=p,n(!1),e.updateArrayBuffer(u)):s()&&(e.bindArrayBuffer(l._partBuffer),e.updateArrayBuffer(u))}n(!1)}else if(i.partDataStartIndex=0,i.groupInfoPartData.length>0){for(var h=0;!i.groupInfoPartData[h];)h++;i.partDataEndIndex=i.groupInfoPartData[h]._partData.usedElementCount}return a},r.prototype._setRenderingScale=function(t){this._renderableData._renderingScale!==t&&(this._renderableData._renderingScale=t)},r.prototype._bindCacheTarget=function(){var e,i,n,s=this._renderableData,o=s._renderingScale,a=s._noResizeOnScale,h=null==this.parent;n=a?h?r._uV:this.parent.actualScale:this.actualScale,h&&this.owner.cachingStrategy===t.Canvas2D.CACHESTRATEGY_CANVAS&&this.owner.isScreenSpace?this.owner.designSize||this.owner.fitRenderingDevice?(r._s.width=this.owner.engine.getRenderWidth(),r._s.height=this.owner.engine.getRenderHeight()):r._s.copyFrom(this.owner.size):(r._s.width=Math.ceil(this.actualSize.width*n.x*o),r._s.height=Math.ceil(this.actualSize.height*n.y*o));var l=!r._s.equals(s._cacheSize);if(s._cacheNode){var c=s._cacheNode.contentSize;if(c.width<r._s.width||c.height<r._s.height){var u=this.owner.isScreenSpace?1.07:1;e=Math.floor(r._s.width*u),i=Math.floor(r._s.height*u),s._cacheTexture.freeRect(s._cacheNode),s._cacheNode=null}}if(!s._cacheNode){var p=this.owner._allocateGroupCache(this,this.parent&&this.parent.renderGroup,e?new t.Size(e,i):null,s._useMipMap,s._anisotropicLevel);s._cacheNode=p.node,s._cacheTexture=p.texture,s._cacheRenderSprite&&s._cacheRenderSprite.dispose(),s._cacheRenderSprite=p.sprite,l=!0}l&&(s._cacheSize.copyFrom(r._s),s._cacheNodeUVs=s._cacheNode.getUVsForCustomSize(s._cacheSize),s._cacheNodeUVsChangedObservable&&s._cacheNodeUVsChangedObservable.hasObservers()&&s._cacheNodeUVsChangedObservable.notifyObservers(s._cacheNodeUVs),this._setFlags(t.SmartPropertyPrim.flagWorldCacheChanged));var d=s._cacheNode;s._cacheTexture.bindTextureForPosSize(d.pos,r._s,!0)},r.prototype._unbindCacheTarget=function(){this._renderableData._cacheTexture&&this._renderableData._cacheTexture.unbindTexture()},r.prototype._spreadActualScaleDirty=function(){this._renderableData&&this._renderableData._cacheRenderSprite&&this.handleGroupChanged(t.Prim2DBase.actualScaleProperty),e.prototype._spreadActualScaleDirty.call(this)},r.prototype.handleGroupChanged=function(e){var i=this._renderableData;if(i){var n=i._cacheRenderSprite;if(this.isCachedGroup&&n)switch(e.id){case t.Prim2DBase.actualPositionProperty.id:n.actualPosition=this.actualPosition.clone(),null!=n.position&&(n.position=n.actualPosition.clone());break;case t.Prim2DBase.rotationProperty.id:n.rotation=this.rotation;break;case t.Prim2DBase.scaleProperty.id:n.scale=this.scale;break;case t.Prim2DBase.originProperty.id:n.origin=this.origin.clone();break;case r.actualSizeProperty.id:n.size=this.actualSize.clone()}}},r.prototype.detectGroupStates=function(){var e=this instanceof t.Canvas2D,n=this.owner.cachingStrategy;if(n===t.Canvas2D.CACHESTRATEGY_DONTCACHE)this._isRenderableGroup=e,this._isCachedGroup=!1;else if(n===t.Canvas2D.CACHESTRATEGY_CANVAS)e?(this._isRenderableGroup=!0,this._isCachedGroup=!0):(this._isRenderableGroup="__cachedCanvasGroup__"===this.id,this._isCachedGroup=!1);else if(n===t.Canvas2D.CACHESTRATEGY_TOPLEVELGROUPS)e?(this._isRenderableGroup=!0,this._isCachedGroup=!1):1===this.hierarchyDepth?(this._isRenderableGroup=!0,this._isCachedGroup=!0):(this._isRenderableGroup=!1,this._isCachedGroup=!1);else if(n===t.Canvas2D.CACHESTRATEGY_ALLGROUPS)if(e)this._isRenderableGroup=!0,this._isCachedGroup=!1;else{var s=this.cacheBehavior&r.GROUPCACHEBEHAVIOR_OPTIONMASK;s!==r.GROUPCACHEBEHAVIOR_DONTCACHEOVERRIDE&&s!==r.GROUPCACHEBEHAVIOR_CACHEINPARENTGROUP||(this._isRenderableGroup=s===r.GROUPCACHEBEHAVIOR_DONTCACHEOVERRIDE,this._isCachedGroup=!1),s===r.GROUPCACHEBEHAVIOR_FOLLOWCACHESTRATEGY&&(this._isRenderableGroup=!0,this._isCachedGroup=!0)}if(this._isRenderableGroup&&(this._renderableData||(this._renderableData=new i)),this._isCachedGroup){this._renderableData._noResizeOnScale=0!=(this.cacheBehavior&r.GROUPCACHEBEHAVIOR_NORESIZEONSCALE);for(var o=this.parent;o;){if(o instanceof r&&o._isRenderableGroup){o._renderableData._childrenRenderableGroups.indexOf(this)===-1&&o._renderableData._childrenRenderableGroups.push(this);break}o=o.parent}}},r.GROUP2D_PROPCOUNT=t.Prim2DBase.PRIM2DBASE_PROPCOUNT+5,r.GROUPCACHEBEHAVIOR_FOLLOWCACHESTRATEGY=0,r.GROUPCACHEBEHAVIOR_DONTCACHEOVERRIDE=1,r.GROUPCACHEBEHAVIOR_CACHEINPARENTGROUP=2,r.GROUPCACHEBEHAVIOR_NORESIZEONSCALE=256,r.GROUPCACHEBEHAVIOR_OPTIONMASK=255,r._uV=new t.Vector2(1,1),r._s=t.Size.Zero(),r._unS=new t.Vector2(1,1),s([t.instanceLevelProperty(t.Prim2DBase.PRIM2DBASE_PROPCOUNT+1,function(t){return r.sizeProperty=t},!1,!0)],r.prototype,"size",null),s([t.instanceLevelProperty(t.Prim2DBase.PRIM2DBASE_PROPCOUNT+2,function(t){return r.actualSizeProperty=t})],r.prototype,"actualSize",null),r=s([t.className("Group2D","BABYLON")],r)}(t.Prim2DBase);t.Group2D=e;var i=function(){function e(){this._primDirtyList=new Array,this._primNewDirtyList=new Array,this._childrenRenderableGroups=new Array,this._renderGroupInstancesInfo=new t.StringDictionary,this._transparentPrimitives=new Array,this._transparentSegments=new Array,this._transparentListChanged=!1,this._cacheNode=null,this._cacheTexture=null,this._cacheRenderSprite=null,this._renderingScale=1,this._cacheNodeUVs=null,this._cacheNodeUVsChangedObservable=null,this._cacheSize=t.Size.Zero(),this._useMipMap=!1,this._anisotropicLevel=1,this._noResizeOnScale=!1}return e.prototype.dispose=function(t){var e=t.engine;if(this._cacheRenderSprite&&(this._cacheRenderSprite.dispose(),this._cacheRenderSprite=null),this._cacheTexture&&this._cacheNode&&(this._cacheTexture.freeRect(this._cacheNode),this._cacheTexture=null,this._cacheNode=null),this._primDirtyList&&(this._primDirtyList.splice(0),this._primDirtyList=null),this._renderGroupInstancesInfo&&(this._renderGroupInstancesInfo.forEach(function(t,e){e.dispose()}),this._renderGroupInstancesInfo=null),this._cacheNodeUVsChangedObservable&&(this._cacheNodeUVsChangedObservable.clear(),this._cacheNodeUVsChangedObservable=null),this._transparentSegments){for(var i=0,r=this._transparentSegments;i<r.length;i++){r[i].dispose(e)}this._transparentSegments.splice(0),this._transparentSegments=null}},e.prototype.addNewTransparentPrimitiveInfo=function(t,e){var i=new r;return i._primitive=t,i._groupInstanceInfo=e,i._transparentSegment=null,this._transparentPrimitives.push(i),this._transparentListChanged=!0,i},e.prototype.removeTransparentPrimitiveInfo=function(t){var e=this._transparentPrimitives.indexOf(t);e!==-1&&(this._transparentPrimitives.splice(e,1),this._transparentListChanged=!0)},e.prototype.transparentPrimitiveZChanged=function(t){this._transparentListChanged=!0},e}();t.RenderableGroupData=i;var r=function(){function t(){}return t}();t.TransparentPrimitiveInfo=r}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i){e.call(this,t,i),this.effectsReady=!1,this.fillVB=null,this.fillIB=null,this.fillIndicesCount=0,this.instancingFillAttributes=null,this.effectFill=null,this.effectFillInstanced=null,this.borderVB=null,this.borderIB=null,this.borderIndicesCount=0,this.instancingBorderAttributes=null,this.effectBorder=null,this.effectBorderInstanced=null}return o(i,e),i.prototype.render=function(e,i){if(!this.effectsReady){if(this.effectFill&&(!this.effectFill.isReady()||this.effectFillInstanced&&!this.effectFillInstanced.isReady())||this.effectBorder&&(!this.effectBorder.isReady()||this.effectBorderInstanced&&!this.effectBorderInstanced.isReady()))return!1;this.effectsReady=!0}var r=e.owner.owner,n=r.engine,s=0;this.effectFill&&this.effectBorder&&(s=n.getDepthFunction(),n.setDepthFunctionToLessOrEqual());var o=n.getAlphaMode();if(this.effectFill){var a=e.partIndexFromId.get(t.Shape2D.SHAPE2D_FILLPARTID.toString()),h=i.groupInfoPartData[a];i.renderMode!==t.Render2DContext.RenderModeOpaque&&n.setAlphaMode(t.Engine.ALPHA_COMBINE,!0);var l=i.useInstancing?this.effectFillInstanced:this.effectFill;if(n.enableEffect(l),n.bindBuffersDirectly(this.fillVB,this.fillIB,[1],4,l),i.useInstancing){this.instancingFillAttributes||(this.instancingFillAttributes=this.loadInstancingAttributes(t.Shape2D.SHAPE2D_FILLPARTID,l));var c=i.instancedBuffers?i.instancedBuffers[a]:h._partBuffer,u=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;r._addDrawCallCount(1,i.renderMode),n.updateAndBindInstancesBuffer(c,null,this.instancingFillAttributes),n.draw(!0,0,this.fillIndicesCount,u),n.unbindInstanceAttributes()}else{r._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(l,a,h._partData,p),n.draw(!0,0,this.fillIndicesCount)}}if(this.effectBorder){var a=e.partIndexFromId.get(t.Shape2D.SHAPE2D_BORDERPARTID.toString()),h=i.groupInfoPartData[a];i.renderMode!==t.Render2DContext.RenderModeOpaque&&n.setAlphaMode(t.Engine.ALPHA_COMBINE,!0);var l=i.useInstancing?this.effectBorderInstanced:this.effectBorder;if(n.enableEffect(l),n.bindBuffersDirectly(this.borderVB,this.borderIB,[1],4,l),i.useInstancing){this.instancingBorderAttributes||(this.instancingBorderAttributes=this.loadInstancingAttributes(t.Shape2D.SHAPE2D_BORDERPARTID,l));var c=i.instancedBuffers?i.instancedBuffers[a]:h._partBuffer,u=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;r._addDrawCallCount(1,i.renderMode),n.updateAndBindInstancesBuffer(c,null,this.instancingBorderAttributes),n.draw(!0,0,this.borderIndicesCount,u),n.unbindInstanceAttributes()}else{r._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(l,a,h._partData,p),n.draw(!0,0,this.borderIndicesCount)}}return n.setAlphaMode(o,!0),this.effectFill&&this.effectBorder&&n.setDepthFunction(s),!0},i.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(this.fillVB&&(this._engine._releaseBuffer(this.fillVB),this.fillVB=null),this.fillIB&&(this._engine._releaseBuffer(this.fillIB),this.fillIB=null),this.effectFill=null,this.effectFillInstanced=null,this.effectBorder=null,this.effectBorderInstanced=null,this.borderVB&&(this._engine._releaseBuffer(this.borderVB),this.borderVB=null),this.borderIB&&(this._engine._releaseBuffer(this.borderIB),this.borderIB=null),!0)},i}(t.ModelRenderCache);t.Rectangle2DRenderCache=e;var i=function(e){function i(t){e.call(this,t,1)}return o(i,e),Object.defineProperty(i.prototype,"properties",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),s([t.instanceData()],i.prototype,"properties",null),i}(t.Shape2DInstanceData);t.Rectangle2DInstanceData=i;var r=function(r){function n(e){if(null==e&&(e={}),r.call(this,e),null!=e.size)this.size=e.size;else if(e.width||e.height){var i=new t.Size(e.width,e.height);this.size=i}var n=null==e.roundRadius?0:e.roundRadius,s=null==e.borderThickness?1:e.borderThickness;this.roundRadius=n,this.borderThickness=s}return o(n,r),Object.defineProperty(n.prototype,"actualSize",{get:function(){return this._actualSize?this._actualSize:this.size},set:function(t){this._actualSize=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"notRounded",{get:function(){return this._notRounded},set:function(t){this._notRounded=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"roundRadius",{get:function(){return this._roundRadius},set:function(t){this._roundRadius=t,this.notRounded=0===t,this._positioningDirty()},enumerable:!0,configurable:!0}),n.prototype.levelIntersect=function(t){if(this.notRounded)return!0;var e=this.size;n._i0.x=t._localPickPosition.x,n._i0.y=t._localPickPosition.y;var i=this.roundRadius,r=i*i;return n._i1.x=i,n._i1.y=i,n._i0.x<=n._i1.x&&n._i0.y<=n._i1.y?(n._i2.x=n._i0.x-n._i1.x,n._i2.y=n._i0.y-n._i1.y,n._i2.lengthSquared()<=r):(n._i1.x=i,n._i1.y=e.height-i,n._i0.x<=n._i1.x&&n._i0.y>=n._i1.y?(n._i2.x=n._i0.x-n._i1.x,n._i2.y=n._i0.y-n._i1.y,n._i2.lengthSquared()<=r):(n._i1.x=e.width-i,n._i1.y=e.height-i,n._i0.x>=n._i1.x&&n._i0.y>=n._i1.y?(n._i2.x=n._i0.x-n._i1.x,n._i2.y=n._i0.y-n._i1.y,n._i2.lengthSquared()<=r):(n._i1.x=e.width-i,n._i1.y=i,!(n._i0.x>=n._i1.x&&n._i0.y<=n._i1.y)||(n._i2.x=n._i0.x-n._i1.x,n._i2.y=n._i0.y-n._i1.y,n._i2.lengthSquared()<=r))))},n.prototype.updateLevelBoundingInfo=function(){t.BoundingInfo2D.CreateFromSizeToRef(this.actualSize,this._levelBoundingInfo)},n.prototype.createModelRenderCache=function(t){return new e(this.owner.engine,t)},n.prototype.setupModelRenderCache=function(e){var i=e,r=this.owner.engine;if(this.fill){for(var s=4*(this.notRounded?1:n.roundSubdivisions)+1,o=new Float32Array(s),a=0;a<s;a++)o[a]=a;i.fillVB=r.createVertexBuffer(o);for(var h=s-1,l=new Float32Array(3*h),a=0;a<h;a++)l[3*a+0]=0,l[3*a+2]=a+1,l[3*a+1]=a+2;l[3*h-2]=1,i.fillIB=r.createIndexBuffer(l),i.fillIndicesCount=3*h;var c=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_FILLPARTID,["index"],null,!0);c&&(i.effectFillInstanced=r.createEffect("rect2d",c.attributes,c.uniforms,[],c.defines,null)),c=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_FILLPARTID,["index"],null,!1),i.effectFill=r.createEffect("rect2d",c.attributes,c.uniforms,[],c.defines,null)}if(this.border){for(var s=4*(this.notRounded?1:n.roundSubdivisions)*2,o=new Float32Array(s),a=0;a<s;a++)o[a]=a;i.borderVB=r.createVertexBuffer(o);for(var h=s,u=h/2,l=new Float32Array(3*h),a=0;a<u;a++){var p=a,d=(a+1)%u;l[6*a+0]=u+d,l[6*a+1]=u+p,l[6*a+2]=p,l[6*a+3]=d,l[6*a+4]=u+d,l[6*a+5]=p}i.borderIB=r.createIndexBuffer(l),i.borderIndicesCount=3*h;var c=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_BORDERPARTID,["index"],null,!0);c&&(i.effectBorderInstanced=r.createEffect("rect2d",c.attributes,c.uniforms,[],c.defines,null)),c=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_BORDERPARTID,["index"],null,!1),i.effectBorder=r.createEffect("rect2d",c.attributes,c.uniforms,[],c.defines,null)}return i},n.prototype._getInitialContentAreaToRef=function(t,e,i){if(this._notRounded)r.prototype._getInitialContentAreaToRef.call(this,t,e,i);else{var n=Math.round(1.3*(this.roundRadius-this.roundRadius/Math.sqrt(2)));e.x=e.y=n,i.width=Math.max(0,t.width-2*n),i.height=Math.max(0,t.height-2*n),e.z=t.width-(e.x+i.width),e.w=t.height-(e.y+i.height)}},n.prototype._getActualSizeFromContentToRef=function(t,e){if(this._notRounded)r.prototype._getActualSizeFromContentToRef.call(this,t,e);else{var i=Math.round(1.3*(this.roundRadius-this.roundRadius/Math.sqrt(2)));e.copyFrom(t),e.width+=2*i,e.height+=2*i}},n.prototype.createInstanceDataParts=function(){var e=new Array;return this.border&&e.push(new i(t.Shape2D.SHAPE2D_BORDERPARTID)),this.fill&&e.push(new i(t.Shape2D.SHAPE2D_FILLPARTID)),e},n.prototype.refreshInstanceDataPart=function(e){if(!r.prototype.refreshInstanceDataPart.call(this,e))return!1;if(e.id===t.Shape2D.SHAPE2D_BORDERPARTID){var i=e,n=this.actualSize,s=this.actualScale;i.properties=new t.Vector3(n.width*s.x,n.height*s.y,this.roundRadius||0)}else if(e.id===t.Shape2D.SHAPE2D_FILLPARTID){var i=e,n=this.actualSize,s=this.actualScale;i.properties=new t.Vector3(n.width*s.x,n.height*s.y,this.roundRadius||0)}return!0},n._i0=t.Vector2.Zero(),n._i1=t.Vector2.Zero(),n._i2=t.Vector2.Zero(),n.roundSubdivisions=16,s([t.instanceLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+1,function(t){return n.actualSizeProperty=t},!1,!0)],n.prototype,"actualSize",null),s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+2,function(t){return n.notRoundedProperty=t})],n.prototype,"notRounded",null),s([t.instanceLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+3,function(t){return n.roundRadiusProperty=t})],n.prototype,"roundRadius",null),n=s([t.className("Rectangle2D","BABYLON")],n)}(t.Shape2D);t.Rectangle2D=r}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i){e.call(this,t,i),this.effectsReady=!1,this.fillVB=null,this.fillIB=null,this.fillIndicesCount=0,this.instancingFillAttributes=null,this.effectFillInstanced=null,this.effectFill=null,this.borderVB=null,this.borderIB=null,this.borderIndicesCount=0,this.instancingBorderAttributes=null,this.effectBorderInstanced=null,this.effectBorder=null}return o(i,e),i.prototype.render=function(e,i){if(!this.effectsReady){if(this.effectFill&&(!this.effectFill.isReady()||this.effectFillInstanced&&!this.effectFillInstanced.isReady())||this.effectBorder&&(!this.effectBorder.isReady()||this.effectBorderInstanced&&!this.effectBorderInstanced.isReady()))return!1;this.effectsReady=!0}var r=e.owner.owner,n=r.engine,s=0;this.effectFill&&this.effectBorder&&(s=n.getDepthFunction(),n.setDepthFunctionToLessOrEqual());var o=n.getAlphaMode();if(this.effectFill){var a=e.partIndexFromId.get(t.Shape2D.SHAPE2D_FILLPARTID.toString()),h=i.groupInfoPartData[a];i.renderMode!==t.Render2DContext.RenderModeOpaque&&n.setAlphaMode(t.Engine.ALPHA_COMBINE,!0);var l=i.useInstancing?this.effectFillInstanced:this.effectFill;if(n.enableEffect(l),n.bindBuffersDirectly(this.fillVB,this.fillIB,[1],4,l),i.useInstancing){this.instancingFillAttributes||(this.instancingFillAttributes=this.loadInstancingAttributes(t.Shape2D.SHAPE2D_FILLPARTID,l));var c=i.instancedBuffers?i.instancedBuffers[a]:h._partBuffer,u=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;r._addDrawCallCount(1,i.renderMode),n.updateAndBindInstancesBuffer(c,null,this.instancingFillAttributes),n.draw(!0,0,this.fillIndicesCount,u),n.unbindInstanceAttributes()}else{r._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(l,a,h._partData,p),n.draw(!0,0,this.fillIndicesCount)}}if(this.effectBorder){var a=e.partIndexFromId.get(t.Shape2D.SHAPE2D_BORDERPARTID.toString()),h=i.groupInfoPartData[a];i.renderMode!==t.Render2DContext.RenderModeOpaque&&n.setAlphaMode(t.Engine.ALPHA_COMBINE,!0);var l=i.useInstancing?this.effectBorderInstanced:this.effectBorder;if(n.enableEffect(l),n.bindBuffersDirectly(this.borderVB,this.borderIB,[1],4,l),i.useInstancing){this.instancingBorderAttributes||(this.instancingBorderAttributes=this.loadInstancingAttributes(t.Shape2D.SHAPE2D_BORDERPARTID,l));var c=i.instancedBuffers?i.instancedBuffers[a]:h._partBuffer,u=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;r._addDrawCallCount(1,i.renderMode),n.updateAndBindInstancesBuffer(c,null,this.instancingBorderAttributes),n.draw(!0,0,this.borderIndicesCount,u),n.unbindInstanceAttributes()}else{r._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(l,a,h._partData,p),n.draw(!0,0,this.borderIndicesCount)}}return n.setAlphaMode(o,!0),this.effectFill&&this.effectBorder&&n.setDepthFunction(s),!0},i.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(this.fillVB&&(this._engine._releaseBuffer(this.fillVB),this.fillVB=null),this.fillIB&&(this._engine._releaseBuffer(this.fillIB),this.fillIB=null),this.effectFill=null,this.effectFillInstanced=null,this.effectBorder=null,this.effectBorderInstanced=null,this.borderVB&&(this._engine._releaseBuffer(this.borderVB),this.borderVB=null),this.borderIB&&(this._engine._releaseBuffer(this.borderIB),this.borderIB=null),!0)},i}(t.ModelRenderCache);t.Ellipse2DRenderCache=e;var i=function(e){function i(t){e.call(this,t,1)}return o(i,e),Object.defineProperty(i.prototype,"properties",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),s([t.instanceData()],i.prototype,"properties",null),i}(t.Shape2DInstanceData);t.Ellipse2DInstanceData=i;var r=function(r){function n(e){if(null==e&&(e={}),r.call(this,e),null!=e.size)this.size=e.size;else if(e.width||e.height){var i=new t.Size(e.width,e.height);this.size=i}var n=null==e.subdivisions?64:e.subdivisions;this.subdivisions=n}return o(n,r),Object.defineProperty(n.prototype,"actualSize",{get:function(){return this._actualSize?this._actualSize:this.size},set:function(t){this._actualSize=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"subdivisions",{get:function(){return this._subdivisions},set:function(t){this._subdivisions=t},enumerable:!0,configurable:!0}),n.prototype.levelIntersect=function(t){var e=this.size.width/2,i=this.size.height/2,r=t._localPickPosition.x-e,n=t._localPickPosition.y-i;return r*r/(e*e)+n*n/(i*i)<=1},n.prototype.updateLevelBoundingInfo=function(){t.BoundingInfo2D.CreateFromSizeToRef(this.actualSize,this._levelBoundingInfo)},n.prototype.createModelRenderCache=function(t){return new e(this.owner.engine,t)},n.prototype.setupModelRenderCache=function(e){var i=e,r=this.owner.engine;if(this.fill){for(var n=this.subdivisions+1,s=new Float32Array(n),o=0;o<n;o++)s[o]=o;i.fillVB=r.createVertexBuffer(s);for(var a=n-1,h=new Float32Array(3*a),o=0;o<a;o++)h[3*o+0]=0,h[3*o+2]=o+1,h[3*o+1]=o+2;h[3*a-2]=1,i.fillIB=r.createIndexBuffer(h),i.fillIndicesCount=3*a;var l=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_FILLPARTID,["index"],null,!0);l&&(i.effectFillInstanced=r.createEffect({vertex:"ellipse2d",fragment:"ellipse2d"},l.attributes,l.uniforms,[],l.defines,null)),l=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_FILLPARTID,["index"],null,!1),i.effectFill=r.createEffect({vertex:"ellipse2d",fragment:"ellipse2d"},l.attributes,l.uniforms,[],l.defines,null)}if(this.border){for(var n=2*this.subdivisions,s=new Float32Array(n),o=0;o<n;o++)s[o]=o;i.borderVB=r.createVertexBuffer(s);for(var a=n,c=a/2,h=new Float32Array(3*a),o=0;o<c;o++){var u=o,p=(o+1)%c;h[6*o+0]=c+p,h[6*o+1]=c+u,h[6*o+2]=u,h[6*o+3]=p,h[6*o+4]=c+p,h[6*o+5]=u}i.borderIB=r.createIndexBuffer(h),i.borderIndicesCount=3*a;var l=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_BORDERPARTID,["index"],null,!0);l&&(i.effectBorderInstanced=r.createEffect("ellipse2d",l.attributes,l.uniforms,[],l.defines,null)),l=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_BORDERPARTID,["index"],null,!1),i.effectBorder=r.createEffect("ellipse2d",l.attributes,l.uniforms,[],l.defines,null)}return i},n.prototype.createInstanceDataParts=function(){var e=new Array;return this.border&&e.push(new i(t.Shape2D.SHAPE2D_BORDERPARTID)),this.fill&&e.push(new i(t.Shape2D.SHAPE2D_FILLPARTID)),e},n.prototype.refreshInstanceDataPart=function(e){if(!r.prototype.refreshInstanceDataPart.call(this,e))return!1;if(e.id===t.Shape2D.SHAPE2D_BORDERPARTID){var i=e,n=this.actualSize,s=this.actualScale;i.properties=new t.Vector3(n.width*s.x,n.height*s.y,this.subdivisions)}else if(e.id===t.Shape2D.SHAPE2D_FILLPARTID){var i=e,n=this.actualSize,s=this.actualScale;i.properties=new t.Vector3(n.width*s.x,n.height*s.y,this.subdivisions)}return!0},s([t.instanceLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+1,function(t){return n.acutalSizeProperty=t},!1,!0)],n.prototype,"actualSize",null),s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+2,function(t){return n.subdivisionsProperty=t})],n.prototype,"subdivisions",null),n=s([t.className("Ellipse2D","BABYLON")],n)}(t.Shape2D);t.Ellipse2D=r}(r||(r={}));var r;!function(t){var e=function(e){function i(){e.apply(this,arguments),this.effectsReady=!1,this.vb=null,this.ib=null,this.instancingAttributes=null,this.texture=null,this.effect=null,this.effectInstanced=null}return o(i,e),i.prototype.render=function(e,i){if(!this.effectsReady){if(this.effect&&(!this.effect.isReady()||this.effectInstanced&&!this.effectInstanced.isReady()))return!1;this.effectsReady=!0}var n=e.owner.owner,s=n.engine,o=s.getAlphaMode(),a=i.useInstancing?this.effectInstanced:this.effect;s.enableEffect(a),a.setTexture("diffuseSampler",this.texture),s.bindBuffersDirectly(this.vb,this.ib,[1],4,a),i.renderMode!==t.Render2DContext.RenderModeOpaque&&s.setAlphaMode(t.Engine.ALPHA_COMBINE,!0),a.setBool("alphaTest",i.renderMode===t.Render2DContext.RenderModeAlphaTest);var h=i.groupInfoPartData[0];if(i.useInstancing){this.instancingAttributes||(this.instancingAttributes=this.loadInstancingAttributes(r.SPRITE2D_MAINPARTID,a));var l=i.instancedBuffers?i.instancedBuffers[0]:h._partBuffer,c=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;n._addDrawCallCount(1,i.renderMode),s.updateAndBindInstancesBuffer(l,null,this.instancingAttributes),s.draw(!0,0,6,c),s.unbindInstanceAttributes()}else{n._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var u=i.partDataStartIndex;u<i.partDataEndIndex;u++)this.setupUniforms(a,0,h._partData,u),s.draw(!0,0,6)}return s.setAlphaMode(o,!0),!0},i.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(this.vb&&(this._engine._releaseBuffer(this.vb),this.vb=null),this.ib&&(this._engine._releaseBuffer(this.ib),this.ib=null),this.effect=null,this.effectInstanced=null,!0)},i}(t.ModelRenderCache);t.Sprite2DRenderCache=e;var i=function(e){function i(t){e.call(this,t,1)}return o(i,e),Object.defineProperty(i.prototype,"topLeftUV",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"sizeUV",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleFactor",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textureSize",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"properties",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),s([t.instanceData()],i.prototype,"topLeftUV",null),s([t.instanceData()],i.prototype,"sizeUV",null),s([t.instanceData()],i.prototype,"scaleFactor",null),s([t.instanceData()],i.prototype,"textureSize",null),s([t.instanceData()],i.prototype,"properties",null),i}(t.InstanceDataBase);t.Sprite2DInstanceData=i;var r=function(r){function n(e,i){var s=this;if(i||(i={}),r.call(this,i),this.texture=e,this.texture.wrapU=t.Texture.CLAMP_ADDRESSMODE,this.texture.wrapV=t.Texture.CLAMP_ADDRESSMODE,this.size=null!=i.spriteSize?i.spriteSize.clone():null,this.spriteLocation=null!=i.spriteLocation?i.spriteLocation.clone():new t.Vector2(0,0),this.spriteScaleFactor=null!=i.spriteScaleFactor?i.spriteScaleFactor:new t.Vector2(1,1),this.spriteFrame=0,this.invertY=null!=i.invertY&&i.invertY,this.alignToPixel=null==i.alignToPixel||i.alignToPixel,this.useAlphaFromTexture=!0,null==i.spriteSize&&(this.size=new t.Size(10,10)),null==i.spriteSize||!e.isReady())if(e.isReady()){var o=e.getBaseSize();this.size=new t.Size(o.width,o.height)}else e.onLoadObservable.add(function(){if(null==i.spriteSize){var r=e.getBaseSize();s.size=new t.Size(r.width,r.height)}s._positioningDirty(),s._setLayoutDirty(),s._instanceDirtyFlags|=t.Prim2DBase.originProperty.flagId|n.textureProperty.flagId})}return o(n,r),Object.defineProperty(n.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture=t,this._oldTextureHasAlpha=this._texture&&this.texture.hasAlpha},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"useAlphaFromTexture",{get:function(){return this._useAlphaFromTexture},set:function(t){this._useAlphaFromTexture!==t&&(this._useAlphaFromTexture=t,this._updateRenderMode())},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"actualSize",{get:function(){return this._actualSize?this._actualSize:this.size},set:function(t){this._actualSize=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"spriteLocation",{get:function(){return this._location},set:function(t){this._location=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(t){this._spriteFrame=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"invertY",{get:function(){return this._invertY},set:function(t){this._invertY=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"spriteScaleFactor",{get:function(){return this._spriteScaleFactor},set:function(t){this._spriteScaleFactor=t},enumerable:!0,configurable:!0}),n.prototype.scaleToSize=function(t){var e=this.size;if(null==e||!this.texture.isReady()){if(!this.texture.isReady()){var i=this;return void this.texture.onLoadObservable.add(function(){i.scaleToSize(t)})}e=this.texture.getBaseSize()}this.scale=Math.max(t.height/e.height,t.width/e.width)},Object.defineProperty(n.prototype,"alignToPixel",{get:function(){return this._alignToPixel},set:function(t){this._alignToPixel=t},enumerable:!0,configurable:!0}),n.prototype.updateLevelBoundingInfo=function(){t.BoundingInfo2D.CreateFromSizeToRef(this.size,this._levelBoundingInfo)},n.prototype.getAnimatables=function(){var t=new Array;return this.texture&&this.texture.animations&&this.texture.animations.length>0&&t.push(this.texture),t},n.prototype.levelIntersect=function(t){return!0},n.prototype.createModelRenderCache=function(t){return new e(this.owner.engine,t)},n.prototype.setupModelRenderCache=function(t){for(var e=t,i=this.owner.engine,r=new Float32Array(4),s=0;s<4;s++)r[s]=s;e.vb=i.createVertexBuffer(r);var o=new Float32Array(6);o[0]=0,o[1]=2,o[2]=1,o[3]=0,o[4]=3,o[5]=2,e.ib=i.createIndexBuffer(o),e.texture=this.texture;var a=this.getDataPartEffectInfo(n.SPRITE2D_MAINPARTID,["index"],["alphaTest"],!0);return a&&(e.effectInstanced=i.createEffect("sprite2d",a.attributes,a.uniforms,["diffuseSampler"],a.defines,null)),a=this.getDataPartEffectInfo(n.SPRITE2D_MAINPARTID,["index"],["alphaTest"],!1),e.effect=i.createEffect("sprite2d",a.attributes,a.uniforms,["diffuseSampler"],a.defines,null),e},n.prototype.createInstanceDataParts=function(){return[new i(n.SPRITE2D_MAINPARTID)]},n.prototype.beforeRefreshForLayoutConstruction=function(t){n.layoutConstructMode=!0},n.prototype.afterRefreshForLayoutConstruction=function(t,e){n.layoutConstructMode=!1},n.prototype.refreshInstanceDataPart=function(e){if(!r.prototype.refreshInstanceDataPart.call(this,e))return!1;if(!this.texture.isReady()&&!n.layoutConstructMode)return!1;if(e.id===n.SPRITE2D_MAINPARTID){var i=this._instanceDataParts[0];if(n.layoutConstructMode)i.topLeftUV=t.Vector2.Zero(),i.sizeUV=t.Vector2.Zero(),i.properties=t.Vector3.Zero(),i.textureSize=t.Vector2.Zero(),i.scaleFactor=t.Vector2.Zero();else{var s=this.texture.getBaseSize(),o=this.spriteLocation,a=this.actualSize,h=this.spriteScaleFactor;i.topLeftUV=new t.Vector2(o.x/s.width,o.y/s.height);var l=new t.Vector2(a.width/s.width,a.height/s.height);i.sizeUV=l,i.scaleFactor=h,n._prop.x=this.spriteFrame,n._prop.y=this.invertY?1:0,n._prop.z=this.alignToPixel?1:0,i.properties=n._prop,i.textureSize=new t.Vector2(s.width,s.height)}}return!0},n.prototype._mustUpdateInstance=function(){var t=this._oldTextureHasAlpha!==(null!=this.texture&&this.texture.hasAlpha);return this._oldTextureHasAlpha=null!=this.texture&&this.texture.hasAlpha,t&&this._updateRenderMode(),t},n.prototype._useTextureAlpha=function(){return null!=this.texture&&this.texture.hasAlpha},n.prototype._shouldUseAlphaFromTexture=function(){return null!=this.texture&&this.texture.hasAlpha&&this.useAlphaFromTexture},n.SPRITE2D_MAINPARTID=1,n._prop=t.Vector3.Zero(),n.layoutConstructMode=!1,s([t.modelLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+1,function(t){return n.textureProperty=t})],n.prototype,"texture",null),s([t.dynamicLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+2,function(t){return n.useAlphaFromTextureProperty=t})],n.prototype,"useAlphaFromTexture",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+3,function(t){return n.actualSizeProperty=t},!1,!0)],n.prototype,"actualSize",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+4,function(t){return n.spriteLocationProperty=t})],n.prototype,"spriteLocation",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+5,function(t){return n.spriteFrameProperty=t})],n.prototype,"spriteFrame",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+6,function(t){return n.invertYProperty=t})],n.prototype,"invertY",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+7,function(t){return n.spriteScaleFactorProperty=t})],n.prototype,"spriteScaleFactor",null),n=s([t.className("Sprite2D","BABYLON")],n)}(t.RenderablePrim2D);t.Sprite2D=r}(r||(r={}));var r;!function(t){var e=function(e){function i(){e.apply(this,arguments),this.effectsReady=!1,this.vb=null,this.ib=null,this.instancingAttributes=null,this.fontTexture=null,this.effect=null,this.effectInstanced=null}return o(i,e),i.prototype.render=function(e,i){if(!this.effectsReady){if(this.effect&&(!this.effect.isReady()||this.effectInstanced&&!this.effectInstanced.isReady()))return!1;this.effectsReady=!0}var n=e.owner.owner,s=n.engine;this.fontTexture.update();var o=i.useInstancing?this.effectInstanced:this.effect;s.enableEffect(o),o.setTexture("diffuseSampler",this.fontTexture),s.bindBuffersDirectly(this.vb,this.ib,[1],4,o);var a,h=this.fontTexture.isSignedDistanceField;h||(a=s.getAlphaMode(),s.setAlphaMode(t.Engine.ALPHA_COMBINE,!0));var l=i.groupInfoPartData[0];if(i.useInstancing){this.instancingAttributes||(this.instancingAttributes=this.loadInstancingAttributes(r.TEXT2D_MAINPARTID,o));var c=i.instancedBuffers?i.instancedBuffers[0]:l._partBuffer,u=i.instancedBuffers?i.instancesCount:l._partData.usedElementCount;n._addDrawCallCount(1,i.renderMode),s.updateAndBindInstancesBuffer(c,null,this.instancingAttributes),s.draw(!0,0,6,u),s.unbindInstanceAttributes()}else{n._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(o,0,l._partData,p),s.draw(!0,0,6)}return h||s.setAlphaMode(a,!0),!0},i.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(this.vb&&(this._engine._releaseBuffer(this.vb),this.vb=null),this.ib&&(this._engine._releaseBuffer(this.ib),this.ib=null),this.fontTexture&&(this.fontTexture.decCachedFontTextureCounter(),this.fontTexture=null),this.effect=null,this.effectInstanced=null,!0)},i}(t.ModelRenderCache);t.Text2DRenderCache=e;var i=function(e){function i(t,i){e.call(this,t,i)}return o(i,e),Object.defineProperty(i.prototype,"topLeftUV",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"sizeUV",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textureSize",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"color",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"superSampleFactor",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),s([t.instanceData()],i.prototype,"topLeftUV",null),s([t.instanceData()],i.prototype,"sizeUV",null),s([t.instanceData()],i.prototype,"textureSize",null),s([t.instanceData()],i.prototype,"color",null),s([t.instanceData()],i.prototype,"superSampleFactor",null),i}(t.InstanceDataBase);t.Text2DInstanceData=i;var r=function(r){function n(e,i){i||(i={}),r.call(this,i),this.fontName=null==i.fontName?"12pt Arial":i.fontName,this._fontSuperSample=null!=i.fontSuperSample&&i.fontSuperSample,this._fontSDF=null!=i.fontSignedDistanceField&&i.fontSignedDistanceField,this.defaultFontColor=null==i.defaultFontColor?new t.Color4(1,1,1,1):i.defaultFontColor,this._tabulationSize=null==i.tabulationSize?4:i.tabulationSize,this._textSize=null,this.text=e,this.size=null==i.size?null:i.size,this._updateRenderMode()}return o(n,r),Object.defineProperty(n.prototype,"fontName",{get:function(){return this._fontName},set:function(t){if(this._fontName)throw new Error("Font Name change is not supported right now.");this._fontName=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"defaultFontColor",{get:function(){return this._defaultFontColor},set:function(t){this._defaultFontColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"text",{get:function(){return this._text},set:function(t){t||(t=""),this._text=t,this._textSize=null,this._size=null,this._updateCharCount();this.textSize},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"size",{get:function(){return null!=this._size?this._size:this.textSize},set:function(t){this._size=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fontSuperSample",{get:function(){return this._fontTexture&&this._fontTexture.isSuperSampled},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fontSignedDistanceField",{get:function(){return this._fontTexture&&this._fontTexture.isSignedDistanceField},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isSizeAuto",{get:function(){return!1},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"actualSize",{get:function(){return this._actualSize?this._actualSize:this.size},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"textSize",{get:function(){if(!this._textSize){if(!this.owner||!this._text)return n.nullSize;var e=this.fontTexture.measureText(this._text,this._tabulationSize);e.equals(this._textSize)||(this.onPrimitivePropertyDirty(t.Prim2DBase.sizeProperty.flagId),this._positioningDirty()),this._textSize=e}return this._textSize},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fontTexture",{get:function(){return this._fontTexture?this._fontTexture:null==this.fontName||null==this.owner||null==this.owner.scene?null:(this._fontTexture=t.FontTexture.GetCachedFontTexture(this.owner.scene,this.fontName,this._fontSuperSample,this._fontSDF),this._fontTexture)},enumerable:!0,configurable:!0}),n.prototype.dispose=function(){return!!r.prototype.dispose.call(this)&&(this._fontTexture&&(t.FontTexture.ReleaseCachedFontTexture(this.owner.scene,this.fontName,this._fontSuperSample,this._fontSDF),this._fontTexture=null),!0)},n.prototype.updateLevelBoundingInfo=function(){t.BoundingInfo2D.CreateFromSizeToRef(this.actualSize,this._levelBoundingInfo)},n.prototype.levelIntersect=function(t){return!0},n.prototype.createModelRenderCache=function(t){return new e(this.owner.engine,t)},n.prototype.setupModelRenderCache=function(t){var e=t,i=this.owner.engine;e.fontTexture=this.fontTexture,e.fontTexture.incCachedFontTextureCounter();for(var r=new Float32Array(4),s=0;s<4;s++)r[s]=s;e.vb=i.createVertexBuffer(r);var o=new Float32Array(6);o[0]=0,o[1]=2,o[2]=1,o[3]=0,o[4]=3,o[5]=2,e.ib=i.createIndexBuffer(o);var a=this.getDataPartEffectInfo(n.TEXT2D_MAINPARTID,["index"],null,!0);return a&&(e.effectInstanced=i.createEffect("text2d",a.attributes,a.uniforms,["diffuseSampler"],a.defines,null)),a=this.getDataPartEffectInfo(n.TEXT2D_MAINPARTID,["index"],null,!1),e.effect=i.createEffect("text2d",a.attributes,a.uniforms,["diffuseSampler"],a.defines,null),e},n.prototype.createInstanceDataParts=function(){return[new i(n.TEXT2D_MAINPARTID,this._charCount)]},n.prototype.beforeRefreshForLayoutConstruction=function(t){if(!this._charCount){var e=this._text;return this.text="A",e}},n.prototype.afterRefreshForLayoutConstruction=function(t,e){void 0!==e&&(this.text=e)},n.prototype.getUsedShaderCategories=function(t){var e=r.prototype.getUsedShaderCategories.call(this,t);return this._fontSDF&&e.push(n.TEXT2D_CATEGORY_SDF),e},n.prototype.refreshInstanceDataPart=function(e){if(!r.prototype.refreshInstanceDataPart.call(this,e))return!1;if(e.id===n.TEXT2D_MAINPARTID){var i=e,s=this.fontTexture,o=s.isSuperSampled?.5:1,a=s.getSize(),h=t.Vector2.Zero(),l=this.fontTexture.lineHeight;h.y=(this.textSize.height/l-1)*l;var c=0;i.dataElementCount=this._charCount,i.curElement=0;for(var u=0,p=this.text;u<p.length;u++){var d=p[u];if("\n"===d&&(h.x=0,h.y-=s.lineHeight),"\t"!==d){if(!(d<" ")){this.updateInstanceDataPart(i,h);var f=s.getChar(d);h.x+=f.charWidth,i.topLeftUV=f.topLeftUV;var m=f.bottomRightUV.subtract(f.topLeftUV);i.sizeUV=m,i.textureSize=new t.Vector2(a.width,a.height),i.color=this.defaultFontColor,i.superSampleFactor=o,++i.curElement}}else{var _=c+this._tabulationSize;_-=_%this._tabulationSize,h.x+=(_-c)*s.spaceWidth,c=_}}}return!0},n.prototype._updateCharCount=function(){for(var t=0,e=0,i=this._text;e<i.length;e++){var r=i[e];"\r"===r||"\n"===r||"\t"===r||r<" "||++t}this._charCount=t},n.prototype._useTextureAlpha=function(){return this._fontSDF},n.prototype._shouldUseAlphaFromTexture=function(){return!this._fontSDF},n.TEXT2D_MAINPARTID=1,n.TEXT2D_CATEGORY_SDF="SignedDistanceField",s([t.modelLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+1,function(t){return n.fontProperty=t},!1,!0)],n.prototype,"fontName",null),s([t.dynamicLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+2,function(t){return n.defaultFontColorProperty=t})],n.prototype,"defaultFontColor",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+3,function(t){return n.textProperty=t},!1,!0)],n.prototype,"text",null),s([t.instanceLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+4,function(t){return n.sizeProperty=t})],n.prototype,"size",null),s([t.modelLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+5,function(t){return n.fontSuperSampleProperty=t},!1,!1)],n.prototype,"fontSuperSample",null),s([t.modelLevelProperty(t.RenderablePrim2D.RENDERABLEPRIM2D_PROPCOUNT+6,function(t){return n.fontSuperSampleProperty=t},!1,!1)],n.prototype,"fontSignedDistanceField",null),n=s([t.className("Text2D","BABYLON")],n)}(t.RenderablePrim2D);t.Text2D=r}(r||(r={}));var r;!function(t){var e=function(e){function i(t,i){e.call(this,t,i),this.effectsReady=!1,this.fillVB=null,this.fillIB=null,this.fillIndicesCount=0,this.instancingFillAttributes=null,this.effectFill=null,this.effectFillInstanced=null,this.borderVB=null,this.borderIB=null,this.borderIndicesCount=0,this.instancingBorderAttributes=null,this.effectBorder=null,this.effectBorderInstanced=null}return o(i,e),i.prototype.render=function(e,i){if(!this.effectsReady){if(this.effectFill&&(!this.effectFill.isReady()||this.effectFillInstanced&&!this.effectFillInstanced.isReady())||this.effectBorder&&(!this.effectBorder.isReady()||this.effectBorderInstanced&&!this.effectBorderInstanced.isReady()))return!1;this.effectsReady=!0}var r=e.owner.owner,n=r.engine,s=0;this.effectFill&&this.effectBorder&&(s=n.getDepthFunction(),n.setDepthFunctionToLessOrEqual());var o=n.getAlphaMode();if(this.effectFill){var a=e.partIndexFromId.get(t.Shape2D.SHAPE2D_FILLPARTID.toString()),h=i.groupInfoPartData[a];i.renderMode!==t.Render2DContext.RenderModeOpaque&&n.setAlphaMode(t.Engine.ALPHA_COMBINE,!0);var l=i.useInstancing?this.effectFillInstanced:this.effectFill;if(n.enableEffect(l),n.bindBuffersDirectly(this.fillVB,this.fillIB,[2],8,l),i.useInstancing){this.instancingFillAttributes||(this.instancingFillAttributes=this.loadInstancingAttributes(t.Shape2D.SHAPE2D_FILLPARTID,l));var c=i.instancedBuffers?i.instancedBuffers[a]:h._partBuffer,u=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;r._addDrawCallCount(1,i.renderMode),n.updateAndBindInstancesBuffer(c,null,this.instancingFillAttributes),n.draw(!0,0,this.fillIndicesCount,u),n.unbindInstanceAttributes()}else{r._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(l,a,h._partData,p),n.draw(!0,0,this.fillIndicesCount)}}if(this.effectBorder){var a=e.partIndexFromId.get(t.Shape2D.SHAPE2D_BORDERPARTID.toString()),h=i.groupInfoPartData[a];i.renderMode!==t.Render2DContext.RenderModeOpaque&&n.setAlphaMode(t.Engine.ALPHA_COMBINE,!0);var l=i.useInstancing?this.effectBorderInstanced:this.effectBorder;if(n.enableEffect(l),n.bindBuffersDirectly(this.borderVB,this.borderIB,[2],8,l),i.useInstancing){this.instancingBorderAttributes||(this.instancingBorderAttributes=this.loadInstancingAttributes(t.Shape2D.SHAPE2D_BORDERPARTID,l));var c=i.instancedBuffers?i.instancedBuffers[a]:h._partBuffer,u=i.instancedBuffers?i.instancesCount:h._partData.usedElementCount;r._addDrawCallCount(1,i.renderMode),n.updateAndBindInstancesBuffer(c,null,this.instancingBorderAttributes),n.draw(!0,0,this.borderIndicesCount,u),n.unbindInstanceAttributes()}else{r._addDrawCallCount(i.partDataEndIndex-i.partDataStartIndex,i.renderMode);for(var p=i.partDataStartIndex;p<i.partDataEndIndex;p++)this.setupUniforms(l,a,h._partData,p),n.draw(!0,0,this.borderIndicesCount)}}return n.setAlphaMode(o,!0),this.effectFill&&this.effectBorder&&n.setDepthFunction(s),!0},i.prototype.dispose=function(){return!!e.prototype.dispose.call(this)&&(this.fillVB&&(this._engine._releaseBuffer(this.fillVB),this.fillVB=null),this.fillIB&&(this._engine._releaseBuffer(this.fillIB),this.fillIB=null),this.effectFill=null,this.effectFillInstanced=null,this.effectBorder=null,this.effectBorderInstanced=null,this.borderVB&&(this._engine._releaseBuffer(this.borderVB),this.borderVB=null),this.borderIB&&(this._engine._releaseBuffer(this.borderIB),this.borderIB=null),!0)},i}(t.ModelRenderCache);t.Lines2DRenderCache=e;var i=function(e){function i(t){e.call(this,t,1)}return o(i,e),Object.defineProperty(i.prototype,"boundingMin",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"boundingMax",{get:function(){return null},set:function(t){},enumerable:!0,configurable:!0}),s([t.instanceData(t.Shape2D.SHAPE2D_CATEGORY_FILLGRADIENT)],i.prototype,"boundingMin",null),s([t.instanceData(t.Shape2D.SHAPE2D_CATEGORY_FILLGRADIENT)],i.prototype,"boundingMax",null),i}(t.Shape2DInstanceData);t.Lines2DInstanceData=i;var r=function(r){function n(e,i){i||(i={}),r.call(this,i),this._fillVB=null,this._fillIB=null,this._borderVB=null,this._borderIB=null,this._size=t.Size.Zero(),this._boundingMin=null,this._boundingMax=null;var n=null==i.fillThickness?1:i.fillThickness,s=null==i.startCap?0:i.startCap,o=null==i.endCap?0:i.endCap,a=null!=i.closed&&i.closed;this.points=e,this.fillThickness=n,this.startCap=s,this.endCap=o,this.closed=a}return o(n,r),Object.defineProperty(n,"NoCap",{get:function(){return n._noCap},enumerable:!0,configurable:!0}),Object.defineProperty(n,"RoundCap",{get:function(){return n._roundCap},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TriangleCap",{get:function(){return n._triangleCap},enumerable:!0,configurable:!0}),Object.defineProperty(n,"SquareAnchorCap",{get:function(){return n._squareAnchorCap},enumerable:!0,configurable:!0}),Object.defineProperty(n,"RoundAnchorCap",{get:function(){return n._roundAnchorCap},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DiamondAnchorCap",{get:function(){return n._diamondAnchorCap},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ArrowCap",{get:function(){return n._arrowCap},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"points",{get:function(){return this._points},set:function(t){this._points=t,this._contour=null,this._boundingBoxDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"fillThickness",{get:function(){return this._fillThickness},set:function(t){this._fillThickness=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"closed",{get:function(){return this._closed},set:function(t){this._closed=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"startCap",{get:function(){return this._startCap},set:function(t){this._startCap=t},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"endCap",{get:function(){return this._endCap},set:function(t){this._endCap=t},enumerable:!0,configurable:!0}),n.prototype.levelIntersect=function(e){var i=this;null==this._contour&&this._computeLines2D();var r=this.points.length,s=this.closed?r+1:r,o=e._localPickPosition;this.transformPointWithOriginToRef(this._contour[0],null,n._prevA),this.transformPointWithOriginToRef(this._contour[1],null,n._prevB);for(var a=1;a<s;a++){if(this.transformPointWithOriginToRef(this._contour[a%r*2+0],null,n._curA),this.transformPointWithOriginToRef(this._contour[a%r*2+1],null,n._curB),t.Vector2.PointInTriangle(o,n._prevA,n._prevB,n._curA))return!0;if(t.Vector2.PointInTriangle(o,n._curA,n._prevB,n._curB))return!0;n._prevA.x=n._curA.x,n._prevA.y=n._curA.y,n._prevB.x=n._curB.x,n._prevB.y=n._curB.y}var h=function(e,r){for(var s=e.length,a=0;a<s;a+=3)if(n._curA.x=r[2*e[a+0]+0],n._curA.y=r[2*e[a+0]+1],i.transformPointWithOriginToRef(n._curA,null,n._curB),n._curA.x=r[2*e[a+1]+0],n._curA.y=r[2*e[a+1]+1],i.transformPointWithOriginToRef(n._curA,null,n._prevA),n._curA.x=r[2*e[a+2]+0],n._curA.y=r[2*e[a+2]+1],i.transformPointWithOriginToRef(n._curA,null,n._prevB),t.Vector2.PointInTriangle(o,n._prevA,n._prevB,n._curB))return!0;return!1};if(this._startCapTriIndices){if(this._startCapTriIndices&&h(this._startCapTriIndices,this._startCapContour))return!0;if(this._endCapTriIndices&&h(this._endCapTriIndices,this._endCapContour))return!0}return!1},Object.defineProperty(n.prototype,"boundingMin",{get:function(){return this._boundingMin||this._computeLines2D(),this._boundingMin},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"boundingMax",{get:function(){return this._boundingMax||this._computeLines2D(),this._boundingMax},enumerable:!0,configurable:!0}),n.prototype.getUsedShaderCategories=function(e){var i=r.prototype.getUsedShaderCategories.call(this,e),n=i.indexOf(t.Shape2D.SHAPE2D_CATEGORY_BORDER);return n!==-1&&i.splice(n,1),i},n.prototype.updateLevelBoundingInfo=function(){this._boundingMin||this._computeLines2D(),t.BoundingInfo2D.CreateFromMinMaxToRef(this._boundingMin.x,this._boundingMax.x,this._boundingMin.y,this._boundingMax.y,this._levelBoundingInfo)},n.prototype.createModelRenderCache=function(t){return new e(this.owner.engine,t)},n.prototype._perp=function(t,e){e.x=t.y,e.y=-t.x},n.prototype._direction=function(t,e,i){t.subtractToRef(e,i),i.normalize()},n.prototype._computeMiter=function(e,i,r,s){return r.addToRef(s,e),e.normalize(),i.x=-e.y,i.y=e.x,n._miterTps.x=-r.y,n._miterTps.y=r.x,1/t.Vector2.Dot(i,n._miterTps)},n.prototype._intersect=function(t,e,i,r,n,s,o,a){var h=(t-i)*(s-a)-(e-r)*(n-o);if(0===h)return!1;var l=((n-o)*(t*r-e*i)-(t-i)*(n*a-s*o))/h;return!(l<Math.min(t,i)||l>Math.max(t,i))&&!(l<Math.min(n,o)||l>Math.max(n,o))},n.prototype._updateMinMax=function(t,e){e>=t.length||(this._boundingMin.x=Math.min(this._boundingMin.x,t[e]),this._boundingMax.x=Math.max(this._boundingMax.x,t[e]),this._boundingMin.y=Math.min(this._boundingMin.y,t[e+1]),this._boundingMax.y=Math.max(this._boundingMax.y,t[e+1]))},n.prototype._store=function(e,i,r,s,o,a,h,l,c){var u=null!=l&&!isNaN(l),p=r*(u?8:4);if(!(p>=e.length)){0===r?this._perp(a,n._startDir):r===s-1&&(this._perp(a,n._endDir),n._endDir.x*=-1,n._endDir.y*=-1);var d=!1;if(e[p+0]=o.x+a.x*h,e[p+1]=o.y+a.y*h,e[p+2]=o.x+a.x*-h,e[p+3]=o.y+a.y*-h,this._updateMinMax(e,p),this._updateMinMax(e,p+2),0!=c){var f=c*(u?8:4);if(this._intersect(e[p+0],e[p+1],e[f+0],e[f+1],e[p+2],e[p+3],e[f+2],e[f+3])){d=!0;var m=e[p+0];e[p+0]=e[p+2],e[p+2]=m,m=e[p+1],e[p+1]=e[p+3],e[p+3]=m}}if(u){var _=h+l;e[p+4]=o.x+a.x*(d?-_:_),e[p+5]=o.y+a.y*(d?-_:_),e[p+6]=o.x+a.x*(d?_:-_),e[p+7]=o.y+a.y*(d?_:-_),this._updateMinMax(e,p+4),this._updateMinMax(e,p+6)}i&&(p+=u?4:0,i.push(new t.Vector2(e[p+0],e[p+1])),i.push(new t.Vector2(e[p+2],e[p+3])))}},n.prototype._getCapSize=function(t,e){void 0===e&&(e=!1);var i=n._roundCapSubDiv,r=0,s=0;switch(t){case n.NoCap:!this.closed&&e?(r=4,s=6):r=s=0;break;case n.RoundCap:e?(r=i,s=3*(i-2)):(r=i/2+1,s=i/2*3);break;case n.ArrowCap:e?(r=12,s=24):(r=3,s=3);break;case n.TriangleCap:e?(r=6,s=12):(r=3,s=3);break;case n.DiamondAnchorCap:e?(r=10,s=24):(r=5,s=9);break;case n.SquareAnchorCap:e?(r=12,s=30):(r=4,s=6);break;case n.RoundAnchorCap:e?(r=2*i,s=6*(i-1)):(r=i+1,s=3*(i+1))}return{vbsize:2*r,ibsize:s}},n.prototype._storeVertex=function(t,e,i,r,s,o,a){var h=Math.cos(s),l=Math.sin(s);n._tpsV.x=h*o.x+-l*o.y+r.x,n._tpsV.y=l*o.x+h*o.y+r.y;var c=e+2*i;return t[c+0]=n._tpsV.x,t[c+1]=n._tpsV.y,a&&(a.push(n._tpsV.x),a.push(n._tpsV.y)),this._updateMinMax(t,c),(e+2*i)/2},n.prototype._storeIndex=function(t,e,i,r){t[e+i]=r},n.prototype._buildCap=function(e,i,r,s,o,a,h,l,c,u){var p=n._roundCapSubDiv,d=new t.Vector2(1,0),f=Math.atan2(c.y,c.x)-Math.atan2(d.y,d.x),m=a/2,_=a,g=null!=h,y=h;switch(l){case n.NoCap:if(g&&!this.closed){var v=0,x=0,b=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,m+y),u),P=this._storeVertex(e,i,v++,o,f,new t.Vector2(y,m+y),u),T=this._storeVertex(e,i,v++,o,f,new t.Vector2(y,-(m+y)),u),S=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,-(m+y)),u);this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,S)}break;case n.ArrowCap:m*=2;case n.TriangleCap:if(g){var A=l===n.TriangleCap?y:Math.sqrt(y*y*2),b=this._storeVertex(e,i,0,o,f,new t.Vector2(0,m),null),P=this._storeVertex(e,i,1,o,f,new t.Vector2(m,0),null),T=this._storeVertex(e,i,2,o,f,new t.Vector2(0,-m),null),S=this._storeVertex(e,i,3,o,f,new t.Vector2(0,m+A),u),C=this._storeVertex(e,i,4,o,f,new t.Vector2(m+A,0),u),E=this._storeVertex(e,i,5,o,f,new t.Vector2(0,-(m+A)),u),x=0;if(this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,C),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,C),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,E),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,E),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,C),l===n.ArrowCap){var M=a/2,D=this._storeVertex(e,i,9,o,f,new t.Vector2(0,-(M+y)),null),R=this._storeVertex(e,i,11,o,f,new t.Vector2(-y,-(m+A)),u),I=this._storeVertex(e,i,10,o,f,new t.Vector2(-y,-(M+y)),u),O=this._storeVertex(e,i,6,o,f,new t.Vector2(0,M+y),null),w=this._storeVertex(e,i,7,o,f,new t.Vector2(-y,M+y),u),L=this._storeVertex(e,i,8,o,f,new t.Vector2(-y,m+A),u);this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,R),this._storeIndex(r,s,x++,I),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,E),this._storeIndex(r,s,x++,R)}}else{var b=this._storeVertex(e,i,0,o,f,new t.Vector2(0,m),u),P=this._storeVertex(e,i,1,o,f,new t.Vector2(m,0),u),T=this._storeVertex(e,i,2,o,f,new t.Vector2(0,-m),u);this._storeIndex(r,s,0,b),this._storeIndex(r,s,1,P),this._storeIndex(r,s,2,T)}break;case n.RoundCap:if(g)for(var F=-Math.PI/2,V=Math.PI/(p/2-1),x=0,N=0;N<p/2;N++){var b=this._storeVertex(e,i,2*N+0,o,f,new t.Vector2(Math.cos(F)*m,Math.sin(F)*m),null),P=this._storeVertex(e,i,2*N+1,o,f,new t.Vector2(Math.cos(F)*(m+y),Math.sin(F)*(m+y)),u);N>0&&(this._storeIndex(r,s,x++,b-2),this._storeIndex(r,s,x++,P-2),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,b-2),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,b)),F+=V}else{var z=this._storeVertex(e,i,0,o,f,new t.Vector2(0,0),null),F=-Math.PI/2,V=Math.PI/(p/2-1);this._storeVertex(e,i,1,o,f,new t.Vector2(Math.cos(F)*m,Math.sin(F)*m),null),F+=V;for(var N=1;N<p/2;N++){var P=this._storeVertex(e,i,N+1,o,f,new t.Vector2(Math.cos(F)*m,Math.sin(F)*m),u);this._storeIndex(r,s,3*N+0,z),this._storeIndex(r,s,3*N+1,P-1),this._storeIndex(r,s,3*N+2,P),F+=V}}break;case n.SquareAnchorCap:var v=0,z=g?null:u,b=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,_),z),P=this._storeVertex(e,i,v++,o,f,new t.Vector2(2*_,_),z),T=this._storeVertex(e,i,v++,o,f,new t.Vector2(2*_,-_),z),S=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,-_),z);if(g){var C=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,m+y),null),E=this._storeVertex(e,i,v++,o,f,new t.Vector2(-y,m+y),u),O=this._storeVertex(e,i,v++,o,f,new t.Vector2(-y,_+y),u),w=this._storeVertex(e,i,v++,o,f,new t.Vector2(2*_+y,_+y),u),L=this._storeVertex(e,i,v++,o,f,new t.Vector2(2*_+y,-(_+y)),u),D=this._storeVertex(e,i,v++,o,f,new t.Vector2(-y,-(_+y)),u),I=this._storeVertex(e,i,v++,o,f,new t.Vector2(-y,-(m+y)),u),R=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,-(m+y)),null),x=0;this._storeIndex(r,s,x++,E),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,C),this._storeIndex(r,s,x++,E),this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,I),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,I),this._storeIndex(r,s,x++,R),this._storeIndex(r,s,x++,S)}else this._storeIndex(r,s,0,b),this._storeIndex(r,s,1,P),this._storeIndex(r,s,2,T),this._storeIndex(r,s,3,b),this._storeIndex(r,s,4,T),this._storeIndex(r,s,5,S);break;case n.RoundAnchorCap:var B=Math.sqrt(_*_-m*m),k=new t.Vector2(B,0),F=t.Tools.ToRadians(-150),V=t.Tools.ToRadians(300)/(p-1);if(g)for(var x=0,N=0;N<p;N++){var b=this._storeVertex(e,i,2*N+0,o,f,new t.Vector2(B+Math.cos(F)*_,Math.sin(F)*_),null),P=this._storeVertex(e,i,2*N+1,o,f,new t.Vector2(B+Math.cos(F)*(_+y),Math.sin(F)*(_+y)),u);N>0&&(this._storeIndex(r,s,x++,b-2),this._storeIndex(r,s,x++,P-2),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,b-2),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,b)),F+=V}else{var z=this._storeVertex(e,i,0,o,f,k,null);this._storeVertex(e,i,1,o,f,new t.Vector2(B+Math.cos(F)*_,Math.sin(F)*_),null),F+=V;for(var N=1;N<p;N++){var P=this._storeVertex(e,i,N+1,o,f,new t.Vector2(B+Math.cos(F)*_,Math.sin(F)*_),u);this._storeIndex(r,s,3*N+0,z),this._storeIndex(r,s,3*N+1,P-1),this._storeIndex(r,s,3*N+2,P),F+=V}this._storeIndex(r,s,3*p+0,z),this._storeIndex(r,s,3*p+1,z+1),this._storeIndex(r,s,3*p+2,z+p)}break;case n.DiamondAnchorCap:var v=0,z=g?null:u,b=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,m),z),P=this._storeVertex(e,i,v++,o,f,new t.Vector2(m,_),z),T=this._storeVertex(e,i,v++,o,f,new t.Vector2(3*m,0),z),S=this._storeVertex(e,i,v++,o,f,new t.Vector2(m,-_),z),C=this._storeVertex(e,i,v++,o,f,new t.Vector2(0,-m),z);if(g){var A=Math.sqrt(y*y*2),E=this._storeVertex(e,i,v++,o,f,new t.Vector2(-A,m),u),O=this._storeVertex(e,i,v++,o,f,new t.Vector2(m,_+A),u),w=this._storeVertex(e,i,v++,o,f,new t.Vector2(3*m+A,0),u),L=this._storeVertex(e,i,v++,o,f,new t.Vector2(m,-(_+A)),u),D=this._storeVertex(e,i,v++,o,f,new t.Vector2(-A,-m),u),x=0;this._storeIndex(r,s,x++,E),this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,b),this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,O),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,P),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,w),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,T),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,L),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,S),this._storeIndex(r,s,x++,D),this._storeIndex(r,s,x++,C)}else this._storeIndex(r,s,0,b),this._storeIndex(r,s,1,P),this._storeIndex(r,s,2,T),this._storeIndex(r,s,3,b),this._storeIndex(r,s,4,T),this._storeIndex(r,s,5,C),this._storeIndex(r,s,6,C),this._storeIndex(r,s,7,T),this._storeIndex(r,s,8,S)}return null},n.prototype._buildLine=function(e,i,r,n){var s=t.Vector2.Zero(),o=t.Vector2.Zero(),a=t.Vector2.Zero(),h=t.Vector2.Zero(),l=null;this.closed&&this.points.push(this.points[0]);for(var c=this.points.length,u=1;u<c;u++){var p=this.points[u-1],d=this.points[u],f=u<this.points.length-1?this.points[u+1]:null;if(this._direction(d,p,s),l||(l=t.Vector2.Zero(),this._perp(s,l)),1===u&&this._store(e,i,0,c,this.points[0],l,r,n),f){this._direction(f,d,o);var m=this._computeMiter(a,h,s,o);this._store(e,i,u,c,this.points[u],h,m*r,m*n,u-1)}else this._perp(s,l),this._store(e,i,u,c,this.points[u],l,r,n,u-1)}if(this.points.length>2&&this.closed){var _=this.points[c-2],g=this.points[0],y=this.points[1];this._direction(g,_,s),this._direction(y,g,o),this._perp(s,l);var v=this._computeMiter(a,h,s,o);if(this._store(e,null,0,c,this.points[0],h,v*r,v*n,1),i){var x=null==n?0:4;i[0].x=e[x+0],i[0].y=e[x+1],i[1].x=e[x+2],i[1].y=e[x+3]}}this.closed&&this.points.splice(c-1)},n.prototype.setupModelRenderCache=function(e){var i=e,r=this.owner.engine;if(null===this._fillVB&&this._computeLines2D(),this.fill){i.fillVB=r.createVertexBuffer(this._fillVB),i.fillIB=r.createIndexBuffer(this._fillIB),i.fillIndicesCount=this._fillIB.length;var n=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_FILLPARTID,["position"],null,!0);n&&(i.effectFillInstanced=r.createEffect("lines2d",n.attributes,n.uniforms,[],n.defines,null)),n=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_FILLPARTID,["position"],null,!1),i.effectFill=r.createEffect("lines2d",n.attributes,n.uniforms,[],n.defines,null)}if(this.border){i.borderVB=r.createVertexBuffer(this._borderVB),i.borderIB=r.createIndexBuffer(this._borderIB),i.borderIndicesCount=this._borderIB.length;var n=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_BORDERPARTID,["position"],null,!0);n&&(i.effectBorderInstanced=r.createEffect({vertex:"lines2d",fragment:"lines2d"},n.attributes,n.uniforms,[],n.defines,null)),n=this.getDataPartEffectInfo(t.Shape2D.SHAPE2D_BORDERPARTID,["position"],null,!1),i.effectBorder=r.createEffect({vertex:"lines2d",fragment:"lines2d"},n.attributes,n.uniforms,[],n.defines,null)}return this._fillVB=null,this._fillIB=null,this._borderVB=null,this._borderIB=null,i},n.prototype._computeLines2D=function(){this._boundingMin=new t.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),this._boundingMax=new t.Vector2(Number.MIN_VALUE,Number.MIN_VALUE);var e=new Array,i=new Array,r=new Array;if(this.fill){var s=this._getCapSize(this.startCap),o=this._getCapSize(this.endCap),h=this.points.length,l=2*h*2+s.vbsize+o.vbsize;this._fillVB=new Float32Array(l);var c=this._fillVB,u=this.fillThickness/2,p=this.points.length;this._buildLine(c,this.border?null:e,u);var d=2*p,f=2*(h-(this.closed?0:1));this._fillIB=new Float32Array(3*f+s.ibsize+o.ibsize);for(var m=this._fillIB,_=0;_<f;_+=2)m[3*_+0]=_+0,m[3*_+1]=_+1,m[3*_+2]=(_+2)%d,m[3*_+3]=_+1,m[3*_+4]=(_+3)%d,m[3*_+5]=(_+2)%d;this._buildCap(c,2*h*2,m,3*f,this.points[0],this.fillThickness,null,this.startCap,n._startDir,this.border?null:i),this._buildCap(c,2*h*2+s.vbsize,m,3*f+s.ibsize,this.points[p-1],this.fillThickness,null,this.endCap,n._endDir,this.border?null:i)}if(this.border){var s=this._getCapSize(this.startCap,!0),o=this._getCapSize(this.endCap,!0),h=this.points.length,l=2*h*2*2+s.vbsize+o.vbsize;this._borderVB=new Float32Array(l);var c=this._borderVB,u=this.fillThickness/2,g=this.borderThickness,p=this.points.length;this._buildLine(c,e,u,g);var d=2*p*2,f=2*(h-(this.closed?0:1))*2;this._borderIB=new Float32Array(3*f+s.ibsize+o.ibsize);for(var m=this._borderIB,_=0;_<f;_+=4)m[3*_+0]=_+0,m[3*_+1]=_+2,m[3*_+2]=(_+6)%d,m[3*_+3]=_+0,m[3*_+4]=(_+6)%d,m[3*_+5]=(_+4)%d,m[3*_+6]=_+3,m[3*_+7]=_+1,m[3*_+8]=(_+5)%d,m[3*_+9]=_+3,m[3*_+10]=(_+5)%d,m[3*_+11]=(_+7)%d;this._buildCap(c,2*h*2*2,m,3*f,this.points[0],this.fillThickness,this.borderThickness,this.startCap,n._startDir,i),this._buildCap(c,2*h*2*2+s.vbsize,m,3*f+s.ibsize,this.points[p-1],this.fillThickness,this.borderThickness,this.endCap,n._endDir,r)}if(this._contour=e,i.length>0){var y=a.earcut(i,null,2);this._startCapTriIndices=y,this._startCapContour=i}else this._startCapTriIndices=null,this._startCapContour=null;if(r.length>0){var v=a.earcut(r,null,2);this._endCapContour=r,this._endCapTriIndices=v}else this._endCapContour=null,this._endCapTriIndices=null;var x=this._boundingMax.subtract(this._boundingMin);this._size.width=x.x,this._size.height=x.y},Object.defineProperty(n.prototype,"size",{get:function(){return null==this._size&&this._computeLines2D(),this._size},enumerable:!0,configurable:!0}),n.prototype.createInstanceDataParts=function(){var e=new Array;return this.border&&e.push(new i(t.Shape2D.SHAPE2D_BORDERPARTID)),this.fill&&e.push(new i(t.Shape2D.SHAPE2D_FILLPARTID)),e},n.prototype.applyActualScaleOnTransform=function(){return!0},n.prototype.refreshInstanceDataPart=function(e){if(!r.prototype.refreshInstanceDataPart.call(this,e))return!1;if(e.id===t.Shape2D.SHAPE2D_BORDERPARTID){var i=e;this.border instanceof t.GradientColorBrush2D&&(i.boundingMin=this.boundingMin,i.boundingMax=this.boundingMax)}else if(e.id===t.Shape2D.SHAPE2D_FILLPARTID){var i=e;this.fill instanceof t.GradientColorBrush2D&&(i.boundingMin=this.boundingMin,i.boundingMax=this.boundingMax)}return!0},n._prevA=t.Vector2.Zero(),n._prevB=t.Vector2.Zero(),n._curA=t.Vector2.Zero(),n._curB=t.Vector2.Zero(),n._miterTps=t.Vector2.Zero(),n._startDir=t.Vector2.Zero(),n._endDir=t.Vector2.Zero(),n._tpsV=t.Vector2.Zero(),n._noCap=0,n._roundCap=1,n._triangleCap=2,n._squareAnchorCap=3,n._roundAnchorCap=4,n._diamondAnchorCap=5,n._arrowCap=6,n._roundCapSubDiv=36,s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+1,function(t){return n.pointsProperty=t})],n.prototype,"points",null),s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+2,function(t){return n.fillThicknessProperty=t})],n.prototype,"fillThickness",null),s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+3,function(t){return n.closedProperty=t})],n.prototype,"closed",null),s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+4,function(t){return n.startCapProperty=t})],n.prototype,"startCap",null),s([t.modelLevelProperty(t.Shape2D.SHAPE2D_PROPCOUNT+5,function(t){return n.endCapProperty=t})],n.prototype,"endCap",null),n=s([t.className("Lines2D","BABYLON")],n)}(t.Shape2D);t.Lines2D=r}(r||(r={}));var r;!function(t){var e=function(){function e(){this._modelCache=new t.StringDictionary}return e.prototype.GetOrAddModelCache=function(t,e){return this._modelCache.getOrAddWithFactory(t,e)},e.prototype.DisposeModelRenderCache=function(t){return!!t.isDisposed&&(this._modelCache.remove(t.modelKey),!0)},e}();t.Canvas2DEngineBoundData=e;var i=function(i){function r(n,s){var o=this;i.call(this,s),this.worldSpaceToNodeLocal=function(e){var i=o._worldSpaceNode;if(i){var r=i.getWorldMatrix().clone();r.invert();var n=t.Vector3.TransformCoordinates(e,r),s=new t.Vector2(n.x,n.y),a=o.actualSize;return s.x+=.5*a.width,s.y+=.5*a.height,s}},this.worldSpaceCacheChanged=function(){var e=o.worldSpaceCanvasNode,i=t.VertexData.ExtractFromMesh(e);i.uvs=new Float32Array(8);var r=e.material,n=o._renderableData._cacheTexture;r.diffuseTexture!==n&&(r.diffuseTexture=n,n.hasAlpha=!0);for(var s=o._renderableData._cacheNodeUVs,a=0;a<4;a++)i.uvs[2*a+0]=s[a].x,i.uvs[2*a+1]=s[a].y;i.applyToMesh(e)},this._notifDebugMode=!1,this.minPartCountToUseInstancedArray=5,this._mapCounter=0,this._drawCallsOpaqueCounter=new t.PerfCounter,this._drawCallsAlphaTestCounter=new t.PerfCounter,this._drawCallsTransparentCounter=new t.PerfCounter,this._groupRenderCounter=new t.PerfCounter,this._updateTransparentDataCounter=new t.PerfCounter,this._cachedGroupRenderCounter=new t.PerfCounter,this._updateCachedStateCounter=new t.PerfCounter,this._updateLayoutCounter=new t.PerfCounter,this._updatePositioningCounter=new t.PerfCounter,this._updateLocalTransformCounter=new t.PerfCounter,this._updateGlobalTransformCounter=new t.PerfCounter,this._boundingInfoRecomputeCounter=new t.PerfCounter,this._uid=null,this._cachedCanvasGroup=null,this._renderingGroupObserver=null,this._beforeRenderObserver=null,this._afterRenderObserver=null,this._profileInfoText=null,t.Prim2DBase._isCanvasInit=!1,s||(s={}),this._cachingStrategy!==r.CACHESTRATEGY_TOPLEVELGROUPS&&(this._background=new t.Rectangle2D({parent:this,id:"###CANVAS BACKGROUND###",size:s.size}),this._background.zOrder=1,this._background.isPickable=!1,this._background.origin=t.Vector2.Zero(),this._background.levelVisible=!1,null!=s.backgroundRoundRadius&&(this.backgroundRoundRadius=s.backgroundRoundRadius),null!=s.backgroundBorder&&("string"==typeof s.backgroundBorder?this.backgroundBorder=r.GetBrushFromString(s.backgroundBorder):this.backgroundBorder=s.backgroundBorder),null!=s.backgroundBorderThickNess&&(this.backgroundBorderThickness=s.backgroundBorderThickNess),null!=s.backgroundFill&&("string"==typeof s.backgroundFill?this.backgroundFill=r.GetBrushFromString(s.backgroundFill):this.backgroundFill=s.backgroundFill),this.propertyChanged.add(function(t,e){"size"===t.propertyName&&(o._background.size=o.size)},t.Group2D.sizeProperty.flagId),this._background._patchHierarchy(this));var a=n.getEngine();this.__engineData=a.getOrAddExternalDataWithFactory("__BJSCANVAS2D__",function(t){return new e}),this._primPointerInfo=new t.PrimitivePointerInfo,this._capturedPointers=new t.StringDictionary,this._pickStartingPosition=t.Vector2.Zero(),this._hierarchyLevelMaxSiblingCount=50,this._hierarchyDepth=0,this._zOrder=0,this._zMax=1,this._scene=n,this._engine=a,this._renderingSize=new t.Size(0,0),this._designSize=s.designSize||null,this._designUseHorizAxis=s.designUseHorizAxis===!0,this._trackedGroups=new Array,this._maxAdaptiveWorldSpaceCanvasSize=null,this._groupCacheMaps=new t.StringDictionary,this._patchHierarchy(this);var h=null==s.enableInteraction||s.enableInteraction;if(this._fitRenderingDevice=!s.size,s.size||(s.size=new t.Size(a.getRenderWidth(),a.getRenderHeight())),n.onDisposeObservable.add(function(t,e){o.dispose()}),this._isScreenSpace)if(s.renderingPhase){if(!s.renderingPhase.camera||null==s.renderingPhase.renderingGroupID)throw Error("You have to specify a valid camera and renderingGroup");this._renderingGroupObserver=this._scene.onRenderingGroupObservable.add(function(e,i){o._scene.activeCamera===s.renderingPhase.camera&&e.renderStage===t.RenderingGroupInfo.STAGE_POSTTRANSPARENT&&(o._engine.clear(null,!1,!0,!0),o._render())},Math.pow(2,s.renderingPhase.renderingGroupID))}else this._afterRenderObserver=this._scene.onAfterRenderObservable.add(function(t,e){o._engine.clear(null,!1,!0,!0),o._render()});else this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(function(t,e){o._render()});this._supprtInstancedArray=null!==this._engine.getCaps().instancedArrays,this._setupInteraction(h),r._INSTANCES.push(this)}return o(r,i),Object.defineProperty(r.prototype,"drawCallsOpaqueCounter",{get:function(){return this._drawCallsOpaqueCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"drawCallsAlphaTestCounter",{get:function(){return this._drawCallsAlphaTestCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"drawCallsTransparentCounter",{get:function(){return this._drawCallsTransparentCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"groupRenderCounter",{get:function(){return this._groupRenderCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updateTransparentDataCounter",{get:function(){return this._updateTransparentDataCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cachedGroupRenderCounter",{get:function(){return this._cachedGroupRenderCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updateCachedStateCounter",{get:function(){return this._updateCachedStateCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updateLayoutCounter",{get:function(){return this._updateLayoutCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updatePositioningCounter",{get:function(){return this._updatePositioningCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updateLocalTransformCounter",{get:function(){return this._updateLocalTransformCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updateGlobalTransformCounter",{get:function(){return this._updateGlobalTransformCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"boundingInfoRecomputeCounter",{get:function(){return this._boundingInfoRecomputeCounter},enumerable:!0,configurable:!0}),Object.defineProperty(r,"instances",{get:function(){return r._INSTANCES},enumerable:!0,configurable:!0}),r.prototype._canvasPreInit=function(t){var e=null==t.cachingStrategy?r.CACHESTRATEGY_DONTCACHE:t.cachingStrategy;this._cachingStrategy=e,this._isScreenSpace=null==t.isScreenSpace||t.isScreenSpace},r.prototype._setupInteraction=function(t){var e=this;if(t!==this._interactionEnabled)if(this._interactionEnabled=t,this._isScreenSpace){if(!t)return void(this._scenePrePointerObserver&&(this.scene.onPrePointerObservable.remove(this._scenePrePointerObserver),this._scenePrePointerObserver=null));this._scenePrePointerObserver=this.scene.onPrePointerObservable.add(function(t,i){if(e.isVisible!==!1){var r=1/e.engine.getHardwareScalingLevel(),n=t.localPosition.multiplyByFloats(r,r);e._handlePointerEventForInteraction(t,n,i)}})}else{var i=this.scene;t?(i.constantlyUpdateMeshUnderPointer=!0,this._scenePointerObserver=i.onPointerObservable.add(function(t,i){if(e.isVisible!==!1&&t.pickInfo.hit&&t.pickInfo.pickedMesh===e._worldSpaceNode&&e.worldSpaceToNodeLocal){var r=e.worldSpaceToNodeLocal(t.pickInfo.pickedPoint);e._handlePointerEventForInteraction(t,r,i)}})):this._scenePointerObserver&&(this.scene.onPointerObservable.remove(this._scenePointerObserver),this._scenePointerObserver=null)}},r.prototype._setPointerCapture=function(e,i){if(this.isPointerCaptured(e))return!1;try{this.engine.getRenderingCanvas().setPointerCapture(e)}catch(t){}return this._primPointerInfo.updateRelatedTarget(i,t.Vector2.Zero()),this._bubbleNotifyPrimPointerObserver(i,t.PrimitivePointerInfo.PointerGotCapture,null),this._capturedPointers.add(e.toString(),i),!0},r.prototype._releasePointerCapture=function(e,i){if(this._capturedPointers.get(e.toString())!==i)return!1;try{this.engine.getRenderingCanvas().releasePointerCapture(e)}catch(t){}return this._primPointerInfo.updateRelatedTarget(i,t.Vector2.Zero()),this._bubbleNotifyPrimPointerObserver(i,t.PrimitivePointerInfo.PointerLostCapture,null),this._capturedPointers.remove(e.toString()),!0},r.prototype.isPointerCaptured=function(t){return this._capturedPointers.contains(t.toString())},r.prototype.getCapturedPrimitive=function(t){return 0===this._capturedPointers.count?null:this._capturedPointers.get(t.toString())},r.prototype._handlePointerEventForInteraction=function(e,i,r){if(!this.isDisposed&&this._updatePointerInfo(e,i)){var n=this.getCapturedPrimitive(this._primPointerInfo.pointerId);if(this._updateIntersectionList(this._primPointerInfo.canvasPointerPos,null!==n,!0),this._updateOverStatus(!0),this._actualOverPrimitive||n){var s=n||this._actualOverPrimitive.prim,o=n?this._primPointerInfo.canvasPointerPos.subtract(new t.Vector2(s.globalTransform.m[12],s.globalTransform.m[13])):this._actualOverPrimitive.intersectionLocation;this._primPointerInfo.updateRelatedTarget(s,o);var a=!1;e.type===t.PointerEventTypes.POINTERWHEEL?a=!this._bubbleNotifyPrimPointerObserver(s,t.PrimitivePointerInfo.PointerMouseWheel,e):e.type===t.PointerEventTypes.POINTERMOVE?a=!this._bubbleNotifyPrimPointerObserver(s,t.PrimitivePointerInfo.PointerMove,e):e.type===t.PointerEventTypes.POINTERDOWN?a=!this._bubbleNotifyPrimPointerObserver(s,t.PrimitivePointerInfo.PointerDown,e):e.type===t.PointerEventTypes.POINTERUP&&(a=!this._bubbleNotifyPrimPointerObserver(s,t.PrimitivePointerInfo.PointerUp,e)),r.skipNextObservers=a}}},r.prototype._updatePointerInfo=function(e,i){var r=this.scale,n=this._primPointerInfo;n.cancelBubble=!1,n.canvasPointerPos||(n.canvasPointerPos=t.Vector2.Zero());var s=this._scene.cameraToUseForPointers||this._scene.activeCamera;if(!s||!s.viewport)return!1;var o=this._scene.getEngine();if(this._isScreenSpace){var a=s.viewport,h=a.toGlobal(o.getRenderWidth(),o.getRenderHeight()),l=i.x-h.x,c=i.y-h.y;n.canvasPointerPos.x=(l-this.actualPosition.x)/r,n.canvasPointerPos.y=(o.getRenderHeight()-c-this.actualPosition.y)/r}else n.canvasPointerPos.x=i.x/r,n.canvasPointerPos.y=i.y/r;if(n.mouseWheelDelta=0,e.type===t.PointerEventTypes.POINTERWHEEL){var u=e.event;u.wheelDelta?n.mouseWheelDelta=u.wheelDelta/(40*t.PrimitivePointerInfo.MouseWheelPrecision):u.detail&&(n.mouseWheelDelta=-u.detail/t.PrimitivePointerInfo.MouseWheelPrecision)}else{var p=e.event;n.ctrlKey=p.ctrlKey,n.altKey=p.altKey,n.shiftKey=p.shiftKey,n.metaKey=p.metaKey,n.button=p.button,n.buttons=p.buttons,n.pointerId=p.pointerId,n.width=p.width,n.height=p.height,n.presssure=p.pressure,n.tilt.x=p.tiltX,n.tilt.y=p.tiltY,n.isCaptured=null!==this.getCapturedPrimitive(p.pointerId)}return!0},r.prototype._updateIntersectionList=function(t,e,i){if(i||this.scene.getRenderId()!==this._intersectionRenderId){this._globalTransform||this.updateCachedStates(!0);var n=r._interInfo;n.pickPosition.x=t.x,n.pickPosition.y=t.y,n.findFirstOnly=!1,e||this.levelBoundingInfo.doesIntersect(n.pickPosition)?this.intersect(n):(n.intersectedPrimitives=new Array,n.topMostIntersectedPrimitive=null),this._previousIntersectionList=this._actualIntersectionList,this._actualIntersectionList=n.intersectedPrimitives,this._previousOverPrimitive=this._actualOverPrimitive,this._actualOverPrimitive=n.topMostIntersectedPrimitive;(null!=this._previousOverPrimitive?this._previousOverPrimitive.prim:null)!==(null!=this._actualOverPrimitive?this._actualOverPrimitive.prim:null)&&this.onPropertyChanged("overPrim",this._previousOverPrimitive?this._previousOverPrimitive.prim:null,this._actualOverPrimitive?this._actualOverPrimitive.prim:null),this._intersectionRenderId=this.scene.getRenderId()}},r.prototype._updateOverStatus=function(e){if((e||this.scene.getRenderId()!==this._hoverStatusRenderId)&&this._previousIntersectionList&&this._actualIntersectionList){var i=this._previousOverPrimitive?this._previousOverPrimitive.prim:null,r=this._actualOverPrimitive?this._actualOverPrimitive.prim:null;if(i!==r){var n=this.getCapturedPrimitive(this._primPointerInfo.pointerId);(n&&n===i||!n&&i&&!i.isDisposed)&&(this._primPointerInfo.updateRelatedTarget(i,this._previousOverPrimitive.intersectionLocation),this._bubbleNotifyPrimPointerObserver(i,t.PrimitivePointerInfo.PointerOut,null)),(n&&n===r||!n&&r)&&(this._primPointerInfo.updateRelatedTarget(r,this._actualOverPrimitive.intersectionLocation),this._bubbleNotifyPrimPointerObserver(r,t.PrimitivePointerInfo.PointerOver,null))}this._hoverStatusRenderId=this.scene.getRenderId()}},r.prototype._updatePrimPointerPos=function(t){if(this._primPointerInfo.isCaptured)this._primPointerInfo.primitivePointerPos=this._primPointerInfo.relatedTargetPointerPos;else for(var e=0,i=this._actualIntersectionList;e<i.length;e++){var r=i[e];if(r.prim===t)return void(this._primPointerInfo.primitivePointerPos=r.intersectionLocation)}},r.prototype._debugExecObserver=function(e,i){if(this._notifDebugMode){for(var r="",n=0;n<e.hierarchyDepth;n++)r+="  ";var s=this._primPointerInfo;r+="[RID:"+this.scene.getRenderId()+"] ["+e.hierarchyDepth+"] event:"+t.PrimitivePointerInfo.getEventTypeName(i)+", id: "+e.id+" ("+t.Tools.getClassName(e)+"), primPos: "+s.primitivePointerPos.toString()+", canvasPos: "+s.canvasPointerPos.toString(),console.log(r)}},r.prototype._bubbleNotifyPrimPointerObserver=function(e,i,r){var n=this._primPointerInfo,s=r?r.event:null;0!=(i&(t.PrimitivePointerInfo.PointerOver|t.PrimitivePointerInfo.PointerOut))&&this._notifParents(e,i);for(var o=!1,a=e;a;){if(!o){if(this._updatePrimPointerPos(a),this._debugExecObserver(a,i),!a._pointerEventObservable.notifyObservers(n,i)&&r instanceof t.PointerInfoPre)return r.skipOnPointerObservable=!0,!1;if(this._triggerActionManager(a,n,i,s),n.cancelBubble){if(0==(i&(t.PrimitivePointerInfo.PointerOver|t.PrimitivePointerInfo.PointerOut)))return!1;o=!0}}o&&this._updatePrimPointerPos(a),a=a.parent}return!0},r.prototype._triggerActionManager=function(e,i,r,n){var s=this;if(this._globalTransform||this.updateCachedStates(!0),0!=(r&t.PrimitivePointerInfo.PointerDown)){if(this._pickStartingPosition=i.primitivePointerPos.clone(),this._pickStartingTime=(new Date).getTime(),this._pickedDownPrim=null,e.actionManager){if(this._pickedDownPrim=e,e.actionManager.hasPickTriggers){var o=t.ActionEvent.CreateNewFromPrimitive(e,i.primitivePointerPos,n);switch(n.button){case 0:e.actionManager.processTrigger(t.ActionManager.OnLeftPickTrigger,o);break;case 1:e.actionManager.processTrigger(t.ActionManager.OnCenterPickTrigger,o);break;case 2:e.actionManager.processTrigger(t.ActionManager.OnRightPickTrigger,o)}e.actionManager.processTrigger(t.ActionManager.OnPickDownTrigger,o)}e.actionManager.hasSpecificTrigger(t.ActionManager.OnLongPressTrigger)&&window.setTimeout(function(){var i=s._primPointerInfo,r=s.getCapturedPrimitive(i.pointerId);s._updateIntersectionList(i.canvasPointerPos,null!==r,!0),s._updateOverStatus(!1);var o=new t.IntersectInfo2D;o.pickPosition=i.canvasPointerPos.clone(),o.findFirstOnly=!1,s.intersect(o),null!==o.isPrimIntersected(e)&&e.actionManager&&0!==s._pickStartingTime&&(new Date).getTime()-s._pickStartingTime>t.ActionManager.LongPressDelay&&Math.abs(s._pickStartingPosition.x-o.pickPosition.x)<t.ActionManager.DragMovementThreshold&&Math.abs(s._pickStartingPosition.y-o.pickPosition.y)<t.ActionManager.DragMovementThreshold&&(s._pickStartingTime=0,e.actionManager.processTrigger(t.ActionManager.OnLongPressTrigger,t.ActionEvent.CreateNewFromPrimitive(e,i.primitivePointerPos,n)))},t.ActionManager.LongPressDelay)}}else if(0!=(r&t.PrimitivePointerInfo.PointerUp)){this._pickStartingTime=0;var o=t.ActionEvent.CreateNewFromPrimitive(e,i.primitivePointerPos,n);e.actionManager&&(e.actionManager.processTrigger(t.ActionManager.OnPickUpTrigger,o),Math.abs(this._pickStartingPosition.x-i.canvasPointerPos.x)<t.ActionManager.DragMovementThreshold&&Math.abs(this._pickStartingPosition.y-i.canvasPointerPos.y)<t.ActionManager.DragMovementThreshold&&e.actionManager.processTrigger(t.ActionManager.OnPickTrigger,o)),this._pickedDownPrim&&this._pickedDownPrim.actionManager&&this._pickedDownPrim!==e&&this._pickedDownPrim.actionManager.processTrigger(t.ActionManager.OnPickOutTrigger,o)}else if(0!=(r&t.PrimitivePointerInfo.PointerOver)){if(e.actionManager){var o=t.ActionEvent.CreateNewFromPrimitive(e,i.primitivePointerPos,n);e.actionManager.processTrigger(t.ActionManager.OnPointerOverTrigger,o)}}else if(0!=(r&t.PrimitivePointerInfo.PointerOut)&&e.actionManager){var o=t.ActionEvent.CreateNewFromPrimitive(e,i.primitivePointerPos,n);e.actionManager.processTrigger(t.ActionManager.OnPointerOutTrigger,o)}},r.prototype._notifParents=function(e,i){for(var r=this._primPointerInfo,n=this;n;)this._updatePrimPointerPos(n),i===t.PrimitivePointerInfo.PointerOver?(this._debugExecObserver(n,t.PrimitivePointerInfo.PointerEnter),n._pointerEventObservable.notifyObservers(r,t.PrimitivePointerInfo.PointerEnter)):i===t.PrimitivePointerInfo.PointerOut&&(this._debugExecObserver(n,t.PrimitivePointerInfo.PointerLeave),n._pointerEventObservable.notifyObservers(r,t.PrimitivePointerInfo.PointerLeave)),n=n.parent},r.prototype.dispose=function(){if(!i.prototype.dispose.call(this))return!1;this._profilingCanvas&&(this._profilingCanvas.dispose(),this._profilingCanvas=null),this.interactionEnabled&&this._setupInteraction(!1),this._renderingGroupObserver&&(this._scene.onRenderingGroupObservable.remove(this._renderingGroupObserver),this._renderingGroupObserver=null),this._beforeRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._beforeRenderObserver=null),this._afterRenderObserver&&(this._scene.onAfterRenderObservable.remove(this._afterRenderObserver),this._afterRenderObserver=null),this._groupCacheMaps&&(this._groupCacheMaps.forEach(function(t,e){return e.forEach(function(t){return t.dispose()})}),this._groupCacheMaps=null);var t=r._INSTANCES.indexOf(this);return t>-1&&r._INSTANCES.splice(t,1),!0},Object.defineProperty(r.prototype,"scene",{get:function(){return this._scene},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"engine",{get:function(){return this._engine},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"uid",{get:function(){return this._uid||(this._uid=t.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderObservable",{get:function(){return this._renderObservable||(this._renderObservable=new t.Observable),this._renderObservable},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"cachingStrategy",{get:function(){return this._cachingStrategy},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isScreenSpace",{get:function(){return this._isScreenSpace},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"worldSpaceCanvasNode",{get:function(){return this._worldSpaceNode},set:function(t){this._worldSpaceNode=t},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"supportInstancedArray",{get:function(){return this._supprtInstancedArray},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"backgroundFill",{get:function(){return this._background&&this._background.isVisible?this._background.fill:null},set:function(t){this.checkBackgroundAvailability(),t!==this._background.fill&&(this._background.fill=t,this._background.levelVisible=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"backgroundBorder",{get:function(){return this._background&&this._background.isVisible?this._background.border:null},set:function(t){this.checkBackgroundAvailability(),t!==this._background.border&&(this._background.border=t,this._background.levelVisible=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"backgroundBorderThickness",{get:function(){return this._background&&this._background.isVisible?this._background.borderThickness:null},set:function(t){this.checkBackgroundAvailability(),t!==this._background.borderThickness&&(this._background.borderThickness=t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"backgroundRoundRadius",{get:function(){return this._background&&this._background.isVisible?this._background.roundRadius:null},set:function(t){this.checkBackgroundAvailability(),t!==this._background.roundRadius&&(this._background.roundRadius=t,this._background.levelVisible=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"interactionEnabled",{get:function(){return this._interactionEnabled},set:function(t){this._setupInteraction(t)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fitRenderingDevice",{get:function(){return this._fitRenderingDevice},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"designSize",{get:function(){return this._designSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"designSizeUseHorizAxis",{get:function(){return this._designUseHorizAxis},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"overPrim",{get:function(){return this._actualOverPrimitive?this._actualOverPrimitive.prim:null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_engineData",{get:function(){return this.__engineData},enumerable:!0,configurable:!0}),r.prototype.createCanvasProfileInfoCanvas=function(){if(this._profilingCanvas)return this._profilingCanvas;var e=new n(this.scene,{id:"ProfileInfoCanvas",cachingStrategy:r.CACHESTRATEGY_DONTCACHE,children:[new t.Rectangle2D({id:"ProfileButton",border:"#ECECECEE",borderThickness:2,roundRadius:1,fill:"#ECECECEE",marginAlignment:"h: right, v: top",marginTop:"20",marginRight:"15",paddingTop:"4",paddingLeft:"15"}),new t.Rectangle2D({id:"ProfileBorder",border:"#FFFFFFFF",borderThickness:2,roundRadius:5,fill:"#C04040C0",marginAlignment:"h: right, v: top",margin:"10",padding:"10",children:[new t.Text2D("Stats",{id:"ProfileInfoText",marginAlignment:"h: left, v: top",fontName:"12pt Lucida Console",fontSignedDistanceField:!0})]})]});return this._profileInfoText=e.findById("ProfileInfoText"),this._profilingCanvas=e,this._profilingMinimized=!1,e.findById("ProfileButton").pointerEventObservable.add(function(t,e){this._profilingMinimized=!this._profilingMinimized}.bind(this),t.PrimitivePointerInfo.PointerUp),e},r.prototype.checkBackgroundAvailability=function(){if(this._cachingStrategy===r.CACHESTRATEGY_TOPLEVELGROUPS)throw Error("Can't use Canvas Background with the caching strategy TOPLEVELGROUPS")},r.prototype._initPerfMetrics=function(){this._drawCallsOpaqueCounter.fetchNewFrame(),this._drawCallsAlphaTestCounter.fetchNewFrame(),this._drawCallsTransparentCounter.fetchNewFrame(),this._groupRenderCounter.fetchNewFrame(),this._updateTransparentDataCounter.fetchNewFrame(),this._cachedGroupRenderCounter.fetchNewFrame(),this._updateCachedStateCounter.fetchNewFrame(),this._updateLayoutCounter.fetchNewFrame(),this._updatePositioningCounter.fetchNewFrame(),this._updateLocalTransformCounter.fetchNewFrame(),this._updateGlobalTransformCounter.fetchNewFrame(),this._boundingInfoRecomputeCounter.fetchNewFrame()},r.prototype._fetchPerfMetrics=function(){this._drawCallsOpaqueCounter.addCount(0,!0),this._drawCallsAlphaTestCounter.addCount(0,!0),this._drawCallsTransparentCounter.addCount(0,!0),this._groupRenderCounter.addCount(0,!0),this._updateTransparentDataCounter.addCount(0,!0),this._cachedGroupRenderCounter.addCount(0,!0),this._updateCachedStateCounter.addCount(0,!0),this._updateLayoutCounter.addCount(0,!0),this._updatePositioningCounter.addCount(0,!0),this._updateLocalTransformCounter.addCount(0,!0),this._updateGlobalTransformCounter.addCount(0,!0),this._boundingInfoRecomputeCounter.addCount(0,!0)},r.prototype._updateProfileCanvas=function(){if(null!=this._profileInfoText){if(this._profilingMinimized)return void(this._profileInfoText.text="");var t=function(t){return(Math.round(100*t)/100).toString()},e="Draw Calls:\n - Opaque:      "+t(this.drawCallsOpaqueCounter.current)+", (avg:"+t(this.drawCallsOpaqueCounter.lastSecAverage)+", t:"+t(this.drawCallsOpaqueCounter.total)+")\n - AlphaTest:   "+t(this.drawCallsAlphaTestCounter.current)+", (avg:"+t(this.drawCallsAlphaTestCounter.lastSecAverage)+", t:"+t(this.drawCallsAlphaTestCounter.total)+")\n - Transparent: "+t(this.drawCallsTransparentCounter.current)+", (avg:"+t(this.drawCallsTransparentCounter.lastSecAverage)+", t:"+t(this.drawCallsTransparentCounter.total)+")\nGroup Render: "+this.groupRenderCounter.current+", (avg:"+t(this.groupRenderCounter.lastSecAverage)+", t:"+t(this.groupRenderCounter.total)+")\nUpdate Transparent Data: "+this.updateTransparentDataCounter.current+", (avg:"+t(this.updateTransparentDataCounter.lastSecAverage)+", t:"+t(this.updateTransparentDataCounter.total)+")\nCached Group Render: "+this.cachedGroupRenderCounter.current+", (avg:"+t(this.cachedGroupRenderCounter.lastSecAverage)+", t:"+t(this.cachedGroupRenderCounter.total)+")\nUpdate Cached States: "+this.updateCachedStateCounter.current+", (avg:"+t(this.updateCachedStateCounter.lastSecAverage)+", t:"+t(this.updateCachedStateCounter.total)+")\n - Update Layout: "+this.updateLayoutCounter.current+", (avg:"+t(this.updateLayoutCounter.lastSecAverage)+", t:"+t(this.updateLayoutCounter.total)+")\n - Update Positioning: "+this.updatePositioningCounter.current+", (avg:"+t(this.updatePositioningCounter.lastSecAverage)+", t:"+t(this.updatePositioningCounter.total)+")\n - Update Local  Trans: "+this.updateLocalTransformCounter.current+", (avg:"+t(this.updateLocalTransformCounter.lastSecAverage)+", t:"+t(this.updateLocalTransformCounter.total)+")\n - Update Global Trans: "+this.updateGlobalTransformCounter.current+", (avg:"+t(this.updateGlobalTransformCounter.lastSecAverage)+", t:"+t(this.updateGlobalTransformCounter.total)+")\n - BoundingInfo Recompute: "+this.boundingInfoRecomputeCounter.current+", (avg:"+t(this.boundingInfoRecomputeCounter.lastSecAverage)+", t:"+t(this.boundingInfoRecomputeCounter.total)+")";this._profileInfoText.text=e}},r.prototype._addDrawCallCount=function(e,i){switch(i){case t.Render2DContext.RenderModeOpaque:return void this._drawCallsOpaqueCounter.addCount(e,!1);case t.Render2DContext.RenderModeAlphaTest:return void this._drawCallsAlphaTestCounter.addCount(e,!1);case t.Render2DContext.RenderModeTransparent:return void this._drawCallsTransparentCounter.addCount(e,!1)}},r.prototype._addGroupRenderCount=function(t){this._groupRenderCounter.addCount(t,!1)},r.prototype._addUpdateTransparentDataCount=function(t){this._updateTransparentDataCounter.addCount(t,!1)},r.prototype.addCachedGroupRenderCounter=function(t){this._cachedGroupRenderCounter.addCount(t,!1)},r.prototype.addUpdateCachedStateCounter=function(t){this._updateCachedStateCounter.addCount(t,!1)},r.prototype.addUpdateLayoutCounter=function(t){this._updateLayoutCounter.addCount(t,!1)},r.prototype.addUpdatePositioningCounter=function(t){this._updatePositioningCounter.addCount(t,!1)},r.prototype.addupdateLocalTransformCounter=function(t){this._updateLocalTransformCounter.addCount(t,!1)},r.prototype.addUpdateGlobalTransformCounter=function(t){this._updateGlobalTransformCounter.addCount(t,!1)},r.prototype._updateTrackedNodes=function(){var e=this.scene.cameraToUseForPointers||this.scene.activeCamera;e.getViewMatrix().multiplyToRef(e.getProjectionMatrix(),r._m);for(var i=this.engine.getRenderHeight(),n=e.viewport.toGlobal(this.engine.getRenderWidth(),i),s=0,o=this._trackedGroups;s<o.length;s++){var a=o[s];if(!a.isDisposed&&a.isVisible){var h=a.trackedNode,l=h.getWorldMatrix(),c=t.Vector3.Project(r._v,l,r._m,n),u=this.scale;a.x=Math.round(c.x/u),a.y=Math.round((i-c.y)/u)}}},r.prototype.updateCanvasLayout=function(t){this._updateCanvasState(t)},r.prototype._updateAdaptiveSizeWorldCanvas=function(){if(!(this._globalTransformStep<2)){var e=this.worldSpaceCanvasNode,i=e.getBoundingInfo().boundingBox,n=i.vectorsWorld,s=this.scene.cameraToUseForPointers||this.scene.activeCamera;s.getViewMatrix().multiplyToRef(s.getProjectionMatrix(),r._m);for(var o=s.viewport.toGlobal(this.engine.getRenderWidth(),this.engine.getRenderHeight()),a=new Array(4),h=0;h<4;h++)a[h]=t.Vector3.Project(n[h],r._mI,r._m,o);var l=a[3].subtract(a[0]).length(),c=a[3].subtract(a[1]).length(),u=a[1].subtract(a[2]).length(),p=a[2].subtract(a[0]).length(),d=Math.round(Math.max(c,p)),f=Math.round(Math.max(u,l)),m=d>f,_=Math.max(d,f);_=_<256?256:Math.pow(2,Math.ceil(Math.log(_)/Math.log(2))),_=Math.min(_,this._maxAdaptiveWorldSpaceCanvasSize);var g=_/(m?this.size.width:this.size.height);if(g!==this.scale){var y=g;this._setRenderingScale(y)}}},r.prototype._updateCanvasState=function(e){if(e||this.scene.getRenderId()!==this._updateRenderId){var i=!1,r=this.engine.getRenderWidth();r!==this._renderingSize.width&&(i=!0),this._renderingSize.width=r;var n=this.engine.getRenderHeight();if(n!==this._renderingSize.height&&(i=!0),this._renderingSize.height=n,i&&this._fitRenderingDevice&&(this._actualSize=this._renderingSize.clone(),this._size=this._renderingSize.clone(),this._background&&(this._background.size=this.size),this._setLayoutDirty()),this._designSize){var s=void 0;s=this._designUseHorizAxis?this._renderingSize.width/this._designSize.width:this._renderingSize.height/this._designSize.height,this.size=this._designSize.clone(),this.actualSize=this._designSize.clone(),this.scale=s}var o=new t.PrepareRender2DContext;++this._globalTransformProcessStep,this.updateCachedStates(!1),this._prepareGroupRender(o),this._updateRenderId=this.scene.getRenderId()}},r.prototype._render=function(){this._initPerfMetrics(),this._renderObservable&&this._renderObservable.hasObservers()&&this._renderObservable.notifyObservers(this,r.RENDEROBSERVABLE_PRE),this._updateCanvasState(!1),this._updateTrackedNodes(),this.isVisible!==!1&&(this._isScreenSpace||this._updateAdaptiveSizeWorldCanvas(),this._updateCanvasState(!1),this._primPointerInfo.canvasPointerPos&&(this._updateIntersectionList(this._primPointerInfo.canvasPointerPos,!1,!1),this._updateOverStatus(!1)),this.engine.setState(!1),this._groupRender(),this._isScreenSpace||this._isFlagSet(t.SmartPropertyPrim.flagWorldCacheChanged)&&(this.worldSpaceCacheChanged(),this._clearFlags(t.SmartPropertyPrim.flagWorldCacheChanged)),this._cachingStrategy===r.CACHESTRATEGY_CANVAS&&this._cachedCanvasGroup&&this._cachedCanvasGroup._renderCachedCanvas(),this._fetchPerfMetrics(),this._updateProfileCanvas(),this._renderObservable&&this._renderObservable.hasObservers()&&this._renderObservable.notifyObservers(this,r.RENDEROBSERVABLE_POST))},r.prototype._allocateGroupCache=function(e,i,n,s,o){void 0===s&&(s=!1),void 0===o&&(o=1);var a,h=(s?"MipMap":"NoMipMap")+"_"+o,l=e._renderableData,c=l._noResizeOnScale,u=null==i;a=c?u?r._unS:e.parent.actualScale:e.actualScale;var p=e.actualSize;p=new t.Size(Math.ceil(p.width*a.x),Math.ceil(p.height*a.y));var d=p.clone();n&&(p.width=Math.max(n.width,p.width),p.height=Math.max(n.height,p.height));for(var f,m=this._groupCacheMaps.getOrAddWithFactory(h,function(){return new Array}),_=null,g=0,y=m;g<y.length;g++){f=y[g];var v=f.allocateRect(p);if(v){_={node:v,texture:f};break}}if(!_){var x=new t.Size(r._groupTextureCacheSize,r._groupTextureCacheSize);(p.width>x.width||p.height>x.height)&&(x.width=Math.pow(2,Math.ceil(Math.log(p.width)/Math.log(2))),x.height=Math.pow(2,Math.ceil(Math.log(p.height)/Math.log(2))));var b="groupsMapChache"+this._mapCounter+++"forCanvas"+this.id;f=new t.MapTexture(b,this._scene,x,s?t.Texture.TRILINEAR_SAMPLINGMODE:t.Texture.BILINEAR_SAMPLINGMODE,s),f.hasAlpha=!0,f.anisotropicFilteringLevel=4,m.splice(0,0,f);var v=f.allocateRect(p);_={node:v,texture:f}}if(e!==this||this._isScreenSpace){var v=_.node,P=void 0;if(this._cachingStrategy===r.CACHESTRATEGY_CANVAS?(this._cachedCanvasGroup&&this._cachedCanvasGroup.dispose(),this._cachedCanvasGroup=t.Group2D._createCachedCanvasGroup(this),P=new t.Sprite2D(f,{parent:this._cachedCanvasGroup,id:"__cachedCanvasSprite__",spriteSize:d,spriteLocation:v.pos}),P.zOrder=1,P.origin=t.Vector2.Zero()):(P=new t.Sprite2D(f,{parent:i,id:"__cachedSpriteOfGroup__"+e.id,x:e.actualPosition.x,y:e.actualPosition.y,spriteSize:d,spriteLocation:v.pos,dontInheritParentScale:!0}),P.origin=e.origin.clone(),P.addExternalData("__cachedGroup__",e),P.pointerEventObservable.add(function(t,i){null!==e.pointerEventObservable&&e.pointerEventObservable.notifyObservers(t,i.mask)}),_.sprite=P),P&&c){var T=u?e.actualScale:e.actualScale.divide(e.parent.actualScale);P.scaleX=T.x,P.scaleY=T.y}}return _},r.prototype._registerTrackedNode=function(e){e._isFlagSet(t.SmartPropertyPrim.flagTrackedGroup)||(this._trackedGroups.push(e),e._setFlags(t.SmartPropertyPrim.flagTrackedGroup))},r.prototype._unregisterTrackedNode=function(e){if(e._isFlagSet(t.SmartPropertyPrim.flagTrackedGroup)){var i=this._trackedGroups.indexOf(e);i!==-1&&this._trackedGroups.splice(i,1),e._clearFlags(t.SmartPropertyPrim.flagTrackedGroup)}},r.GetSolidColorBrush=function(e){return r._solidColorBrushes.getOrAddWithFactory(e.toHexString(),function(){return new t.SolidColorBrush2D(e.clone(),!0)})},r.GetSolidColorBrushFromHex=function(e){return r._solidColorBrushes.getOrAddWithFactory(e,function(){return new t.SolidColorBrush2D(t.Color4.FromHexString(e),!0)})},r.GetGradientColorBrush=function(e,i,n,s,o){return void 0===n&&(n=t.Vector2.Zero()),void 0===s&&(s=0),void 0===o&&(o=1),r._gradientColorBrushes.getOrAddWithFactory(t.GradientColorBrush2D.BuildKey(e,i,n,s,o),function(){return new t.GradientColorBrush2D(e,i,n,s,o,!0)})},r.GetBrushFromString=function(e){e=e.trim();var i=e.split(",");if(1===i.length){var n=null;if(0===e.indexOf("solid:"))n=e.substr(6).trim();else{if(0!==e.indexOf("#"))return null;n=e}return r.GetSolidColorBrushFromHex(n)}0===i[0].indexOf("gradient:")&&(i[0]=i[0].substr(9).trim());try{var s=t.Color4.FromHexString(i[0].trim()),o=t.Color4.FromHexString(i[1].trim()),a=t.Vector2.Zero();if(i.length>2){var h=i[2].trim();if("["!==h.charAt(0)||"]"!==h.charAt(h.length-1))return null;var l=h.indexOf(":"),c=parseFloat(h.substr(1,l)),u=parseFloat(h.substr(l+1,h.length-(l+1)));a=new t.Vector2(c,u)}var p=0;i.length>3&&(p=t.Tools.ToRadians(parseFloat(i[3].trim())));var d=1;return i.length>4&&(d=parseFloat(i[4].trim())),r.GetGradientColorBrush(s,o,a,p,d)}catch(t){return null}},r.CACHESTRATEGY_TOPLEVELGROUPS=1,r.CACHESTRATEGY_ALLGROUPS=2,r.CACHESTRATEGY_CANVAS=3,r.CACHESTRATEGY_DONTCACHE=4,r.RENDEROBSERVABLE_PRE=1,r.RENDEROBSERVABLE_POST=2,r._INSTANCES=[],r._zMinDelta=1/(Math.pow(2,24)-1),r._interInfo=new t.IntersectInfo2D,r._v=t.Vector3.Zero(),r._m=t.Matrix.Identity(),r._mI=t.Matrix.Identity(),r._groupTextureCacheSize=1024,r._solidColorBrushes=new t.StringDictionary,r._gradientColorBrushes=new t.StringDictionary,r=s([t.className("Canvas2D","BABYLON")],r)}(t.Group2D);t.Canvas2D=i;var r=function(e){function r(r,n,s){var o=this;t.Prim2DBase._isCanvasInit=!0;var a=s;if(a.isScreenSpace=!1,a.size=n.clone(),s.cachingStrategy=null==s.cachingStrategy?i.CACHESTRATEGY_CANVAS:s.cachingStrategy,s.cachingStrategy!==i.CACHESTRATEGY_CANVAS)throw new Error("Right now only the CACHESTRATEGY_CANVAS cache Strategy is supported for WorldSpace Canvas. More will come soon!");e.call(this,r,s),t.Prim2DBase._isCanvasInit=!1,this._renderableData._useMipMap=!0,this._renderableData._anisotropicLevel=8;var h=!s||null==s.customWorldSpaceNode;this._customWorldSpaceNode=!h;var l=s?s.id||null:null,c=this.engine.getCaps().maxRenderTextureSize,u=Math.min(c,1024);if(null==s.maxAdaptiveCanvasSize?this._maxAdaptiveWorldSpaceCanvasSize=u:this._maxAdaptiveWorldSpaceCanvasSize=Math.min(s.maxAdaptiveCanvasSize,c),h){var p=new t.WorldSpaceCanvas2DNode(l,r,this),d=t.VertexData.CreatePlane({width:n.width,height:n.height,sideOrientation:s&&s.sideOrientation||t.Mesh.DEFAULTSIDE}),f=new t.StandardMaterial(l+"_Material",r);this.applyCachedTexture(d,f),d.applyToMesh(p,!0),f.specularColor=new t.Color3(0,0,0),f.disableLighting=!0,f.useAlphaFromDiffuseTexture=!0,p.position=s&&s.worldPosition||t.Vector3.Zero(),p.rotationQuaternion=s&&s.worldRotation||t.Quaternion.Identity(),p.material=f,this._worldSpaceNode=p}else this._worldSpaceNode=s.customWorldSpaceNode,this.applyCachedTexture(null,null);this.propertyChanged.add(function(t,e){var i=o._worldSpaceNode;i&&(i.isVisible=t.newValue)},t.Prim2DBase.isVisibleProperty.flagId)}return o(r,e),r.prototype.dispose=function(){if(!e.prototype.dispose.call(this))return!1;!this._customWorldSpaceNode&&this._worldSpaceNode&&(this._worldSpaceNode.dispose(),this._worldSpaceNode=null)},r=s([t.className("WorldSpaceCanvas2D","BABYLON")],r)}(i);t.WorldSpaceCanvas2D=r;var n=function(e){function i(i,r){t.Prim2DBase._isCanvasInit=!0,e.call(this,i,r)}return o(i,e),i=s([t.className("ScreenSpaceCanvas2D","BABYLON")],i)}(i);t.ScreenSpaceCanvas2D=n}(r||(r={}));var r;!function(t){var e=function(t){function e(e,i,r){t.call(this,e,i),this._canvas=r}return o(e,t),e.prototype.dispose=function(){t.prototype.dispose.call(this),this._canvas&&(this._canvas.dispose(),this._canvas=null)},e}(t.Mesh);t.WorldSpaceCanvas2DNode=e}(r||(r={}));var r;!function(t){function e(t,e,i){return function(){a.registerRenderingTemplate(t,e,i)}}var i=function(){function e(t,e){if(!t)throw Error("At least an execute lambda must be given at Command creation time");this._canExecuteChanged=null,this._lastCanExecuteResult=null,this.execute=t,this.canExecute=e}return e.prototype.canExecute=function(t){var e=!0;return this._canExecute&&(e=this._canExecute(t)),e!==this._lastCanExecuteResult&&(this._canExecuteChanged&&this._canExecuteChanged.hasObservers()&&this._canExecuteChanged.notifyObservers(null),this._lastCanExecuteResult=e),e},e.prototype.execute=function(t){this._execute(t)},Object.defineProperty(e.prototype,"canExecuteChanged",{get:function(){return this._canExecuteChanged||(this._canExecuteChanged=new t.Observable),this._canExecuteChanged},enumerable:!0,configurable:!0}),e}();t.Command=i;var r=function(e){function i(r){if(e.call(this),!r)throw Error("A settings object must be passed with at least either a parent or owner parameter");var n=t.Tools.getFullClassName(this);this._ownerWindow=null,this._parent=null,this._visualPlaceholder=null,this._visualTemplateRoot=null,this._visualChildrenPlaceholder=null,this._hierarchyDepth=0,this._renderingTemplateName=null!=r.templateName?r.templateName:a.DefaultTemplateName,this._style=null!=r.styleName?a.getStyle(n,r.styleName):null,this._flags=0,this._id=null!=r.id?r.id:null,this._uid=null,this._width=null!=r.width?r.width:null,this._height=null!=r.height?r.height:null,this._minWidth=null!=r.minWidth?r.minWidth:0,this._minHeight=null!=r.minHeight?r.minHeight:0,this._maxWidth=null!=r.maxWidth?r.maxWidth:Number.MAX_VALUE,this._maxHeight=null!=r.maxHeight?r.maxHeight:Number.MAX_VALUE,this._margin=null,this._padding=null,this._marginAlignment=null,this._setFlags(i.flagIsVisible|i.flagIsEnabled),r.marginTop&&this.margin.setTop(r.marginTop),r.marginLeft&&this.margin.setLeft(r.marginLeft),r.marginRight&&this.margin.setRight(r.marginRight),r.marginBottom&&this.margin.setBottom(r.marginBottom),r.margin&&("string"==typeof r.margin?this.margin.fromString(r.margin):this.margin.fromUniformPixels(r.margin)),r.marginHAlignment&&(this.marginAlignment.horizontal=r.marginHAlignment),r.marginVAlignment&&(this.marginAlignment.vertical=r.marginVAlignment),r.marginAlignment&&this.marginAlignment.fromString(r.marginAlignment),r.paddingTop&&this.padding.setTop(r.paddingTop),r.paddingLeft&&this.padding.setLeft(r.paddingLeft),r.paddingRight&&this.padding.setRight(r.paddingRight),r.paddingBottom&&this.padding.setBottom(r.paddingBottom),r.padding&&this.padding.fromString(r.padding),r.paddingHAlignment&&(this.paddingAlignment.horizontal=r.paddingHAlignment),r.paddingVAlignment&&(this.paddingAlignment.vertical=r.paddingVAlignment),r.paddingAlignment&&this.paddingAlignment.fromString(r.paddingAlignment),null!=r.parent&&(this._parent=r.parent,this._hierarchyDepth=this._parent._hierarchyDepth+1)}return o(i,e),Object.defineProperty(i,"enabledState",{get:function(){return i._enableState},enumerable:!0,configurable:!0}),Object.defineProperty(i,"disabledState",{get:function(){return i._disabledState},enumerable:!0,configurable:!0}),Object.defineProperty(i,"mouseOverState",{get:function(){return i._mouseOverState},enumerable:!0,configurable:!0}),i.prototype.dispose=function(){return!this.isDisposed&&(this._renderingTemplate&&(this._renderingTemplate.detach(),this._renderingTemplate=null),e.prototype.dispose.call(this),this.animations.splice(0),!0)},i.prototype.getAnimatables=function(){return new Array},i.prototype.findById=function(t){if(this._id===t)return this;for(var e=this._getChildren(),i=0,r=e;i<r.length;i++){var n=r[i],s=n.findById(t);if(null!=s)return s}},Object.defineProperty(i.prototype,"ownerWindow",{get:function(){return this._ownerWindow},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"style",{get:function(){return this.style?this._style.name:a.DefaultStyleName},set:function(e){if(!this._style||this._style.name!==e){var i=null;if(e&&!(i=a.getStyle(t.Tools.getFullClassName(this),e)))throw Error("Couldn't find Style "+e+" for UIElement "+t.Tools.getFullClassName(this));this._style&&this._style.removeStyle(this),i&&i.applyStyle(this),this._style=i}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"id",{get:function(){return this._id},set:function(t){this._id!==t&&(this._id=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"uid",{get:function(){return this._uid||(this._uid=t.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"hierarchyDepth",{get:function(){return this._hierarchyDepth},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},set:function(t){this._parent=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minWidth",{get:function(){return this._minWidth},set:function(t){this._minWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minHheight",{get:function(){return this._minHeight},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minHeight",{set:function(t){this._minHeight=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxWidth",{get:function(){return this._maxWidth},set:function(t){this._maxWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxHeight",{get:function(){return this._maxHeight},set:function(t){this._maxHeight=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualWidth",{get:function(){return this._actualWidth},set:function(t){this._actualWidth=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actualHeight",{get:function(){return this._actualHeight},set:function(t){this._actualHeight=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"margin",{get:function(){var e=this;return this._margin||(this._margin=new t.PrimitiveThickness(function(){return e.parent?e.parent.margin:null})),this._margin},set:function(t){this.margin.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasMargin",{get:function(){return null!==this._margin&&!this._margin.isDefault||null!==this._marginAlignment&&!this._marginAlignment.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"padding",{get:function(){var e=this;return this._padding||(this._padding=new t.PrimitiveThickness(function(){return e.parent?e.parent.padding:null})),this._padding},set:function(t){this.padding.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasPadding",{get:function(){return null!==this._padding&&!this._padding.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"marginAlignment",{get:function(){return this._marginAlignment||(this._marginAlignment=new t.PrimitiveAlignment),this._marginAlignment},set:function(t){this.marginAlignment.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasMarginAlignment",{get:function(){return null!==this._marginAlignment&&!this._marginAlignment.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"paddingAlignment",{get:function(){return this._paddingAlignment||(this._paddingAlignment=new t.PrimitiveAlignment),this._paddingAlignment},set:function(t){this.paddingAlignment.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_hasPaddingAlignment",{get:function(){return null!==this._paddingAlignment&&!this._paddingAlignment.isDefault},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isVisible",{get:function(){return this._isFlagSet(i.flagIsVisible)},set:function(t){this.isVisible!==t&&(this._visualPlaceholder.levelVisible=t,this._changeFlags(i.flagIsVisible,t))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isEnabled",{get:function(){return this._isFlagSet(i.flagIsEnabled)},set:function(t){this._changeFlags(i.flagIsEnabled,t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isFocused",{get:function(){return this._isFlagSet(i.flagIsFocus)},set:function(t){if(!this.isFocusable){var e=this.parent;if(!e)return;e.isFocused=t}t&&this.ownerWindow.focusManager.setFocusOn(this,this.getFocusScope()),this._changeFlags(i.flagIsFocus,t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isMouseOver",{get:function(){return this._isFlagSet(i.flagIsMouseOver)},set:function(t){this._changeFlags(i.flagIsMouseOver,t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isFocusScope",{get:function(){return this._isFlagSet(i.flagIsFocusScope)},set:function(t){this._changeFlags(i.flagIsFocusScope,t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isFocusable",{get:function(){return this._isFlagSet(i.flagIsFocusable)},set:function(t){this._changeFlags(i.flagIsFocusable,t)},enumerable:!0,configurable:!0}),i.prototype.getFocusScope=function(){if(this.isFocusScope)return this;var t=this.parent;return t?t.getFocusScope():null},i.prototype._isFlagSet=function(t){return 0!=(this._flags&t)},i.prototype._areAllFlagsSet=function(t){return(this._flags&t)===t},i.prototype._areSomeFlagsSet=function(t){return 0!=(this._flags&t)},i.prototype._clearFlags=function(t){this._flags&=~t},i.prototype._setFlags=function(t){var e=this._flags;return this._flags|=t,e},i.prototype._changeFlags=function(t,e){e?this._flags|=t:this._flags&=~t},i.prototype._assignTemplate=function(e){e||(e=a.DefaultTemplateName);var i=t.Tools.getFullClassName(this);if(!i)throw Error("Couldn't access class name of this UIElement, you have to decorate the type with the className decorator");var r=a.getRenderingTemplate(i,e);if(!r)throw Error("Couldn't get the renderingTemplate "+e+" of class "+i);this._renderingTemplateName=e,this._renderingTemplate=r(),this._renderingTemplate.attach(this)},i.prototype._createVisualTree=function(){var e=this.ownerWindow.canvas;this.parent&&(e=this.parent.visualChildrenPlaceholder),this._renderingTemplate||this._assignTemplate(this._renderingTemplateName),this._visualPlaceholder=new t.Group2D({parent:e,id:"GUI "+t.Tools.getClassName(this)+" RootGroup of "+this.id});var i=this._visualPlaceholder;i.addExternalData("_GUIOwnerElement_",this),i.dataSource=this,i.createSimpleDataBinding(t.Prim2DBase.widthProperty,"width",t.DataBinding.MODE_ONEWAY),i.createSimpleDataBinding(t.Prim2DBase.heightProperty,"height",t.DataBinding.MODE_ONEWAY),i.createSimpleDataBinding(t.Prim2DBase.actualWidthProperty,"actualWidth",t.DataBinding.MODE_ONEWAYTOSOURCE),i.createSimpleDataBinding(t.Prim2DBase.actualHeightProperty,"actualHeight",t.DataBinding.MODE_ONEWAYTOSOURCE),i.createSimpleDataBinding(t.Prim2DBase.marginProperty,"margin",t.DataBinding.MODE_ONEWAY),i.createSimpleDataBinding(t.Prim2DBase.marginAlignmentProperty,"marginAlignment",t.DataBinding.MODE_ONEWAY),this.createVisualTree()},i.prototype._patchUIElement=function(t,e){t&&(this._ownerWindow||t._registerVisualToBuild(this),this._ownerWindow=t),this._parent=e,e&&(this._hierarchyDepth=e.hierarchyDepth+1);var i=this._getChildren();if(i)for(var r=0,n=i;r<n.length;r++){var s=n[r];s._patchUIElement(t,this)}},i.prototype._getDataSource=function(){var t=e.prototype._getDataSource.call(this);if(null!=t)return t;var i=this.parent;return null!=i?i.dataSource:null},i.prototype.createVisualTree=function(){var t=this._renderingTemplate.createVisualTree(this,this._visualPlaceholder);this._visualTemplateRoot=t.root,this._visualChildrenPlaceholder=t.contentPlaceholder},Object.defineProperty(i.prototype,"visualPlaceholder",{get:function(){return this._visualPlaceholder},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visualTemplateRoot",{get:function(){return this._visualTemplateRoot},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visualChildrenPlaceholder",{get:function(){return this._visualChildrenPlaceholder},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_position",{get:function(){return null},enumerable:!0,configurable:!0}),i.UIELEMENT_PROPCOUNT=16,i.flagVisualToBuild=1,i.flagIsVisible=2,i.flagIsFocus=4,i.flagIsFocusScope=8,i.flagIsFocusable=16,i.flagIsEnabled=32,i.flagIsMouseOver=64,i._enableState="Enabled",i._disabledState="Disabled",i._mouseOverState="MouseOver",s([t.dependencyProperty(0,function(t){return i.parentProperty=t})],i.prototype,"parent",null),s([t.dependencyProperty(1,function(t){return i.widthProperty=t})],i.prototype,"width",null),s([t.dependencyProperty(2,function(t){return i.heightProperty=t})],i.prototype,"height",null),s([t.dependencyProperty(3,function(t){return i.minWidthProperty=t})],i.prototype,"minWidth",null),s([t.dependencyProperty(4,function(t){return i.minHeightProperty=t})],i.prototype,"minHheight",null),s([t.dependencyProperty(5,function(t){return i.maxWidthProperty=t})],i.prototype,"maxWidth",null),s([t.dependencyProperty(6,function(t){return i.maxHeightProperty=t})],i.prototype,"maxHeight",null),s([t.dependencyProperty(7,function(t){return i.actualWidthProperty=t})],i.prototype,"actualWidth",null),s([t.dependencyProperty(8,function(t){return i.actualHeightProperty=t})],i.prototype,"actualHeight",null),s([t.dynamicLevelProperty(9,function(t){return i.marginProperty=t})],i.prototype,"margin",null),s([t.dynamicLevelProperty(10,function(t){return i.paddingProperty=t})],i.prototype,"padding",null),s([t.dynamicLevelProperty(11,function(t){return i.marginAlignmentProperty=t})],i.prototype,"marginAlignment",null),s([t.dynamicLevelProperty(12,function(t){return i.paddingAlignmentProperty=t})],i.prototype,"paddingAlignment",null),s([t.dynamicLevelProperty(13,function(t){return i.isEnabledProperty=t})],i.prototype,"isEnabled",null),s([t.dynamicLevelProperty(14,function(t){return i.isFocusedProperty=t})],i.prototype,"isFocused",null),s([t.dynamicLevelProperty(15,function(t){return i.isMouseOverProperty=t})],i.prototype,"isMouseOver",null),i}(t.SmartPropertyBase);t.UIElement=r;var n=function(){function t(){}return Object.defineProperty(t.prototype,"name",{get:function(){return null},enumerable:!0,configurable:!0}),t}();t.UIElementStyle=n;var a=function(){function e(){}return e.registerDataTemplate=function(t,e){},e.getStyle=function(t,i){var r=e.stylesByUIElement.get(t);if(!r)throw Error("The type "+t+" is unknown, no style were registered for it.");var n=r.get(i);if(!n)throw Error("Couldn't find Template "+i+" of UIElement type "+t);return n},e.registerStyle=function(i,r,n){var s=e.stylesByUIElement.getOrAddWithFactory(i,function(){return new t.StringDictionary});s.contains(r)?s[r]=n:s.add(r,n)},Object.defineProperty(e,"DefaultStyleName",{get:function(){return e._defaultStyleName},set:function(t){e._defaultStyleName=t},enumerable:!0,configurable:!0}),e.getRenderingTemplate=function(t,i){var r=e.renderingTemplatesByUIElement.get(t);if(!r)throw Error("The type "+t+" is unknown, no Rendering Template were registered for it.");var n=r.get(i);if(!n)throw Error("Couldn't find Template "+i+" of UI Element type "+t);return n},e.registerRenderingTemplate=function(i,r,n){var s=e.renderingTemplatesByUIElement.getOrAddWithFactory(i,function(){return new t.StringDictionary});s.contains(r)?s[r]=n:s.add(r,n)},Object.defineProperty(e,"DefaultTemplateName",{get:function(){return e._defaultTemplateName},set:function(t){e._defaultTemplateName=t},enumerable:!0,configurable:!0}),e.stylesByUIElement=new t.StringDictionary,e.renderingTemplatesByUIElement=new t.StringDictionary,e._defaultTemplateName="Default",e._defaultStyleName="Default",e}();t.GUIManager=a;var h=function(){function t(){}return t.prototype.attach=function(t){this._owner=t},t.prototype.detach=function(){},Object.defineProperty(t.prototype,"owner",{get:function(){return this._owner},enumerable:!0,configurable:!0}),t}();t.UIElementRenderingTemplateBase=h,t.registerWindowRenderingTemplate=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t){if(t||(t={}),e.call(this,t),this.isOrientationHorizontal=null==t.isOrientationHorizontal||t.isOrientationHorizontal,this._children=new Array,null!=t.children)for(var i=0,r=t.children;i<r.length;i++){var n=r[i];this._children.push(n)}}return o(i,e),Object.defineProperty(i.prototype,"isOrientationHorizontal",{get:function(){return this._isOrientationHorizontal},set:function(t){this._isOrientationHorizontal=t},enumerable:!0,configurable:!0}),i.prototype.createVisualTree=function(){e.prototype.createVisualTree.call(this),this._childrenPlaceholder=new t.Group2D({parent:this._visualPlaceholder,id:"StackPanel Children Placeholder of "+this.id});var i=this._childrenPlaceholder;i.layoutEngine=this.isOrientationHorizontal?t.StackPanelLayoutEngine.Horizontal:t.StackPanelLayoutEngine.Vertical,i.dataSource=this,i.createSimpleDataBinding(t.Prim2DBase.marginProperty,"padding",t.DataBinding.MODE_ONEWAY),i.createSimpleDataBinding(t.Prim2DBase.marginAlignmentProperty,"paddingAlignment",t.DataBinding.MODE_ONEWAY),this._visualChildrenPlaceholder=this._childrenPlaceholder},Object.defineProperty(i.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),i.prototype._getChildren=function(){return this.children},i.STACKPANEL_PROPCOUNT=t.UIElement.UIELEMENT_PROPCOUNT+3,s([t.dependencyProperty(i.STACKPANEL_PROPCOUNT+0,function(t){return i.orientationHorizontalProperty=t})],i.prototype,"isOrientationHorizontal",null),i=s([t.className("StackPanel","BABYLON")],i)}(t.UIElement);t.StackPanel=e;var i=function(e){function i(){e.apply(this,arguments)}return o(i,e),i.prototype.createVisualTree=function(t,e){return{root:e,contentPlaceholder:e}},i.prototype.attach=function(t){e.prototype.attach.call(this,t)},i=s([t.registerWindowRenderingTemplate("BABYLON.StackPanel","Default",function(){return new i})],i)}(t.UIElementRenderingTemplateBase);t.DefaultStackPanelRenderingTemplate=i}(r||(r={}));var r;!function(t){var e=function(e){function i(t){e.call(this,t)}return o(i,e),Object.defineProperty(i.prototype,"background",{get:function(){return this._background||(this._background=new t.ObservableStringDictionary(!1)),this._background},set:function(t){this.background.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"borderThickness",{get:function(){return this._borderThickness},set:function(t){this._borderThickness=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fontName",{get:function(){return this._fontName},set:function(t){this._fontName=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"foreground",{get:function(){return this._foreground},set:function(t){this._foreground=t},enumerable:!0,configurable:!0}),i.CONTROL_PROPCOUNT=t.UIElement.UIELEMENT_PROPCOUNT+5,s([t.dependencyProperty(t.UIElement.UIELEMENT_PROPCOUNT+0,function(t){return i.backgroundProperty=t})],i.prototype,"background",null),s([t.dependencyProperty(t.UIElement.UIELEMENT_PROPCOUNT+1,function(t){return i.borderProperty=t})],i.prototype,"border",null),s([t.dependencyProperty(t.UIElement.UIELEMENT_PROPCOUNT+2,function(t){return i.borderThicknessProperty=t})],i.prototype,"borderThickness",null),s([t.dependencyProperty(t.UIElement.UIELEMENT_PROPCOUNT+3,function(t){return i.fontNameProperty=t})],i.prototype,"fontName",null),s([t.dependencyProperty(t.UIElement.UIELEMENT_PROPCOUNT+4,function(t){return i.foregroundProperty=t})],i.prototype,"foreground",null),i=s([t.className("Control","BABYLON")],i)}(t.UIElement);t.Control=e}(r||(r={}));var r;!function(t){var e=function(e){function i(t){t||(t={}),e.call(this,t),null!=t.content&&(this._content=t.content)}return o(i,e),i.prototype.dispose=function(){return!this.isDisposed&&(this.content&&this.content.dispose&&(this.content.dispose(),this.content=null),this.__contentUIElement&&(this.__contentUIElement.dispose(),this.__contentUIElement=null),e.prototype.dispose.call(this),!0)},Object.defineProperty(i.prototype,"content",{get:function(){return this._content},set:function(t){this._content=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_contentUIElement",{get:function(){return this.__contentUIElement||this._buildContentUIElement(),this.__contentUIElement},enumerable:!0,configurable:!0}),i.prototype._createVisualTree=function(){e.prototype._createVisualTree.call(this),this._contentPlaceholder=new t.Group2D({parent:this._visualPlaceholder,id:"ContentControl Content Placeholder of "+this.id});var i=this._contentPlaceholder;i.dataSource=this,i.createSimpleDataBinding(t.Prim2DBase.marginProperty,"padding",t.DataBinding.MODE_ONEWAY),i.createSimpleDataBinding(t.Prim2DBase.marginAlignmentProperty,"paddingAlignment",t.DataBinding.MODE_ONEWAY),this._visualChildrenPlaceholder=this._contentPlaceholder},i.prototype._buildContentUIElement=function(){var e=this._content;if(this.__contentUIElement=null,e instanceof t.UIElement)this.__contentUIElement=e;else if("string"==typeof e||"boolean"==typeof e||"number"==typeof e){var i=new t.Label({parent:this,id:"Content of "+this.id}),r=new t.DataBinding;r.propertyPathName="content",r.stringFormat=function(t){return""+t},r.dataSource=this,i.createDataBinding(t.Label.textProperty,r),this.__contentUIElement=i}this.__contentUIElement&&this.__contentUIElement._patchUIElement(this.ownerWindow,this)},i.prototype._getChildren=function(){var t=new Array;return this.content&&t.push(this._contentUIElement),t},i.CONTENTCONTROL_PROPCOUNT=t.Control.CONTROL_PROPCOUNT+2,s([t.dependencyProperty(t.Control.CONTROL_PROPCOUNT+0,function(t){return i.contentProperty=t})],i.prototype,"content",null),i=s([t.className("ContentControl","BABYLON")],i)}(t.Control);t.ContentControl=e}(r||(r={}));var r;!function(t){var e=function(){function t(t){this.focusScope=t,this.focusedElement=null}return t}(),i=function(){function i(){this._focusScopes=new t.StringDictionary,this._rootScope=new e(null),this._activeScope=null}return i.prototype.setFocusOn=function(t,i){var r=null!=i?this._focusScopes.getOrAddWithFactory(i.uid,function(t){return new e(i)}):this._rootScope;r.focusedElement!==t&&(r.focusedElement&&(r.focusedElement.isFocused=!1),r.focusedElement=t),this._activeScope!==r&&(this._activeScope=r)},i}();t.FocusManager=i;var r=function(){function e(e){this.scene=e,this.screenSpaceCanvas=new t.ScreenSpaceCanvas2D(e,{id:"GUI Canvas",cachingStrategy:t.Canvas2D.CACHESTRATEGY_DONTCACHE}),this.focusManager=new i}return e}(),n=function(e){function i(r,n){var s=this;if(n||(n={}),e.call(this,n),this.isFocusScope=!0,this.isActive=!1,this._UIElementVisualToBuildList||(this._UIElementVisualToBuildList=new Array),this._patchUIElement(this,null),n.worldPosition||n.worldRotation){var o=null==n.width?100:n.width,a=null==n.height?100:n.height,h=null==n.worldPosition?t.Vector3.Zero():n.worldPosition,l=null==n.worldRotation?t.Quaternion.Identity():n.worldRotation;this._canvas=new t.WorldSpaceCanvas2D(r,new t.Size(o,a),{id:"GUI Canvas",cachingStrategy:t.Canvas2D.CACHESTRATEGY_DONTCACHE,worldPosition:h,worldRotation:l}),this._isWorldSpaceCanvas=!0}else this._sceneData=i.getSceneData(r),this._canvas=this._sceneData.screenSpaceCanvas,this._isWorldSpaceCanvas=!1,this._left=null!=n.left?n.left:0,this._bottom=null!=n.bottom?n.bottom:0;this._renderObserver=this._canvas.renderObservable.add(function(t,e){return s._canvasPreRender()},t.Canvas2D.RENDEROBSERVABLE_PRE),this._disposeObserver=this._canvas.disposeObservable.add(function(t,e){return s._canvasDisposed()}),this._canvas.propertyChanged.add(function(t,e){"overPrim"===t.propertyName&&s._overPrimChanged(t.oldValue,t.newValue)}),this._mouseOverUIElement=null}return o(i,e),Object.defineProperty(i.prototype,"canvas",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"left",{get:function(){return this._left},set:function(e){var i=new t.Vector2(this._left,this._bottom);this._left=e,this.onPropertyChanged("_position",i,this._position)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bottom",{get:function(){return this._bottom},set:function(e){var i=new t.Vector2(this._left,this._bottom);this._bottom=e,this.onPropertyChanged("_position",i,this._position)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"position",{get:function(){return this._position},set:function(t){this._left=t.x,this._bottom=t.y},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isActive",{get:function(){return this._isActive},set:function(t){this._isActive=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"focusManager",{get:function(){return this._sceneData.focusManager},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"_position",{get:function(){return new t.Vector2(this.left,this.bottom)},enumerable:!0,configurable:!0}),i.prototype.createVisualTree=function(){e.prototype.createVisualTree.call(this),this._visualPlaceholder.createSimpleDataBinding(t.Group2D.positionProperty,"position")},i.prototype._registerVisualToBuild=function(e){e._isFlagSet(t.UIElement.flagVisualToBuild)||(this._UIElementVisualToBuildList||(this._UIElementVisualToBuildList=new Array),this._UIElementVisualToBuildList.push(e),e._setFlags(t.UIElement.flagVisualToBuild))},i.prototype._overPrimChanged=function(e,i){for(var r=this._mouseOverUIElement,n=null,s=i?i.traverseUp(function(e){return e instanceof t.Group2D}):null;s;){var o=s.getExternalData("_GUIOwnerElement_");if(o){n=o;break}s=s.parent?s.parent.traverseUp(function(e){return e instanceof t.Group2D}):null}r!==n&&(r&&(r.isMouseOver=!1),n&&(n.isMouseOver=!0),this._mouseOverUIElement=n)},i.prototype._canvasPreRender=function(){if(this._UIElementVisualToBuildList.length>0){for(var t=this._UIElementVisualToBuildList.sort(function(t,e){return t.hierarchyDepth-e.hierarchyDepth}),e=0,i=t;e<i.length;e++){i[e]._createVisualTree()}this._UIElementVisualToBuildList.splice(0)}},i.prototype._canvasDisposed=function(){this._canvas.disposeObservable.remove(this._disposeObserver),this._canvas.renderObservable.remove(this._renderObserver)},i.getSceneData=function(t){return i._sceneData.getOrAddWithFactory(t.uid,function(e){return new r(t)})},i.WINDOW_PROPCOUNT=t.ContentControl.CONTENTCONTROL_PROPCOUNT+4,i._sceneData=new t.StringDictionary,s([t.dependencyProperty(t.ContentControl.CONTENTCONTROL_PROPCOUNT+0,function(t){return i.leftProperty=t})],i.prototype,"left",null),s([t.dependencyProperty(t.ContentControl.CONTENTCONTROL_PROPCOUNT+1,function(t){return i.bottomProperty=t})],i.prototype,"bottom",null),s([t.dependencyProperty(t.ContentControl.CONTENTCONTROL_PROPCOUNT+2,function(t){return i.positionProperty=t})],i.prototype,"position",null),s([t.dependencyProperty(t.ContentControl.CONTENTCONTROL_PROPCOUNT+3,function(t){return i.isActiveProperty=t})],i.prototype,"isActive",null),i=s([t.className("Window","BABYLON")],i)}(t.ContentControl);t.Window=n;var a=function(e){function i(){e.apply(this,arguments)}return o(i,e),i.prototype.createVisualTree=function(e,i){var r=new t.Rectangle2D({parent:i,fill:"#808080FF"});return{root:r,contentPlaceholder:r}},i=s([t.registerWindowRenderingTemplate("BABYLON.Window","Default",function(){return new i})],i)}(t.UIElementRenderingTemplateBase);t.DefaultWindowRenderingTemplate=a}(r||(r={}));var r;!function(t){var e=function(e){function i(t){t||(t={}),e.call(this,t),null!=t.text&&(this.text=t.text)}return o(i,e),Object.defineProperty(i.prototype,"_position",{get:function(){return t.Vector2.Zero()},enumerable:!0,configurable:!0}),i.prototype._getChildren=function(){return i._emptyArray},i.prototype.createVisualTree=function(){e.prototype.createVisualTree.call(this);this._visualChildrenPlaceholder},Object.defineProperty(i.prototype,"text",{get:function(){return this._text},set:function(t){this._text=t},enumerable:!0,configurable:!0}),i._emptyArray=new Array,s([t.dependencyProperty(t.Control.CONTROL_PROPCOUNT+0,function(t){return i.textProperty=t})],i.prototype,"text",null),i=s([t.className("Label","BABYLON")],i)}(t.Control);t.Label=e;var i=function(e){function i(){e.apply(this,arguments)}return o(i,e),i.prototype.createVisualTree=function(e,i){var r=new t.Text2D("",{parent:i});return r.createSimpleDataBinding(t.Text2D.textProperty,"text"),r.dataSource=e,{root:r,contentPlaceholder:r}},i=s([t.registerWindowRenderingTemplate("BABYLON.Label","Default",function(){return new i})],i)}(t.UIElementRenderingTemplateBase);t.DefaultLabelRenderingTemplate=i}(r||(r={}));var r;!function(t){var e=function(e){function i(r){r||(r={}),e.call(this,r),null==r.paddingAlignment&&(this.paddingAlignment.horizontal=t.PrimitiveAlignment.AlignCenter,this.paddingAlignment.vertical=t.PrimitiveAlignment.AlignCenter),this._normalStateBackground=new t.ObservableStringDictionary(!1),this._normalStateBorder=new t.ObservableStringDictionary(!1),this._defaultStateBackground=new t.ObservableStringDictionary(!1),this._defaultStateBorder=new t.ObservableStringDictionary(!1),this._normalStateBackground.add(t.UIElement.enabledState,t.Canvas2D.GetSolidColorBrushFromHex("#337AB7FF")),this._normalStateBackground.add(t.UIElement.disabledState,t.Canvas2D.GetSolidColorBrushFromHex("#7BA9D0FF")),this._normalStateBackground.add(t.UIElement.mouseOverState,t.Canvas2D.GetSolidColorBrushFromHex("#286090FF")),this._normalStateBackground.add(i.pushedState,t.Canvas2D.GetSolidColorBrushFromHex("#1E496EFF")),this._normalStateBorder.add(t.UIElement.enabledState,t.Canvas2D.GetSolidColorBrushFromHex("#2E6DA4FF")),this._normalStateBorder.add(t.UIElement.disabledState,t.Canvas2D.GetSolidColorBrushFromHex("#77A0C4FF")),this._normalStateBorder.add(t.UIElement.mouseOverState,t.Canvas2D.GetSolidColorBrushFromHex("#204D74FF")),this._normalStateBorder.add(i.pushedState,t.Canvas2D.GetSolidColorBrushFromHex("#2E5D9EFF")),this._defaultStateBackground.add(t.UIElement.enabledState,t.Canvas2D.GetSolidColorBrushFromHex("#FFFFFFFF")),this._defaultStateBackground.add(t.UIElement.disabledState,t.Canvas2D.GetSolidColorBrushFromHex("#FFFFFFFF")),this._defaultStateBackground.add(t.UIElement.mouseOverState,t.Canvas2D.GetSolidColorBrushFromHex("#E6E6E6FF")),this._defaultStateBackground.add(i.pushedState,t.Canvas2D.GetSolidColorBrushFromHex("#D4D4D4FF")),this._defaultStateBorder.add(t.UIElement.enabledState,t.Canvas2D.GetSolidColorBrushFromHex("#CCCCCCFF")),this._defaultStateBorder.add(t.UIElement.disabledState,t.Canvas2D.GetSolidColorBrushFromHex("#DEDEDEFF")),this._defaultStateBorder.add(t.UIElement.mouseOverState,t.Canvas2D.GetSolidColorBrushFromHex("#ADADADFF")),this._defaultStateBorder.add(i.pushedState,t.Canvas2D.GetSolidColorBrushFromHex("#6C8EC5FF"))}return o(i,e),Object.defineProperty(i,"pushedState",{get:function(){return i._pushedState},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isPushed",{get:function(){return this._isPushed},set:function(t){this._isPushed=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isDefault",{get:function(){return this._isDefault},set:function(t){this._isDefault=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isOutline",{get:function(){return this._isOutline},set:function(t){this._isOutline=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"clickObservable",{get:function(){return this._clickObservable||(this._clickObservable=new t.Observable),this._clickObservable},enumerable:!0,configurable:!0}),i.prototype._raiseClick=function(){this._clickObservable&&this._clickObservable.hasObservers()&&this._clickObservable.notifyObservers(this)},i.prototype.createVisualTree=function(){var i=this;e.prototype.createVisualTree.call(this),this._visualPlaceholder.pointerEventObservable.add(function(e,r){i.isVisible&&i.isEnabled&&e.relatedTarget!==i._visualPlaceholder&&(r.mask===t.PrimitivePointerInfo.PointerUp?(i._raiseClick(),i.isPushed=!1):r.mask===t.PrimitivePointerInfo.PointerDown&&(i.isPushed=!0,i.isFocused=!0))},t.PrimitivePointerInfo.PointerUp|t.PrimitivePointerInfo.PointerDown)},Object.defineProperty(i.prototype,"normalStateBackground",{get:function(){return this._normalStateBackground},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"defaultStateBackground",{get:function(){return this._defaultStateBackground},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"normalStateBorder",{get:function(){return this._normalStateBorder},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"defaultStateBorder",{get:function(){return this._defaultStateBorder},enumerable:!0,configurable:!0}),i.BUTTON_PROPCOUNT=t.ContentControl.CONTENTCONTROL_PROPCOUNT+3,i._pushedState="Pushed",s([t.dependencyProperty(t.ContentControl.CONTROL_PROPCOUNT+0,function(t){return i.isPushedProperty=t})],i.prototype,"isPushed",null),s([t.dependencyProperty(t.ContentControl.CONTROL_PROPCOUNT+1,function(t){return i.isDefaultProperty=t})],i.prototype,"isDefault",null),s([t.dependencyProperty(t.ContentControl.CONTROL_PROPCOUNT+2,function(t){return i.isOutlineProperty=t})],i.prototype,"isOutline",null),i=s([t.className("Button","BABYLON")],i)}(t.ContentControl);t.Button=e;var i=function(i){function r(){i.apply(this,arguments)}return o(r,i),r.prototype.createVisualTree=function(e,i){return this._rect=new t.Rectangle2D({parent:i,fill:"#FF8080FF",border:"#FF8080FF",roundRadius:10,borderThickness:2}),this.stateChange(),{root:this._rect,contentPlaceholder:this._rect}},r.prototype.attach=function(r){var n=this;i.prototype.attach.call(this,r),this.owner.propertyChanged.add(function(t,e){return n.stateChange()},t.UIElement.isEnabledProperty.flagId|t.UIElement.isFocusedProperty.flagId|t.UIElement.isMouseOverProperty.flagId|e.isDefaultProperty.flagId|e.isOutlineProperty.flagId|e.isPushedProperty.flagId);var s=r;s.normalStateBackground.dictionaryChanged.add(function(t,e){return n.stateChange()}),s.normalStateBorder.dictionaryChanged.add(function(t,e){return n.stateChange()}),s.defaultStateBackground.dictionaryChanged.add(function(t,e){return n.stateChange()}),s.defaultStateBorder.dictionaryChanged.add(function(t,e){return n.stateChange()})},r.prototype.stateChange=function(){var i=this.owner,r=t.UIElement.enabledState,n=i.isDefault?i.defaultStateBackground.get(r):i.normalStateBackground.get(r),s=i.isDefault?i.defaultStateBorder.get(r):i.normalStateBorder.get(r);i.isPushed?(r=e.pushedState,i.isDefault?(n=i.defaultStateBackground.get(r),s=i.defaultStateBorder.get(r)):(n=i.normalStateBackground.get(r),s=i.normalStateBorder.get(r))):i.isMouseOver?(r=t.UIElement.mouseOverState,i.isDefault?(n=i.defaultStateBackground.get(r),s=i.defaultStateBorder.get(r)):(n=i.normalStateBackground.get(r),s=i.normalStateBorder.get(r))):i.isEnabled||(r=t.UIElement.disabledState,i.isDefault?(n=i.defaultStateBackground.get(r),s=i.defaultStateBorder.get(r)):(n=i.normalStateBackground.get(r),s=i.normalStateBorder.get(r))),this._rect.fill=n,this._rect.border=s},r=s([t.registerWindowRenderingTemplate("BABYLON.Button","Default",function(){return new r})],r)}(t.UIElementRenderingTemplateBase);t.DefaultButtonRenderingTemplate=i}(r||(r={})),r.Effect.ShadersStore.ellipse2dPixelShader="varying vec4 vColor;\nvoid main(void) {\ngl_FragColor=vColor;\n}",r.Effect.ShadersStore.ellipse2dVertexShader="\n#ifdef Instanced\n#define att attribute\n#else\n#define att uniform\n#endif\nattribute float index;\natt vec2 zBias;\natt vec4 transformX;\natt vec4 transformY;\natt float opacity;\n#ifdef Border\natt float borderThickness;\n#endif\n#ifdef FillSolid\natt vec4 fillSolidColor;\n#endif\n#ifdef BorderSolid\natt vec4 borderSolidColor;\n#endif\n#ifdef FillGradient\natt vec4 fillGradientColor1;\natt vec4 fillGradientColor2;\natt vec4 fillGradientTY;\n#endif\n#ifdef BorderGradient\natt vec4 borderGradientColor1;\natt vec4 borderGradientColor2;\natt vec4 borderGradientTY;\n#endif\n\natt vec3 properties;\n#define TWOPI 6.28318530\n\nvarying vec2 vUV;\nvarying vec4 vColor;\nvoid main(void) {\nvec2 pos2;\n#ifdef Border\nfloat w=properties.x;\nfloat h=properties.y;\nfloat ms=properties.z;\nvec2 borderOffset=vec2(1.0,1.0);\nfloat segi=index;\nif (index<ms) {\nborderOffset=vec2(1.0-(borderThickness*2.0/w),1.0-(borderThickness*2.0/h));\n}\nelse {\nsegi-=ms;\n}\nfloat angle=TWOPI*segi/ms;\npos2.x=(cos(angle)/2.0)+0.5;\npos2.y=(sin(angle)/2.0)+0.5;\npos2.x=((pos2.x-0.5)*borderOffset.x)+0.5;\npos2.y=((pos2.y-0.5)*borderOffset.y)+0.5;\n#else\nif (index == 0.0) {\npos2=vec2(0.5,0.5);\n}\nelse {\nfloat ms=properties.z;\nfloat angle=TWOPI*(index-1.0)/ms;\npos2.x=(cos(angle)/2.0)+0.5;\npos2.y=(sin(angle)/2.0)+0.5;\n}\n#endif\n#ifdef FillSolid\nvColor=fillSolidColor;\n#endif\n#ifdef BorderSolid\nvColor=borderSolidColor;\n#endif\n#ifdef FillGradient\nfloat v=dot(vec4(pos2.xy,1,1),fillGradientTY);\nvColor=mix(fillGradientColor2,fillGradientColor1,v); \n#endif\n#ifdef BorderGradient\nfloat v=dot(vec4(pos2.xy,1,1),borderGradientTY);\nvColor=mix(borderGradientColor2,borderGradientColor1,v); \n#endif\nvColor.a*=opacity;\nvec4 pos;\npos.xy=pos2.xy*properties.xy;\npos.z=1.0;\npos.w=1.0;\ngl_Position=vec4(dot(pos,transformX),dot(pos,transformY),zBias.x,1);\n}",r.Effect.ShadersStore.lines2dPixelShader="varying vec4 vColor;\nvoid main(void) {\ngl_FragColor=vColor;\n}",r.Effect.ShadersStore.lines2dVertexShader="\n#ifdef Instanced\n#define att attribute\n#else\n#define att uniform\n#endif\nattribute vec2 position;\natt vec2 zBias;\natt vec4 transformX;\natt vec4 transformY;\natt float opacity;\n#ifdef FillSolid\natt vec4 fillSolidColor;\n#endif\n#ifdef BorderSolid\natt vec4 borderSolidColor;\n#endif\n#ifdef FillGradient\natt vec2 boundingMin;\natt vec2 boundingMax;\natt vec4 fillGradientColor1;\natt vec4 fillGradientColor2;\natt vec4 fillGradientTY;\n#endif\n#ifdef BorderGradient\natt vec4 borderGradientColor1;\natt vec4 borderGradientColor2;\natt vec4 borderGradientTY;\n#endif\n#define TWOPI 6.28318530\n\nvarying vec2 vUV;\nvarying vec4 vColor;\nvoid main(void) {\n#ifdef FillSolid\nvColor=fillSolidColor;\n#endif\n#ifdef BorderSolid\nvColor=borderSolidColor;\n#endif\n#ifdef FillGradient\nfloat v=dot(vec4((position.xy-boundingMin)/(boundingMax-boundingMin),1,1),fillGradientTY);\nvColor=mix(fillGradientColor2,fillGradientColor1,v); \n#endif\n#ifdef BorderGradient\nfloat v=dot(vec4((position.xy-boundingMin)/(boundingMax-boundingMin),1,1),borderGradientTY);\nvColor=mix(borderGradientColor2,borderGradientColor1,v); \n#endif\nvColor.a*=opacity;\nvec4 pos;\npos.xy=position.xy;\npos.z=1.0;\npos.w=1.0;\ngl_Position=vec4(dot(pos,transformX),dot(pos,transformY),zBias.x,1);\n}",r.Effect.ShadersStore.rect2dPixelShader="varying vec4 vColor;\nvoid main(void) {\ngl_FragColor=vColor;\n}",r.Effect.ShadersStore.rect2dVertexShader="\n#ifdef Instanced\n#define att attribute\n#else\n#define att uniform\n#endif\nattribute float index;\natt vec2 zBias;\natt vec4 transformX;\natt vec4 transformY;\natt float opacity;\n#ifdef Border\natt float borderThickness;\n#endif\n#ifdef FillSolid\natt vec4 fillSolidColor;\n#endif\n#ifdef BorderSolid\natt vec4 borderSolidColor;\n#endif\n#ifdef FillGradient\natt vec4 fillGradientColor1;\natt vec4 fillGradientColor2;\natt vec4 fillGradientTY;\n#endif\n#ifdef BorderGradient\natt vec4 borderGradientColor1;\natt vec4 borderGradientColor2;\natt vec4 borderGradientTY;\n#endif\n\natt vec3 properties;\n\n#define rsub0 17.0\n#define rsub1 33.0\n#define rsub2 49.0\n#define rsub3 65.0\n#define rsub 64.0\n#define TWOPI 6.28318530\n\nvarying vec2 vUV;\nvarying vec4 vColor;\nvoid main(void) {\nvec2 pos2;\n\nif (properties.z == 0.0) {\n#ifdef Border\nfloat w=properties.x;\nfloat h=properties.y;\nvec2 borderOffset=vec2(1.0,1.0);\nfloat segi=index;\nif (index<4.0) {\nborderOffset=vec2(1.0-(borderThickness*2.0/w),1.0-(borderThickness*2.0/h));\n}\nelse {\nsegi-=4.0;\n}\nif (segi == 0.0) {\npos2=vec2(1.0,1.0);\n} \nelse if (segi == 1.0) {\npos2=vec2(1.0,0.0);\n}\nelse if (segi == 2.0) {\npos2=vec2(0.0,0.0);\n} \nelse {\npos2=vec2(0.0,1.0);\n}\npos2.x=((pos2.x-0.5)*borderOffset.x)+0.5;\npos2.y=((pos2.y-0.5)*borderOffset.y)+0.5;\n#else\nif (index == 0.0) {\npos2=vec2(0.5,0.5);\n}\nelse if (index == 1.0) {\npos2=vec2(1.0,1.0);\n}\nelse if (index == 2.0) {\npos2=vec2(1.0,0.0);\n}\nelse if (index == 3.0) {\npos2=vec2(0.0,0.0);\n}\nelse {\npos2=vec2(0.0,1.0);\n}\n#endif\n}\nelse\n{\n#ifdef Border\nfloat w=properties.x;\nfloat h=properties.y;\nfloat r=properties.z;\nfloat nru=r/w;\nfloat nrv=r/h;\nvec2 borderOffset=vec2(1.0,1.0);\nfloat segi=index;\nif (index<rsub) {\nborderOffset=vec2(1.0-(borderThickness*2.0/w),1.0-(borderThickness*2.0/h));\n}\nelse {\nsegi-=rsub;\n}\n\nif (segi<rsub0) {\npos2=vec2(1.0-nru,nrv);\n}\n\nelse if (segi<rsub1) {\npos2=vec2(nru,nrv);\n}\n\nelse if (segi<rsub2) {\npos2=vec2(nru,1.0-nrv);\n}\n\nelse {\npos2=vec2(1.0-nru,1.0-nrv);\n}\nfloat angle=TWOPI-((index-1.0)*TWOPI/(rsub-0.5));\npos2.x+=cos(angle)*nru;\npos2.y+=sin(angle)*nrv;\npos2.x=((pos2.x-0.5)*borderOffset.x)+0.5;\npos2.y=((pos2.y-0.5)*borderOffset.y)+0.5;\n#else\nif (index == 0.0) {\npos2=vec2(0.5,0.5);\n}\nelse {\nfloat w=properties.x;\nfloat h=properties.y;\nfloat r=properties.z;\nfloat nru=r/w;\nfloat nrv=r/h;\n\nif (index<rsub0) {\npos2=vec2(1.0-nru,nrv);\n}\n\nelse if (index<rsub1) {\npos2=vec2(nru,nrv);\n}\n\nelse if (index<rsub2) {\npos2=vec2(nru,1.0-nrv);\n}\n\nelse {\npos2=vec2(1.0-nru,1.0-nrv);\n}\nfloat angle=TWOPI-((index-1.0)*TWOPI/(rsub-0.5));\npos2.x+=cos(angle)*nru;\npos2.y+=sin(angle)*nrv;\n}\n#endif\n}\n#ifdef FillSolid\nvColor=fillSolidColor;\n#endif\n#ifdef BorderSolid\nvColor=borderSolidColor;\n#endif\n#ifdef FillGradient\nfloat v=dot(vec4(pos2.xy,1,1),fillGradientTY);\nvColor=mix(fillGradientColor2,fillGradientColor1,v); \n#endif\n#ifdef BorderGradient\nfloat v=dot(vec4(pos2.xy,1,1),borderGradientTY);\nvColor=mix(borderGradientColor2,borderGradientColor1,v); \n#endif\nvColor.a*=opacity;\nvec4 pos;\npos.xy=pos2.xy*properties.xy;\npos.z=1.0;\npos.w=1.0;\ngl_Position=vec4(dot(pos,transformX),dot(pos,transformY),zBias.x,1);\n}",r.Effect.ShadersStore.sprite2dPixelShader="varying vec2 vUV;\nvarying float vOpacity;\nuniform bool alphaTest;\nuniform sampler2D diffuseSampler;\nvoid main(void) {\nvec4 color=texture2D(diffuseSampler,vUV);\nif (alphaTest)\n{\nif (color.a<0.95) {\ndiscard;\n}\n}\ncolor.a*=vOpacity;\ngl_FragColor=color;\n}",r.Effect.ShadersStore.sprite2dVertexShader="\n#ifdef Instanced\n#define att attribute\n#else\n#define att uniform\n#endif\n\nattribute float index;\natt vec2 topLeftUV;\natt vec2 sizeUV;\natt vec2 scaleFactor;\natt vec2 textureSize;\n\natt vec3 properties;\natt vec2 zBias;\natt vec4 transformX;\natt vec4 transformY;\natt float opacity;\n\n\nvarying vec2 vUV;\nvarying float vOpacity;\nvoid main(void) {\nvec2 pos2;\n\nvec2 off=vec2(0.0,0.0);\nvec2 sfSizeUV=sizeUV*scaleFactor;\nfloat frame=properties.x;\nfloat invertY=properties.y;\nfloat alignToPixel=properties.z;\n\nif (index == 0.0) {\npos2=vec2(0.0,0.0);\nvUV=vec2(topLeftUV.x+(frame*sfSizeUV.x)+off.x,topLeftUV.y-off.y);\n}\n\nelse if (index == 1.0) {\npos2=vec2(0.0,1.0);\nvUV=vec2(topLeftUV.x+(frame*sfSizeUV.x)+off.x,(topLeftUV.y+sfSizeUV.y));\n}\n\nelse if (index == 2.0) {\npos2=vec2( 1.0,1.0);\nvUV=vec2(topLeftUV.x+sfSizeUV.x+(frame*sfSizeUV.x),(topLeftUV.y+sfSizeUV.y));\n}\n\nelse if (index == 3.0) {\npos2=vec2( 1.0,0.0);\nvUV=vec2(topLeftUV.x+sfSizeUV.x+(frame*sfSizeUV.x),topLeftUV.y-off.y);\n}\nif (invertY == 1.0) {\nvUV.y=1.0-vUV.y;\n}\nvec4 pos;\nif (alignToPixel == 1.0)\n{\npos.xy=floor(pos2.xy*sizeUV*textureSize);\n} else {\npos.xy=pos2.xy*sizeUV*textureSize;\n}\nvOpacity=opacity;\npos.z=1.0;\npos.w=1.0;\ngl_Position=vec4(dot(pos,transformX),dot(pos,transformY),zBias.x,1);\n} ",r.Effect.ShadersStore.text2dPixelShader="\nvarying vec4 vColor;\nvarying vec2 vUV;\n\nuniform sampler2D diffuseSampler;\nvoid main(void) {\n#ifdef SignedDistanceField\nfloat dist=texture2D(diffuseSampler,vUV).r;\nif (dist<0.5) {\ndiscard;\n}\n\n\n\n\n\ngl_FragColor=vec4(vColor.xyz*dist,1.0);\n#else\nvec4 color=texture2D(diffuseSampler,vUV);\ngl_FragColor=color*vColor;\n#endif\n}",r.Effect.ShadersStore.text2dVertexShader="\n#ifdef Instanced\n#define att attribute\n#else\n#define att uniform\n#endif\n\nattribute float index;\natt vec2 zBias;\natt vec4 transformX;\natt vec4 transformY;\natt float opacity;\natt vec2 topLeftUV;\natt vec2 sizeUV;\natt vec2 textureSize;\natt vec4 color;\natt float superSampleFactor;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\nvoid main(void) {\nvec2 pos2;\n\nif (index == 0.0) {\npos2=vec2(0.0,0.0);\nvUV=vec2(topLeftUV.x,topLeftUV.y+sizeUV.y);\n}\n\nelse if (index == 1.0) {\npos2=vec2(0.0,1.0);\nvUV=vec2(topLeftUV.x,topLeftUV.y);\n}\n\nelse if (index == 2.0) {\npos2=vec2(1.0,1.0);\nvUV=vec2(topLeftUV.x+sizeUV.x,topLeftUV.y);\n}\n\nelse if (index == 3.0) {\npos2=vec2(1.0,0.0);\nvUV=vec2(topLeftUV.x+sizeUV.x,topLeftUV.y+sizeUV.y);\n}\n\nvUV=(floor(vUV*textureSize)+vec2(0.0,0.0))/textureSize;\nvColor=color;\nvColor.a*=opacity;\nvec4 pos;\npos.xy=floor(pos2.xy*superSampleFactor*sizeUV*textureSize); \npos.z=1.0;\npos.w=1.0;\ngl_Position=vec4(dot(pos,transformX),dot(pos,transformY),zBias.x,1);\n}",("undefined"!=typeof window&&window.module||void 0!==t)&&void 0!==t.exports&&(t.exports=r)},function(t,e,i){t.exports=i(0)}])});