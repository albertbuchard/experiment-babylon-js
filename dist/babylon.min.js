!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.EBJS=i():t.EBJS=i()}(this,function(){return function(t){function i(h){if(s[h])return s[h].exports;var e=s[h]={i:h,l:!1,exports:{}};return t[h].call(e.exports,e,e.exports,i),e.l=!0,e.exports}var s={};return i.m=t,i.c=s,i.i=function(t){return t},i.d=function(t,s,h){i.o(t,s)||Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:h})},i.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(s,"a",s),s},i.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},i.p="http://localhost:7000/dist/",i(i.s=8)}([function(t,i,s){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var h={},e=s(2),o=s(1);i.BABYLON=h,i.OIMO=e,i.HANDJS=o},function(t,i,s){"use strict";(function(t){!function(){function t(){w=!0,clearTimeout(k),k=setTimeout(function(){w=!1},700)}function i(t,i){for(;t;){if(t.contains(i))return t;t=t.parentNode}return null}function s(t,s,h){for(var e=i(t,s),o=t,n=[];o&&o!==e;)x(o,"pointerenter")&&n.push(o),o=o.parentNode;for(;n.length>0;)h(n.pop())}function h(t,s,h){for(var e=i(t,s),o=t;o&&o!==e;)x(o,"pointerleave")&&h(o),o=o.parentNode}function e(t,i){["pointerdown","pointermove","pointerup","pointerover","pointerout"].forEach(function(s){window.addEventListener(t(s),function(t){!w&&d(t.target,s)&&i(t,s,!0)})}),void 0===window["on"+t("pointerenter").toLowerCase()]&&window.addEventListener(t("pointerover"),function(t){if(!w){var h=d(t.target,"pointerenter");h&&h!==window&&(h.contains(t.relatedTarget)||s(h,t.relatedTarget,function(s){i(t,"pointerenter",!1,s,t.relatedTarget)}))}}),void 0===window["on"+t("pointerleave").toLowerCase()]&&window.addEventListener(t("pointerout"),function(t){if(!w){var s=d(t.target,"pointerleave");s&&s!==window&&(s.contains(t.relatedTarget)||h(s,t.relatedTarget,function(s){i(t,"pointerleave",!1,s,t.relatedTarget)}))}})}if(!window.PointerEvent){Array.prototype.indexOf||(Array.prototype.indexOf=function(t){var i=Object(this),s=i.length>>>0;if(0===s)return-1;var h=0;if(arguments.length>0&&(h=Number(arguments[1]),h!==h?h=0:0!==h&&1/0!==h&&h!==-1/0&&(h=(h>0||-1)*Math.floor(Math.abs(h)))),h>=s)return-1;for(var e=h>=0?h:Math.max(s-Math.abs(h),0);s>e;e++)if(e in i&&i[e]===t)return e;return-1}),Array.prototype.forEach||(Array.prototype.forEach=function(t,i){if(!(this&&t instanceof Function))throw new TypeError;for(var s=0;s<this.length;s++)t.call(i,this[s],s,this)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/,"")});var o=["pointerdown","pointerup","pointermove","pointerover","pointerout","pointercancel","pointerenter","pointerleave"],n=["PointerDown","PointerUp","PointerMove","PointerOver","PointerOut","PointerCancel","PointerEnter","PointerLeave"],a="touch",r="pen",l="mouse",c={},m=function(t){for(;t&&!t.handjs_forcePreventDefault;)t=t.parentNode;return!!t||window.handjs_forcePreventDefault},p=function(t,i,s,h,e){var o=void 0;if(document.createEvent?(o=document.createEvent("MouseEvents"),o.initMouseEvent(i,s,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,e||t.relatedTarget)):(o=document.createEventObject(),o.screenX=t.screenX,o.screenY=t.screenY,o.clientX=t.clientX,o.clientY=t.clientY,o.ctrlKey=t.ctrlKey,o.altKey=t.altKey,o.shiftKey=t.shiftKey,o.metaKey=t.metaKey,o.button=t.button,o.relatedTarget=e||t.relatedTarget),void 0===o.offsetX&&(void 0!==t.offsetX?(Object&&void 0!==Object.defineProperty&&(Object.defineProperty(o,"offsetX",{writable:!0}),Object.defineProperty(o,"offsetY",{writable:!0})),o.offsetX=t.offsetX,o.offsetY=t.offsetY):Object&&void 0!==Object.defineProperty?(Object.defineProperty(o,"offsetX",{get:function(){return this.currentTarget&&this.currentTarget.offsetLeft?t.clientX-this.currentTarget.offsetLeft:t.clientX}}),Object.defineProperty(o,"offsetY",{get:function(){return this.currentTarget&&this.currentTarget.offsetTop?t.clientY-this.currentTarget.offsetTop:t.clientY}})):void 0!==t.layerX&&(o.offsetX=t.layerX-t.currentTarget.offsetLeft,o.offsetY=t.layerY-t.currentTarget.offsetTop)),o.isPrimary=void 0===t.isPrimary||t.isPrimary,t.pressure)o.pressure=t.pressure;else{var n=0;void 0!==t.which?n=t.which:void 0!==t.button&&(n=t.button),o.pressure=0===n?0:.5}if(o.rotation=t.rotation?t.rotation:0,o.hwTimestamp=t.hwTimestamp?t.hwTimestamp:0,o.tiltX=t.tiltX?t.tiltX:0,o.tiltY=t.tiltY?t.tiltY:0,o.height=t.height?t.height:0,o.width=t.width?t.width:0,o.preventDefault=function(){void 0!==t.preventDefault&&t.preventDefault()},void 0!==o.stopPropagation){var c=o.stopPropagation;o.stopPropagation=function(){void 0!==t.stopPropagation&&t.stopPropagation(),c.call(this)}}switch(o.pointerId=t.pointerId,o.pointerType=t.pointerType,o.pointerType){case 2:o.pointerType=a;break;case 3:o.pointerType=r;break;case 4:o.pointerType=l}h?h.dispatchEvent(o):t.target?t.target.dispatchEvent(o):t.srcElement.fireEvent("on"+v(i),o)},u=function(t,i,s,h,e){t.pointerId=1,t.pointerType=l,p(t,i,s,h,e)},y=function(t,i,s,h,e,o){var n=i.identifier+2;i.pointerId=n,i.pointerType=a,i.currentTarget=s,void 0!==h.preventDefault&&(i.preventDefault=function(){h.preventDefault()}),p(i,t,e,s,o)},x=function(t,i){return t.__handjsGlobalRegisteredEvents&&t.__handjsGlobalRegisteredEvents[i]},d=function(t,i){for(;t&&!x(t,i);)t=t.parentNode;return t||x(window,i)?window:void 0},f=function(t,i,s,h,e,o){d(s,t)&&y(t,i,s,h,e,o)},v=function(t){return t.toLowerCase().replace("pointer","mouse")},N=function(t,i){return t+n[o.indexOf(i)]},b=function(t,i,s,h){if(void 0===t.__handjsRegisteredEvents&&(t.__handjsRegisteredEvents=[]),h){if(void 0!==t.__handjsRegisteredEvents[i])return void t.__handjsRegisteredEvents[i]++;t.__handjsRegisteredEvents[i]=1,t.addEventListener(i,s,!1)}else{if(t.__handjsRegisteredEvents.indexOf(i)!==-1&&0!==--t.__handjsRegisteredEvents[i])return;t.removeEventListener(i,s),t.__handjsRegisteredEvents[i]=0}},z=function(t,i,s){if(t.__handjsGlobalRegisteredEvents||(t.__handjsGlobalRegisteredEvents=[]),s){if(void 0!==t.__handjsGlobalRegisteredEvents[i])return void t.__handjsGlobalRegisteredEvents[i]++;t.__handjsGlobalRegisteredEvents[i]=1}else void 0!==t.__handjsGlobalRegisteredEvents[i]&&--t.__handjsGlobalRegisteredEvents[i]<0&&(t.__handjsGlobalRegisteredEvents[i]=0);var h=void 0,e=void 0;switch(window.MSPointerEvent?(h=function(t){return N("MS",t)},e=p):(h=v,e=u),i){case"pointerenter":case"pointerleave":var o=h(i);void 0!==t["on"+o.toLowerCase()]&&b(t,o,function(t){e(t,i)},s)}},A=function(t){var i=t.prototype?t.prototype.addEventListener:t.addEventListener,s=function(t,s,h){o.indexOf(t)!==-1&&z(this,t,!0),void 0===i?this.attachEvent("on"+v(t),s):i.call(this,t,s,h)};t.prototype?t.prototype.addEventListener=s:t.addEventListener=s},g=function(t){var i=t.prototype?t.prototype.removeEventListener:t.removeEventListener,s=function(t,s,h){o.indexOf(t)!==-1&&z(this,t,!1),void 0===i?this.detachEvent(v(t),s):i.call(this,t,s,h)};t.prototype?t.prototype.removeEventListener=s:t.removeEventListener=s};A(window),A(window.HTMLElement||window.Element),A(document),navigator.isCocoonJS||(A(HTMLBodyElement),A(HTMLDivElement),A(HTMLImageElement),A(HTMLUListElement),A(HTMLAnchorElement),A(HTMLLIElement),A(HTMLTableElement),window.HTMLSpanElement&&A(HTMLSpanElement)),window.HTMLCanvasElement&&A(HTMLCanvasElement),!navigator.isCocoonJS&&window.SVGElement&&A(SVGElement),g(window),g(window.HTMLElement||window.Element),g(document),navigator.isCocoonJS||(g(HTMLBodyElement),g(HTMLDivElement),g(HTMLImageElement),g(HTMLUListElement),g(HTMLAnchorElement),g(HTMLLIElement),g(HTMLTableElement),window.HTMLSpanElement&&g(HTMLSpanElement)),window.HTMLCanvasElement&&g(HTMLCanvasElement),!navigator.isCocoonJS&&window.SVGElement&&g(SVGElement);var w=!1,k=-1;!function(){window.MSPointerEvent?e(function(t){return N("MS",t)},p):(e(v,u),void 0!==window.ontouchstart&&(window.addEventListener("touchstart",function(i){for(var h=0;h<i.changedTouches.length;++h){var e=i.changedTouches[h];c[e.identifier]=e.target,f("pointerover",e,e.target,i,!0),s(e.target,null,function(t){y("pointerenter",e,t,i,!1)}),f("pointerdown",e,e.target,i,!0)}t()}),window.addEventListener("touchend",function(i){for(var s=0;s<i.changedTouches.length;++s){var e=i.changedTouches[s],o=c[e.identifier];f("pointerup",e,o,i,!0),f("pointerout",e,o,i,!0),h(o,null,function(t){y("pointerleave",e,t,i,!1)})}t()}),window.addEventListener("touchmove",function(i){for(var e=0;e<i.changedTouches.length;++e){var o=i.changedTouches[e],n=document.elementFromPoint(o.clientX,o.clientY),a=c[o.identifier];if(a&&m(a)===!0&&i.preventDefault(),f("pointermove",o,a,i,!0),!navigator.isCocoonJS){var n=document.elementFromPoint(o.clientX,o.clientY);if(a===n)continue;a&&(f("pointerout",o,a,i,!0,n),a.contains(n)||h(a,n,function(t){y("pointerleave",o,t,i,!1,n)})),n&&(f("pointerover",o,n,i,!0,a),n.contains(a)||s(n,a,function(t){y("pointerenter",o,t,i,!1,a)})),c[o.identifier]=n}}t()}),window.addEventListener("touchcancel",function(t){for(var i=0;i<t.changedTouches.length;++i){var s=t.changedTouches[i];f("pointercancel",s,c[s.identifier],t,!0)}})))}(),void 0===navigator.pointerEnabled&&(navigator.pointerEnabled=!0,navigator.msPointerEnabled&&(navigator.maxTouchPoints=navigator.msMaxTouchPoints))}}(),function(){window.PointerEvent||document.styleSheets&&document.addEventListener&&document.addEventListener("DOMContentLoaded",function(){if(void 0===document.body.style.touchAction){var i=new RegExp(".+?{.*?}","m"),s=new RegExp(".+?{","m"),h=function(t){var h=i.exec(t);if(h){var e=h[0];t=t.replace(e,"").trim();var o=s.exec(e)[0].replace("{","").trim();if(e.replace(/\s/g,"").indexOf("touch-action:none")!==-1)for(var n=document.querySelectorAll(o),a=0;a<n.length;a++){var r=n[a];void 0!==r.style.msTouchAction?r.style.msTouchAction="none":r.handjs_forcePreventDefault=!0}return t}},e=function i(s){if(window.setImmediate)s&&t(i,h(s));else for(;s;)s=h(s)};try{for(var o=0;o<document.styleSheets.length;o++){var n=document.styleSheets[o];if(null!=n.href){var a=new XMLHttpRequest;a.open("get",n.href),a.send();e(a.responseText.replace(/(\n|\r)/g,""))}}}catch(t){}for(var r=document.getElementsByTagName("style"),o=0;o<r.length;o++){e(r[o].innerHTML.replace(/(\n|\r)/g,"").trim())}}},!1)}()}).call(i,s(6).setImmediate)},function(t,i,s){"use strict";function h(t,i,s){return{a:t,b:i,c:s}}function e(t,i,s,h){var e=.5*(-s.y*h.x+i.y*(-s.x+h.x)+i.x*(s.y-h.y)+s.x*h.y),o=e<0?-1:1,n=(i.y*h.x-i.x*h.y+(h.y-i.y)*t.x+(i.x-h.x)*t.y)*o,a=(i.x*s.y-i.y*s.x+(i.y-s.y)*t.x+(s.x-i.x)*t.y)*o;return n>0&&a>0&&n+a<2*e*o}function o(t,i){return{x:t,y:i}}var n,a={REVISION:"1.2",nextID:0,proxyID:0,BR_NULL:0,BR_BRUTE_FORCE:1,BR_SWEEP_AND_PRUNE:2,BR_BOUNDING_VOLUME_TREE:3,BODY_NULL:0,BODY_DYNAMIC:1,BODY_STATIC:2,SHAPE_NULL:0,SHAPE_SPHERE:1,SHAPE_BOX:2,SHAPE_CYLINDER:3,SHAPE_TETRA:4,JOINT_NULL:0,JOINT_DISTANCE:1,JOINT_BALL_AND_SOCKET:2,JOINT_HINGE:3,JOINT_WHEEL:4,JOINT_SLIDER:5,JOINT_PRISMATIC:6,WORLD_SCALE:100,INV_SCALE:.01,AABB_PROX:.005,sqrt:Math.sqrt,abs:Math.abs,floor:Math.floor,cos:Math.cos,sin:Math.sin,acos:Math.acos,asin:Math.asin,atan2:Math.atan2,round:Math.round,pow:Math.pow,max:Math.max,min:Math.min,random:Math.random,lerp:function(t,i,s){return t+(i-t)*s},rand:function(t,i){return a.lerp(t,i,a.random())},randInt:function(t,i,s){return 1*a.lerp(t,i,a.random()).toFixed(s||0)},int:function(t){return~~t},fix:function(t,i){return t.toFixed(i||3,10)},clamp:function(t,i,s){return a.max(i,a.min(s,t))},degtorad:.017453292519943295,radtodeg:57.29577951308232,PI:3.141592653589793,TwoPI:6.283185307179586,PI90:1.570796326794896,PI270:4.712388980384689,CustomError:null,Error:function(t,i){null==a.CustomError?console.error(t,i):a.CustomError.innerHTML+=t+" - "+i+"<br>"}};n||(n="undefined"!=typeof Float32Array?Float32Array:Array);try{!function(t){var i,s=["now","webkitNow","msNow","mozNow"];if(t.performance)for(var h=0;h<s.length;++h){var e=s[h];if(t.performance[e]){i=function(){return t.performance[e]()};break}}i||(i=Date.now),a.now=i}(window)}catch(t){a.now=function(){return 0}}a.World=function(t,i,s,h){switch(this.timeStep=t||.01666,this.numIterations=s||8,i||2){case 1:this.broadPhase=new a.BruteForceBroadPhase;break;case 2:default:this.broadPhase=new a.SAPBroadPhase;break;case 3:this.broadPhase=new a.DBVTBroadPhase}this.performance=null,this.isNoStat=h||!1,this.isNoStat||(this.performance=new a.Performance(this)),this.enableRandomizer=!0,this.rigidBodies=null,this.numRigidBodies=0,this.contacts=null,this.unusedContacts=null,this.numContacts=0,this.numContactPoints=0,this.joints=null,this.numJoints=0,this.numIslands=0,this.gravity=new a.Vec3(0,-9.80665,0);var e=5;this.detectors=[],this.detectors.length=e;for(var o=e;o--;)this.detectors[o]=[],this.detectors[o].length=e;this.detectors[a.SHAPE_SPHERE][a.SHAPE_SPHERE]=new a.SphereSphereCollisionDetector,this.detectors[a.SHAPE_SPHERE][a.SHAPE_BOX]=new a.SphereBoxCollisionDetector(!1),this.detectors[a.SHAPE_BOX][a.SHAPE_SPHERE]=new a.SphereBoxCollisionDetector(!0),this.detectors[a.SHAPE_BOX][a.SHAPE_BOX]=new a.BoxBoxCollisionDetector,this.detectors[a.SHAPE_CYLINDER][a.SHAPE_CYLINDER]=new a.CylinderCylinderCollisionDetector,this.detectors[a.SHAPE_CYLINDER][a.SHAPE_BOX]=new a.BoxCylinderCollisionDetector(!0),this.detectors[a.SHAPE_BOX][a.SHAPE_CYLINDER]=new a.BoxCylinderCollisionDetector(!1),this.detectors[a.SHAPE_CYLINDER][a.SHAPE_SPHERE]=new a.SphereCylinderCollisionDetector(!0),this.detectors[a.SHAPE_SPHERE][a.SHAPE_CYLINDER]=new a.SphereCylinderCollisionDetector(!1),this.detectors[a.SHAPE_TETRA][a.SHAPE_TETRA]=new a.TetraTetraCollisionDetector,this.randX=65535,this.randA=98765,this.randB=123456789,this.islandRigidBodies=[],this.islandStack=[],this.islandConstraints=[]},a.World.prototype={constructor:a.World,clear:function(){for(this.randX=65535;null!==this.joints;)this.removeJoint(this.joints);for(;null!==this.contacts;)this.removeContact(this.contacts);for(;null!==this.rigidBodies;)this.removeRigidBody(this.rigidBodies);a.nextID=0,a.proxyID=0},addRigidBody:function(t){t.parent&&a.Error("World","It is not possible to be added to more than one world one of the rigid body"),t.parent=this,t.awake();for(var i=t.shapes;null!==i;i=i.next)this.addShape(i);null!==this.rigidBodies&&((this.rigidBodies.prev=t).next=this.rigidBodies),this.rigidBodies=t,this.numRigidBodies++},removeRigidBody:function(t){var i=t;if(i.parent===this){i.awake();for(var s=i.jointLink;null!=s;){var h=s.joint;s=s.next,this.removeJoint(h)}for(var e=t.shapes;null!==e;e=e.next)this.removeShape(e);var o=i.prev,n=i.next;null!==o&&(o.next=n),null!==n&&(n.prev=o),this.rigidBodies==i&&(this.rigidBodies=n),i.prev=null,i.next=null,i.parent=null,this.numRigidBodies--}},getByName:function(t){for(var i=null,s=this.rigidBodies;null!==s;)" "!==s.name&&s.name===t&&(i=s),s=s.next;for(var h=this.joints;null!==h;)""!==h.name&&h.name===t&&(i=h),h=h.next;return i},addShape:function(t){t.parent&&t.parent.parent||a.Error("World","It is not possible to be added alone to shape world"),t.proxy=this.broadPhase.createProxy(t),t.updateProxy(),this.broadPhase.addProxy(t.proxy)},removeShape:function(t){this.broadPhase.removeProxy(t.proxy),t.proxy=null},addJoint:function(t){t.parent&&a.Error("World","It is not possible to be added to more than one world one of the joint"),null!=this.joints&&((this.joints.prev=t).next=this.joints),this.joints=t,t.parent=this,this.numJoints++,t.awake(),t.attach()},removeJoint:function(t){var i=t,s=i.prev,h=i.next;null!==s&&(s.next=h),null!==h&&(h.prev=s),this.joints==i&&(this.joints=h),i.prev=null,i.next=null,this.numJoints--,i.awake(),i.detach(),i.parent=null},worldscale:function(t){a.WORLD_SCALE=t||100,a.INV_SCALE=1/a.WORLD_SCALE},addContact:function(t,i){var s;null!==this.unusedContacts?(s=this.unusedContacts,this.unusedContacts=this.unusedContacts.next):s=new a.Contact,s.attach(t,i),s.detector=this.detectors[t.type][i.type],this.contacts&&((this.contacts.prev=s).next=this.contacts),this.contacts=s,this.numContacts++},removeContact:function(t){var i=t.prev,s=t.next;s&&(s.prev=i),i&&(i.next=s),this.contacts==t&&(this.contacts=s),t.prev=null,t.next=null,t.detach(),t.next=this.unusedContacts,this.unusedContacts=t,this.numContacts--},checkContact:function(t,i){for(var s,h,e=this.contacts;null!==e;){if(s=e.body1.name||" ",h=e.body2.name||" ",s==t&&h==i||h==t&&s==i)return!!e.touching;e=e.next}return!1},callSleep:function(t){return!!t.allowSleep&&(!(t.linearVelocity.lengthSq()>.04)&&!(t.angularVelocity.lengthSq()>.25))},step:function(){var t,i,s,h,e=!this.isNoStat;e&&(t=a.now());for(var o=this.rigidBodies;null!==o;)o.addedToIsland=!1,o.sleeping&&(o.linearVelocity.testZero()||o.angularVelocity.testZero()||o.position.testDiff(o.sleepPosition)||o.orientation.testDiff(o.sleepOrientation))&&o.awake(),o=o.next;e&&(i=a.now()),this.broadPhase.detectPairs();for(var n=this.broadPhase.pairs,r=this.broadPhase.numPairs;r--;){var l,c,m=n[r];m.shape1.id<m.shape2.id?(l=m.shape1,c=m.shape2):(l=m.shape2,c=m.shape1);var p;p=l.numContacts<c.numContacts?l.contactLink:c.contactLink;for(var u=!1;p;){var y=p.contact;if(y.shape1==l&&y.shape2==c){y.persisting=!0,u=!0;break}p=p.next}u||this.addContact(l,c)}for(e&&(s=a.now(),this.performance.broadPhaseTime=s-i),this.numContactPoints=0,y=this.contacts;null!==y;)if(y.persisting||!y.shape1.aabb.intersectTest(y.shape2.aabb)){var x=y.body1,d=y.body2;(x.isDynamic&&!x.sleeping||d.isDynamic&&!d.sleeping)&&y.updateManifold(),this.numContactPoints+=y.manifold.numPoints,y.persisting=!1,y.constraint.addedToIsland=!1,y=y.next}else{var f=y.next;this.removeContact(y),y=f}e&&(h=a.now(),this.performance.narrowPhaseTime=h-s);var v,N,b=1/this.timeStep;for(v=this.joints;null!==v;v=v.next)v.addedToIsland=!1;this.islandRigidBodies=[],this.islandConstraints=[],this.islandStack=[],i=a.now(),this.numIslands=0;for(var z=this.rigidBodies;null!==z;z=z.next)if(!(z.addedToIsland||z.isStatic||z.sleeping))if(z.isLonely())z.isDynamic&&z.linearVelocity.addTime(this.gravity,this.timeStep),this.callSleep(z)?(z.sleepTime+=this.timeStep,z.sleepTime>.5?z.sleep():z.updatePosition(this.timeStep)):(z.sleepTime=0,z.updatePosition(this.timeStep)),this.numIslands++;else{var A=0,g=0,w=1;this.islandStack[0]=z,z.addedToIsland=!0;do{if(o=this.islandStack[--w],this.islandStack[w]=null,o.sleeping=!1,this.islandRigidBodies[A++]=o,!o.isStatic){for(var k=o.contactLink;null!==k;k=k.next){var y=k.contact;if(N=y.constraint,!N.addedToIsland&&y.touching){this.islandConstraints[g++]=N,N.addedToIsland=!0;var f=k.body;f.addedToIsland||(this.islandStack[w++]=f,f.addedToIsland=!0)}}for(var S=o.jointLink;null!==S;S=S.next)N=S.joint,N.addedToIsland||(this.islandConstraints[g++]=N,N.addedToIsland=!0,f=S.body,!f.addedToIsland&&f.isDynamic&&(this.islandStack[w++]=f,f.addedToIsland=!0))}}while(0!=w);for(var P=(new a.Vec3).addTime(this.gravity,this.timeStep),L=A;L--;)o=this.islandRigidBodies[L],o.isDynamic&&o.linearVelocity.addEqual(P);if(this.enableRandomizer)for(L=g;L--;)if(0!==L){var I=(this.randX=this.randX*this.randA+this.randB&2147483647)/2147483648*L|0;N=this.islandConstraints[L],this.islandConstraints[L]=this.islandConstraints[I],this.islandConstraints[I]=N}for(L=g;L--;)this.islandConstraints[L].preSolve(this.timeStep,b);for(var M=this.numIterations;M--;)for(L=g;L--;)this.islandConstraints[L].solve();for(L=g;L--;)this.islandConstraints[L].postSolve(),this.islandConstraints[L]=null;var T=10;for(L=A;L--;)o=this.islandRigidBodies[L],this.callSleep(o)?(o.sleepTime+=this.timeStep,o.sleepTime<T&&(T=o.sleepTime)):(o.sleepTime=0,T=0);if(T>.5)for(L=A;L--;)this.islandRigidBodies[L].sleep(),this.islandRigidBodies[L]=null;else for(L=A;L--;)this.islandRigidBodies[L].updatePosition(this.timeStep),this.islandRigidBodies[L]=null;this.numIslands++}e&&(s=a.now(),this.performance.solvingTime=s-i,s=a.now(),this.performance.upfps(),this.performance.totalTime=s-t)}},a.RigidBody=function(t,i,s,h,e,o,n){this.name=" ",this.MAX_SHAPES=64,this.prev=null,this.next=null,this.type=a.BODY_NULL,this.massInfo=new a.MassInfo,this.position=new a.Vec3(t,i,s),this.orientation=this.rotationAxisToQuad(h||0,e||0,o||0,n||0),this.newPosition=new a.Vec3,this.controlPos=!1,this.newOrientation=new a.Quat,this.newRotation=new a.Vec3,this.currentRotation=new a.Vec3,this.controlRot=!1,this.controlRotInTime=!1,this.linearVelocity=new a.Vec3,this.angularVelocity=new a.Vec3,this.matrix=new a.Mat44,this.parent=null,this.contactLink=null,this.numContacts=0,this.shapes=null,this.numShapes=0,this.jointLink=null,this.numJoints=0,this.sleepPosition=new a.Vec3,this.sleepOrientation=new a.Quat,this.isStatic=!1,this.isDynamic=!1,this.rotation=new a.Mat33,this.mass=NaN,this.inverseMass=NaN,this.inverseInertia=new a.Mat33,this.localInertia=new a.Mat33,this.inverseLocalInertia=new a.Mat33,this.addedToIsland=!1,this.allowSleep=!0,this.sleepTime=0,this.sleeping=!1},a.RigidBody.prototype={constructor:a.RigidBody,addShape:function(t){t.parent&&a.Error("RigidBody","It is not possible that you add to the multi-rigid body the shape of one"),null!=this.shapes&&((this.shapes.prev=t).next=this.shapes),this.shapes=t,t.parent=this,this.parent&&this.parent.addShape(t),this.numShapes++},removeShape:function(t){var i=t;if(i.parent==this){var s=i.prev,h=i.next;null!=s&&(s.next=h),null!=h&&(h.prev=s),this.shapes==i&&(this.shapes=h),i.prev=null,i.next=null,i.parent=null,this.parent&&this.parent.removeShape(i),this.numShapes--}},remove:function(){this.dispose()},dispose:function(){this.parent.removeRigidBody(this)},checkContact:function(t){this.parent.checkContact(this.name,t)},setupMass:function(t,i){var s=void 0===i||i;this.type=t||a.BODY_DYNAMIC,this.isDynamic=this.type==a.BODY_DYNAMIC,this.isStatic=this.type==a.BODY_STATIC,this.mass=0,this.localInertia.set(0,0,0,0,0,0,0,0,0);for(var h=this.localInertia.elements,e=new a.Mat33,o=new a.Vec3,n=this.shapes;null!=n;n=n.next){n.calculateMassInfo(this.massInfo);var r=this.massInfo.mass,l=n.relativePosition.x,c=n.relativePosition.y,m=n.relativePosition.z;o.addScale(n.relativePosition,r),this.mass+=r,this.rotateInertia(n.relativeRotation,this.massInfo.inertia,e),this.localInertia.addEqual(e),h[0]+=r*(c*c+m*m),h[4]+=r*(l*l+m*m),h[8]+=r*(l*l+c*c);var p=r*l*c,u=r*c*m,y=r*m*l;h[1]-=p,h[3]-=p,h[2]-=u,h[6]-=u,h[5]-=y,h[7]-=y}if(this.inverseMass=1/this.mass,o.scaleEqual(this.inverseMass),s){for(this.position.addEqual(o),n=this.shapes;null!=n;n=n.next)n.relativePosition.subEqual(o);l=o.x,c=o.y,m=o.z,h[0]-=this.mass*(c*c+m*m),h[4]-=this.mass*(l*l+m*m),h[8]-=this.mass*(l*l+c*c),p=this.mass*l*c,u=this.mass*c*m,y=this.mass*m*l,h[1]+=p,h[3]+=p,h[2]+=u,h[6]+=u,h[5]+=y,h[7]+=y}this.inverseLocalInertia.invert(this.localInertia),this.type==a.BODY_STATIC&&(this.inverseMass=0,this.inverseLocalInertia.set(0,0,0,0,0,0,0,0,0)),this.syncShapes(),this.awake()},awake:function(){if(this.allowSleep&&this.sleeping){this.sleeping=!1,this.sleepTime=0;for(var t=this.contactLink;null!=t;)t.body.sleepTime=0,t.body.sleeping=!1,t=t.next;for(var i=this.jointLink;null!=i;)i.body.sleepTime=0,i.body.sleeping=!1,i=i.next;for(var s=this.shapes;null!=s;s=s.next)s.updateProxy()}},sleep:function(){if(this.allowSleep&&!this.sleeping){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.sleepPosition.copy(this.position),this.sleepOrientation.copy(this.orientation),this.sleepTime=0,this.sleeping=!0;for(var t=this.shapes;null!=t;t=t.next)t.updateProxy()}},isLonely:function(){return 0==this.numJoints&&0==this.numContacts},updatePosition:function(t){switch(this.type){case a.BODY_STATIC:this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.controlPos&&(this.position.copy(this.newPosition),this.controlPos=!1),this.controlRot&&(this.orientation.copy(this.newOrientation),this.controlRot=!1);break;case a.BODY_DYNAMIC:this.controlPos&&(this.angularVelocity.set(0,0,0),this.linearVelocity.set(0,0,0),this.linearVelocity.x=(this.newPosition.x-this.position.x)/t,this.linearVelocity.y=(this.newPosition.y-this.position.y)/t,this.linearVelocity.z=(this.newPosition.z-this.position.z)/t,this.controlPos=!1),this.controlRot&&(this.angularVelocity.set(0,0,0),this.orientation.copy(this.newOrientation),this.controlRot=!1),this.position.addTime(this.linearVelocity,t),this.orientation.addTime(this.angularVelocity,t);break;default:a.Error("RigidBody","Invalid type.")}this.syncShapes()},rotateInertia:function(t,i,s){var h=t.elements,e=i.elements,o=h[0],n=h[3],a=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],u=h[8],y=e[0],x=e[3],d=e[6],f=e[1],v=e[4],N=e[7],b=e[2],z=e[5],A=e[8],g=o*y+r*x+m*d,w=o*f+r*v+m*N,k=o*b+r*z+m*A,S=n*y+l*x+p*d,P=n*f+l*v+p*N,L=n*b+l*z+p*A,I=a*y+c*x+u*d,M=a*f+c*v+u*N,T=a*b+c*z+u*A,V=s.elements;V[0]=g*o+w*r+k*m,V[1]=g*n+w*l+k*p,V[2]=g*a+w*c+k*u,V[3]=S*o+P*r+L*m,V[4]=S*n+P*l+L*p,V[5]=S*a+P*c+L*u,V[6]=I*o+M*r+T*m,V[7]=I*n+M*l+T*p,V[8]=I*a+M*c+T*u},syncShapes:function(){var t=this.orientation.s,i=this.orientation.x,s=this.orientation.y,h=this.orientation.z,e=2*i,o=2*s,n=2*h,a=i*e,r=s*o,l=h*n,c=i*o,m=s*n,p=i*n,u=t*e,y=t*o,x=t*n,d=this.rotation.elements;d[0]=1-r-l,d[1]=c-x,d[2]=p+y,d[3]=c+x,d[4]=1-a-l,d[5]=m-u,d[6]=p-y,d[7]=m+u,d[8]=1-a-r,this.rotateInertia(this.rotation,this.inverseLocalInertia,this.inverseInertia);for(var f=this.shapes;null!=f;f=f.next)f.position.mul(this.position,f.relativePosition,this.rotation),f.rotation.mul(this.rotation,f.relativeRotation),f.updateProxy()},applyImpulse:function(t,i){this.linearVelocity.addScale(i,this.inverseMass);var s=new a.Vec3;s.sub(t,this.position).cross(s,i).mulMat(this.inverseInertia,s),this.angularVelocity.addEqual(s)},rotationVectToQuad:function(t){var i=a.EulerToAxis(t.x*a.degtorad,t.y*a.degtorad,t.z*a.degtorad);return this.rotationAxisToQuad(i[0],i[1],i[2],i[3])},rotationAxisToQuad:function(t,i,s,h){var e=i*i+s*s+h*h;e>0&&(e=1/a.sqrt(e),i*=e,s*=e,h*=e);var o=a.sin(.5*t),n=a.cos(.5*t);return new a.Quat(n,o*i,o*s,o*h)},setPosition:function(t){this.newPosition.copy(t).multiplyScalar(a.INV_SCALE),this.controlPos=!0},setQuaternion:function(t){this.newOrientation.set(t.x,t.y,t.z,t.w),this.controlRot=!0},setRotation:function(t){this.newOrientation=this.rotationVectToQuad(t),this.controlRot=!0},resetPosition:function(t,i,s){this.linearVelocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.position.set(t,i,s).multiplyScalar(a.INV_SCALE),this.awake()},resetQuaternion:function(t){this.angularVelocity.set(0,0,0),this.orientation=new a.Quat(t.w,t.x,t.y,t.z),this.awake()},resetRotation:function(t,i,s){this.angularVelocity.set(0,0,0),this.orientation=this.rotationVectToQuad(new a.Vec3(t,i,s)),this.awake()},getPosition:function(){return(new a.Vec3).scale(this.position,a.WORLD_SCALE)},getRotation:function(){return(new a.Euler).setFromRotationMatrix(this.rotation)},getQuaternion:function(){return(new a.Quaternion).setFromRotationMatrix(this.rotation)},getMatrix:function(){var t,i,s=this.matrix.elements;return this.sleeping?s[15]=1:(t=this.rotation.elements,s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=0,s[4]=t[1],s[5]=t[4],s[6]=t[7],s[7]=0,s[8]=t[2],s[9]=t[5],s[10]=t[8],s[11]=0,i=this.position,s[12]=i.x*a.WORLD_SCALE,s[13]=i.y*a.WORLD_SCALE,s[14]=i.z*a.WORLD_SCALE,s[15]=0),s}},a.Body=function(t){var i=t||{};i.world&&(void 0===i.type&&(i.type="box"),this.name=i.name||"",this.body=i.world.add(i))},a.Body.prototype={constructor:a.Body,setPosition:function(t){this.body.setPosition(t)},setQuaternion:function(t){this.body.setQuaternion(t)},setRotation:function(t){this.body.setRotation(t)},getPosition:function(){return this.body.getPosition()},getRotation:function(){return this.body.getRotation()},getQuaternion:function(){return this.body.getQuaternion()},getMatrix:function(){return this.body.getMatrix()},getSleep:function(){return this.body.sleeping},resetPosition:function(t,i,s){this.body.resetPosition(t,i,s)},resetRotation:function(t,i,s){this.body.resetRotation(t,i,s)},awake:function(){this.body.awake()},remove:function(){this.body.dispose()},checkContact:function(t){this.body.checkContact(t)}},a.Link=function(t){var i=t||{};i.world&&(void 0===i.type&&(i.type="jointHinge"),this.name=i.name||"",this.joint=i.world.add(i))},a.Link.prototype={constructor:a.Link,getPosition:function(){return this.joint.getPosition()},getMatrix:function(){return this.joint.getMatrix()},remove:function(){this.joint.dispose()},awake:function(){this.joint.awake()}},a.Dictionary=function(){this.data={},this.keys=[]},a.Dictionary.prototype={constructor:a.Dictionary,set:function(t){var i=t.id;this.get[i]||this.keys.push(i),this.data[i]=t},get:function(t){return this.data[t]},del:function(t){var i=this.keys,s=i.indexOf(t.id);s>-1&&(delete this.data[i[s]],i.splice(s,1))},reset:function(){for(var t,i=this.data,s=this.keys;s.length>0;)t=s.pop(),delete i[t]}},a.Performance=function(t){this.parent=t,this.infos=new n(13),this.f=[0,0,0],this.types=["None","BruteForce","Sweep & Prune","Bounding Volume Tree"],this.broadPhase=this.types[this.parent.broadPhase.types],this.version=a.REVISION,this.fps=0,this.broadPhaseTime=0,this.narrowPhaseTime=0,this.solvingTime=0,this.totalTime=0},a.Performance.prototype={upfps:function(){this.f[1]=Date.now(),this.f[1]-1e3>this.f[0]&&(this.f[0]=this.f[1],this.fps=this.f[2],this.f[2]=0),this.f[2]++},updatingTime:function(){return a.fix(this.totalTime-(this.broadPhaseTime+this.narrowPhaseTime+this.solvingTime))},show:function(){return["Oimo.js "+this.version+"<br>",this.broadPhase+"<br><br>","FPS: "+this.fps+" fps<br><br>","rigidbody "+this.parent.numRigidBodies+"<br>","contact &nbsp;&nbsp;"+this.parent.numContacts+"<br>","ct-point &nbsp;"+this.parent.numContactPoints+"<br>","paircheck "+this.parent.broadPhase.numPairChecks+"<br>","island &nbsp;&nbsp;&nbsp;"+this.parent.numIslands+"<br><br>","Time in milliseconde<br><br>","broad-phase &nbsp;"+a.fix(this.broadPhaseTime)+"<br>","narrow-phase "+a.fix(this.narrowPhaseTime)+"<br>","solving &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+a.fix(this.solvingTime)+"<br>","total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+a.fix(this.totalTime)+"<br>","updating &nbsp;&nbsp;&nbsp;&nbsp;"+this.updatingTime()+"<br>"].join("\n")},toArray:function(){return this.infos[0]=this.parent.broadPhase.types,this.infos[1]=this.parent.numRigidBodies,this.infos[2]=this.parent.numContacts,this.infos[3]=this.parent.broadPhase.numPairChecks,this.infos[4]=this.parent.numContactPoints,this.infos[5]=this.parent.numIslands,this.infos[6]=this.broadPhaseTime,this.infos[7]=this.narrowPhaseTime,this.infos[8]=this.solvingTime,this.infos[9]=this.updatingTime(),this.infos[10]=this.totalTime,this.infos[11]=this.fps,this.infos}},a.Mat44=function(t,i,s,h,e,o,a,r,l,c,m,p,u,y,x,d){this.elements=new n(16);var f=this.elements;f[0]=void 0!==t?t:1,f[4]=i||0,f[8]=s||0,f[12]=h||0,f[1]=e||0,f[5]=void 0!==o?o:1,f[9]=a||0,f[13]=r||0,f[2]=l||0,f[6]=c||0,f[10]=void 0!==m?m:1,f[14]=p||0,f[3]=u||0,f[7]=y||0,f[11]=x||0,f[15]=void 0!==d?d:1},a.Mat44.prototype={constructor:a.Mat44,set:function(t,i,s,h,e,o,n,a,r,l,c,m,p,u,y,x){var d=this.elements;return d[0]=t,d[4]=i,d[8]=s,d[12]=h,d[1]=e,d[5]=o,d[9]=n,d[13]=a,d[2]=r,d[6]=l,d[10]=c,d[14]=m,d[3]=p,d[7]=u,d[11]=y,d[15]=x,this}},a.Mat33=function(t,i,s,h,e,o,a,r,l){this.elements=new n(9);this.elements;this.init(void 0!==t?t:1,i||0,s||0,h||0,void 0!==e?e:1,o||0,a||0,r||0,void 0!==l?l:1)},a.Mat33.prototype={constructor:a.Mat33,set:function(t,i,s,h,e,o,n,a,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=n,l[7]=a,l[8]=r,this},init:function(t,i,s,h,e,o,n,a,r){var l=this.elements;return l[0]=t,l[1]=i,l[2]=s,l[3]=h,l[4]=e,l[5]=o,l[6]=n,l[7]=a,l[8]=r,this},multiply:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},add:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]+e[0],s[1]=h[1]+e[1],s[2]=h[2]+e[2],s[3]=h[3]+e[3],s[4]=h[4]+e[4],s[5]=h[5]+e[5],s[6]=h[6]+e[6],s[7]=h[7]+e[7],s[8]=h[8]+e[8],this},addEqual:function(t){var i=this.elements,s=t.elements;return i[0]+=s[0],i[1]+=s[1],i[2]+=s[2],i[3]+=s[3],i[4]+=s[4],i[5]+=s[5],i[6]+=s[6],i[7]+=s[7],i[8]+=s[8],this},sub:function(t,i){var s=this.elements,h=t.elements,e=i.elements;return s[0]=h[0]-e[0],s[1]=h[1]-e[1],s[2]=h[2]-e[2],s[3]=h[3]-e[3],s[4]=h[4]-e[4],s[5]=h[5]-e[5],s[6]=h[6]-e[6],s[7]=h[7]-e[7],s[8]=h[8]-e[8],this},subEqual:function(t){var i=this.elements,s=t.elements;return i[0]-=s[0],i[1]-=s[1],i[2]-=s[2],i[3]-=s[3],i[4]-=s[4],i[5]-=s[5],i[6]-=s[6],i[7]-=s[7],i[8]-=s[8],this},scale:function(t,i){var s=this.elements,h=t.elements;return s[0]=h[0]*i,s[1]=h[1]*i,s[2]=h[2]*i,s[3]=h[3]*i,s[4]=h[4]*i,s[5]=h[5]*i,s[6]=h[6]*i,s[7]=h[7]*i,s[8]=h[8]*i,this},scaleEqual:function(t){var i=this.elements;return i[0]*=t,i[1]*=t,i[2]*=t,i[3]*=t,i[4]*=t,i[5]*=t,i[6]*=t,i[7]*=t,i[8]*=t,this},mul:function(t,i){var s=this.elements,h=t.elements,e=i.elements,o=h[0],n=h[3],a=h[6],r=h[1],l=h[4],c=h[7],m=h[2],p=h[5],u=h[8],y=e[0],x=e[3],d=e[6],f=e[1],v=e[4],N=e[7],b=e[2],z=e[5],A=e[8];return s[0]=o*y+r*x+m*d,s[1]=o*f+r*v+m*N,s[2]=o*b+r*z+m*A,s[3]=n*y+l*x+p*d,s[4]=n*f+l*v+p*N,s[5]=n*b+l*z+p*A,s[6]=a*y+c*x+u*d,s[7]=a*f+c*v+u*N,s[8]=a*b+c*z+u*A,this},mulScale:function(t,i,s,h,e){var o=e||!1,n=this.elements,a=t.elements;return o?(n[0]=i*a[0],n[1]=i*a[1],n[2]=i*a[2],n[3]=s*a[3],n[4]=s*a[4],n[5]=s*a[5],n[6]=h*a[6],n[7]=h*a[7],n[8]=h*a[8]):(n[0]=a[0]*i,n[1]=a[1]*s,n[2]=a[2]*h,n[3]=a[3]*i,n[4]=a[4]*s,n[5]=a[5]*h,n[6]=a[6]*i,n[7]=a[7]*s,n[8]=a[8]*h),this},mulRotate:function(t,i,s,h,e,o){var n=o||!1,r=a.sin(i),l=a.cos(i),c=1-l,m=s*s*c+l,p=s*h*c-e*r,u=s*e*c+h*r,y=h*s*c+e*r,x=h*h*c+l,d=h*e*c-s*r,f=e*s*c-h*r,v=e*h*c+s*r,N=e*e*c+l,b=t.elements,z=b[0],A=b[3],g=b[6],w=b[1],k=b[4],S=b[7],P=b[2],L=b[5],I=b[8],M=this.elements;return n?(M[0]=m*z+p*A+u*g,M[1]=m*w+p*k+u*S,M[2]=m*P+p*L+u*I,M[3]=y*z+x*A+d*g,M[4]=y*w+x*k+d*S,M[5]=y*P+x*L+d*I,M[6]=f*z+v*A+N*g,M[7]=f*w+v*k+N*S,M[8]=f*P+v*L+N*I):(M[0]=z*m+w*y+P*f,M[1]=z*p+w*x+P*v,M[2]=z*u+w*d+P*N,M[3]=A*m+k*y+L*f,M[4]=A*p+k*x+L*v,M[5]=A*u+k*d+L*N,M[6]=g*m+S*y+I*f,M[7]=g*p+S*x+I*v,M[8]=g*u+S*d+I*N),this},transpose:function(t){var i=this.elements,s=t.elements;return i[0]=s[0],i[1]=s[3],i[2]=s[6],i[3]=s[1],i[4]=s[4],i[5]=s[7],i[6]=s[2],i[7]=s[5],i[8]=s[8],this},setQuat:function(t){var i=this.elements,s=2*t.x,h=2*t.y,e=2*t.z,o=t.x*s,n=t.y*h,a=t.z*e,r=t.x*h,l=t.y*e,c=t.x*e,m=t.s*s,p=t.s*h,u=t.s*e;return i[0]=1-n-a,i[1]=r-u,i[2]=c+p,i[3]=r+u,i[4]=1-o-a,i[5]=l-m,i[6]=c-p,i[7]=l+m,i[8]=1-o-n,this},invert:function(t){var i=this.elements,s=t.elements,h=s[0],e=s[3],o=s[6],n=s[1],a=s[4],r=s[7],l=s[2],c=s[5],m=s[8],p=a*m-r*c,u=r*l-n*m,y=n*c-a*l,x=h*p+e*u+o*y;return 0!=x&&(x=1/x),i[0]=x*p,i[1]=x*u,i[2]=x*y,i[3]=x*(c*o-e*m),i[4]=x*(h*m-l*o),i[5]=x*(l*e-h*c),i[6]=x*(e*r-a*o),i[7]=x*(n*o-h*r),i[8]=x*(h*a-n*e),this},toEuler:function(){function t(t){return a.min(a.max(t,-1),1)}var i=this.elements,s=i[0],h=i[3],e=i[6],o=(i[1],i[4]),n=i[7],r=(i[2],i[5]),l=i[8],c=new a.Vec3;new a.Quat;return c.y=a.asin(t(e)),a.abs(e)<.99999?(c.x=a.atan2(-n,l),c.z=a.atan2(-h,s)):(c.x=a.atan2(r,o),c.z=0),c},toString:function(){var t=this.elements;return"Mat33|"+t[0].toFixed(4)+", "+t[1].toFixed(4)+", "+t[2].toFixed(4)+"|\n     |"+t[3].toFixed(4)+", "+t[4].toFixed(4)+", "+t[5].toFixed(4)+"|\n     |"+t[6].toFixed(4)+", "+t[7].toFixed(4)+", "+t[8].toFixed(4)+"|"},multiplyScalar:function(t){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=t,i[4]*=t,i[7]*=t,i[2]*=t,i[5]*=t,i[8]*=t,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var i=t.elements;return this.set(i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]),this},fromArray:function(t){return this.elements.set(t),this},toArray:function(){var t=this.elements;return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}},a.Quat=function(t,i,s,h){this.s=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0},a.Quat.prototype={constructor:a.Quat,set:function(t,i,s,h){return this.x=t,this.y=i,this.z=s,this.s=h,this},init:function(t,i,s,h){return this.s=void 0!==t?t:1,this.x=i||0,this.y=s||0,this.z=h||0,this},add:function(t,i){return this.s=t.s+i.s,this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addTime:function(t,i){var s=t.x,h=t.y,e=t.z,o=this.s,n=this.x,r=this.y,l=this.z;i*=.5;var c=(-s*n-h*r-e*l)*i,m=(s*o+h*l-e*r)*i,p=(-s*l+h*o+e*n)*i,u=(s*r-h*n+e*o)*i;o+=c,n+=m,r+=p,l+=u;var y=1/a.sqrt(o*o+n*n+r*r+l*l);return this.s=o*y,this.x=n*y,this.y=r*y,this.z=l*y,this},sub:function(t,i){return this.s=t.s-i.s,this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},scale:function(t,i){return this.s=t.s*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},mul:function(t,i){var s=t.x,h=t.y,e=t.z,o=t.s,n=i.x,a=i.y,r=i.z,l=i.s;return this.x=s*l+o*n+h*r-e*a,this.y=h*l+o*a+e*n-s*r,this.z=e*l+o*r+s*a-h*n,this.s=o*l-s*n-h*a-e*r,this},arc:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,n=i.y,r=i.z,l=s*o+h*n+e*r;if(l==-1)return o=h*s-e*e,n=-e*h-s*s,r=s*e+h*h,l=1/a.sqrt(o*o+n*n+r*r),this.s=0,this.x=o*l,this.y=n*l,this.z=r*l,this;var c=h*r-e*n,m=e*o-s*r,p=s*n-h*o;return this.s=a.sqrt(.5*(1+l)),l=.5/this.s,this.x=c*l,this.y=m*l,this.z=p*l,this},normalize:function(t){var i=a.sqrt(t.s*t.s+t.x*t.x+t.y*t.y+t.z*t.z);return i>0&&(i=1/i),this.s=t.s*i,this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},invert:function(t){return this.s=t.s,this.x=-t.x,this.y=-t.y,this.z=-t.z,this},length:function(){return a.sqrt(this.s*this.s+this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.s=t.s,this.x=t.x,this.y=t.y,this.z=t.z,this},testDiff:function(t){return this.s!==t.s||this.x!==t.x||this.y!==t.y||this.z!==t.z},clone:function(t){return new a.Quat(this.s,this.x,this.y,this.z)},toString:function(){return"Quat["+this.s.toFixed(4)+", ("+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+")]"}},a.Quaternion=function(t,i,s,h){this.x=t||0,this.y=i||0,this.z=s||0,this.w=void 0!==h?h:1},a.Quaternion.prototype={constructor:a.Quaternion,setFromRotationMatrix:function(t){var i,s=t.elements,h=s[0],e=s[1],o=s[2],n=s[3],r=s[4],l=s[5],c=s[6],m=s[7],p=s[8],u=h+r+p;return u>0?(i=.5/a.sqrt(u+1),this.w=.25/i,this.x=(m-l)*i,this.y=(o-c)*i,this.z=(n-e)*i):h>r&&h>p?(i=2*a.sqrt(1+h-r-p),this.w=(m-l)/i,this.x=.25*i,this.y=(e+n)/i,this.z=(o+c)/i):r>p?(i=2*a.sqrt(1+r-h-p),this.w=(o-c)/i,this.x=(e+n)/i,this.y=.25*i,this.z=(l+m)/i):(i=2*a.sqrt(1+p-h-r),this.w=(n-e)/i,this.x=(o+c)/i,this.y=(l+m)/i,this.z=.25*i),this}},a.Vec3=function(t,i,s){this.x=t||0,this.y=i||0,this.z=s||0},a.Vec3.prototype={constructor:a.Vec3,init:function(t,i,s){return this.x=t||0,this.y=i||0,this.z=s||0,this},set:function(t,i,s){return this.x=t,this.y=i,this.z=s,this},add:function(t,i){return this.x=t.x+i.x,this.y=t.y+i.y,this.z=t.z+i.z,this},addEqual:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},addTime:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},sub:function(t,i){return this.x=t.x-i.x,this.y=t.y-i.y,this.z=t.z-i.z,this},subEqual:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},addScale:function(t,i){return this.x+=t.x*i,this.y+=t.y*i,this.z+=t.z*i,this},scale:function(t,i){return this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this},scaleEqual:function(t){return this.x*=t,this.y*=t,this.z*=t,this},cross:function(t,i){var s=t.x,h=t.y,e=t.z,o=i.x,n=i.y,a=i.z;return this.x=h*a-e*n,this.y=e*o-s*a,this.z=s*n-h*o,this},mul:function(t,i,s){var h=s.elements;return this.x=t.x+i.x*h[0]+i.y*h[1]+i.z*h[2],this.y=t.y+i.x*h[3]+i.y*h[4]+i.z*h[5],this.z=t.z+i.x*h[6]+i.y*h[7]+i.z*h[8],this},mulMat:function(t,i){var s=t.elements;return this.x=s[0]*i.x+s[1]*i.y+s[2]*i.z,this.y=s[3]*i.x+s[4]*i.y+s[5]*i.z,this.z=s[6]*i.x+s[7]*i.y+s[8]*i.z,this},normalize:function(t){var i=t.x,s=t.y,h=t.z,e=i*i+s*s+h*h;return e>0&&(e=1/a.sqrt(e),this.x=i*e,this.y=s*e,this.z=h*e),this},invert:function(t){return this.x=-t.x,this.y=-t.y,this.z=-t.z,this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return a.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},applyQuaternion:function(t){var i=this.x,s=this.y,h=this.z,e=t.x,o=t.y,n=t.z,a=t.s,r=a*i+o*h-n*s,l=a*s+n*i-e*h,c=a*h+e*s-o*i,m=-e*i-o*s-n*h;return this.x=r*a+m*-e+l*-n-c*-o,this.y=l*a+m*-o+c*-e-r*-n,this.z=c*a+m*-n+r*-o-l*-e,this},testZero:function(){return 0!==this.x||0!==this.y||0!==this.z},testDiff:function(t){return t.x!==this.x||t.y!==this.y||t.z!==this.z},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},clone:function(){return new this.constructor(this.x,this.y,this.z)},toString:function(){return"Vec3["+this.x.toFixed(4)+", "+this.y.toFixed(4)+", "+this.z.toFixed(4)+"]"},multiplyScalar:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this},divideScalar:function(t){return this.multiplyScalar(1/t)},norm:function(){return this.divideScalar(this.length())}},a.Euler=function(t,i,s,h){this._x=t||0,this._y=i||0,this._z=s||0,this._order=h||a.Euler.DefaultOrder},a.Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],a.Euler.DefaultOrder="XYZ",a.clamp=function(t,i,s){return t<i?i:t>s?s:t},a.Euler.prototype={constructor:a.Euler,_x:0,_y:0,_z:0,_order:a.Euler.DefaultOrder,get x(){return this._x},set x(t){this._x=t,this.onChangeCallback()},get y(){return this._y},set y(t){this._y=t,this.onChangeCallback()},get z(){return this._z},set z(t){this._z=t,this.onChangeCallback()},get order(){return this._order},set order(t){this._order=t,this.onChangeCallback()},set:function(t,i,s,h){return this._x=t,this._y=i,this._z=s,this._order=h||this._order,this.onChangeCallback(),this},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},setFromRotationMatrix:function(t,i){var s=a.clamp,h=t.elements,e=h[0],o=h[1],n=h[2],r=h[3],l=h[4],c=h[5],m=h[6],p=h[7],u=h[8];return i=i||this._order,"XYZ"===i?(this._y=a.asin(s(n,-1,1)),a.abs(n)<.99999?(this._x=a.atan2(-c,u),this._z=a.atan2(-o,e)):(this._x=a.atan2(p,l),this._z=0)):"YXZ"===i?(this._x=a.asin(-s(c,-1,1)),a.abs(c)<.99999?(this._y=a.atan2(n,u),this._z=a.atan2(r,l)):(this._y=a.atan2(-m,e),this._z=0)):"ZXY"===i?(this._x=a.asin(s(p,-1,1)),a.abs(p)<.99999?(this._y=a.atan2(-m,u),this._z=a.atan2(-o,l)):(this._y=0,this._z=a.atan2(r,e))):"ZYX"===i?(this._y=a.asin(-s(m,-1,1)),a.abs(m)<.99999?(this._x=a.atan2(p,u),this._z=a.atan2(r,e)):(this._x=0,this._z=a.atan2(-o,l))):"YZX"===i?(this._z=a.asin(s(r,-1,1)),a.abs(r)<.99999?(this._x=a.atan2(-c,l),this._y=a.atan2(-m,e)):(this._x=0,this._y=a.atan2(n,u))):"XZY"===i?(this._z=a.asin(-s(o,-1,1)),a.abs(o)<.99999?(this._x=a.atan2(p,l),this._y=a.atan2(n,e)):(this._x=a.atan2(-c,u),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+i),this._order=i,this.onChangeCallback(),this},setFromQuaternion:function(t,i,s){var h=a.clamp,e=t.x*t.x,o=t.y*t.y,n=t.z*t.z,r=t.s*t.s;return i=i||this._order,"XYZ"===i?(this._x=a.atan2(2*(t.x*t.s-t.y*t.z),r-e-o+n),this._y=a.asin(h(2*(t.x*t.z+t.y*t.s),-1,1)),this._z=a.atan2(2*(t.z*t.s-t.x*t.y),r+e-o-n)):"YXZ"===i?(this._x=a.asin(h(2*(t.x*t.s-t.y*t.z),-1,1)),this._y=a.atan2(2*(t.x*t.z+t.y*t.s),r-e-o+n),this._z=a.atan2(2*(t.x*t.y+t.z*t.s),r-e+o-n)):"ZXY"===i?(this._x=a.asin(h(2*(t.x*t.s+t.y*t.z),-1,1)),this._y=a.atan2(2*(t.y*t.s-t.z*t.x),r-e-o+n),this._z=a.atan2(2*(t.z*t.s-t.x*t.y),r-e+o-n)):"ZYX"===i?(this._x=a.atan2(2*(t.x*t.s+t.z*t.y),r-e-o+n),this._y=a.asin(h(2*(t.y*t.s-t.x*t.z),-1,1)),this._z=a.atan2(2*(t.x*t.y+t.z*t.s),r+e-o-n)):"YZX"===i?(this._x=a.atan2(2*(t.x*t.s-t.z*t.y),r-e+o-n),this._y=a.atan2(2*(t.y*t.s-t.x*t.z),r+e-o-n),this._z=a.asin(h(2*(t.x*t.y+t.z*t.s),-1,1))):"XZY"===i?(this._x=a.atan2(2*(t.x*t.s+t.y*t.z),r-e+o-n),this._y=a.atan2(2*(t.x*t.z+t.y*t.s),r+e-o-n),this._z=a.asin(h(2*(t.z*t.s-t.x*t.y),-1,1))):console.warn("OIMO.Euler: .setFromQuaternion() given unsupported order: "+i),this._order=i,s!==!1&&this.onChangeCallback(),this},reorder:function(){var t=new a.Quat;return function(i){t.setFromEuler(this),this.setFromQuaternion(t,i)}}(),equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){},clone:function(){return new a.Euler(this._x,this._y,this._z,this._order)}},a.EulerToAxis=function(t,i,s){var h=a.cos(.5*i),e=a.sin(.5*i),o=a.cos(.5*s),n=a.sin(.5*s),r=a.cos(.5*t),l=a.sin(.5*t),c=h*o,m=e*n,p=c*r-m*l,u=c*l+m*r,y=e*o*r+h*n*l,x=h*n*r-e*o*l,d=2*a.acos(p),f=u*u+y*y+x*x;return f<.001?(u=1,y=x=0):(f=a.sqrt(f),u/=f,y/=f,x/=f),[d,u,y,x]},a.EulerToMatrix=function(t,i,s){var h=a.cos(i),e=a.sin(i),o=a.cos(s),n=a.sin(s),r=a.cos(t),l=a.sin(t),c=new a.Mat33,m=c.elements;return m[0]=h*o,m[1]=e*l-h*n*r,m[2]=h*n*l+e*r,m[3]=n,m[4]=o*r,m[5]=-o*l,m[6]=-e*o,m[7]=e*n*r+h*l,m[8]=-e*n*l+h*r,c},a.MatrixToEuler=function(t){var i,s,h,e=t.elements;return e[3]>.998?(s=a.atan2(e[2],e[8]),h=a.PI/2,i=0):e[3]<-.998?(s=a.atan2(e[2],e[8]),h=-a.PI/2,i=0):(s=a.atan2(-e[6],e[0]),i=a.atan2(-e[5],e[4]),h=a.asin(e[3])),[i,s,h]},a.unwrapDegrees=function(t){return t%=360,t>180&&(t-=360),t<-180&&(t+=360),t},a.unwrapRadian=function(t){return t%=a.TwoPI,t>a.PI&&(t-=a.TwoPI),t<-a.PI&&(t+=a.TwoPI),t},a.Distance3d=function(t,i){var s=i[0]-t[0],h=i[1]-t[1],e=i[2]-t[2];return a.sqrt(s*s+h*h+e*e)},a.Constraint=function(){this.parent=null,this.body1=null,this.body2=null,this.addedToIsland=!1},a.Constraint.prototype={constructor:a.Constraint,preSolve:function(t,i){a.Error("Constraint","Inheritance error.")},solve:function(){a.Error("Constraint","Inheritance error.")},postSolve:function(){a.Error("Constraint","Inheritance error.")}},a.Joint=function(t){a.Constraint.call(this),this.name="",this.type=a.JOINT_NULL,this.prev=null,this.next=null,this.body1=t.body1,this.body2=t.body2,this.localAnchorPoint1=(new a.Vec3).copy(t.localAnchorPoint1),this.localAnchorPoint2=(new a.Vec3).copy(t.localAnchorPoint2),this.relativeAnchorPoint1=new a.Vec3,this.relativeAnchorPoint2=new a.Vec3,this.anchorPoint1=new a.Vec3,this.anchorPoint2=new a.Vec3,this.allowCollision=t.allowCollision,this.b1Link=new a.JointLink(this),this.b2Link=new a.JointLink(this),this.matrix=new a.Mat44},a.Joint.prototype=Object.create(a.Constraint.prototype),a.Joint.prototype.constructor=a.Joint,a.Joint.prototype.updateAnchorPoints=function(){this.relativeAnchorPoint1.mulMat(this.body1.rotation,this.localAnchorPoint1),this.relativeAnchorPoint2.mulMat(this.body2.rotation,this.localAnchorPoint2),this.anchorPoint1.add(this.relativeAnchorPoint1,this.body1.position),this.anchorPoint2.add(this.relativeAnchorPoint2,this.body2.position)},a.Joint.prototype.attach=function(){this.b1Link.body=this.body2,this.b2Link.body=this.body1,null!=this.body1.jointLink?(this.b1Link.next=this.body1.jointLink).prev=this.b1Link:this.b1Link.next=null,this.body1.jointLink=this.b1Link,this.body1.numJoints++,null!=this.body2.jointLink?(this.b2Link.next=this.body2.jointLink).prev=this.b2Link:this.b2Link.next=null,this.body2.jointLink=this.b2Link,this.body2.numJoints++},a.Joint.prototype.detach=function(){var t=this.b1Link.prev,i=this.b1Link.next;null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body1.jointLink==this.b1Link&&(this.body1.jointLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.body=null,this.body1.numJoints--,t=this.b2Link.prev,i=this.b2Link.next,null!=t&&(t.next=i),null!=i&&(i.prev=t),this.body2.jointLink==this.b2Link&&(this.body2.jointLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.body=null,this.body2.numJoints--,this.b1Link.body=null,this.b2Link.body=null},a.Joint.prototype.awake=function(){this.body1.awake(),this.body2.awake()},a.Joint.prototype.preSolve=function(t,i){},a.Joint.prototype.solve=function(){},a.Joint.prototype.postSolve=function(){},a.Joint.prototype.remove=function(){this.dispose()},a.Joint.prototype.dispose=function(){this.parent.removeJoint(this)},a.Joint.prototype.getPosition=function(){return[(new a.Vec3).scale(this.anchorPoint1,a.WORLD_SCALE),(new a.Vec3).scale(this.anchorPoint2,a.WORLD_SCALE)]},a.Joint.prototype.getMatrix=function(){var t=this.matrix.elements,i=this.anchorPoint1,s=this.anchorPoint2;return t[0]=i.x*a.WORLD_SCALE,t[1]=i.y*a.WORLD_SCALE,t[2]=i.z*a.WORLD_SCALE,t[3]=0,t[4]=s.x*a.WORLD_SCALE,t[5]=s.y*a.WORLD_SCALE,t[6]=s.z*a.WORLD_SCALE,t[7]=0,t},a.JointConfig=function(){this.body1=null,this.body2=null,this.localAnchorPoint1=new a.Vec3,this.localAnchorPoint2=new a.Vec3,this.localAxis1=new a.Vec3,this.localAxis2=new a.Vec3,this.allowCollision=!1},a.JointLink=function(t){this.prev=null,this.next=null,this.body=null,this.joint=t},a.LimitMotor=function(t,i){i=i||!1,this.axis=t,this.angle=0,this.lowerLimit=i?0:1,this.upperLimit=0,this.motorSpeed=0,this.maxMotorForce=0,this.frequency=0,this.dampingRatio=0},a.LimitMotor.prototype={constructor:a.LimitMotor,setLimit:function(t,i){this.lowerLimit=t,this.upperLimit=i},setMotor:function(t,i){this.motorSpeed=t,this.maxMotorForce=i},setSpring:function(t,i){this.frequency=t,this.dampingRatio=i}},a.BallAndSocketJoint=function(t){a.Joint.call(this,t),this.type=a.JOINT_BALL_AND_SOCKET,this.lc=new a.LinearConstraint(this)},a.BallAndSocketJoint.prototype=Object.create(a.Joint.prototype),a.BallAndSocketJoint.prototype.constructor=a.BallAndSocketJoint,a.BallAndSocketJoint.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.lc.preSolve(t,i)},a.BallAndSocketJoint.prototype.solve=function(){this.lc.solve()},a.BallAndSocketJoint.prototype.postSolve=function(){},a.DistanceJoint=function(t,i,s){a.Joint.call(this,t),this.type=a.JOINT_DISTANCE,this.normal=new a.Vec3,this.nr=new a.Vec3,this.limitMotor=new a.LimitMotor(this.normal,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t=new a.TranslationalConstraint(this,this.limitMotor)},a.DistanceJoint.prototype=Object.create(a.Joint.prototype),a.DistanceJoint.prototype.constructor=a.DistanceJoint,a.DistanceJoint.prototype.preSolve=function(t,i){this.updateAnchorPoints(),this.nr.sub(this.anchorPoint2,this.anchorPoint1),this.normal.normalize(this.nr),this.t.preSolve(t,i)},a.DistanceJoint.prototype.solve=function(){this.t.solve()},a.DistanceJoint.prototype.postSolve=function(){},a.HingeJoint=function(t,i,s){a.Joint.call(this,t),this.type=a.JOINT_HINGE,this.localAxis1=t.localAxis1.clone().norm(),this.localAxis2=t.localAxis2.clone().norm(),this.localAngle1=new a.Vec3(this.localAxis1.y*this.localAxis1.x-this.localAxis1.z*this.localAxis1.z,-this.localAxis1.z*this.localAxis1.y-this.localAxis1.x*this.localAxis1.x,this.localAxis1.x*this.localAxis1.z+this.localAxis1.y*this.localAxis1.y).norm();var h=(new a.Mat33).setQuat((new a.Quat).arc(this.localAxis1,this.localAxis2));this.localAngle2=(new a.Vec3).mulMat(h,this.localAngle1),this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.ax1=new a.Vec3,this.ax2=new a.Vec3,this.an1=new a.Vec3,this.an2=new a.Vec3,this.limitMotor=new a.LimitMotor(this.nor,!1),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.lc=new a.LinearConstraint(this),this.r3=new a.Rotational3Constraint(this,this.limitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0))},a.HingeJoint.prototype=Object.create(a.Joint.prototype),a.HingeJoint.prototype.constructor=a.HingeJoint,a.HingeJoint.prototype.preSolve=function(t,i){var s,h,e,o;this.updateAnchorPoints(),this.ax1.mulMat(this.body1.rotation,this.localAxis1),this.ax2.mulMat(this.body2.rotation,this.localAxis2),this.an1.mulMat(this.body1.rotation,this.localAngle1),this.an2.mulMat(this.body2.rotation,this.localAngle2),this.nor.set(this.ax1.x*this.body2.inverseMass+this.ax2.x*this.body1.inverseMass,this.ax1.y*this.body2.inverseMass+this.ax2.y*this.body1.inverseMass,this.ax1.z*this.body2.inverseMass+this.ax2.z*this.body1.inverseMass).norm(),this.tan.set(this.nor.y*this.nor.x-this.nor.z*this.nor.z,-this.nor.z*this.nor.y-this.nor.x*this.nor.x,this.nor.x*this.nor.z+this.nor.y*this.nor.y).norm(),this.bin.set(this.nor.y*this.tan.z-this.nor.z*this.tan.y,this.nor.z*this.tan.x-this.nor.x*this.tan.z,this.nor.x*this.tan.y-this.nor.y*this.tan.x),o=this.acosClamp(this.an1.x*this.an2.x+this.an1.y*this.an2.y+this.an1.z*this.an2.z),this.nor.x*(this.an1.y*this.an2.z-this.an1.z*this.an2.y)+this.nor.y*(this.an1.z*this.an2.x-this.an1.x*this.an2.z)+this.nor.z*(this.an1.x*this.an2.y-this.an1.y*this.an2.x)<0?this.limitMotor.angle=-o:this.limitMotor.angle=o,s=this.ax1.y*this.ax2.z-this.ax1.z*this.ax2.y,h=this.ax1.z*this.ax2.x-this.ax1.x*this.ax2.z,e=this.ax1.x*this.ax2.y-this.ax1.y*this.ax2.x,this.r3.limitMotor2.angle=this.tan.x*s+this.tan.y*h+this.tan.z*e,this.r3.limitMotor3.angle=this.bin.x*s+this.bin.y*h+this.bin.z*e,this.r3.preSolve(t,i),this.lc.preSolve(t,i)},a.HingeJoint.prototype.solve=function(){this.r3.solve(),this.lc.solve()},a.HingeJoint.prototype.postSolve=function(){},a.HingeJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?a.PI:a.acos(t)},a.PrismaticJoint=function(t,i,s){a.Joint.call(this,t),this.type=a.JOINT_PRISMATIC,this.localAxis1=(new a.Vec3).normalize(t.localAxis1),this.localAxis2=(new a.Vec3).normalize(t.localAxis2),this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z,this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.ac=new a.AngularConstraint(this,(new a.Quat).arc(this.localAxis1,this.localAxis2)),this.limitMotor=new a.LimitMotor(this.nor,!0),this.limitMotor.lowerLimit=i,this.limitMotor.upperLimit=s,this.t3=new a.Translational3Constraint(this,this.limitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0))},a.PrismaticJoint.prototype=Object.create(a.Joint.prototype),a.PrismaticJoint.prototype.constructor=a.PrismaticJoint,a.PrismaticJoint.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],o=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],n=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8];s=this.body2.rotation.elements;var r=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],l=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],c=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],m=e*this.body2.inverseMass+r*this.body1.inverseMass,p=o*this.body2.inverseMass+l*this.body1.inverseMass,u=n*this.body2.inverseMass+c*this.body1.inverseMass;h=a.sqrt(m*m+p*p+u*u),h>0&&(h=1/h),m*=h,p*=h,u*=h;var y=p*m-u*u,x=-u*p-m*m,d=m*u+p*p;h=1/a.sqrt(y*y+x*x+d*d),y*=h,x*=h,d*=h;var f=p*d-u*x,v=u*y-m*d,N=m*x-p*y;this.nor.init(m,p,u),this.tan.init(y,x,d),this.bin.init(f,v,N),this.ac.preSolve(t,i),this.t3.preSolve(t,i)},a.PrismaticJoint.prototype.solve=function(){this.ac.solve(),this.t3.solve()},a.PrismaticJoint.prototype.postSolve=function(){},a.SliderJoint=function(t,i,s){a.Joint.call(this,t),this.type=a.JOINT_SLIDER,this.localAxis1=(new a.Vec3).normalize(t.localAxis1),this.localAxis2=(new a.Vec3).normalize(t.localAxis2);var h;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,h=1/a.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=h,this.localAngAxis1Y*=h,this.localAngAxis1Z*=h,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var e=(new a.Mat33).setQuat((new a.Quat).arc(this.localAxis1,this.localAxis2)),o=e.elements;this.localAngAxis2X=this.localAngAxis1X*o[0]+this.localAngAxis1Y*o[1]+this.localAngAxis1Z*o[2],this.localAngAxis2Y=this.localAngAxis1X*o[3]+this.localAngAxis1Y*o[4]+this.localAngAxis1Z*o[5],this.localAngAxis2Z=this.localAngAxis1X*o[6]+this.localAngAxis1Y*o[7]+this.localAngAxis1Z*o[8],this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.rotationalLimitMotor=new a.LimitMotor(this.nor,!1),this.r3=new a.Rotational3Constraint(this,this.rotationalLimitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0)),this.translationalLimitMotor=new a.LimitMotor(this.nor,!0),this.translationalLimitMotor.lowerLimit=i,this.translationalLimitMotor.upperLimit=s,this.t3=new a.Translational3Constraint(this,this.translationalLimitMotor,new a.LimitMotor(this.tan,!0),new a.LimitMotor(this.bin,!0))},a.SliderJoint.prototype=Object.create(a.Joint.prototype),a.SliderJoint.prototype.constructor=a.SliderJoint,a.SliderJoint.prototype.preSolve=function(t,i){var s,h,e,o;this.updateAnchorPoints(),s=this.body1.rotation.elements;var n=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],r=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],l=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],c=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],m=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],p=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var u=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],y=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],x=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],d=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],f=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],v=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8],N=n*this.body2.inverseMass+u*this.body1.inverseMass,b=r*this.body2.inverseMass+y*this.body1.inverseMass,z=l*this.body2.inverseMass+x*this.body1.inverseMass;h=a.sqrt(N*N+b*b+z*z),h>0&&(h=1/h),N*=h,b*=h,z*=h;var A=b*N-z*z,g=-z*b-N*N,w=N*z+b*b;h=1/a.sqrt(A*A+g*g+w*w),A*=h,g*=h,w*=h;var k=b*w-z*g,S=z*A-N*w,P=N*g-b*A;this.nor.init(N,b,z),this.tan.init(A,g,w),this.bin.init(k,S,P),this.rotationalLimitMotor.angle=N*(m*v-p*f)+b*(p*d-c*v)+z*(c*f-m*d)<0?-this.acosClamp(c*d+m*f+p*v):this.acosClamp(c*d+m*f+p*v),h=r*x-l*y,e=l*u-n*x,o=n*y-r*u,this.r3.limitMotor2.angle=A*h+g*e+w*o,this.r3.limitMotor3.angle=k*h+S*e+P*o,this.r3.preSolve(t,i),this.t3.preSolve(t,i)},a.SliderJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},a.SliderJoint.prototype.postSolve=function(){},a.SliderJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?a.PI:a.acos(t)},a.WheelJoint=function(t){a.Joint.call(this,t),this.type=a.JOINT_WHEEL,this.localAxis1=(new a.Vec3).normalize(t.localAxis1),this.localAxis2=(new a.Vec3).normalize(t.localAxis2);var i;this.localAxis1X=this.localAxis1.x,this.localAxis1Y=this.localAxis1.y,this.localAxis1Z=this.localAxis1.z,this.localAxis2X=this.localAxis2.x,this.localAxis2Y=this.localAxis2.y,this.localAxis2Z=this.localAxis2.z;var s=this.localAxis1X*this.localAxis2X+this.localAxis1Y*this.localAxis2Y+this.localAxis1Z*this.localAxis2Z;if(s>-1&&s<1)this.localAngAxis1X=this.localAxis2X-s*this.localAxis1X,this.localAngAxis1Y=this.localAxis2Y-s*this.localAxis1Y,this.localAngAxis1Z=this.localAxis2Z-s*this.localAxis1Z,this.localAngAxis2X=this.localAxis1X-s*this.localAxis2X,this.localAngAxis2Y=this.localAxis1Y-s*this.localAxis2Y,this.localAngAxis2Z=this.localAxis1Z-s*this.localAxis2Z,i=1/a.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=i,this.localAngAxis1Y*=i,this.localAngAxis1Z*=i,i=1/a.sqrt(this.localAngAxis2X*this.localAngAxis2X+this.localAngAxis2Y*this.localAngAxis2Y+this.localAngAxis2Z*this.localAngAxis2Z),this.localAngAxis2X*=i,this.localAngAxis2Y*=i,this.localAngAxis2Z*=i;else{this.localAngAxis1X=this.localAxis1Y*this.localAxis1X-this.localAxis1Z*this.localAxis1Z,this.localAngAxis1Y=-this.localAxis1Z*this.localAxis1Y-this.localAxis1X*this.localAxis1X,this.localAngAxis1Z=this.localAxis1X*this.localAxis1Z+this.localAxis1Y*this.localAxis1Y,i=1/a.sqrt(this.localAngAxis1X*this.localAngAxis1X+this.localAngAxis1Y*this.localAngAxis1Y+this.localAngAxis1Z*this.localAngAxis1Z),this.localAngAxis1X*=i,this.localAngAxis1Y*=i,this.localAngAxis1Z*=i;var h=(new a.Mat33).setQuat((new a.Quat).arc(this.localAxis1,this.localAxis2)),e=h.elements;this.localAngAxis2X=this.localAngAxis1X*e[0]+this.localAngAxis1Y*e[1]+this.localAngAxis1Z*e[2],this.localAngAxis2Y=this.localAngAxis1X*e[3]+this.localAngAxis1Y*e[4]+this.localAngAxis1Z*e[5],this.localAngAxis2Z=this.localAngAxis1X*e[6]+this.localAngAxis1Y*e[7]+this.localAngAxis1Z*e[8]}this.nor=new a.Vec3,this.tan=new a.Vec3,this.bin=new a.Vec3,this.translationalLimitMotor=new a.LimitMotor(this.tan,!0),this.translationalLimitMotor.frequency=8,this.translationalLimitMotor.dampingRatio=1,this.rotationalLimitMotor1=new a.LimitMotor(this.tan,!1),this.rotationalLimitMotor2=new a.LimitMotor(this.bin,!1),this.t3=new a.Translational3Constraint(this,new a.LimitMotor(this.nor,!0),this.translationalLimitMotor,new a.LimitMotor(this.bin,!0)),this.t3.weight=1,this.r3=new a.Rotational3Constraint(this,new a.LimitMotor(this.nor,!0),this.rotationalLimitMotor1,this.rotationalLimitMotor2)},a.WheelJoint.prototype=Object.create(a.Joint.prototype),a.WheelJoint.prototype.constructor=a.WheelJoint,a.WheelJoint.prototype.preSolve=function(t,i){var s,h;this.updateAnchorPoints(),s=this.body1.rotation.elements;var e=this.localAxis1X*s[0]+this.localAxis1Y*s[1]+this.localAxis1Z*s[2],o=this.localAxis1X*s[3]+this.localAxis1Y*s[4]+this.localAxis1Z*s[5],n=this.localAxis1X*s[6]+this.localAxis1Y*s[7]+this.localAxis1Z*s[8],r=this.localAngAxis1X*s[0]+this.localAngAxis1Y*s[1]+this.localAngAxis1Z*s[2],l=this.localAngAxis1X*s[3]+this.localAngAxis1Y*s[4]+this.localAngAxis1Z*s[5],c=this.localAngAxis1X*s[6]+this.localAngAxis1Y*s[7]+this.localAngAxis1Z*s[8];s=this.body2.rotation.elements;var m=this.localAxis2X*s[0]+this.localAxis2Y*s[1]+this.localAxis2Z*s[2],p=this.localAxis2X*s[3]+this.localAxis2Y*s[4]+this.localAxis2Z*s[5],u=this.localAxis2X*s[6]+this.localAxis2Y*s[7]+this.localAxis2Z*s[8],y=this.localAngAxis2X*s[0]+this.localAngAxis2Y*s[1]+this.localAngAxis2Z*s[2],x=this.localAngAxis2X*s[3]+this.localAngAxis2Y*s[4]+this.localAngAxis2Z*s[5],d=this.localAngAxis2X*s[6]+this.localAngAxis2Y*s[7]+this.localAngAxis2Z*s[8];this.r3.limitMotor1.angle=e*m+o*p+n*u,this.rotationalLimitMotor1.angle=e*(l*u-c*p)+o*(c*m-r*u)+n*(r*p-l*m)<0?-this.acosClamp(r*m+l*p+c*u):this.acosClamp(r*m+l*p+c*u),this.rotationalLimitMotor2.angle=m*(x*n-d*o)+p*(d*e-y*n)+u*(y*o-x*e)<0?this.acosClamp(y*e+x*o+d*n):-this.acosClamp(y*e+x*o+d*n);var f=p*n-u*o,v=u*e-m*n,N=m*o-p*e;h=a.sqrt(f*f+v*v+N*N),h>0&&(h=1/h),f*=h,v*=h,N*=h;var b=v*u-N*p,z=N*m-f*u,A=f*p-v*m;h=a.sqrt(b*b+z*z+A*A),h>0&&(h=1/h),b*=h,z*=h,A*=h;var g=o*N-n*v,w=n*f-e*N,k=e*v-o*f;h=a.sqrt(g*g+w*w+k*k),h>0&&(h=1/h),g*=h,w*=h,k*=h,this.nor.init(f,v,N),this.tan.init(b,z,A),this.bin.init(g,w,k),this.r3.preSolve(t,i),this.t3.preSolve(t,i)},a.WheelJoint.prototype.solve=function(){this.r3.solve(),this.t3.solve()},a.WheelJoint.prototype.postSolve=function(){},a.WheelJoint.prototype.acosClamp=function(t){return t>1?0:t<-1?a.PI:a.acos(t)},a.AngularConstraint=function(t,i){this.joint=t,this.targetOrientation=(new a.Quat).invert(i),this.relativeOrientation=new a.Quat,this.ii1=null,this.ii2=null,this.dd=null,this.vel=new a.Vec3,this.imp=new a.Vec3,this.rn0=new a.Vec3,this.rn1=new a.Vec3,this.rn2=new a.Vec3,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia},a.AngularConstraint.prototype={constructor:a.AngularConstraint,preSolve:function(t,i){var s,h,e;this.ii1=this.i1.clone(),this.ii2=this.i2.clone(),e=(new a.Mat33).add(this.ii1,this.ii2).elements,s=1/(e[0]*(e[4]*e[8]-e[7]*e[5])+e[3]*(e[7]*e[2]-e[1]*e[8])+e[6]*(e[1]*e[5]-e[4]*e[2])),this.dd=new a.Mat33(e[4]*e[8]-e[5]*e[7],e[2]*e[7]-e[1]*e[8],e[1]*e[5]-e[2]*e[4],e[5]*e[6]-e[3]*e[8],e[0]*e[8]-e[2]*e[6],e[2]*e[3]-e[0]*e[5],e[3]*e[7]-e[4]*e[6],e[1]*e[6]-e[0]*e[7],e[0]*e[4]-e[1]*e[3]).multiply(s),this.relativeOrientation.invert(this.b1.orientation),this.relativeOrientation.mul(this.targetOrientation,this.relativeOrientation),this.relativeOrientation.mul(this.b2.orientation,this.relativeOrientation),s=2*this.relativeOrientation.s,this.vel.scale(this.relativeOrientation,s),h=this.vel.length(),h>.02?(h=(.02-h)/h*i*.05,this.vel.scaleEqual(h)):this.vel.init(),this.rn1.mulMat(this.ii1,this.imp),this.rn2.mulMat(this.ii2,this.imp),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)},solve:function(){var t=this.a2.clone().subEqual(this.a1).subEqual(this.vel);this.rn0.mulMat(this.dd,t),this.rn1.mulMat(this.ii1,this.rn0),this.rn2.mulMat(this.ii2,this.rn0),this.imp.addEqual(this.rn0),this.a1.addEqual(this.rn1),this.a2.subEqual(this.rn2)}},a.LinearConstraint=function(t){this.m1=NaN,this.m2=NaN,this.ii1=null,this.ii2=null,this.dd=null,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.ax1x=NaN,this.ax1y=NaN,this.ax1z=NaN,this.ay1x=NaN,this.ay1y=NaN,this.ay1z=NaN,this.az1x=NaN,this.az1y=NaN,this.az1z=NaN,this.ax2x=NaN,this.ax2y=NaN,this.ax2z=NaN,this.ay2x=NaN,this.ay2y=NaN,this.ay2z=NaN,this.az2x=NaN,this.az2y=NaN,this.az2z=NaN,this.vel=NaN,this.velx=NaN,this.vely=NaN,this.velz=NaN,this.joint=t,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.b1=t.body1,this.b2=t.body2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.impx=0,this.impy=0,this.impz=0},a.LinearConstraint.prototype={constructor:a.LinearConstraint,preSolve:function(t,i){this.r1x=this.r1.x,this.r1y=this.r1.y,this.r1z=this.r1.z,this.r2x=this.r2.x,this.r2y=this.r2.y,this.r2z=this.r2.z,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements;this.ax1x=this.r1z*s[1]+-this.r1y*s[2],this.ax1y=this.r1z*s[4]+-this.r1y*s[5],this.ax1z=this.r1z*s[7]+-this.r1y*s[8],this.ay1x=-this.r1z*s[0]+this.r1x*s[2],this.ay1y=-this.r1z*s[3]+this.r1x*s[5],this.ay1z=-this.r1z*s[6]+this.r1x*s[8],this.az1x=this.r1y*s[0]+-this.r1x*s[1],this.az1y=this.r1y*s[3]+-this.r1x*s[4],this.az1z=this.r1y*s[6]+-this.r1x*s[7],this.ax2x=this.r2z*h[1]+-this.r2y*h[2],this.ax2y=this.r2z*h[4]+-this.r2y*h[5],this.ax2z=this.r2z*h[7]+-this.r2y*h[8],this.ay2x=-this.r2z*h[0]+this.r2x*h[2],this.ay2y=-this.r2z*h[3]+this.r2x*h[5],this.ay2z=-this.r2z*h[6]+this.r2x*h[8],this.az2x=this.r2y*h[0]+-this.r2x*h[1],this.az2y=this.r2y*h[3]+-this.r2x*h[4],this.az2z=this.r2y*h[6]+-this.r2x*h[7];var e=this.m1+this.m2,o=new a.Mat33(e,0,0,0,e,0,0,0,e),n=o.elements;n[0]+=s[4]*this.r1z*this.r1z-(s[7]+s[5])*this.r1y*this.r1z+s[8]*this.r1y*this.r1y,n[1]+=(s[6]*this.r1y+s[5]*this.r1x)*this.r1z-s[3]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[2]+=(s[3]*this.r1y-s[4]*this.r1x)*this.r1z-s[6]*this.r1y*this.r1y+s[7]*this.r1x*this.r1y,n[3]+=(s[2]*this.r1y+s[7]*this.r1x)*this.r1z-s[1]*this.r1z*this.r1z-s[8]*this.r1x*this.r1y,n[4]+=s[0]*this.r1z*this.r1z-(s[6]+s[2])*this.r1x*this.r1z+s[8]*this.r1x*this.r1x,n[5]+=(s[1]*this.r1x-s[0]*this.r1y)*this.r1z-s[7]*this.r1x*this.r1x+s[6]*this.r1x*this.r1y,n[6]+=(s[1]*this.r1y-s[4]*this.r1x)*this.r1z-s[2]*this.r1y*this.r1y+s[5]*this.r1x*this.r1y,n[7]+=(s[3]*this.r1x-s[0]*this.r1y)*this.r1z-s[5]*this.r1x*this.r1x+s[2]*this.r1x*this.r1y,n[8]+=s[0]*this.r1y*this.r1y-(s[3]+s[1])*this.r1x*this.r1y+s[4]*this.r1x*this.r1x,n[0]+=h[4]*this.r2z*this.r2z-(h[7]+h[5])*this.r2y*this.r2z+h[8]*this.r2y*this.r2y,n[1]+=(h[6]*this.r2y+h[5]*this.r2x)*this.r2z-h[3]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,n[2]+=(h[3]*this.r2y-h[4]*this.r2x)*this.r2z-h[6]*this.r2y*this.r2y+h[7]*this.r2x*this.r2y,n[3]+=(h[2]*this.r2y+h[7]*this.r2x)*this.r2z-h[1]*this.r2z*this.r2z-h[8]*this.r2x*this.r2y,n[4]+=h[0]*this.r2z*this.r2z-(h[6]+h[2])*this.r2x*this.r2z+h[8]*this.r2x*this.r2x,n[5]+=(h[1]*this.r2x-h[0]*this.r2y)*this.r2z-h[7]*this.r2x*this.r2x+h[6]*this.r2x*this.r2y,n[6]+=(h[1]*this.r2y-h[4]*this.r2x)*this.r2z-h[2]*this.r2y*this.r2y+h[5]*this.r2x*this.r2y,n[7]+=(h[3]*this.r2x-h[0]*this.r2y)*this.r2z-h[5]*this.r2x*this.r2x+h[2]*this.r2x*this.r2y,n[8]+=h[0]*this.r2y*this.r2y-(h[3]+h[1])*this.r2x*this.r2y+h[4]*this.r2x*this.r2x;var r=1/(n[0]*(n[4]*n[8]-n[7]*n[5])+n[3]*(n[7]*n[2]-n[1]*n[8])+n[6]*(n[1]*n[5]-n[4]*n[2]));this.dd=new a.Mat33(n[4]*n[8]-n[5]*n[7],n[2]*n[7]-n[1]*n[8],n[1]*n[5]-n[2]*n[4],n[5]*n[6]-n[3]*n[8],n[0]*n[8]-n[2]*n[6],n[2]*n[3]-n[0]*n[5],n[3]*n[7]-n[4]*n[6],n[1]*n[6]-n[0]*n[7],n[0]*n[4]-n[1]*n[3]).multiply(r),this.velx=this.p2.x-this.p1.x,this.vely=this.p2.y-this.p1.y,this.velz=this.p2.z-this.p1.z;var l=a.sqrt(this.velx*this.velx+this.vely*this.vely+this.velz*this.velz);l>.005?(l=(.005-l)/l*i*.05,this.velx*=l,this.vely*=l,this.velz*=l):(this.velx=0,this.vely=0,this.velz=0),this.impx*=.95,this.impy*=.95,this.impz*=.95,this.l1.x+=this.impx*this.m1,this.l1.y+=this.impy*this.m1,this.l1.z+=this.impz*this.m1,this.a1.x+=this.impx*this.ax1x+this.impy*this.ay1x+this.impz*this.az1x,this.a1.y+=this.impx*this.ax1y+this.impy*this.ay1y+this.impz*this.az1y,this.a1.z+=this.impx*this.ax1z+this.impy*this.ay1z+this.impz*this.az1z,this.l2.x-=this.impx*this.m2,this.l2.y-=this.impy*this.m2,this.l2.z-=this.impz*this.m2,this.a2.x-=this.impx*this.ax2x+this.impy*this.ay2x+this.impz*this.az2x,this.a2.y-=this.impx*this.ax2y+this.impy*this.ay2y+this.impz*this.az2y,this.a2.z-=this.impx*this.ax2z+this.impy*this.ay2z+this.impz*this.az2z},solve:function(){var t=this.dd.elements,i=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y-this.velx,s=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z-this.vely,h=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x-this.velz,e=i*t[0]+s*t[1]+h*t[2],o=i*t[3]+s*t[4]+h*t[5],n=i*t[6]+s*t[7]+h*t[8];this.impx+=e,this.impy+=o,this.impz+=n,this.l1.x+=e*this.m1,this.l1.y+=o*this.m1,this.l1.z+=n*this.m1,this.a1.x+=e*this.ax1x+o*this.ay1x+n*this.az1x,this.a1.y+=e*this.ax1y+o*this.ay1y+n*this.az1y,this.a1.z+=e*this.ax1z+o*this.ay1z+n*this.az1z,this.l2.x-=e*this.m2,this.l2.y-=o*this.m2,this.l2.z-=n*this.m2,this.a2.x-=e*this.ax2x+o*this.ay2x+n*this.az2x,this.a2.y-=e*this.ax2y+o*this.ay2y+n*this.az2y,this.a2.z-=e*this.ax2z+o*this.ay2z+n*this.az2z}},a.Rotational3Constraint=function(t,i,s,h){this.cfm1=NaN,this.cfm2=NaN,this.cfm3=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0},a.Rotational3Constraint.prototype={constructor:a.Rotational3Constraint,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor1.frequency,o=this.limitMotor2.frequency,n=this.limitMotor3.frequency,a=e>0,r=o>0,l=n>0,c=this.lowerLimit1<=this.upperLimit1,m=this.lowerLimit2<=this.upperLimit2,p=this.lowerLimit3<=this.upperLimit3,u=this.limitMotor1.angle;c?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-u):u>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-u):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),a||(this.limitVelocity1>.02?this.limitVelocity1-=.02:this.limitVelocity1<-.02?this.limitVelocity1+=.02:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0);var y=this.limitMotor2.angle;m?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-y):y<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-y):y>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-y):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),r||(this.limitVelocity2>.02?this.limitVelocity2-=.02:this.limitVelocity2<-.02?this.limitVelocity2+=.02:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0);var x=this.limitMotor3.angle;if(p?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-x):x<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-x):x>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-x):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),l||(this.limitVelocity3>.02?this.limitVelocity3-=.02:this.limitVelocity3<-.02?this.limitVelocity3+=.02:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||a)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||r)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||l)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0),this.a1x1=this.ax1*this.i1e00+this.ay1*this.i1e01+this.az1*this.i1e02,this.a1y1=this.ax1*this.i1e10+this.ay1*this.i1e11+this.az1*this.i1e12,this.a1z1=this.ax1*this.i1e20+this.ay1*this.i1e21+this.az1*this.i1e22,this.a2x1=this.ax1*this.i2e00+this.ay1*this.i2e01+this.az1*this.i2e02,this.a2y1=this.ax1*this.i2e10+this.ay1*this.i2e11+this.az1*this.i2e12,this.a2z1=this.ax1*this.i2e20+this.ay1*this.i2e21+this.az1*this.i2e22,this.a1x2=this.ax2*this.i1e00+this.ay2*this.i1e01+this.az2*this.i1e02,this.a1y2=this.ax2*this.i1e10+this.ay2*this.i1e11+this.az2*this.i1e12,this.a1z2=this.ax2*this.i1e20+this.ay2*this.i1e21+this.az2*this.i1e22,this.a2x2=this.ax2*this.i2e00+this.ay2*this.i2e01+this.az2*this.i2e02,this.a2y2=this.ax2*this.i2e10+this.ay2*this.i2e11+this.az2*this.i2e12,this.a2z2=this.ax2*this.i2e20+this.ay2*this.i2e21+this.az2*this.i2e22,this.a1x3=this.ax3*this.i1e00+this.ay3*this.i1e01+this.az3*this.i1e02,this.a1y3=this.ax3*this.i1e10+this.ay3*this.i1e11+this.az3*this.i1e12,this.a1z3=this.ax3*this.i1e20+this.ay3*this.i1e21+this.az3*this.i1e22,this.a2x3=this.ax3*this.i2e00+this.ay3*this.i2e01+this.az3*this.i2e02,this.a2y3=this.ax3*this.i2e10+this.ay3*this.i2e11+this.az3*this.i2e12,this.a2z3=this.ax3*this.i2e20+this.ay3*this.i2e21+this.az3*this.i2e22,this.k00=this.ax1*(this.a1x1+this.a2x1)+this.ay1*(this.a1y1+this.a2y1)+this.az1*(this.a1z1+this.a2z1),this.k01=this.ax1*(this.a1x2+this.a2x2)+this.ay1*(this.a1y2+this.a2y2)+this.az1*(this.a1z2+this.a2z2),this.k02=this.ax1*(this.a1x3+this.a2x3)+this.ay1*(this.a1y3+this.a2y3)+this.az1*(this.a1z3+this.a2z3),this.k10=this.ax2*(this.a1x1+this.a2x1)+this.ay2*(this.a1y1+this.a2y1)+this.az2*(this.a1z1+this.a2z1),this.k11=this.ax2*(this.a1x2+this.a2x2)+this.ay2*(this.a1y2+this.a2y2)+this.az2*(this.a1z2+this.a2z2),this.k12=this.ax2*(this.a1x3+this.a2x3)+this.ay2*(this.a1y3+this.a2y3)+this.az2*(this.a1z3+this.a2z3),this.k20=this.ax3*(this.a1x1+this.a2x1)+this.ay3*(this.a1y1+this.a2y1)+this.az3*(this.a1z1+this.a2z1),this.k21=this.ax3*(this.a1x2+this.a2x2)+this.ay3*(this.a1y2+this.a2y2)+this.az3*(this.a1z2+this.a2z2),this.k22=this.ax3*(this.a1x3+this.a2x3)+this.ay3*(this.a1y3+this.a2y3)+this.az3*(this.a1z3+this.a2z3),this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,a&&2!=this.limitState1){var d=6.2831853*e,f=d*d*t,v=i/(f+2*this.limitMotor1.dampingRatio*d);this.cfm1=this.kv00*v,this.limitVelocity1*=f*v}else this.cfm1=0,this.limitVelocity1*=.05*i;r&&2!=this.limitState2?(d=6.2831853*o,f=d*d*t,v=i/(f+2*this.limitMotor2.dampingRatio*d),this.cfm2=this.kv11*v,this.limitVelocity2*=f*v):(this.cfm2=0,this.limitVelocity2*=.05*i),l&&2!=this.limitState3?(d=6.2831853*n,f=d*d*t,v=i/(f+2*this.limitMotor3.dampingRatio*d),this.cfm3=this.kv22*v,this.limitVelocity3*=f*v):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var N=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*N,this.d01=(this.k02*this.k21-this.k01*this.k22)*N,this.d02=(this.k01*this.k12-this.k02*this.k11)*N,this.d10=(this.k12*this.k20-this.k10*this.k22)*N,this.d11=(this.k00*this.k22-this.k02*this.k20)*N,this.d12=(this.k02*this.k10-this.k00*this.k12)*N,this.d20=(this.k10*this.k21-this.k11*this.k20)*N,this.d21=(this.k01*this.k20-this.k00*this.k21)*N,this.d22=(this.k00*this.k11-this.k01*this.k10)*N,this.limitImpulse1*=.95,this.motorImpulse1*=.95,this.limitImpulse2*=.95,this.motorImpulse2*=.95,this.limitImpulse3*=.95,this.motorImpulse3*=.95;var b=this.limitImpulse1+this.motorImpulse1,z=this.limitImpulse2+this.motorImpulse2,A=this.limitImpulse3+this.motorImpulse3;this.a1.x+=b*this.a1x1+z*this.a1x2+A*this.a1x3,this.a1.y+=b*this.a1y1+z*this.a1y2+A*this.a1y3,this.a1.z+=b*this.a1z1+z*this.a1z2+A*this.a1z3,this.a2.x-=b*this.a2x1+z*this.a2x2+A*this.a2x3,this.a2.y-=b*this.a2y1+z*this.a2y2+A*this.a2y3,this.a2.z-=b*this.a2z1+z*this.a2z2+A*this.a2z3},solve_:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z;this.limitVelocity3=30;var h=t*this.ax1+i*this.ay1+s*this.az1-this.limitVelocity1,e=t*this.ax2+i*this.ay2+s*this.az2-this.limitVelocity2,o=t*this.ax3+i*this.ay3+s*this.az3-this.limitVelocity3,n=h*this.d00+e*this.d01+o*this.d02,a=h*this.d10+e*this.d11+o*this.d12,r=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=n,this.limitImpulse2+=a,this.limitImpulse3+=r,this.a1.x+=n*this.a1x1+a*this.a1x2+r*this.a1x3,this.a1.y+=n*this.a1y1+a*this.a1y2+r*this.a1y3,this.a1.z+=n*this.a1z1+a*this.a1z2+r*this.a1z3,this.a2.x-=n*this.a2x1+a*this.a2x2+r*this.a2x3,this.a2.y-=n*this.a2y1+a*this.a2y2+r*this.a2y3,this.a2.z-=n*this.a2z1+a*this.a2z2+r*this.a2z3},solve:function(){var t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,n=this.motorImpulse1,a=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-n),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-a),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,y=this.limitImpulse3,x=h*this.d00+e*this.d01+o*this.d02,d=h*this.d10+e*this.d11+o*this.d12,f=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=x,this.limitImpulse2+=d,this.limitImpulse3+=f;var v=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(x=-p,e+=x*this.k10,o+=x*this.k20,v|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-u,h+=d*this.k01,o+=d*this.k21,v|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(f=-y,h+=f*this.k02,e+=f*this.k12,v|=4);var N;switch(v){case 1:N=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*o)*N,f=(-this.k21*e+this.k11*o)*N;break;case 2:N=1/(this.k00*this.k22-this.k02*this.k20),x=(this.k22*h+-this.k02*o)*N,f=(-this.k20*h+this.k00*o)*N;break;case 3:f=o/this.k22;break;case 4:N=1/(this.k00*this.k11-this.k01*this.k10),x=(this.k11*h+-this.k01*e)*N,d=(-this.k10*h+this.k00*e)*N;break;case 5:d=e/this.k11;break;case 6:x=h/this.k00}this.limitImpulse1=x+p,this.limitImpulse2=d+u,this.limitImpulse3=f+y;var b=l+x,z=c+d,A=m+f;this.a1.x+=b*this.a1x1+z*this.a1x2+A*this.a1x3,this.a1.y+=b*this.a1y1+z*this.a1y2+A*this.a1y3,this.a1.z+=b*this.a1z1+z*this.a1z2+A*this.a1z3,this.a2.x-=b*this.a2x1+z*this.a2x2+A*this.a2x3,this.a2.y-=b*this.a2y1+z*this.a2y2+A*this.a2y3,this.a2.z-=b*this.a2z1+z*this.a2z2+A*this.a2z3,t=this.a2.x-this.a1.x,i=this.a2.y-this.a1.y,s=this.a2.z-this.a1.z,e=t*this.ax2+i*this.ay2+s*this.az2}},a.RotationalConstraint=function(t,i){this.cfm=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.enableLimit=!1,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},a.RotationalConstraint.prototype={constructor:a.RotationalConstraint,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.limitMotor.frequency,o=e>0,n=this.lowerLimit<=this.upperLimit,a=this.limitMotor.angle;if(n?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a):a<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a):a>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-a):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),o||(this.limitVelocity>.02?this.limitVelocity-=.02:this.limitVelocity<-.02?this.limitVelocity+=.02:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||o)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0),this.a1x=this.ax*this.i1e00+this.ay*this.i1e01+this.az*this.i1e02,this.a1y=this.ax*this.i1e10+this.ay*this.i1e11+this.az*this.i1e12,this.a1z=this.ax*this.i1e20+this.ay*this.i1e21+this.az*this.i1e22,this.a2x=this.ax*this.i2e00+this.ay*this.i2e01+this.az*this.i2e02,this.a2y=this.ax*this.i2e10+this.ay*this.i2e11+this.az*this.i2e12,this.a2z=this.ax*this.i2e20+this.ay*this.i2e21+this.az*this.i2e22,this.motorDenom=this.ax*(this.a1x+this.a2x)+this.ay*(this.a1y+this.a2y)+this.az*(this.a1z+this.a2z),this.invMotorDenom=1/this.motorDenom,o&&2!=this.limitState){var r=6.2831853*e,l=r*r*t,c=i/(l+2*this.limitMotor.dampingRatio*r);this.cfm=this.motorDenom*c,this.limitVelocity*=l*c}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm),this.limitImpulse*=.95,this.motorImpulse*=.95;var m=this.limitImpulse+this.motorImpulse;this.a1.x+=m*this.a1x,this.a1.y+=m*this.a1y,this.a1.z+=m*this.a1z,this.a2.x-=m*this.a2x,this.a2.y-=m*this.a2y,this.a2.z-=m*this.a2z},solve:function(){var t,i=this.ax*(this.a2.x-this.a1.x)+this.ay*(this.a2.y-this.a1.y)+this.az*(this.a2.z-this.a1.z);if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var o=h+t;this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}},a.Translational3Constraint=function(t,i,s,h){this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.ax1=NaN,this.ay1=NaN,this.az1=NaN,this.ax2=NaN,this.ay2=NaN,this.az2=NaN,this.ax3=NaN,this.ay3=NaN,this.az3=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x1=NaN,this.t1y1=NaN,this.t1z1=NaN,this.t2x1=NaN,this.t2y1=NaN,this.t2z1=NaN,this.l1x1=NaN,this.l1y1=NaN,this.l1z1=NaN,this.l2x1=NaN,this.l2y1=NaN,this.l2z1=NaN,this.a1x1=NaN,this.a1y1=NaN,this.a1z1=NaN,this.a2x1=NaN,this.a2y1=NaN,this.a2z1=NaN,this.t1x2=NaN,this.t1y2=NaN,this.t1z2=NaN,this.t2x2=NaN,this.t2y2=NaN,this.t2z2=NaN,this.l1x2=NaN,this.l1y2=NaN,this.l1z2=NaN,this.l2x2=NaN,this.l2y2=NaN,this.l2z2=NaN,this.a1x2=NaN,this.a1y2=NaN,this.a1z2=NaN,this.a2x2=NaN,this.a2y2=NaN,this.a2z2=NaN,this.t1x3=NaN,this.t1y3=NaN,this.t1z3=NaN,this.t2x3=NaN,this.t2y3=NaN,this.t2z3=NaN,this.l1x3=NaN,this.l1y3=NaN,this.l1z3=NaN,this.l2x3=NaN,this.l2y3=NaN,this.l2z3=NaN,this.a1x3=NaN,this.a1y3=NaN,this.a1z3=NaN,this.a2x3=NaN,this.a2y3=NaN,this.a2z3=NaN,this.lowerLimit1=NaN,this.upperLimit1=NaN,this.limitVelocity1=NaN,this.limitState1=0,this.enableMotor1=!1,this.motorSpeed1=NaN,this.maxMotorForce1=NaN,this.maxMotorImpulse1=NaN,this.lowerLimit2=NaN,this.upperLimit2=NaN,this.limitVelocity2=NaN,this.limitState2=0,this.enableMotor2=!1,this.motorSpeed2=NaN,this.maxMotorForce2=NaN,this.maxMotorImpulse2=NaN,this.lowerLimit3=NaN,this.upperLimit3=NaN,this.limitVelocity3=NaN,this.limitState3=0,this.enableMotor3=!1,this.motorSpeed3=NaN,this.maxMotorForce3=NaN,this.maxMotorImpulse3=NaN,this.k00=NaN,this.k01=NaN,this.k02=NaN,this.k10=NaN,this.k11=NaN,this.k12=NaN,this.k20=NaN,this.k21=NaN,this.k22=NaN,this.kv00=NaN,this.kv11=NaN,this.kv22=NaN,this.dv00=NaN,this.dv11=NaN,this.dv22=NaN,this.d00=NaN,this.d01=NaN,this.d02=NaN,this.d10=NaN,this.d11=NaN,this.d12=NaN,this.d20=NaN,this.d21=NaN,this.d22=NaN,this.limitMotor1=i,this.limitMotor2=s,this.limitMotor3=h,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse1=0,this.motorImpulse1=0,this.limitImpulse2=0,this.motorImpulse2=0,this.limitImpulse3=0,this.motorImpulse3=0,this.cfm1=0,this.cfm2=0,this.cfm3=0,this.weight=-1},a.Translational3Constraint.prototype={constructor:a.Translational3Constraint,preSolve:function(t,i){this.ax1=this.limitMotor1.axis.x,this.ay1=this.limitMotor1.axis.y,this.az1=this.limitMotor1.axis.z,this.ax2=this.limitMotor2.axis.x,this.ay2=this.limitMotor2.axis.y,this.az2=this.limitMotor2.axis.z,this.ax3=this.limitMotor3.axis.x,this.ay3=this.limitMotor3.axis.y,this.az3=this.limitMotor3.axis.z,this.lowerLimit1=this.limitMotor1.lowerLimit,this.upperLimit1=this.limitMotor1.upperLimit,this.motorSpeed1=this.limitMotor1.motorSpeed,this.maxMotorForce1=this.limitMotor1.maxMotorForce,this.enableMotor1=this.maxMotorForce1>0,this.lowerLimit2=this.limitMotor2.lowerLimit,this.upperLimit2=this.limitMotor2.upperLimit,this.motorSpeed2=this.limitMotor2.motorSpeed,this.maxMotorForce2=this.limitMotor2.maxMotorForce,this.enableMotor2=this.maxMotorForce2>0,this.lowerLimit3=this.limitMotor3.lowerLimit,this.upperLimit3=this.limitMotor3.upperLimit,this.motorSpeed3=this.limitMotor3.motorSpeed,this.maxMotorForce3=this.limitMotor3.maxMotorForce,this.enableMotor3=this.maxMotorForce3>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,n=this.p2.z-this.p1.z,a=e*this.ax1+o*this.ay1+n*this.az1,r=e*this.ax2+o*this.ay2+n*this.az2,l=e*this.ax3+o*this.ay3+n*this.az3,c=this.limitMotor1.frequency,m=this.limitMotor2.frequency,p=this.limitMotor3.frequency,u=c>0,y=m>0,x=p>0,d=this.lowerLimit1<=this.upperLimit1,f=this.lowerLimit2<=this.upperLimit2,v=this.lowerLimit3<=this.upperLimit3;(u&&a>20||a<-20)&&(u=!1),(y&&r>20||r<-20)&&(y=!1),(x&&l>20||l<-20)&&(x=!1),d?(this.lowerLimit1==this.upperLimit1?(0!=this.limitState1&&(this.limitState1=0,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-a,u||(a=this.lowerLimit1)):a<this.lowerLimit1?(this.limitState1!=-1&&(this.limitState1=-1,this.limitImpulse1=0),this.limitVelocity1=this.lowerLimit1-a,u||(a=this.lowerLimit1)):a>this.upperLimit1?(1!=this.limitState1&&(this.limitState1=1,this.limitImpulse1=0),this.limitVelocity1=this.upperLimit1-a,u||(a=this.upperLimit1)):(this.limitState1=2,this.limitImpulse1=0,this.limitVelocity1=0),u||(this.limitVelocity1>.005?this.limitVelocity1-=.005:this.limitVelocity1<-.005?this.limitVelocity1+=.005:this.limitVelocity1=0)):(this.limitState1=2,this.limitImpulse1=0),f?(this.lowerLimit2==this.upperLimit2?(0!=this.limitState2&&(this.limitState2=0,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,y||(r=this.lowerLimit2)):r<this.lowerLimit2?(this.limitState2!=-1&&(this.limitState2=-1,this.limitImpulse2=0),this.limitVelocity2=this.lowerLimit2-r,y||(r=this.lowerLimit2)):r>this.upperLimit2?(1!=this.limitState2&&(this.limitState2=1,this.limitImpulse2=0),this.limitVelocity2=this.upperLimit2-r,y||(r=this.upperLimit2)):(this.limitState2=2,this.limitImpulse2=0,this.limitVelocity2=0),y||(this.limitVelocity2>.005?this.limitVelocity2-=.005:this.limitVelocity2<-.005?this.limitVelocity2+=.005:this.limitVelocity2=0)):(this.limitState2=2,this.limitImpulse2=0),v?(this.lowerLimit3==this.upperLimit3?(0!=this.limitState3&&(this.limitState3=0,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,x||(l=this.lowerLimit3)):l<this.lowerLimit3?(this.limitState3!=-1&&(this.limitState3=-1,this.limitImpulse3=0),this.limitVelocity3=this.lowerLimit3-l,x||(l=this.lowerLimit3)):l>this.upperLimit3?(1!=this.limitState3&&(this.limitState3=1,this.limitImpulse3=0),this.limitVelocity3=this.upperLimit3-l,x||(l=this.upperLimit3)):(this.limitState3=2,this.limitImpulse3=0,this.limitVelocity3=0),x||(this.limitVelocity3>.005?this.limitVelocity3-=.005:this.limitVelocity3<-.005?this.limitVelocity3+=.005:this.limitVelocity3=0)):(this.limitState3=2,this.limitImpulse3=0),this.enableMotor1&&(0!=this.limitState1||u)?this.maxMotorImpulse1=this.maxMotorForce1*t:(this.motorImpulse1=0,this.maxMotorImpulse1=0),this.enableMotor2&&(0!=this.limitState2||y)?this.maxMotorImpulse2=this.maxMotorForce2*t:(this.motorImpulse2=0,this.maxMotorImpulse2=0),this.enableMotor3&&(0!=this.limitState3||x)?this.maxMotorImpulse3=this.maxMotorForce3*t:(this.motorImpulse3=0,this.maxMotorImpulse3=0);var N=a*this.ax1+r*this.ax2+l*this.ax2,b=a*this.ay1+r*this.ay2+l*this.ay2,z=a*this.az1+r*this.az2+l*this.az2,A=this.m2/(this.m1+this.m2);this.weight>=0&&(A=this.weight);var g=1-A;this.r1x=this.r1.x+N*A,this.r1y=this.r1.y+b*A,this.r1z=this.r1.z+z*A,this.r2x=this.r2.x-N*g,this.r2y=this.r2.y-b*g,this.r2z=this.r2.z-z*g,this.t1x1=this.r1y*this.az1-this.r1z*this.ay1,this.t1y1=this.r1z*this.ax1-this.r1x*this.az1,this.t1z1=this.r1x*this.ay1-this.r1y*this.ax1,this.t2x1=this.r2y*this.az1-this.r2z*this.ay1,this.t2y1=this.r2z*this.ax1-this.r2x*this.az1,this.t2z1=this.r2x*this.ay1-this.r2y*this.ax1,this.l1x1=this.ax1*this.m1,this.l1y1=this.ay1*this.m1,this.l1z1=this.az1*this.m1,this.l2x1=this.ax1*this.m2,this.l2y1=this.ay1*this.m2,this.l2z1=this.az1*this.m2,this.a1x1=this.t1x1*this.i1e00+this.t1y1*this.i1e01+this.t1z1*this.i1e02,this.a1y1=this.t1x1*this.i1e10+this.t1y1*this.i1e11+this.t1z1*this.i1e12,this.a1z1=this.t1x1*this.i1e20+this.t1y1*this.i1e21+this.t1z1*this.i1e22,this.a2x1=this.t2x1*this.i2e00+this.t2y1*this.i2e01+this.t2z1*this.i2e02,this.a2y1=this.t2x1*this.i2e10+this.t2y1*this.i2e11+this.t2z1*this.i2e12,this.a2z1=this.t2x1*this.i2e20+this.t2y1*this.i2e21+this.t2z1*this.i2e22,this.t1x2=this.r1y*this.az2-this.r1z*this.ay2,this.t1y2=this.r1z*this.ax2-this.r1x*this.az2,this.t1z2=this.r1x*this.ay2-this.r1y*this.ax2,this.t2x2=this.r2y*this.az2-this.r2z*this.ay2,this.t2y2=this.r2z*this.ax2-this.r2x*this.az2,this.t2z2=this.r2x*this.ay2-this.r2y*this.ax2,this.l1x2=this.ax2*this.m1,this.l1y2=this.ay2*this.m1,this.l1z2=this.az2*this.m1,this.l2x2=this.ax2*this.m2,this.l2y2=this.ay2*this.m2,this.l2z2=this.az2*this.m2,this.a1x2=this.t1x2*this.i1e00+this.t1y2*this.i1e01+this.t1z2*this.i1e02,this.a1y2=this.t1x2*this.i1e10+this.t1y2*this.i1e11+this.t1z2*this.i1e12,this.a1z2=this.t1x2*this.i1e20+this.t1y2*this.i1e21+this.t1z2*this.i1e22,this.a2x2=this.t2x2*this.i2e00+this.t2y2*this.i2e01+this.t2z2*this.i2e02,this.a2y2=this.t2x2*this.i2e10+this.t2y2*this.i2e11+this.t2z2*this.i2e12,this.a2z2=this.t2x2*this.i2e20+this.t2y2*this.i2e21+this.t2z2*this.i2e22,this.t1x3=this.r1y*this.az3-this.r1z*this.ay3,this.t1y3=this.r1z*this.ax3-this.r1x*this.az3,this.t1z3=this.r1x*this.ay3-this.r1y*this.ax3,this.t2x3=this.r2y*this.az3-this.r2z*this.ay3,this.t2y3=this.r2z*this.ax3-this.r2x*this.az3,this.t2z3=this.r2x*this.ay3-this.r2y*this.ax3,this.l1x3=this.ax3*this.m1,this.l1y3=this.ay3*this.m1,this.l1z3=this.az3*this.m1,this.l2x3=this.ax3*this.m2,this.l2y3=this.ay3*this.m2,this.l2z3=this.az3*this.m2,this.a1x3=this.t1x3*this.i1e00+this.t1y3*this.i1e01+this.t1z3*this.i1e02,this.a1y3=this.t1x3*this.i1e10+this.t1y3*this.i1e11+this.t1z3*this.i1e12,this.a1z3=this.t1x3*this.i1e20+this.t1y3*this.i1e21+this.t1z3*this.i1e22,this.a2x3=this.t2x3*this.i2e00+this.t2y3*this.i2e01+this.t2z3*this.i2e02,this.a2y3=this.t2x3*this.i2e10+this.t2y3*this.i2e11+this.t2z3*this.i2e12,this.a2z3=this.t2x3*this.i2e20+this.t2y3*this.i2e21+this.t2z3*this.i2e22;var w=this.m1+this.m2;if(this.k00=(this.ax1*this.ax1+this.ay1*this.ay1+this.az1*this.az1)*w,this.k01=(this.ax1*this.ax2+this.ay1*this.ay2+this.az1*this.az2)*w,this.k02=(this.ax1*this.ax3+this.ay1*this.ay3+this.az1*this.az3)*w,this.k10=(this.ax2*this.ax1+this.ay2*this.ay1+this.az2*this.az1)*w,this.k11=(this.ax2*this.ax2+this.ay2*this.ay2+this.az2*this.az2)*w,this.k12=(this.ax2*this.ax3+this.ay2*this.ay3+this.az2*this.az3)*w,this.k20=(this.ax3*this.ax1+this.ay3*this.ay1+this.az3*this.az1)*w,this.k21=(this.ax3*this.ax2+this.ay3*this.ay2+this.az3*this.az2)*w,this.k22=(this.ax3*this.ax3+this.ay3*this.ay3+this.az3*this.az3)*w,this.k00+=this.t1x1*this.a1x1+this.t1y1*this.a1y1+this.t1z1*this.a1z1,this.k01+=this.t1x1*this.a1x2+this.t1y1*this.a1y2+this.t1z1*this.a1z2,this.k02+=this.t1x1*this.a1x3+this.t1y1*this.a1y3+this.t1z1*this.a1z3,this.k10+=this.t1x2*this.a1x1+this.t1y2*this.a1y1+this.t1z2*this.a1z1,this.k11+=this.t1x2*this.a1x2+this.t1y2*this.a1y2+this.t1z2*this.a1z2,this.k12+=this.t1x2*this.a1x3+this.t1y2*this.a1y3+this.t1z2*this.a1z3,this.k20+=this.t1x3*this.a1x1+this.t1y3*this.a1y1+this.t1z3*this.a1z1,this.k21+=this.t1x3*this.a1x2+this.t1y3*this.a1y2+this.t1z3*this.a1z2,this.k22+=this.t1x3*this.a1x3+this.t1y3*this.a1y3+this.t1z3*this.a1z3,this.k00+=this.t2x1*this.a2x1+this.t2y1*this.a2y1+this.t2z1*this.a2z1,this.k01+=this.t2x1*this.a2x2+this.t2y1*this.a2y2+this.t2z1*this.a2z2,this.k02+=this.t2x1*this.a2x3+this.t2y1*this.a2y3+this.t2z1*this.a2z3,this.k10+=this.t2x2*this.a2x1+this.t2y2*this.a2y1+this.t2z2*this.a2z1,this.k11+=this.t2x2*this.a2x2+this.t2y2*this.a2y2+this.t2z2*this.a2z2,this.k12+=this.t2x2*this.a2x3+this.t2y2*this.a2y3+this.t2z2*this.a2z3,this.k20+=this.t2x3*this.a2x1+this.t2y3*this.a2y1+this.t2z3*this.a2z1,this.k21+=this.t2x3*this.a2x2+this.t2y3*this.a2y2+this.t2z3*this.a2z2,this.k22+=this.t2x3*this.a2x3+this.t2y3*this.a2y3+this.t2z3*this.a2z3,this.kv00=this.k00,this.kv11=this.k11,this.kv22=this.k22,this.dv00=1/this.kv00,this.dv11=1/this.kv11,this.dv22=1/this.kv22,u&&2!=this.limitState1){var k=6.2831853*c,S=k*k*t,P=i/(S+2*this.limitMotor1.dampingRatio*k);this.cfm1=this.kv00*P,this.limitVelocity1*=S*P}else this.cfm1=0,this.limitVelocity1*=.05*i;y&&2!=this.limitState2?(k=6.2831853*m,S=k*k*t,P=i/(S+2*this.limitMotor2.dampingRatio*k),this.cfm2=this.kv11*P,this.limitVelocity2*=S*P):(this.cfm2=0,this.limitVelocity2*=.05*i),x&&2!=this.limitState3?(k=6.2831853*p,S=k*k*t,P=i/(S+2*this.limitMotor3.dampingRatio*k),this.cfm3=this.kv22*P,this.limitVelocity3*=S*P):(this.cfm3=0,this.limitVelocity3*=.05*i),this.k00+=this.cfm1,this.k11+=this.cfm2,this.k22+=this.cfm3;var L=1/(this.k00*(this.k11*this.k22-this.k21*this.k12)+this.k10*(this.k21*this.k02-this.k01*this.k22)+this.k20*(this.k01*this.k12-this.k11*this.k02));this.d00=(this.k11*this.k22-this.k12*this.k21)*L,this.d01=(this.k02*this.k21-this.k01*this.k22)*L,this.d02=(this.k01*this.k12-this.k02*this.k11)*L,this.d10=(this.k12*this.k20-this.k10*this.k22)*L,this.d11=(this.k00*this.k22-this.k02*this.k20)*L,this.d12=(this.k02*this.k10-this.k00*this.k12)*L,this.d20=(this.k10*this.k21-this.k11*this.k20)*L,this.d21=(this.k01*this.k20-this.k00*this.k21)*L,this.d22=(this.k00*this.k11-this.k01*this.k10)*L;var I=this.limitImpulse1+this.motorImpulse1,M=this.limitImpulse2+this.motorImpulse2,T=this.limitImpulse3+this.motorImpulse3;this.l1.x+=I*this.l1x1+M*this.l1x2+T*this.l1x3,this.l1.y+=I*this.l1y1+M*this.l1y2+T*this.l1y3,this.l1.z+=I*this.l1z1+M*this.l1z2+T*this.l1z3,this.a1.x+=I*this.a1x1+M*this.a1x2+T*this.a1x3,this.a1.y+=I*this.a1y1+M*this.a1y2+T*this.a1y3,this.a1.z+=I*this.a1z1+M*this.a1z2+T*this.a1z3,this.l2.x-=I*this.l2x1+M*this.l2x2+T*this.l2x3,this.l2.y-=I*this.l2y1+M*this.l2y2+T*this.l2y3,this.l2.z-=I*this.l2z1+M*this.l2z2+T*this.l2z3,this.a2.x-=I*this.a2x1+M*this.a2x2+T*this.a2x3,this.a2.y-=I*this.a2y1+M*this.a2y2+T*this.a2y3,this.a2.z-=I*this.a2z1+M*this.a2z2+T*this.a2z3},solve:function(){var t=this.l2.x-this.l1.x+this.a2.y*this.r2z-this.a2.z*this.r2y-this.a1.y*this.r1z+this.a1.z*this.r1y,i=this.l2.y-this.l1.y+this.a2.z*this.r2x-this.a2.x*this.r2z-this.a1.z*this.r1x+this.a1.x*this.r1z,s=this.l2.z-this.l1.z+this.a2.x*this.r2y-this.a2.y*this.r2x-this.a1.x*this.r1y+this.a1.y*this.r1x,h=t*this.ax1+i*this.ay1+s*this.az1,e=t*this.ax2+i*this.ay2+s*this.az2,o=t*this.ax3+i*this.ay3+s*this.az3,n=this.motorImpulse1,a=this.motorImpulse2,r=this.motorImpulse3,l=0,c=0,m=0;this.enableMotor1&&(l=(h-this.motorSpeed1)*this.dv00,this.motorImpulse1+=l,this.motorImpulse1>this.maxMotorImpulse1?this.motorImpulse1=this.maxMotorImpulse1:this.motorImpulse1<-this.maxMotorImpulse1&&(this.motorImpulse1=-this.maxMotorImpulse1),l=this.motorImpulse1-n),this.enableMotor2&&(c=(e-this.motorSpeed2)*this.dv11,this.motorImpulse2+=c,this.motorImpulse2>this.maxMotorImpulse2?this.motorImpulse2=this.maxMotorImpulse2:this.motorImpulse2<-this.maxMotorImpulse2&&(this.motorImpulse2=-this.maxMotorImpulse2),c=this.motorImpulse2-a),this.enableMotor3&&(m=(o-this.motorSpeed3)*this.dv22,this.motorImpulse3+=m,this.motorImpulse3>this.maxMotorImpulse3?this.motorImpulse3=this.maxMotorImpulse3:this.motorImpulse3<-this.maxMotorImpulse3&&(this.motorImpulse3=-this.maxMotorImpulse3),m=this.motorImpulse3-r),h+=l*this.kv00+c*this.k01+m*this.k02,e+=l*this.k10+c*this.kv11+m*this.k12,o+=l*this.k20+c*this.k21+m*this.kv22,h-=this.limitVelocity1+this.limitImpulse1*this.cfm1,e-=this.limitVelocity2+this.limitImpulse2*this.cfm2,o-=this.limitVelocity3+this.limitImpulse3*this.cfm3;var p=this.limitImpulse1,u=this.limitImpulse2,y=this.limitImpulse3,x=h*this.d00+e*this.d01+o*this.d02,d=h*this.d10+e*this.d11+o*this.d12,f=h*this.d20+e*this.d21+o*this.d22;this.limitImpulse1+=x,this.limitImpulse2+=d,this.limitImpulse3+=f;var v=0;(2==this.limitState1||this.limitImpulse1*this.limitState1<0)&&(x=-p,e+=x*this.k10,o+=x*this.k20,v|=1),(2==this.limitState2||this.limitImpulse2*this.limitState2<0)&&(d=-u,h+=d*this.k01,o+=d*this.k21,v|=2),(2==this.limitState3||this.limitImpulse3*this.limitState3<0)&&(f=-y,h+=f*this.k02,e+=f*this.k12,v|=4);var N;switch(v){case 1:N=1/(this.k11*this.k22-this.k12*this.k21),d=(this.k22*e+-this.k12*o)*N,f=(-this.k21*e+this.k11*o)*N;break;case 2:N=1/(this.k00*this.k22-this.k02*this.k20),x=(this.k22*h+-this.k02*o)*N,f=(-this.k20*h+this.k00*o)*N;break;case 3:f=o/this.k22;break;case 4:N=1/(this.k00*this.k11-this.k01*this.k10),x=(this.k11*h+-this.k01*e)*N,d=(-this.k10*h+this.k00*e)*N;break;case 5:d=e/this.k11;break;case 6:x=h/this.k00}this.limitImpulse1=p+x,this.limitImpulse2=u+d,this.limitImpulse3=y+f;var b=l+x,z=c+d,A=m+f;this.l1.x+=b*this.l1x1+z*this.l1x2+A*this.l1x3,this.l1.y+=b*this.l1y1+z*this.l1y2+A*this.l1y3,this.l1.z+=b*this.l1z1+z*this.l1z2+A*this.l1z3,this.a1.x+=b*this.a1x1+z*this.a1x2+A*this.a1x3,this.a1.y+=b*this.a1y1+z*this.a1y2+A*this.a1y3,this.a1.z+=b*this.a1z1+z*this.a1z2+A*this.a1z3,this.l2.x-=b*this.l2x1+z*this.l2x2+A*this.l2x3,this.l2.y-=b*this.l2y1+z*this.l2y2+A*this.l2y3,this.l2.z-=b*this.l2z1+z*this.l2z2+A*this.l2z3,this.a2.x-=b*this.a2x1+z*this.a2x2+A*this.a2x3,this.a2.y-=b*this.a2y1+z*this.a2y2+A*this.a2y3,this.a2.z-=b*this.a2z1+z*this.a2z2+A*this.a2z3}},a.TranslationalConstraint=function(t,i){this.cfm=NaN,this.m1=NaN,this.m2=NaN,this.i1e00=NaN,this.i1e01=NaN,this.i1e02=NaN,this.i1e10=NaN,this.i1e11=NaN,this.i1e12=NaN,this.i1e20=NaN,this.i1e21=NaN,this.i1e22=NaN,this.i2e00=NaN,this.i2e01=NaN,this.i2e02=NaN,this.i2e10=NaN,this.i2e11=NaN,this.i2e12=NaN,this.i2e20=NaN,this.i2e21=NaN,this.i2e22=NaN,this.motorDenom=NaN,this.invMotorDenom=NaN,this.invDenom=NaN,this.ax=NaN,this.ay=NaN,this.az=NaN,this.r1x=NaN,this.r1y=NaN,this.r1z=NaN,this.r2x=NaN,this.r2y=NaN,this.r2z=NaN,this.t1x=NaN,this.t1y=NaN,this.t1z=NaN,this.t2x=NaN,this.t2y=NaN,this.t2z=NaN,this.l1x=NaN,this.l1y=NaN,this.l1z=NaN,this.l2x=NaN,this.l2y=NaN,this.l2z=NaN,this.a1x=NaN,this.a1y=NaN,this.a1z=NaN,this.a2x=NaN,this.a2y=NaN,this.a2z=NaN,this.lowerLimit=NaN,this.upperLimit=NaN,this.limitVelocity=NaN,this.limitState=0,this.enableMotor=!1,this.motorSpeed=NaN,this.maxMotorForce=NaN,this.maxMotorImpulse=NaN,this.limitMotor=i,this.b1=t.body1,this.b2=t.body2,this.p1=t.anchorPoint1,this.p2=t.anchorPoint2,this.r1=t.relativeAnchorPoint1,this.r2=t.relativeAnchorPoint2,this.l1=this.b1.linearVelocity,this.l2=this.b2.linearVelocity,this.a1=this.b1.angularVelocity,this.a2=this.b2.angularVelocity,this.i1=this.b1.inverseInertia,this.i2=this.b2.inverseInertia,this.limitImpulse=0,this.motorImpulse=0},a.TranslationalConstraint.prototype={constructor:a.TranslationalConstraint,preSolve:function(t,i){this.ax=this.limitMotor.axis.x,this.ay=this.limitMotor.axis.y,this.az=this.limitMotor.axis.z,this.lowerLimit=this.limitMotor.lowerLimit,this.upperLimit=this.limitMotor.upperLimit,this.motorSpeed=this.limitMotor.motorSpeed,this.maxMotorForce=this.limitMotor.maxMotorForce,this.enableMotor=this.maxMotorForce>0,this.m1=this.b1.inverseMass,this.m2=this.b2.inverseMass;var s=this.i1.elements,h=this.i2.elements;this.i1e00=s[0],this.i1e01=s[1],this.i1e02=s[2],this.i1e10=s[3],this.i1e11=s[4],this.i1e12=s[5],this.i1e20=s[6],this.i1e21=s[7],this.i1e22=s[8],this.i2e00=h[0],this.i2e01=h[1],this.i2e02=h[2],this.i2e10=h[3],this.i2e11=h[4],this.i2e12=h[5],this.i2e20=h[6],this.i2e21=h[7],this.i2e22=h[8];var e=this.p2.x-this.p1.x,o=this.p2.y-this.p1.y,n=this.p2.z-this.p1.z,a=e*this.ax+o*this.ay+n*this.az,r=this.limitMotor.frequency,l=r>0,c=this.lowerLimit<=this.upperLimit;(l&&a>20||a<-20)&&(l=!1),c?(this.lowerLimit==this.upperLimit?(0!=this.limitState&&(this.limitState=0,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a,l||(a=this.lowerLimit)):a<this.lowerLimit?(this.limitState!=-1&&(this.limitState=-1,this.limitImpulse=0),this.limitVelocity=this.lowerLimit-a,l||(a=this.lowerLimit)):a>this.upperLimit?(1!=this.limitState&&(this.limitState=1,this.limitImpulse=0),this.limitVelocity=this.upperLimit-a,l||(a=this.upperLimit)):(this.limitState=2,this.limitImpulse=0,this.limitVelocity=0),l||(this.limitVelocity>.005?this.limitVelocity-=.005:this.limitVelocity<-.005?this.limitVelocity+=.005:this.limitVelocity=0)):(this.limitState=2,this.limitImpulse=0),this.enableMotor&&(0!=this.limitState||l)?this.maxMotorImpulse=this.maxMotorForce*t:(this.motorImpulse=0,this.maxMotorImpulse=0);var m=a*this.ax,p=a*this.ay,u=a*this.az,y=this.m1/(this.m1+this.m2),x=1-y;if(this.r1x=this.r1.x+m*y,this.r1y=this.r1.y+p*y,this.r1z=this.r1.z+u*y,this.r2x=this.r2.x-m*x,this.r2y=this.r2.y-p*x,this.r2z=this.r2.z-u*x,this.t1x=this.r1y*this.az-this.r1z*this.ay,this.t1y=this.r1z*this.ax-this.r1x*this.az,this.t1z=this.r1x*this.ay-this.r1y*this.ax,this.t2x=this.r2y*this.az-this.r2z*this.ay,this.t2y=this.r2z*this.ax-this.r2x*this.az,this.t2z=this.r2x*this.ay-this.r2y*this.ax,this.l1x=this.ax*this.m1,this.l1y=this.ay*this.m1,this.l1z=this.az*this.m1,this.l2x=this.ax*this.m2,this.l2y=this.ay*this.m2,this.l2z=this.az*this.m2,this.a1x=this.t1x*this.i1e00+this.t1y*this.i1e01+this.t1z*this.i1e02,this.a1y=this.t1x*this.i1e10+this.t1y*this.i1e11+this.t1z*this.i1e12,this.a1z=this.t1x*this.i1e20+this.t1y*this.i1e21+this.t1z*this.i1e22,this.a2x=this.t2x*this.i2e00+this.t2y*this.i2e01+this.t2z*this.i2e02,this.a2y=this.t2x*this.i2e10+this.t2y*this.i2e11+this.t2z*this.i2e12,this.a2z=this.t2x*this.i2e20+this.t2y*this.i2e21+this.t2z*this.i2e22,this.motorDenom=this.m1+this.m2+this.ax*(this.a1y*this.r1z-this.a1z*this.r1y+this.a2y*this.r2z-this.a2z*this.r2y)+this.ay*(this.a1z*this.r1x-this.a1x*this.r1z+this.a2z*this.r2x-this.a2x*this.r2z)+this.az*(this.a1x*this.r1y-this.a1y*this.r1x+this.a2x*this.r2y-this.a2y*this.r2x),this.invMotorDenom=1/this.motorDenom,l&&2!=this.limitState){var d=6.2831853*r,f=d*d*t,v=i/(f+2*this.limitMotor.dampingRatio*d);this.cfm=this.motorDenom*v,this.limitVelocity*=f*v}else this.cfm=0,this.limitVelocity*=.05*i;this.invDenom=1/(this.motorDenom+this.cfm);var N=this.limitImpulse+this.motorImpulse;this.l1.x+=N*this.l1x,this.l1.y+=N*this.l1y,this.l1.z+=N*this.l1z,this.a1.x+=N*this.a1x,this.a1.y+=N*this.a1y,this.a1.z+=N*this.a1z,this.l2.x-=N*this.l2x,this.l2.y-=N*this.l2y,this.l2.z-=N*this.l2z,this.a2.x-=N*this.a2x,this.a2.y-=N*this.a2y,this.a2.z-=N*this.a2z},solve:function(){var t,i=this.ax*(this.l2.x-this.l1.x)+this.ay*(this.l2.y-this.l1.y)+this.az*(this.l2.z-this.l1.z)+this.t2x*this.a2.x-this.t1x*this.a1.x+this.t2y*this.a2.y-this.t1y*this.a1.y+this.t2z*this.a2.z-this.t1z*this.a1.z;if(this.enableMotor){t=(i-this.motorSpeed)*this.invMotorDenom;var s=this.motorImpulse;this.motorImpulse+=t,this.motorImpulse>this.maxMotorImpulse?this.motorImpulse=this.maxMotorImpulse:this.motorImpulse<-this.maxMotorImpulse&&(this.motorImpulse=-this.maxMotorImpulse),t=this.motorImpulse-s,i-=t*this.motorDenom}else t=0;var h;if(2!=this.limitState){h=(i-this.limitVelocity-this.limitImpulse*this.cfm)*this.invDenom;var e=this.limitImpulse;this.limitImpulse+=h,this.limitImpulse*this.limitState<0&&(this.limitImpulse=0),h=this.limitImpulse-e}else h=0;var o=h+t;this.l1.x+=o*this.l1x,this.l1.y+=o*this.l1y,this.l1.z+=o*this.l1z,this.a1.x+=o*this.a1x,this.a1.y+=o*this.a1y,this.a1.z+=o*this.a1z,this.l2.x-=o*this.l2x,this.l2.y-=o*this.l2y,this.l2.z-=o*this.l2z,this.a2.x-=o*this.a2x,this.a2.y-=o*this.a2y,this.a2.z-=o*this.a2z}},a.Contact=function(){this.shape1=null,this.shape2=null,this.body1=null,this.body2=null,this.prev=null,this.next=null,this.persisting=!1,this.sleeping=!1,this.detector=null,this.constraint=null,this.touching=!1,this.b1Link=new a.ContactLink(this),this.b2Link=new a.ContactLink(this),this.s1Link=new a.ContactLink(this),this.s2Link=new a.ContactLink(this),this.manifold=new a.ContactManifold,this.buffer=[],this.buffer.length=4,this.buffer[0]=new a.ImpulseDataBuffer,this.buffer[1]=new a.ImpulseDataBuffer,this.buffer[2]=new a.ImpulseDataBuffer,this.buffer[3]=new a.ImpulseDataBuffer,this.points=this.manifold.points,this.constraint=new a.ContactConstraint(this.manifold)},a.Contact.prototype={constructor:a.Contact,mixRestitution:function(t,i){return a.sqrt(t*i)},mixFriction:function(t,i){return a.sqrt(t*i)},updateManifold:function(){this.constraint.restitution=this.mixRestitution(this.shape1.restitution,this.shape2.restitution),this.constraint.friction=this.mixFriction(this.shape1.friction,this.shape2.friction);for(var t=this.manifold.numPoints,i=t;i--;){var s=this.buffer[i],h=this.points[i];s.lp1X=h.localPoint1.x,s.lp1Y=h.localPoint1.y,s.lp1Z=h.localPoint1.z,s.lp2X=h.localPoint2.x,s.lp2Y=h.localPoint2.y,s.lp2Z=h.localPoint2.z,s.impulse=h.normalImpulse}this.manifold.numPoints=0,this.detector.detectCollision(this.shape1,this.shape2,this.manifold);var e=this.manifold.numPoints;if(0==e)return void(this.touching=!1);for(this.touching=!0,i=e;i--;){h=this.points[i];for(var o=h.localPoint1.x,n=h.localPoint1.y,a=h.localPoint1.z,r=h.localPoint2.x,l=h.localPoint2.y,c=h.localPoint2.z,m=-1,p=4e-4,u=t;u--;){s=this.buffer[u];var y=s.lp1X-o,x=s.lp1Y-n,d=s.lp1Z-a,f=y*y+x*x+d*d;y=s.lp2X-r,x=s.lp2Y-l,d=s.lp2Z-c;var v=y*y+x*x+d*d;f<v?f<p&&(p=f,m=u):v<p&&(p=v,m=u)}if(m!=-1){var N=this.buffer[m];this.buffer[m]=this.buffer[--t],this.buffer[t]=N,h.normalImpulse=N.impulse,h.warmStarted=!0}else h.normalImpulse=0,h.warmStarted=!1}},attach:function(t,i){this.shape1=t,this.shape2=i,this.body1=t.parent,this.body2=i.parent,this.manifold.body1=this.body1,this.manifold.body2=this.body2,this.constraint.body1=this.body1,this.constraint.body2=this.body2,this.constraint.attach(),this.s1Link.shape=i,this.s1Link.body=this.body2,this.s2Link.shape=t,this.s2Link.body=this.body1,null!=t.contactLink?(this.s1Link.next=t.contactLink).prev=this.s1Link:this.s1Link.next=null,t.contactLink=this.s1Link,t.numContacts++,null!=i.contactLink?(this.s2Link.next=i.contactLink).prev=this.s2Link:this.s2Link.next=null,i.contactLink=this.s2Link,i.numContacts++,this.b1Link.shape=i,this.b1Link.body=this.body2,this.b2Link.shape=t,this.b2Link.body=this.body1,null!=this.body1.contactLink?(this.b1Link.next=this.body1.contactLink).prev=this.b1Link:this.b1Link.next=null,this.body1.contactLink=this.b1Link,this.body1.numContacts++,null!=this.body2.contactLink?(this.b2Link.next=this.body2.contactLink).prev=this.b2Link:this.b2Link.next=null,this.body2.contactLink=this.b2Link,this.body2.numContacts++,this.prev=null,this.next=null,this.persisting=!0,this.sleeping=this.body1.sleeping&&this.body2.sleeping,this.manifold.numPoints=0},detach:function(){var t=this.s1Link.prev,i=this.s1Link.next;null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape1.contactLink==this.s1Link&&(this.shape1.contactLink=i),this.s1Link.prev=null,this.s1Link.next=null,this.s1Link.shape=null,this.s1Link.body=null,this.shape1.numContacts--,t=this.s2Link.prev,i=this.s2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.shape2.contactLink==this.s2Link&&(this.shape2.contactLink=i),this.s2Link.prev=null,this.s2Link.next=null,this.s2Link.shape=null,this.s2Link.body=null,this.shape2.numContacts--,t=this.b1Link.prev,i=this.b1Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body1.contactLink==this.b1Link&&(this.body1.contactLink=i),this.b1Link.prev=null,this.b1Link.next=null,this.b1Link.shape=null,this.b1Link.body=null,this.body1.numContacts--,t=this.b2Link.prev,i=this.b2Link.next,null!==t&&(t.next=i),null!==i&&(i.prev=t),this.body2.contactLink==this.b2Link&&(this.body2.contactLink=i),this.b2Link.prev=null,this.b2Link.next=null,this.b2Link.shape=null,this.b2Link.body=null,this.body2.numContacts--,this.manifold.body1=null,this.manifold.body2=null,this.constraint.body1=null,this.constraint.body2=null,this.constraint.detach(),this.shape1=null,this.shape2=null,this.body1=null,this.body2=null}},a.ContactConstraint=function(t){a.Constraint.call(this),this.manifold=t,this.restitution=NaN,this.friction=NaN,this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null,this.ii1=null,this.ii2=null,this.m1=NaN,this.m2=NaN,this.num=0,this.ps=t.points,this.cs=new a.ContactPointDataBuffer,this.cs.next=new a.ContactPointDataBuffer,this.cs.next.next=new a.ContactPointDataBuffer,this.cs.next.next.next=new a.ContactPointDataBuffer},a.ContactConstraint.prototype=Object.create(a.Constraint.prototype),a.ContactConstraint.prototype.attach=function(){this.p1=this.body1.position,this.p2=this.body2.position,this.lv1=this.body1.linearVelocity,this.av1=this.body1.angularVelocity,this.lv2=this.body2.linearVelocity,this.av2=this.body2.angularVelocity,this.i1=this.body1.inverseInertia,this.i2=this.body2.inverseInertia},a.ContactConstraint.prototype.detach=function(){this.p1=null,this.p2=null,this.lv1=null,this.lv2=null,this.av1=null,this.av2=null,this.i1=null,this.i2=null},a.ContactConstraint.prototype.preSolve=function(t,i){this.m1=this.body1.inverseMass,this.m2=this.body2.inverseMass,this.ii1=this.i1.clone(),this.ii2=this.i2.clone();var s=this.ii1.elements,h=this.ii2.elements,e=this.p1.x,o=this.p1.y,n=this.p1.z,r=this.p2.x,l=this.p2.y,c=this.p2.z,m=this.m1+this.m2;this.num=this.manifold.numPoints;for(var p=this.cs,u=0;u<this.num;u++){var y,x,d,f,v,N,b=this.ps[u];y=b.position.x,x=b.position.y,d=b.position.z;var z=y-e,A=x-o,g=d-n,w=y-r,k=x-l,S=d-c;p.rp1X=z,p.rp1Y=A,p.rp1Z=g,p.rp2X=w,p.rp2Y=k,p.rp2Z=S,p.norImp=b.normalImpulse,p.tanImp=b.tangentImpulse,p.binImp=b.binormalImpulse;var P=b.normal.x,L=b.normal.y,I=b.normal.z,M=this.lv2.x+this.av2.y*S-this.av2.z*k-(this.lv1.x+this.av1.y*g-this.av1.z*A),T=this.lv2.y+this.av2.z*w-this.av2.x*S-(this.lv1.y+this.av1.z*z-this.av1.x*g),V=this.lv2.z+this.av2.x*k-this.av2.y*w-(this.lv1.z+this.av1.x*A-this.av1.y*z),C=P*M+L*T+I*V,E=M-C*P,D=T-C*L,_=V-C*I,B=E*E+D*D+_*_;B>.04?B=1/a.sqrt(B):(E=L*P-I*I,D=-I*L-P*P,_=P*I+L*L,B=1/a.sqrt(E*E+D*D+_*_)),E*=B,D*=B,_*=B;var Y=L*_-I*D,X=I*E-P*_,Z=P*D-L*E;p.norX=P,p.norY=L,p.norZ=I,p.tanX=E,p.tanY=D,p.tanZ=_,p.binX=Y,p.binY=X,p.binZ=Z,p.norU1X=P*this.m1,p.norU1Y=L*this.m1,p.norU1Z=I*this.m1,p.norU2X=P*this.m2,p.norU2Y=L*this.m2,p.norU2Z=I*this.m2,p.tanU1X=E*this.m1,p.tanU1Y=D*this.m1,p.tanU1Z=_*this.m1,p.tanU2X=E*this.m2,p.tanU2Y=D*this.m2,p.tanU2Z=_*this.m2,p.binU1X=Y*this.m1,p.binU1Y=X*this.m1,p.binU1Z=Z*this.m1,p.binU2X=Y*this.m2,p.binU2Y=X*this.m2,p.binU2Z=Z*this.m2;var R=A*I-g*L,O=g*P-z*I,j=z*L-A*P,U=k*I-S*L,J=S*P-w*I,F=w*L-k*P,q=A*_-g*D,H=g*E-z*_,W=z*D-A*E,Q=k*_-S*D,G=S*E-w*_,K=w*D-k*E,$=A*Z-g*X,tt=g*Y-z*Z,it=z*X-A*Y,st=k*Z-S*X,ht=S*Y-w*Z,et=w*X-k*Y,ot=R*s[0]+O*s[1]+j*s[2],nt=R*s[3]+O*s[4]+j*s[5],at=R*s[6]+O*s[7]+j*s[8],rt=U*h[0]+J*h[1]+F*h[2],lt=U*h[3]+J*h[4]+F*h[5],ct=U*h[6]+J*h[7]+F*h[8],mt=q*s[0]+H*s[1]+W*s[2],pt=q*s[3]+H*s[4]+W*s[5],ut=q*s[6]+H*s[7]+W*s[8],yt=Q*h[0]+G*h[1]+K*h[2],xt=Q*h[3]+G*h[4]+K*h[5],dt=Q*h[6]+G*h[7]+K*h[8],ft=$*s[0]+tt*s[1]+it*s[2],vt=$*s[3]+tt*s[4]+it*s[5],Nt=$*s[6]+tt*s[7]+it*s[8],bt=st*h[0]+ht*h[1]+et*h[2],zt=st*h[3]+ht*h[4]+et*h[5],At=st*h[6]+ht*h[7]+et*h[8];p.norT1X=R,p.norT1Y=O,p.norT1Z=j,p.tanT1X=q,p.tanT1Y=H,p.tanT1Z=W,p.binT1X=$,p.binT1Y=tt,p.binT1Z=it,p.norT2X=U,p.norT2Y=J,p.norT2Z=F,p.tanT2X=Q,p.tanT2Y=G,p.tanT2Z=K,p.binT2X=st,p.binT2Y=ht,p.binT2Z=et,p.norTU1X=ot,p.norTU1Y=nt,p.norTU1Z=at,p.tanTU1X=mt,p.tanTU1Y=pt,p.tanTU1Z=ut,p.binTU1X=ft,p.binTU1Y=vt,p.binTU1Z=Nt,p.norTU2X=rt,p.norTU2Y=lt,p.norTU2Z=ct,p.tanTU2X=yt,p.tanTU2Y=xt,p.tanTU2Z=dt,p.binTU2X=bt,p.binTU2Y=zt,p.binTU2Z=At,y=R*s[0]+O*s[1]+j*s[2],x=R*s[3]+O*s[4]+j*s[5],d=R*s[6]+O*s[7]+j*s[8],f=x*g-d*A,v=d*z-y*g,N=y*A-x*z,y=U*h[0]+J*h[1]+F*h[2],x=U*h[3]+J*h[4]+F*h[5],d=U*h[6]+J*h[7]+F*h[8],f+=x*S-d*k,v+=d*w-y*S,N+=y*k-x*w;var gt=1/(m+P*f+L*v+I*N);y=q*s[0]+H*s[1]+W*s[2],x=q*s[3]+H*s[4]+W*s[5],d=q*s[6]+H*s[7]+W*s[8],f=x*g-d*A,v=d*z-y*g,N=y*A-x*z,y=Q*h[0]+G*h[1]+K*h[2],x=Q*h[3]+G*h[4]+K*h[5],d=Q*h[6]+G*h[7]+K*h[8],f+=x*S-d*k,v+=d*w-y*S,N+=y*k-x*w;var wt=1/(m+E*f+D*v+_*N);y=$*s[0]+tt*s[1]+it*s[2],x=$*s[3]+tt*s[4]+it*s[5],d=$*s[6]+tt*s[7]+it*s[8],f=x*g-d*A,v=d*z-y*g,N=y*A-x*z,y=st*h[0]+ht*h[1]+et*h[2],x=st*h[3]+ht*h[4]+et*h[5],d=st*h[6]+ht*h[7]+et*h[8],f+=x*S-d*k,v+=d*w-y*S,N+=y*k-x*w;var kt=1/(m+Y*f+X*v+Z*N);if(p.norDen=gt,p.tanDen=wt,p.binDen=kt,b.warmStarted){var St=b.normalImpulse;this.lv1.x+=p.norU1X*St,this.lv1.y+=p.norU1Y*St,this.lv1.z+=p.norU1Z*St,this.av1.x+=ot*St,this.av1.y+=nt*St,this.av1.z+=at*St,this.lv2.x-=p.norU2X*St,this.lv2.y-=p.norU2Y*St,this.lv2.z-=p.norU2Z*St,this.av2.x-=rt*St,this.av2.y-=lt*St,this.av2.z-=ct*St,p.norImp=St,p.tanImp=0,p.binImp=0,C=0}else p.norImp=0,p.tanImp=0,p.binImp=0;C>-1&&(C=0);var Pt=this.restitution*-C,Lt=-(b.penetration+.005)*i*.05;Pt<Lt&&(Pt=Lt),p.norTar=Pt,p.last=u==this.num-1,p=p.next}},a.ContactConstraint.prototype.solve=function(){for(var t=this.lv1.x,i=this.lv1.y,s=this.lv1.z,h=this.lv2.x,e=this.lv2.y,o=this.lv2.z,n=this.av1.x,r=this.av1.y,l=this.av1.z,c=this.av2.x,m=this.av2.y,p=this.av2.z,u=this.cs;;){var y,x,d,f,v,N=u.norImp,b=u.tanImp,z=u.binImp,A=-N*this.friction,g=h-t,w=e-i,k=o-s;v=g*u.tanX+w*u.tanY+k*u.tanZ+c*u.tanT2X+m*u.tanT2Y+p*u.tanT2Z-n*u.tanT1X-r*u.tanT1Y-l*u.tanT1Z,y=b,x=v*u.tanDen,b+=x,v=g*u.binX+w*u.binY+k*u.binZ+c*u.binT2X+m*u.binT2Y+p*u.binT2Z-n*u.binT1X-r*u.binT1Y-l*u.binT1Z,d=z,f=v*u.binDen,z+=f;var S=b*b+z*z;if(S>A*A&&(S=A/a.sqrt(S),b*=S,z*=S),x=b-y,f=z-d,t+=u.tanU1X*x+u.binU1X*f,i+=u.tanU1Y*x+u.binU1Y*f,s+=u.tanU1Z*x+u.binU1Z*f,n+=u.tanTU1X*x+u.binTU1X*f,r+=u.tanTU1Y*x+u.binTU1Y*f,l+=u.tanTU1Z*x+u.binTU1Z*f,h-=u.tanU2X*x+u.binU2X*f,e-=u.tanU2Y*x+u.binU2Y*f,o-=u.tanU2Z*x+u.binU2Z*f,c-=u.tanTU2X*x+u.binTU2X*f,m-=u.tanTU2Y*x+u.binTU2Y*f,p-=u.tanTU2Z*x+u.binTU2Z*f,v=(h-t)*u.norX+(e-i)*u.norY+(o-s)*u.norZ+c*u.norT2X+m*u.norT2Y+p*u.norT2Z-n*u.norT1X-r*u.norT1Y-l*u.norT1Z,y=N,x=(v-u.norTar)*u.norDen,N+=x,N>0&&(N=0),x=N-y,t+=u.norU1X*x,i+=u.norU1Y*x,s+=u.norU1Z*x,n+=u.norTU1X*x,r+=u.norTU1Y*x,l+=u.norTU1Z*x,h-=u.norU2X*x,e-=u.norU2Y*x,o-=u.norU2Z*x,c-=u.norTU2X*x,m-=u.norTU2Y*x,p-=u.norTU2Z*x,u.norImp=N,u.tanImp=b,u.binImp=z,u.last)break;u=u.next}this.lv1.x=t,this.lv1.y=i,this.lv1.z=s,this.lv2.x=h,this.lv2.y=e,this.lv2.z=o,this.av1.x=n,this.av1.y=r,this.av1.z=l,this.av2.x=c,this.av2.y=m,this.av2.z=p},a.ContactConstraint.prototype.postSolve=function(){for(var t=this.cs,i=this.num;i--;){var s=this.ps[i];s.normal.x=t.norX,s.normal.y=t.norY,s.normal.z=t.norZ,s.tangent.x=t.tanX,s.tangent.y=t.tanY,s.tangent.z=t.tanZ,s.binormal.x=t.binX,s.binormal.y=t.binY,s.binormal.z=t.binZ,s.normalImpulse=t.norImp,s.tangentImpulse=t.tanImp,s.binormalImpulse=t.binImp,s.normalDenominator=t.norDen,s.tangentDenominator=t.tanDen,s.binormalDenominator=t.binDen,t=t.next}},a.ContactLink=function(t){this.prev=null,this.next=null,this.shape=null,this.body=null,this.contact=t},a.ContactManifold=function(){this.body1=null,this.body2=null,this.numPoints=0,this.points=[],this.points.length=4,this.points[0]=new a.ManifoldPoint,this.points[1]=new a.ManifoldPoint,this.points[2]=new a.ManifoldPoint,this.points[3]=new a.ManifoldPoint},a.ContactManifold.prototype={constructor:a.ContactManifold,reset:function(t,i){this.body1=t.parent,this.body2=i.parent,this.numPoints=0},addPoint:function(t,i,s,h,e,o,n,a){var r=this.points[this.numPoints++];r.position.x=t,r.position.y=i,r.position.z=s;var l=this.body1.rotation,c=t-this.body1.position.x,m=i-this.body1.position.y,p=s-this.body1.position.z,u=l.elements;r.localPoint1.x=c*u[0]+m*u[3]+p*u[6],r.localPoint1.y=c*u[1]+m*u[4]+p*u[7],r.localPoint1.z=c*u[2]+m*u[5]+p*u[8],l=this.body2.rotation,c=t-this.body2.position.x,m=i-this.body2.position.y,p=s-this.body2.position.z,r.localPoint2.x=c*u[0]+m*u[3]+p*u[6],r.localPoint2.y=c*u[1]+m*u[4]+p*u[7],r.localPoint2.z=c*u[2]+m*u[5]+p*u[8],r.normalImpulse=0,a?(r.normal.x=-h,r.normal.y=-e,r.normal.z=-o):(r.normal.x=h,r.normal.y=e,r.normal.z=o),r.penetration=n,r.warmStarted=!1}},a.ContactPointDataBuffer=function(){this.norX=NaN,this.norY=NaN,this.norZ=NaN,this.tanX=NaN,this.tanY=NaN,this.tanZ=NaN,this.binX=NaN,this.binY=NaN,this.binZ=NaN,this.rp1X=NaN,this.rp1Y=NaN,this.rp1Z=NaN,this.rp2X=NaN,this.rp2Y=NaN,this.rp2Z=NaN,this.norU1X=NaN,this.norU1Y=NaN,this.norU1Z=NaN,this.norU2X=NaN,this.norU2Y=NaN,this.norU2Z=NaN,this.tanU1X=NaN,this.tanU1Y=NaN,this.tanU1Z=NaN,this.tanU2X=NaN,this.tanU2Y=NaN,this.tanU2Z=NaN,this.binU1X=NaN,this.binU1Y=NaN,this.binU1Z=NaN,this.binU2X=NaN,this.binU2Y=NaN,this.binU2Z=NaN,this.norT1X=NaN,this.norT1Y=NaN,this.norT1Z=NaN,this.norT2X=NaN,this.norT2Y=NaN,this.norT2Z=NaN,this.tanT1X=NaN,this.tanT1Y=NaN,this.tanT1Z=NaN,this.tanT2X=NaN,this.tanT2Y=NaN,this.tanT2Z=NaN,this.binT1X=NaN,this.binT1Y=NaN,this.binT1Z=NaN,this.binT2X=NaN,this.binT2Y=NaN,this.binT2Z=NaN,this.norTU1X=NaN,this.norTU1Y=NaN,this.norTU1Z=NaN,this.norTU2X=NaN,this.norTU2Y=NaN,this.norTU2Z=NaN,this.tanTU1X=NaN,this.tanTU1Y=NaN,this.tanTU1Z=NaN,this.tanTU2X=NaN,this.tanTU2Y=NaN,this.tanTU2Z=NaN,this.binTU1X=NaN,this.binTU1Y=NaN,this.binTU1Z=NaN,this.binTU2X=NaN,this.binTU2Y=NaN,this.binTU2Z=NaN,this.norImp=NaN,this.tanImp=NaN,this.binImp=NaN,this.norDen=NaN,this.tanDen=NaN,this.binDen=NaN,this.norTar=NaN,this.next=null,this.last=!1},a.ImpulseDataBuffer=function(){this.lp1X=NaN,this.lp1Y=NaN,this.lp1Z=NaN,this.lp2X=NaN,this.lp2Y=NaN,this.lp2Z=NaN,this.impulse=NaN},a.ManifoldPoint=function(){this.warmStarted=!1,this.position=new a.Vec3,this.localPoint1=new a.Vec3,this.localPoint2=new a.Vec3,this.normal=new a.Vec3,this.tangent=new a.Vec3,this.binormal=new a.Vec3,this.normalImpulse=0,this.tangentImpulse=0,this.binormalImpulse=0,this.normalDenominator=0,this.tangentDenominator=0,this.binormalDenominator=0,this.penetration=0},a.MassInfo=function(){this.mass=0,this.inertia=new a.Mat33},a.Shape=function(t){this.type=a.SHAPE_NULL,this.id=a.nextID++,this.prev=null,this.next=null,this.proxy=null,this.parent=null,this.contactLink=null,this.numContacts=0,this.position=new a.Vec3,this.rotation=new a.Mat33,this.relativePosition=(new a.Vec3).copy(t.relativePosition),this.relativeRotation=(new a.Mat33).copy(t.relativeRotation),this.aabb=new a.AABB,this.density=t.density,this.friction=t.friction,this.restitution=t.restitution,this.belongsTo=t.belongsTo,this.collidesWith=t.collidesWith},a.Shape.prototype={constructor:a.Shape,calculateMassInfo:function(t){a.Error("Shape","Inheritance error.")},updateProxy:function(){a.Error("Shape","Inheritance error.")}},a.ShapeConfig=function(){this.relativePosition=new a.Vec3,this.relativeRotation=new a.Mat33,this.friction=.4,this.restitution=.2,this.density=1,this.belongsTo=1,this.collidesWith=4294967295},a.BoxShape=function(t,i,s,h){a.Shape.call(this,t),this.type=a.SHAPE_BOX,this.width=i,this.height=s,this.depth=h,this.halfWidth=.5*i,this.halfHeight=.5*s,this.halfDepth=.5*h,this.dimentions=new n(18),this.elements=new n(24)},a.BoxShape.prototype=Object.create(a.Shape.prototype),a.BoxShape.prototype.constructor=a.BoxShape,a.BoxShape.prototype.calculateMassInfo=function(t){var i=this.width*this.height*this.depth*this.density,s=1/12;t.mass=i,t.inertia.set(i*(this.height*this.height+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.depth*this.depth)*s,0,0,0,i*(this.width*this.width+this.height*this.height)*s)},a.BoxShape.prototype.updateProxy=function(){var t=this.rotation.elements,i=this.dimentions;i[0]=t[0],i[1]=t[3],i[2]=t[6],i[3]=t[1],i[4]=t[4],i[5]=t[7],i[6]=t[2],i[7]=t[5],i[8]=t[8],i[9]=t[0]*this.halfWidth,i[10]=t[3]*this.halfWidth,i[11]=t[6]*this.halfWidth,i[12]=t[1]*this.halfHeight,i[13]=t[4]*this.halfHeight,i[14]=t[7]*this.halfHeight,i[15]=t[2]*this.halfDepth,i[16]=t[5]*this.halfDepth,i[17]=t[8]*this.halfDepth;var s=i[9],h=i[10],e=i[11],o=i[12],n=i[13],r=i[14],l=i[15],c=i[16],m=i[17],p=this.position.x,u=this.position.y,y=this.position.z,x=this.elements;x[0]=p+s+o+l,x[1]=u+h+n+c,x[2]=y+e+r+m,x[3]=p+s+o-l,x[4]=u+h+n-c,x[5]=y+e+r-m,x[6]=p+s-o+l,x[7]=u+h-n+c,x[8]=y+e-r+m,x[9]=p+s-o-l,x[10]=u+h-n-c,x[11]=y+e-r-m,x[12]=p-s+o+l,x[13]=u-h+n+c,x[14]=y-e+r+m,x[15]=p-s+o-l,x[16]=u-h+n-c,x[17]=y-e+r-m,x[18]=p-s-o+l,x[19]=u-h-n+c,x[20]=y-e-r+m,x[21]=p-s-o-l,x[22]=u-h-n-c,x[23]=y-e-r-m;var d=i[9]<0?-i[9]:i[9],f=i[10]<0?-i[10]:i[10],v=i[11]<0?-i[11]:i[11];d=i[12]<0?d-i[12]:d+i[12],f=i[13]<0?f-i[13]:f+i[13],v=i[14]<0?v-i[14]:v+i[14],d=i[15]<0?d-i[15]:d+i[15],f=i[16]<0?f-i[16]:f+i[16],v=i[17]<0?v-i[17]:v+i[17];var N=a.AABB_PROX;this.aabb.set(this.position.x-d-N,this.position.x+d+N,this.position.y-f-N,this.position.y+f+N,this.position.z-v-N,this.position.z+v+N),null!=this.proxy&&this.proxy.update()},a.SphereShape=function(t,i){a.Shape.call(this,t),this.type=a.SHAPE_SPHERE,this.radius=i},a.SphereShape.prototype=Object.create(a.Shape.prototype),a.SphereShape.prototype.constructor=a.SphereShape,a.SphereShape.prototype.calculateMassInfo=function(t){var i=1.333*a.PI*this.radius*this.radius*this.radius*this.density;t.mass=i;var s=i*this.radius*this.radius*.4;t.inertia.set(s,0,0,0,s,0,0,0,s)},a.SphereShape.prototype.updateProxy=function(){var t=a.AABB_PROX;this.aabb.set(this.position.x-this.radius-t,this.position.x+this.radius+t,this.position.y-this.radius-t,this.position.y+this.radius+t,this.position.z-this.radius-t,this.position.z+this.radius+t),null!=this.proxy&&this.proxy.update()},a.CylinderShape=function(t,i,s){a.Shape.call(this,t),this.type=a.SHAPE_CYLINDER,this.radius=i,this.height=s,this.halfHeight=.5*s,this.normalDirection=new a.Vec3,this.halfDirection=new a.Vec3},a.CylinderShape.prototype=Object.create(a.Shape.prototype),a.CylinderShape.prototype.constructor=a.CylinderShape,a.CylinderShape.prototype.calculateMassInfo=function(t){var i=this.radius*this.radius,s=a.PI*i*this.height*this.density,h=(.25*i+.0833*this.height*this.height)*s,e=.5*i;t.mass=s,t.inertia.set(h,0,0,0,e,0,0,0,h)},a.CylinderShape.prototype.updateProxy=function(){var t,i,s,h,e,o,n,r,l,c,m,p=this.rotation.elements;e=p[1]*p[1],o=p[4]*p[4],n=p[7]*p[7],this.normalDirection.set(p[1],p[4],p[7]),this.halfDirection.scale(this.normalDirection,this.halfHeight),i=1-e,t=a.sqrt(i*i+e*o+e*n),t>0&&(t=this.radius/t),i*=t,s=1-o,t=a.sqrt(o*e+s*s+o*n),t>0&&(t=this.radius/t),s*=t,h=1-n,t=a.sqrt(n*e+n*o+h*h),t>0&&(t=this.radius/t),h*=t,r=this.halfDirection.x<0?-this.halfDirection.x:this.halfDirection.x,l=this.halfDirection.y<0?-this.halfDirection.y:this.halfDirection.y,c=this.halfDirection.z<0?-this.halfDirection.z:this.halfDirection.z,r=i<0?r-i:r+i,l=s<0?l-s:l+s,c=h<0?c-h:c+h,m=a.AABB_PROX,this.aabb.set(this.position.x-r-m,this.position.x+r+m,this.position.y-l-m,this.position.y+l+m,this.position.z-c-m,this.position.z+c+m),null!=this.proxy&&this.proxy.update()},a.TetraShape=function(t,i,s,e,o){a.Shape.call(this,t),this.type=a.SHAPE_TETRA,this.verts=[i,s,e,o],this.faces=[h(0,1,2),h(1,2,3),h(2,3,4),h(4,0,1)]},a.TetraShape.prototype=Object.create(a.Shape.prototype),a.TetraShape.prototype.constructor=a.TetraShape,a.TetraShape.prototype.calculateMassInfo=function(){},a.TetraShape.prototype.updateProxy=function(){this.aabb.setFromPoints(this.verts),null!==this.proxy&&this.proxy.update()},a.CollisionDetector=function(){this.flip=!1},a.CollisionDetector.prototype={constructor:a.CollisionDetector,detectCollision:function(t,i,s){a.Error("CollisionDetector","Inheritance error.")}},a.BoxBoxCollisionDetector=function(){a.CollisionDetector.call(this),this.clipVertices1=new n(24),this.clipVertices2=new n(24),this.used=new n(8),this.INF=1/0},a.BoxBoxCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.BoxBoxCollisionDetector.prototype.constructor=a.BoxBoxCollisionDetector,a.BoxBoxCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var o,n,r,l,c,m,p,u,y,x,d,f,v,N,b,z,A,g,w,k,S,P,L,I,M,T,V,C,E,D,_,B,Y,X,Z,R,O=h.elements,j=e.elements,U=h.dimentions,J=e.dimentions,F=h.position,q=e.position,H=F.x,W=F.y,Q=F.z,G=q.x,K=q.y,$=q.z,tt=G-H,it=K-W,st=$-Q,ht=h.halfWidth,et=h.halfHeight,ot=h.halfDepth,nt=e.halfWidth,at=e.halfHeight,rt=e.halfDepth,lt=U[0],ct=U[1],mt=U[2],pt=U[3],ut=U[4],yt=U[5],xt=U[6],dt=U[7],ft=U[8],vt=U[9],Nt=U[10],bt=U[11],zt=U[12],At=U[13],gt=U[14],wt=U[15],kt=U[16],St=U[17],Pt=J[0],Lt=J[1],It=J[2],Mt=J[3],Tt=J[4],Vt=J[5],Ct=J[6],Et=J[7],Dt=J[8],_t=J[9],Bt=J[10],Yt=J[11],Xt=J[12],Zt=J[13],Rt=J[14],Ot=J[15],jt=J[16],Ut=J[17],Jt=ct*It-mt*Lt,Ft=mt*Pt-lt*It,qt=lt*Lt-ct*Pt,Ht=ct*Vt-mt*Tt,Wt=mt*Mt-lt*Vt,Qt=lt*Tt-ct*Mt,Gt=ct*Dt-mt*Et,Kt=mt*Ct-lt*Dt,$t=lt*Et-ct*Ct,ti=ut*It-yt*Lt,ii=yt*Pt-pt*It,si=pt*Lt-ut*Pt,hi=ut*Vt-yt*Tt,ei=yt*Mt-pt*Vt,oi=pt*Tt-ut*Mt,ni=ut*Dt-yt*Et,ai=yt*Ct-pt*Dt,ri=pt*Et-ut*Ct,li=dt*It-ft*Lt,ci=ft*Pt-xt*It,mi=xt*Lt-dt*Pt,pi=dt*Vt-ft*Tt,ui=ft*Mt-xt*Vt,yi=xt*Tt-dt*Mt,xi=dt*Dt-ft*Et,di=ft*Ct-xt*Dt,fi=xt*Et-dt*Ct,vi=!1,Ni=!1,bi=!1,zi=!1,Ai=!1,gi=!1,wi=!1,ki=!1,Si=!1;if(_=lt*tt+ct*it+mt*st,o=_>0,o||(_=-_),B=ht,X=lt*Pt+ct*Lt+mt*It,Z=lt*Mt+ct*Tt+mt*Vt,R=lt*Ct+ct*Et+mt*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),Y=X*nt+Z*at+R*rt,!((z=_-B-Y)>0||(_=pt*tt+ut*it+yt*st,n=_>0,n||(_=-_),B=et,X=pt*Pt+ut*Lt+yt*It,Z=pt*Mt+ut*Tt+yt*Vt,R=pt*Ct+ut*Et+yt*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),Y=X*nt+Z*at+R*rt,(A=_-B-Y)>0||(_=xt*tt+dt*it+ft*st,r=_>0,r||(_=-_),B=ot,X=xt*Pt+dt*Lt+ft*It,Z=xt*Mt+dt*Tt+ft*Vt,R=xt*Ct+dt*Et+ft*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),Y=X*nt+Z*at+R*rt,(g=_-B-Y)>0||(_=Pt*tt+Lt*it+It*st,l=_>0,l||(_=-_),X=Pt*lt+Lt*ct+It*mt,Z=Pt*pt+Lt*ut+It*yt,R=Pt*xt+Lt*dt+It*ft,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),B=X*ht+Z*et+R*ot,Y=nt,(w=1*(_-B-Y))>0||(_=Mt*tt+Tt*it+Vt*st,c=_>0,c||(_=-_),X=Mt*lt+Tt*ct+Vt*mt,Z=Mt*pt+Tt*ut+Vt*yt,R=Mt*xt+Tt*dt+Vt*ft,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),B=X*ht+Z*et+R*ot,Y=at,(k=1*(_-B-Y))>0||(_=Ct*tt+Et*it+Dt*st,m=_>0,m||(_=-_),X=Ct*lt+Et*ct+Dt*mt,Z=Ct*pt+Et*ut+Dt*yt,R=Ct*xt+Et*dt+Dt*ft,X<0&&(X=-X),Z<0&&(Z=-Z),R<0&&(R=-R),B=X*ht+Z*et+R*ot,Y=rt,(S=1*(_-B-Y))>0))))))){if((_=Jt*Jt+Ft*Ft+qt*qt)>1e-5){if(_=1/a.sqrt(_),Jt*=_,Ft*=_,qt*=_,_=Jt*tt+Ft*it+qt*st,p=_>0,p||(_=-_),X=Jt*pt+Ft*ut+qt*yt,Z=Jt*xt+Ft*dt+qt*ft,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*et+Z*ot,X=Jt*Mt+Ft*Tt+qt*Vt,Z=Jt*Ct+Ft*Et+qt*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*rt,(P=_-B-Y)>0)return}else p=!1,P=0,vi=!0;if((_=Ht*Ht+Wt*Wt+Qt*Qt)>1e-5){if(_=1/a.sqrt(_),Ht*=_,Wt*=_,Qt*=_,_=Ht*tt+Wt*it+Qt*st,u=_>0,u||(_=-_),X=Ht*pt+Wt*ut+Qt*yt,Z=Ht*xt+Wt*dt+Qt*ft,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*et+Z*ot,X=Ht*Pt+Wt*Lt+Qt*It,Z=Ht*Ct+Wt*Et+Qt*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*rt,(L=_-B-Y)>0)return}else u=!1,L=0,Ni=!0;if((_=Gt*Gt+Kt*Kt+$t*$t)>1e-5){if(_=1/a.sqrt(_),Gt*=_,Kt*=_,$t*=_,_=Gt*tt+Kt*it+$t*st,y=_>0,y||(_=-_),X=Gt*pt+Kt*ut+$t*yt,Z=Gt*xt+Kt*dt+$t*ft,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*et+Z*ot,X=Gt*Pt+Kt*Lt+$t*It,Z=Gt*Mt+Kt*Tt+$t*Vt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*at,(I=_-B-Y)>0)return}else y=!1,I=0,bi=!0;if((_=ti*ti+ii*ii+si*si)>1e-5){if(_=1/a.sqrt(_),ti*=_,ii*=_,si*=_,_=ti*tt+ii*it+si*st,x=_>0,x||(_=-_),X=ti*lt+ii*ct+si*mt,Z=ti*xt+ii*dt+si*ft,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*ht+Z*ot,X=ti*Mt+ii*Tt+si*Vt,Z=ti*Ct+ii*Et+si*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*rt,(M=_-B-Y)>0)return}else x=!1,M=0,zi=!0;if((_=hi*hi+ei*ei+oi*oi)>1e-5){if(_=1/a.sqrt(_),hi*=_,ei*=_,oi*=_,_=hi*tt+ei*it+oi*st,d=_>0,d||(_=-_),X=hi*lt+ei*ct+oi*mt,Z=hi*xt+ei*dt+oi*ft,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*ht+Z*ot,X=hi*Pt+ei*Lt+oi*It,Z=hi*Ct+ei*Et+oi*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*rt,(T=_-B-Y)>0)return}else d=!1,T=0,Ai=!0;if((_=ni*ni+ai*ai+ri*ri)>1e-5){if(_=1/a.sqrt(_),ni*=_,ai*=_,ri*=_,_=ni*tt+ai*it+ri*st,f=_>0,f||(_=-_),X=ni*lt+ai*ct+ri*mt,Z=ni*xt+ai*dt+ri*ft,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*ht+Z*ot,X=ni*Pt+ai*Lt+ri*It,Z=ni*Mt+ai*Tt+ri*Vt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*at,(V=_-B-Y)>0)return}else f=!1,V=0,gi=!0;if((_=li*li+ci*ci+mi*mi)>1e-5){if(_=1/a.sqrt(_),li*=_,ci*=_,mi*=_,_=li*tt+ci*it+mi*st,v=_>0,v||(_=-_),X=li*lt+ci*ct+mi*mt,Z=li*pt+ci*ut+mi*yt,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*ht+Z*et,X=li*Mt+ci*Tt+mi*Vt,Z=li*Ct+ci*Et+mi*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*at+Z*rt,(C=_-B-Y)>0)return}else v=!1,C=0,wi=!0;if((_=pi*pi+ui*ui+yi*yi)>1e-5){if(_=1/a.sqrt(_),pi*=_,ui*=_,yi*=_,_=pi*tt+ui*it+yi*st,N=_>0,N||(_=-_),X=pi*lt+ui*ct+yi*mt,Z=pi*pt+ui*ut+yi*yt,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*ht+Z*et,X=pi*Pt+ui*Lt+yi*It,Z=pi*Ct+ui*Et+yi*Dt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*rt,(E=_-B-Y)>0)return}else N=!1,E=0,ki=!0;if((_=xi*xi+di*di+fi*fi)>1e-5){if(_=1/a.sqrt(_),xi*=_,di*=_,fi*=_,_=xi*tt+di*it+fi*st,b=_>0,b||(_=-_),X=xi*lt+di*ct+fi*mt,Z=xi*pt+di*ut+fi*yt,X<0&&(X=-X),Z<0&&(Z=-Z),B=X*ht+Z*et,X=xi*Pt+di*Lt+fi*It,Z=xi*Mt+di*Tt+fi*Vt,X<0&&(X=-X),Z<0&&(Z=-Z),Y=X*nt+Z*at,(D=_-B-Y)>0)return}else b=!1,D=0,Si=!0;var Pi=z,Li=z,Ii=0,Mi=o;A>Li&&(Pi=A,Li=A,Ii=1,Mi=n),g>Li&&(Pi=g,Li=g,Ii=2,Mi=r),w>Li&&(Pi=w,Li=w,Ii=3,Mi=l),k>Li&&(Pi=k,Li=k,Ii=4,Mi=c),S>Li&&(Pi=S,Li=S,Ii=5,Mi=m),P-.01>Li&&!vi&&(Pi=P,Li=P-.01,Ii=6,Mi=p),L-.01>Li&&!Ni&&(Pi=L,Li=L-.01,Ii=7,Mi=u),I-.01>Li&&!bi&&(Pi=I,Li=I-.01,Ii=8,Mi=y),M-.01>Li&&!zi&&(Pi=M,Li=M-.01,Ii=9,Mi=x),T-.01>Li&&!Ai&&(Pi=T,Li=T-.01,Ii=10,Mi=d),V-.01>Li&&!gi&&(Pi=V,Li=V-.01,Ii=11,Mi=f),C-.01>Li&&!wi&&(Pi=C,Li=C-.01,Ii=12,Mi=v),E-.01>Li&&!ki&&(Pi=E,Li=E-.01,Ii=13,Mi=N),D-.01>Li&&!Si&&(Pi=D,Ii=14,Mi=b);var Ti=0,Vi=0,Ci=0,Ei=0,Di=0,_i=0,Bi=0,Yi=0,Xi=0,Zi=0,Ri=0,Oi=0,ji=0,Ui=0,Ji=0,Fi=0,qi=0,Hi=0,Wi=!1;0==Ii?(Mi?(Zi=H+vt,Ri=W+Nt,Oi=Q+bt,Ti=lt,Vi=ct,Ci=mt):(Zi=H-vt,Ri=W-Nt,Oi=Q-bt,Ti=-lt,Vi=-ct,Ci=-mt),ji=zt,Ui=At,Ji=gt,Ei=-pt,Di=-ut,_i=-yt,Fi=wt,qi=kt,Hi=St,Bi=-xt,Yi=-dt,Xi=-ft):1==Ii?(Mi?(Zi=H+zt,Ri=W+At,Oi=Q+gt,Ti=pt,Vi=ut,Ci=yt):(Zi=H-zt,Ri=W-At,Oi=Q-gt,Ti=-pt,Vi=-ut,Ci=-yt),ji=vt,Ui=Nt,Ji=bt,Ei=-lt,Di=-ct,_i=-mt,Fi=wt,qi=kt,Hi=St,Bi=-xt,Yi=-dt,Xi=-ft):2==Ii?(Mi?(Zi=H+wt,Ri=W+kt,Oi=Q+St,Ti=xt,Vi=dt,Ci=ft):(Zi=H-wt,Ri=W-kt,Oi=Q-St,Ti=-xt,Vi=-dt,Ci=-ft),ji=vt,Ui=Nt,Ji=bt,Ei=-lt,Di=-ct,_i=-mt,Fi=zt,qi=At,Hi=gt,Bi=-pt,Yi=-ut,Xi=-yt):3==Ii?(Wi=!0,Mi?(Zi=G-_t,Ri=K-Bt,Oi=$-Yt,Ti=-Pt,Vi=-Lt,Ci=-It):(Zi=G+_t,Ri=K+Bt,Oi=$+Yt,Ti=Pt,Vi=Lt,Ci=It),ji=Xt,Ui=Zt,Ji=Rt,Ei=-Mt,Di=-Tt,_i=-Vt,Fi=Ot,qi=jt,Hi=Ut,Bi=-Ct,Yi=-Et,Xi=-Dt):4==Ii?(Wi=!0,Mi?(Zi=G-Xt,Ri=K-Zt,Oi=$-Rt,Ti=-Mt,Vi=-Tt,Ci=-Vt):(Zi=G+Xt,Ri=K+Zt,Oi=$+Rt,Ti=Mt,Vi=Tt,Ci=Vt),ji=_t,Ui=Bt,Ji=Yt,Ei=-Pt,Di=-Lt,_i=-It,Fi=Ot,qi=jt,Hi=Ut,Bi=-Ct,Yi=-Et,Xi=-Dt):5==Ii?(Wi=!0,Mi?(Zi=G-Ot,Ri=K-jt,Oi=$-Ut,Ti=-Ct,Vi=-Et,Ci=-Dt):(Zi=G+Ot,Ri=K+jt,Oi=$+Ut,Ti=Ct,Vi=Et,Ci=Dt),ji=_t,Ui=Bt,Ji=Yt,Ei=-Pt,Di=-Lt,_i=-It,Fi=Xt,qi=Zt,Hi=Rt,Bi=-Mt,Yi=-Tt,Xi=-Vt):6==Ii?(Ti=Jt,Vi=Ft,Ci=qt,Ei=lt,Di=ct,_i=mt,Bi=Pt,Yi=Lt,Xi=It):7==Ii?(Ti=Ht,Vi=Wt,Ci=Qt,Ei=lt,Di=ct,_i=mt,Bi=Mt,Yi=Tt,Xi=Vt):8==Ii?(Ti=Gt,Vi=Kt,Ci=$t,Ei=lt,Di=ct,_i=mt,Bi=Ct,Yi=Et,Xi=Dt):9==Ii?(Ti=ti,Vi=ii,Ci=si,Ei=pt,Di=ut,_i=yt,Bi=Pt,Yi=Lt,Xi=It):10==Ii?(Ti=hi,Vi=ei,Ci=oi,Ei=pt,Di=ut,_i=yt,Bi=Mt,Yi=Tt,Xi=Vt):11==Ii?(Ti=ni,Vi=ai,Ci=ri,Ei=pt,Di=ut,_i=yt,Bi=Ct,Yi=Et,Xi=Dt):12==Ii?(Ti=li,Vi=ci,Ci=mi,Ei=xt,Di=dt,_i=ft,Bi=Pt,Yi=Lt,Xi=It):13==Ii?(Ti=pi,Vi=ui,Ci=yi,Ei=xt,Di=dt,_i=ft,Bi=Mt,Yi=Tt,Xi=Vt):14==Ii&&(Ti=xi,Vi=di,Ci=fi,Ei=xt,Di=dt,_i=ft,Bi=Ct,Yi=Et,Xi=Dt);if(Ii>5){Mi||(Ti=-Ti,Vi=-Vi,Ci=-Ci);var Qi,Gi,Ki,$i,ts,is,ss,hs,es,os,ns;is=O[0],ss=O[1],hs=O[2],Gi=Ti*is+Vi*ss+Ci*hs,Ki=O[3],$i=O[4],ts=O[5],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=O[6],$i=O[7],ts=O[8],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=O[9],$i=O[10],ts=O[11],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=O[12],$i=O[13],ts=O[14],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=O[15],$i=O[16],ts=O[17],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=O[18],$i=O[19],ts=O[20],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),Ki=O[21],$i=O[22],ts=O[23],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi>Gi&&(Gi=Qi,is=Ki,ss=$i,hs=ts),es=j[0],os=j[1],ns=j[2],Gi=Ti*es+Vi*os+Ci*ns,Ki=j[3],$i=j[4],ts=j[5],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=j[6],$i=j[7],ts=j[8],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=j[9],$i=j[10],ts=j[11],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=j[12],$i=j[13],ts=j[14],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=j[15],$i=j[16],ts=j[17],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=j[18],$i=j[19],ts=j[20],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=j[21],$i=j[22],ts=j[23],Qi=Ti*Ki+Vi*$i+Ci*ts,Qi<Gi&&(Gi=Qi,es=Ki,os=$i,ns=ts),Ki=es-is,$i=os-ss,ts=ns-hs,X=Ei*Bi+Di*Yi+_i*Xi;var as=(Ki*(Ei-Bi*X)+$i*(Di-Yi*X)+ts*(_i-Xi*X))/(1-X*X);return void s.addPoint(is+Ei*as+Ti*Pi*.5,ss+Di*as+Vi*Pi*.5,hs+_i*as+Ci*Pi*.5,Ti,Vi,Ci,Pi,!1)}var rs,ls,cs,ms,ps,us,ys,xs,ds,fs,vs,Ns,bs=1,zs=0,As=0;Wi?(zs=lt*Ti+ct*Vi+mt*Ci,zs<bs&&(bs=zs,As=0),-zs<bs&&(bs=-zs,As=1),zs=pt*Ti+ut*Vi+yt*Ci,zs<bs&&(bs=zs,As=2),-zs<bs&&(bs=-zs,As=3),zs=xt*Ti+dt*Vi+ft*Ci,zs<bs&&(bs=zs,As=4),-zs<bs&&(bs=-zs,As=5),0==As?(rs=O[0],ls=O[1],cs=O[2],ms=O[6],ps=O[7],us=O[8],ys=O[9],xs=O[10],ds=O[11],fs=O[3],vs=O[4],Ns=O[5]):1==As?(rs=O[15],ls=O[16],cs=O[17],ms=O[21],ps=O[22],us=O[23],ys=O[18],xs=O[19],ds=O[20],fs=O[12],vs=O[13],Ns=O[14]):2==As?(rs=O[12],ls=O[13],cs=O[14],ms=O[0],ps=O[1],us=O[2],ys=O[3],xs=O[4],ds=O[5],fs=O[15],vs=O[16],Ns=O[17]):3==As?(rs=O[21],ls=O[22],cs=O[23],ms=O[9],ps=O[10],us=O[11],ys=O[6],xs=O[7],ds=O[8],fs=O[18],vs=O[19],Ns=O[20]):4==As?(rs=O[12],ls=O[13],cs=O[14],ms=O[18],ps=O[19],us=O[20],ys=O[6],xs=O[7],ds=O[8],fs=O[0],vs=O[1],Ns=O[2]):5==As&&(rs=O[3],ls=O[4],cs=O[5],ms=O[6],ps=O[7],us=O[8],ys=O[21],xs=O[22],ds=O[23],fs=O[15],vs=O[16],Ns=O[17])):(zs=Pt*Ti+Lt*Vi+It*Ci,zs<bs&&(bs=zs,As=0),-zs<bs&&(bs=-zs,As=1),zs=Mt*Ti+Tt*Vi+Vt*Ci,zs<bs&&(bs=zs,As=2),-zs<bs&&(bs=-zs,As=3),zs=Ct*Ti+Et*Vi+Dt*Ci,zs<bs&&(bs=zs,As=4),-zs<bs&&(bs=-zs,As=5),0==As?(rs=j[0],ls=j[1],cs=j[2],ms=j[6],ps=j[7],us=j[8],ys=j[9],xs=j[10],ds=j[11],fs=j[3],vs=j[4],Ns=j[5]):1==As?(rs=j[15],ls=j[16],cs=j[17],ms=j[21],ps=j[22],us=j[23],ys=j[18],xs=j[19],ds=j[20],fs=j[12],vs=j[13],Ns=j[14]):2==As?(rs=j[12],ls=j[13],cs=j[14],ms=j[0],ps=j[1],us=j[2],ys=j[3],xs=j[4],ds=j[5],fs=j[15],vs=j[16],Ns=j[17]):3==As?(rs=j[21],ls=j[22],cs=j[23],ms=j[9],ps=j[10],us=j[11],ys=j[6],xs=j[7],ds=j[8],fs=j[18],vs=j[19],Ns=j[20]):4==As?(rs=j[12],ls=j[13],cs=j[14],ms=j[18],ps=j[19],us=j[20],ys=j[6],xs=j[7],ds=j[8],fs=j[0],vs=j[1],Ns=j[2]):5==As&&(rs=j[3],ls=j[4],cs=j[5],ms=j[9],ps=j[10],us=j[11],ys=j[21],xs=j[22],ds=j[23],fs=j[15],vs=j[16],Ns=j[17]));var gs,ws,ks,Ss,Ps,Ls,Is,Ms,Ts;this.clipVertices1[0]=rs,this.clipVertices1[1]=ls,this.clipVertices1[2]=cs,this.clipVertices1[3]=ms,this.clipVertices1[4]=ps,this.clipVertices1[5]=us,this.clipVertices1[6]=ys,this.clipVertices1[7]=xs,this.clipVertices1[8]=ds,this.clipVertices1[9]=fs,this.clipVertices1[10]=vs,this.clipVertices1[11]=Ns,ws=0,Ss=this.clipVertices1[9],Ps=this.clipVertices1[10],Ls=this.clipVertices1[11],X=(Ss-Zi-ji)*Ei+(Ps-Ri-Ui)*Di+(Ls-Oi-Ji)*_i;for(var Vs=0;Vs<4;Vs++)ks=3*Vs,Is=this.clipVertices1[ks],Ms=this.clipVertices1[ks+1],Ts=this.clipVertices1[ks+2],Z=(Is-Zi-ji)*Ei+(Ms-Ri-Ui)*Di+(Ts-Oi-Ji)*_i,X>0?Z>0?(ks=3*ws,ws++,this.clipVertices2[ks]=Is,this.clipVertices2[ks+1]=Ms,this.clipVertices2[ks+2]=Ts):(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices2[ks]=Ss+(Is-Ss)*as,this.clipVertices2[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices2[ks+2]=Ls+(Ts-Ls)*as):Z>0&&(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices2[ks]=Ss+(Is-Ss)*as,this.clipVertices2[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices2[ks+2]=Ls+(Ts-Ls)*as,ks=3*ws,ws++,this.clipVertices2[ks]=Is,this.clipVertices2[ks+1]=Ms,this.clipVertices2[ks+2]=Ts),Ss=Is,Ps=Ms,Ls=Ts,X=Z;if(0!=(gs=ws)){for(ws=0,ks=3*(gs-1),Ss=this.clipVertices2[ks],Ps=this.clipVertices2[ks+1],Ls=this.clipVertices2[ks+2],X=(Ss-Zi-Fi)*Bi+(Ps-Ri-qi)*Yi+(Ls-Oi-Hi)*Xi,Vs=0;Vs<gs;Vs++)ks=3*Vs,Is=this.clipVertices2[ks],Ms=this.clipVertices2[ks+1],Ts=this.clipVertices2[ks+2],Z=(Is-Zi-Fi)*Bi+(Ms-Ri-qi)*Yi+(Ts-Oi-Hi)*Xi,X>0?Z>0?(ks=3*ws,ws++,this.clipVertices1[ks]=Is,this.clipVertices1[ks+1]=Ms,this.clipVertices1[ks+2]=Ts):(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices1[ks]=Ss+(Is-Ss)*as,this.clipVertices1[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices1[ks+2]=Ls+(Ts-Ls)*as):Z>0&&(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices1[ks]=Ss+(Is-Ss)*as,this.clipVertices1[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices1[ks+2]=Ls+(Ts-Ls)*as,ks=3*ws,ws++,this.clipVertices1[ks]=Is,this.clipVertices1[ks+1]=Ms,this.clipVertices1[ks+2]=Ts),Ss=Is,Ps=Ms,Ls=Ts,X=Z;if(0!=(gs=ws)){for(ws=0,ks=3*(gs-1),Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],X=(Ss-Zi+ji)*-Ei+(Ps-Ri+Ui)*-Di+(Ls-Oi+Ji)*-_i,Vs=0;Vs<gs;Vs++)ks=3*Vs,Is=this.clipVertices1[ks],Ms=this.clipVertices1[ks+1],Ts=this.clipVertices1[ks+2],Z=(Is-Zi+ji)*-Ei+(Ms-Ri+Ui)*-Di+(Ts-Oi+Ji)*-_i,X>0?Z>0?(ks=3*ws,ws++,this.clipVertices2[ks]=Is,this.clipVertices2[ks+1]=Ms,this.clipVertices2[ks+2]=Ts):(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices2[ks]=Ss+(Is-Ss)*as,this.clipVertices2[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices2[ks+2]=Ls+(Ts-Ls)*as):Z>0&&(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices2[ks]=Ss+(Is-Ss)*as,this.clipVertices2[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices2[ks+2]=Ls+(Ts-Ls)*as,ks=3*ws,ws++,this.clipVertices2[ks]=Is,this.clipVertices2[ks+1]=Ms,this.clipVertices2[ks+2]=Ts),Ss=Is,Ps=Ms,Ls=Ts,X=Z;if(0!=(gs=ws)){for(ws=0,ks=3*(gs-1),Ss=this.clipVertices2[ks],Ps=this.clipVertices2[ks+1],Ls=this.clipVertices2[ks+2],X=(Ss-Zi+Fi)*-Bi+(Ps-Ri+qi)*-Yi+(Ls-Oi+Hi)*-Xi,Vs=0;Vs<gs;Vs++)ks=3*Vs,Is=this.clipVertices2[ks],Ms=this.clipVertices2[ks+1],Ts=this.clipVertices2[ks+2],Z=(Is-Zi+Fi)*-Bi+(Ms-Ri+qi)*-Yi+(Ts-Oi+Hi)*-Xi,X>0?Z>0?(ks=3*ws,ws++,this.clipVertices1[ks]=Is,this.clipVertices1[ks+1]=Ms,this.clipVertices1[ks+2]=Ts):(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices1[ks]=Ss+(Is-Ss)*as,this.clipVertices1[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices1[ks+2]=Ls+(Ts-Ls)*as):Z>0&&(ks=3*ws,ws++,as=X/(X-Z),this.clipVertices1[ks]=Ss+(Is-Ss)*as,this.clipVertices1[ks+1]=Ps+(Ms-Ps)*as,this.clipVertices1[ks+2]=Ls+(Ts-Ls)*as,ks=3*ws,ws++,this.clipVertices1[ks]=Is,this.clipVertices1[ks+1]=Ms,this.clipVertices1[ks+2]=Ts),Ss=Is,Ps=Ms,Ls=Ts,X=Z;if(gs=ws,Wi){var Cs=h;h=e,e=Cs}if(0!=gs){var Es=h!=t;if(gs>4){Ss=.25*(rs+ms+ys+fs),Ps=.25*(ls+ps+xs+vs),Ls=.25*(cs+us+ds+Ns),Ei=rs-Ss,Di=ls-Ps,_i=cs-Ls,Bi=ms-Ss,Yi=ps-Ps,Xi=us-Ls;var Ds=0,_s=0,Bs=0,Ys=0,Xs=-this.INF;for(bs=this.INF,Vs=0;Vs<gs;Vs++)this.used[Vs]=!1,ks=3*Vs,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],zs=Ss*Ei+Ps*Di+Ls*_i,zs<bs&&(bs=zs,Ds=Vs),zs>Xs&&(Xs=zs,Bs=Vs);for(this.used[Ds]=!0,this.used[Bs]=!0,Xs=-this.INF,bs=this.INF,Vs=0;Vs<gs;Vs++)this.used[Vs]||(ks=3*Vs,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],zs=Ss*Bi+Ps*Yi+Ls*Xi,zs<bs&&(bs=zs,_s=Vs),zs>Xs&&(Xs=zs,Ys=Vs));ks=3*Ds,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],zs=(Ss-Zi)*Ti+(Ps-Ri)*Vi+(Ls-Oi)*Ci,zs<0&&s.addPoint(Ss,Ps,Ls,Ti,Vi,Ci,zs,Es),ks=3*_s,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],zs=(Ss-Zi)*Ti+(Ps-Ri)*Vi+(Ls-Oi)*Ci,zs<0&&s.addPoint(Ss,Ps,Ls,Ti,Vi,Ci,zs,Es),ks=3*Bs,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],zs=(Ss-Zi)*Ti+(Ps-Ri)*Vi+(Ls-Oi)*Ci,zs<0&&s.addPoint(Ss,Ps,Ls,Ti,Vi,Ci,zs,Es),ks=3*Ys,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],zs=(Ss-Zi)*Ti+(Ps-Ri)*Vi+(Ls-Oi)*Ci,zs<0&&s.addPoint(Ss,Ps,Ls,Ti,Vi,Ci,zs,Es)}else for(Vs=0;Vs<gs;Vs++)ks=3*Vs,Ss=this.clipVertices1[ks],Ps=this.clipVertices1[ks+1],Ls=this.clipVertices1[ks+2],(zs=(Ss-Zi)*Ti+(Ps-Ri)*Vi+(Ls-Oi)*Ci)<0&&s.addPoint(Ss,Ps,Ls,Ti,Vi,Ci,zs,Es)}}}}}},a.SphereBoxCollisionDetector=function(t){a.CollisionDetector.call(this),this.flip=t},a.SphereBoxCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.SphereBoxCollisionDetector.prototype.constructor=a.SphereBoxCollisionDetector,a.SphereBoxCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o,n,r,l,c,m=e.dimentions,p=h.position,u=p.x,y=p.y,x=p.z,d=e.position,f=d.x,v=d.y,N=d.z,b=h.radius,z=e.halfWidth,A=e.halfHeight,g=e.halfDepth,w=u-f,k=y-v,S=x-N,P=m[0]*w+m[1]*k+m[2]*S,L=m[3]*w+m[4]*k+m[5]*S,I=m[6]*w+m[7]*k+m[8]*S,M=0;P>z?P=z:P<-z?P=-z:M=1,L>A?L=A:L<-A?L=-A:M|=2,I>g?I=g:I<-g?I=-g:M|=4,7==M?(w=P<0?z+P:z-P,k=L<0?A+L:A-L,S=I<0?g+I:g-I,w<k?w<S?(l=w-z,P<0?(P=-z,w=m[0],k=m[1],S=m[2]):(P=z,w=-m[0],k=-m[1],S=-m[2])):(l=S-g,I<0?(I=-g,w=m[6],k=m[7],S=m[8]):(I=g,w=-m[6],k=-m[7],S=-m[8])):k<S?(l=k-A,L<0?(L=-A,w=m[3],k=m[4],S=m[5]):(L=A,w=-m[3],k=-m[4],S=-m[5])):(l=S-g,I<0?(I=-g,w=m[6],k=m[7],S=m[8]):(I=g,w=-m[6],k=-m[7],S=-m[8])),o=f+P*m[0]+L*m[3]+I*m[6],n=v+P*m[1]+L*m[4]+I*m[7],r=N+P*m[2]+L*m[5]+I*m[8],s.addPoint(u+b*w,y+b*k,x+b*S,w,k,S,l-b,this.flip)):(o=f+P*m[0]+L*m[3]+I*m[6],n=v+P*m[1]+L*m[4]+I*m[7],r=N+P*m[2]+L*m[5]+I*m[8],w=o-p.x,k=n-p.y,S=r-p.z,(l=w*w+k*k+S*S)>0&&l<b*b&&(l=a.sqrt(l),c=1/l,w*=c,k*=c,S*=c,s.addPoint(u+b*w,y+b*k,x+b*S,w,k,S,l-b,this.flip)))},a.SphereSphereCollisionDetector=function(){a.CollisionDetector.call(this)},a.SphereSphereCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.SphereSphereCollisionDetector.prototype.constructor=a.SphereSphereCollisionDetector,a.SphereSphereCollisionDetector.prototype.detectCollision=function(t,i,s){var h=t,e=i,o=h.position,n=e.position,r=n.x-o.x,l=n.y-o.y,c=n.z-o.z,m=r*r+l*l+c*c,p=h.radius,u=e.radius,y=p+u;if(m>0&&m<y*y){m=a.sqrt(m);var x=1/m;r*=x,l*=x,c*=x,s.addPoint(o.x+r*p,o.y+l*p,o.z+c*p,r,l,c,m-y,!1)}},a.BoxCylinderCollisionDetector=function(t){a.CollisionDetector.call(this),this.flip=t},a.BoxCylinderCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.BoxCylinderCollisionDetector.prototype.constructor=a.BoxCylinderCollisionDetector,a.BoxCylinderCollisionDetector.prototype.getSep=function(t,i,s,h,e){var o,n,r,l,c,m,p,u,y,x,d,f,v,N=new a.Vec3,b=t.position.x,z=t.position.y,A=t.position.z,g=i.position.x,w=i.position.y,k=i.position.z,S=g-b,P=w-z,L=k-A;S*S+P*P+L*L==0&&(P=.001);var I=-S,M=-P,T=-L;this.supportPointB(t,-I,-M,-T,N);var V=N.x,C=N.y,E=N.z;this.supportPointC(i,I,M,T,N);var D=N.x,_=N.y,B=N.z,Y=D-V,X=_-C,Z=B-E;if(Y*I+X*M+Z*T<=0)return!1;if(I=X*L-Z*P,M=Z*S-Y*L,T=Y*P-X*S,I*I+M*M+T*T==0)return s.init(Y-S,X-P,Z-L),s.normalize(s),h.init(.5*(V+D),.5*(C+_),.5*(E+B)),!0;this.supportPointB(t,-I,-M,-T,N);var R=N.x,O=N.y,j=N.z;this.supportPointC(i,I,M,T,N);var U=N.x,J=N.y,F=N.z,q=U-R,H=J-O,W=F-j;if(q*I+H*M+W*T<=0)return!1;o=Y-S,n=X-P,r=Z-L,l=q-S,c=H-P,m=W-L,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l,I*S+M*P+T*L>0&&(o=Y,n=X,r=Z,Y=q,X=H,Z=W,q=o,H=n,W=r,o=V,n=C,r=E,V=R,C=O,E=j,R=o,O=n,j=r,o=D,n=_,r=B,D=U,_=J,B=F,U=o,J=n,F=r,I=-I,M=-M,T=-T);for(var Q=0;;){if(++Q>100)return!1;this.supportPointB(t,-I,-M,-T,N);var G=N.x,K=N.y,$=N.z;this.supportPointC(i,I,M,T,N);var tt=N.x,it=N.y,st=N.z,ht=tt-G,et=it-K,ot=st-$;if(ht*I+et*M+ot*T<=0)return!1;if((X*ot-Z*et)*S+(Z*ht-Y*ot)*P+(Y*et-X*ht)*L<0)q=ht,H=et,W=ot,R=G,O=K,j=$,U=tt,J=it,F=st,o=Y-S,n=X-P,r=Z-L,l=ht-S,c=et-P,m=ot-L,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l;else if((et*W-ot*H)*S+(ot*q-ht*W)*P+(ht*H-et*q)*L<0)Y=ht,X=et,Z=ot,V=G,C=K,E=$,D=tt,_=it,B=st,o=ht-S,n=et-P,r=ot-L,l=q-S,c=H-P,m=W-L,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l;else for(var nt=!1;;){if(o=q-Y,n=H-X,r=W-Z,l=ht-Y,c=et-X,m=ot-Z,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l,p=1/a.sqrt(I*I+M*M+T*T),I*=p,M*=p,T*=p,I*Y+M*X+T*Z>=0&&!nt){var at=(X*W-Z*H)*ht+(Z*q-Y*W)*et+(Y*H-X*q)*ot,rt=(et*W-ot*H)*S+(ot*q-ht*W)*P+(ht*H-et*q)*L,lt=(P*Z-L*X)*ht+(L*Y-S*Z)*et+(S*X-P*Y)*ot,ct=(H*Z-W*X)*S+(W*Y-q*Z)*P+(q*X-H*Y)*L,mt=at+rt+lt+ct;mt<=0&&(at=0,rt=(H*ot-W*et)*I+(W*ht-q*ot)*M+(q*et-H*ht)*T,lt=(et*W-ot*H)*I+(ot*q-ht*W)*M+(ht*H-et*q)*T,ct=(X*W-Z*H)*I+(Z*q-Y*W)*M+(Y*H-X*q)*T,mt=rt+lt+ct);var pt=1/mt;u=(b*at+V*rt+R*lt+G*ct)*pt,y=(z*at+C*rt+O*lt+K*ct)*pt,x=(A*at+E*rt+j*lt+$*ct)*pt,d=(g*at+D*rt+U*lt+tt*ct)*pt,f=(w*at+_*rt+J*lt+it*ct)*pt,v=(k*at+B*rt+F*lt+st*ct)*pt,nt=!0}this.supportPointB(t,-I,-M,-T,N);var ut=N.x,yt=N.y,xt=N.z;this.supportPointC(i,I,M,T,N);var dt=N.x,ft=N.y,vt=N.z,Nt=dt-ut,bt=ft-yt,zt=vt-xt,At=-(Nt*I+bt*M+zt*T);if((Nt-ht)*I+(bt-et)*M+(zt-ot)*T<=.01||At>=0)return!!nt&&(s.init(-I,-M,-T),h.init(.5*(u+d),.5*(y+f),.5*(x+v)),e.x=At,!0);(bt*Z-zt*X)*S+(zt*Y-Nt*Z)*P+(Nt*X-bt*Y)*L<0?(bt*W-zt*H)*S+(zt*q-Nt*W)*P+(Nt*H-bt*q)*L<0?(Y=Nt,X=bt,Z=zt,V=ut,C=yt,E=xt,D=dt,_=ft,B=vt):(ht=Nt,et=bt,ot=zt,G=ut,K=yt,$=xt,tt=dt,it=ft,st=vt):(bt*ot-zt*et)*S+(zt*ht-Nt*ot)*P+(Nt*et-bt*ht)*L<0?(q=Nt,H=bt,W=zt,R=ut,O=yt,j=xt,U=dt,J=ft,F=vt):(Y=Nt,X=bt,Z=zt,V=ut,C=yt,E=xt,D=dt,_=ft,B=vt)}}},a.BoxCylinderCollisionDetector.prototype.supportPointB=function(t,i,s,h,e){var o,n,a,r=t.rotation.elements,l=r[0]*i+r[3]*s+r[6]*h,c=r[1]*i+r[4]*s+r[7]*h,m=r[2]*i+r[5]*s+r[8]*h,p=t.halfWidth,u=t.halfHeight,y=t.halfDepth;o=l<0?-p:p,n=c<0?-u:u,a=m<0?-y:y,l=r[0]*o+r[1]*n+r[2]*a+t.position.x,c=r[3]*o+r[4]*n+r[5]*a+t.position.y,m=r[6]*o+r[7]*n+r[8]*a+t.position.z,e.init(l,c,m)},a.BoxCylinderCollisionDetector.prototype.supportPointC=function(t,i,s,h,e){var o,n,r,l=t.rotation.elements,c=l[0]*i+l[3]*s+l[6]*h,m=l[1]*i+l[4]*s+l[7]*h,p=l[2]*i+l[5]*s+l[8]*h,u=c,y=p,x=u*u+y*y,d=t.radius,f=t.halfHeight;0==x?m<0?(o=d,n=-f,r=0):(o=d,n=f,r=0):(x=t.radius/a.sqrt(x),m<0?(o=u*x,n=-f,r=y*x):(o=u*x,n=f,r=y*x)),c=l[0]*o+l[1]*n+l[2]*r+t.position.x,m=l[3]*o+l[4]*n+l[5]*r+t.position.y,p=l[6]*o+l[7]*n+l[8]*r+t.position.z,e.init(c,m,p)},a.BoxCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o=new a.Vec3,n=new a.Vec3,r=new a.Vec3;if(this.getSep(h,e,o,n,r)){var l=h.position.x,c=h.position.y,m=h.position.z,p=e.position.x,u=e.position.y,y=e.position.z,x=h.halfWidth,d=h.halfHeight,f=h.halfDepth,v=e.halfHeight,N=e.radius,b=h.dimentions,z=b[0],A=b[1],g=b[2],w=b[3],k=b[4],S=b[5],P=b[6],L=b[7],I=b[8],M=b[9],T=b[10],V=b[11],C=b[12],E=b[13],D=b[14],_=b[15],B=b[16],Y=b[17],X=e.normalDirection.x,Z=e.normalDirection.y,R=e.normalDirection.z,O=e.halfDirection.x,j=e.halfDirection.y,U=e.halfDirection.z,J=o.x,F=o.y,q=o.z,H=J*z+F*A+q*g,W=J*w+F*k+q*S,Q=J*P+F*L+q*I,G=J*X+F*Z+q*R,K=H>0,$=W>0,tt=Q>0,it=G>0;K||(H=-H),$||(W=-W),tt||(Q=-Q),it||(G=-G);var st=0;G>.999?st=H>.999?H>G?1:4:W>.999?W>G?2:4:Q>.999&&Q>G?3:4:H>.999?st=1:W>.999?st=2:Q>.999&&(st=3);var ht,et,ot,nt,at,rt,lt,ct,mt,pt,ut,yt,xt,dt,ft,vt,Nt,bt,zt,At,gt,wt,kt,St,Pt,Lt,It,Mt,Tt,Vt,Ct,Et,Dt,_t,Bt,Yt,Xt,Zt,Rt,Ot,jt,Ut,Jt,Ft,qt,Ht,Wt,Qt,Gt,Kt,$t,ti,ii;if(0==st)s.addPoint(n.x,n.y,n.z,J,F,q,r.x,this.flip);else if(4==st){it?(nt=p-O,at=u-j,rt=y-U,J=-X,F=-Z,q=-R):(nt=p+O,at=u+j,rt=y+U,J=X,F=Z,q=R);var si,hi,ei,oi,ni,ai,ri,li,ci,mi,pi,ui;At=1,st=0,Jt=z*J+A*F+g*q,Jt<At&&(At=Jt,st=0),-Jt<At&&(At=-Jt,st=1),Jt=w*J+k*F+S*q,Jt<At&&(At=Jt,st=2),-Jt<At&&(At=-Jt,st=3),Jt=P*J+L*F+I*q,Jt<At&&(At=Jt,st=4),-Jt<At&&(At=-Jt,st=5);var yi=h.elements;switch(st){case 0:si=yi[0],hi=yi[1],ei=yi[2],oi=yi[6],ni=yi[7],ai=yi[8],ri=yi[9],li=yi[10],ci=yi[11],mi=yi[3],pi=yi[4],ui=yi[5];break;case 1:si=yi[15],hi=yi[16],ei=yi[17],oi=yi[21],ni=yi[22],ai=yi[23],ri=yi[18],li=yi[19],ci=yi[20],mi=yi[12],pi=yi[13],ui=yi[14];break;case 2:si=yi[12],hi=yi[13],ei=yi[14],oi=yi[0],ni=yi[1],ai=yi[2],ri=yi[3],li=yi[4],ci=yi[5],mi=yi[15],pi=yi[16],ui=yi[17];break;case 3:si=yi[21],hi=yi[22],ei=yi[23],oi=yi[9],ni=yi[10],ai=yi[11],ri=yi[6],li=yi[7],ci=yi[8],mi=yi[18],pi=yi[19],ui=yi[20];break;case 4:si=yi[12],hi=yi[13],ei=yi[14],oi=yi[18],ni=yi[19],ai=yi[20],ri=yi[6],li=yi[7],ci=yi[8],mi=yi[0],pi=yi[1],ui=yi[2];break;case 5:si=yi[3],hi=yi[4],ei=yi[5],oi=yi[9],ni=yi[10],ai=yi[11],ri=yi[21],li=yi[22],ci=yi[23],mi=yi[15],pi=yi[16],ui=yi[17]}zt=J*(si-nt)+F*(hi-at)+q*(ei-rt),zt<=0&&s.addPoint(si,hi,ei,-J,-F,-q,zt,this.flip),zt=J*(oi-nt)+F*(ni-at)+q*(ai-rt),zt<=0&&s.addPoint(oi,ni,ai,-J,-F,-q,zt,this.flip),zt=J*(ri-nt)+F*(li-at)+q*(ci-rt),zt<=0&&s.addPoint(ri,li,ci,-J,-F,-q,zt,this.flip),zt=J*(mi-nt)+F*(pi-at)+q*(ui-rt),zt<=0&&s.addPoint(mi,pi,ui,-J,-F,-q,zt,this.flip)}else{switch(st){case 1:K?(ht=l+M,et=c+T,ot=m+V,J=z,F=A,q=g):(ht=l-M,et=c-T,ot=m-V,J=-z,F=-A,q=-g),Ht=w,Wt=k,Qt=S,ti=d,Gt=P,Kt=L,$t=I,ii=f;break;case 2:$?(ht=l+C,et=c+E,ot=m+D,J=w,F=k,q=S):(ht=l-C,et=c-E,ot=m-D,J=-w,F=-k,q=-S),Ht=z,Wt=A,Qt=g,ti=x,Gt=P,Kt=L,$t=I,ii=f;break;case 3:tt?(ht=l+_,et=c+B,ot=m+Y,J=P,F=L,q=I):(ht=l-_,et=c-B,ot=m-Y,J=-P,F=-L,q=-I),Ht=z,Wt=A,Qt=g,ti=x,Gt=w,Kt=k,$t=S,ii=d}if(At=J*X+F*Z+q*R,gt=At<0?v:-v,nt=p+gt*X,at=u+gt*Z,rt=y+gt*R,G>=.999999?(wt=-F,kt=q,St=J):(wt=J,kt=F,St=q),gt=wt*X+kt*Z+St*R,Lt=gt*X-wt,It=gt*Z-kt,Mt=gt*R-St,0==(gt=a.sqrt(Lt*Lt+It*It+Mt*Mt)))return;if(gt=N/gt,Lt*=gt,It*=gt,Mt*=gt,wt=nt+Lt,kt=at+It,St=rt+Mt,At<-.96||At>.96)lt=X*X*1.5-.5,ct=X*Z*1.5-.866025403*R,mt=X*R*1.5+.866025403*Z,pt=Z*X*1.5+.866025403*R,ut=Z*Z*1.5-.5,yt=Z*R*1.5-.866025403*X,xt=R*X*1.5-.866025403*Z,dt=R*Z*1.5+.866025403*X,ft=R*R*1.5-.5,vt=wt,Nt=kt,bt=St,zt=J*(vt-ht)+F*(Nt-et)+q*(bt-ot),wt=vt-zt*J-ht,kt=Nt-zt*F-et,St=bt-zt*q-ot,Zt=Ht*wt+Wt*kt+Qt*St,Ut=Gt*wt+Kt*kt+$t*St,Zt<-ti?Zt=-ti:Zt>ti&&(Zt=ti),Ut<-ii?Ut=-ii:Ut>ii&&(Ut=ii),wt=Zt*Ht+Ut*Gt,kt=Zt*Wt+Ut*Kt,St=Zt*Qt+Ut*$t,vt=ht+wt,Nt=et+kt,bt=ot+St,s.addPoint(vt,Nt,bt,J,F,q,zt,this.flip),vt=Lt*lt+It*ct+Mt*mt,Nt=Lt*pt+It*ut+Mt*yt,bt=Lt*xt+It*dt+Mt*ft,vt=(Lt=vt)+nt,Nt=(It=Nt)+at,bt=(Mt=bt)+rt,zt=J*(vt-ht)+F*(Nt-et)+q*(bt-ot),zt<=0&&(wt=vt-zt*J-ht,kt=Nt-zt*F-et,St=bt-zt*q-ot,Zt=Ht*wt+Wt*kt+Qt*St,Ut=Gt*wt+Kt*kt+$t*St,Zt<-ti?Zt=-ti:Zt>ti&&(Zt=ti),Ut<-ii?Ut=-ii:Ut>ii&&(Ut=ii),wt=Zt*Ht+Ut*Gt,kt=Zt*Wt+Ut*Kt,St=Zt*Qt+Ut*$t,vt=ht+wt,Nt=et+kt,bt=ot+St,s.addPoint(vt,Nt,bt,J,F,q,zt,this.flip)),vt=Lt*lt+It*ct+Mt*mt,Nt=Lt*pt+It*ut+Mt*yt,bt=Lt*xt+It*dt+Mt*ft,vt=(Lt=vt)+nt,Nt=(It=Nt)+at,bt=(Mt=bt)+rt,(zt=J*(vt-ht)+F*(Nt-et)+q*(bt-ot))<=0&&(wt=vt-zt*J-ht,kt=Nt-zt*F-et,St=bt-zt*q-ot,Zt=Ht*wt+Wt*kt+Qt*St,Ut=Gt*wt+Kt*kt+$t*St,Zt<-ti?Zt=-ti:Zt>ti&&(Zt=ti),Ut<-ii?Ut=-ii:Ut>ii&&(Ut=ii),wt=Zt*Ht+Ut*Gt,kt=Zt*Wt+Ut*Kt,St=Zt*Qt+Ut*$t,vt=ht+wt,Nt=et+kt,bt=ot+St,s.addPoint(vt,Nt,bt,J,F,q,zt,this.flip));else{if(Bt=wt,Yt=kt,Xt=St,Zt=J*(Bt-ht)+F*(Yt-et)+q*(Xt-ot),Bt-=Zt*J,Yt-=Zt*F,Xt-=Zt*q,At>0?(Rt=wt+2*O,Ot=kt+2*j,jt=St+2*U):(Rt=wt-2*O,Ot=kt-2*j,jt=St-2*U),Ut=J*(Rt-ht)+F*(Ot-et)+q*(jt-ot),Rt-=Ut*J,Ot-=Ut*F,jt-=Ut*q,Tt=Bt-ht,Vt=Yt-et,Ct=Xt-ot,Et=Rt-ht,Dt=Ot-et,_t=jt-ot,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt,H=Tt*Ht+Vt*Wt+Ct*Qt,W=Et*Ht+Dt*Wt+_t*Qt,Jt=H-ti,Ft=W-ti,Jt>0){if(Ft>0)return;qt=Jt/(Jt-Ft),Bt+=wt*qt,Yt+=kt*qt,Xt+=St*qt,Zt+=Pt*qt,Tt=Bt-ht,Vt=Yt-et,Ct=Xt-ot,H=Tt*Ht+Vt*Wt+Ct*Qt,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt}else Ft>0&&(qt=Jt/(Jt-Ft),Rt=Bt+wt*qt,Ot=Yt+kt*qt,jt=Xt+St*qt,Ut=Zt+Pt*qt,Et=Rt-ht,Dt=Ot-et,_t=jt-ot,W=Et*Ht+Dt*Wt+_t*Qt,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt);if(Jt=H+ti,Ft=W+ti,Jt<0){if(Ft<0)return;qt=Jt/(Jt-Ft),Bt+=wt*qt,Yt+=kt*qt,Xt+=St*qt,Zt+=Pt*qt,Tt=Bt-ht,Vt=Yt-et,Ct=Xt-ot,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt}else Ft<0&&(qt=Jt/(Jt-Ft),Rt=Bt+wt*qt,Ot=Yt+kt*qt,jt=Xt+St*qt,Ut=Zt+Pt*qt,Et=Rt-ht,Dt=Ot-et,_t=jt-ot,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt);if(H=Tt*Gt+Vt*Kt+Ct*$t,W=Et*Gt+Dt*Kt+_t*$t,Jt=H-ii,Ft=W-ii,Jt>0){if(Ft>0)return;qt=Jt/(Jt-Ft),Bt+=wt*qt,Yt+=kt*qt,Xt+=St*qt,Zt+=Pt*qt,Tt=Bt-ht,Vt=Yt-et,Ct=Xt-ot,H=Tt*Gt+Vt*Kt+Ct*$t,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt}else Ft>0&&(qt=Jt/(Jt-Ft),Rt=Bt+wt*qt,Ot=Yt+kt*qt,jt=Xt+St*qt,Ut=Zt+Pt*qt,Et=Rt-ht,Dt=Ot-et,_t=jt-ot,W=Et*Gt+Dt*Kt+_t*$t,wt=Rt-Bt,kt=Ot-Yt,St=jt-Xt,Pt=Ut-Zt);if(Jt=H+ii,Ft=W+ii,Jt<0){if(Ft<0)return;qt=Jt/(Jt-Ft),Bt+=wt*qt,Yt+=kt*qt,Xt+=St*qt,Zt+=Pt*qt}else Ft<0&&(qt=Jt/(Jt-Ft),Rt=Bt+wt*qt,Ot=Yt+kt*qt,jt=Xt+St*qt,Ut=Zt+Pt*qt);Zt<0&&s.addPoint(Bt,Yt,Xt,J,F,q,Zt,this.flip),Ut<0&&s.addPoint(Rt,Ot,jt,J,F,q,Ut,this.flip)}}}},a.CylinderCylinderCollisionDetector=function(){a.CollisionDetector.call(this)},a.CylinderCylinderCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.CylinderCylinderCollisionDetector.prototype.constructor=a.CylinderCylinderCollisionDetector,a.CylinderCylinderCollisionDetector.prototype.getSep=function(t,i,s,h,e){var o,n,r,l,c,m,p,u,y,x,d,f,v,N=new a.Vec3,b=t.position.x,z=t.position.y,A=t.position.z,g=i.position.x,w=i.position.y,k=i.position.z,S=g-b,P=w-z,L=k-A;S*S+P*P+L*L==0&&(P=.001);var I=-S,M=-P,T=-L;this.supportPoint(t,-I,-M,-T,N);var V=N.x,C=N.y,E=N.z;this.supportPoint(i,I,M,T,N);var D=N.x,_=N.y,B=N.z,Y=D-V,X=_-C,Z=B-E;if(Y*I+X*M+Z*T<=0)return!1;if(I=X*L-Z*P,M=Z*S-Y*L,T=Y*P-X*S,I*I+M*M+T*T==0)return s.init(Y-S,X-P,Z-L),s.normalize(s),h.init(.5*(V+D),.5*(C+_),.5*(E+B)),!0;this.supportPoint(t,-I,-M,-T,N);var R=N.x,O=N.y,j=N.z;this.supportPoint(i,I,M,T,N);var U=N.x,J=N.y,F=N.z,q=U-R,H=J-O,W=F-j;if(q*I+H*M+W*T<=0)return!1;o=Y-S,n=X-P,r=Z-L,l=q-S,c=H-P,m=W-L,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l,I*S+M*P+T*L>0&&(o=Y,n=X,r=Z,Y=q,X=H,Z=W,q=o,H=n,W=r,o=V,n=C,r=E,V=R,C=O,E=j,R=o,O=n,j=r,o=D,n=_,r=B,D=U,_=J,B=F,U=o,J=n,F=r,I=-I,M=-M,T=-T);for(var Q=0;;){if(++Q>100)return!1;this.supportPoint(t,-I,-M,-T,N);var G=N.x,K=N.y,$=N.z;this.supportPoint(i,I,M,T,N);var tt=N.x,it=N.y,st=N.z,ht=tt-G,et=it-K,ot=st-$;if(ht*I+et*M+ot*T<=0)return!1;if((X*ot-Z*et)*S+(Z*ht-Y*ot)*P+(Y*et-X*ht)*L<0)q=ht,H=et,W=ot,R=G,O=K,j=$,U=tt,J=it,F=st,o=Y-S,n=X-P,r=Z-L,l=ht-S,c=et-P,m=ot-L,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l;else if((et*W-ot*H)*S+(ot*q-ht*W)*P+(ht*H-et*q)*L<0)Y=ht,X=et,Z=ot,V=G,C=K,E=$,D=tt,_=it,B=st,o=ht-S,n=et-P,r=ot-L,l=q-S,c=H-P,m=W-L,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l;else for(var nt=!1;;){if(o=q-Y,n=H-X,r=W-Z,l=ht-Y,c=et-X,m=ot-Z,I=n*m-r*c,M=r*l-o*m,T=o*c-n*l,p=1/a.sqrt(I*I+M*M+T*T),I*=p,M*=p,T*=p,I*Y+M*X+T*Z>=0&&!nt){var at=(X*W-Z*H)*ht+(Z*q-Y*W)*et+(Y*H-X*q)*ot,rt=(et*W-ot*H)*S+(ot*q-ht*W)*P+(ht*H-et*q)*L,lt=(P*Z-L*X)*ht+(L*Y-S*Z)*et+(S*X-P*Y)*ot,ct=(H*Z-W*X)*S+(W*Y-q*Z)*P+(q*X-H*Y)*L,mt=at+rt+lt+ct;mt<=0&&(at=0,rt=(H*ot-W*et)*I+(W*ht-q*ot)*M+(q*et-H*ht)*T,lt=(et*W-ot*H)*I+(ot*q-ht*W)*M+(ht*H-et*q)*T,ct=(X*W-Z*H)*I+(Z*q-Y*W)*M+(Y*H-X*q)*T,mt=rt+lt+ct);var pt=1/mt;u=(b*at+V*rt+R*lt+G*ct)*pt,y=(z*at+C*rt+O*lt+K*ct)*pt,x=(A*at+E*rt+j*lt+$*ct)*pt,d=(g*at+D*rt+U*lt+tt*ct)*pt,f=(w*at+_*rt+J*lt+it*ct)*pt,v=(k*at+B*rt+F*lt+st*ct)*pt,nt=!0}this.supportPoint(t,-I,-M,-T,N);var ut=N.x,yt=N.y,xt=N.z;this.supportPoint(i,I,M,T,N);var dt=N.x,ft=N.y,vt=N.z,Nt=dt-ut,bt=ft-yt,zt=vt-xt,At=-(Nt*I+bt*M+zt*T);if((Nt-ht)*I+(bt-et)*M+(zt-ot)*T<=.01||At>=0)return!!nt&&(s.init(-I,-M,-T),h.init(.5*(u+d),.5*(y+f),.5*(x+v)),e.x=At,!0);(bt*Z-zt*X)*S+(zt*Y-Nt*Z)*P+(Nt*X-bt*Y)*L<0?(bt*W-zt*H)*S+(zt*q-Nt*W)*P+(Nt*H-bt*q)*L<0?(Y=Nt,X=bt,Z=zt,V=ut,C=yt,E=xt,D=dt,_=ft,B=vt):(ht=Nt,et=bt,ot=zt,G=ut,K=yt,$=xt,tt=dt,it=ft,st=vt):(bt*ot-zt*et)*S+(zt*ht-Nt*ot)*P+(Nt*et-bt*ht)*L<0?(q=Nt,H=bt,W=zt,R=ut,O=yt,j=xt,U=dt,J=ft,F=vt):(Y=Nt,X=bt,Z=zt,V=ut,C=yt,E=xt,D=dt,_=ft,B=vt)}}},a.CylinderCylinderCollisionDetector.prototype.supportPoint=function(t,i,s,h,e){var o,n,r,l=t.rotation.elements,c=l[0]*i+l[3]*s+l[6]*h,m=l[1]*i+l[4]*s+l[7]*h,p=l[2]*i+l[5]*s+l[8]*h,u=c,y=p,x=u*u+y*y,d=t.radius,f=t.halfHeight;0==x?m<0?(o=d,n=-f,r=0):(o=d,n=f,r=0):(x=t.radius/a.sqrt(x),m<0?(o=u*x,n=-f,r=y*x):(o=u*x,n=f,r=y*x)),c=l[0]*o+l[1]*n+l[2]*r+t.position.x,m=l[3]*o+l[4]*n+l[5]*r+t.position.y,p=l[6]*o+l[7]*n+l[8]*r+t.position.z,e.init(c,m,p)},a.CylinderCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;t.id<i.id?(h=t,e=i):(h=i,e=t);var o,n,r,l,c,m,p,u,y,x,d,f,v,N,b,z,A,g,w,k,S,P=h.position,L=e.position,I=P.x,M=P.y,T=P.z,V=L.x,C=L.y,E=L.z,D=h.halfHeight,_=e.halfHeight,B=h.normalDirection,Y=e.normalDirection,X=h.halfDirection,Z=e.halfDirection,R=h.radius,O=e.radius,j=B.x,U=B.y,J=B.z,F=Y.x,q=Y.y,H=Y.z,W=X.x,Q=X.y,G=X.z,K=Z.x,$=Z.y,tt=Z.z,it=I-V,st=M-C,ht=T-E,et=new a.Vec3,ot=new a.Vec3,nt=new a.Vec3;if(this.getSep(h,e,et,ot,nt)){var at=et.x*j+et.y*U+et.z*J,rt=et.x*F+et.y*q+et.z*H,lt=at>0,ct=rt>0;lt||(at=-at),ct||(rt=-rt);var mt=0;(at>.999||rt>.999)&&(mt=at>rt?1:2);var pt,ut,yt,xt,dt,ft,vt,Nt,bt,zt,At,gt,wt,kt,St,Pt,Lt,It,Mt,Tt,Vt=nt.x;switch(pt=et.x,ut=et.y,yt=et.z,mt){case 0:s.addPoint(ot.x,ot.y,ot.z,pt,ut,yt,Vt,!1);break;case 1:if(lt?(n=I+W,r=M+Q,l=T+G,pt=j,ut=U,yt=J):(n=I-W,r=M-Q,l=T-G,pt=-j,ut=-U,yt=-J),w=pt*F+ut*q+yt*H,o=w<0?_:-_,c=V+o*F,m=C+o*q,p=E+o*H,rt>=.999999?(u=-ut,y=yt,x=pt):(u=pt,y=ut,x=yt),o=u*F+y*q+x*H,it=o*F-u,st=o*q-y,ht=o*H-x,0==(o=a.sqrt(it*it+st*st+ht*ht)))break;if(o=O/o,it*=o,st*=o,ht*=o,u=c+it,y=m+st,x=p+ht,w<-.96||w>.96)xt=F*F*1.5-.5,dt=F*q*1.5-.866025403*H,ft=F*H*1.5+.866025403*q,vt=q*F*1.5+.866025403*H,Nt=q*q*1.5-.5,bt=q*H*1.5-.866025403*F,zt=H*F*1.5-.866025403*q,At=H*q*1.5+.866025403*F,gt=H*H*1.5-.5,wt=u,kt=y,St=x,Pt=pt*(wt-n)+ut*(kt-r)+yt*(St-l),u=wt-Pt*pt-n,y=kt-Pt*ut-r,x=St-Pt*yt-l,o=u*u+y*y+x*x,o>R*R&&(o=R/a.sqrt(o),u*=o,y*=o,x*=o),wt=n+u,kt=r+y,St=l+x,s.addPoint(wt,kt,St,pt,ut,yt,Pt,!1),wt=it*xt+st*dt+ht*ft,kt=it*vt+st*Nt+ht*bt,St=it*zt+st*At+ht*gt,wt=(it=wt)+c,kt=(st=kt)+m,St=(ht=St)+p,Pt=pt*(wt-n)+ut*(kt-r)+yt*(St-l),Pt<=0&&(u=wt-Pt*pt-n,y=kt-Pt*ut-r,x=St-Pt*yt-l,o=u*u+y*y+x*x,o>R*R&&(o=R/a.sqrt(o),u*=o,y*=o,x*=o),wt=n+u,kt=r+y,St=l+x,s.addPoint(wt,kt,St,pt,ut,yt,Pt,!1)),wt=it*xt+st*dt+ht*ft,kt=it*vt+st*Nt+ht*bt,St=it*zt+st*At+ht*gt,wt=(it=wt)+c,kt=(st=kt)+m,St=(ht=St)+p,(Pt=pt*(wt-n)+ut*(kt-r)+yt*(St-l))<=0&&(u=wt-Pt*pt-n,y=kt-Pt*ut-r,x=St-Pt*yt-l,o=u*u+y*y+x*x,o>R*R&&(o=R/a.sqrt(o),u*=o,y*=o,x*=o),wt=n+u,kt=r+y,St=l+x,s.addPoint(wt,kt,St,pt,ut,yt,Pt,!1));else{if(d=u,f=y,v=x,A=pt*(d-n)+ut*(f-r)+yt*(v-l),d-=A*pt,f-=A*ut,v-=A*yt,w>0?(N=u+F*_*2,b=y+q*_*2,z=x+H*_*2):(N=u-F*_*2,b=y-q*_*2,z=x-H*_*2),g=pt*(N-n)+ut*(b-r)+yt*(z-l),N-=g*pt,b-=g*ut,z-=g*yt,it=n-d,st=r-f,ht=l-v,u=N-d,y=b-f,x=z-v,Lt=it*it+st*st+ht*ht,It=it*u+st*y+ht*x,Mt=u*u+y*y+x*x,(Tt=It*It-Mt*(Lt-R*R))<0)break;Tt=a.sqrt(Tt),k=(It+Tt)/Mt,S=(It-Tt)/Mt,S<k&&(o=k,k=S,S=o),S>1&&(S=1),k<0&&(k=0),u=d+(N-d)*k,y=f+(b-f)*k,x=v+(z-v)*k,N=d+(N-d)*S,b=f+(b-f)*S,z=v+(z-v)*S,d=u,f=y,v=x,o=A+(g-A)*k,g=A+(g-A)*S,A=o,A<0&&s.addPoint(d,f,v,pt,ut,yt,Pt,!1),g<0&&s.addPoint(N,b,z,pt,ut,yt,Pt,!1)}break;case 2:if(ct?(c=V-K,m=C-$,p=E-tt,pt=-F,ut=-q,yt=-H):(c=V+K,m=C+$,p=E+tt,pt=F,ut=q,yt=H),w=pt*j+ut*U+yt*J,o=w<0?D:-D,n=I+o*j,r=M+o*U,l=T+o*J,at>=.999999?(u=-ut,y=yt,x=pt):(u=pt,y=ut,x=yt),o=u*j+y*U+x*J,it=o*j-u,st=o*U-y,ht=o*J-x,0==(o=a.sqrt(it*it+st*st+ht*ht)))break;if(o=R/o,it*=o,st*=o,ht*=o,u=n+it,y=r+st,x=l+ht,w<-.96||w>.96)xt=j*j*1.5-.5,dt=j*U*1.5-.866025403*J,ft=j*J*1.5+.866025403*U,vt=U*j*1.5+.866025403*J,Nt=U*U*1.5-.5,bt=U*J*1.5-.866025403*j,zt=J*j*1.5-.866025403*U,At=J*U*1.5+.866025403*j,gt=J*J*1.5-.5,wt=u,kt=y,St=x,Pt=pt*(wt-c)+ut*(kt-m)+yt*(St-p),u=wt-Pt*pt-c,y=kt-Pt*ut-m,x=St-Pt*yt-p,o=u*u+y*y+x*x,o>O*O&&(o=O/a.sqrt(o),u*=o,y*=o,x*=o),wt=c+u,kt=m+y,St=p+x,s.addPoint(wt,kt,St,-pt,-ut,-yt,Pt,!1),wt=it*xt+st*dt+ht*ft,kt=it*vt+st*Nt+ht*bt,St=it*zt+st*At+ht*gt,wt=(it=wt)+n,kt=(st=kt)+r,St=(ht=St)+l,Pt=pt*(wt-c)+ut*(kt-m)+yt*(St-p),Pt<=0&&(u=wt-Pt*pt-c,y=kt-Pt*ut-m,x=St-Pt*yt-p,o=u*u+y*y+x*x,o>O*O&&(o=O/a.sqrt(o),u*=o,y*=o,x*=o),wt=c+u,kt=m+y,St=p+x,s.addPoint(wt,kt,St,-pt,-ut,-yt,Pt,!1)),wt=it*xt+st*dt+ht*ft,kt=it*vt+st*Nt+ht*bt,St=it*zt+st*At+ht*gt,wt=(it=wt)+n,kt=(st=kt)+r,St=(ht=St)+l,(Pt=pt*(wt-c)+ut*(kt-m)+yt*(St-p))<=0&&(u=wt-Pt*pt-c,y=kt-Pt*ut-m,x=St-Pt*yt-p,o=u*u+y*y+x*x,o>O*O&&(o=O/a.sqrt(o),u*=o,y*=o,x*=o),wt=c+u,kt=m+y,St=p+x,s.addPoint(wt,kt,St,-pt,-ut,-yt,Pt,!1));else{if(d=u,f=y,v=x,A=pt*(d-c)+ut*(f-m)+yt*(v-p),d-=A*pt,f-=A*ut,v-=A*yt,w>0?(N=u+j*D*2,b=y+U*D*2,z=x+J*D*2):(N=u-j*D*2,b=y-U*D*2,z=x-J*D*2),g=pt*(N-c)+ut*(b-m)+yt*(z-p),N-=g*pt,b-=g*ut,z-=g*yt,it=c-d,st=m-f,ht=p-v,u=N-d,y=b-f,x=z-v,Lt=it*it+st*st+ht*ht,It=it*u+st*y+ht*x,Mt=u*u+y*y+x*x,(Tt=It*It-Mt*(Lt-O*O))<0)break;Tt=a.sqrt(Tt),k=(It+Tt)/Mt,S=(It-Tt)/Mt,S<k&&(o=k,k=S,S=o),S>1&&(S=1),k<0&&(k=0),u=d+(N-d)*k,y=f+(b-f)*k,x=v+(z-v)*k,N=d+(N-d)*S,b=f+(b-f)*S,z=v+(z-v)*S,d=u,f=y,v=x,o=A+(g-A)*k,g=A+(g-A)*S,A=o,A<0&&s.addPoint(d,f,v,-pt,-ut,-yt,A,!1),g<0&&s.addPoint(N,b,z,-pt,-ut,-yt,g,!1)}}}},a.SphereCylinderCollisionDetector=function(t){a.CollisionDetector.call(this),this.flip=t},a.SphereCylinderCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.SphereCylinderCollisionDetector.prototype.constructor=a.SphereCylinderCollisionDetector,a.SphereCylinderCollisionDetector.prototype.detectCollision=function(t,i,s){var h,e;this.flip?(h=i,e=t):(h=t,e=i);var o=h.position,n=o.x,r=o.y,l=o.z,c=e.position,m=c.x,p=c.y,u=c.z,y=e.normalDirection.x,x=e.normalDirection.y,d=e.normalDirection.z,f=h.radius,v=e.radius,N=f+v,b=e.halfHeight,z=n-m,A=r-p,g=l-u,w=z*y+A*x+g*d;if(!(w<-b-f||w>b+f)){var k=m+w*y,S=p+w*x,P=u+w*d,L=n-k,I=r-S,M=l-P,T=L*L+I*I+M*M;if(!(T>N*N)){T>v*v&&(T=v/a.sqrt(T),L*=T,I*=T,M*=T),w<-b?w=-b:w>b&&(w=b),k=m+w*y+L,S=p+w*x+I,P=u+w*d+M,z=k-n,A=S-r,g=P-l,T=z*z+A*A+g*g;var V;T>0&&T<f*f&&(T=a.sqrt(T),V=1/T,z*=V,A*=V,g*=V,s.addPoint(n+z*f,r+A*f,l+g*f,z,A,g,T-f,this.flip))}}},a.TetraTetraCollisionDetector=function(){a.CollisionDetector.call(this)},a.TetraTetraCollisionDetector.prototype=Object.create(a.CollisionDetector.prototype),a.TetraTetraCollisionDetector.prototype.constructor=a.TetraTetraCollisionDetector,a.TetraTetraCollisionDetector.prototype.detectCollision=function(t,i,s){var h,n,a,r,l,c,m=t.faces,p=t.verts,u=(i.faces,i.verts),y=0,x=m;for(h=0;h<4;h++)for(a=p[h],n=0;n<4;n++)r=u[x[h].a],l=u[x[h].b],c=u[x[h].c],e(o(a.x,a.y),o(r.x,r.y),o(l.x,l.y),o(c.x,c.y))&&e(o(a.x,a.z),o(r.x,r.z),o(l.x,l.z),o(c.x,c.z))&&e(o(a.z,a.y),o(r.z,r.y),o(l.z,l.y),o(c.z,c.y))&&y++,4===y&&s.addPoint(a)},a.AABB=function(t,i,s,h,e,o){this.elements=new n(6);var a=this.elements;a[0]=t||0,a[1]=s||0,a[2]=e||0,a[3]=i||0,a[4]=h||0,a[5]=o||0},a.AABB.prototype={constructor:a.AABB,set:function(t,i,s,h,e,o){var n=this.elements;return n[0]=t,n[3]=i,n[1]=s,n[4]=h,n[2]=e,n[5]=o,this},intersectTest:function(t){var i=this.elements,s=t.elements;return i[0]>s[3]||i[1]>s[4]||i[2]>s[5]||i[3]<s[0]||i[4]<s[1]||i[5]<s[2]},intersectTestTwo:function(t){var i=this.elements,s=t.elements;return i[0]<s[0]||i[1]<s[1]||i[2]<s[2]||i[3]>s[3]||i[4]>s[4]||i[5]>s[5]},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t,i){var s=i||0,h=t.elements;return this.set(h[0]-s,h[3]+s,h[1]-s,h[4]+s,h[2]-s,h[5]+s),this},fromArray:function(t){return this.elements.set(t),this},combine:function(t,i){var s=t.elements,h=i.elements,e=this.elements;return e[0]=s[0]<h[0]?s[0]:h[0],e[1]=s[1]<h[1]?s[1]:h[1],e[2]=s[2]<h[2]?s[2]:h[2],e[3]=s[3]>h[3]?s[3]:h[3],e[4]=s[4]>h[4]?s[4]:h[4],e[5]=s[5]>h[5]?s[5]:h[5],this},surfaceArea:function(){var t=this.elements,i=t[3]-t[0],s=t[4]-t[1],h=t[5]-t[2];return 2*(i*(s+h)+s*h)},intersectsWithPoint:function(t,i,s){var h=this.elements;return t>=h[0]&&t<=h[3]&&i>=h[1]&&i<=h[4]&&s>=h[2]&&s<=h[5]},setFromPoints:function(t){this.makeEmpty();for(var i=0;i<t.length;i++)this.expandByPoint(t[i])},makeEmpty:function(){this.set(-(1/0),-(1/0),-(1/0),1/0,1/0,1/0)},expandByPoint:function(t){var i=this.elements;this.set(a.min(i[0],t.x),a.min(i[1],t.y),a.min(i[2],t.z),a.max(i[3],t.x),a.max(i[4],t.y),a.max(i[5],t.z))}},a.Proxy=function(t){this.shape=t,this.aabb=t.aabb},a.Proxy.prototype={constructor:a.Proxy,update:function(){a.Error("Proxy","Inheritance error.")}},a.BasicProxy=function(t){a.Proxy.call(this,t),this.id=a.proxyID++},a.BasicProxy.prototype=Object.create(a.Proxy.prototype),a.BasicProxy.prototype.constructor=a.BasicProxy,a.BasicProxy.prototype.update=function(){},a.BroadPhase=function(){this.types=a.BR_NULL,this.numPairChecks=0,this.numPairs=0,this.pairs=[]},a.BroadPhase.prototype={constructor:a.BroadPhase,createProxy:function(t){a.Error("BroadPhase","Inheritance error.")},addProxy:function(t){a.Error("BroadPhase","Inheritance error.")},removeProxy:function(t){a.Error("BroadPhase","Inheritance error.")},isAvailablePair:function(t,i){var s=t.parent,h=i.parent;if(s==h||!s.isDynamic&&!h.isDynamic||0==(t.belongsTo&i.collidesWith)||0==(i.belongsTo&t.collidesWith))return!1;var e;for(e=s.numJoints<h.numJoints?s.jointLink:h.jointLink;null!==e;){var o=e.joint;if(!o.allowCollision&&(o.body1==s&&o.body2==h||o.body1==h&&o.body2==s))return!1;e=e.next}return!0},detectPairs:function(){this.pairs=[],this.numPairs=0,this.numPairChecks=0,this.collectPairs()},collectPairs:function(){a.Error("BroadPhase","Inheritance error.")},addPair:function(t,i){var s=new a.Pair(t,i);this.pairs.push(s),this.numPairs++}},a.BruteForceBroadPhase=function(){a.BroadPhase.call(this),this.types=a.BR_BRUTE_FORCE,this.proxies=[]},a.BruteForceBroadPhase.prototype=Object.create(a.BroadPhase.prototype),a.BruteForceBroadPhase.prototype.constructor=a.BruteForceBroadPhase,a.BruteForceBroadPhase.prototype.createProxy=function(t){return new a.BasicProxy(t)},a.BruteForceBroadPhase.prototype.addProxy=function(t){this.proxies.push(t)},a.BruteForceBroadPhase.prototype.removeProxy=function(t){var i=this.proxies.indexOf(t);i>-1&&this.proxies.splice(i,1)},a.BruteForceBroadPhase.prototype.collectPairs=function(){var t,i,s,h=0,e=this.proxies,o=e.length;for(this.numPairChecks=o*(o-1)>>1;h<o;)for(i=e[h++],t=h+1;t<o;)s=e[t++],!i.aabb.intersectTest(s.aabb)&&this.isAvailablePair(i.shape,s.shape)&&this.addPair(i.shape,s.shape)},a.Pair=function(t,i){this.shape1=t||null,this.shape2=i||null},a.SAPAxis=function(){this.numElements=0,this.bufferSize=256,this.elements=[],this.elements.length=this.bufferSize,this.stack=new n(64)},a.SAPAxis.prototype={constructor:a.SAPAxis,addElements:function(t,i){if(this.numElements+2>=this.bufferSize){this.bufferSize*=2;for(var s=[],h=this.numElements;h--;)s[h]=this.elements[h]}this.elements[this.numElements++]=t,this.elements[this.numElements++]=i},removeElements:function(t,i){for(var s=-1,h=-1,e=0,o=this.numElements;e<o;e++){var n=this.elements[e];if(n==t||n==i){if(s!=-1){h=e;break}s=e}}for(e=s+1,o=h;e<o;e++)this.elements[e-1]=this.elements[e];for(e=h+1,o=this.numElements;e<o;e++)this.elements[e-2]=this.elements[e];this.elements[--this.numElements]=null,this.elements[--this.numElements]=null},sort:function(){for(var t=0,i=1;this.numElements>>i!=0;)i++;i=i*this.numElements>>2,t=0;for(var s=!1,h=this.elements,e=1,o=this.numElements;e<o;e++){var n=h[e],r=n.value,l=h[e-1];if(l.value>r){var c=e;do{if(h[c]=l,0==--c)break;l=h[c-1]}while(l.value>r);if(h[c]=n,(t+=e-c)>i){s=!0;break}}}if(s){t=2;var m=this.stack;for(m[0]=0,m[1]=this.numElements-1;t>0;){var p=m[--t],u=m[--t],y=p-u;if(y>16){var x=u+a.floor(.5*y);for(n=h[x],h[x]=h[p],h[p]=n,r=n.value,e=u-1,c=p;;){var d,f;do{d=h[++e]}while(d.value<r);do{f=h[--c]}while(r<f.value&&c!=u);if(e>=c)break;h[e]=f,h[c]=d}h[p]=h[e],h[e]=n,e-u>p-e?(m[t++]=u,m[t++]=e-1,m[t++]=e+1,m[t++]=p):(m[t++]=e+1,m[t++]=p,m[t++]=u,m[t++]=e-1)}else for(e=u+1;e<=p;e++)if(n=h[e],r=n.value,l=h[e-1],l.value>r){c=e;do{if(h[c]=l,0==--c)break;l=h[c-1]}while(l.value>r);h[c]=n}}}},calculateTestCount:function(){for(var t=1,i=0,s=1,h=this.numElements;s<h;s++)this.elements[s].max?t--:(i+=t,t++);return i}},a.SAPBroadPhase=function(){a.BroadPhase.call(this),this.types=a.BR_SWEEP_AND_PRUNE,this.numElementsD=0,this.numElementsS=0,this.axesD=[new a.SAPAxis,new a.SAPAxis,new a.SAPAxis],this.axesS=[new a.SAPAxis,new a.SAPAxis,new a.SAPAxis],this.index1=0,this.index2=1},a.SAPBroadPhase.prototype=Object.create(a.BroadPhase.prototype);a.SAPBroadPhase.prototype.constructor=a.SAPBroadPhase,a.SAPBroadPhase.prototype.createProxy=function(t){return new a.SAPProxy(this,t)},a.SAPBroadPhase.prototype.addProxy=function(t){var i=t;i.isDynamic()?(this.axesD[0].addElements(i.min[0],i.max[0]),this.axesD[1].addElements(i.min[1],i.max[1]),this.axesD[2].addElements(i.min[2],i.max[2]),i.belongsTo=1,this.numElementsD+=2):(this.axesS[0].addElements(i.min[0],i.max[0]),this.axesS[1].addElements(i.min[1],i.max[1]),this.axesS[2].addElements(i.min[2],i.max[2]),i.belongsTo=2,this.numElementsS+=2)},a.SAPBroadPhase.prototype.removeProxy=function(t){var i=t;if(0!=i.belongsTo){switch(i.belongsTo){case 1:this.axesD[0].removeElements(i.min[0],i.max[0]),this.axesD[1].removeElements(i.min[1],i.max[1]),this.axesD[2].removeElements(i.min[2],i.max[2]),this.numElementsD-=2;break;case 2:this.axesS[0].removeElements(i.min[0],i.max[0]),this.axesS[1].removeElements(i.min[1],i.max[1]),this.axesS[2].removeElements(i.min[2],i.max[2]),this.numElementsS-=2}i.belongsTo=0}},a.SAPBroadPhase.prototype.collectPairs=function(){if(0!=this.numElementsD){var t=this.axesD[this.index1],i=this.axesD[this.index2];t.sort(),i.sort();var s,h,e=t.calculateTestCount(),o=i.calculateTestCount();e<=o?(i=this.axesS[this.index1],i.sort(),s=t.elements,h=i.elements):(t=this.axesS[this.index2],t.sort(),s=i.elements,h=t.elements,this.index1^=this.index2,this.index2^=this.index1,this.index1^=this.index2);for(var n,a,r=0,l=0;r<this.numElementsD;){var c,m;if(l==this.numElementsS)c=s[r],m=!0,r++;else{var p=s[r],u=h[l];p.value<u.value?(c=p,m=!0,r++):(c=u,m=!1,l++)}if(c.max){var y=c.pair;if(m){if(y==n){n=n.pair;continue}c=n}else{if(y==a){a=a.pair;continue}c=a}do{if((b=c.pair)==y){c.pair=b.pair;break}c=b}while(null!=c)}else{for(var x=c.proxy.shape,d=c.min1.value,f=c.max1.value,v=c.min2.value,N=c.max2.value,b=n;null!=b;b=b.pair){var z=b.proxy.shape;this.numPairChecks++,d>b.max1.value||f<b.min1.value||v>b.max2.value||N<b.min2.value||!this.isAvailablePair(x,z)||this.addPair(x,z)}if(m){for(b=a;null!=b;b=b.pair)z=b.proxy.shape,this.numPairChecks++,d>b.max1.value||f<b.min1.value||v>b.max2.value||N<b.min2.value||!this.isAvailablePair(x,z)||this.addPair(x,z);c.pair=n,n=c}else c.pair=a,a=c}}this.index2=3^(this.index1|this.index2)}},a.SAPElement=function(t,i){this.proxy=t,this.pair=null,this.min1=null,this.max1=null,this.min2=null,this.max2=null,this.max=i,this.value=0},a.SAPProxy=function(t,i){a.Proxy.call(this,i),this.belongsTo=0,this.max=[],this.min=[],this.sap=t,this.min[0]=new a.SAPElement(this,!1),this.max[0]=new a.SAPElement(this,!0),this.min[1]=new a.SAPElement(this,!1),this.max[1]=new a.SAPElement(this,!0),this.min[2]=new a.SAPElement(this,!1),this.max[2]=new a.SAPElement(this,!0),this.max[0].pair=this.min[0],this.max[1].pair=this.min[1],this.max[2].pair=this.min[2],this.min[0].min1=this.min[1],this.min[0].max1=this.max[1],this.min[0].min2=this.min[2],this.min[0].max2=this.max[2],this.min[1].min1=this.min[0],this.min[1].max1=this.max[0],this.min[1].min2=this.min[2],this.min[1].max2=this.max[2],this.min[2].min1=this.min[0],this.min[2].max1=this.max[0],this.min[2].min2=this.min[1],this.min[2].max2=this.max[1]},a.SAPProxy.prototype=Object.create(a.Proxy.prototype),a.SAPProxy.prototype.constructor=a.SAPProxy,a.SAPProxy.prototype.isDynamic=function(){var t=this.shape.parent;return t.isDynamic&&!t.sleeping},a.SAPProxy.prototype.update=function(){var t=this.aabb.elements;this.min[0].value=t[0],this.min[1].value=t[1],this.min[2].value=t[2],this.max[0].value=t[3],this.max[1].value=t[4],this.max[2].value=t[5],(1==this.belongsTo&&!this.isDynamic()||2==this.belongsTo&&this.isDynamic())&&(this.sap.removeProxy(this),this.sap.addProxy(this))},a.DBVT=function(){this.root=null,this.freeNodes=[],this.freeNodes.length=16384,this.numFreeNodes=0,this.aabb=new a.AABB},a.DBVT.prototype={constructor:a.DBVT,moveLeaf:function(t){this.deleteLeaf(t),this.insertLeaf(t)},insertLeaf:function(t){if(null==this.root)return void(this.root=t);for(var i,s,h=t.aabb,e=this.root;null==e.proxy;){var o=e.child1,n=e.child2,r=e.aabb,l=o.aabb,c=n.aabb;i=r.surfaceArea(),this.aabb.combine(h,r),s=this.aabb.surfaceArea();var m=2*s,p=2*(s-i),u=p;this.aabb.combine(h,l),u+=null!=o.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-l.surfaceArea();var y=p;if(this.aabb.combine(h,c),y+=null!=n.proxy?this.aabb.surfaceArea():this.aabb.surfaceArea()-c.surfaceArea(),u<y){if(m<u)break;e=o}else{if(m<y)break;e=n}}var x,d=e.parent;x=this.numFreeNodes>0?this.freeNodes[--this.numFreeNodes]:new a.DBVTNode,x.parent=d,x.child1=t,x.child2=e,x.aabb.combine(t.aabb,e.aabb),x.height=e.height+1,e.parent=x,t.parent=x,e==this.root?this.root=x:d.child1==e?d.child1=x:d.child2=x;do{x=this.balance(x),this.fix(x),x=x.parent}while(null!=x)},getBalance:function(t){return null!=t.proxy?0:t.child1.height-t.child2.height},deleteLeaf:function(t){if(t==this.root)return void(this.root=null);var i,s=t.parent;if(i=s.child1==t?s.child2:s.child1,s==this.root)return this.root=i,void(i.parent=null);var h=s.parent;i.parent=h,h.child1==s?h.child1=i:h.child2=i,this.numFreeNodes<16384&&(this.freeNodes[this.numFreeNodes++]=s);do{h=this.balance(h),this.fix(h),h=h.parent}while(null!=h)},balance:function t(i){var s=i.height;if(s<2)return i;var h,e=i.parent,o=i.child1,n=i.child2,a=o.height,r=n.height,t=a-r;if(t>1){var l=o.child1,c=o.child2,m=l.height,p=c.height;return m>p?(o.child2=i,i.parent=o,i.child1=c,c.parent=i,i.aabb.combine(c.aabb,n.aabb),h=p-r,i.height=p-(h&h>>31)+1,o.aabb.combine(l.aabb,i.aabb),h=m-s,o.height=m-(h&h>>31)+1):(o.child1=i,i.parent=o,i.child1=l,l.parent=i,i.aabb.combine(l.aabb,n.aabb),h=m-r,i.height=m-(h&h>>31)+1,o.aabb.combine(i.aabb,c.aabb),h=s-p,o.height=s-(h&h>>31)+1),null!=e?e.child1==i?e.child1=o:e.child2=o:this.root=o,o.parent=e,o}if(t<-1){var u=n.child1,y=n.child2,x=u.height,d=y.height;return x>d?(n.child2=i,i.parent=n,i.child2=y,y.parent=i,i.aabb.combine(o.aabb,y.aabb),h=a-d,i.height=a-(h&h>>31)+1,n.aabb.combine(u.aabb,i.aabb),h=x-s,n.height=x-(h&h>>31)+1):(n.child1=i,i.parent=n,i.child2=u,u.parent=i,i.aabb.combine(o.aabb,u.aabb),h=a-x,i.height=a-(h&h>>31)+1,n.aabb.combine(i.aabb,y.aabb),h=s-d,n.height=s-(h&h>>31)+1),null!=e?e.child1==i?e.child1=n:e.child2=n:this.root=n,n.parent=e,n}return i},fix:function(t){var i=t.child1,s=t.child2;t.aabb.combine(i.aabb,s.aabb),t.height=i.height<s.height?s.height+1:i.height+1}},a.DBVTBroadPhase=function(){a.BroadPhase.call(this),this.types=a.BR_BOUNDING_VOLUME_TREE,this.tree=new a.DBVT,this.stack=[],this.leaves=[],this.numLeaves=0},a.DBVTBroadPhase.prototype=Object.create(a.BroadPhase.prototype),a.DBVTBroadPhase.prototype.constructor=a.DBVTBroadPhase,a.DBVTBroadPhase.prototype.createProxy=function(t){return new a.DBVTProxy(t)},a.DBVTBroadPhase.prototype.addProxy=function(t){this.tree.insertLeaf(t.leaf),this.leaves.push(t.leaf),this.numLeaves++},a.DBVTBroadPhase.prototype.removeProxy=function(t){this.tree.deleteLeaf(t.leaf);var i=this.leaves.indexOf(t.leaf);i>-1&&(this.leaves.splice(i,1),this.numLeaves--)},a.DBVTBroadPhase.prototype.collectPairs=function(){if(!(this.numLeaves<2))for(var t,i=.1,s=this.numLeaves;s--;)t=this.leaves[s],t.proxy.aabb.intersectTestTwo(t.aabb)&&(t.aabb.copy(t.proxy.aabb,i),this.tree.deleteLeaf(t),this.tree.insertLeaf(t),this.collide(t,this.tree.root))},a.DBVTBroadPhase.prototype.collide=function(t,i){var s,h,e,o,n,a,r=2;for(this.stack[0]=t,this.stack[1]=i;r>0;)if(e=this.stack[--r],o=this.stack[--r],n=null!=e.proxy,a=null!=o.proxy,this.numPairChecks++,n&&a){if(s=e.proxy.shape,h=o.proxy.shape,s==h||s.aabb.intersectTest(h.aabb)||!this.isAvailablePair(s,h))continue;this.addPair(s,h)}else{if(e.aabb.intersectTest(o.aabb))continue;a||!n&&e.aabb.surfaceArea()>o.aabb.surfaceArea()?(this.stack[r++]=e.child1,this.stack[r++]=o,this.stack[r++]=e.child2,this.stack[r++]=o):(this.stack[r++]=e,this.stack[r++]=o.child1,this.stack[r++]=e,this.stack[r++]=o.child2)}},a.DBVTNode=function(){this.child1=null,this.child2=null,this.parent=null,this.proxy=null,this.height=0,this.aabb=new a.AABB},a.DBVTProxy=function(t){a.Proxy.call(this,t),this.leaf=new a.DBVTNode,this.leaf.proxy=this},a.DBVTProxy.prototype=Object.create(a.Proxy.prototype),a.DBVTProxy.prototype.constructor=a.DBVTProxy,a.DBVTProxy.prototype.update=function(){},a.World.prototype.add=function(t){t=t||{};var i=t.type||"box";if("string"==typeof i&&(i=[i]),"joint"==i[0].substring(0,5)){"joint"===i[0]&&(i[0]="jointHinge");var s=t.axe1||[1,0,0],h=t.axe2||[1,0,0],e=t.pos1||[0,0,0],o=t.pos2||[0,0,0];e=e.map(function(t){return t*a.INV_SCALE}),o=o.map(function(t){return t*a.INV_SCALE});var n,r;"jointDistance"===i[0]?(n=t.min||0,r=t.max||10,n*=a.INV_SCALE,r*=a.INV_SCALE):(n=t.min||57.29578,r=t.max||0,n*=a.degtorad,r*=a.degtorad);var l=t.limit||null,c=t.spring||null,m=t.motor||null,p=new a.JointConfig;p.allowCollision=t.collision||!1,p.localAxis1.init(s[0],s[1],s[2]),p.localAxis2.init(h[0],h[1],h[2]),p.localAnchorPoint1.init(e[0],e[1],e[2]),p.localAnchorPoint2.init(o[0],o[1],o[2]),("string"==typeof t.body1||t.body1 instanceof String)&&(t.body1=this.getByName(t.body1)),("string"==typeof t.body2||t.body2 instanceof String)&&(t.body2=this.getByName(t.body2)),p.body1=t.body1,p.body2=t.body2;var u;switch(i[0]){case"jointDistance":u=new a.DistanceJoint(p,n,r),null!==c&&u.limitMotor.setSpring(c[0],c[1]),null!==m&&u.limitMotor.setSpring(m[0],m[1]);break;case"jointHinge":u=new a.HingeJoint(p,n,r),null!==c&&u.limitMotor.setSpring(c[0],c[1]),null!==m&&u.limitMotor.setSpring(m[0],m[1]);break;case"jointPrisme":u=new a.PrismaticJoint(p,n,r);break;case"jointSlide":u=new a.SliderJoint(p,n,r);break;case"jointBall":u=new a.BallAndSocketJoint(p);break;case"jointWheel":u=new a.WheelJoint(p),null!==l&&u.rotationalLimitMotor1.setLimit(l[0],l[1]),null!==c&&u.rotationalLimitMotor1.setSpring(c[0],c[1]),null!==m&&u.rotationalLimitMotor1.setSpring(m[0],m[1])}return u.name=t.name||"",this.addJoint(u),u}var y=t.move||!1,x=t.noSleep||!1,d=t.pos||[0,0,0];d=d.map(function(t){return t*a.INV_SCALE});var f=t.size||[1,1,1];f=f.map(function(t){return t*a.INV_SCALE});var v=t.rot||[0,0,0];v=v.map(function(t){return t*a.degtorad});for(var N=[],b=0;b<v.length/3;b++){var z=a.EulerToAxis(v[b+0],v[b+1],v[b+2]);N.push(z[0]),N.push(z[1]),N.push(z[2]),N.push(z[3])}var A=new a.ShapeConfig;void 0!==t.sc&&(A=t.sc),t.config&&(A.density=void 0===t.config[0]?1:t.config[0],A.friction=void 0===t.config[1]?.4:t.config[1],A.restitution=void 0===t.config[2]?.2:t.config[2],A.belongsTo=t.config[3]||1,A.collidesWith=t.config[4]||4294967295),void 0!==t.density&&(A.density=t.density),void 0!==t.friction&&(A.friction=t.friction),void 0!==t.restitution&&(A.restitution=t.restitution),void 0!==t.belongsTo&&(A.belongsTo=t.belongsTo),void 0!==t.collidesWith&&(A.collidesWith=t.collidesWith),t.massPos&&(t.massPos=t.massPos.map(function(t){return t*a.INV_SCALE}),A.relativePosition.init(t.massPos[0],t.massPos[1],t.massPos[2])),t.massRot&&(t.massRot=t.massRot.map(function(t){return t*a.degtorad}),A.relativeRotation=a.EulerToMatrix(t.massRot[0],t.massRot[1],t.massRot[2]));for(var g,w,k=new a.RigidBody(d[0],d[1],d[2],N[0],N[1],N[2],N[3]),S=[],b=0;b<i.length;b++){switch(g=3*b,w=4*b,i[b]){case"sphere":S[b]=new a.SphereShape(A,f[g]);break;case"cylinder":S[b]=new a.CylinderShape(A,f[g],f[g+1]);break;case"box":S[b]=new a.BoxShape(A,f[g],f[g+1],f[g+2])}k.addShape(S[b]),b>0&&(S[b].relativePosition=new a.Vec3(d[g],d[g+1],d[g+2]),N[w+0]&&(S[b].relativeRotation=[N[w],N[w+1],N[w+2],N[w+3]]))}return y?(t.massPos||t.massRot?k.setupMass(1,!1):k.setupMass(1,!0),k.allowSleep=!x):k.setupMass(2),k.name=t.name||" ",this.addRigidBody(k),k}},,function(t,i){function s(){throw new Error("setTimeout has not been defined")}function h(){throw new Error("clearTimeout has not been defined")}function e(t){if(c===setTimeout)return setTimeout(t,0);if((c===s||!c)&&setTimeout)return c=setTimeout,setTimeout(t,0);try{return c(t,0)}catch(i){try{return c.call(null,t,0)}catch(i){return c.call(this,t,0)}}}function o(t){if(m===clearTimeout)return clearTimeout(t);if((m===h||!m)&&clearTimeout)return m=clearTimeout,clearTimeout(t);try{return m(t)}catch(i){try{return m.call(null,t)}catch(i){return m.call(this,t)}}}function n(){x&&u&&(x=!1,u.length?y=u.concat(y):d=-1,y.length&&a())}function a(){if(!x){var t=e(n);x=!0;for(var i=y.length;i;){for(u=y,y=[];++d<i;)u&&u[d].run();d=-1,i=y.length}u=null,x=!1,o(t)}}function r(t,i){this.fun=t,this.array=i}function l(){}var c,m,p=t.exports={};!function(){try{c="function"==typeof setTimeout?setTimeout:s}catch(t){c=s}try{m="function"==typeof clearTimeout?clearTimeout:h}catch(t){m=h}}();var u,y=[],x=!1,d=-1;p.nextTick=function(t){var i=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)i[s-1]=arguments[s];y.push(new r(t,i)),1!==y.length||x||e(a)},r.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=l,p.addListener=l,p.once=l,p.off=l,p.removeListener=l,p.removeAllListeners=l,p.emit=l,p.binding=function(t){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(t){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},function(t,i,s){(function(t,i){!function(t,s){"use strict";function h(t){"function"!=typeof t&&(t=new Function(""+t));for(var i=new Array(arguments.length-1),s=0;s<i.length;s++)i[s]=arguments[s+1];var h={callback:t,args:i};return x[y]=h,u(y),y++}function e(t){delete x[t]}function o(t){var i=t.callback,h=t.args;switch(h.length){case 0:i();break;case 1:i(h[0]);break;case 2:i(h[0],h[1]);break;case 3:i(h[0],h[1],h[2]);break;default:i.apply(s,h)}}function n(t){if(d)setTimeout(n,0,t);else{var i=x[t];if(i){d=!0;try{o(i)}finally{e(t),d=!1}}}}function a(){u=function(t){i.nextTick(function(){n(t)})}}function r(){if(t.postMessage&&!t.importScripts){var i=!0,s=t.onmessage;return t.onmessage=function(){i=!1},t.postMessage("","*"),t.onmessage=s,i}}function l(){var i="setImmediate$"+Math.random()+"$",s=function(s){s.source===t&&"string"==typeof s.data&&0===s.data.indexOf(i)&&n(+s.data.slice(i.length))};t.addEventListener?t.addEventListener("message",s,!1):t.attachEvent("onmessage",s),u=function(s){t.postMessage(i+s,"*")}}function c(){var t=new MessageChannel;t.port1.onmessage=function(t){n(t.data)},u=function(i){t.port2.postMessage(i)}}function m(){var t=f.documentElement;u=function(i){var s=f.createElement("script");s.onreadystatechange=function(){n(i),s.onreadystatechange=null,t.removeChild(s),s=null},t.appendChild(s)}}function p(){u=function(t){setTimeout(n,0,t)}}if(!t.setImmediate){var u,y=1,x={},d=!1,f=t.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(t);v=v&&v.setTimeout?v:t,"[object process]"==={}.toString.call(t.process)?a():r()?l():t.MessageChannel?c():f&&"onreadystatechange"in f.createElement("script")?m():p(),v.setImmediate=h,v.clearImmediate=e}}("undefined"==typeof self?void 0===t?this:t:self)}).call(i,s(7),s(4))},function(t,i,s){function h(t,i){this._id=t,this._clearFn=i}var e=Function.prototype.apply;i.setTimeout=function(){return new h(e.call(setTimeout,window,arguments),clearTimeout)},i.setInterval=function(){return new h(e.call(setInterval,window,arguments),clearInterval)},i.clearTimeout=i.clearInterval=function(t){t&&t.close()},h.prototype.unref=h.prototype.ref=function(){},h.prototype.close=function(){this._clearFn.call(window,this._id)},i.enroll=function(t,i){clearTimeout(t._idleTimeoutId),t._idleTimeout=i},i.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},i._unrefActive=i.active=function(t){clearTimeout(t._idleTimeoutId);var i=t._idleTimeout;i>=0&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},i))},s(5),i.setImmediate=setImmediate,i.clearImmediate=clearImmediate},function(t,i){var s;s=function(){return this}();try{s=s||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(s=window)}t.exports=s},function(t,i,s){t.exports=s(0)}])});